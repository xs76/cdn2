var Nv=Object.defineProperty,Bv=Object.defineProperties;var kv=Object.getOwnPropertyDescriptors;var gm=Object.getOwnPropertySymbols;var Uv=Object.prototype.hasOwnProperty,Vv=Object.prototype.propertyIsEnumerable;var ks=Math.pow,mh=(s,e,t)=>e in s?Nv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Qt=(s,e)=>{for(var t in e||(e={}))Uv.call(e,t)&&mh(s,t,e[t]);if(gm)for(var t of gm(e))Vv.call(e,t)&&mh(s,t,e[t]);return s},Em=(s,e)=>Bv(s,kv(e));var X=(s,e,t)=>(mh(s,typeof e!="symbol"?e+"":e,t),t);var Ie=(s,e,t)=>new Promise((i,n)=>{var r=l=>{try{o(t.next(l))}catch(c){n(c)}},a=l=>{try{o(t.throw(l))}catch(c){n(c)}},o=l=>l.done?i(l.value):Promise.resolve(l.value).then(r,a);o((t=t.apply(s,e)).next())});(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();var Gv=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function Kg(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Qg={exports:{}},mt={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Hl=Symbol.for("react.element"),zv=Symbol.for("react.portal"),Hv=Symbol.for("react.fragment"),Wv=Symbol.for("react.strict_mode"),Xv=Symbol.for("react.profiler"),Yv=Symbol.for("react.provider"),Kv=Symbol.for("react.context"),Qv=Symbol.for("react.forward_ref"),Zv=Symbol.for("react.suspense"),qv=Symbol.for("react.memo"),jv=Symbol.for("react.lazy"),vm=Symbol.iterator;function $v(s){return s===null||typeof s!="object"?null:(s=vm&&s[vm]||s["@@iterator"],typeof s=="function"?s:null)}var Zg={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},qg=Object.assign,jg={};function xo(s,e,t){this.props=s,this.context=e,this.refs=jg,this.updater=t||Zg}xo.prototype.isReactComponent={};xo.prototype.setState=function(s,e){if(typeof s!="object"&&typeof s!="function"&&s!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,s,e,"setState")};xo.prototype.forceUpdate=function(s){this.updater.enqueueForceUpdate(this,s,"forceUpdate")};function $g(){}$g.prototype=xo.prototype;function ep(s,e,t){this.props=s,this.context=e,this.refs=jg,this.updater=t||Zg}var tp=ep.prototype=new $g;tp.constructor=ep;qg(tp,xo.prototype);tp.isPureReactComponent=!0;var ym=Array.isArray,Jg=Object.prototype.hasOwnProperty,ip={current:null},e0={key:!0,ref:!0,__self:!0,__source:!0};function t0(s,e,t){var i,n={},r=null,a=null;if(e!=null)for(i in e.ref!==void 0&&(a=e.ref),e.key!==void 0&&(r=""+e.key),e)Jg.call(e,i)&&!e0.hasOwnProperty(i)&&(n[i]=e[i]);var o=arguments.length-2;if(o===1)n.children=t;else if(1<o){for(var l=Array(o),c=0;c<o;c++)l[c]=arguments[c+2];n.children=l}if(s&&s.defaultProps)for(i in o=s.defaultProps,o)n[i]===void 0&&(n[i]=o[i]);return{$$typeof:Hl,type:s,key:r,ref:a,props:n,_owner:ip.current}}function Jv(s,e){return{$$typeof:Hl,type:s.type,key:e,ref:s.ref,props:s.props,_owner:s._owner}}function np(s){return typeof s=="object"&&s!==null&&s.$$typeof===Hl}function ey(s){var e={"=":"=0",":":"=2"};return"$"+s.replace(/[=:]/g,function(t){return e[t]})}var Am=/\/+/g;function _h(s,e){return typeof s=="object"&&s!==null&&s.key!=null?ey(""+s.key):e.toString(36)}function wc(s,e,t,i,n){var r=typeof s;(r==="undefined"||r==="boolean")&&(s=null);var a=!1;if(s===null)a=!0;else switch(r){case"string":case"number":a=!0;break;case"object":switch(s.$$typeof){case Hl:case zv:a=!0}}if(a)return a=s,n=n(a),s=i===""?"."+_h(a,0):i,ym(n)?(t="",s!=null&&(t=s.replace(Am,"$&/")+"/"),wc(n,e,t,"",function(c){return c})):n!=null&&(np(n)&&(n=Jv(n,t+(!n.key||a&&a.key===n.key?"":(""+n.key).replace(Am,"$&/")+"/")+s)),e.push(n)),1;if(a=0,i=i===""?".":i+":",ym(s))for(var o=0;o<s.length;o++){r=s[o];var l=i+_h(r,o);a+=wc(r,e,t,l,n)}else if(l=$v(s),typeof l=="function")for(s=l.call(s),o=0;!(r=s.next()).done;)r=r.value,l=i+_h(r,o++),a+=wc(r,e,t,l,n);else if(r==="object")throw e=String(s),Error("Objects are not valid as a React child (found: "+(e==="[object Object]"?"object with keys {"+Object.keys(s).join(", ")+"}":e)+"). If you meant to render a collection of children, use an array instead.");return a}function uc(s,e,t){if(s==null)return s;var i=[],n=0;return wc(s,i,"","",function(r){return e.call(t,r,n++)}),i}function ty(s){if(s._status===-1){var e=s._result;e=e(),e.then(function(t){(s._status===0||s._status===-1)&&(s._status=1,s._result=t)},function(t){(s._status===0||s._status===-1)&&(s._status=2,s._result=t)}),s._status===-1&&(s._status=0,s._result=e)}if(s._status===1)return s._result.default;throw s._result}var mn={current:null},Fc={transition:null},iy={ReactCurrentDispatcher:mn,ReactCurrentBatchConfig:Fc,ReactCurrentOwner:ip};mt.Children={map:uc,forEach:function(s,e,t){uc(s,function(){e.apply(this,arguments)},t)},count:function(s){var e=0;return uc(s,function(){e++}),e},toArray:function(s){return uc(s,function(e){return e})||[]},only:function(s){if(!np(s))throw Error("React.Children.only expected to receive a single React element child.");return s}};mt.Component=xo;mt.Fragment=Hv;mt.Profiler=Xv;mt.PureComponent=ep;mt.StrictMode=Wv;mt.Suspense=Zv;mt.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=iy;mt.cloneElement=function(s,e,t){if(s==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+s+".");var i=qg({},s.props),n=s.key,r=s.ref,a=s._owner;if(e!=null){if(e.ref!==void 0&&(r=e.ref,a=ip.current),e.key!==void 0&&(n=""+e.key),s.type&&s.type.defaultProps)var o=s.type.defaultProps;for(l in e)Jg.call(e,l)&&!e0.hasOwnProperty(l)&&(i[l]=e[l]===void 0&&o!==void 0?o[l]:e[l])}var l=arguments.length-2;if(l===1)i.children=t;else if(1<l){o=Array(l);for(var c=0;c<l;c++)o[c]=arguments[c+2];i.children=o}return{$$typeof:Hl,type:s.type,key:n,ref:r,props:i,_owner:a}};mt.createContext=function(s){return s={$$typeof:Kv,_currentValue:s,_currentValue2:s,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},s.Provider={$$typeof:Yv,_context:s},s.Consumer=s};mt.createElement=t0;mt.createFactory=function(s){var e=t0.bind(null,s);return e.type=s,e};mt.createRef=function(){return{current:null}};mt.forwardRef=function(s){return{$$typeof:Qv,render:s}};mt.isValidElement=np;mt.lazy=function(s){return{$$typeof:jv,_payload:{_status:-1,_result:s},_init:ty}};mt.memo=function(s,e){return{$$typeof:qv,type:s,compare:e===void 0?null:e}};mt.startTransition=function(s){var e=Fc.transition;Fc.transition={};try{s()}finally{Fc.transition=e}};mt.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")};mt.useCallback=function(s,e){return mn.current.useCallback(s,e)};mt.useContext=function(s){return mn.current.useContext(s)};mt.useDebugValue=function(){};mt.useDeferredValue=function(s){return mn.current.useDeferredValue(s)};mt.useEffect=function(s,e){return mn.current.useEffect(s,e)};mt.useId=function(){return mn.current.useId()};mt.useImperativeHandle=function(s,e,t){return mn.current.useImperativeHandle(s,e,t)};mt.useInsertionEffect=function(s,e){return mn.current.useInsertionEffect(s,e)};mt.useLayoutEffect=function(s,e){return mn.current.useLayoutEffect(s,e)};mt.useMemo=function(s,e){return mn.current.useMemo(s,e)};mt.useReducer=function(s,e,t){return mn.current.useReducer(s,e,t)};mt.useRef=function(s){return mn.current.useRef(s)};mt.useState=function(s){return mn.current.useState(s)};mt.useSyncExternalStore=function(s,e,t){return mn.current.useSyncExternalStore(s,e,t)};mt.useTransition=function(){return mn.current.useTransition()};mt.version="18.2.0";Qg.exports=mt;var ve=Qg.exports;const M=Kg(ve);var i0={exports:{}},Gn={},n0={exports:{}},s0={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(s){function e(re,ge){var be=re.length;re.push(ge);e:for(;0<be;){var ze=be-1>>>1,Ke=re[ze];if(0<n(Ke,ge))re[ze]=ge,re[be]=Ke,be=ze;else break e}}function t(re){return re.length===0?null:re[0]}function i(re){if(re.length===0)return null;var ge=re[0],be=re.pop();if(be!==ge){re[0]=be;e:for(var ze=0,Ke=re.length,Ut=Ke>>>1;ze<Ut;){var st=2*(ze+1)-1,Jt=re[st],Wt=st+1,ii=re[Wt];if(0>n(Jt,be))Wt<Ke&&0>n(ii,Jt)?(re[ze]=ii,re[Wt]=be,ze=Wt):(re[ze]=Jt,re[st]=be,ze=st);else if(Wt<Ke&&0>n(ii,be))re[ze]=ii,re[Wt]=be,ze=Wt;else break e}}return ge}function n(re,ge){var be=re.sortIndex-ge.sortIndex;return be!==0?be:re.id-ge.id}if(typeof performance=="object"&&typeof performance.now=="function"){var r=performance;s.unstable_now=function(){return r.now()}}else{var a=Date,o=a.now();s.unstable_now=function(){return a.now()-o}}var l=[],c=[],u=1,h=null,d=3,f=!1,p=!1,m=!1,_=typeof setTimeout=="function"?setTimeout:null,E=typeof clearTimeout=="function"?clearTimeout:null,v=typeof setImmediate!="undefined"?setImmediate:null;typeof navigator!="undefined"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function y(re){for(var ge=t(c);ge!==null;){if(ge.callback===null)i(c);else if(ge.startTime<=re)i(c),ge.sortIndex=ge.expirationTime,e(l,ge);else break;ge=t(c)}}function A(re){if(m=!1,y(re),!p)if(t(l)!==null)p=!0,Ve(I);else{var ge=t(c);ge!==null&&$e(A,ge.startTime-re)}}function I(re,ge){p=!1,m&&(m=!1,E(x),x=-1),f=!0;var be=d;try{for(y(ge),h=t(l);h!==null&&(!(h.expirationTime>ge)||re&&!V());){var ze=h.callback;if(typeof ze=="function"){h.callback=null,d=h.priorityLevel;var Ke=ze(h.expirationTime<=ge);ge=s.unstable_now(),typeof Ke=="function"?h.callback=Ke:h===t(l)&&i(l),y(ge)}else i(l);h=t(l)}if(h!==null)var Ut=!0;else{var st=t(c);st!==null&&$e(A,st.startTime-ge),Ut=!1}return Ut}finally{h=null,d=be,f=!1}}var T=!1,R=null,x=-1,F=5,L=-1;function V(){return!(s.unstable_now()-L<F)}function Z(){if(R!==null){var re=s.unstable_now();L=re;var ge=!0;try{ge=R(!0,re)}finally{ge?ne():(T=!1,R=null)}}else T=!1}var ne;if(typeof v=="function")ne=function(){v(Z)};else if(typeof MessageChannel!="undefined"){var ae=new MessageChannel,Ue=ae.port2;ae.port1.onmessage=Z,ne=function(){Ue.postMessage(null)}}else ne=function(){_(Z,0)};function Ve(re){R=re,T||(T=!0,ne())}function $e(re,ge){x=_(function(){re(s.unstable_now())},ge)}s.unstable_IdlePriority=5,s.unstable_ImmediatePriority=1,s.unstable_LowPriority=4,s.unstable_NormalPriority=3,s.unstable_Profiling=null,s.unstable_UserBlockingPriority=2,s.unstable_cancelCallback=function(re){re.callback=null},s.unstable_continueExecution=function(){p||f||(p=!0,Ve(I))},s.unstable_forceFrameRate=function(re){0>re||125<re?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):F=0<re?Math.floor(1e3/re):5},s.unstable_getCurrentPriorityLevel=function(){return d},s.unstable_getFirstCallbackNode=function(){return t(l)},s.unstable_next=function(re){switch(d){case 1:case 2:case 3:var ge=3;break;default:ge=d}var be=d;d=ge;try{return re()}finally{d=be}},s.unstable_pauseExecution=function(){},s.unstable_requestPaint=function(){},s.unstable_runWithPriority=function(re,ge){switch(re){case 1:case 2:case 3:case 4:case 5:break;default:re=3}var be=d;d=re;try{return ge()}finally{d=be}},s.unstable_scheduleCallback=function(re,ge,be){var ze=s.unstable_now();switch(typeof be=="object"&&be!==null?(be=be.delay,be=typeof be=="number"&&0<be?ze+be:ze):be=ze,re){case 1:var Ke=-1;break;case 2:Ke=250;break;case 5:Ke=1073741823;break;case 4:Ke=1e4;break;default:Ke=5e3}return Ke=be+Ke,re={id:u++,callback:ge,priorityLevel:re,startTime:be,expirationTime:Ke,sortIndex:-1},be>ze?(re.sortIndex=be,e(c,re),t(l)===null&&re===t(c)&&(m?(E(x),x=-1):m=!0,$e(A,be-ze))):(re.sortIndex=Ke,e(l,re),p||f||(p=!0,Ve(I))),re},s.unstable_shouldYield=V,s.unstable_wrapCallback=function(re){var ge=d;return function(){var be=d;d=ge;try{return re.apply(this,arguments)}finally{d=be}}}})(s0);n0.exports=s0;var ny=n0.exports;/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var r0=ve,kn=ny;function ue(s){for(var e="https://reactjs.org/docs/error-decoder.html?invariant="+s,t=1;t<arguments.length;t++)e+="&args[]="+encodeURIComponent(arguments[t]);return"Minified React error #"+s+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var a0=new Set,ml={};function Ta(s,e){fo(s,e),fo(s+"Capture",e)}function fo(s,e){for(ml[s]=e,s=0;s<e.length;s++)a0.add(e[s])}var tr=!(typeof window=="undefined"||typeof window.document=="undefined"||typeof window.document.createElement=="undefined"),od=Object.prototype.hasOwnProperty,sy=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,Tm={},Sm={};function ry(s){return od.call(Sm,s)?!0:od.call(Tm,s)?!1:sy.test(s)?Sm[s]=!0:(Tm[s]=!0,!1)}function ay(s,e,t,i){if(t!==null&&t.type===0)return!1;switch(typeof e){case"function":case"symbol":return!0;case"boolean":return i?!1:t!==null?!t.acceptsBooleans:(s=s.toLowerCase().slice(0,5),s!=="data-"&&s!=="aria-");default:return!1}}function oy(s,e,t,i){if(e===null||typeof e=="undefined"||ay(s,e,t,i))return!0;if(i)return!1;if(t!==null)switch(t.type){case 3:return!e;case 4:return e===!1;case 5:return isNaN(e);case 6:return isNaN(e)||1>e}return!1}function _n(s,e,t,i,n,r,a){this.acceptsBooleans=e===2||e===3||e===4,this.attributeName=i,this.attributeNamespace=n,this.mustUseProperty=t,this.propertyName=s,this.type=e,this.sanitizeURL=r,this.removeEmptyString=a}var Vi={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(s){Vi[s]=new _n(s,0,!1,s,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(s){var e=s[0];Vi[e]=new _n(e,1,!1,s[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(s){Vi[s]=new _n(s,2,!1,s.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(s){Vi[s]=new _n(s,2,!1,s,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(s){Vi[s]=new _n(s,3,!1,s.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(s){Vi[s]=new _n(s,3,!0,s,null,!1,!1)});["capture","download"].forEach(function(s){Vi[s]=new _n(s,4,!1,s,null,!1,!1)});["cols","rows","size","span"].forEach(function(s){Vi[s]=new _n(s,6,!1,s,null,!1,!1)});["rowSpan","start"].forEach(function(s){Vi[s]=new _n(s,5,!1,s.toLowerCase(),null,!1,!1)});var sp=/[\-:]([a-z])/g;function rp(s){return s[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(s){var e=s.replace(sp,rp);Vi[e]=new _n(e,1,!1,s,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(s){var e=s.replace(sp,rp);Vi[e]=new _n(e,1,!1,s,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(s){var e=s.replace(sp,rp);Vi[e]=new _n(e,1,!1,s,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(s){Vi[s]=new _n(s,1,!1,s.toLowerCase(),null,!1,!1)});Vi.xlinkHref=new _n("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(s){Vi[s]=new _n(s,1,!1,s.toLowerCase(),null,!0,!0)});function ap(s,e,t,i){var n=Vi.hasOwnProperty(e)?Vi[e]:null;(n!==null?n.type!==0:i||!(2<e.length)||e[0]!=="o"&&e[0]!=="O"||e[1]!=="n"&&e[1]!=="N")&&(oy(e,t,n,i)&&(t=null),i||n===null?ry(e)&&(t===null?s.removeAttribute(e):s.setAttribute(e,""+t)):n.mustUseProperty?s[n.propertyName]=t===null?n.type===3?!1:"":t:(e=n.attributeName,i=n.attributeNamespace,t===null?s.removeAttribute(e):(n=n.type,t=n===3||n===4&&t===!0?"":""+t,i?s.setAttributeNS(i,e,t):s.setAttribute(e,t))))}var or=r0.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,hc=Symbol.for("react.element"),Ba=Symbol.for("react.portal"),ka=Symbol.for("react.fragment"),op=Symbol.for("react.strict_mode"),ld=Symbol.for("react.profiler"),o0=Symbol.for("react.provider"),l0=Symbol.for("react.context"),lp=Symbol.for("react.forward_ref"),cd=Symbol.for("react.suspense"),ud=Symbol.for("react.suspense_list"),cp=Symbol.for("react.memo"),_r=Symbol.for("react.lazy"),c0=Symbol.for("react.offscreen"),Cm=Symbol.iterator;function Bo(s){return s===null||typeof s!="object"?null:(s=Cm&&s[Cm]||s["@@iterator"],typeof s=="function"?s:null)}var li=Object.assign,gh;function Ko(s){if(gh===void 0)try{throw Error()}catch(t){var e=t.stack.trim().match(/\n( *(at )?)/);gh=e&&e[1]||""}return`
`+gh+s}var Eh=!1;function vh(s,e){if(!s||Eh)return"";Eh=!0;var t=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(e)if(e=function(){throw Error()},Object.defineProperty(e.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(e,[])}catch(c){var i=c}Reflect.construct(s,[],e)}else{try{e.call()}catch(c){i=c}s.call(e.prototype)}else{try{throw Error()}catch(c){i=c}s()}}catch(c){if(c&&i&&typeof c.stack=="string"){for(var n=c.stack.split(`
`),r=i.stack.split(`
`),a=n.length-1,o=r.length-1;1<=a&&0<=o&&n[a]!==r[o];)o--;for(;1<=a&&0<=o;a--,o--)if(n[a]!==r[o]){if(a!==1||o!==1)do if(a--,o--,0>o||n[a]!==r[o]){var l=`
`+n[a].replace(" at new "," at ");return s.displayName&&l.includes("<anonymous>")&&(l=l.replace("<anonymous>",s.displayName)),l}while(1<=a&&0<=o);break}}}finally{Eh=!1,Error.prepareStackTrace=t}return(s=s?s.displayName||s.name:"")?Ko(s):""}function ly(s){switch(s.tag){case 5:return Ko(s.type);case 16:return Ko("Lazy");case 13:return Ko("Suspense");case 19:return Ko("SuspenseList");case 0:case 2:case 15:return s=vh(s.type,!1),s;case 11:return s=vh(s.type.render,!1),s;case 1:return s=vh(s.type,!0),s;default:return""}}function hd(s){if(s==null)return null;if(typeof s=="function")return s.displayName||s.name||null;if(typeof s=="string")return s;switch(s){case ka:return"Fragment";case Ba:return"Portal";case ld:return"Profiler";case op:return"StrictMode";case cd:return"Suspense";case ud:return"SuspenseList"}if(typeof s=="object")switch(s.$$typeof){case l0:return(s.displayName||"Context")+".Consumer";case o0:return(s._context.displayName||"Context")+".Provider";case lp:var e=s.render;return s=s.displayName,s||(s=e.displayName||e.name||"",s=s!==""?"ForwardRef("+s+")":"ForwardRef"),s;case cp:return e=s.displayName||null,e!==null?e:hd(s.type)||"Memo";case _r:e=s._payload,s=s._init;try{return hd(s(e))}catch(t){}}return null}function cy(s){var e=s.type;switch(s.tag){case 24:return"Cache";case 9:return(e.displayName||"Context")+".Consumer";case 10:return(e._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return s=e.render,s=s.displayName||s.name||"",e.displayName||(s!==""?"ForwardRef("+s+")":"ForwardRef");case 7:return"Fragment";case 5:return e;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return hd(e);case 8:return e===op?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e}return null}function kr(s){switch(typeof s){case"boolean":case"number":case"string":case"undefined":return s;case"object":return s;default:return""}}function u0(s){var e=s.type;return(s=s.nodeName)&&s.toLowerCase()==="input"&&(e==="checkbox"||e==="radio")}function uy(s){var e=u0(s)?"checked":"value",t=Object.getOwnPropertyDescriptor(s.constructor.prototype,e),i=""+s[e];if(!s.hasOwnProperty(e)&&typeof t!="undefined"&&typeof t.get=="function"&&typeof t.set=="function"){var n=t.get,r=t.set;return Object.defineProperty(s,e,{configurable:!0,get:function(){return n.call(this)},set:function(a){i=""+a,r.call(this,a)}}),Object.defineProperty(s,e,{enumerable:t.enumerable}),{getValue:function(){return i},setValue:function(a){i=""+a},stopTracking:function(){s._valueTracker=null,delete s[e]}}}}function dc(s){s._valueTracker||(s._valueTracker=uy(s))}function h0(s){if(!s)return!1;var e=s._valueTracker;if(!e)return!0;var t=e.getValue(),i="";return s&&(i=u0(s)?s.checked?"true":"false":s.value),s=i,s!==t?(e.setValue(s),!0):!1}function qc(s){if(s=s||(typeof document!="undefined"?document:void 0),typeof s=="undefined")return null;try{return s.activeElement||s.body}catch(e){return s.body}}function dd(s,e){var t=e.checked;return li({},e,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:t!=null?t:s._wrapperState.initialChecked})}function Im(s,e){var t=e.defaultValue==null?"":e.defaultValue,i=e.checked!=null?e.checked:e.defaultChecked;t=kr(e.value!=null?e.value:t),s._wrapperState={initialChecked:i,initialValue:t,controlled:e.type==="checkbox"||e.type==="radio"?e.checked!=null:e.value!=null}}function d0(s,e){e=e.checked,e!=null&&ap(s,"checked",e,!1)}function fd(s,e){d0(s,e);var t=kr(e.value),i=e.type;if(t!=null)i==="number"?(t===0&&s.value===""||s.value!=t)&&(s.value=""+t):s.value!==""+t&&(s.value=""+t);else if(i==="submit"||i==="reset"){s.removeAttribute("value");return}e.hasOwnProperty("value")?pd(s,e.type,t):e.hasOwnProperty("defaultValue")&&pd(s,e.type,kr(e.defaultValue)),e.checked==null&&e.defaultChecked!=null&&(s.defaultChecked=!!e.defaultChecked)}function Rm(s,e,t){if(e.hasOwnProperty("value")||e.hasOwnProperty("defaultValue")){var i=e.type;if(!(i!=="submit"&&i!=="reset"||e.value!==void 0&&e.value!==null))return;e=""+s._wrapperState.initialValue,t||e===s.value||(s.value=e),s.defaultValue=e}t=s.name,t!==""&&(s.name=""),s.defaultChecked=!!s._wrapperState.initialChecked,t!==""&&(s.name=t)}function pd(s,e,t){(e!=="number"||qc(s.ownerDocument)!==s)&&(t==null?s.defaultValue=""+s._wrapperState.initialValue:s.defaultValue!==""+t&&(s.defaultValue=""+t))}var Qo=Array.isArray;function qa(s,e,t,i){if(s=s.options,e){e={};for(var n=0;n<t.length;n++)e["$"+t[n]]=!0;for(t=0;t<s.length;t++)n=e.hasOwnProperty("$"+s[t].value),s[t].selected!==n&&(s[t].selected=n),n&&i&&(s[t].defaultSelected=!0)}else{for(t=""+kr(t),e=null,n=0;n<s.length;n++){if(s[n].value===t){s[n].selected=!0,i&&(s[n].defaultSelected=!0);return}e!==null||s[n].disabled||(e=s[n])}e!==null&&(e.selected=!0)}}function md(s,e){if(e.dangerouslySetInnerHTML!=null)throw Error(ue(91));return li({},e,{value:void 0,defaultValue:void 0,children:""+s._wrapperState.initialValue})}function bm(s,e){var t=e.value;if(t==null){if(t=e.children,e=e.defaultValue,t!=null){if(e!=null)throw Error(ue(92));if(Qo(t)){if(1<t.length)throw Error(ue(93));t=t[0]}e=t}e==null&&(e=""),t=e}s._wrapperState={initialValue:kr(t)}}function f0(s,e){var t=kr(e.value),i=kr(e.defaultValue);t!=null&&(t=""+t,t!==s.value&&(s.value=t),e.defaultValue==null&&s.defaultValue!==t&&(s.defaultValue=t)),i!=null&&(s.defaultValue=""+i)}function xm(s){var e=s.textContent;e===s._wrapperState.initialValue&&e!==""&&e!==null&&(s.value=e)}function p0(s){switch(s){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function _d(s,e){return s==null||s==="http://www.w3.org/1999/xhtml"?p0(e):s==="http://www.w3.org/2000/svg"&&e==="foreignObject"?"http://www.w3.org/1999/xhtml":s}var fc,m0=function(s){return typeof MSApp!="undefined"&&MSApp.execUnsafeLocalFunction?function(e,t,i,n){MSApp.execUnsafeLocalFunction(function(){return s(e,t,i,n)})}:s}(function(s,e){if(s.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in s)s.innerHTML=e;else{for(fc=fc||document.createElement("div"),fc.innerHTML="<svg>"+e.valueOf().toString()+"</svg>",e=fc.firstChild;s.firstChild;)s.removeChild(s.firstChild);for(;e.firstChild;)s.appendChild(e.firstChild)}});function _l(s,e){if(e){var t=s.firstChild;if(t&&t===s.lastChild&&t.nodeType===3){t.nodeValue=e;return}}s.textContent=e}var el={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},hy=["Webkit","ms","Moz","O"];Object.keys(el).forEach(function(s){hy.forEach(function(e){e=e+s.charAt(0).toUpperCase()+s.substring(1),el[e]=el[s]})});function _0(s,e,t){return e==null||typeof e=="boolean"||e===""?"":t||typeof e!="number"||e===0||el.hasOwnProperty(s)&&el[s]?(""+e).trim():e+"px"}function g0(s,e){s=s.style;for(var t in e)if(e.hasOwnProperty(t)){var i=t.indexOf("--")===0,n=_0(t,e[t],i);t==="float"&&(t="cssFloat"),i?s.setProperty(t,n):s[t]=n}}var dy=li({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function gd(s,e){if(e){if(dy[s]&&(e.children!=null||e.dangerouslySetInnerHTML!=null))throw Error(ue(137,s));if(e.dangerouslySetInnerHTML!=null){if(e.children!=null)throw Error(ue(60));if(typeof e.dangerouslySetInnerHTML!="object"||!("__html"in e.dangerouslySetInnerHTML))throw Error(ue(61))}if(e.style!=null&&typeof e.style!="object")throw Error(ue(62))}}function Ed(s,e){if(s.indexOf("-")===-1)return typeof e.is=="string";switch(s){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var vd=null;function up(s){return s=s.target||s.srcElement||window,s.correspondingUseElement&&(s=s.correspondingUseElement),s.nodeType===3?s.parentNode:s}var yd=null,ja=null,$a=null;function Mm(s){if(s=Yl(s)){if(typeof yd!="function")throw Error(ue(280));var e=s.stateNode;e&&(e=Vu(e),yd(s.stateNode,s.type,e))}}function E0(s){ja?$a?$a.push(s):$a=[s]:ja=s}function v0(){if(ja){var s=ja,e=$a;if($a=ja=null,Mm(s),e)for(s=0;s<e.length;s++)Mm(e[s])}}function y0(s,e){return s(e)}function A0(){}var yh=!1;function T0(s,e,t){if(yh)return s(e,t);yh=!0;try{return y0(s,e,t)}finally{yh=!1,(ja!==null||$a!==null)&&(A0(),v0())}}function gl(s,e){var t=s.stateNode;if(t===null)return null;var i=Vu(t);if(i===null)return null;t=i[e];e:switch(e){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(i=!i.disabled)||(s=s.type,i=!(s==="button"||s==="input"||s==="select"||s==="textarea")),s=!i;break e;default:s=!1}if(s)return null;if(t&&typeof t!="function")throw Error(ue(231,e,typeof t));return t}var Ad=!1;if(tr)try{var ko={};Object.defineProperty(ko,"passive",{get:function(){Ad=!0}}),window.addEventListener("test",ko,ko),window.removeEventListener("test",ko,ko)}catch(s){Ad=!1}function fy(s,e,t,i,n,r,a,o,l){var c=Array.prototype.slice.call(arguments,3);try{e.apply(t,c)}catch(u){this.onError(u)}}var tl=!1,jc=null,$c=!1,Td=null,py={onError:function(s){tl=!0,jc=s}};function my(s,e,t,i,n,r,a,o,l){tl=!1,jc=null,fy.apply(py,arguments)}function _y(s,e,t,i,n,r,a,o,l){if(my.apply(this,arguments),tl){if(tl){var c=jc;tl=!1,jc=null}else throw Error(ue(198));$c||($c=!0,Td=c)}}function Sa(s){var e=s,t=s;if(s.alternate)for(;e.return;)e=e.return;else{s=e;do e=s,e.flags&4098&&(t=e.return),s=e.return;while(s)}return e.tag===3?t:null}function S0(s){if(s.tag===13){var e=s.memoizedState;if(e===null&&(s=s.alternate,s!==null&&(e=s.memoizedState)),e!==null)return e.dehydrated}return null}function Pm(s){if(Sa(s)!==s)throw Error(ue(188))}function gy(s){var e=s.alternate;if(!e){if(e=Sa(s),e===null)throw Error(ue(188));return e!==s?null:s}for(var t=s,i=e;;){var n=t.return;if(n===null)break;var r=n.alternate;if(r===null){if(i=n.return,i!==null){t=i;continue}break}if(n.child===r.child){for(r=n.child;r;){if(r===t)return Pm(n),s;if(r===i)return Pm(n),e;r=r.sibling}throw Error(ue(188))}if(t.return!==i.return)t=n,i=r;else{for(var a=!1,o=n.child;o;){if(o===t){a=!0,t=n,i=r;break}if(o===i){a=!0,i=n,t=r;break}o=o.sibling}if(!a){for(o=r.child;o;){if(o===t){a=!0,t=r,i=n;break}if(o===i){a=!0,i=r,t=n;break}o=o.sibling}if(!a)throw Error(ue(189))}}if(t.alternate!==i)throw Error(ue(190))}if(t.tag!==3)throw Error(ue(188));return t.stateNode.current===t?s:e}function C0(s){return s=gy(s),s!==null?I0(s):null}function I0(s){if(s.tag===5||s.tag===6)return s;for(s=s.child;s!==null;){var e=I0(s);if(e!==null)return e;s=s.sibling}return null}var R0=kn.unstable_scheduleCallback,Dm=kn.unstable_cancelCallback,Ey=kn.unstable_shouldYield,vy=kn.unstable_requestPaint,pi=kn.unstable_now,yy=kn.unstable_getCurrentPriorityLevel,hp=kn.unstable_ImmediatePriority,b0=kn.unstable_UserBlockingPriority,Jc=kn.unstable_NormalPriority,Ay=kn.unstable_LowPriority,x0=kn.unstable_IdlePriority,Nu=null,Ps=null;function Ty(s){if(Ps&&typeof Ps.onCommitFiberRoot=="function")try{Ps.onCommitFiberRoot(Nu,s,void 0,(s.current.flags&128)===128)}catch(e){}}var ds=Math.clz32?Math.clz32:Iy,Sy=Math.log,Cy=Math.LN2;function Iy(s){return s>>>=0,s===0?32:31-(Sy(s)/Cy|0)|0}var pc=64,mc=4194304;function Zo(s){switch(s&-s){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return s&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return s&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return s}}function eu(s,e){var t=s.pendingLanes;if(t===0)return 0;var i=0,n=s.suspendedLanes,r=s.pingedLanes,a=t&268435455;if(a!==0){var o=a&~n;o!==0?i=Zo(o):(r&=a,r!==0&&(i=Zo(r)))}else a=t&~n,a!==0?i=Zo(a):r!==0&&(i=Zo(r));if(i===0)return 0;if(e!==0&&e!==i&&!(e&n)&&(n=i&-i,r=e&-e,n>=r||n===16&&(r&4194240)!==0))return e;if(i&4&&(i|=t&16),e=s.entangledLanes,e!==0)for(s=s.entanglements,e&=i;0<e;)t=31-ds(e),n=1<<t,i|=s[t],e&=~n;return i}function Ry(s,e){switch(s){case 1:case 2:case 4:return e+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return e+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function by(s,e){for(var t=s.suspendedLanes,i=s.pingedLanes,n=s.expirationTimes,r=s.pendingLanes;0<r;){var a=31-ds(r),o=1<<a,l=n[a];l===-1?(!(o&t)||o&i)&&(n[a]=Ry(o,e)):l<=e&&(s.expiredLanes|=o),r&=~o}}function Sd(s){return s=s.pendingLanes&-1073741825,s!==0?s:s&1073741824?1073741824:0}function M0(){var s=pc;return pc<<=1,!(pc&4194240)&&(pc=64),s}function Ah(s){for(var e=[],t=0;31>t;t++)e.push(s);return e}function Wl(s,e,t){s.pendingLanes|=e,e!==536870912&&(s.suspendedLanes=0,s.pingedLanes=0),s=s.eventTimes,e=31-ds(e),s[e]=t}function xy(s,e){var t=s.pendingLanes&~e;s.pendingLanes=e,s.suspendedLanes=0,s.pingedLanes=0,s.expiredLanes&=e,s.mutableReadLanes&=e,s.entangledLanes&=e,e=s.entanglements;var i=s.eventTimes;for(s=s.expirationTimes;0<t;){var n=31-ds(t),r=1<<n;e[n]=0,i[n]=-1,s[n]=-1,t&=~r}}function dp(s,e){var t=s.entangledLanes|=e;for(s=s.entanglements;t;){var i=31-ds(t),n=1<<i;n&e|s[i]&e&&(s[i]|=e),t&=~n}}var kt=0;function P0(s){return s&=-s,1<s?4<s?s&268435455?16:536870912:4:1}var D0,fp,O0,w0,F0,Cd=!1,_c=[],Rr=null,br=null,xr=null,El=new Map,vl=new Map,yr=[],My="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Om(s,e){switch(s){case"focusin":case"focusout":Rr=null;break;case"dragenter":case"dragleave":br=null;break;case"mouseover":case"mouseout":xr=null;break;case"pointerover":case"pointerout":El.delete(e.pointerId);break;case"gotpointercapture":case"lostpointercapture":vl.delete(e.pointerId)}}function Uo(s,e,t,i,n,r){return s===null||s.nativeEvent!==r?(s={blockedOn:e,domEventName:t,eventSystemFlags:i,nativeEvent:r,targetContainers:[n]},e!==null&&(e=Yl(e),e!==null&&fp(e)),s):(s.eventSystemFlags|=i,e=s.targetContainers,n!==null&&e.indexOf(n)===-1&&e.push(n),s)}function Py(s,e,t,i,n){switch(e){case"focusin":return Rr=Uo(Rr,s,e,t,i,n),!0;case"dragenter":return br=Uo(br,s,e,t,i,n),!0;case"mouseover":return xr=Uo(xr,s,e,t,i,n),!0;case"pointerover":var r=n.pointerId;return El.set(r,Uo(El.get(r)||null,s,e,t,i,n)),!0;case"gotpointercapture":return r=n.pointerId,vl.set(r,Uo(vl.get(r)||null,s,e,t,i,n)),!0}return!1}function L0(s){var e=sa(s.target);if(e!==null){var t=Sa(e);if(t!==null){if(e=t.tag,e===13){if(e=S0(t),e!==null){s.blockedOn=e,F0(s.priority,function(){O0(t)});return}}else if(e===3&&t.stateNode.current.memoizedState.isDehydrated){s.blockedOn=t.tag===3?t.stateNode.containerInfo:null;return}}}s.blockedOn=null}function Lc(s){if(s.blockedOn!==null)return!1;for(var e=s.targetContainers;0<e.length;){var t=Id(s.domEventName,s.eventSystemFlags,e[0],s.nativeEvent);if(t===null){t=s.nativeEvent;var i=new t.constructor(t.type,t);vd=i,t.target.dispatchEvent(i),vd=null}else return e=Yl(t),e!==null&&fp(e),s.blockedOn=t,!1;e.shift()}return!0}function wm(s,e,t){Lc(s)&&t.delete(e)}function Dy(){Cd=!1,Rr!==null&&Lc(Rr)&&(Rr=null),br!==null&&Lc(br)&&(br=null),xr!==null&&Lc(xr)&&(xr=null),El.forEach(wm),vl.forEach(wm)}function Vo(s,e){s.blockedOn===e&&(s.blockedOn=null,Cd||(Cd=!0,kn.unstable_scheduleCallback(kn.unstable_NormalPriority,Dy)))}function yl(s){function e(n){return Vo(n,s)}if(0<_c.length){Vo(_c[0],s);for(var t=1;t<_c.length;t++){var i=_c[t];i.blockedOn===s&&(i.blockedOn=null)}}for(Rr!==null&&Vo(Rr,s),br!==null&&Vo(br,s),xr!==null&&Vo(xr,s),El.forEach(e),vl.forEach(e),t=0;t<yr.length;t++)i=yr[t],i.blockedOn===s&&(i.blockedOn=null);for(;0<yr.length&&(t=yr[0],t.blockedOn===null);)L0(t),t.blockedOn===null&&yr.shift()}var Ja=or.ReactCurrentBatchConfig,tu=!0;function Oy(s,e,t,i){var n=kt,r=Ja.transition;Ja.transition=null;try{kt=1,pp(s,e,t,i)}finally{kt=n,Ja.transition=r}}function wy(s,e,t,i){var n=kt,r=Ja.transition;Ja.transition=null;try{kt=4,pp(s,e,t,i)}finally{kt=n,Ja.transition=r}}function pp(s,e,t,i){if(tu){var n=Id(s,e,t,i);if(n===null)Dh(s,e,i,iu,t),Om(s,i);else if(Py(n,s,e,t,i))i.stopPropagation();else if(Om(s,i),e&4&&-1<My.indexOf(s)){for(;n!==null;){var r=Yl(n);if(r!==null&&D0(r),r=Id(s,e,t,i),r===null&&Dh(s,e,i,iu,t),r===n)break;n=r}n!==null&&i.stopPropagation()}else Dh(s,e,i,null,t)}}var iu=null;function Id(s,e,t,i){if(iu=null,s=up(i),s=sa(s),s!==null)if(e=Sa(s),e===null)s=null;else if(t=e.tag,t===13){if(s=S0(e),s!==null)return s;s=null}else if(t===3){if(e.stateNode.current.memoizedState.isDehydrated)return e.tag===3?e.stateNode.containerInfo:null;s=null}else e!==s&&(s=null);return iu=s,null}function N0(s){switch(s){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(yy()){case hp:return 1;case b0:return 4;case Jc:case Ay:return 16;case x0:return 536870912;default:return 16}default:return 16}}var Tr=null,mp=null,Nc=null;function B0(){if(Nc)return Nc;var s,e=mp,t=e.length,i,n="value"in Tr?Tr.value:Tr.textContent,r=n.length;for(s=0;s<t&&e[s]===n[s];s++);var a=t-s;for(i=1;i<=a&&e[t-i]===n[r-i];i++);return Nc=n.slice(s,1<i?1-i:void 0)}function Bc(s){var e=s.keyCode;return"charCode"in s?(s=s.charCode,s===0&&e===13&&(s=13)):s=e,s===10&&(s=13),32<=s||s===13?s:0}function gc(){return!0}function Fm(){return!1}function zn(s){function e(t,i,n,r,a){this._reactName=t,this._targetInst=n,this.type=i,this.nativeEvent=r,this.target=a,this.currentTarget=null;for(var o in s)s.hasOwnProperty(o)&&(t=s[o],this[o]=t?t(r):r[o]);return this.isDefaultPrevented=(r.defaultPrevented!=null?r.defaultPrevented:r.returnValue===!1)?gc:Fm,this.isPropagationStopped=Fm,this}return li(e.prototype,{preventDefault:function(){this.defaultPrevented=!0;var t=this.nativeEvent;t&&(t.preventDefault?t.preventDefault():typeof t.returnValue!="unknown"&&(t.returnValue=!1),this.isDefaultPrevented=gc)},stopPropagation:function(){var t=this.nativeEvent;t&&(t.stopPropagation?t.stopPropagation():typeof t.cancelBubble!="unknown"&&(t.cancelBubble=!0),this.isPropagationStopped=gc)},persist:function(){},isPersistent:gc}),e}var Mo={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(s){return s.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},_p=zn(Mo),Xl=li({},Mo,{view:0,detail:0}),Fy=zn(Xl),Th,Sh,Go,Bu=li({},Xl,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:gp,button:0,buttons:0,relatedTarget:function(s){return s.relatedTarget===void 0?s.fromElement===s.srcElement?s.toElement:s.fromElement:s.relatedTarget},movementX:function(s){return"movementX"in s?s.movementX:(s!==Go&&(Go&&s.type==="mousemove"?(Th=s.screenX-Go.screenX,Sh=s.screenY-Go.screenY):Sh=Th=0,Go=s),Th)},movementY:function(s){return"movementY"in s?s.movementY:Sh}}),Lm=zn(Bu),Ly=li({},Bu,{dataTransfer:0}),Ny=zn(Ly),By=li({},Xl,{relatedTarget:0}),Ch=zn(By),ky=li({},Mo,{animationName:0,elapsedTime:0,pseudoElement:0}),Uy=zn(ky),Vy=li({},Mo,{clipboardData:function(s){return"clipboardData"in s?s.clipboardData:window.clipboardData}}),Gy=zn(Vy),zy=li({},Mo,{data:0}),Nm=zn(zy),Hy={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},Wy={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},Xy={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function Yy(s){var e=this.nativeEvent;return e.getModifierState?e.getModifierState(s):(s=Xy[s])?!!e[s]:!1}function gp(){return Yy}var Ky=li({},Xl,{key:function(s){if(s.key){var e=Hy[s.key]||s.key;if(e!=="Unidentified")return e}return s.type==="keypress"?(s=Bc(s),s===13?"Enter":String.fromCharCode(s)):s.type==="keydown"||s.type==="keyup"?Wy[s.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:gp,charCode:function(s){return s.type==="keypress"?Bc(s):0},keyCode:function(s){return s.type==="keydown"||s.type==="keyup"?s.keyCode:0},which:function(s){return s.type==="keypress"?Bc(s):s.type==="keydown"||s.type==="keyup"?s.keyCode:0}}),Qy=zn(Ky),Zy=li({},Bu,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),Bm=zn(Zy),qy=li({},Xl,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:gp}),jy=zn(qy),$y=li({},Mo,{propertyName:0,elapsedTime:0,pseudoElement:0}),Jy=zn($y),eA=li({},Bu,{deltaX:function(s){return"deltaX"in s?s.deltaX:"wheelDeltaX"in s?-s.wheelDeltaX:0},deltaY:function(s){return"deltaY"in s?s.deltaY:"wheelDeltaY"in s?-s.wheelDeltaY:"wheelDelta"in s?-s.wheelDelta:0},deltaZ:0,deltaMode:0}),tA=zn(eA),iA=[9,13,27,32],Ep=tr&&"CompositionEvent"in window,il=null;tr&&"documentMode"in document&&(il=document.documentMode);var nA=tr&&"TextEvent"in window&&!il,k0=tr&&(!Ep||il&&8<il&&11>=il),km=String.fromCharCode(32),Um=!1;function U0(s,e){switch(s){case"keyup":return iA.indexOf(e.keyCode)!==-1;case"keydown":return e.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function V0(s){return s=s.detail,typeof s=="object"&&"data"in s?s.data:null}var Ua=!1;function sA(s,e){switch(s){case"compositionend":return V0(e);case"keypress":return e.which!==32?null:(Um=!0,km);case"textInput":return s=e.data,s===km&&Um?null:s;default:return null}}function rA(s,e){if(Ua)return s==="compositionend"||!Ep&&U0(s,e)?(s=B0(),Nc=mp=Tr=null,Ua=!1,s):null;switch(s){case"paste":return null;case"keypress":if(!(e.ctrlKey||e.altKey||e.metaKey)||e.ctrlKey&&e.altKey){if(e.char&&1<e.char.length)return e.char;if(e.which)return String.fromCharCode(e.which)}return null;case"compositionend":return k0&&e.locale!=="ko"?null:e.data;default:return null}}var aA={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Vm(s){var e=s&&s.nodeName&&s.nodeName.toLowerCase();return e==="input"?!!aA[s.type]:e==="textarea"}function G0(s,e,t,i){E0(i),e=nu(e,"onChange"),0<e.length&&(t=new _p("onChange","change",null,t,i),s.push({event:t,listeners:e}))}var nl=null,Al=null;function oA(s){$0(s,0)}function ku(s){var e=za(s);if(h0(e))return s}function lA(s,e){if(s==="change")return e}var z0=!1;if(tr){var Ih;if(tr){var Rh="oninput"in document;if(!Rh){var Gm=document.createElement("div");Gm.setAttribute("oninput","return;"),Rh=typeof Gm.oninput=="function"}Ih=Rh}else Ih=!1;z0=Ih&&(!document.documentMode||9<document.documentMode)}function zm(){nl&&(nl.detachEvent("onpropertychange",H0),Al=nl=null)}function H0(s){if(s.propertyName==="value"&&ku(Al)){var e=[];G0(e,Al,s,up(s)),T0(oA,e)}}function cA(s,e,t){s==="focusin"?(zm(),nl=e,Al=t,nl.attachEvent("onpropertychange",H0)):s==="focusout"&&zm()}function uA(s){if(s==="selectionchange"||s==="keyup"||s==="keydown")return ku(Al)}function hA(s,e){if(s==="click")return ku(e)}function dA(s,e){if(s==="input"||s==="change")return ku(e)}function fA(s,e){return s===e&&(s!==0||1/s===1/e)||s!==s&&e!==e}var ms=typeof Object.is=="function"?Object.is:fA;function Tl(s,e){if(ms(s,e))return!0;if(typeof s!="object"||s===null||typeof e!="object"||e===null)return!1;var t=Object.keys(s),i=Object.keys(e);if(t.length!==i.length)return!1;for(i=0;i<t.length;i++){var n=t[i];if(!od.call(e,n)||!ms(s[n],e[n]))return!1}return!0}function Hm(s){for(;s&&s.firstChild;)s=s.firstChild;return s}function Wm(s,e){var t=Hm(s);s=0;for(var i;t;){if(t.nodeType===3){if(i=s+t.textContent.length,s<=e&&i>=e)return{node:t,offset:e-s};s=i}e:{for(;t;){if(t.nextSibling){t=t.nextSibling;break e}t=t.parentNode}t=void 0}t=Hm(t)}}function W0(s,e){return s&&e?s===e?!0:s&&s.nodeType===3?!1:e&&e.nodeType===3?W0(s,e.parentNode):"contains"in s?s.contains(e):s.compareDocumentPosition?!!(s.compareDocumentPosition(e)&16):!1:!1}function X0(){for(var s=window,e=qc();e instanceof s.HTMLIFrameElement;){try{var t=typeof e.contentWindow.location.href=="string"}catch(i){t=!1}if(t)s=e.contentWindow;else break;e=qc(s.document)}return e}function vp(s){var e=s&&s.nodeName&&s.nodeName.toLowerCase();return e&&(e==="input"&&(s.type==="text"||s.type==="search"||s.type==="tel"||s.type==="url"||s.type==="password")||e==="textarea"||s.contentEditable==="true")}function pA(s){var e=X0(),t=s.focusedElem,i=s.selectionRange;if(e!==t&&t&&t.ownerDocument&&W0(t.ownerDocument.documentElement,t)){if(i!==null&&vp(t)){if(e=i.start,s=i.end,s===void 0&&(s=e),"selectionStart"in t)t.selectionStart=e,t.selectionEnd=Math.min(s,t.value.length);else if(s=(e=t.ownerDocument||document)&&e.defaultView||window,s.getSelection){s=s.getSelection();var n=t.textContent.length,r=Math.min(i.start,n);i=i.end===void 0?r:Math.min(i.end,n),!s.extend&&r>i&&(n=i,i=r,r=n),n=Wm(t,r);var a=Wm(t,i);n&&a&&(s.rangeCount!==1||s.anchorNode!==n.node||s.anchorOffset!==n.offset||s.focusNode!==a.node||s.focusOffset!==a.offset)&&(e=e.createRange(),e.setStart(n.node,n.offset),s.removeAllRanges(),r>i?(s.addRange(e),s.extend(a.node,a.offset)):(e.setEnd(a.node,a.offset),s.addRange(e)))}}for(e=[],s=t;s=s.parentNode;)s.nodeType===1&&e.push({element:s,left:s.scrollLeft,top:s.scrollTop});for(typeof t.focus=="function"&&t.focus(),t=0;t<e.length;t++)s=e[t],s.element.scrollLeft=s.left,s.element.scrollTop=s.top}}var mA=tr&&"documentMode"in document&&11>=document.documentMode,Va=null,Rd=null,sl=null,bd=!1;function Xm(s,e,t){var i=t.window===t?t.document:t.nodeType===9?t:t.ownerDocument;bd||Va==null||Va!==qc(i)||(i=Va,"selectionStart"in i&&vp(i)?i={start:i.selectionStart,end:i.selectionEnd}:(i=(i.ownerDocument&&i.ownerDocument.defaultView||window).getSelection(),i={anchorNode:i.anchorNode,anchorOffset:i.anchorOffset,focusNode:i.focusNode,focusOffset:i.focusOffset}),sl&&Tl(sl,i)||(sl=i,i=nu(Rd,"onSelect"),0<i.length&&(e=new _p("onSelect","select",null,e,t),s.push({event:e,listeners:i}),e.target=Va)))}function Ec(s,e){var t={};return t[s.toLowerCase()]=e.toLowerCase(),t["Webkit"+s]="webkit"+e,t["Moz"+s]="moz"+e,t}var Ga={animationend:Ec("Animation","AnimationEnd"),animationiteration:Ec("Animation","AnimationIteration"),animationstart:Ec("Animation","AnimationStart"),transitionend:Ec("Transition","TransitionEnd")},bh={},Y0={};tr&&(Y0=document.createElement("div").style,"AnimationEvent"in window||(delete Ga.animationend.animation,delete Ga.animationiteration.animation,delete Ga.animationstart.animation),"TransitionEvent"in window||delete Ga.transitionend.transition);function Uu(s){if(bh[s])return bh[s];if(!Ga[s])return s;var e=Ga[s],t;for(t in e)if(e.hasOwnProperty(t)&&t in Y0)return bh[s]=e[t];return s}var K0=Uu("animationend"),Q0=Uu("animationiteration"),Z0=Uu("animationstart"),q0=Uu("transitionend"),j0=new Map,Ym="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function Wr(s,e){j0.set(s,e),Ta(e,[s])}for(var xh=0;xh<Ym.length;xh++){var Mh=Ym[xh],_A=Mh.toLowerCase(),gA=Mh[0].toUpperCase()+Mh.slice(1);Wr(_A,"on"+gA)}Wr(K0,"onAnimationEnd");Wr(Q0,"onAnimationIteration");Wr(Z0,"onAnimationStart");Wr("dblclick","onDoubleClick");Wr("focusin","onFocus");Wr("focusout","onBlur");Wr(q0,"onTransitionEnd");fo("onMouseEnter",["mouseout","mouseover"]);fo("onMouseLeave",["mouseout","mouseover"]);fo("onPointerEnter",["pointerout","pointerover"]);fo("onPointerLeave",["pointerout","pointerover"]);Ta("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));Ta("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));Ta("onBeforeInput",["compositionend","keypress","textInput","paste"]);Ta("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));Ta("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));Ta("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var qo="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),EA=new Set("cancel close invalid load scroll toggle".split(" ").concat(qo));function Km(s,e,t){var i=s.type||"unknown-event";s.currentTarget=t,_y(i,e,void 0,s),s.currentTarget=null}function $0(s,e){e=(e&4)!==0;for(var t=0;t<s.length;t++){var i=s[t],n=i.event;i=i.listeners;e:{var r=void 0;if(e)for(var a=i.length-1;0<=a;a--){var o=i[a],l=o.instance,c=o.currentTarget;if(o=o.listener,l!==r&&n.isPropagationStopped())break e;Km(n,o,c),r=l}else for(a=0;a<i.length;a++){if(o=i[a],l=o.instance,c=o.currentTarget,o=o.listener,l!==r&&n.isPropagationStopped())break e;Km(n,o,c),r=l}}}if($c)throw s=Td,$c=!1,Td=null,s}function ei(s,e){var t=e[Od];t===void 0&&(t=e[Od]=new Set);var i=s+"__bubble";t.has(i)||(J0(e,s,2,!1),t.add(i))}function Ph(s,e,t){var i=0;e&&(i|=4),J0(t,s,i,e)}var vc="_reactListening"+Math.random().toString(36).slice(2);function Sl(s){if(!s[vc]){s[vc]=!0,a0.forEach(function(t){t!=="selectionchange"&&(EA.has(t)||Ph(t,!1,s),Ph(t,!0,s))});var e=s.nodeType===9?s:s.ownerDocument;e===null||e[vc]||(e[vc]=!0,Ph("selectionchange",!1,e))}}function J0(s,e,t,i){switch(N0(e)){case 1:var n=Oy;break;case 4:n=wy;break;default:n=pp}t=n.bind(null,e,t,s),n=void 0,!Ad||e!=="touchstart"&&e!=="touchmove"&&e!=="wheel"||(n=!0),i?n!==void 0?s.addEventListener(e,t,{capture:!0,passive:n}):s.addEventListener(e,t,!0):n!==void 0?s.addEventListener(e,t,{passive:n}):s.addEventListener(e,t,!1)}function Dh(s,e,t,i,n){var r=i;if(!(e&1)&&!(e&2)&&i!==null)e:for(;;){if(i===null)return;var a=i.tag;if(a===3||a===4){var o=i.stateNode.containerInfo;if(o===n||o.nodeType===8&&o.parentNode===n)break;if(a===4)for(a=i.return;a!==null;){var l=a.tag;if((l===3||l===4)&&(l=a.stateNode.containerInfo,l===n||l.nodeType===8&&l.parentNode===n))return;a=a.return}for(;o!==null;){if(a=sa(o),a===null)return;if(l=a.tag,l===5||l===6){i=r=a;continue e}o=o.parentNode}}i=i.return}T0(function(){var c=r,u=up(t),h=[];e:{var d=j0.get(s);if(d!==void 0){var f=_p,p=s;switch(s){case"keypress":if(Bc(t)===0)break e;case"keydown":case"keyup":f=Qy;break;case"focusin":p="focus",f=Ch;break;case"focusout":p="blur",f=Ch;break;case"beforeblur":case"afterblur":f=Ch;break;case"click":if(t.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":f=Lm;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":f=Ny;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":f=jy;break;case K0:case Q0:case Z0:f=Uy;break;case q0:f=Jy;break;case"scroll":f=Fy;break;case"wheel":f=tA;break;case"copy":case"cut":case"paste":f=Gy;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":f=Bm}var m=(e&4)!==0,_=!m&&s==="scroll",E=m?d!==null?d+"Capture":null:d;m=[];for(var v=c,y;v!==null;){y=v;var A=y.stateNode;if(y.tag===5&&A!==null&&(y=A,E!==null&&(A=gl(v,E),A!=null&&m.push(Cl(v,A,y)))),_)break;v=v.return}0<m.length&&(d=new f(d,p,null,t,u),h.push({event:d,listeners:m}))}}if(!(e&7)){e:{if(d=s==="mouseover"||s==="pointerover",f=s==="mouseout"||s==="pointerout",d&&t!==vd&&(p=t.relatedTarget||t.fromElement)&&(sa(p)||p[ir]))break e;if((f||d)&&(d=u.window===u?u:(d=u.ownerDocument)?d.defaultView||d.parentWindow:window,f?(p=t.relatedTarget||t.toElement,f=c,p=p?sa(p):null,p!==null&&(_=Sa(p),p!==_||p.tag!==5&&p.tag!==6)&&(p=null)):(f=null,p=c),f!==p)){if(m=Lm,A="onMouseLeave",E="onMouseEnter",v="mouse",(s==="pointerout"||s==="pointerover")&&(m=Bm,A="onPointerLeave",E="onPointerEnter",v="pointer"),_=f==null?d:za(f),y=p==null?d:za(p),d=new m(A,v+"leave",f,t,u),d.target=_,d.relatedTarget=y,A=null,sa(u)===c&&(m=new m(E,v+"enter",p,t,u),m.target=y,m.relatedTarget=_,A=m),_=A,f&&p)t:{for(m=f,E=p,v=0,y=m;y;y=ba(y))v++;for(y=0,A=E;A;A=ba(A))y++;for(;0<v-y;)m=ba(m),v--;for(;0<y-v;)E=ba(E),y--;for(;v--;){if(m===E||E!==null&&m===E.alternate)break t;m=ba(m),E=ba(E)}m=null}else m=null;f!==null&&Qm(h,d,f,m,!1),p!==null&&_!==null&&Qm(h,_,p,m,!0)}}e:{if(d=c?za(c):window,f=d.nodeName&&d.nodeName.toLowerCase(),f==="select"||f==="input"&&d.type==="file")var I=lA;else if(Vm(d))if(z0)I=dA;else{I=uA;var T=cA}else(f=d.nodeName)&&f.toLowerCase()==="input"&&(d.type==="checkbox"||d.type==="radio")&&(I=hA);if(I&&(I=I(s,c))){G0(h,I,t,u);break e}T&&T(s,d,c),s==="focusout"&&(T=d._wrapperState)&&T.controlled&&d.type==="number"&&pd(d,"number",d.value)}switch(T=c?za(c):window,s){case"focusin":(Vm(T)||T.contentEditable==="true")&&(Va=T,Rd=c,sl=null);break;case"focusout":sl=Rd=Va=null;break;case"mousedown":bd=!0;break;case"contextmenu":case"mouseup":case"dragend":bd=!1,Xm(h,t,u);break;case"selectionchange":if(mA)break;case"keydown":case"keyup":Xm(h,t,u)}var R;if(Ep)e:{switch(s){case"compositionstart":var x="onCompositionStart";break e;case"compositionend":x="onCompositionEnd";break e;case"compositionupdate":x="onCompositionUpdate";break e}x=void 0}else Ua?U0(s,t)&&(x="onCompositionEnd"):s==="keydown"&&t.keyCode===229&&(x="onCompositionStart");x&&(k0&&t.locale!=="ko"&&(Ua||x!=="onCompositionStart"?x==="onCompositionEnd"&&Ua&&(R=B0()):(Tr=u,mp="value"in Tr?Tr.value:Tr.textContent,Ua=!0)),T=nu(c,x),0<T.length&&(x=new Nm(x,s,null,t,u),h.push({event:x,listeners:T}),R?x.data=R:(R=V0(t),R!==null&&(x.data=R)))),(R=nA?sA(s,t):rA(s,t))&&(c=nu(c,"onBeforeInput"),0<c.length&&(u=new Nm("onBeforeInput","beforeinput",null,t,u),h.push({event:u,listeners:c}),u.data=R))}$0(h,e)})}function Cl(s,e,t){return{instance:s,listener:e,currentTarget:t}}function nu(s,e){for(var t=e+"Capture",i=[];s!==null;){var n=s,r=n.stateNode;n.tag===5&&r!==null&&(n=r,r=gl(s,t),r!=null&&i.unshift(Cl(s,r,n)),r=gl(s,e),r!=null&&i.push(Cl(s,r,n))),s=s.return}return i}function ba(s){if(s===null)return null;do s=s.return;while(s&&s.tag!==5);return s||null}function Qm(s,e,t,i,n){for(var r=e._reactName,a=[];t!==null&&t!==i;){var o=t,l=o.alternate,c=o.stateNode;if(l!==null&&l===i)break;o.tag===5&&c!==null&&(o=c,n?(l=gl(t,r),l!=null&&a.unshift(Cl(t,l,o))):n||(l=gl(t,r),l!=null&&a.push(Cl(t,l,o)))),t=t.return}a.length!==0&&s.push({event:e,listeners:a})}var vA=/\r\n?/g,yA=/\u0000|\uFFFD/g;function Zm(s){return(typeof s=="string"?s:""+s).replace(vA,`
`).replace(yA,"")}function yc(s,e,t){if(e=Zm(e),Zm(s)!==e&&t)throw Error(ue(425))}function su(){}var xd=null,Md=null;function Pd(s,e){return s==="textarea"||s==="noscript"||typeof e.children=="string"||typeof e.children=="number"||typeof e.dangerouslySetInnerHTML=="object"&&e.dangerouslySetInnerHTML!==null&&e.dangerouslySetInnerHTML.__html!=null}var Dd=typeof setTimeout=="function"?setTimeout:void 0,AA=typeof clearTimeout=="function"?clearTimeout:void 0,qm=typeof Promise=="function"?Promise:void 0,TA=typeof queueMicrotask=="function"?queueMicrotask:typeof qm!="undefined"?function(s){return qm.resolve(null).then(s).catch(SA)}:Dd;function SA(s){setTimeout(function(){throw s})}function Oh(s,e){var t=e,i=0;do{var n=t.nextSibling;if(s.removeChild(t),n&&n.nodeType===8)if(t=n.data,t==="/$"){if(i===0){s.removeChild(n),yl(e);return}i--}else t!=="$"&&t!=="$?"&&t!=="$!"||i++;t=n}while(t);yl(e)}function Mr(s){for(;s!=null;s=s.nextSibling){var e=s.nodeType;if(e===1||e===3)break;if(e===8){if(e=s.data,e==="$"||e==="$!"||e==="$?")break;if(e==="/$")return null}}return s}function jm(s){s=s.previousSibling;for(var e=0;s;){if(s.nodeType===8){var t=s.data;if(t==="$"||t==="$!"||t==="$?"){if(e===0)return s;e--}else t==="/$"&&e++}s=s.previousSibling}return null}var Po=Math.random().toString(36).slice(2),bs="__reactFiber$"+Po,Il="__reactProps$"+Po,ir="__reactContainer$"+Po,Od="__reactEvents$"+Po,CA="__reactListeners$"+Po,IA="__reactHandles$"+Po;function sa(s){var e=s[bs];if(e)return e;for(var t=s.parentNode;t;){if(e=t[ir]||t[bs]){if(t=e.alternate,e.child!==null||t!==null&&t.child!==null)for(s=jm(s);s!==null;){if(t=s[bs])return t;s=jm(s)}return e}s=t,t=s.parentNode}return null}function Yl(s){return s=s[bs]||s[ir],!s||s.tag!==5&&s.tag!==6&&s.tag!==13&&s.tag!==3?null:s}function za(s){if(s.tag===5||s.tag===6)return s.stateNode;throw Error(ue(33))}function Vu(s){return s[Il]||null}var wd=[],Ha=-1;function Xr(s){return{current:s}}function ti(s){0>Ha||(s.current=wd[Ha],wd[Ha]=null,Ha--)}function jt(s,e){Ha++,wd[Ha]=s.current,s.current=e}var Ur={},Zi=Xr(Ur),Rn=Xr(!1),_a=Ur;function po(s,e){var t=s.type.contextTypes;if(!t)return Ur;var i=s.stateNode;if(i&&i.__reactInternalMemoizedUnmaskedChildContext===e)return i.__reactInternalMemoizedMaskedChildContext;var n={},r;for(r in t)n[r]=e[r];return i&&(s=s.stateNode,s.__reactInternalMemoizedUnmaskedChildContext=e,s.__reactInternalMemoizedMaskedChildContext=n),n}function bn(s){return s=s.childContextTypes,s!=null}function ru(){ti(Rn),ti(Zi)}function $m(s,e,t){if(Zi.current!==Ur)throw Error(ue(168));jt(Zi,e),jt(Rn,t)}function e1(s,e,t){var i=s.stateNode;if(e=e.childContextTypes,typeof i.getChildContext!="function")return t;i=i.getChildContext();for(var n in i)if(!(n in e))throw Error(ue(108,cy(s)||"Unknown",n));return li({},t,i)}function au(s){return s=(s=s.stateNode)&&s.__reactInternalMemoizedMergedChildContext||Ur,_a=Zi.current,jt(Zi,s),jt(Rn,Rn.current),!0}function Jm(s,e,t){var i=s.stateNode;if(!i)throw Error(ue(169));t?(s=e1(s,e,_a),i.__reactInternalMemoizedMergedChildContext=s,ti(Rn),ti(Zi),jt(Zi,s)):ti(Rn),jt(Rn,t)}var Ws=null,Gu=!1,wh=!1;function t1(s){Ws===null?Ws=[s]:Ws.push(s)}function RA(s){Gu=!0,t1(s)}function Yr(){if(!wh&&Ws!==null){wh=!0;var s=0,e=kt;try{var t=Ws;for(kt=1;s<t.length;s++){var i=t[s];do i=i(!0);while(i!==null)}Ws=null,Gu=!1}catch(n){throw Ws!==null&&(Ws=Ws.slice(s+1)),R0(hp,Yr),n}finally{kt=e,wh=!1}}return null}var Wa=[],Xa=0,ou=null,lu=0,Kn=[],Qn=0,ga=null,Zs=1,qs="";function jr(s,e){Wa[Xa++]=lu,Wa[Xa++]=ou,ou=s,lu=e}function i1(s,e,t){Kn[Qn++]=Zs,Kn[Qn++]=qs,Kn[Qn++]=ga,ga=s;var i=Zs;s=qs;var n=32-ds(i)-1;i&=~(1<<n),t+=1;var r=32-ds(e)+n;if(30<r){var a=n-n%5;r=(i&(1<<a)-1).toString(32),i>>=a,n-=a,Zs=1<<32-ds(e)+n|t<<n|i,qs=r+s}else Zs=1<<r|t<<n|i,qs=s}function yp(s){s.return!==null&&(jr(s,1),i1(s,1,0))}function Ap(s){for(;s===ou;)ou=Wa[--Xa],Wa[Xa]=null,lu=Wa[--Xa],Wa[Xa]=null;for(;s===ga;)ga=Kn[--Qn],Kn[Qn]=null,qs=Kn[--Qn],Kn[Qn]=null,Zs=Kn[--Qn],Kn[Qn]=null}var Bn=null,Nn=null,ni=!1,us=null;function n1(s,e){var t=$n(5,null,null,0);t.elementType="DELETED",t.stateNode=e,t.return=s,e=s.deletions,e===null?(s.deletions=[t],s.flags|=16):e.push(t)}function e_(s,e){switch(s.tag){case 5:var t=s.type;return e=e.nodeType!==1||t.toLowerCase()!==e.nodeName.toLowerCase()?null:e,e!==null?(s.stateNode=e,Bn=s,Nn=Mr(e.firstChild),!0):!1;case 6:return e=s.pendingProps===""||e.nodeType!==3?null:e,e!==null?(s.stateNode=e,Bn=s,Nn=null,!0):!1;case 13:return e=e.nodeType!==8?null:e,e!==null?(t=ga!==null?{id:Zs,overflow:qs}:null,s.memoizedState={dehydrated:e,treeContext:t,retryLane:1073741824},t=$n(18,null,null,0),t.stateNode=e,t.return=s,s.child=t,Bn=s,Nn=null,!0):!1;default:return!1}}function Fd(s){return(s.mode&1)!==0&&(s.flags&128)===0}function Ld(s){if(ni){var e=Nn;if(e){var t=e;if(!e_(s,e)){if(Fd(s))throw Error(ue(418));e=Mr(t.nextSibling);var i=Bn;e&&e_(s,e)?n1(i,t):(s.flags=s.flags&-4097|2,ni=!1,Bn=s)}}else{if(Fd(s))throw Error(ue(418));s.flags=s.flags&-4097|2,ni=!1,Bn=s}}}function t_(s){for(s=s.return;s!==null&&s.tag!==5&&s.tag!==3&&s.tag!==13;)s=s.return;Bn=s}function Ac(s){if(s!==Bn)return!1;if(!ni)return t_(s),ni=!0,!1;var e;if((e=s.tag!==3)&&!(e=s.tag!==5)&&(e=s.type,e=e!=="head"&&e!=="body"&&!Pd(s.type,s.memoizedProps)),e&&(e=Nn)){if(Fd(s))throw s1(),Error(ue(418));for(;e;)n1(s,e),e=Mr(e.nextSibling)}if(t_(s),s.tag===13){if(s=s.memoizedState,s=s!==null?s.dehydrated:null,!s)throw Error(ue(317));e:{for(s=s.nextSibling,e=0;s;){if(s.nodeType===8){var t=s.data;if(t==="/$"){if(e===0){Nn=Mr(s.nextSibling);break e}e--}else t!=="$"&&t!=="$!"&&t!=="$?"||e++}s=s.nextSibling}Nn=null}}else Nn=Bn?Mr(s.stateNode.nextSibling):null;return!0}function s1(){for(var s=Nn;s;)s=Mr(s.nextSibling)}function mo(){Nn=Bn=null,ni=!1}function Tp(s){us===null?us=[s]:us.push(s)}var bA=or.ReactCurrentBatchConfig;function os(s,e){if(s&&s.defaultProps){e=li({},e),s=s.defaultProps;for(var t in s)e[t]===void 0&&(e[t]=s[t]);return e}return e}var cu=Xr(null),uu=null,Ya=null,Sp=null;function Cp(){Sp=Ya=uu=null}function Ip(s){var e=cu.current;ti(cu),s._currentValue=e}function Nd(s,e,t){for(;s!==null;){var i=s.alternate;if((s.childLanes&e)!==e?(s.childLanes|=e,i!==null&&(i.childLanes|=e)):i!==null&&(i.childLanes&e)!==e&&(i.childLanes|=e),s===t)break;s=s.return}}function eo(s,e){uu=s,Sp=Ya=null,s=s.dependencies,s!==null&&s.firstContext!==null&&(s.lanes&e&&(In=!0),s.firstContext=null)}function is(s){var e=s._currentValue;if(Sp!==s)if(s={context:s,memoizedValue:e,next:null},Ya===null){if(uu===null)throw Error(ue(308));Ya=s,uu.dependencies={lanes:0,firstContext:s}}else Ya=Ya.next=s;return e}var ra=null;function Rp(s){ra===null?ra=[s]:ra.push(s)}function r1(s,e,t,i){var n=e.interleaved;return n===null?(t.next=t,Rp(e)):(t.next=n.next,n.next=t),e.interleaved=t,nr(s,i)}function nr(s,e){s.lanes|=e;var t=s.alternate;for(t!==null&&(t.lanes|=e),t=s,s=s.return;s!==null;)s.childLanes|=e,t=s.alternate,t!==null&&(t.childLanes|=e),t=s,s=s.return;return t.tag===3?t.stateNode:null}var gr=!1;function bp(s){s.updateQueue={baseState:s.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function a1(s,e){s=s.updateQueue,e.updateQueue===s&&(e.updateQueue={baseState:s.baseState,firstBaseUpdate:s.firstBaseUpdate,lastBaseUpdate:s.lastBaseUpdate,shared:s.shared,effects:s.effects})}function Js(s,e){return{eventTime:s,lane:e,tag:0,payload:null,callback:null,next:null}}function Pr(s,e,t){var i=s.updateQueue;if(i===null)return null;if(i=i.shared,Ct&2){var n=i.pending;return n===null?e.next=e:(e.next=n.next,n.next=e),i.pending=e,nr(s,t)}return n=i.interleaved,n===null?(e.next=e,Rp(i)):(e.next=n.next,n.next=e),i.interleaved=e,nr(s,t)}function kc(s,e,t){if(e=e.updateQueue,e!==null&&(e=e.shared,(t&4194240)!==0)){var i=e.lanes;i&=s.pendingLanes,t|=i,e.lanes=t,dp(s,t)}}function i_(s,e){var t=s.updateQueue,i=s.alternate;if(i!==null&&(i=i.updateQueue,t===i)){var n=null,r=null;if(t=t.firstBaseUpdate,t!==null){do{var a={eventTime:t.eventTime,lane:t.lane,tag:t.tag,payload:t.payload,callback:t.callback,next:null};r===null?n=r=a:r=r.next=a,t=t.next}while(t!==null);r===null?n=r=e:r=r.next=e}else n=r=e;t={baseState:i.baseState,firstBaseUpdate:n,lastBaseUpdate:r,shared:i.shared,effects:i.effects},s.updateQueue=t;return}s=t.lastBaseUpdate,s===null?t.firstBaseUpdate=e:s.next=e,t.lastBaseUpdate=e}function hu(s,e,t,i){var n=s.updateQueue;gr=!1;var r=n.firstBaseUpdate,a=n.lastBaseUpdate,o=n.shared.pending;if(o!==null){n.shared.pending=null;var l=o,c=l.next;l.next=null,a===null?r=c:a.next=c,a=l;var u=s.alternate;u!==null&&(u=u.updateQueue,o=u.lastBaseUpdate,o!==a&&(o===null?u.firstBaseUpdate=c:o.next=c,u.lastBaseUpdate=l))}if(r!==null){var h=n.baseState;a=0,u=c=l=null,o=r;do{var d=o.lane,f=o.eventTime;if((i&d)===d){u!==null&&(u=u.next={eventTime:f,lane:0,tag:o.tag,payload:o.payload,callback:o.callback,next:null});e:{var p=s,m=o;switch(d=e,f=t,m.tag){case 1:if(p=m.payload,typeof p=="function"){h=p.call(f,h,d);break e}h=p;break e;case 3:p.flags=p.flags&-65537|128;case 0:if(p=m.payload,d=typeof p=="function"?p.call(f,h,d):p,d==null)break e;h=li({},h,d);break e;case 2:gr=!0}}o.callback!==null&&o.lane!==0&&(s.flags|=64,d=n.effects,d===null?n.effects=[o]:d.push(o))}else f={eventTime:f,lane:d,tag:o.tag,payload:o.payload,callback:o.callback,next:null},u===null?(c=u=f,l=h):u=u.next=f,a|=d;if(o=o.next,o===null){if(o=n.shared.pending,o===null)break;d=o,o=d.next,d.next=null,n.lastBaseUpdate=d,n.shared.pending=null}}while(1);if(u===null&&(l=h),n.baseState=l,n.firstBaseUpdate=c,n.lastBaseUpdate=u,e=n.shared.interleaved,e!==null){n=e;do a|=n.lane,n=n.next;while(n!==e)}else r===null&&(n.shared.lanes=0);va|=a,s.lanes=a,s.memoizedState=h}}function n_(s,e,t){if(s=e.effects,e.effects=null,s!==null)for(e=0;e<s.length;e++){var i=s[e],n=i.callback;if(n!==null){if(i.callback=null,i=t,typeof n!="function")throw Error(ue(191,n));n.call(i)}}}var o1=new r0.Component().refs;function Bd(s,e,t,i){e=s.memoizedState,t=t(i,e),t=t==null?e:li({},e,t),s.memoizedState=t,s.lanes===0&&(s.updateQueue.baseState=t)}var zu={isMounted:function(s){return(s=s._reactInternals)?Sa(s)===s:!1},enqueueSetState:function(s,e,t){s=s._reactInternals;var i=un(),n=Or(s),r=Js(i,n);r.payload=e,t!=null&&(r.callback=t),e=Pr(s,r,n),e!==null&&(fs(e,s,n,i),kc(e,s,n))},enqueueReplaceState:function(s,e,t){s=s._reactInternals;var i=un(),n=Or(s),r=Js(i,n);r.tag=1,r.payload=e,t!=null&&(r.callback=t),e=Pr(s,r,n),e!==null&&(fs(e,s,n,i),kc(e,s,n))},enqueueForceUpdate:function(s,e){s=s._reactInternals;var t=un(),i=Or(s),n=Js(t,i);n.tag=2,e!=null&&(n.callback=e),e=Pr(s,n,i),e!==null&&(fs(e,s,i,t),kc(e,s,i))}};function s_(s,e,t,i,n,r,a){return s=s.stateNode,typeof s.shouldComponentUpdate=="function"?s.shouldComponentUpdate(i,r,a):e.prototype&&e.prototype.isPureReactComponent?!Tl(t,i)||!Tl(n,r):!0}function l1(s,e,t){var i=!1,n=Ur,r=e.contextType;return typeof r=="object"&&r!==null?r=is(r):(n=bn(e)?_a:Zi.current,i=e.contextTypes,r=(i=i!=null)?po(s,n):Ur),e=new e(t,r),s.memoizedState=e.state!==null&&e.state!==void 0?e.state:null,e.updater=zu,s.stateNode=e,e._reactInternals=s,i&&(s=s.stateNode,s.__reactInternalMemoizedUnmaskedChildContext=n,s.__reactInternalMemoizedMaskedChildContext=r),e}function r_(s,e,t,i){s=e.state,typeof e.componentWillReceiveProps=="function"&&e.componentWillReceiveProps(t,i),typeof e.UNSAFE_componentWillReceiveProps=="function"&&e.UNSAFE_componentWillReceiveProps(t,i),e.state!==s&&zu.enqueueReplaceState(e,e.state,null)}function kd(s,e,t,i){var n=s.stateNode;n.props=t,n.state=s.memoizedState,n.refs=o1,bp(s);var r=e.contextType;typeof r=="object"&&r!==null?n.context=is(r):(r=bn(e)?_a:Zi.current,n.context=po(s,r)),n.state=s.memoizedState,r=e.getDerivedStateFromProps,typeof r=="function"&&(Bd(s,e,r,t),n.state=s.memoizedState),typeof e.getDerivedStateFromProps=="function"||typeof n.getSnapshotBeforeUpdate=="function"||typeof n.UNSAFE_componentWillMount!="function"&&typeof n.componentWillMount!="function"||(e=n.state,typeof n.componentWillMount=="function"&&n.componentWillMount(),typeof n.UNSAFE_componentWillMount=="function"&&n.UNSAFE_componentWillMount(),e!==n.state&&zu.enqueueReplaceState(n,n.state,null),hu(s,t,n,i),n.state=s.memoizedState),typeof n.componentDidMount=="function"&&(s.flags|=4194308)}function zo(s,e,t){if(s=t.ref,s!==null&&typeof s!="function"&&typeof s!="object"){if(t._owner){if(t=t._owner,t){if(t.tag!==1)throw Error(ue(309));var i=t.stateNode}if(!i)throw Error(ue(147,s));var n=i,r=""+s;return e!==null&&e.ref!==null&&typeof e.ref=="function"&&e.ref._stringRef===r?e.ref:(e=function(a){var o=n.refs;o===o1&&(o=n.refs={}),a===null?delete o[r]:o[r]=a},e._stringRef=r,e)}if(typeof s!="string")throw Error(ue(284));if(!t._owner)throw Error(ue(290,s))}return s}function Tc(s,e){throw s=Object.prototype.toString.call(e),Error(ue(31,s==="[object Object]"?"object with keys {"+Object.keys(e).join(", ")+"}":s))}function a_(s){var e=s._init;return e(s._payload)}function c1(s){function e(E,v){if(s){var y=E.deletions;y===null?(E.deletions=[v],E.flags|=16):y.push(v)}}function t(E,v){if(!s)return null;for(;v!==null;)e(E,v),v=v.sibling;return null}function i(E,v){for(E=new Map;v!==null;)v.key!==null?E.set(v.key,v):E.set(v.index,v),v=v.sibling;return E}function n(E,v){return E=wr(E,v),E.index=0,E.sibling=null,E}function r(E,v,y){return E.index=y,s?(y=E.alternate,y!==null?(y=y.index,y<v?(E.flags|=2,v):y):(E.flags|=2,v)):(E.flags|=1048576,v)}function a(E){return s&&E.alternate===null&&(E.flags|=2),E}function o(E,v,y,A){return v===null||v.tag!==6?(v=Vh(y,E.mode,A),v.return=E,v):(v=n(v,y),v.return=E,v)}function l(E,v,y,A){var I=y.type;return I===ka?u(E,v,y.props.children,A,y.key):v!==null&&(v.elementType===I||typeof I=="object"&&I!==null&&I.$$typeof===_r&&a_(I)===v.type)?(A=n(v,y.props),A.ref=zo(E,v,y),A.return=E,A):(A=Wc(y.type,y.key,y.props,null,E.mode,A),A.ref=zo(E,v,y),A.return=E,A)}function c(E,v,y,A){return v===null||v.tag!==4||v.stateNode.containerInfo!==y.containerInfo||v.stateNode.implementation!==y.implementation?(v=Gh(y,E.mode,A),v.return=E,v):(v=n(v,y.children||[]),v.return=E,v)}function u(E,v,y,A,I){return v===null||v.tag!==7?(v=la(y,E.mode,A,I),v.return=E,v):(v=n(v,y),v.return=E,v)}function h(E,v,y){if(typeof v=="string"&&v!==""||typeof v=="number")return v=Vh(""+v,E.mode,y),v.return=E,v;if(typeof v=="object"&&v!==null){switch(v.$$typeof){case hc:return y=Wc(v.type,v.key,v.props,null,E.mode,y),y.ref=zo(E,null,v),y.return=E,y;case Ba:return v=Gh(v,E.mode,y),v.return=E,v;case _r:var A=v._init;return h(E,A(v._payload),y)}if(Qo(v)||Bo(v))return v=la(v,E.mode,y,null),v.return=E,v;Tc(E,v)}return null}function d(E,v,y,A){var I=v!==null?v.key:null;if(typeof y=="string"&&y!==""||typeof y=="number")return I!==null?null:o(E,v,""+y,A);if(typeof y=="object"&&y!==null){switch(y.$$typeof){case hc:return y.key===I?l(E,v,y,A):null;case Ba:return y.key===I?c(E,v,y,A):null;case _r:return I=y._init,d(E,v,I(y._payload),A)}if(Qo(y)||Bo(y))return I!==null?null:u(E,v,y,A,null);Tc(E,y)}return null}function f(E,v,y,A,I){if(typeof A=="string"&&A!==""||typeof A=="number")return E=E.get(y)||null,o(v,E,""+A,I);if(typeof A=="object"&&A!==null){switch(A.$$typeof){case hc:return E=E.get(A.key===null?y:A.key)||null,l(v,E,A,I);case Ba:return E=E.get(A.key===null?y:A.key)||null,c(v,E,A,I);case _r:var T=A._init;return f(E,v,y,T(A._payload),I)}if(Qo(A)||Bo(A))return E=E.get(y)||null,u(v,E,A,I,null);Tc(v,A)}return null}function p(E,v,y,A){for(var I=null,T=null,R=v,x=v=0,F=null;R!==null&&x<y.length;x++){R.index>x?(F=R,R=null):F=R.sibling;var L=d(E,R,y[x],A);if(L===null){R===null&&(R=F);break}s&&R&&L.alternate===null&&e(E,R),v=r(L,v,x),T===null?I=L:T.sibling=L,T=L,R=F}if(x===y.length)return t(E,R),ni&&jr(E,x),I;if(R===null){for(;x<y.length;x++)R=h(E,y[x],A),R!==null&&(v=r(R,v,x),T===null?I=R:T.sibling=R,T=R);return ni&&jr(E,x),I}for(R=i(E,R);x<y.length;x++)F=f(R,E,x,y[x],A),F!==null&&(s&&F.alternate!==null&&R.delete(F.key===null?x:F.key),v=r(F,v,x),T===null?I=F:T.sibling=F,T=F);return s&&R.forEach(function(V){return e(E,V)}),ni&&jr(E,x),I}function m(E,v,y,A){var I=Bo(y);if(typeof I!="function")throw Error(ue(150));if(y=I.call(y),y==null)throw Error(ue(151));for(var T=I=null,R=v,x=v=0,F=null,L=y.next();R!==null&&!L.done;x++,L=y.next()){R.index>x?(F=R,R=null):F=R.sibling;var V=d(E,R,L.value,A);if(V===null){R===null&&(R=F);break}s&&R&&V.alternate===null&&e(E,R),v=r(V,v,x),T===null?I=V:T.sibling=V,T=V,R=F}if(L.done)return t(E,R),ni&&jr(E,x),I;if(R===null){for(;!L.done;x++,L=y.next())L=h(E,L.value,A),L!==null&&(v=r(L,v,x),T===null?I=L:T.sibling=L,T=L);return ni&&jr(E,x),I}for(R=i(E,R);!L.done;x++,L=y.next())L=f(R,E,x,L.value,A),L!==null&&(s&&L.alternate!==null&&R.delete(L.key===null?x:L.key),v=r(L,v,x),T===null?I=L:T.sibling=L,T=L);return s&&R.forEach(function(Z){return e(E,Z)}),ni&&jr(E,x),I}function _(E,v,y,A){if(typeof y=="object"&&y!==null&&y.type===ka&&y.key===null&&(y=y.props.children),typeof y=="object"&&y!==null){switch(y.$$typeof){case hc:e:{for(var I=y.key,T=v;T!==null;){if(T.key===I){if(I=y.type,I===ka){if(T.tag===7){t(E,T.sibling),v=n(T,y.props.children),v.return=E,E=v;break e}}else if(T.elementType===I||typeof I=="object"&&I!==null&&I.$$typeof===_r&&a_(I)===T.type){t(E,T.sibling),v=n(T,y.props),v.ref=zo(E,T,y),v.return=E,E=v;break e}t(E,T);break}else e(E,T);T=T.sibling}y.type===ka?(v=la(y.props.children,E.mode,A,y.key),v.return=E,E=v):(A=Wc(y.type,y.key,y.props,null,E.mode,A),A.ref=zo(E,v,y),A.return=E,E=A)}return a(E);case Ba:e:{for(T=y.key;v!==null;){if(v.key===T)if(v.tag===4&&v.stateNode.containerInfo===y.containerInfo&&v.stateNode.implementation===y.implementation){t(E,v.sibling),v=n(v,y.children||[]),v.return=E,E=v;break e}else{t(E,v);break}else e(E,v);v=v.sibling}v=Gh(y,E.mode,A),v.return=E,E=v}return a(E);case _r:return T=y._init,_(E,v,T(y._payload),A)}if(Qo(y))return p(E,v,y,A);if(Bo(y))return m(E,v,y,A);Tc(E,y)}return typeof y=="string"&&y!==""||typeof y=="number"?(y=""+y,v!==null&&v.tag===6?(t(E,v.sibling),v=n(v,y),v.return=E,E=v):(t(E,v),v=Vh(y,E.mode,A),v.return=E,E=v),a(E)):t(E,v)}return _}var _o=c1(!0),u1=c1(!1),Kl={},Ds=Xr(Kl),Rl=Xr(Kl),bl=Xr(Kl);function aa(s){if(s===Kl)throw Error(ue(174));return s}function xp(s,e){switch(jt(bl,e),jt(Rl,s),jt(Ds,Kl),s=e.nodeType,s){case 9:case 11:e=(e=e.documentElement)?e.namespaceURI:_d(null,"");break;default:s=s===8?e.parentNode:e,e=s.namespaceURI||null,s=s.tagName,e=_d(e,s)}ti(Ds),jt(Ds,e)}function go(){ti(Ds),ti(Rl),ti(bl)}function h1(s){aa(bl.current);var e=aa(Ds.current),t=_d(e,s.type);e!==t&&(jt(Rl,s),jt(Ds,t))}function Mp(s){Rl.current===s&&(ti(Ds),ti(Rl))}var si=Xr(0);function du(s){for(var e=s;e!==null;){if(e.tag===13){var t=e.memoizedState;if(t!==null&&(t=t.dehydrated,t===null||t.data==="$?"||t.data==="$!"))return e}else if(e.tag===19&&e.memoizedProps.revealOrder!==void 0){if(e.flags&128)return e}else if(e.child!==null){e.child.return=e,e=e.child;continue}if(e===s)break;for(;e.sibling===null;){if(e.return===null||e.return===s)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}return null}var Fh=[];function Pp(){for(var s=0;s<Fh.length;s++)Fh[s]._workInProgressVersionPrimary=null;Fh.length=0}var Uc=or.ReactCurrentDispatcher,Lh=or.ReactCurrentBatchConfig,Ea=0,ai=null,Ri=null,wi=null,fu=!1,rl=!1,xl=0,xA=0;function Wi(){throw Error(ue(321))}function Dp(s,e){if(e===null)return!1;for(var t=0;t<e.length&&t<s.length;t++)if(!ms(s[t],e[t]))return!1;return!0}function Op(s,e,t,i,n,r){if(Ea=r,ai=e,e.memoizedState=null,e.updateQueue=null,e.lanes=0,Uc.current=s===null||s.memoizedState===null?OA:wA,s=t(i,n),rl){r=0;do{if(rl=!1,xl=0,25<=r)throw Error(ue(301));r+=1,wi=Ri=null,e.updateQueue=null,Uc.current=FA,s=t(i,n)}while(rl)}if(Uc.current=pu,e=Ri!==null&&Ri.next!==null,Ea=0,wi=Ri=ai=null,fu=!1,e)throw Error(ue(300));return s}function wp(){var s=xl!==0;return xl=0,s}function Is(){var s={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return wi===null?ai.memoizedState=wi=s:wi=wi.next=s,wi}function ns(){if(Ri===null){var s=ai.alternate;s=s!==null?s.memoizedState:null}else s=Ri.next;var e=wi===null?ai.memoizedState:wi.next;if(e!==null)wi=e,Ri=s;else{if(s===null)throw Error(ue(310));Ri=s,s={memoizedState:Ri.memoizedState,baseState:Ri.baseState,baseQueue:Ri.baseQueue,queue:Ri.queue,next:null},wi===null?ai.memoizedState=wi=s:wi=wi.next=s}return wi}function Ml(s,e){return typeof e=="function"?e(s):e}function Nh(s){var e=ns(),t=e.queue;if(t===null)throw Error(ue(311));t.lastRenderedReducer=s;var i=Ri,n=i.baseQueue,r=t.pending;if(r!==null){if(n!==null){var a=n.next;n.next=r.next,r.next=a}i.baseQueue=n=r,t.pending=null}if(n!==null){r=n.next,i=i.baseState;var o=a=null,l=null,c=r;do{var u=c.lane;if((Ea&u)===u)l!==null&&(l=l.next={lane:0,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null}),i=c.hasEagerState?c.eagerState:s(i,c.action);else{var h={lane:u,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null};l===null?(o=l=h,a=i):l=l.next=h,ai.lanes|=u,va|=u}c=c.next}while(c!==null&&c!==r);l===null?a=i:l.next=o,ms(i,e.memoizedState)||(In=!0),e.memoizedState=i,e.baseState=a,e.baseQueue=l,t.lastRenderedState=i}if(s=t.interleaved,s!==null){n=s;do r=n.lane,ai.lanes|=r,va|=r,n=n.next;while(n!==s)}else n===null&&(t.lanes=0);return[e.memoizedState,t.dispatch]}function Bh(s){var e=ns(),t=e.queue;if(t===null)throw Error(ue(311));t.lastRenderedReducer=s;var i=t.dispatch,n=t.pending,r=e.memoizedState;if(n!==null){t.pending=null;var a=n=n.next;do r=s(r,a.action),a=a.next;while(a!==n);ms(r,e.memoizedState)||(In=!0),e.memoizedState=r,e.baseQueue===null&&(e.baseState=r),t.lastRenderedState=r}return[r,i]}function d1(){}function f1(s,e){var t=ai,i=ns(),n=e(),r=!ms(i.memoizedState,n);if(r&&(i.memoizedState=n,In=!0),i=i.queue,Fp(_1.bind(null,t,i,s),[s]),i.getSnapshot!==e||r||wi!==null&&wi.memoizedState.tag&1){if(t.flags|=2048,Pl(9,m1.bind(null,t,i,n,e),void 0,null),Ni===null)throw Error(ue(349));Ea&30||p1(t,e,n)}return n}function p1(s,e,t){s.flags|=16384,s={getSnapshot:e,value:t},e=ai.updateQueue,e===null?(e={lastEffect:null,stores:null},ai.updateQueue=e,e.stores=[s]):(t=e.stores,t===null?e.stores=[s]:t.push(s))}function m1(s,e,t,i){e.value=t,e.getSnapshot=i,g1(e)&&E1(s)}function _1(s,e,t){return t(function(){g1(e)&&E1(s)})}function g1(s){var e=s.getSnapshot;s=s.value;try{var t=e();return!ms(s,t)}catch(i){return!0}}function E1(s){var e=nr(s,1);e!==null&&fs(e,s,1,-1)}function o_(s){var e=Is();return typeof s=="function"&&(s=s()),e.memoizedState=e.baseState=s,s={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:Ml,lastRenderedState:s},e.queue=s,s=s.dispatch=DA.bind(null,ai,s),[e.memoizedState,s]}function Pl(s,e,t,i){return s={tag:s,create:e,destroy:t,deps:i,next:null},e=ai.updateQueue,e===null?(e={lastEffect:null,stores:null},ai.updateQueue=e,e.lastEffect=s.next=s):(t=e.lastEffect,t===null?e.lastEffect=s.next=s:(i=t.next,t.next=s,s.next=i,e.lastEffect=s)),s}function v1(){return ns().memoizedState}function Vc(s,e,t,i){var n=Is();ai.flags|=s,n.memoizedState=Pl(1|e,t,void 0,i===void 0?null:i)}function Hu(s,e,t,i){var n=ns();i=i===void 0?null:i;var r=void 0;if(Ri!==null){var a=Ri.memoizedState;if(r=a.destroy,i!==null&&Dp(i,a.deps)){n.memoizedState=Pl(e,t,r,i);return}}ai.flags|=s,n.memoizedState=Pl(1|e,t,r,i)}function l_(s,e){return Vc(8390656,8,s,e)}function Fp(s,e){return Hu(2048,8,s,e)}function y1(s,e){return Hu(4,2,s,e)}function A1(s,e){return Hu(4,4,s,e)}function T1(s,e){if(typeof e=="function")return s=s(),e(s),function(){e(null)};if(e!=null)return s=s(),e.current=s,function(){e.current=null}}function S1(s,e,t){return t=t!=null?t.concat([s]):null,Hu(4,4,T1.bind(null,e,s),t)}function Lp(){}function C1(s,e){var t=ns();e=e===void 0?null:e;var i=t.memoizedState;return i!==null&&e!==null&&Dp(e,i[1])?i[0]:(t.memoizedState=[s,e],s)}function I1(s,e){var t=ns();e=e===void 0?null:e;var i=t.memoizedState;return i!==null&&e!==null&&Dp(e,i[1])?i[0]:(s=s(),t.memoizedState=[s,e],s)}function R1(s,e,t){return Ea&21?(ms(t,e)||(t=M0(),ai.lanes|=t,va|=t,s.baseState=!0),e):(s.baseState&&(s.baseState=!1,In=!0),s.memoizedState=t)}function MA(s,e){var t=kt;kt=t!==0&&4>t?t:4,s(!0);var i=Lh.transition;Lh.transition={};try{s(!1),e()}finally{kt=t,Lh.transition=i}}function b1(){return ns().memoizedState}function PA(s,e,t){var i=Or(s);if(t={lane:i,action:t,hasEagerState:!1,eagerState:null,next:null},x1(s))M1(e,t);else if(t=r1(s,e,t,i),t!==null){var n=un();fs(t,s,i,n),P1(t,e,i)}}function DA(s,e,t){var i=Or(s),n={lane:i,action:t,hasEagerState:!1,eagerState:null,next:null};if(x1(s))M1(e,n);else{var r=s.alternate;if(s.lanes===0&&(r===null||r.lanes===0)&&(r=e.lastRenderedReducer,r!==null))try{var a=e.lastRenderedState,o=r(a,t);if(n.hasEagerState=!0,n.eagerState=o,ms(o,a)){var l=e.interleaved;l===null?(n.next=n,Rp(e)):(n.next=l.next,l.next=n),e.interleaved=n;return}}catch(c){}finally{}t=r1(s,e,n,i),t!==null&&(n=un(),fs(t,s,i,n),P1(t,e,i))}}function x1(s){var e=s.alternate;return s===ai||e!==null&&e===ai}function M1(s,e){rl=fu=!0;var t=s.pending;t===null?e.next=e:(e.next=t.next,t.next=e),s.pending=e}function P1(s,e,t){if(t&4194240){var i=e.lanes;i&=s.pendingLanes,t|=i,e.lanes=t,dp(s,t)}}var pu={readContext:is,useCallback:Wi,useContext:Wi,useEffect:Wi,useImperativeHandle:Wi,useInsertionEffect:Wi,useLayoutEffect:Wi,useMemo:Wi,useReducer:Wi,useRef:Wi,useState:Wi,useDebugValue:Wi,useDeferredValue:Wi,useTransition:Wi,useMutableSource:Wi,useSyncExternalStore:Wi,useId:Wi,unstable_isNewReconciler:!1},OA={readContext:is,useCallback:function(s,e){return Is().memoizedState=[s,e===void 0?null:e],s},useContext:is,useEffect:l_,useImperativeHandle:function(s,e,t){return t=t!=null?t.concat([s]):null,Vc(4194308,4,T1.bind(null,e,s),t)},useLayoutEffect:function(s,e){return Vc(4194308,4,s,e)},useInsertionEffect:function(s,e){return Vc(4,2,s,e)},useMemo:function(s,e){var t=Is();return e=e===void 0?null:e,s=s(),t.memoizedState=[s,e],s},useReducer:function(s,e,t){var i=Is();return e=t!==void 0?t(e):e,i.memoizedState=i.baseState=e,s={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:s,lastRenderedState:e},i.queue=s,s=s.dispatch=PA.bind(null,ai,s),[i.memoizedState,s]},useRef:function(s){var e=Is();return s={current:s},e.memoizedState=s},useState:o_,useDebugValue:Lp,useDeferredValue:function(s){return Is().memoizedState=s},useTransition:function(){var s=o_(!1),e=s[0];return s=MA.bind(null,s[1]),Is().memoizedState=s,[e,s]},useMutableSource:function(){},useSyncExternalStore:function(s,e,t){var i=ai,n=Is();if(ni){if(t===void 0)throw Error(ue(407));t=t()}else{if(t=e(),Ni===null)throw Error(ue(349));Ea&30||p1(i,e,t)}n.memoizedState=t;var r={value:t,getSnapshot:e};return n.queue=r,l_(_1.bind(null,i,r,s),[s]),i.flags|=2048,Pl(9,m1.bind(null,i,r,t,e),void 0,null),t},useId:function(){var s=Is(),e=Ni.identifierPrefix;if(ni){var t=qs,i=Zs;t=(i&~(1<<32-ds(i)-1)).toString(32)+t,e=":"+e+"R"+t,t=xl++,0<t&&(e+="H"+t.toString(32)),e+=":"}else t=xA++,e=":"+e+"r"+t.toString(32)+":";return s.memoizedState=e},unstable_isNewReconciler:!1},wA={readContext:is,useCallback:C1,useContext:is,useEffect:Fp,useImperativeHandle:S1,useInsertionEffect:y1,useLayoutEffect:A1,useMemo:I1,useReducer:Nh,useRef:v1,useState:function(){return Nh(Ml)},useDebugValue:Lp,useDeferredValue:function(s){var e=ns();return R1(e,Ri.memoizedState,s)},useTransition:function(){var s=Nh(Ml)[0],e=ns().memoizedState;return[s,e]},useMutableSource:d1,useSyncExternalStore:f1,useId:b1,unstable_isNewReconciler:!1},FA={readContext:is,useCallback:C1,useContext:is,useEffect:Fp,useImperativeHandle:S1,useInsertionEffect:y1,useLayoutEffect:A1,useMemo:I1,useReducer:Bh,useRef:v1,useState:function(){return Bh(Ml)},useDebugValue:Lp,useDeferredValue:function(s){var e=ns();return Ri===null?e.memoizedState=s:R1(e,Ri.memoizedState,s)},useTransition:function(){var s=Bh(Ml)[0],e=ns().memoizedState;return[s,e]},useMutableSource:d1,useSyncExternalStore:f1,useId:b1,unstable_isNewReconciler:!1};function Eo(s,e){try{var t="",i=e;do t+=ly(i),i=i.return;while(i);var n=t}catch(r){n=`
Error generating stack: `+r.message+`
`+r.stack}return{value:s,source:e,stack:n,digest:null}}function kh(s,e,t){return{value:s,source:null,stack:t!=null?t:null,digest:e!=null?e:null}}function Ud(s,e){try{console.error(e.value)}catch(t){setTimeout(function(){throw t})}}var LA=typeof WeakMap=="function"?WeakMap:Map;function D1(s,e,t){t=Js(-1,t),t.tag=3,t.payload={element:null};var i=e.value;return t.callback=function(){_u||(_u=!0,Zd=i),Ud(s,e)},t}function O1(s,e,t){t=Js(-1,t),t.tag=3;var i=s.type.getDerivedStateFromError;if(typeof i=="function"){var n=e.value;t.payload=function(){return i(n)},t.callback=function(){Ud(s,e)}}var r=s.stateNode;return r!==null&&typeof r.componentDidCatch=="function"&&(t.callback=function(){Ud(s,e),typeof i!="function"&&(Dr===null?Dr=new Set([this]):Dr.add(this));var a=e.stack;this.componentDidCatch(e.value,{componentStack:a!==null?a:""})}),t}function c_(s,e,t){var i=s.pingCache;if(i===null){i=s.pingCache=new LA;var n=new Set;i.set(e,n)}else n=i.get(e),n===void 0&&(n=new Set,i.set(e,n));n.has(t)||(n.add(t),s=ZA.bind(null,s,e,t),e.then(s,s))}function u_(s){do{var e;if((e=s.tag===13)&&(e=s.memoizedState,e=e!==null?e.dehydrated!==null:!0),e)return s;s=s.return}while(s!==null);return null}function h_(s,e,t,i,n){return s.mode&1?(s.flags|=65536,s.lanes=n,s):(s===e?s.flags|=65536:(s.flags|=128,t.flags|=131072,t.flags&=-52805,t.tag===1&&(t.alternate===null?t.tag=17:(e=Js(-1,1),e.tag=2,Pr(t,e,1))),t.lanes|=1),s)}var NA=or.ReactCurrentOwner,In=!1;function sn(s,e,t,i){e.child=s===null?u1(e,null,t,i):_o(e,s.child,t,i)}function d_(s,e,t,i,n){t=t.render;var r=e.ref;return eo(e,n),i=Op(s,e,t,i,r,n),t=wp(),s!==null&&!In?(e.updateQueue=s.updateQueue,e.flags&=-2053,s.lanes&=~n,sr(s,e,n)):(ni&&t&&yp(e),e.flags|=1,sn(s,e,i,n),e.child)}function f_(s,e,t,i,n){if(s===null){var r=t.type;return typeof r=="function"&&!Hp(r)&&r.defaultProps===void 0&&t.compare===null&&t.defaultProps===void 0?(e.tag=15,e.type=r,w1(s,e,r,i,n)):(s=Wc(t.type,null,i,e,e.mode,n),s.ref=e.ref,s.return=e,e.child=s)}if(r=s.child,!(s.lanes&n)){var a=r.memoizedProps;if(t=t.compare,t=t!==null?t:Tl,t(a,i)&&s.ref===e.ref)return sr(s,e,n)}return e.flags|=1,s=wr(r,i),s.ref=e.ref,s.return=e,e.child=s}function w1(s,e,t,i,n){if(s!==null){var r=s.memoizedProps;if(Tl(r,i)&&s.ref===e.ref)if(In=!1,e.pendingProps=i=r,(s.lanes&n)!==0)s.flags&131072&&(In=!0);else return e.lanes=s.lanes,sr(s,e,n)}return Vd(s,e,t,i,n)}function F1(s,e,t){var i=e.pendingProps,n=i.children,r=s!==null?s.memoizedState:null;if(i.mode==="hidden")if(!(e.mode&1))e.memoizedState={baseLanes:0,cachePool:null,transitions:null},jt(Qa,Fn),Fn|=t;else{if(!(t&1073741824))return s=r!==null?r.baseLanes|t:t,e.lanes=e.childLanes=1073741824,e.memoizedState={baseLanes:s,cachePool:null,transitions:null},e.updateQueue=null,jt(Qa,Fn),Fn|=s,null;e.memoizedState={baseLanes:0,cachePool:null,transitions:null},i=r!==null?r.baseLanes:t,jt(Qa,Fn),Fn|=i}else r!==null?(i=r.baseLanes|t,e.memoizedState=null):i=t,jt(Qa,Fn),Fn|=i;return sn(s,e,n,t),e.child}function L1(s,e){var t=e.ref;(s===null&&t!==null||s!==null&&s.ref!==t)&&(e.flags|=512,e.flags|=2097152)}function Vd(s,e,t,i,n){var r=bn(t)?_a:Zi.current;return r=po(e,r),eo(e,n),t=Op(s,e,t,i,r,n),i=wp(),s!==null&&!In?(e.updateQueue=s.updateQueue,e.flags&=-2053,s.lanes&=~n,sr(s,e,n)):(ni&&i&&yp(e),e.flags|=1,sn(s,e,t,n),e.child)}function p_(s,e,t,i,n){if(bn(t)){var r=!0;au(e)}else r=!1;if(eo(e,n),e.stateNode===null)Gc(s,e),l1(e,t,i),kd(e,t,i,n),i=!0;else if(s===null){var a=e.stateNode,o=e.memoizedProps;a.props=o;var l=a.context,c=t.contextType;typeof c=="object"&&c!==null?c=is(c):(c=bn(t)?_a:Zi.current,c=po(e,c));var u=t.getDerivedStateFromProps,h=typeof u=="function"||typeof a.getSnapshotBeforeUpdate=="function";h||typeof a.UNSAFE_componentWillReceiveProps!="function"&&typeof a.componentWillReceiveProps!="function"||(o!==i||l!==c)&&r_(e,a,i,c),gr=!1;var d=e.memoizedState;a.state=d,hu(e,i,a,n),l=e.memoizedState,o!==i||d!==l||Rn.current||gr?(typeof u=="function"&&(Bd(e,t,u,i),l=e.memoizedState),(o=gr||s_(e,t,o,i,d,l,c))?(h||typeof a.UNSAFE_componentWillMount!="function"&&typeof a.componentWillMount!="function"||(typeof a.componentWillMount=="function"&&a.componentWillMount(),typeof a.UNSAFE_componentWillMount=="function"&&a.UNSAFE_componentWillMount()),typeof a.componentDidMount=="function"&&(e.flags|=4194308)):(typeof a.componentDidMount=="function"&&(e.flags|=4194308),e.memoizedProps=i,e.memoizedState=l),a.props=i,a.state=l,a.context=c,i=o):(typeof a.componentDidMount=="function"&&(e.flags|=4194308),i=!1)}else{a=e.stateNode,a1(s,e),o=e.memoizedProps,c=e.type===e.elementType?o:os(e.type,o),a.props=c,h=e.pendingProps,d=a.context,l=t.contextType,typeof l=="object"&&l!==null?l=is(l):(l=bn(t)?_a:Zi.current,l=po(e,l));var f=t.getDerivedStateFromProps;(u=typeof f=="function"||typeof a.getSnapshotBeforeUpdate=="function")||typeof a.UNSAFE_componentWillReceiveProps!="function"&&typeof a.componentWillReceiveProps!="function"||(o!==h||d!==l)&&r_(e,a,i,l),gr=!1,d=e.memoizedState,a.state=d,hu(e,i,a,n);var p=e.memoizedState;o!==h||d!==p||Rn.current||gr?(typeof f=="function"&&(Bd(e,t,f,i),p=e.memoizedState),(c=gr||s_(e,t,c,i,d,p,l)||!1)?(u||typeof a.UNSAFE_componentWillUpdate!="function"&&typeof a.componentWillUpdate!="function"||(typeof a.componentWillUpdate=="function"&&a.componentWillUpdate(i,p,l),typeof a.UNSAFE_componentWillUpdate=="function"&&a.UNSAFE_componentWillUpdate(i,p,l)),typeof a.componentDidUpdate=="function"&&(e.flags|=4),typeof a.getSnapshotBeforeUpdate=="function"&&(e.flags|=1024)):(typeof a.componentDidUpdate!="function"||o===s.memoizedProps&&d===s.memoizedState||(e.flags|=4),typeof a.getSnapshotBeforeUpdate!="function"||o===s.memoizedProps&&d===s.memoizedState||(e.flags|=1024),e.memoizedProps=i,e.memoizedState=p),a.props=i,a.state=p,a.context=l,i=c):(typeof a.componentDidUpdate!="function"||o===s.memoizedProps&&d===s.memoizedState||(e.flags|=4),typeof a.getSnapshotBeforeUpdate!="function"||o===s.memoizedProps&&d===s.memoizedState||(e.flags|=1024),i=!1)}return Gd(s,e,t,i,r,n)}function Gd(s,e,t,i,n,r){L1(s,e);var a=(e.flags&128)!==0;if(!i&&!a)return n&&Jm(e,t,!1),sr(s,e,r);i=e.stateNode,NA.current=e;var o=a&&typeof t.getDerivedStateFromError!="function"?null:i.render();return e.flags|=1,s!==null&&a?(e.child=_o(e,s.child,null,r),e.child=_o(e,null,o,r)):sn(s,e,o,r),e.memoizedState=i.state,n&&Jm(e,t,!0),e.child}function N1(s){var e=s.stateNode;e.pendingContext?$m(s,e.pendingContext,e.pendingContext!==e.context):e.context&&$m(s,e.context,!1),xp(s,e.containerInfo)}function m_(s,e,t,i,n){return mo(),Tp(n),e.flags|=256,sn(s,e,t,i),e.child}var zd={dehydrated:null,treeContext:null,retryLane:0};function Hd(s){return{baseLanes:s,cachePool:null,transitions:null}}function B1(s,e,t){var i=e.pendingProps,n=si.current,r=!1,a=(e.flags&128)!==0,o;if((o=a)||(o=s!==null&&s.memoizedState===null?!1:(n&2)!==0),o?(r=!0,e.flags&=-129):(s===null||s.memoizedState!==null)&&(n|=1),jt(si,n&1),s===null)return Ld(e),s=e.memoizedState,s!==null&&(s=s.dehydrated,s!==null)?(e.mode&1?s.data==="$!"?e.lanes=8:e.lanes=1073741824:e.lanes=1,null):(a=i.children,s=i.fallback,r?(i=e.mode,r=e.child,a={mode:"hidden",children:a},!(i&1)&&r!==null?(r.childLanes=0,r.pendingProps=a):r=Yu(a,i,0,null),s=la(s,i,t,null),r.return=e,s.return=e,r.sibling=s,e.child=r,e.child.memoizedState=Hd(t),e.memoizedState=zd,s):Np(e,a));if(n=s.memoizedState,n!==null&&(o=n.dehydrated,o!==null))return BA(s,e,a,i,o,n,t);if(r){r=i.fallback,a=e.mode,n=s.child,o=n.sibling;var l={mode:"hidden",children:i.children};return!(a&1)&&e.child!==n?(i=e.child,i.childLanes=0,i.pendingProps=l,e.deletions=null):(i=wr(n,l),i.subtreeFlags=n.subtreeFlags&14680064),o!==null?r=wr(o,r):(r=la(r,a,t,null),r.flags|=2),r.return=e,i.return=e,i.sibling=r,e.child=i,i=r,r=e.child,a=s.child.memoizedState,a=a===null?Hd(t):{baseLanes:a.baseLanes|t,cachePool:null,transitions:a.transitions},r.memoizedState=a,r.childLanes=s.childLanes&~t,e.memoizedState=zd,i}return r=s.child,s=r.sibling,i=wr(r,{mode:"visible",children:i.children}),!(e.mode&1)&&(i.lanes=t),i.return=e,i.sibling=null,s!==null&&(t=e.deletions,t===null?(e.deletions=[s],e.flags|=16):t.push(s)),e.child=i,e.memoizedState=null,i}function Np(s,e){return e=Yu({mode:"visible",children:e},s.mode,0,null),e.return=s,s.child=e}function Sc(s,e,t,i){return i!==null&&Tp(i),_o(e,s.child,null,t),s=Np(e,e.pendingProps.children),s.flags|=2,e.memoizedState=null,s}function BA(s,e,t,i,n,r,a){if(t)return e.flags&256?(e.flags&=-257,i=kh(Error(ue(422))),Sc(s,e,a,i)):e.memoizedState!==null?(e.child=s.child,e.flags|=128,null):(r=i.fallback,n=e.mode,i=Yu({mode:"visible",children:i.children},n,0,null),r=la(r,n,a,null),r.flags|=2,i.return=e,r.return=e,i.sibling=r,e.child=i,e.mode&1&&_o(e,s.child,null,a),e.child.memoizedState=Hd(a),e.memoizedState=zd,r);if(!(e.mode&1))return Sc(s,e,a,null);if(n.data==="$!"){if(i=n.nextSibling&&n.nextSibling.dataset,i)var o=i.dgst;return i=o,r=Error(ue(419)),i=kh(r,i,void 0),Sc(s,e,a,i)}if(o=(a&s.childLanes)!==0,In||o){if(i=Ni,i!==null){switch(a&-a){case 4:n=2;break;case 16:n=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:n=32;break;case 536870912:n=268435456;break;default:n=0}n=n&(i.suspendedLanes|a)?0:n,n!==0&&n!==r.retryLane&&(r.retryLane=n,nr(s,n),fs(i,s,n,-1))}return zp(),i=kh(Error(ue(421))),Sc(s,e,a,i)}return n.data==="$?"?(e.flags|=128,e.child=s.child,e=qA.bind(null,s),n._reactRetry=e,null):(s=r.treeContext,Nn=Mr(n.nextSibling),Bn=e,ni=!0,us=null,s!==null&&(Kn[Qn++]=Zs,Kn[Qn++]=qs,Kn[Qn++]=ga,Zs=s.id,qs=s.overflow,ga=e),e=Np(e,i.children),e.flags|=4096,e)}function __(s,e,t){s.lanes|=e;var i=s.alternate;i!==null&&(i.lanes|=e),Nd(s.return,e,t)}function Uh(s,e,t,i,n){var r=s.memoizedState;r===null?s.memoizedState={isBackwards:e,rendering:null,renderingStartTime:0,last:i,tail:t,tailMode:n}:(r.isBackwards=e,r.rendering=null,r.renderingStartTime=0,r.last=i,r.tail=t,r.tailMode=n)}function k1(s,e,t){var i=e.pendingProps,n=i.revealOrder,r=i.tail;if(sn(s,e,i.children,t),i=si.current,i&2)i=i&1|2,e.flags|=128;else{if(s!==null&&s.flags&128)e:for(s=e.child;s!==null;){if(s.tag===13)s.memoizedState!==null&&__(s,t,e);else if(s.tag===19)__(s,t,e);else if(s.child!==null){s.child.return=s,s=s.child;continue}if(s===e)break e;for(;s.sibling===null;){if(s.return===null||s.return===e)break e;s=s.return}s.sibling.return=s.return,s=s.sibling}i&=1}if(jt(si,i),!(e.mode&1))e.memoizedState=null;else switch(n){case"forwards":for(t=e.child,n=null;t!==null;)s=t.alternate,s!==null&&du(s)===null&&(n=t),t=t.sibling;t=n,t===null?(n=e.child,e.child=null):(n=t.sibling,t.sibling=null),Uh(e,!1,n,t,r);break;case"backwards":for(t=null,n=e.child,e.child=null;n!==null;){if(s=n.alternate,s!==null&&du(s)===null){e.child=n;break}s=n.sibling,n.sibling=t,t=n,n=s}Uh(e,!0,t,null,r);break;case"together":Uh(e,!1,null,null,void 0);break;default:e.memoizedState=null}return e.child}function Gc(s,e){!(e.mode&1)&&s!==null&&(s.alternate=null,e.alternate=null,e.flags|=2)}function sr(s,e,t){if(s!==null&&(e.dependencies=s.dependencies),va|=e.lanes,!(t&e.childLanes))return null;if(s!==null&&e.child!==s.child)throw Error(ue(153));if(e.child!==null){for(s=e.child,t=wr(s,s.pendingProps),e.child=t,t.return=e;s.sibling!==null;)s=s.sibling,t=t.sibling=wr(s,s.pendingProps),t.return=e;t.sibling=null}return e.child}function kA(s,e,t){switch(e.tag){case 3:N1(e),mo();break;case 5:h1(e);break;case 1:bn(e.type)&&au(e);break;case 4:xp(e,e.stateNode.containerInfo);break;case 10:var i=e.type._context,n=e.memoizedProps.value;jt(cu,i._currentValue),i._currentValue=n;break;case 13:if(i=e.memoizedState,i!==null)return i.dehydrated!==null?(jt(si,si.current&1),e.flags|=128,null):t&e.child.childLanes?B1(s,e,t):(jt(si,si.current&1),s=sr(s,e,t),s!==null?s.sibling:null);jt(si,si.current&1);break;case 19:if(i=(t&e.childLanes)!==0,s.flags&128){if(i)return k1(s,e,t);e.flags|=128}if(n=e.memoizedState,n!==null&&(n.rendering=null,n.tail=null,n.lastEffect=null),jt(si,si.current),i)break;return null;case 22:case 23:return e.lanes=0,F1(s,e,t)}return sr(s,e,t)}var U1,Wd,V1,G1;U1=function(s,e){for(var t=e.child;t!==null;){if(t.tag===5||t.tag===6)s.appendChild(t.stateNode);else if(t.tag!==4&&t.child!==null){t.child.return=t,t=t.child;continue}if(t===e)break;for(;t.sibling===null;){if(t.return===null||t.return===e)return;t=t.return}t.sibling.return=t.return,t=t.sibling}};Wd=function(){};V1=function(s,e,t,i){var n=s.memoizedProps;if(n!==i){s=e.stateNode,aa(Ds.current);var r=null;switch(t){case"input":n=dd(s,n),i=dd(s,i),r=[];break;case"select":n=li({},n,{value:void 0}),i=li({},i,{value:void 0}),r=[];break;case"textarea":n=md(s,n),i=md(s,i),r=[];break;default:typeof n.onClick!="function"&&typeof i.onClick=="function"&&(s.onclick=su)}gd(t,i);var a;t=null;for(c in n)if(!i.hasOwnProperty(c)&&n.hasOwnProperty(c)&&n[c]!=null)if(c==="style"){var o=n[c];for(a in o)o.hasOwnProperty(a)&&(t||(t={}),t[a]="")}else c!=="dangerouslySetInnerHTML"&&c!=="children"&&c!=="suppressContentEditableWarning"&&c!=="suppressHydrationWarning"&&c!=="autoFocus"&&(ml.hasOwnProperty(c)?r||(r=[]):(r=r||[]).push(c,null));for(c in i){var l=i[c];if(o=n!=null?n[c]:void 0,i.hasOwnProperty(c)&&l!==o&&(l!=null||o!=null))if(c==="style")if(o){for(a in o)!o.hasOwnProperty(a)||l&&l.hasOwnProperty(a)||(t||(t={}),t[a]="");for(a in l)l.hasOwnProperty(a)&&o[a]!==l[a]&&(t||(t={}),t[a]=l[a])}else t||(r||(r=[]),r.push(c,t)),t=l;else c==="dangerouslySetInnerHTML"?(l=l?l.__html:void 0,o=o?o.__html:void 0,l!=null&&o!==l&&(r=r||[]).push(c,l)):c==="children"?typeof l!="string"&&typeof l!="number"||(r=r||[]).push(c,""+l):c!=="suppressContentEditableWarning"&&c!=="suppressHydrationWarning"&&(ml.hasOwnProperty(c)?(l!=null&&c==="onScroll"&&ei("scroll",s),r||o===l||(r=[])):(r=r||[]).push(c,l))}t&&(r=r||[]).push("style",t);var c=r;(e.updateQueue=c)&&(e.flags|=4)}};G1=function(s,e,t,i){t!==i&&(e.flags|=4)};function Ho(s,e){if(!ni)switch(s.tailMode){case"hidden":e=s.tail;for(var t=null;e!==null;)e.alternate!==null&&(t=e),e=e.sibling;t===null?s.tail=null:t.sibling=null;break;case"collapsed":t=s.tail;for(var i=null;t!==null;)t.alternate!==null&&(i=t),t=t.sibling;i===null?e||s.tail===null?s.tail=null:s.tail.sibling=null:i.sibling=null}}function Xi(s){var e=s.alternate!==null&&s.alternate.child===s.child,t=0,i=0;if(e)for(var n=s.child;n!==null;)t|=n.lanes|n.childLanes,i|=n.subtreeFlags&14680064,i|=n.flags&14680064,n.return=s,n=n.sibling;else for(n=s.child;n!==null;)t|=n.lanes|n.childLanes,i|=n.subtreeFlags,i|=n.flags,n.return=s,n=n.sibling;return s.subtreeFlags|=i,s.childLanes=t,e}function UA(s,e,t){var i=e.pendingProps;switch(Ap(e),e.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Xi(e),null;case 1:return bn(e.type)&&ru(),Xi(e),null;case 3:return i=e.stateNode,go(),ti(Rn),ti(Zi),Pp(),i.pendingContext&&(i.context=i.pendingContext,i.pendingContext=null),(s===null||s.child===null)&&(Ac(e)?e.flags|=4:s===null||s.memoizedState.isDehydrated&&!(e.flags&256)||(e.flags|=1024,us!==null&&($d(us),us=null))),Wd(s,e),Xi(e),null;case 5:Mp(e);var n=aa(bl.current);if(t=e.type,s!==null&&e.stateNode!=null)V1(s,e,t,i,n),s.ref!==e.ref&&(e.flags|=512,e.flags|=2097152);else{if(!i){if(e.stateNode===null)throw Error(ue(166));return Xi(e),null}if(s=aa(Ds.current),Ac(e)){i=e.stateNode,t=e.type;var r=e.memoizedProps;switch(i[bs]=e,i[Il]=r,s=(e.mode&1)!==0,t){case"dialog":ei("cancel",i),ei("close",i);break;case"iframe":case"object":case"embed":ei("load",i);break;case"video":case"audio":for(n=0;n<qo.length;n++)ei(qo[n],i);break;case"source":ei("error",i);break;case"img":case"image":case"link":ei("error",i),ei("load",i);break;case"details":ei("toggle",i);break;case"input":Im(i,r),ei("invalid",i);break;case"select":i._wrapperState={wasMultiple:!!r.multiple},ei("invalid",i);break;case"textarea":bm(i,r),ei("invalid",i)}gd(t,r),n=null;for(var a in r)if(r.hasOwnProperty(a)){var o=r[a];a==="children"?typeof o=="string"?i.textContent!==o&&(r.suppressHydrationWarning!==!0&&yc(i.textContent,o,s),n=["children",o]):typeof o=="number"&&i.textContent!==""+o&&(r.suppressHydrationWarning!==!0&&yc(i.textContent,o,s),n=["children",""+o]):ml.hasOwnProperty(a)&&o!=null&&a==="onScroll"&&ei("scroll",i)}switch(t){case"input":dc(i),Rm(i,r,!0);break;case"textarea":dc(i),xm(i);break;case"select":case"option":break;default:typeof r.onClick=="function"&&(i.onclick=su)}i=n,e.updateQueue=i,i!==null&&(e.flags|=4)}else{a=n.nodeType===9?n:n.ownerDocument,s==="http://www.w3.org/1999/xhtml"&&(s=p0(t)),s==="http://www.w3.org/1999/xhtml"?t==="script"?(s=a.createElement("div"),s.innerHTML="<script><\/script>",s=s.removeChild(s.firstChild)):typeof i.is=="string"?s=a.createElement(t,{is:i.is}):(s=a.createElement(t),t==="select"&&(a=s,i.multiple?a.multiple=!0:i.size&&(a.size=i.size))):s=a.createElementNS(s,t),s[bs]=e,s[Il]=i,U1(s,e,!1,!1),e.stateNode=s;e:{switch(a=Ed(t,i),t){case"dialog":ei("cancel",s),ei("close",s),n=i;break;case"iframe":case"object":case"embed":ei("load",s),n=i;break;case"video":case"audio":for(n=0;n<qo.length;n++)ei(qo[n],s);n=i;break;case"source":ei("error",s),n=i;break;case"img":case"image":case"link":ei("error",s),ei("load",s),n=i;break;case"details":ei("toggle",s),n=i;break;case"input":Im(s,i),n=dd(s,i),ei("invalid",s);break;case"option":n=i;break;case"select":s._wrapperState={wasMultiple:!!i.multiple},n=li({},i,{value:void 0}),ei("invalid",s);break;case"textarea":bm(s,i),n=md(s,i),ei("invalid",s);break;default:n=i}gd(t,n),o=n;for(r in o)if(o.hasOwnProperty(r)){var l=o[r];r==="style"?g0(s,l):r==="dangerouslySetInnerHTML"?(l=l?l.__html:void 0,l!=null&&m0(s,l)):r==="children"?typeof l=="string"?(t!=="textarea"||l!=="")&&_l(s,l):typeof l=="number"&&_l(s,""+l):r!=="suppressContentEditableWarning"&&r!=="suppressHydrationWarning"&&r!=="autoFocus"&&(ml.hasOwnProperty(r)?l!=null&&r==="onScroll"&&ei("scroll",s):l!=null&&ap(s,r,l,a))}switch(t){case"input":dc(s),Rm(s,i,!1);break;case"textarea":dc(s),xm(s);break;case"option":i.value!=null&&s.setAttribute("value",""+kr(i.value));break;case"select":s.multiple=!!i.multiple,r=i.value,r!=null?qa(s,!!i.multiple,r,!1):i.defaultValue!=null&&qa(s,!!i.multiple,i.defaultValue,!0);break;default:typeof n.onClick=="function"&&(s.onclick=su)}switch(t){case"button":case"input":case"select":case"textarea":i=!!i.autoFocus;break e;case"img":i=!0;break e;default:i=!1}}i&&(e.flags|=4)}e.ref!==null&&(e.flags|=512,e.flags|=2097152)}return Xi(e),null;case 6:if(s&&e.stateNode!=null)G1(s,e,s.memoizedProps,i);else{if(typeof i!="string"&&e.stateNode===null)throw Error(ue(166));if(t=aa(bl.current),aa(Ds.current),Ac(e)){if(i=e.stateNode,t=e.memoizedProps,i[bs]=e,(r=i.nodeValue!==t)&&(s=Bn,s!==null))switch(s.tag){case 3:yc(i.nodeValue,t,(s.mode&1)!==0);break;case 5:s.memoizedProps.suppressHydrationWarning!==!0&&yc(i.nodeValue,t,(s.mode&1)!==0)}r&&(e.flags|=4)}else i=(t.nodeType===9?t:t.ownerDocument).createTextNode(i),i[bs]=e,e.stateNode=i}return Xi(e),null;case 13:if(ti(si),i=e.memoizedState,s===null||s.memoizedState!==null&&s.memoizedState.dehydrated!==null){if(ni&&Nn!==null&&e.mode&1&&!(e.flags&128))s1(),mo(),e.flags|=98560,r=!1;else if(r=Ac(e),i!==null&&i.dehydrated!==null){if(s===null){if(!r)throw Error(ue(318));if(r=e.memoizedState,r=r!==null?r.dehydrated:null,!r)throw Error(ue(317));r[bs]=e}else mo(),!(e.flags&128)&&(e.memoizedState=null),e.flags|=4;Xi(e),r=!1}else us!==null&&($d(us),us=null),r=!0;if(!r)return e.flags&65536?e:null}return e.flags&128?(e.lanes=t,e):(i=i!==null,i!==(s!==null&&s.memoizedState!==null)&&i&&(e.child.flags|=8192,e.mode&1&&(s===null||si.current&1?Di===0&&(Di=3):zp())),e.updateQueue!==null&&(e.flags|=4),Xi(e),null);case 4:return go(),Wd(s,e),s===null&&Sl(e.stateNode.containerInfo),Xi(e),null;case 10:return Ip(e.type._context),Xi(e),null;case 17:return bn(e.type)&&ru(),Xi(e),null;case 19:if(ti(si),r=e.memoizedState,r===null)return Xi(e),null;if(i=(e.flags&128)!==0,a=r.rendering,a===null)if(i)Ho(r,!1);else{if(Di!==0||s!==null&&s.flags&128)for(s=e.child;s!==null;){if(a=du(s),a!==null){for(e.flags|=128,Ho(r,!1),i=a.updateQueue,i!==null&&(e.updateQueue=i,e.flags|=4),e.subtreeFlags=0,i=t,t=e.child;t!==null;)r=t,s=i,r.flags&=14680066,a=r.alternate,a===null?(r.childLanes=0,r.lanes=s,r.child=null,r.subtreeFlags=0,r.memoizedProps=null,r.memoizedState=null,r.updateQueue=null,r.dependencies=null,r.stateNode=null):(r.childLanes=a.childLanes,r.lanes=a.lanes,r.child=a.child,r.subtreeFlags=0,r.deletions=null,r.memoizedProps=a.memoizedProps,r.memoizedState=a.memoizedState,r.updateQueue=a.updateQueue,r.type=a.type,s=a.dependencies,r.dependencies=s===null?null:{lanes:s.lanes,firstContext:s.firstContext}),t=t.sibling;return jt(si,si.current&1|2),e.child}s=s.sibling}r.tail!==null&&pi()>vo&&(e.flags|=128,i=!0,Ho(r,!1),e.lanes=4194304)}else{if(!i)if(s=du(a),s!==null){if(e.flags|=128,i=!0,t=s.updateQueue,t!==null&&(e.updateQueue=t,e.flags|=4),Ho(r,!0),r.tail===null&&r.tailMode==="hidden"&&!a.alternate&&!ni)return Xi(e),null}else 2*pi()-r.renderingStartTime>vo&&t!==1073741824&&(e.flags|=128,i=!0,Ho(r,!1),e.lanes=4194304);r.isBackwards?(a.sibling=e.child,e.child=a):(t=r.last,t!==null?t.sibling=a:e.child=a,r.last=a)}return r.tail!==null?(e=r.tail,r.rendering=e,r.tail=e.sibling,r.renderingStartTime=pi(),e.sibling=null,t=si.current,jt(si,i?t&1|2:t&1),e):(Xi(e),null);case 22:case 23:return Gp(),i=e.memoizedState!==null,s!==null&&s.memoizedState!==null!==i&&(e.flags|=8192),i&&e.mode&1?Fn&1073741824&&(Xi(e),e.subtreeFlags&6&&(e.flags|=8192)):Xi(e),null;case 24:return null;case 25:return null}throw Error(ue(156,e.tag))}function VA(s,e){switch(Ap(e),e.tag){case 1:return bn(e.type)&&ru(),s=e.flags,s&65536?(e.flags=s&-65537|128,e):null;case 3:return go(),ti(Rn),ti(Zi),Pp(),s=e.flags,s&65536&&!(s&128)?(e.flags=s&-65537|128,e):null;case 5:return Mp(e),null;case 13:if(ti(si),s=e.memoizedState,s!==null&&s.dehydrated!==null){if(e.alternate===null)throw Error(ue(340));mo()}return s=e.flags,s&65536?(e.flags=s&-65537|128,e):null;case 19:return ti(si),null;case 4:return go(),null;case 10:return Ip(e.type._context),null;case 22:case 23:return Gp(),null;case 24:return null;default:return null}}var Cc=!1,Qi=!1,GA=typeof WeakSet=="function"?WeakSet:Set,we=null;function Ka(s,e){var t=s.ref;if(t!==null)if(typeof t=="function")try{t(null)}catch(i){hi(s,e,i)}else t.current=null}function Xd(s,e,t){try{t()}catch(i){hi(s,e,i)}}var g_=!1;function zA(s,e){if(xd=tu,s=X0(),vp(s)){if("selectionStart"in s)var t={start:s.selectionStart,end:s.selectionEnd};else e:{t=(t=s.ownerDocument)&&t.defaultView||window;var i=t.getSelection&&t.getSelection();if(i&&i.rangeCount!==0){t=i.anchorNode;var n=i.anchorOffset,r=i.focusNode;i=i.focusOffset;try{t.nodeType,r.nodeType}catch(A){t=null;break e}var a=0,o=-1,l=-1,c=0,u=0,h=s,d=null;t:for(;;){for(var f;h!==t||n!==0&&h.nodeType!==3||(o=a+n),h!==r||i!==0&&h.nodeType!==3||(l=a+i),h.nodeType===3&&(a+=h.nodeValue.length),(f=h.firstChild)!==null;)d=h,h=f;for(;;){if(h===s)break t;if(d===t&&++c===n&&(o=a),d===r&&++u===i&&(l=a),(f=h.nextSibling)!==null)break;h=d,d=h.parentNode}h=f}t=o===-1||l===-1?null:{start:o,end:l}}else t=null}t=t||{start:0,end:0}}else t=null;for(Md={focusedElem:s,selectionRange:t},tu=!1,we=e;we!==null;)if(e=we,s=e.child,(e.subtreeFlags&1028)!==0&&s!==null)s.return=e,we=s;else for(;we!==null;){e=we;try{var p=e.alternate;if(e.flags&1024)switch(e.tag){case 0:case 11:case 15:break;case 1:if(p!==null){var m=p.memoizedProps,_=p.memoizedState,E=e.stateNode,v=E.getSnapshotBeforeUpdate(e.elementType===e.type?m:os(e.type,m),_);E.__reactInternalSnapshotBeforeUpdate=v}break;case 3:var y=e.stateNode.containerInfo;y.nodeType===1?y.textContent="":y.nodeType===9&&y.documentElement&&y.removeChild(y.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(ue(163))}}catch(A){hi(e,e.return,A)}if(s=e.sibling,s!==null){s.return=e.return,we=s;break}we=e.return}return p=g_,g_=!1,p}function al(s,e,t){var i=e.updateQueue;if(i=i!==null?i.lastEffect:null,i!==null){var n=i=i.next;do{if((n.tag&s)===s){var r=n.destroy;n.destroy=void 0,r!==void 0&&Xd(e,t,r)}n=n.next}while(n!==i)}}function Wu(s,e){if(e=e.updateQueue,e=e!==null?e.lastEffect:null,e!==null){var t=e=e.next;do{if((t.tag&s)===s){var i=t.create;t.destroy=i()}t=t.next}while(t!==e)}}function Yd(s){var e=s.ref;if(e!==null){var t=s.stateNode;switch(s.tag){case 5:s=t;break;default:s=t}typeof e=="function"?e(s):e.current=s}}function z1(s){var e=s.alternate;e!==null&&(s.alternate=null,z1(e)),s.child=null,s.deletions=null,s.sibling=null,s.tag===5&&(e=s.stateNode,e!==null&&(delete e[bs],delete e[Il],delete e[Od],delete e[CA],delete e[IA])),s.stateNode=null,s.return=null,s.dependencies=null,s.memoizedProps=null,s.memoizedState=null,s.pendingProps=null,s.stateNode=null,s.updateQueue=null}function H1(s){return s.tag===5||s.tag===3||s.tag===4}function E_(s){e:for(;;){for(;s.sibling===null;){if(s.return===null||H1(s.return))return null;s=s.return}for(s.sibling.return=s.return,s=s.sibling;s.tag!==5&&s.tag!==6&&s.tag!==18;){if(s.flags&2||s.child===null||s.tag===4)continue e;s.child.return=s,s=s.child}if(!(s.flags&2))return s.stateNode}}function Kd(s,e,t){var i=s.tag;if(i===5||i===6)s=s.stateNode,e?t.nodeType===8?t.parentNode.insertBefore(s,e):t.insertBefore(s,e):(t.nodeType===8?(e=t.parentNode,e.insertBefore(s,t)):(e=t,e.appendChild(s)),t=t._reactRootContainer,t!=null||e.onclick!==null||(e.onclick=su));else if(i!==4&&(s=s.child,s!==null))for(Kd(s,e,t),s=s.sibling;s!==null;)Kd(s,e,t),s=s.sibling}function Qd(s,e,t){var i=s.tag;if(i===5||i===6)s=s.stateNode,e?t.insertBefore(s,e):t.appendChild(s);else if(i!==4&&(s=s.child,s!==null))for(Qd(s,e,t),s=s.sibling;s!==null;)Qd(s,e,t),s=s.sibling}var ki=null,cs=!1;function pr(s,e,t){for(t=t.child;t!==null;)W1(s,e,t),t=t.sibling}function W1(s,e,t){if(Ps&&typeof Ps.onCommitFiberUnmount=="function")try{Ps.onCommitFiberUnmount(Nu,t)}catch(o){}switch(t.tag){case 5:Qi||Ka(t,e);case 6:var i=ki,n=cs;ki=null,pr(s,e,t),ki=i,cs=n,ki!==null&&(cs?(s=ki,t=t.stateNode,s.nodeType===8?s.parentNode.removeChild(t):s.removeChild(t)):ki.removeChild(t.stateNode));break;case 18:ki!==null&&(cs?(s=ki,t=t.stateNode,s.nodeType===8?Oh(s.parentNode,t):s.nodeType===1&&Oh(s,t),yl(s)):Oh(ki,t.stateNode));break;case 4:i=ki,n=cs,ki=t.stateNode.containerInfo,cs=!0,pr(s,e,t),ki=i,cs=n;break;case 0:case 11:case 14:case 15:if(!Qi&&(i=t.updateQueue,i!==null&&(i=i.lastEffect,i!==null))){n=i=i.next;do{var r=n,a=r.destroy;r=r.tag,a!==void 0&&(r&2||r&4)&&Xd(t,e,a),n=n.next}while(n!==i)}pr(s,e,t);break;case 1:if(!Qi&&(Ka(t,e),i=t.stateNode,typeof i.componentWillUnmount=="function"))try{i.props=t.memoizedProps,i.state=t.memoizedState,i.componentWillUnmount()}catch(o){hi(t,e,o)}pr(s,e,t);break;case 21:pr(s,e,t);break;case 22:t.mode&1?(Qi=(i=Qi)||t.memoizedState!==null,pr(s,e,t),Qi=i):pr(s,e,t);break;default:pr(s,e,t)}}function v_(s){var e=s.updateQueue;if(e!==null){s.updateQueue=null;var t=s.stateNode;t===null&&(t=s.stateNode=new GA),e.forEach(function(i){var n=jA.bind(null,s,i);t.has(i)||(t.add(i),i.then(n,n))})}}function rs(s,e){var t=e.deletions;if(t!==null)for(var i=0;i<t.length;i++){var n=t[i];try{var r=s,a=e,o=a;e:for(;o!==null;){switch(o.tag){case 5:ki=o.stateNode,cs=!1;break e;case 3:ki=o.stateNode.containerInfo,cs=!0;break e;case 4:ki=o.stateNode.containerInfo,cs=!0;break e}o=o.return}if(ki===null)throw Error(ue(160));W1(r,a,n),ki=null,cs=!1;var l=n.alternate;l!==null&&(l.return=null),n.return=null}catch(c){hi(n,e,c)}}if(e.subtreeFlags&12854)for(e=e.child;e!==null;)X1(e,s),e=e.sibling}function X1(s,e){var t=s.alternate,i=s.flags;switch(s.tag){case 0:case 11:case 14:case 15:if(rs(e,s),Ts(s),i&4){try{al(3,s,s.return),Wu(3,s)}catch(m){hi(s,s.return,m)}try{al(5,s,s.return)}catch(m){hi(s,s.return,m)}}break;case 1:rs(e,s),Ts(s),i&512&&t!==null&&Ka(t,t.return);break;case 5:if(rs(e,s),Ts(s),i&512&&t!==null&&Ka(t,t.return),s.flags&32){var n=s.stateNode;try{_l(n,"")}catch(m){hi(s,s.return,m)}}if(i&4&&(n=s.stateNode,n!=null)){var r=s.memoizedProps,a=t!==null?t.memoizedProps:r,o=s.type,l=s.updateQueue;if(s.updateQueue=null,l!==null)try{o==="input"&&r.type==="radio"&&r.name!=null&&d0(n,r),Ed(o,a);var c=Ed(o,r);for(a=0;a<l.length;a+=2){var u=l[a],h=l[a+1];u==="style"?g0(n,h):u==="dangerouslySetInnerHTML"?m0(n,h):u==="children"?_l(n,h):ap(n,u,h,c)}switch(o){case"input":fd(n,r);break;case"textarea":f0(n,r);break;case"select":var d=n._wrapperState.wasMultiple;n._wrapperState.wasMultiple=!!r.multiple;var f=r.value;f!=null?qa(n,!!r.multiple,f,!1):d!==!!r.multiple&&(r.defaultValue!=null?qa(n,!!r.multiple,r.defaultValue,!0):qa(n,!!r.multiple,r.multiple?[]:"",!1))}n[Il]=r}catch(m){hi(s,s.return,m)}}break;case 6:if(rs(e,s),Ts(s),i&4){if(s.stateNode===null)throw Error(ue(162));n=s.stateNode,r=s.memoizedProps;try{n.nodeValue=r}catch(m){hi(s,s.return,m)}}break;case 3:if(rs(e,s),Ts(s),i&4&&t!==null&&t.memoizedState.isDehydrated)try{yl(e.containerInfo)}catch(m){hi(s,s.return,m)}break;case 4:rs(e,s),Ts(s);break;case 13:rs(e,s),Ts(s),n=s.child,n.flags&8192&&(r=n.memoizedState!==null,n.stateNode.isHidden=r,!r||n.alternate!==null&&n.alternate.memoizedState!==null||(Up=pi())),i&4&&v_(s);break;case 22:if(u=t!==null&&t.memoizedState!==null,s.mode&1?(Qi=(c=Qi)||u,rs(e,s),Qi=c):rs(e,s),Ts(s),i&8192){if(c=s.memoizedState!==null,(s.stateNode.isHidden=c)&&!u&&s.mode&1)for(we=s,u=s.child;u!==null;){for(h=we=u;we!==null;){switch(d=we,f=d.child,d.tag){case 0:case 11:case 14:case 15:al(4,d,d.return);break;case 1:Ka(d,d.return);var p=d.stateNode;if(typeof p.componentWillUnmount=="function"){i=d,t=d.return;try{e=i,p.props=e.memoizedProps,p.state=e.memoizedState,p.componentWillUnmount()}catch(m){hi(i,t,m)}}break;case 5:Ka(d,d.return);break;case 22:if(d.memoizedState!==null){A_(h);continue}}f!==null?(f.return=d,we=f):A_(h)}u=u.sibling}e:for(u=null,h=s;;){if(h.tag===5){if(u===null){u=h;try{n=h.stateNode,c?(r=n.style,typeof r.setProperty=="function"?r.setProperty("display","none","important"):r.display="none"):(o=h.stateNode,l=h.memoizedProps.style,a=l!=null&&l.hasOwnProperty("display")?l.display:null,o.style.display=_0("display",a))}catch(m){hi(s,s.return,m)}}}else if(h.tag===6){if(u===null)try{h.stateNode.nodeValue=c?"":h.memoizedProps}catch(m){hi(s,s.return,m)}}else if((h.tag!==22&&h.tag!==23||h.memoizedState===null||h===s)&&h.child!==null){h.child.return=h,h=h.child;continue}if(h===s)break e;for(;h.sibling===null;){if(h.return===null||h.return===s)break e;u===h&&(u=null),h=h.return}u===h&&(u=null),h.sibling.return=h.return,h=h.sibling}}break;case 19:rs(e,s),Ts(s),i&4&&v_(s);break;case 21:break;default:rs(e,s),Ts(s)}}function Ts(s){var e=s.flags;if(e&2){try{e:{for(var t=s.return;t!==null;){if(H1(t)){var i=t;break e}t=t.return}throw Error(ue(160))}switch(i.tag){case 5:var n=i.stateNode;i.flags&32&&(_l(n,""),i.flags&=-33);var r=E_(s);Qd(s,r,n);break;case 3:case 4:var a=i.stateNode.containerInfo,o=E_(s);Kd(s,o,a);break;default:throw Error(ue(161))}}catch(l){hi(s,s.return,l)}s.flags&=-3}e&4096&&(s.flags&=-4097)}function HA(s,e,t){we=s,Y1(s)}function Y1(s,e,t){for(var i=(s.mode&1)!==0;we!==null;){var n=we,r=n.child;if(n.tag===22&&i){var a=n.memoizedState!==null||Cc;if(!a){var o=n.alternate,l=o!==null&&o.memoizedState!==null||Qi;o=Cc;var c=Qi;if(Cc=a,(Qi=l)&&!c)for(we=n;we!==null;)a=we,l=a.child,a.tag===22&&a.memoizedState!==null?T_(n):l!==null?(l.return=a,we=l):T_(n);for(;r!==null;)we=r,Y1(r),r=r.sibling;we=n,Cc=o,Qi=c}y_(s)}else n.subtreeFlags&8772&&r!==null?(r.return=n,we=r):y_(s)}}function y_(s){for(;we!==null;){var e=we;if(e.flags&8772){var t=e.alternate;try{if(e.flags&8772)switch(e.tag){case 0:case 11:case 15:Qi||Wu(5,e);break;case 1:var i=e.stateNode;if(e.flags&4&&!Qi)if(t===null)i.componentDidMount();else{var n=e.elementType===e.type?t.memoizedProps:os(e.type,t.memoizedProps);i.componentDidUpdate(n,t.memoizedState,i.__reactInternalSnapshotBeforeUpdate)}var r=e.updateQueue;r!==null&&n_(e,r,i);break;case 3:var a=e.updateQueue;if(a!==null){if(t=null,e.child!==null)switch(e.child.tag){case 5:t=e.child.stateNode;break;case 1:t=e.child.stateNode}n_(e,a,t)}break;case 5:var o=e.stateNode;if(t===null&&e.flags&4){t=o;var l=e.memoizedProps;switch(e.type){case"button":case"input":case"select":case"textarea":l.autoFocus&&t.focus();break;case"img":l.src&&(t.src=l.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(e.memoizedState===null){var c=e.alternate;if(c!==null){var u=c.memoizedState;if(u!==null){var h=u.dehydrated;h!==null&&yl(h)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(ue(163))}Qi||e.flags&512&&Yd(e)}catch(d){hi(e,e.return,d)}}if(e===s){we=null;break}if(t=e.sibling,t!==null){t.return=e.return,we=t;break}we=e.return}}function A_(s){for(;we!==null;){var e=we;if(e===s){we=null;break}var t=e.sibling;if(t!==null){t.return=e.return,we=t;break}we=e.return}}function T_(s){for(;we!==null;){var e=we;try{switch(e.tag){case 0:case 11:case 15:var t=e.return;try{Wu(4,e)}catch(l){hi(e,t,l)}break;case 1:var i=e.stateNode;if(typeof i.componentDidMount=="function"){var n=e.return;try{i.componentDidMount()}catch(l){hi(e,n,l)}}var r=e.return;try{Yd(e)}catch(l){hi(e,r,l)}break;case 5:var a=e.return;try{Yd(e)}catch(l){hi(e,a,l)}}}catch(l){hi(e,e.return,l)}if(e===s){we=null;break}var o=e.sibling;if(o!==null){o.return=e.return,we=o;break}we=e.return}}var WA=Math.ceil,mu=or.ReactCurrentDispatcher,Bp=or.ReactCurrentOwner,ts=or.ReactCurrentBatchConfig,Ct=0,Ni=null,Ti=null,Ui=0,Fn=0,Qa=Xr(0),Di=0,Dl=null,va=0,Xu=0,kp=0,ol=null,Tn=null,Up=0,vo=1/0,Hs=null,_u=!1,Zd=null,Dr=null,Ic=!1,Sr=null,gu=0,ll=0,qd=null,zc=-1,Hc=0;function un(){return Ct&6?pi():zc!==-1?zc:zc=pi()}function Or(s){return s.mode&1?Ct&2&&Ui!==0?Ui&-Ui:bA.transition!==null?(Hc===0&&(Hc=M0()),Hc):(s=kt,s!==0||(s=window.event,s=s===void 0?16:N0(s.type)),s):1}function fs(s,e,t,i){if(50<ll)throw ll=0,qd=null,Error(ue(185));Wl(s,t,i),(!(Ct&2)||s!==Ni)&&(s===Ni&&(!(Ct&2)&&(Xu|=t),Di===4&&Ar(s,Ui)),xn(s,i),t===1&&Ct===0&&!(e.mode&1)&&(vo=pi()+500,Gu&&Yr()))}function xn(s,e){var t=s.callbackNode;by(s,e);var i=eu(s,s===Ni?Ui:0);if(i===0)t!==null&&Dm(t),s.callbackNode=null,s.callbackPriority=0;else if(e=i&-i,s.callbackPriority!==e){if(t!=null&&Dm(t),e===1)s.tag===0?RA(S_.bind(null,s)):t1(S_.bind(null,s)),TA(function(){!(Ct&6)&&Yr()}),t=null;else{switch(P0(i)){case 1:t=hp;break;case 4:t=b0;break;case 16:t=Jc;break;case 536870912:t=x0;break;default:t=Jc}t=eE(t,K1.bind(null,s))}s.callbackPriority=e,s.callbackNode=t}}function K1(s,e){if(zc=-1,Hc=0,Ct&6)throw Error(ue(327));var t=s.callbackNode;if(to()&&s.callbackNode!==t)return null;var i=eu(s,s===Ni?Ui:0);if(i===0)return null;if(i&30||i&s.expiredLanes||e)e=Eu(s,i);else{e=i;var n=Ct;Ct|=2;var r=Z1();(Ni!==s||Ui!==e)&&(Hs=null,vo=pi()+500,oa(s,e));do try{KA();break}catch(o){Q1(s,o)}while(1);Cp(),mu.current=r,Ct=n,Ti!==null?e=0:(Ni=null,Ui=0,e=Di)}if(e!==0){if(e===2&&(n=Sd(s),n!==0&&(i=n,e=jd(s,n))),e===1)throw t=Dl,oa(s,0),Ar(s,i),xn(s,pi()),t;if(e===6)Ar(s,i);else{if(n=s.current.alternate,!(i&30)&&!XA(n)&&(e=Eu(s,i),e===2&&(r=Sd(s),r!==0&&(i=r,e=jd(s,r))),e===1))throw t=Dl,oa(s,0),Ar(s,i),xn(s,pi()),t;switch(s.finishedWork=n,s.finishedLanes=i,e){case 0:case 1:throw Error(ue(345));case 2:$r(s,Tn,Hs);break;case 3:if(Ar(s,i),(i&130023424)===i&&(e=Up+500-pi(),10<e)){if(eu(s,0)!==0)break;if(n=s.suspendedLanes,(n&i)!==i){un(),s.pingedLanes|=s.suspendedLanes&n;break}s.timeoutHandle=Dd($r.bind(null,s,Tn,Hs),e);break}$r(s,Tn,Hs);break;case 4:if(Ar(s,i),(i&4194240)===i)break;for(e=s.eventTimes,n=-1;0<i;){var a=31-ds(i);r=1<<a,a=e[a],a>n&&(n=a),i&=~r}if(i=n,i=pi()-i,i=(120>i?120:480>i?480:1080>i?1080:1920>i?1920:3e3>i?3e3:4320>i?4320:1960*WA(i/1960))-i,10<i){s.timeoutHandle=Dd($r.bind(null,s,Tn,Hs),i);break}$r(s,Tn,Hs);break;case 5:$r(s,Tn,Hs);break;default:throw Error(ue(329))}}}return xn(s,pi()),s.callbackNode===t?K1.bind(null,s):null}function jd(s,e){var t=ol;return s.current.memoizedState.isDehydrated&&(oa(s,e).flags|=256),s=Eu(s,e),s!==2&&(e=Tn,Tn=t,e!==null&&$d(e)),s}function $d(s){Tn===null?Tn=s:Tn.push.apply(Tn,s)}function XA(s){for(var e=s;;){if(e.flags&16384){var t=e.updateQueue;if(t!==null&&(t=t.stores,t!==null))for(var i=0;i<t.length;i++){var n=t[i],r=n.getSnapshot;n=n.value;try{if(!ms(r(),n))return!1}catch(a){return!1}}}if(t=e.child,e.subtreeFlags&16384&&t!==null)t.return=e,e=t;else{if(e===s)break;for(;e.sibling===null;){if(e.return===null||e.return===s)return!0;e=e.return}e.sibling.return=e.return,e=e.sibling}}return!0}function Ar(s,e){for(e&=~kp,e&=~Xu,s.suspendedLanes|=e,s.pingedLanes&=~e,s=s.expirationTimes;0<e;){var t=31-ds(e),i=1<<t;s[t]=-1,e&=~i}}function S_(s){if(Ct&6)throw Error(ue(327));to();var e=eu(s,0);if(!(e&1))return xn(s,pi()),null;var t=Eu(s,e);if(s.tag!==0&&t===2){var i=Sd(s);i!==0&&(e=i,t=jd(s,i))}if(t===1)throw t=Dl,oa(s,0),Ar(s,e),xn(s,pi()),t;if(t===6)throw Error(ue(345));return s.finishedWork=s.current.alternate,s.finishedLanes=e,$r(s,Tn,Hs),xn(s,pi()),null}function Vp(s,e){var t=Ct;Ct|=1;try{return s(e)}finally{Ct=t,Ct===0&&(vo=pi()+500,Gu&&Yr())}}function ya(s){Sr!==null&&Sr.tag===0&&!(Ct&6)&&to();var e=Ct;Ct|=1;var t=ts.transition,i=kt;try{if(ts.transition=null,kt=1,s)return s()}finally{kt=i,ts.transition=t,Ct=e,!(Ct&6)&&Yr()}}function Gp(){Fn=Qa.current,ti(Qa)}function oa(s,e){s.finishedWork=null,s.finishedLanes=0;var t=s.timeoutHandle;if(t!==-1&&(s.timeoutHandle=-1,AA(t)),Ti!==null)for(t=Ti.return;t!==null;){var i=t;switch(Ap(i),i.tag){case 1:i=i.type.childContextTypes,i!=null&&ru();break;case 3:go(),ti(Rn),ti(Zi),Pp();break;case 5:Mp(i);break;case 4:go();break;case 13:ti(si);break;case 19:ti(si);break;case 10:Ip(i.type._context);break;case 22:case 23:Gp()}t=t.return}if(Ni=s,Ti=s=wr(s.current,null),Ui=Fn=e,Di=0,Dl=null,kp=Xu=va=0,Tn=ol=null,ra!==null){for(e=0;e<ra.length;e++)if(t=ra[e],i=t.interleaved,i!==null){t.interleaved=null;var n=i.next,r=t.pending;if(r!==null){var a=r.next;r.next=n,i.next=a}t.pending=i}ra=null}return s}function Q1(s,e){do{var t=Ti;try{if(Cp(),Uc.current=pu,fu){for(var i=ai.memoizedState;i!==null;){var n=i.queue;n!==null&&(n.pending=null),i=i.next}fu=!1}if(Ea=0,wi=Ri=ai=null,rl=!1,xl=0,Bp.current=null,t===null||t.return===null){Di=1,Dl=e,Ti=null;break}e:{var r=s,a=t.return,o=t,l=e;if(e=Ui,o.flags|=32768,l!==null&&typeof l=="object"&&typeof l.then=="function"){var c=l,u=o,h=u.tag;if(!(u.mode&1)&&(h===0||h===11||h===15)){var d=u.alternate;d?(u.updateQueue=d.updateQueue,u.memoizedState=d.memoizedState,u.lanes=d.lanes):(u.updateQueue=null,u.memoizedState=null)}var f=u_(a);if(f!==null){f.flags&=-257,h_(f,a,o,r,e),f.mode&1&&c_(r,c,e),e=f,l=c;var p=e.updateQueue;if(p===null){var m=new Set;m.add(l),e.updateQueue=m}else p.add(l);break e}else{if(!(e&1)){c_(r,c,e),zp();break e}l=Error(ue(426))}}else if(ni&&o.mode&1){var _=u_(a);if(_!==null){!(_.flags&65536)&&(_.flags|=256),h_(_,a,o,r,e),Tp(Eo(l,o));break e}}r=l=Eo(l,o),Di!==4&&(Di=2),ol===null?ol=[r]:ol.push(r),r=a;do{switch(r.tag){case 3:r.flags|=65536,e&=-e,r.lanes|=e;var E=D1(r,l,e);i_(r,E);break e;case 1:o=l;var v=r.type,y=r.stateNode;if(!(r.flags&128)&&(typeof v.getDerivedStateFromError=="function"||y!==null&&typeof y.componentDidCatch=="function"&&(Dr===null||!Dr.has(y)))){r.flags|=65536,e&=-e,r.lanes|=e;var A=O1(r,o,e);i_(r,A);break e}}r=r.return}while(r!==null)}j1(t)}catch(I){e=I,Ti===t&&t!==null&&(Ti=t=t.return);continue}break}while(1)}function Z1(){var s=mu.current;return mu.current=pu,s===null?pu:s}function zp(){(Di===0||Di===3||Di===2)&&(Di=4),Ni===null||!(va&268435455)&&!(Xu&268435455)||Ar(Ni,Ui)}function Eu(s,e){var t=Ct;Ct|=2;var i=Z1();(Ni!==s||Ui!==e)&&(Hs=null,oa(s,e));do try{YA();break}catch(n){Q1(s,n)}while(1);if(Cp(),Ct=t,mu.current=i,Ti!==null)throw Error(ue(261));return Ni=null,Ui=0,Di}function YA(){for(;Ti!==null;)q1(Ti)}function KA(){for(;Ti!==null&&!Ey();)q1(Ti)}function q1(s){var e=J1(s.alternate,s,Fn);s.memoizedProps=s.pendingProps,e===null?j1(s):Ti=e,Bp.current=null}function j1(s){var e=s;do{var t=e.alternate;if(s=e.return,e.flags&32768){if(t=VA(t,e),t!==null){t.flags&=32767,Ti=t;return}if(s!==null)s.flags|=32768,s.subtreeFlags=0,s.deletions=null;else{Di=6,Ti=null;return}}else if(t=UA(t,e,Fn),t!==null){Ti=t;return}if(e=e.sibling,e!==null){Ti=e;return}Ti=e=s}while(e!==null);Di===0&&(Di=5)}function $r(s,e,t){var i=kt,n=ts.transition;try{ts.transition=null,kt=1,QA(s,e,t,i)}finally{ts.transition=n,kt=i}return null}function QA(s,e,t,i){do to();while(Sr!==null);if(Ct&6)throw Error(ue(327));t=s.finishedWork;var n=s.finishedLanes;if(t===null)return null;if(s.finishedWork=null,s.finishedLanes=0,t===s.current)throw Error(ue(177));s.callbackNode=null,s.callbackPriority=0;var r=t.lanes|t.childLanes;if(xy(s,r),s===Ni&&(Ti=Ni=null,Ui=0),!(t.subtreeFlags&2064)&&!(t.flags&2064)||Ic||(Ic=!0,eE(Jc,function(){return to(),null})),r=(t.flags&15990)!==0,t.subtreeFlags&15990||r){r=ts.transition,ts.transition=null;var a=kt;kt=1;var o=Ct;Ct|=4,Bp.current=null,zA(s,t),X1(t,s),pA(Md),tu=!!xd,Md=xd=null,s.current=t,HA(t),vy(),Ct=o,kt=a,ts.transition=r}else s.current=t;if(Ic&&(Ic=!1,Sr=s,gu=n),r=s.pendingLanes,r===0&&(Dr=null),Ty(t.stateNode),xn(s,pi()),e!==null)for(i=s.onRecoverableError,t=0;t<e.length;t++)n=e[t],i(n.value,{componentStack:n.stack,digest:n.digest});if(_u)throw _u=!1,s=Zd,Zd=null,s;return gu&1&&s.tag!==0&&to(),r=s.pendingLanes,r&1?s===qd?ll++:(ll=0,qd=s):ll=0,Yr(),null}function to(){if(Sr!==null){var s=P0(gu),e=ts.transition,t=kt;try{if(ts.transition=null,kt=16>s?16:s,Sr===null)var i=!1;else{if(s=Sr,Sr=null,gu=0,Ct&6)throw Error(ue(331));var n=Ct;for(Ct|=4,we=s.current;we!==null;){var r=we,a=r.child;if(we.flags&16){var o=r.deletions;if(o!==null){for(var l=0;l<o.length;l++){var c=o[l];for(we=c;we!==null;){var u=we;switch(u.tag){case 0:case 11:case 15:al(8,u,r)}var h=u.child;if(h!==null)h.return=u,we=h;else for(;we!==null;){u=we;var d=u.sibling,f=u.return;if(z1(u),u===c){we=null;break}if(d!==null){d.return=f,we=d;break}we=f}}}var p=r.alternate;if(p!==null){var m=p.child;if(m!==null){p.child=null;do{var _=m.sibling;m.sibling=null,m=_}while(m!==null)}}we=r}}if(r.subtreeFlags&2064&&a!==null)a.return=r,we=a;else e:for(;we!==null;){if(r=we,r.flags&2048)switch(r.tag){case 0:case 11:case 15:al(9,r,r.return)}var E=r.sibling;if(E!==null){E.return=r.return,we=E;break e}we=r.return}}var v=s.current;for(we=v;we!==null;){a=we;var y=a.child;if(a.subtreeFlags&2064&&y!==null)y.return=a,we=y;else e:for(a=v;we!==null;){if(o=we,o.flags&2048)try{switch(o.tag){case 0:case 11:case 15:Wu(9,o)}}catch(I){hi(o,o.return,I)}if(o===a){we=null;break e}var A=o.sibling;if(A!==null){A.return=o.return,we=A;break e}we=o.return}}if(Ct=n,Yr(),Ps&&typeof Ps.onPostCommitFiberRoot=="function")try{Ps.onPostCommitFiberRoot(Nu,s)}catch(I){}i=!0}return i}finally{kt=t,ts.transition=e}}return!1}function C_(s,e,t){e=Eo(t,e),e=D1(s,e,1),s=Pr(s,e,1),e=un(),s!==null&&(Wl(s,1,e),xn(s,e))}function hi(s,e,t){if(s.tag===3)C_(s,s,t);else for(;e!==null;){if(e.tag===3){C_(e,s,t);break}else if(e.tag===1){var i=e.stateNode;if(typeof e.type.getDerivedStateFromError=="function"||typeof i.componentDidCatch=="function"&&(Dr===null||!Dr.has(i))){s=Eo(t,s),s=O1(e,s,1),e=Pr(e,s,1),s=un(),e!==null&&(Wl(e,1,s),xn(e,s));break}}e=e.return}}function ZA(s,e,t){var i=s.pingCache;i!==null&&i.delete(e),e=un(),s.pingedLanes|=s.suspendedLanes&t,Ni===s&&(Ui&t)===t&&(Di===4||Di===3&&(Ui&130023424)===Ui&&500>pi()-Up?oa(s,0):kp|=t),xn(s,e)}function $1(s,e){e===0&&(s.mode&1?(e=mc,mc<<=1,!(mc&130023424)&&(mc=4194304)):e=1);var t=un();s=nr(s,e),s!==null&&(Wl(s,e,t),xn(s,t))}function qA(s){var e=s.memoizedState,t=0;e!==null&&(t=e.retryLane),$1(s,t)}function jA(s,e){var t=0;switch(s.tag){case 13:var i=s.stateNode,n=s.memoizedState;n!==null&&(t=n.retryLane);break;case 19:i=s.stateNode;break;default:throw Error(ue(314))}i!==null&&i.delete(e),$1(s,t)}var J1;J1=function(s,e,t){if(s!==null)if(s.memoizedProps!==e.pendingProps||Rn.current)In=!0;else{if(!(s.lanes&t)&&!(e.flags&128))return In=!1,kA(s,e,t);In=!!(s.flags&131072)}else In=!1,ni&&e.flags&1048576&&i1(e,lu,e.index);switch(e.lanes=0,e.tag){case 2:var i=e.type;Gc(s,e),s=e.pendingProps;var n=po(e,Zi.current);eo(e,t),n=Op(null,e,i,s,n,t);var r=wp();return e.flags|=1,typeof n=="object"&&n!==null&&typeof n.render=="function"&&n.$$typeof===void 0?(e.tag=1,e.memoizedState=null,e.updateQueue=null,bn(i)?(r=!0,au(e)):r=!1,e.memoizedState=n.state!==null&&n.state!==void 0?n.state:null,bp(e),n.updater=zu,e.stateNode=n,n._reactInternals=e,kd(e,i,s,t),e=Gd(null,e,i,!0,r,t)):(e.tag=0,ni&&r&&yp(e),sn(null,e,n,t),e=e.child),e;case 16:i=e.elementType;e:{switch(Gc(s,e),s=e.pendingProps,n=i._init,i=n(i._payload),e.type=i,n=e.tag=JA(i),s=os(i,s),n){case 0:e=Vd(null,e,i,s,t);break e;case 1:e=p_(null,e,i,s,t);break e;case 11:e=d_(null,e,i,s,t);break e;case 14:e=f_(null,e,i,os(i.type,s),t);break e}throw Error(ue(306,i,""))}return e;case 0:return i=e.type,n=e.pendingProps,n=e.elementType===i?n:os(i,n),Vd(s,e,i,n,t);case 1:return i=e.type,n=e.pendingProps,n=e.elementType===i?n:os(i,n),p_(s,e,i,n,t);case 3:e:{if(N1(e),s===null)throw Error(ue(387));i=e.pendingProps,r=e.memoizedState,n=r.element,a1(s,e),hu(e,i,null,t);var a=e.memoizedState;if(i=a.element,r.isDehydrated)if(r={element:i,isDehydrated:!1,cache:a.cache,pendingSuspenseBoundaries:a.pendingSuspenseBoundaries,transitions:a.transitions},e.updateQueue.baseState=r,e.memoizedState=r,e.flags&256){n=Eo(Error(ue(423)),e),e=m_(s,e,i,t,n);break e}else if(i!==n){n=Eo(Error(ue(424)),e),e=m_(s,e,i,t,n);break e}else for(Nn=Mr(e.stateNode.containerInfo.firstChild),Bn=e,ni=!0,us=null,t=u1(e,null,i,t),e.child=t;t;)t.flags=t.flags&-3|4096,t=t.sibling;else{if(mo(),i===n){e=sr(s,e,t);break e}sn(s,e,i,t)}e=e.child}return e;case 5:return h1(e),s===null&&Ld(e),i=e.type,n=e.pendingProps,r=s!==null?s.memoizedProps:null,a=n.children,Pd(i,n)?a=null:r!==null&&Pd(i,r)&&(e.flags|=32),L1(s,e),sn(s,e,a,t),e.child;case 6:return s===null&&Ld(e),null;case 13:return B1(s,e,t);case 4:return xp(e,e.stateNode.containerInfo),i=e.pendingProps,s===null?e.child=_o(e,null,i,t):sn(s,e,i,t),e.child;case 11:return i=e.type,n=e.pendingProps,n=e.elementType===i?n:os(i,n),d_(s,e,i,n,t);case 7:return sn(s,e,e.pendingProps,t),e.child;case 8:return sn(s,e,e.pendingProps.children,t),e.child;case 12:return sn(s,e,e.pendingProps.children,t),e.child;case 10:e:{if(i=e.type._context,n=e.pendingProps,r=e.memoizedProps,a=n.value,jt(cu,i._currentValue),i._currentValue=a,r!==null)if(ms(r.value,a)){if(r.children===n.children&&!Rn.current){e=sr(s,e,t);break e}}else for(r=e.child,r!==null&&(r.return=e);r!==null;){var o=r.dependencies;if(o!==null){a=r.child;for(var l=o.firstContext;l!==null;){if(l.context===i){if(r.tag===1){l=Js(-1,t&-t),l.tag=2;var c=r.updateQueue;if(c!==null){c=c.shared;var u=c.pending;u===null?l.next=l:(l.next=u.next,u.next=l),c.pending=l}}r.lanes|=t,l=r.alternate,l!==null&&(l.lanes|=t),Nd(r.return,t,e),o.lanes|=t;break}l=l.next}}else if(r.tag===10)a=r.type===e.type?null:r.child;else if(r.tag===18){if(a=r.return,a===null)throw Error(ue(341));a.lanes|=t,o=a.alternate,o!==null&&(o.lanes|=t),Nd(a,t,e),a=r.sibling}else a=r.child;if(a!==null)a.return=r;else for(a=r;a!==null;){if(a===e){a=null;break}if(r=a.sibling,r!==null){r.return=a.return,a=r;break}a=a.return}r=a}sn(s,e,n.children,t),e=e.child}return e;case 9:return n=e.type,i=e.pendingProps.children,eo(e,t),n=is(n),i=i(n),e.flags|=1,sn(s,e,i,t),e.child;case 14:return i=e.type,n=os(i,e.pendingProps),n=os(i.type,n),f_(s,e,i,n,t);case 15:return w1(s,e,e.type,e.pendingProps,t);case 17:return i=e.type,n=e.pendingProps,n=e.elementType===i?n:os(i,n),Gc(s,e),e.tag=1,bn(i)?(s=!0,au(e)):s=!1,eo(e,t),l1(e,i,n),kd(e,i,n,t),Gd(null,e,i,!0,s,t);case 19:return k1(s,e,t);case 22:return F1(s,e,t)}throw Error(ue(156,e.tag))};function eE(s,e){return R0(s,e)}function $A(s,e,t,i){this.tag=s,this.key=t,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=e,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=i,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function $n(s,e,t,i){return new $A(s,e,t,i)}function Hp(s){return s=s.prototype,!(!s||!s.isReactComponent)}function JA(s){if(typeof s=="function")return Hp(s)?1:0;if(s!=null){if(s=s.$$typeof,s===lp)return 11;if(s===cp)return 14}return 2}function wr(s,e){var t=s.alternate;return t===null?(t=$n(s.tag,e,s.key,s.mode),t.elementType=s.elementType,t.type=s.type,t.stateNode=s.stateNode,t.alternate=s,s.alternate=t):(t.pendingProps=e,t.type=s.type,t.flags=0,t.subtreeFlags=0,t.deletions=null),t.flags=s.flags&14680064,t.childLanes=s.childLanes,t.lanes=s.lanes,t.child=s.child,t.memoizedProps=s.memoizedProps,t.memoizedState=s.memoizedState,t.updateQueue=s.updateQueue,e=s.dependencies,t.dependencies=e===null?null:{lanes:e.lanes,firstContext:e.firstContext},t.sibling=s.sibling,t.index=s.index,t.ref=s.ref,t}function Wc(s,e,t,i,n,r){var a=2;if(i=s,typeof s=="function")Hp(s)&&(a=1);else if(typeof s=="string")a=5;else e:switch(s){case ka:return la(t.children,n,r,e);case op:a=8,n|=8;break;case ld:return s=$n(12,t,e,n|2),s.elementType=ld,s.lanes=r,s;case cd:return s=$n(13,t,e,n),s.elementType=cd,s.lanes=r,s;case ud:return s=$n(19,t,e,n),s.elementType=ud,s.lanes=r,s;case c0:return Yu(t,n,r,e);default:if(typeof s=="object"&&s!==null)switch(s.$$typeof){case o0:a=10;break e;case l0:a=9;break e;case lp:a=11;break e;case cp:a=14;break e;case _r:a=16,i=null;break e}throw Error(ue(130,s==null?s:typeof s,""))}return e=$n(a,t,e,n),e.elementType=s,e.type=i,e.lanes=r,e}function la(s,e,t,i){return s=$n(7,s,i,e),s.lanes=t,s}function Yu(s,e,t,i){return s=$n(22,s,i,e),s.elementType=c0,s.lanes=t,s.stateNode={isHidden:!1},s}function Vh(s,e,t){return s=$n(6,s,null,e),s.lanes=t,s}function Gh(s,e,t){return e=$n(4,s.children!==null?s.children:[],s.key,e),e.lanes=t,e.stateNode={containerInfo:s.containerInfo,pendingChildren:null,implementation:s.implementation},e}function eT(s,e,t,i,n){this.tag=e,this.containerInfo=s,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=Ah(0),this.expirationTimes=Ah(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Ah(0),this.identifierPrefix=i,this.onRecoverableError=n,this.mutableSourceEagerHydrationData=null}function Wp(s,e,t,i,n,r,a,o,l){return s=new eT(s,e,t,o,l),e===1?(e=1,r===!0&&(e|=8)):e=0,r=$n(3,null,null,e),s.current=r,r.stateNode=s,r.memoizedState={element:i,isDehydrated:t,cache:null,transitions:null,pendingSuspenseBoundaries:null},bp(r),s}function tT(s,e,t){var i=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:Ba,key:i==null?null:""+i,children:s,containerInfo:e,implementation:t}}function tE(s){if(!s)return Ur;s=s._reactInternals;e:{if(Sa(s)!==s||s.tag!==1)throw Error(ue(170));var e=s;do{switch(e.tag){case 3:e=e.stateNode.context;break e;case 1:if(bn(e.type)){e=e.stateNode.__reactInternalMemoizedMergedChildContext;break e}}e=e.return}while(e!==null);throw Error(ue(171))}if(s.tag===1){var t=s.type;if(bn(t))return e1(s,t,e)}return e}function iE(s,e,t,i,n,r,a,o,l){return s=Wp(t,i,!0,s,n,r,a,o,l),s.context=tE(null),t=s.current,i=un(),n=Or(t),r=Js(i,n),r.callback=e!=null?e:null,Pr(t,r,n),s.current.lanes=n,Wl(s,n,i),xn(s,i),s}function Ku(s,e,t,i){var n=e.current,r=un(),a=Or(n);return t=tE(t),e.context===null?e.context=t:e.pendingContext=t,e=Js(r,a),e.payload={element:s},i=i===void 0?null:i,i!==null&&(e.callback=i),s=Pr(n,e,a),s!==null&&(fs(s,n,a,r),kc(s,n,a)),a}function vu(s){if(s=s.current,!s.child)return null;switch(s.child.tag){case 5:return s.child.stateNode;default:return s.child.stateNode}}function I_(s,e){if(s=s.memoizedState,s!==null&&s.dehydrated!==null){var t=s.retryLane;s.retryLane=t!==0&&t<e?t:e}}function Xp(s,e){I_(s,e),(s=s.alternate)&&I_(s,e)}function iT(){return null}var nE=typeof reportError=="function"?reportError:function(s){console.error(s)};function Yp(s){this._internalRoot=s}Qu.prototype.render=Yp.prototype.render=function(s){var e=this._internalRoot;if(e===null)throw Error(ue(409));Ku(s,e,null,null)};Qu.prototype.unmount=Yp.prototype.unmount=function(){var s=this._internalRoot;if(s!==null){this._internalRoot=null;var e=s.containerInfo;ya(function(){Ku(null,s,null,null)}),e[ir]=null}};function Qu(s){this._internalRoot=s}Qu.prototype.unstable_scheduleHydration=function(s){if(s){var e=w0();s={blockedOn:null,target:s,priority:e};for(var t=0;t<yr.length&&e!==0&&e<yr[t].priority;t++);yr.splice(t,0,s),t===0&&L0(s)}};function Kp(s){return!(!s||s.nodeType!==1&&s.nodeType!==9&&s.nodeType!==11)}function Zu(s){return!(!s||s.nodeType!==1&&s.nodeType!==9&&s.nodeType!==11&&(s.nodeType!==8||s.nodeValue!==" react-mount-point-unstable "))}function R_(){}function nT(s,e,t,i,n){if(n){if(typeof i=="function"){var r=i;i=function(){var c=vu(a);r.call(c)}}var a=iE(e,i,s,0,null,!1,!1,"",R_);return s._reactRootContainer=a,s[ir]=a.current,Sl(s.nodeType===8?s.parentNode:s),ya(),a}for(;n=s.lastChild;)s.removeChild(n);if(typeof i=="function"){var o=i;i=function(){var c=vu(l);o.call(c)}}var l=Wp(s,0,!1,null,null,!1,!1,"",R_);return s._reactRootContainer=l,s[ir]=l.current,Sl(s.nodeType===8?s.parentNode:s),ya(function(){Ku(e,l,t,i)}),l}function qu(s,e,t,i,n){var r=t._reactRootContainer;if(r){var a=r;if(typeof n=="function"){var o=n;n=function(){var l=vu(a);o.call(l)}}Ku(e,a,s,n)}else a=nT(t,e,s,n,i);return vu(a)}D0=function(s){switch(s.tag){case 3:var e=s.stateNode;if(e.current.memoizedState.isDehydrated){var t=Zo(e.pendingLanes);t!==0&&(dp(e,t|1),xn(e,pi()),!(Ct&6)&&(vo=pi()+500,Yr()))}break;case 13:ya(function(){var i=nr(s,1);if(i!==null){var n=un();fs(i,s,1,n)}}),Xp(s,1)}};fp=function(s){if(s.tag===13){var e=nr(s,134217728);if(e!==null){var t=un();fs(e,s,134217728,t)}Xp(s,134217728)}};O0=function(s){if(s.tag===13){var e=Or(s),t=nr(s,e);if(t!==null){var i=un();fs(t,s,e,i)}Xp(s,e)}};w0=function(){return kt};F0=function(s,e){var t=kt;try{return kt=s,e()}finally{kt=t}};yd=function(s,e,t){switch(e){case"input":if(fd(s,t),e=t.name,t.type==="radio"&&e!=null){for(t=s;t.parentNode;)t=t.parentNode;for(t=t.querySelectorAll("input[name="+JSON.stringify(""+e)+'][type="radio"]'),e=0;e<t.length;e++){var i=t[e];if(i!==s&&i.form===s.form){var n=Vu(i);if(!n)throw Error(ue(90));h0(i),fd(i,n)}}}break;case"textarea":f0(s,t);break;case"select":e=t.value,e!=null&&qa(s,!!t.multiple,e,!1)}};y0=Vp;A0=ya;var sT={usingClientEntryPoint:!1,Events:[Yl,za,Vu,E0,v0,Vp]},Wo={findFiberByHostInstance:sa,bundleType:0,version:"18.2.0",rendererPackageName:"react-dom"},rT={bundleType:Wo.bundleType,version:Wo.version,rendererPackageName:Wo.rendererPackageName,rendererConfig:Wo.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:or.ReactCurrentDispatcher,findHostInstanceByFiber:function(s){return s=C0(s),s===null?null:s.stateNode},findFiberByHostInstance:Wo.findFiberByHostInstance||iT,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.2.0-next-9e3b772b8-20220608"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__!="undefined"){var Rc=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Rc.isDisabled&&Rc.supportsFiber)try{Nu=Rc.inject(rT),Ps=Rc}catch(s){}}Gn.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=sT;Gn.createPortal=function(s,e){var t=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!Kp(e))throw Error(ue(200));return tT(s,e,null,t)};Gn.createRoot=function(s,e){if(!Kp(s))throw Error(ue(299));var t=!1,i="",n=nE;return e!=null&&(e.unstable_strictMode===!0&&(t=!0),e.identifierPrefix!==void 0&&(i=e.identifierPrefix),e.onRecoverableError!==void 0&&(n=e.onRecoverableError)),e=Wp(s,1,!1,null,null,t,!1,i,n),s[ir]=e.current,Sl(s.nodeType===8?s.parentNode:s),new Yp(e)};Gn.findDOMNode=function(s){if(s==null)return null;if(s.nodeType===1)return s;var e=s._reactInternals;if(e===void 0)throw typeof s.render=="function"?Error(ue(188)):(s=Object.keys(s).join(","),Error(ue(268,s)));return s=C0(e),s=s===null?null:s.stateNode,s};Gn.flushSync=function(s){return ya(s)};Gn.hydrate=function(s,e,t){if(!Zu(e))throw Error(ue(200));return qu(null,s,e,!0,t)};Gn.hydrateRoot=function(s,e,t){if(!Kp(s))throw Error(ue(405));var i=t!=null&&t.hydratedSources||null,n=!1,r="",a=nE;if(t!=null&&(t.unstable_strictMode===!0&&(n=!0),t.identifierPrefix!==void 0&&(r=t.identifierPrefix),t.onRecoverableError!==void 0&&(a=t.onRecoverableError)),e=iE(e,null,s,1,t!=null?t:null,n,!1,r,a),s[ir]=e.current,Sl(s),i)for(s=0;s<i.length;s++)t=i[s],n=t._getVersion,n=n(t._source),e.mutableSourceEagerHydrationData==null?e.mutableSourceEagerHydrationData=[t,n]:e.mutableSourceEagerHydrationData.push(t,n);return new Qu(e)};Gn.render=function(s,e,t){if(!Zu(e))throw Error(ue(200));return qu(null,s,e,!1,t)};Gn.unmountComponentAtNode=function(s){if(!Zu(s))throw Error(ue(40));return s._reactRootContainer?(ya(function(){qu(null,null,s,!1,function(){s._reactRootContainer=null,s[ir]=null})}),!0):!1};Gn.unstable_batchedUpdates=Vp;Gn.unstable_renderSubtreeIntoContainer=function(s,e,t,i){if(!Zu(t))throw Error(ue(200));if(s==null||s._reactInternals===void 0)throw Error(ue(38));return qu(s,e,t,!1,i)};Gn.version="18.2.0-next-9e3b772b8-20220608";function sE(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__=="undefined"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(sE)}catch(s){console.error(s)}}sE(),i0.exports=Gn;var aT=i0.exports,rE,b_=aT;rE=b_.createRoot,b_.hydrateRoot;Promise.allSettled=Promise.allSettled||(s=>Promise.all(s.map(e=>e.then(t=>({status:"fulfilled",value:t})).catch(t=>({status:"rejected",reason:t})))));class jo{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}}class W{static WithinEpsilon(e,t,i=1401298e-51){return Math.abs(e-t)<=i}static ToHex(e){const t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()}static Sign(e){return e=+e,e===0||isNaN(e)?e:e>0?1:-1}static Clamp(e,t=0,i=1){return Math.min(i,Math.max(t,e))}static Log2(e){return Math.log(e)*Math.LOG2E}static ILog2(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(e===0)return-1/0;let t=0;if(e<1){for(;e<1;)t++,e=e*2;t=-t}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t}static Repeat(e,t){return e-Math.floor(e/t)*t}static Normalize(e,t,i){return(e-t)/(i-t)}static Denormalize(e,t,i){return e*(i-t)+t}static DeltaAngle(e,t){let i=W.Repeat(t-e,360);return i>180&&(i-=360),i}static PingPong(e,t){const i=W.Repeat(e,t*2);return t-Math.abs(i-t)}static SmoothStep(e,t,i){let n=W.Clamp(i);return n=-2*n*n*n+3*n*n,t*n+e*(1-n)}static MoveTowards(e,t,i){let n=0;return Math.abs(t-e)<=i?n=t:n=e+W.Sign(t-e)*i,n}static MoveTowardsAngle(e,t,i){const n=W.DeltaAngle(e,t);let r=0;return-i<n&&n<i?r=t:(t=e+n,r=W.MoveTowards(e,t,i)),r}static Lerp(e,t,i){return e+(t-e)*i}static LerpAngle(e,t,i){let n=W.Repeat(t-e,360);return n>180&&(n-=360),e+n*W.Clamp(i)}static InverseLerp(e,t,i){let n=0;return e!=t?n=W.Clamp((i-e)/(t-e)):n=0,n}static Hermite(e,t,i,n,r){const a=r*r,o=r*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+r,h=o-a;return e*l+i*c+t*u+n*h}static Hermite1stDerivative(e,t,i,n,r){const a=r*r;return(a-r)*6*e+(3*a-4*r+1)*t+(-a+r)*6*i+(3*a-2*r)*n}static RandomRange(e,t){return e===t?e:Math.random()*(t-e)+e}static RangeToPercent(e,t,i){return(e-t)/(i-t)}static PercentToRange(e,t,i){return(i-t)*e+t}static NormalizeRadians(e){return e-=W.TwoPi*Math.floor((e+Math.PI)/W.TwoPi),e}static HCF(e,t){const i=e%t;return i===0?t:W.HCF(t,i)}}W.TwoPi=Math.PI*2;const Xc=1/2.2,Yc=2.2,lt=.001;class mi{static BuildArray(e,t){const i=[];for(let n=0;n<e;++n)i.push(t());return i}static BuildTuple(e,t){return mi.BuildArray(e,t)}}function oT(s,e,t){const i=s[e];if(typeof i!="function")return null;const n=function(){const r=s.length,a=n.previous.apply(s,arguments);return t(e,r),a};return i.next=n,n.previous=i,s[e]=n,()=>{const r=n.previous;if(!r)return;const a=n.next;a?(r.next=a,a.previous=r):(r.next=void 0,s[e]=r),n.next=void 0,n.previous=void 0}}const lT=["push","splice","pop","shift","unshift"];function aE(s,e){const t=lT.map(i=>oT(s,i,e));return()=>{t.forEach(i=>{i==null||i()})}}const oE={};function Rt(s,e){oE[s]=e}function hn(s){return oE[s]}class fi{static SetMatrixPrecision(e){if(fi.MatrixTrackPrecisionChange=!1,e&&!fi.MatrixUse64Bits&&fi.MatrixTrackedMatrices)for(let t=0;t<fi.MatrixTrackedMatrices.length;++t){const i=fi.MatrixTrackedMatrices[t],n=i._m;i._m=new Array(16);for(let r=0;r<16;++r)i._m[r]=n[r]}fi.MatrixUse64Bits=e,fi.MatrixCurrentType=fi.MatrixUse64Bits?Array:Float32Array,fi.MatrixTrackedMatrices=null}}fi.MatrixUse64Bits=!1;fi.MatrixTrackPrecisionChange=!0;fi.MatrixCurrentType=Float32Array;fi.MatrixTrackedMatrices=[];class cT{constructor(e,t=!1,i,n){this.initialize(e,t,i,n)}initialize(e,t=!1,i,n){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=n,this}}class uT{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1,this._remove=null}remove(){this._remove&&this._remove()}}class O{static FromPromise(e,t){const i=new O;return e.then(n=>{i.notifyObservers(n)}).catch(n=>{if(t)t.notifyObservers(n);else throw n}),i}get observers(){return this._observers}constructor(e,t=!1){this.notifyIfTriggered=t,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new cT(0),e&&(this._onObserverAdded=e)}add(e,t=-1,i=!1,n=null,r=!1){if(!e)return null;const a=new uT(e,t,n);return a.unregisterOnNextCall=r,i?this._observers.unshift(a):this._observers.push(a),this._onObserverAdded&&this._onObserverAdded(a),this._hasNotified&&this.notifyIfTriggered&&this._lastNotifiedValue!==void 0&&this.notifyObserver(a,this._lastNotifiedValue),a._remove=()=>{this.remove(a)},a}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return e?(e._remove=null,this._observers.indexOf(e)!==-1?(this._deferUnregister(e),!0):!1):!1}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){const n=this._observers[i];if(!n._willBeUnregistered&&n.callback===e&&(!t||t===n.scope))return this._deferUnregister(n),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(()=>{this._remove(e)},0))}_remove(e,t=!0){if(!e)return!1;const i=this._observers.indexOf(e);return i!==-1?(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(i,1),!0):!1}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,i,n,r){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;const a=this._eventState;a.mask=t,a.target=i,a.currentTarget=n,a.skipNextObservers=!1,a.lastReturnValue=e,a.userInfo=r;for(const o of this._observers)if(!o._willBeUnregistered&&(o.mask&t&&(o.unregisterOnNextCall&&this._deferUnregister(o),o.scope?a.lastReturnValue=o.callback.apply(o.scope,[e,a]):a.lastReturnValue=o.callback(e,a)),a.skipNextObservers))return!1;return!0}notifyObserver(e,t,i=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=t),e._willBeUnregistered)return;const n=this._eventState;n.mask=i,n.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,n)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){for(;this._observers.length;){const e=this._observers.pop();e&&(e._remove=null)}this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){const e=new O;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}class Fe{static get LastCreatedEngine(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}Fe.Instances=new Array;Fe.OnEnginesDisposedObservable=new O;Fe._LastCreatedScene=null;Fe.UseFallbackTexture=!0;Fe.FallbackTexture="";const cn=s=>parseInt(s.toString().replace(/\W/g,""));class j{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){const e=cn(this.x),t=cn(this.y);let i=e;return i=i*397^t,i}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return j.FromArrayToRef(e,t,this),this}asArray(){const e=new Array;return this.toArray(e,0),e}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}add(e){return new this.constructor(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addVector3(e){return new this.constructor(this.x+e.x,this.y+e.y)}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new this.constructor(this.x*e,this.y*t)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.divideToRef(e,this)}negate(){return new this.constructor(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.copyFromFloats(this.x*-1,this.y*-1)}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){const t=new this.constructor(0,0);return this.scaleToRef(e,t),t}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=lt){return e&&W.WithinEpsilon(this.x,e.x,t)&&W.WithinEpsilon(this.y,e.y,t)}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}rotateToRef(e,t){const i=Math.cos(e),n=Math.sin(e),r=i*this.x-n*this.y,a=n*this.x+i*this.y;return t.x=r,t.y=a,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return j.NormalizeToRef(this,this),this}clone(){return new this.constructor(this.x,this.y)}static Zero(){return new j(0,0)}static One(){return new j(1,1)}static Random(e=0,t=1){return new j(W.RandomRange(e,t),W.RandomRange(e,t))}static get ZeroReadOnly(){return j._ZeroReadOnly}static FromArray(e,t=0){return new j(e[t],e[t+1])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i}static CatmullRom(e,t,i,n,r){const a=r*r,o=r*a,l=.5*(2*t.x+(-e.x+i.x)*r+(2*e.x-5*t.x+4*i.x-n.x)*a+(-e.x+3*t.x-3*i.x+n.x)*o),c=.5*(2*t.y+(-e.y+i.y)*r+(2*e.y-5*t.y+4*i.y-n.y)*a+(-e.y+3*t.y-3*i.y+n.y)*o);return new e.constructor(l,c)}static Clamp(e,t,i){let n=e.x;n=n>i.x?i.x:n,n=n<t.x?t.x:n;let r=e.y;return r=r>i.y?i.y:r,r=r<t.y?t.y:r,new e.constructor(n,r)}static Hermite(e,t,i,n,r){const a=r*r,o=r*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+r,h=o-a,d=e.x*l+i.x*c+t.x*u+n.x*h,f=e.y*l+i.y*c+t.y*u+n.y*h;return new e.constructor(d,f)}static Hermite1stDerivative(e,t,i,n,r){const a=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,n,r,a),a}static Hermite1stDerivativeToRef(e,t,i,n,r,a){const o=r*r;return a.x=(o-r)*6*e.x+(3*o-4*r+1)*t.x+(-o+r)*6*i.x+(3*o-2*r)*n.x,a.y=(o-r)*6*e.y+(3*o-4*r+1)*t.y+(-o+r)*6*i.y+(3*o-2*r)*n.y,a}static Lerp(e,t,i){const n=e.x+(t.x-e.x)*i,r=e.y+(t.y-e.y)*i;return new e.constructor(n,r)}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){const t=new e.constructor;return this.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){const i=e.length();return i===0||(t.x=e.x/i,t.y=e.y/i),t}static Minimize(e,t){const i=e.x<t.x?e.x:t.x,n=e.y<t.y?e.y:t.y;return new e.constructor(i,n)}static Maximize(e,t){const i=e.x>t.x?e.x:t.x,n=e.y>t.y?e.y:t.y;return new e.constructor(i,n)}static Transform(e,t){const i=new e.constructor;return j.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){const n=t.m,r=e.x*n[0]+e.y*n[4]+n[12],a=e.x*n[1]+e.y*n[5]+n[13];return i.x=r,i.y=a,i}static PointInTriangle(e,t,i,n){const r=.5*(-i.y*n.x+t.y*(-i.x+n.x)+t.x*(i.y-n.y)+i.x*n.y),a=r<0?-1:1,o=(t.y*n.x-t.x*n.y+(n.y-t.y)*e.x+(t.x-n.x)*e.y)*a,l=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*a;return o>0&&l>0&&o+l<2*r*a}static Distance(e,t){return Math.sqrt(j.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,n=e.y-t.y;return i*i+n*n}static Center(e,t){const i=new e.constructor;return j.CenterToRef(e,t,i)}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,i){const n=j.DistanceSquared(t,i);if(n===0)return j.Distance(e,t);const r=i.subtract(t),a=Math.max(0,Math.min(1,j.Dot(e.subtract(t),r)/n)),o=t.add(r.multiplyByFloats(a,a));return j.Distance(e,o)}}j._ZeroReadOnly=j.Zero();class g{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,t=0,i=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){const e=cn(this._x),t=cn(this._y),i=cn(this._z);let n=e;return n=n*397^t,n=n*397^i,n}asArray(){const e=[];return this.toArray(e,0),e}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return g.FromArrayToRef(e,t,this),this}toQuaternion(){return ee.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this.addInPlaceFromFloats(e._x,e._y,e._z)}addInPlaceFromFloats(e,t,i){return this._x+=e,this._y+=t,this._z+=i,this._isDirty=!0,this}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,i){return new this.constructor(this._x-e,this._y-t,this._z-i)}subtractFromFloatsToRef(e,t,i,n){return n.copyFromFloats(this._x-e,this._y-t,this._z-i)}negate(){return new this.constructor(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e.copyFromFloats(this._x*-1,this._y*-1,this._z*-1)}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t.copyFromFloats(this._x*e,this._y*e,this._z*e)}getNormalToRef(e){const t=this.length();let i=Math.acos(this.y/t);const n=Math.atan2(this.z,this.x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;const r=t*Math.sin(i)*Math.cos(n),a=t*Math.cos(i),o=t*Math.sin(i)*Math.sin(n);return e.set(r,a,o),e}applyRotationQuaternionToRef(e,t){const i=this._x,n=this._y,r=this._z,a=e._x,o=e._y,l=e._z,c=e._w,u=2*(o*r-l*n),h=2*(l*i-a*r),d=2*(a*n-o*i);return t._x=i+c*u+o*d-l*h,t._y=n+c*h+l*u-a*d,t._z=r+c*d+a*h-o*u,t._isDirty=!0,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new this.constructor)}scaleAndAddToRef(e,t){return t.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)}projectOnPlane(e,t){const i=new this.constructor;return this.projectOnPlaneToRef(e,t,i),i}projectOnPlaneToRef(e,t,i){const n=e.normal,r=e.d,a=Se.Vector3[0];this.subtractToRef(t,a),a.normalize();const o=g.Dot(a,n);if(Math.abs(o)<Math.pow(10,-10))i.setAll(1/0);else{const l=-(g.Dot(t,n)+r)/o,c=a.scaleInPlace(l);t.addToRef(c,i)}return i}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=lt){return e&&W.WithinEpsilon(this._x,e._x,t)&&W.WithinEpsilon(this._y,e._y,t)&&W.WithinEpsilon(this._z,e._z,t)}equalsToFloats(e,t,i){return this._x===e&&this._y===t&&this._z===i}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)}multiplyByFloats(e,t,i){return new this.constructor(this._x*e,this._y*t,this._z*i)}divide(e){return new this.constructor(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(e){const t=Math.abs(this._x),i=Math.abs(this._y);if(!W.WithinEpsilon(t,i,e))return!0;const n=Math.abs(this._z);return!W.WithinEpsilon(t,n,e)||!W.WithinEpsilon(i,n,e)}get isNonUniform(){const e=Math.abs(this._x),t=Math.abs(this._y);if(e!==t)return!0;const i=Math.abs(this._z);return e!==i}floor(){return new this.constructor(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}fract(){return new this.constructor(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z===0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){return e=e.toLowerCase(),e==="xyz"?this:(Se.Vector3[0].copyFrom(this),["x","y","z"].forEach((t,i)=>{this[t]=Se.Vector3[0][e[i]]}),this)}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(Se.Matrix[0]),g.TransformCoordinatesToRef(this,Se.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,i){return this.subtractToRef(t,Se.Vector3[0]),Se.Vector3[0].rotateByQuaternionToRef(e,Se.Vector3[0]),t.addToRef(Se.Vector3[0],i),i}cross(e){const t=new this.constructor;return g.CrossToRef(this,e,t)}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return t===0||t===1?e.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/t,e)}clone(){return new this.constructor(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,i){return this._x=e,this._y=t,this._z=i,this._isDirty=!0,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(e,t,i,n){const r=g.Dot(e,i)-n,a=g.Dot(t,i)-n;return r/(r-a)}static GetAngleBetweenVectors(e,t,i){const n=e.normalizeToRef(Se.Vector3[1]),r=t.normalizeToRef(Se.Vector3[2]);let a=g.Dot(n,r);a=W.Clamp(a,-1,1);const o=Math.acos(a),l=Se.Vector3[3];return g.CrossToRef(n,r,l),g.Dot(l,i)>0?isNaN(o)?0:o:isNaN(o)?-Math.PI:-Math.acos(a)}static GetAngleBetweenVectorsOnPlane(e,t,i){Se.Vector3[0].copyFrom(e);const n=Se.Vector3[0];Se.Vector3[1].copyFrom(t);const r=Se.Vector3[1];Se.Vector3[2].copyFrom(i);const a=Se.Vector3[2],o=Se.Vector3[3],l=Se.Vector3[4];n.normalize(),r.normalize(),a.normalize(),g.CrossToRef(a,n,o),g.CrossToRef(o,a,l);const c=Math.atan2(g.Dot(r,o),g.Dot(r,l));return W.NormalizeRadians(c)}static PitchYawRollToMoveBetweenPointsToRef(e,t,i){const n=w.Vector3[0];return t.subtractToRef(e,n),i._y=Math.atan2(n.x,n.z)||0,i._x=Math.atan2(Math.sqrt(ks(n.x,2)+ks(n.z,2)),n.y)||0,i._z=0,i._isDirty=!0,i}static PitchYawRollToMoveBetweenPoints(e,t){const i=g.Zero();return g.PitchYawRollToMoveBetweenPointsToRef(e,t,i)}static SlerpToRef(e,t,i,n){i=W.Clamp(i,0,1);const r=Se.Vector3[0],a=Se.Vector3[1];r.copyFrom(e);const o=r.length();r.normalizeFromLength(o),a.copyFrom(t);const l=a.length();a.normalizeFromLength(l);const c=g.Dot(r,a);let u,h;if(c<1-lt){const d=Math.acos(c),f=1/Math.sin(d);u=Math.sin((1-i)*d)*f,h=Math.sin(i*d)*f}else u=1-i,h=i;return r.scaleInPlace(u),a.scaleInPlace(h),n.copyFrom(r).addInPlace(a),n.scaleInPlace(W.Lerp(o,l,i)),n}static SmoothToRef(e,t,i,n,r){return g.SlerpToRef(e,t,n===0?1:i/n,r),r}static FromArray(e,t=0){return new g(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return g.FromArray(e,t)}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._isDirty=!0,i}static FromFloatArrayToRef(e,t,i){return g.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,n){return n.copyFromFloats(e,t,i),n}static Zero(){return new g(0,0,0)}static One(){return new g(1,1,1)}static Up(){return new g(0,1,0)}static get UpReadOnly(){return g._UpReadOnly}static get DownReadOnly(){return g._DownReadOnly}static get RightReadOnly(){return g._RightReadOnly}static get LeftReadOnly(){return g._LeftReadOnly}static get LeftHandedForwardReadOnly(){return g._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return g._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return g._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return g._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return g._ZeroReadOnly}static get OneReadOnly(){return g._OneReadOnly}static Down(){return new g(0,-1,0)}static Forward(e=!1){return new g(0,0,e?-1:1)}static Backward(e=!1){return new g(0,0,e?1:-1)}static Right(){return new g(1,0,0)}static Left(){return new g(-1,0,0)}static Random(e=0,t=1){return new g(W.RandomRange(e,t),W.RandomRange(e,t),W.RandomRange(e,t))}static TransformCoordinates(e,t){const i=g.Zero();return g.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return g.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,n,r){const a=n.m,o=e*a[0]+t*a[4]+i*a[8]+a[12],l=e*a[1]+t*a[5]+i*a[9]+a[13],c=e*a[2]+t*a[6]+i*a[10]+a[14],u=1/(e*a[3]+t*a[7]+i*a[11]+a[15]);return r._x=o*u,r._y=l*u,r._z=c*u,r._isDirty=!0,r}static TransformNormal(e,t){const i=g.Zero();return g.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformNormalFromFloatsToRef(e,t,i,n,r){const a=n.m;return r._x=e*a[0]+t*a[4]+i*a[8],r._y=e*a[1]+t*a[5]+i*a[9],r._z=e*a[2]+t*a[6]+i*a[10],r._isDirty=!0,r}static CatmullRom(e,t,i,n,r){const a=r*r,o=r*a,l=.5*(2*t._x+(-e._x+i._x)*r+(2*e._x-5*t._x+4*i._x-n._x)*a+(-e._x+3*t._x-3*i._x+n._x)*o),c=.5*(2*t._y+(-e._y+i._y)*r+(2*e._y-5*t._y+4*i._y-n._y)*a+(-e._y+3*t._y-3*i._y+n._y)*o),u=.5*(2*t._z+(-e._z+i._z)*r+(2*e._z-5*t._z+4*i._z-n._z)*a+(-e._z+3*t._z-3*i._z+n._z)*o);return new e.constructor(l,c,u)}static Clamp(e,t,i){const n=new e.constructor;return g.ClampToRef(e,t,i,n),n}static ClampToRef(e,t,i,n){let r=e._x;r=r>i._x?i._x:r,r=r<t._x?t._x:r;let a=e._y;a=a>i._y?i._y:a,a=a<t._y?t._y:a;let o=e._z;return o=o>i._z?i._z:o,o=o<t._z?t._z:o,n.copyFromFloats(r,a,o),n}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static Hermite(e,t,i,n,r){const a=r*r,o=r*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+r,h=o-a,d=e._x*l+i._x*c+t._x*u+n._x*h,f=e._y*l+i._y*c+t._y*u+n._y*h,p=e._z*l+i._z*c+t._z*u+n._z*h;return new e.constructor(d,f,p)}static Hermite1stDerivative(e,t,i,n,r){const a=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,n,r,a),a}static Hermite1stDerivativeToRef(e,t,i,n,r,a){const o=r*r;return a._x=(o-r)*6*e._x+(3*o-4*r+1)*t._x+(-o+r)*6*i._x+(3*o-2*r)*n._x,a._y=(o-r)*6*e._y+(3*o-4*r+1)*t._y+(-o+r)*6*i._y+(3*o-2*r)*n._y,a._z=(o-r)*6*e._z+(3*o-4*r+1)*t._z+(-o+r)*6*i._z+(3*o-2*r)*n._z,a._isDirty=!0,a}static Lerp(e,t,i){const n=new e.constructor(0,0,0);return g.LerpToRef(e,t,i,n),n}static LerpToRef(e,t,i,n){return n._x=e._x+(t._x-e._x)*i,n._y=e._y+(t._y-e._y)*i,n._z=e._z+(t._z-e._z)*i,n._isDirty=!0,n}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}static Cross(e,t){const i=new e.constructor;return g.CrossToRef(e,t,i),i}static CrossToRef(e,t,i){const n=e._y*t._z-e._z*t._y,r=e._z*t._x-e._x*t._z,a=e._x*t._y-e._y*t._x;return i.copyFromFloats(n,r,a),i}static Normalize(e){const t=g.Zero();return g.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(e,t,i,n){const r=new e.constructor;return g.ProjectToRef(e,t,i,n,r),r}static ProjectToRef(e,t,i,n,r){const a=n.width,o=n.height,l=n.x,c=n.y,u=Se.Matrix[1];D.FromValuesToRef(a/2,0,0,0,0,-o/2,0,0,0,0,.5,0,l+a/2,o/2+c,.5,1,u);const h=Se.Matrix[0];return t.multiplyToRef(i,h),h.multiplyToRef(u,h),g.TransformCoordinatesToRef(e,h,r),r}static Reflect(e,t){return this.ReflectToRef(e,t,new g)}static ReflectToRef(e,t,i){const n=w.Vector3[0];return n.copyFrom(t).scaleInPlace(2*g.Dot(e,t)),i.copyFrom(e).subtractInPlace(n)}static _UnprojectFromInvertedMatrixToRef(e,t,i){g.TransformCoordinatesToRef(e,t,i);const n=t.m,r=e._x*n[3]+e._y*n[7]+e._z*n[11]+n[15];return W.WithinEpsilon(r,1)&&i.scaleInPlace(1/r),i}static UnprojectFromTransform(e,t,i,n,r){return this.Unproject(e,t,i,n,r,D.IdentityReadOnly)}static Unproject(e,t,i,n,r,a){const o=new e.constructor;return g.UnprojectToRef(e,t,i,n,r,a,o),o}static UnprojectToRef(e,t,i,n,r,a,o){return g.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,n,r,a,o),o}static UnprojectFloatsToRef(e,t,i,n,r,a,o,l,c){var u;const h=Se.Matrix[0];a.multiplyToRef(o,h),h.multiplyToRef(l,h),h.invert();const d=Se.Vector3[0];return d.x=e/n*2-1,d.y=-(t/r*2-1),!((u=Fe.LastCreatedEngine)===null||u===void 0)&&u.isNDCHalfZRange?d.z=i:d.z=2*i-1,g._UnprojectFromInvertedMatrixToRef(d,h,c),c}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(g.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e._x-t._x,n=e._y-t._y,r=e._z-t._z;return i*i+n*n+r*r}static ProjectOnTriangleToRef(e,t,i,n,r){const a=Se.Vector3[0],o=Se.Vector3[1],l=Se.Vector3[2],c=Se.Vector3[3],u=Se.Vector3[4];i.subtractToRef(t,a),n.subtractToRef(t,o),n.subtractToRef(i,l);const h=a.length(),d=o.length(),f=l.length();if(h<lt||d<lt||f<lt)return r.copyFrom(t),g.Distance(e,t);e.subtractToRef(t,u),g.CrossToRef(a,o,c);const p=c.length();if(p<lt)return r.copyFrom(t),g.Distance(e,t);c.normalizeFromLength(p);let m=u.length();if(m<lt)return r.copyFrom(t),0;u.normalizeFromLength(m);const _=g.Dot(c,u),E=Se.Vector3[5],v=Se.Vector3[6];E.copyFrom(c).scaleInPlace(-m*_),v.copyFrom(e).addInPlace(E);const y=Se.Vector3[4],A=Se.Vector3[5],I=Se.Vector3[7],T=Se.Vector3[8];y.copyFrom(a).scaleInPlace(1/h),T.copyFrom(o).scaleInPlace(1/d),y.addInPlace(T).scaleInPlace(-1),A.copyFrom(a).scaleInPlace(-1/h),T.copyFrom(l).scaleInPlace(1/f),A.addInPlace(T).scaleInPlace(-1),I.copyFrom(l).scaleInPlace(-1/f),T.copyFrom(o).scaleInPlace(-1/d),I.addInPlace(T).scaleInPlace(-1);const R=Se.Vector3[9];let x;R.copyFrom(v).subtractInPlace(t),g.CrossToRef(y,R,T),x=g.Dot(T,c);const F=x;R.copyFrom(v).subtractInPlace(i),g.CrossToRef(A,R,T),x=g.Dot(T,c);const L=x;R.copyFrom(v).subtractInPlace(n),g.CrossToRef(I,R,T),x=g.Dot(T,c);const V=x,Z=Se.Vector3[10];let ne,ae;F>0&&L<0?(Z.copyFrom(a),ne=t,ae=i):L>0&&V<0?(Z.copyFrom(l),ne=i,ae=n):(Z.copyFrom(o).scaleInPlace(-1),ne=n,ae=t);const Ue=Se.Vector3[9],Ve=Se.Vector3[4];if(ne.subtractToRef(v,T),ae.subtractToRef(v,Ue),g.CrossToRef(T,Ue,Ve),!(g.Dot(Ve,c)<0))return r.copyFrom(v),Math.abs(m*_);const re=Se.Vector3[5];g.CrossToRef(Z,Ve,re),re.normalize();const ge=Se.Vector3[9];ge.copyFrom(ne).subtractInPlace(v);const be=ge.length();if(be<lt)return r.copyFrom(ne),g.Distance(e,ne);ge.normalizeFromLength(be);const ze=g.Dot(re,ge),Ke=Se.Vector3[7];Ke.copyFrom(v).addInPlace(re.scaleInPlace(be*ze)),T.copyFrom(Ke).subtractInPlace(ne),m=Z.length(),Z.normalizeFromLength(m);let Ut=g.Dot(T,Z)/Math.max(m,lt);return Ut=W.Clamp(Ut,0,1),Ke.copyFrom(ne).addInPlace(Z.scaleInPlace(Ut*m)),r.copyFrom(Ke),g.Distance(e,Ke)}static Center(e,t){return g.CenterToRef(e,t,g.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,i){const n=new e.constructor;return g.RotationFromAxisToRef(e,t,i,n),n}static RotationFromAxisToRef(e,t,i,n){const r=Se.Quaternion[0];return ee.RotationQuaternionFromAxisToRef(e,t,i,r),r.toEulerAnglesToRef(n),n}}g._UpReadOnly=g.Up();g._DownReadOnly=g.Down();g._LeftHandedForwardReadOnly=g.Forward(!1);g._RightHandedForwardReadOnly=g.Forward(!0);g._LeftHandedBackwardReadOnly=g.Backward(!1);g._RightHandedBackwardReadOnly=g.Backward(!0);g._RightReadOnly=g.Right();g._LeftReadOnly=g.Left();g._ZeroReadOnly=g.Zero();g._OneReadOnly=g.One();class dt{constructor(e=0,t=0,i=0,n=0){this.x=e,this.y=t,this.z=i,this.w=n}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){const e=cn(this.x),t=cn(this.y),i=cn(this.z),n=cn(this.w);let r=e;return r=r*397^t,r=r*397^i,r=r*397^n,r}asArray(){const e=new Array;return this.toArray(e,0),e}toArray(e,t){return t===void 0&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}fromArray(e,t=0){return dt.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add(e){return new this.constructor(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,t}subtractFromFloats(e,t,i,n){return new this.constructor(this.x-e,this.y-t,this.z-i,this.w-n)}subtractFromFloatsToRef(e,t,i,n,r){return r.x=this.x-e,r.y=this.y-t,r.z=this.z-i,r.w=this.w-n,r}negate(){return new this.constructor(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.copyFromFloats(this.x*-1,this.y*-1,this.z*-1,this.w*-1)}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new this.constructor(this.x*e,this.y*e,this.z*e,this.w*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsWithEpsilon(e,t=lt){return e&&W.WithinEpsilon(this.x,e.x,t)&&W.WithinEpsilon(this.y,e.y,t)&&W.WithinEpsilon(this.z,e.z,t)&&W.WithinEpsilon(this.w,e.w,t)}equalsToFloats(e,t,i,n){return this.x===e&&this.y===t&&this.z===i&&this.w===n}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,t}multiplyByFloats(e,t,i,n){return new this.constructor(this.x*e,this.y*t,this.z*i,this.w*n)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){const e=this.length();return e===0?this:this.scaleInPlace(1/e)}toVector3(){return new g(this.x,this.y,this.z)}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this}set(e,t,i,n){return this.copyFromFloats(e,t,i,n)}setAll(e){return this.x=this.y=this.z=this.w=e,this}static FromArray(e,t){return t||(t=0),new dt(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}static FromFloatArrayToRef(e,t,i){return dt.FromArrayToRef(e,t,i),i}static FromFloatsToRef(e,t,i,n,r){return r.x=e,r.y=t,r.z=i,r.w=n,r}static Zero(){return new dt(0,0,0,0)}static One(){return new dt(1,1,1,1)}static Random(e=0,t=1){return new dt(W.RandomRange(e,t),W.RandomRange(e,t),W.RandomRange(e,t),W.RandomRange(e,t))}static get ZeroReadOnly(){return dt._ZeroReadOnly}static Normalize(e){const t=dt.Zero();return dt.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return t.copyFrom(e),t.normalize(),t}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(dt.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,n=e.y-t.y,r=e.z-t.z,a=e.w-t.w;return i*i+n*n+r*r+a*a}static Center(e,t){return dt.CenterToRef(e,t,dt.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}static TransformCoordinates(e,t){const i=dt.Zero();return dt.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return dt.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,n,r){const a=n.m,o=e*a[0]+t*a[4]+i*a[8]+a[12],l=e*a[1]+t*a[5]+i*a[9]+a[13],c=e*a[2]+t*a[6]+i*a[10]+a[14],u=e*a[3]+t*a[7]+i*a[11]+a[15];return r.x=o,r.y=l,r.z=c,r.w=u,r}static TransformNormal(e,t){const i=new e.constructor;return dt.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){const n=t.m,r=e.x*n[0]+e.y*n[4]+e.z*n[8],a=e.x*n[1]+e.y*n[5]+e.z*n[9],o=e.x*n[2]+e.y*n[6]+e.z*n[10];return i.x=r,i.y=a,i.z=o,i.w=e.w,i}static TransformNormalFromFloatsToRef(e,t,i,n,r,a){const o=r.m;return a.x=e*o[0]+t*o[4]+i*o[8],a.y=e*o[1]+t*o[5]+i*o[9],a.z=e*o[2]+t*o[6]+i*o[10],a.w=n,a}static FromVector3(e,t=0){return new dt(e._x,e._y,e._z,t)}}dt._ZeroReadOnly=dt.Zero();class ee{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,i=0,n=1){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=n}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){const e=cn(this._x),t=cn(this._y),i=cn(this._z),n=cn(this._w);let r=e;return r=r*397^t,r=r*397^i,r=r*397^n,r}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=lt){return e&&W.WithinEpsilon(this._x,e._x,t)&&W.WithinEpsilon(this._y,e._y,t)&&W.WithinEpsilon(this._z,e._z,t)&&W.WithinEpsilon(this._w,e._w,t)}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,t,i,n){return this._x=e,this._y=t,this._z=i,this._w=n,this._isDirty=!0,this}set(e,t,i,n){return this.copyFromFloats(e,t,i,n)}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=!0,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=!0,t}multiply(e){const t=new this.constructor(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){const i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,n=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,r=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,a=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,n,r,a),t}multiplyInPlace(e){return this.multiplyToRef(e,this),this}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new this.constructor(-this._x,-this._y,-this._z,this._w)}invert(){const e=this.conjugate(),t=this.lengthSquared();return t==0||t==1||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();const e=this.lengthSquared();return e==0||e==1?this:(this.scaleInPlace(1/e),this)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){const e=this.length();if(e===0)return this;const t=1/e;return this.scaleInPlace(t),this}normalizeToNew(){const e=this.length();if(e===0)return this.clone();const t=1/e;return this.scale(t)}toEulerAngles(){const e=g.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){const t=this._z,i=this._x,n=this._y,r=this._w,a=n*t-i*r,o=.4999999;if(a<-o)e._y=2*Math.atan2(n,r),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(a>o)e._y=2*Math.atan2(n,r),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{const l=r*r,c=t*t,u=i*i,h=n*n;e._z=Math.atan2(2*(i*n+t*r),-c-u+h+l),e._x=Math.asin(-2*a),e._y=Math.atan2(2*(t*i+n*r),c-u-h+l),e._isDirty=!0}return e}toRotationMatrix(e){return D.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return ee.FromRotationMatrixToRef(e,this),this}static FromRotationMatrix(e){const t=new ee;return ee.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){const i=e.m,n=i[0],r=i[4],a=i[8],o=i[1],l=i[5],c=i[9],u=i[2],h=i[6],d=i[10],f=n+l+d;let p;return f>0?(p=.5/Math.sqrt(f+1),t._w=.25/p,t._x=(h-c)*p,t._y=(a-u)*p,t._z=(o-r)*p,t._isDirty=!0):n>l&&n>d?(p=2*Math.sqrt(1+n-l-d),t._w=(h-c)/p,t._x=.25*p,t._y=(r+o)/p,t._z=(a+u)/p,t._isDirty=!0):l>d?(p=2*Math.sqrt(1+l-n-d),t._w=(a-u)/p,t._x=(r+o)/p,t._y=.25*p,t._z=(c+h)/p,t._isDirty=!0):(p=2*Math.sqrt(1+d-n-l),t._w=(o-r)/p,t._x=(a+u)/p,t._y=(c+h)/p,t._z=.25*p,t._isDirty=!0),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,i=.1){const n=ee.Dot(e,t);return 1-n*n<=i}static SmoothToRef(e,t,i,n,r){let a=n===0?1:i/n;return a=W.Clamp(a,0,1),ee.SlerpToRef(e,t,a,r),r}static Zero(){return new ee(0,0,0,0)}static Inverse(e){return new e.constructor(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new ee(0,0,0,1)}static IsIdentity(e){return e&&e._x===0&&e._y===0&&e._z===0&&e._w===1}static RotationAxis(e,t){return ee.RotationAxisToRef(e,t,new ee)}static RotationAxisToRef(e,t,i){const n=Math.sin(t/2);return e.normalize(),i._w=Math.cos(t/2),i._x=e._x*n,i._y=e._y*n,i._z=e._z*n,i._isDirty=!0,i}static FromArray(e,t){return t||(t=0),new ee(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._w=e[t+3],i._isDirty=!0,i}static FromEulerAngles(e,t,i){const n=new ee;return ee.RotationYawPitchRollToRef(t,e,i,n),n}static FromEulerAnglesToRef(e,t,i,n){return ee.RotationYawPitchRollToRef(t,e,i,n),n}static FromEulerVector(e){const t=new ee;return ee.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return ee.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,i,n=lt){const r=g.Dot(e,t)+1;return r<n?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(g.CrossToRef(e,t,w.Vector3[0]),i.set(w.Vector3[0].x,w.Vector3[0].y,w.Vector3[0].z,r)),i.normalize()}static RotationYawPitchRoll(e,t,i){const n=new ee;return ee.RotationYawPitchRollToRef(e,t,i,n),n}static RotationYawPitchRollToRef(e,t,i,n){const r=i*.5,a=t*.5,o=e*.5,l=Math.sin(r),c=Math.cos(r),u=Math.sin(a),h=Math.cos(a),d=Math.sin(o),f=Math.cos(o);return n._x=f*u*c+d*h*l,n._y=d*h*c-f*u*l,n._z=f*h*l-d*u*c,n._w=f*h*c+d*u*l,n._isDirty=!0,n}static RotationAlphaBetaGamma(e,t,i){const n=new ee;return ee.RotationAlphaBetaGammaToRef(e,t,i,n),n}static RotationAlphaBetaGammaToRef(e,t,i,n){const r=(i+e)*.5,a=(i-e)*.5,o=t*.5;return n._x=Math.cos(a)*Math.sin(o),n._y=Math.sin(a)*Math.sin(o),n._z=Math.sin(r)*Math.cos(o),n._w=Math.cos(r)*Math.cos(o),n._isDirty=!0,n}static RotationQuaternionFromAxis(e,t,i){const n=new ee(0,0,0,0);return ee.RotationQuaternionFromAxisToRef(e,t,i,n),n}static RotationQuaternionFromAxisToRef(e,t,i,n){const r=Se.Matrix[0];return D.FromXYZAxesToRef(e.normalize(),t.normalize(),i.normalize(),r),ee.FromRotationMatrixToRef(r,n),n}static FromLookDirectionLH(e,t){const i=new ee;return ee.FromLookDirectionLHToRef(e,t,i),i}static FromLookDirectionLHToRef(e,t,i){const n=Se.Matrix[0];return D.LookDirectionLHToRef(e,t,n),ee.FromRotationMatrixToRef(n,i),i}static FromLookDirectionRH(e,t){const i=new ee;return ee.FromLookDirectionRHToRef(e,t,i),i}static FromLookDirectionRHToRef(e,t,i){const n=Se.Matrix[0];return D.LookDirectionRHToRef(e,t,n),ee.FromRotationMatrixToRef(n,i)}static Slerp(e,t,i){const n=ee.Identity();return ee.SlerpToRef(e,t,i,n),n}static SlerpToRef(e,t,i,n){let r,a,o=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,l=!1;if(o<0&&(l=!0,o=-o),o>.999999)a=1-i,r=l?-i:i;else{const c=Math.acos(o),u=1/Math.sin(c);a=Math.sin((1-i)*c)*u,r=l?-Math.sin(i*c)*u:Math.sin(i*c)*u}return n._x=a*e._x+r*t._x,n._y=a*e._y+r*t._y,n._z=a*e._z+r*t._z,n._w=a*e._w+r*t._w,n._isDirty=!0,n}static Hermite(e,t,i,n,r){const a=r*r,o=r*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+r,h=o-a,d=e._x*l+i._x*c+t._x*u+n._x*h,f=e._y*l+i._y*c+t._y*u+n._y*h,p=e._z*l+i._z*c+t._z*u+n._z*h,m=e._w*l+i._w*c+t._w*u+n._w*h;return new e.constructor(d,f,p,m)}static Hermite1stDerivative(e,t,i,n,r){const a=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,n,r,a),a}static Hermite1stDerivativeToRef(e,t,i,n,r,a){const o=r*r;return a._x=(o-r)*6*e._x+(3*o-4*r+1)*t._x+(-o+r)*6*i._x+(3*o-2*r)*n._x,a._y=(o-r)*6*e._y+(3*o-4*r+1)*t._y+(-o+r)*6*i._y+(3*o-2*r)*n._y,a._z=(o-r)*6*e._z+(3*o-4*r+1)*t._z+(-o+r)*6*i._z+(3*o-2*r)*n._z,a._w=(o-r)*6*e._w+(3*o-4*r+1)*t._w+(-o+r)*6*i._w+(3*o-2*r)*n._w,a._isDirty=!0,a}}class D{static get Use64Bits(){return fi.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=D._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,i=!1,n=!0){this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=this._isIdentity?!1:t,this._isIdentity3x2Dirty=this._isIdentity3x2?!1:n}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,fi.MatrixTrackPrecisionChange&&fi.MatrixTrackedMatrices.push(this),this._m=new fi.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;const e=this._m;this._isIdentity=e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._m[0]!==1||this._m[5]!==1||this._m[15]!==1?this._isIdentity3x2=!1:this._m[1]!==0||this._m[2]!==0||this._m[3]!==0||this._m[4]!==0||this._m[6]!==0||this._m[7]!==0||this._m[8]!==0||this._m[9]!==0||this._m[10]!==0||this._m[11]!==0||this._m[12]!==0||this._m[13]!==0||this._m[14]!==0?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(this._isIdentity===!0)return 1;const e=this._m,t=e[0],i=e[1],n=e[2],r=e[3],a=e[4],o=e[5],l=e[6],c=e[7],u=e[8],h=e[9],d=e[10],f=e[11],p=e[12],m=e[13],_=e[14],E=e[15],v=d*E-_*f,y=h*E-m*f,A=h*_-m*d,I=u*E-p*f,T=u*_-d*p,R=u*m-p*h,x=+(o*v-l*y+c*A),F=-(a*v-l*I+c*T),L=+(a*y-o*I+c*R),V=-(a*A-o*T+l*R);return t*x+i*F+n*L+r*V}toArray(){return this._m}asArray(){return this._m}invert(){return this.invertToRef(this),this}reset(){return D.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){const t=new this.constructor;return this.addToRef(e,t),t}addToRef(e,t){const i=this._m,n=t._m,r=e.m;for(let a=0;a<16;a++)n[a]=i[a]+r[a];return t.markAsUpdated(),t}addToSelf(e){const t=this._m,i=e.m;for(let n=0;n<16;n++)t[n]+=i[n];return this.markAsUpdated(),this}invertToRef(e){if(this._isIdentity===!0)return D.IdentityToRef(e),e;const t=this._m,i=t[0],n=t[1],r=t[2],a=t[3],o=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=t[9],f=t[10],p=t[11],m=t[12],_=t[13],E=t[14],v=t[15],y=f*v-E*p,A=d*v-_*p,I=d*E-_*f,T=h*v-m*p,R=h*E-f*m,x=h*_-m*d,F=+(l*y-c*A+u*I),L=-(o*y-c*T+u*R),V=+(o*A-l*T+u*x),Z=-(o*I-l*R+c*x),ne=i*F+n*L+r*V+a*Z;if(ne===0)return e.copyFrom(this),e;const ae=1/ne,Ue=c*v-E*u,Ve=l*v-_*u,$e=l*E-_*c,re=o*v-m*u,ge=o*E-m*c,be=o*_-m*l,ze=c*p-f*u,Ke=l*p-d*u,Ut=l*f-d*c,st=o*p-h*u,Jt=o*f-h*c,Wt=o*d-h*l,ii=-(n*y-r*A+a*I),$i=+(i*y-r*T+a*R),Ji=-(i*A-n*T+a*x),en=+(i*I-n*R+r*x),vn=+(n*Ue-r*Ve+a*$e),Ne=-(i*Ue-r*re+a*ge),Xe=+(i*Ve-n*re+a*be),_i=-(i*$e-n*ge+r*be),yt=-(n*ze-r*Ke+a*Ut),Ge=+(i*ze-r*st+a*Jt),yn=-(i*Ke-n*st+a*Wt),Vt=+(i*Ut-n*Jt+r*Wt);return D.FromValuesToRef(F*ae,ii*ae,vn*ae,yt*ae,L*ae,$i*ae,Ne*ae,Ge*ae,V*ae,Ji*ae,Xe*ae,yn*ae,Z*ae,en*ae,_i*ae,Vt*ae,e),e}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new g(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){const e=this.m;return D.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1),this}multiply(e){const t=new this.constructor;return this.multiplyToRef(e,t),t}copyFrom(e){e.copyToArray(this._m);const t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){const i=this._m;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],this}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,i){const n=this._m,r=e.m,a=n[0],o=n[1],l=n[2],c=n[3],u=n[4],h=n[5],d=n[6],f=n[7],p=n[8],m=n[9],_=n[10],E=n[11],v=n[12],y=n[13],A=n[14],I=n[15],T=r[0],R=r[1],x=r[2],F=r[3],L=r[4],V=r[5],Z=r[6],ne=r[7],ae=r[8],Ue=r[9],Ve=r[10],$e=r[11],re=r[12],ge=r[13],be=r[14],ze=r[15];return t[i]=a*T+o*L+l*ae+c*re,t[i+1]=a*R+o*V+l*Ue+c*ge,t[i+2]=a*x+o*Z+l*Ve+c*be,t[i+3]=a*F+o*ne+l*$e+c*ze,t[i+4]=u*T+h*L+d*ae+f*re,t[i+5]=u*R+h*V+d*Ue+f*ge,t[i+6]=u*x+h*Z+d*Ve+f*be,t[i+7]=u*F+h*ne+d*$e+f*ze,t[i+8]=p*T+m*L+_*ae+E*re,t[i+9]=p*R+m*V+_*Ue+E*ge,t[i+10]=p*x+m*Z+_*Ve+E*be,t[i+11]=p*F+m*ne+_*$e+E*ze,t[i+12]=v*T+y*L+A*ae+I*re,t[i+13]=v*R+y*V+A*Ue+I*ge,t[i+14]=v*x+y*Z+A*Ve+I*be,t[i+15]=v*F+y*ne+A*$e+I*ze,this}equals(e){const t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;const i=this.m,n=t.m;return i[0]===n[0]&&i[1]===n[1]&&i[2]===n[2]&&i[3]===n[3]&&i[4]===n[4]&&i[5]===n[5]&&i[6]===n[6]&&i[7]===n[7]&&i[8]===n[8]&&i[9]===n[9]&&i[10]===n[10]&&i[11]===n[11]&&i[12]===n[12]&&i[13]===n[13]&&i[14]===n[14]&&i[15]===n[15]}clone(){const e=new this.constructor;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=cn(this._m[0]);for(let t=1;t<16;t++)e=e*397^cn(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new ee,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,i,n){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;const r=this._m;if(i&&i.copyFromFloats(r[12],r[13],r[14]),e=e||Se.Vector3[0],e.x=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),e.y=Math.sqrt(r[4]*r[4]+r[5]*r[5]+r[6]*r[6]),e.z=Math.sqrt(r[8]*r[8]+r[9]*r[9]+r[10]*r[10]),n){const a=n.scaling.x<0?-1:1,o=n.scaling.y<0?-1:1,l=n.scaling.z<0?-1:1;e.x*=a,e.y*=o,e.z*=l}else this.determinant()<=0&&(e.y*=-1);if(e._x===0||e._y===0||e._z===0)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){const a=1/e._x,o=1/e._y,l=1/e._z;D.FromValuesToRef(r[0]*a,r[1]*a,r[2]*a,0,r[4]*o,r[5]*o,r[6]*o,0,r[8]*l,r[9]*l,r[10]*l,0,0,0,0,1,Se.Matrix[0]),ee.FromRotationMatrixToRef(Se.Matrix[0],t)}return!0}getRow(e){if(e<0||e>3)return null;const t=e*4;return new dt(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<3){const i=e*4;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3]}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){const e=new this.constructor;return D.TransposeToRef(this,e),e}transposeToRef(e){return D.TransposeToRef(this,e),e}setRowFromFloats(e,t,i,n,r){if(e<0||e>3)return this;const a=e*4;return this._m[a+0]=t,this._m[a+1]=i,this._m[a+2]=n,this._m[a+3]=r,this.markAsUpdated(),this}scale(e){const t=new this.constructor;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),t}toNormalMatrix(e){const t=Se.Matrix[0];this.invertToRef(t),t.transposeToRef(e);const i=e._m;return D.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e),e}getRotationMatrix(){const e=new this.constructor;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){const t=Se.Vector3[0];if(!this.decompose(t))return D.IdentityToRef(e),e;const i=this._m,n=1/t._x,r=1/t._y,a=1/t._z;return D.FromValuesToRef(i[0]*n,i[1]*n,i[2]*n,0,i[4]*r,i[5]*r,i[6]*r,0,i[8]*a,i[9]*a,i[10]*a,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){const e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){const e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,t=0){const i=new D;return D.FromArrayToRef(e,t,i),i}static FromArrayToRef(e,t,i){for(let n=0;n<16;n++)i._m[n]=e[n+t];return i.markAsUpdated(),i}static FromFloat32ArrayToRefScaled(e,t,i,n){for(let r=0;r<16;r++)n._m[r]=e[r+t]*i;return n.markAsUpdated(),n}static get IdentityReadOnly(){return D._IdentityReadOnly}static FromValuesToRef(e,t,i,n,r,a,o,l,c,u,h,d,f,p,m,_,E){const v=E._m;v[0]=e,v[1]=t,v[2]=i,v[3]=n,v[4]=r,v[5]=a,v[6]=o,v[7]=l,v[8]=c,v[9]=u,v[10]=h,v[11]=d,v[12]=f,v[13]=p,v[14]=m,v[15]=_,E.markAsUpdated()}static FromValues(e,t,i,n,r,a,o,l,c,u,h,d,f,p,m,_){const E=new D,v=E._m;return v[0]=e,v[1]=t,v[2]=i,v[3]=n,v[4]=r,v[5]=a,v[6]=o,v[7]=l,v[8]=c,v[9]=u,v[10]=h,v[11]=d,v[12]=f,v[13]=p,v[14]=m,v[15]=_,E.markAsUpdated(),E}static Compose(e,t,i){const n=new D;return D.ComposeToRef(e,t,i,n),n}static ComposeToRef(e,t,i,n){const r=n._m,a=t._x,o=t._y,l=t._z,c=t._w,u=a+a,h=o+o,d=l+l,f=a*u,p=a*h,m=a*d,_=o*h,E=o*d,v=l*d,y=c*u,A=c*h,I=c*d,T=e._x,R=e._y,x=e._z;return r[0]=(1-(_+v))*T,r[1]=(p+I)*T,r[2]=(m-A)*T,r[3]=0,r[4]=(p-I)*R,r[5]=(1-(f+v))*R,r[6]=(E+y)*R,r[7]=0,r[8]=(m+A)*x,r[9]=(E-y)*x,r[10]=(1-(f+_))*x,r[11]=0,r[12]=i._x,r[13]=i._y,r[14]=i._z,r[15]=1,n.markAsUpdated(),n}static Identity(){const e=D.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){return D.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0),e}static Zero(){const e=D.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){const t=new D;return D.RotationXToRef(e,t),t}static Invert(e){const t=new e.constructor;return e.invertToRef(t),t}static RotationXToRef(e,t){const i=Math.sin(e),n=Math.cos(e);return D.FromValuesToRef(1,0,0,0,0,n,i,0,0,-i,n,0,0,0,0,1,t),t._updateIdentityStatus(n===1&&i===0),t}static RotationY(e){const t=new D;return D.RotationYToRef(e,t),t}static RotationYToRef(e,t){const i=Math.sin(e),n=Math.cos(e);return D.FromValuesToRef(n,0,-i,0,0,1,0,0,i,0,n,0,0,0,0,1,t),t._updateIdentityStatus(n===1&&i===0),t}static RotationZ(e){const t=new D;return D.RotationZToRef(e,t),t}static RotationZToRef(e,t){const i=Math.sin(e),n=Math.cos(e);return D.FromValuesToRef(n,i,0,0,-i,n,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(n===1&&i===0),t}static RotationAxis(e,t){const i=new D;return D.RotationAxisToRef(e,t,i),i}static RotationAxisToRef(e,t,i){const n=Math.sin(-t),r=Math.cos(-t),a=1-r;e.normalize();const o=i._m;return o[0]=e._x*e._x*a+r,o[1]=e._x*e._y*a-e._z*n,o[2]=e._x*e._z*a+e._y*n,o[3]=0,o[4]=e._y*e._x*a+e._z*n,o[5]=e._y*e._y*a+r,o[6]=e._y*e._z*a-e._x*n,o[7]=0,o[8]=e._z*e._x*a-e._y*n,o[9]=e._z*e._y*a+e._x*n,o[10]=e._z*e._z*a+r,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,i.markAsUpdated(),i}static RotationAlignToRef(e,t,i){const n=g.Dot(t,e),r=i._m;if(n<-1+lt)r[0]=-1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0;else{const a=g.Cross(t,e),o=1/(1+n);r[0]=a._x*a._x*o+n,r[1]=a._y*a._x*o-a._z,r[2]=a._z*a._x*o+a._y,r[3]=0,r[4]=a._x*a._y*o+a._z,r[5]=a._y*a._y*o+n,r[6]=a._z*a._y*o-a._x,r[7]=0,r[8]=a._x*a._z*o-a._y,r[9]=a._y*a._z*o+a._x,r[10]=a._z*a._z*o+n,r[11]=0}return r[12]=0,r[13]=0,r[14]=0,r[15]=1,i.markAsUpdated(),i}static RotationYawPitchRoll(e,t,i){const n=new D;return D.RotationYawPitchRollToRef(e,t,i,n),n}static RotationYawPitchRollToRef(e,t,i,n){return ee.RotationYawPitchRollToRef(e,t,i,Se.Quaternion[0]),Se.Quaternion[0].toRotationMatrix(n),n}static Scaling(e,t,i){const n=new D;return D.ScalingToRef(e,t,i,n),n}static ScalingToRef(e,t,i,n){return D.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,n),n._updateIdentityStatus(e===1&&t===1&&i===1),n}static Translation(e,t,i){const n=new D;return D.TranslationToRef(e,t,i,n),n}static TranslationToRef(e,t,i,n){return D.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,n),n._updateIdentityStatus(e===0&&t===0&&i===0),n}static Lerp(e,t,i){const n=new e.constructor;return D.LerpToRef(e,t,i,n),n}static LerpToRef(e,t,i,n){const r=n._m,a=e.m,o=t.m;for(let l=0;l<16;l++)r[l]=a[l]*(1-i)+o[l]*i;return n.markAsUpdated(),n}static DecomposeLerp(e,t,i){const n=new e.constructor;return D.DecomposeLerpToRef(e,t,i,n),n}static DecomposeLerpToRef(e,t,i,n){const r=Se.Vector3[0],a=Se.Quaternion[0],o=Se.Vector3[1];e.decompose(r,a,o);const l=Se.Vector3[2],c=Se.Quaternion[1],u=Se.Vector3[3];t.decompose(l,c,u);const h=Se.Vector3[4];g.LerpToRef(r,l,i,h);const d=Se.Quaternion[2];ee.SlerpToRef(a,c,i,d);const f=Se.Vector3[5];return g.LerpToRef(o,u,i,f),D.ComposeToRef(h,d,f,n),n}static LookAtLH(e,t,i){const n=new D;return D.LookAtLHToRef(e,t,i,n),n}static LookAtLHToRef(e,t,i,n){const r=Se.Vector3[0],a=Se.Vector3[1],o=Se.Vector3[2];t.subtractToRef(e,o),o.normalize(),g.CrossToRef(i,o,r);const l=r.lengthSquared();l===0?r.x=1:r.normalizeFromLength(Math.sqrt(l)),g.CrossToRef(o,r,a),a.normalize();const c=-g.Dot(r,e),u=-g.Dot(a,e),h=-g.Dot(o,e);D.FromValuesToRef(r._x,a._x,o._x,0,r._y,a._y,o._y,0,r._z,a._z,o._z,0,c,u,h,1,n)}static LookAtRH(e,t,i){const n=new D;return D.LookAtRHToRef(e,t,i,n),n}static LookAtRHToRef(e,t,i,n){const r=Se.Vector3[0],a=Se.Vector3[1],o=Se.Vector3[2];e.subtractToRef(t,o),o.normalize(),g.CrossToRef(i,o,r);const l=r.lengthSquared();l===0?r.x=1:r.normalizeFromLength(Math.sqrt(l)),g.CrossToRef(o,r,a),a.normalize();const c=-g.Dot(r,e),u=-g.Dot(a,e),h=-g.Dot(o,e);return D.FromValuesToRef(r._x,a._x,o._x,0,r._y,a._y,o._y,0,r._z,a._z,o._z,0,c,u,h,1,n),n}static LookDirectionLH(e,t){const i=new D;return D.LookDirectionLHToRef(e,t,i),i}static LookDirectionLHToRef(e,t,i){const n=Se.Vector3[0];n.copyFrom(e),n.scaleInPlace(-1);const r=Se.Vector3[1];return g.CrossToRef(t,n,r),D.FromValuesToRef(r._x,r._y,r._z,0,t._x,t._y,t._z,0,n._x,n._y,n._z,0,0,0,0,1,i),i}static LookDirectionRH(e,t){const i=new D;return D.LookDirectionRHToRef(e,t,i),i}static LookDirectionRHToRef(e,t,i){const n=Se.Vector3[2];return g.CrossToRef(t,e,n),D.FromValuesToRef(n._x,n._y,n._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i),i}static OrthoLH(e,t,i,n,r){const a=new D;return D.OrthoLHToRef(e,t,i,n,a,r),a}static OrthoLHToRef(e,t,i,n,r,a){const o=i,l=n,c=2/e,u=2/t,h=2/(l-o),d=-(l+o)/(l-o);return D.FromValuesToRef(c,0,0,0,0,u,0,0,0,0,h,0,0,0,d,1,r),a&&r.multiplyToRef(mr,r),r._updateIdentityStatus(c===1&&u===1&&h===1&&d===0),r}static OrthoOffCenterLH(e,t,i,n,r,a,o){const l=new D;return D.OrthoOffCenterLHToRef(e,t,i,n,r,a,l,o),l}static OrthoOffCenterLHToRef(e,t,i,n,r,a,o,l){const c=r,u=a,h=2/(t-e),d=2/(n-i),f=2/(u-c),p=-(u+c)/(u-c),m=(e+t)/(e-t),_=(n+i)/(i-n);return D.FromValuesToRef(h,0,0,0,0,d,0,0,0,0,f,0,m,_,p,1,o),l&&o.multiplyToRef(mr,o),o.markAsUpdated(),o}static OrthoOffCenterRH(e,t,i,n,r,a,o){const l=new D;return D.OrthoOffCenterRHToRef(e,t,i,n,r,a,l,o),l}static OrthoOffCenterRHToRef(e,t,i,n,r,a,o,l){return D.OrthoOffCenterLHToRef(e,t,i,n,r,a,o,l),o._m[10]*=-1,o}static PerspectiveLH(e,t,i,n,r,a=0){const o=new D,l=i,c=n,u=2*l/e,h=2*l/t,d=(c+l)/(c-l),f=-2*c*l/(c-l),p=Math.tan(a);return D.FromValuesToRef(u,0,0,0,0,h,0,p,0,0,d,1,0,0,f,0,o),r&&o.multiplyToRef(mr,o),o._updateIdentityStatus(!1),o}static PerspectiveFovLH(e,t,i,n,r,a=0,o=!1){const l=new D;return D.PerspectiveFovLHToRef(e,t,i,n,l,!0,r,a,o),l}static PerspectiveFovLHToRef(e,t,i,n,r,a=!0,o,l=0,c=!1){const u=i,h=n,d=1/Math.tan(e*.5),f=a?d/t:d,p=a?d:d*t,m=c&&u===0?-1:h!==0?(h+u)/(h-u):1,_=c&&u===0?2*h:h!==0?-2*h*u/(h-u):-2*u,E=Math.tan(l);return D.FromValuesToRef(f,0,0,0,0,p,0,E,0,0,m,1,0,0,_,0,r),o&&r.multiplyToRef(mr,r),r._updateIdentityStatus(!1),r}static PerspectiveFovReverseLHToRef(e,t,i,n,r,a=!0,o,l=0){const c=1/Math.tan(e*.5),u=a?c/t:c,h=a?c:c*t,d=Math.tan(l);return D.FromValuesToRef(u,0,0,0,0,h,0,d,0,0,-i,1,0,0,1,0,r),o&&r.multiplyToRef(mr,r),r._updateIdentityStatus(!1),r}static PerspectiveFovRH(e,t,i,n,r,a=0,o=!1){const l=new D;return D.PerspectiveFovRHToRef(e,t,i,n,l,!0,r,a,o),l}static PerspectiveFovRHToRef(e,t,i,n,r,a=!0,o,l=0,c=!1){const u=i,h=n,d=1/Math.tan(e*.5),f=a?d/t:d,p=a?d:d*t,m=c&&u===0?1:h!==0?-(h+u)/(h-u):-1,_=c&&u===0?2*h:h!==0?-2*h*u/(h-u):-2*u,E=Math.tan(l);return D.FromValuesToRef(f,0,0,0,0,p,0,E,0,0,m,-1,0,0,_,0,r),o&&r.multiplyToRef(mr,r),r._updateIdentityStatus(!1),r}static PerspectiveFovReverseRHToRef(e,t,i,n,r,a=!0,o,l=0){const c=1/Math.tan(e*.5),u=a?c/t:c,h=a?c:c*t,d=Math.tan(l);return D.FromValuesToRef(u,0,0,0,0,h,0,d,0,0,-i,-1,0,0,-1,0,r),o&&r.multiplyToRef(mr,r),r._updateIdentityStatus(!1),r}static PerspectiveFovWebVRToRef(e,t,i,n,r=!1,a,o=0){const l=r?-1:1,c=Math.tan(e.upDegrees*Math.PI/180),u=Math.tan(e.downDegrees*Math.PI/180),h=Math.tan(e.leftDegrees*Math.PI/180),d=Math.tan(e.rightDegrees*Math.PI/180),f=2/(h+d),p=2/(c+u),m=Math.tan(o),_=n._m;return _[0]=f,_[1]=_[2]=_[3]=_[4]=0,_[5]=p,_[6]=0,_[7]=m,_[8]=(h-d)*f*.5,_[9]=-((c-u)*p*.5),_[10]=-i/(t-i),_[11]=1*l,_[12]=_[13]=_[15]=0,_[14]=-(2*i*t)/(i-t),a&&n.multiplyToRef(mr,n),n.markAsUpdated(),n}static GetFinalMatrix(e,t,i,n,r,a){const o=e.width,l=e.height,c=e.x,u=e.y,h=D.FromValues(o/2,0,0,0,0,-l/2,0,0,0,0,a-r,0,c+o/2,l/2+u,r,1),d=new t.constructor;return t.multiplyToRef(i,d),d.multiplyToRef(n,d),d.multiplyToRef(h,d)}static GetAsMatrix2x2(e){const t=e.m,i=[t[0],t[1],t[4],t[5]];return fi.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(e){const t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return fi.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(e){const t=new e.constructor;return D.TransposeToRef(e,t),t}static TransposeToRef(e,t){const i=t._m,n=e.m;return i[0]=n[0],i[1]=n[4],i[2]=n[8],i[3]=n[12],i[4]=n[1],i[5]=n[5],i[6]=n[9],i[7]=n[13],i[8]=n[2],i[9]=n[6],i[10]=n[10],i[11]=n[14],i[12]=n[3],i[13]=n[7],i[14]=n[11],i[15]=n[15],t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(e){const t=new D;return D.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();const i=e.normal.x,n=e.normal.y,r=e.normal.z,a=-2*i,o=-2*n,l=-2*r;return D.FromValuesToRef(a*i+1,o*i,l*i,0,a*n,o*n+1,l*n,0,a*r,o*r,l*r+1,0,a*e.d,o*e.d,l*e.d,1,t),t}static FromXYZAxesToRef(e,t,i,n){return D.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,n),n}static FromQuaternionToRef(e,t){const i=e._x*e._x,n=e._y*e._y,r=e._z*e._z,a=e._x*e._y,o=e._z*e._w,l=e._z*e._x,c=e._y*e._w,u=e._y*e._z,h=e._x*e._w;return t._m[0]=1-2*(n+r),t._m[1]=2*(a+o),t._m[2]=2*(l-c),t._m[3]=0,t._m[4]=2*(a-o),t._m[5]=1-2*(r+i),t._m[6]=2*(u+h),t._m[7]=0,t._m[8]=2*(l+c),t._m[9]=2*(u-h),t._m[10]=1-2*(n+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}}D._UpdateFlagSeed=0;D._IdentityReadOnly=D.Identity();class Se{}Se.Vector3=mi.BuildTuple(11,g.Zero);Se.Matrix=mi.BuildTuple(2,D.Identity);Se.Quaternion=mi.BuildTuple(3,ee.Zero);class w{}w.Vector2=mi.BuildTuple(3,j.Zero);w.Vector3=mi.BuildTuple(13,g.Zero);w.Vector4=mi.BuildTuple(3,dt.Zero);w.Quaternion=mi.BuildTuple(2,ee.Zero);w.Matrix=mi.BuildTuple(8,D.Identity);Rt("BABYLON.Vector2",j);Rt("BABYLON.Vector3",g);Rt("BABYLON.Vector4",dt);Rt("BABYLON.Matrix",D);const mr=D.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);function io(s){return Math.pow(s,Yc)}function no(s){return s<=.04045?.0773993808*s:Math.pow(.947867299*(s+.055),2.4)}function so(s){return Math.pow(s,Xc)}function ro(s){return s<=.0031308?12.92*s:1.055*Math.pow(s,.41666)-.055}class G{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return G.FromArrayToRef(e,t,this),this}toColor4(e=1){return new pe(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return this.r*.3+this.g*.59+this.b*.11}multiply(e){return new G(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}scale(e){return new G(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,this}clampToRef(e=0,t=1,i){return i.r=W.Clamp(this.r,e,t),i.g=W.Clamp(this.g,e,t),i.b=W.Clamp(this.b,e,t),this}add(e){return new G(this.r+e.r,this.g+e.g,this.b+e.b)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,this}subtract(e){return new G(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,this}clone(){return new G(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}toHexString(){const e=Math.round(this.r*255),t=Math.round(this.g*255),i=Math.round(this.b*255);return"#"+W.ToHex(e)+W.ToHex(t)+W.ToHex(i)}toHSV(){const e=new G;return this.toHSVToRef(e),e}toHSVToRef(e){const t=this.r,i=this.g,n=this.b,r=Math.max(t,i,n),a=Math.min(t,i,n);let o=0,l=0;const c=r,u=r-a;r!==0&&(l=u/r),r!=a&&(r==t?(o=(i-n)/u,i<n&&(o+=6)):r==i?o=(n-t)/u+2:r==n&&(o=(t-i)/u+4),o*=60),e.r=o,e.g=l,e.b=c}toLinearSpace(e=!1){const t=new G;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=no(this.r),e.g=no(this.g),e.b=no(this.b)):(e.r=io(this.r),e.g=io(this.g),e.b=io(this.b)),this}toGammaSpace(e=!1){const t=new G;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=ro(this.r),e.g=ro(this.g),e.b=ro(this.b)):(e.r=so(this.r),e.g=so(this.g),e.b=so(this.b)),this}static HSVtoRGBToRef(e,t,i,n){const r=i*t,a=e/60,o=r*(1-Math.abs(a%2-1));let l=0,c=0,u=0;a>=0&&a<=1?(l=r,c=o):a>=1&&a<=2?(l=o,c=r):a>=2&&a<=3?(c=r,u=o):a>=3&&a<=4?(c=o,u=r):a>=4&&a<=5?(l=o,u=r):a>=5&&a<=6&&(l=r,u=o);const h=i-r;n.set(l+h,c+h,u+h)}static FromHSV(e,t,i){const n=new G(0,0,0);return G.HSVtoRGBToRef(e,t,i,n),n}static FromHexString(e){if(e.substring(0,1)!=="#"||e.length!==7)return new G(0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),n=parseInt(e.substring(5,7),16);return G.FromInts(t,i,n)}static FromArray(e,t=0){return new G(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2]}static FromInts(e,t,i){return new G(e/255,t/255,i/255)}static Lerp(e,t,i){const n=new G(0,0,0);return G.LerpToRef(e,t,i,n),n}static LerpToRef(e,t,i,n){n.r=e.r+(t.r-e.r)*i,n.g=e.g+(t.g-e.g)*i,n.b=e.b+(t.b-e.b)*i}static Hermite(e,t,i,n,r){const a=r*r,o=r*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+r,h=o-a,d=e.r*l+i.r*c+t.r*u+n.r*h,f=e.g*l+i.g*c+t.g*u+n.g*h,p=e.b*l+i.b*c+t.b*u+n.b*h;return new G(d,f,p)}static Hermite1stDerivative(e,t,i,n,r){const a=G.Black();return this.Hermite1stDerivativeToRef(e,t,i,n,r,a),a}static Hermite1stDerivativeToRef(e,t,i,n,r,a){const o=r*r;a.r=(o-r)*6*e.r+(3*o-4*r+1)*t.r+(-o+r)*6*i.r+(3*o-2*r)*n.r,a.g=(o-r)*6*e.g+(3*o-4*r+1)*t.g+(-o+r)*6*i.g+(3*o-2*r)*n.g,a.b=(o-r)*6*e.b+(3*o-4*r+1)*t.b+(-o+r)*6*i.b+(3*o-2*r)*n.b}static Red(){return new G(1,0,0)}static Green(){return new G(0,1,0)}static Blue(){return new G(0,0,1)}static Black(){return new G(0,0,0)}static get BlackReadOnly(){return G._BlackReadOnly}static White(){return new G(1,1,1)}static Purple(){return new G(.5,0,.5)}static Magenta(){return new G(1,0,1)}static Yellow(){return new G(1,1,0)}static Gray(){return new G(.5,.5,.5)}static Teal(){return new G(0,1,1)}static Random(){return new G(Math.random(),Math.random(),Math.random())}}G._BlackReadOnly=G.Black();class pe{constructor(e=0,t=0,i=0,n=1){this.r=e,this.g=t,this.b=i,this.a=n}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return pe.FromArrayToRef(e,t,this),this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new pe(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new pe(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,this}scale(e){return new pe(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,this}clampToRef(e=0,t=1,i){return i.r=W.Clamp(this.r,e,t),i.g=W.Clamp(this.g,e,t),i.b=W.Clamp(this.b,e,t),i.a=W.Clamp(this.a,e,t),this}multiply(e){return new pe(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e=e*397^(this.a*255|0),e}clone(){return new pe(this.r,this.g,this.b,this.a)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,n){return this.r=e,this.g=t,this.b=i,this.a=n,this}set(e,t,i,n){return this.copyFromFloats(e,t,i,n)}toHexString(e=!1){const t=Math.round(this.r*255),i=Math.round(this.g*255),n=Math.round(this.b*255);if(e)return"#"+W.ToHex(t)+W.ToHex(i)+W.ToHex(n);const r=Math.round(this.a*255);return"#"+W.ToHex(t)+W.ToHex(i)+W.ToHex(n)+W.ToHex(r)}toLinearSpace(e=!1){const t=new pe;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=no(this.r),e.g=no(this.g),e.b=no(this.b)):(e.r=io(this.r),e.g=io(this.g),e.b=io(this.b)),e.a=this.a,this}toGammaSpace(e=!1){const t=new pe;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=ro(this.r),e.g=ro(this.g),e.b=ro(this.b)):(e.r=so(this.r),e.g=so(this.g),e.b=so(this.b)),e.a=this.a,this}static FromHexString(e){if(e.substring(0,1)!=="#"||e.length!==9&&e.length!==7)return new pe(0,0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),n=parseInt(e.substring(5,7),16),r=e.length===9?parseInt(e.substring(7,9),16):255;return pe.FromInts(t,i,n,r)}static Lerp(e,t,i){const n=new pe(0,0,0,0);return pe.LerpToRef(e,t,i,n),n}static LerpToRef(e,t,i,n){n.r=e.r+(t.r-e.r)*i,n.g=e.g+(t.g-e.g)*i,n.b=e.b+(t.b-e.b)*i,n.a=e.a+(t.a-e.a)*i}static Hermite(e,t,i,n,r){const a=r*r,o=r*a,l=2*o-3*a+1,c=-2*o+3*a,u=o-2*a+r,h=o-a,d=e.r*l+i.r*c+t.r*u+n.r*h,f=e.g*l+i.g*c+t.g*u+n.g*h,p=e.b*l+i.b*c+t.b*u+n.b*h,m=e.a*l+i.a*c+t.a*u+n.a*h;return new pe(d,f,p,m)}static Hermite1stDerivative(e,t,i,n,r){const a=new pe;return this.Hermite1stDerivativeToRef(e,t,i,n,r,a),a}static Hermite1stDerivativeToRef(e,t,i,n,r,a){const o=r*r;a.r=(o-r)*6*e.r+(3*o-4*r+1)*t.r+(-o+r)*6*i.r+(3*o-2*r)*n.r,a.g=(o-r)*6*e.g+(3*o-4*r+1)*t.g+(-o+r)*6*i.g+(3*o-2*r)*n.g,a.b=(o-r)*6*e.b+(3*o-4*r+1)*t.b+(-o+r)*6*i.b+(3*o-2*r)*n.b,a.a=(o-r)*6*e.a+(3*o-4*r+1)*t.a+(-o+r)*6*i.a+(3*o-2*r)*n.a}static FromColor3(e,t=1){return new pe(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new pe(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}static FromInts(e,t,i,n){return new pe(e/255,t/255,i/255,n/255)}static CheckColors4(e,t){if(e.length===t*3){const i=[];for(let n=0;n<e.length;n+=3){const r=n/3*4;i[r]=e[n],i[r+1]=e[n+1],i[r+2]=e[n+2],i[r+3]=1}return i}return e}}class jn{}jn.Color3=mi.BuildArray(3,G.Black);jn.Color4=mi.BuildArray(3,()=>new pe(0,0,0,0));Rt("BABYLON.Color3",G);Rt("BABYLON.Color4",pe);function vi(){return typeof window!="undefined"}function Kc(){return typeof navigator!="undefined"}function cl(){return typeof document!="undefined"}function lE(s){let e="",t=s.firstChild;for(;t;)t.nodeType===3&&(e+=t.textContent),t=t.nextSibling;return e}class U{static _CheckLimit(e,t){let i=U._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},U._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){var i;const n=U._LogLimitOutputs[e];if(!n||!U.MessageLimitReached)return;const r=this._Levels[t];n.current===n.limit&&U[r.name](U.MessageLimitReached.replace(/%LIMIT%/g,""+n.limit).replace(/%TYPE%/g,(i=r.name)!==null&&i!==void 0?i:""))}static _AddLogEntry(e){U._LogCache=e+U._LogCache,U.OnNewCacheEntry&&U.OnNewCacheEntry(e)}static _FormatMessage(e){const t=n=>n<10?"0"+n:""+n,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){if(i!==void 0&&!U._CheckLimit(t,i))return;const n=U._FormatMessage(t),r=this._Levels[e];r.logFunc&&r.logFunc("BJS - "+n);const a=`<div style='color:${r.color}'>${n}</div><br>`;U._AddLogEntry(a),U._GenerateLimitMessage(t,e)}static get LogCache(){return U._LogCache}static ClearLogCache(){U._LogCache="",U._LogLimitOutputs={},U.errorsCount=0}static set LogLevels(e){U.Log=U._LogDisabled,U.Warn=U._LogDisabled,U.Error=U._LogDisabled,[U.MessageLogLevel,U.WarningLogLevel,U.ErrorLogLevel].forEach(t=>{if((e&t)===t){const i=this._Levels[t];U[i.name]=U._LogEnabled.bind(U,t)}})}}U.NoneLogLevel=0;U.MessageLogLevel=1;U.WarningLogLevel=2;U.ErrorLogLevel=4;U.AllLogLevel=7;U.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.";U._LogCache="";U._LogLimitOutputs={};U._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}];U.errorsCount=0;U.Log=U._LogEnabled.bind(U,U.MessageLogLevel);U.Warn=U._LogEnabled.bind(U,U.WarningLogLevel);U.Error=U._LogEnabled.bind(U,U.ErrorLogLevel);const x_=(s,e)=>!s||s.getClassName&&s.getClassName()==="Mesh"?null:s.getClassName&&(s.getClassName()==="SubMesh"||s.getClassName()==="PhysicsBody")?s.clone(e):s.clone?s.clone():Array.isArray(s)?s.slice():null;function hT(s){const e=[];do Object.getOwnPropertyNames(s).forEach(function(t){e.indexOf(t)===-1&&e.push(t)});while(s=Object.getPrototypeOf(s));return e}class On{static DeepCopy(e,t,i,n){const r=hT(e);for(const a of r){if(a[0]==="_"&&(!n||n.indexOf(a)===-1)||a.endsWith("Observable")||i&&i.indexOf(a)!==-1)continue;const o=e[a],l=typeof o;if(l!=="function")try{if(l==="object")if(o instanceof Uint8Array)t[a]=Uint8Array.from(o);else if(o instanceof Array){if(t[a]=[],o.length>0)if(typeof o[0]=="object")for(let c=0;c<o.length;c++){const u=x_(o[c],t);t[a].indexOf(u)===-1&&t[a].push(u)}else t[a]=o.slice(0)}else t[a]=x_(o,t);else t[a]=o}catch(c){U.Warn(c.message)}}}}class Mn{static get Now(){return vi()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}function De(s){return`${s} needs to be imported before as it contains a side-effect required by your code.`}function dT(){return typeof _native!="undefined"&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}class ln{constructor(){this._xhr=dT(),this._requestURL=""}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in ln.CustomRequestHeaders){const t=ln.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return ln.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,i){this._xhr.addEventListener(e,t,i)}removeEventListener(e,t,i){this._xhr.removeEventListener(e,t,i)}abort(){this._xhr.abort()}send(e){ln.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(const i of ln.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;i(this._xhr,t)}return t=t.replace("file:http:","http:"),t=t.replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}}ln.CustomRequestHeaders={};ln.CustomRequestModifiers=new Array;ln.SkipRequestModificationForBabylonCDN=!0;class ul{}ul.FilesToLoad={};class fT{static ExponentialBackoff(e=3,t=500){return(i,n,r)=>n.status!==0||r>=e||i.indexOf("file:")!==-1?-1:Math.pow(2,r)*t}}class yo extends Error{}yo._setPrototypeOf=Object.setPrototypeOf||((s,e)=>(s.__proto__=e,s));const Fr={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002};class Os extends yo{constructor(e,t,i){super(e),this.errorCode=t,this.innerError=i,this.name="RuntimeError",yo._setPrototypeOf(this,Os.prototype)}}const pT=s=>{if(typeof TextDecoder!="undefined")return new TextDecoder().decode(s);let e="";for(let t=0;t<s.byteLength;t++)e+=String.fromCharCode(s[t]);return e},Qp=s=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let t="",i,n,r,a,o,l,c,u=0;const h=ArrayBuffer.isView(s)?new Uint8Array(s.buffer,s.byteOffset,s.byteLength):new Uint8Array(s);for(;u<h.length;)i=h[u++],n=u<h.length?h[u++]:Number.NaN,r=u<h.length?h[u++]:Number.NaN,a=i>>2,o=(i&3)<<4|n>>4,l=(n&15)<<2|r>>6,c=r&63,isNaN(n)?l=c=64:isNaN(r)&&(c=64),t+=e.charAt(a)+e.charAt(o)+e.charAt(l)+e.charAt(c);return t},cE=s=>atob(s),uE=s=>{const e=cE(s),t=e.length,i=new Uint8Array(new ArrayBuffer(t));for(let n=0;n<t;n++)i[n]=e.charCodeAt(n);return i.buffer},mT="attribute",_T="varying";class hl{constructor(){this.children=[]}isValid(e){return!0}process(e,t){var i,n,r,a,o,l,c;let u="";if(this.line){let h=this.line;const d=t.processor;if(d){d.lineProcessor&&(h=d.lineProcessor(h,t.isFragment,t.processingContext));const f=(n=(i=t.processor)===null||i===void 0?void 0:i.attributeKeywordName)!==null&&n!==void 0?n:mT,p=t.isFragment&&(!((r=t.processor)===null||r===void 0)&&r.varyingFragmentKeywordName)?(a=t.processor)===null||a===void 0?void 0:a.varyingFragmentKeywordName:!t.isFragment&&(!((o=t.processor)===null||o===void 0)&&o.varyingVertexKeywordName)?(l=t.processor)===null||l===void 0?void 0:l.varyingVertexKeywordName:_T;!t.isFragment&&d.attributeProcessor&&this.line.startsWith(f)?h=d.attributeProcessor(this.line,e,t.processingContext):d.varyingProcessor&&(!((c=d.varyingCheck)===null||c===void 0)&&c.call(d,this.line,t.isFragment)||!d.varyingCheck&&this.line.startsWith(p))?h=d.varyingProcessor(this.line,t.isFragment,e,t.processingContext):d.uniformProcessor&&d.uniformRegexp&&d.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(h=d.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):d.uniformBufferProcessor&&d.uniformBufferRegexp&&d.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(h=d.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):d.textureProcessor&&d.textureRegexp&&d.textureRegexp.test(this.line)?h=d.textureProcessor(this.line,t.isFragment,e,t.processingContext):(d.uniformProcessor||d.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?d.uniformProcessor&&(h=d.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):d.uniformBufferProcessor&&(h=d.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(t.lookForClosingBracketForUniformBuffer=!1,d.endOfUniformBufferProcessor&&(h=d.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}u+=h+`
`}return this.children.forEach(h=>{u+=h.process(e,t)}),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),u}}class gT{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if(!t||t==="\r")continue;if(t[0]==="#"){this._lines.push(t);continue}const i=t.trim();if(!i)continue;if(i.startsWith("//")){this._lines.push(t);continue}const n=i.indexOf(";");if(n===-1)this._lines.push(i);else if(n===i.length-1)i.length>1&&this._lines.push(i);else{const r=t.split(";");for(let a=0;a<r.length;a++){let o=r[a];o&&(o=o.trim(),o&&this._lines.push(o+(a!==r.length-1?";":"")))}}}}}class zh extends hl{process(e,t){for(let i=0;i<this.children.length;i++){const n=this.children[i];if(n.isValid(e))return n.process(e,t)}return""}}class ET extends hl{isValid(e){return this.testExpression.isTrue(e)}}class Xt{isTrue(e){return!0}static postfixToInfix(e){const t=[];for(const i of e)if(Xt._OperatorPriority[i]===void 0)t.push(i);else{const n=t[t.length-1],r=t[t.length-2];t.length-=2,t.push(`(${r}${i}${n})`)}return t[t.length-1]}static infixToPostfix(e){const t=Xt._InfixToPostfixCache.get(e);if(t)return t.accessTime=Date.now(),t.result;if(!e.includes("&&")&&!e.includes("||")&&!e.includes(")")&&!e.includes("("))return[e];const i=[];let n=-1;const r=()=>{u=u.trim(),u!==""&&(i.push(u),u="")},a=h=>{n<Xt._Stack.length-1&&(Xt._Stack[++n]=h)},o=()=>Xt._Stack[n],l=()=>n===-1?"!!INVALID EXPRESSION!!":Xt._Stack[n--];let c=0,u="";for(;c<e.length;){const h=e.charAt(c),d=c<e.length-1?e.substr(c,2):"";if(h==="(")u="",a(h);else if(h===")"){for(r();n!==-1&&o()!=="(";)i.push(l());l()}else if(Xt._OperatorPriority[d]>1){for(r();n!==-1&&Xt._OperatorPriority[o()]>=Xt._OperatorPriority[d];)i.push(l());a(d),c++}else u+=h;c++}for(r();n!==-1;)o()==="("?l():i.push(l());return Xt._InfixToPostfixCache.size>=Xt.InfixToPostfixCacheLimitSize&&Xt.ClearCache(),Xt._InfixToPostfixCache.set(e,{result:i,accessTime:Date.now()}),i}static ClearCache(){const e=Array.from(Xt._InfixToPostfixCache.entries()).sort((t,i)=>t[1].accessTime-i[1].accessTime);for(let t=0;t<Xt.InfixToPostfixCacheCleanupSize;t++)Xt._InfixToPostfixCache.delete(e[t][0])}}Xt.InfixToPostfixCacheLimitSize=5e4;Xt.InfixToPostfixCacheCleanupSize=25e3;Xt._InfixToPostfixCache=new Map;Xt._OperatorPriority={")":0,"(":1,"||":2,"&&":3};Xt._Stack=["","","","","","","","","","","","","","","","","","","",""];class bc extends Xt{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=e[this.define]!==void 0;return this.not&&(t=!t),t}}class vT extends Xt{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class yT extends Xt{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class AT extends Xt{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}isTrue(e){let t=e[this.define];t===void 0&&(t=this.define);let i=!1;const n=parseInt(t),r=parseInt(this.testValue);switch(this.operand){case">":i=n>r;break;case"<":i=n<r;break;case"<=":i=n<=r;break;case">=":i=n>=r;break;case"==":i=n===r;break;case"!=":i=n!==r;break}return i}}var Ai;(function(s){s[s.GLSL=0]="GLSL",s[s.WGSL=1]="WGSL"})(Ai||(Ai={}));const TT=/defined\s*?\((.+?)\)/g,Hh=/defined\s*?\[(.+?)\]/g,ST=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,CT=/__decl__/,M_=/light\{X\}.(\w*)/g,P_=/\{X\}/g,xc=[];class xs{static Initialize(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)}static Process(e,t,i,n){var r;!((r=t.processor)===null||r===void 0)&&r.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,a=>{t.processCodeAfterIncludes&&(a=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",a));const o=this._ProcessShaderConversion(a,t,n);i(o,a)})}static PreProcess(e,t,i,n){var r;!((r=t.processor)===null||r===void 0)&&r.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,a=>{t.processCodeAfterIncludes&&(a=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",a));const o=this._ApplyPreProcessing(a,t,n);i(o,a)})}static Finalize(e,t,i){return!i.processor||!i.processor.finalizeShaders?{vertexCode:e,fragmentCode:t}:i.processor.finalizeShaders(e,t,i.processingContext)}static _ProcessPrecision(e,t){var i;if(!((i=t.processor)===null||i===void 0)&&i.noPrecision)return e;const n=t.shouldUseHighPrecisionShader;return e.indexOf("precision highp float")===-1?n?e=`precision highp float;
`+e:e=`precision mediump float;
`+e:n||(e=e.replace("precision highp float","precision mediump float")),e}static _ExtractOperation(e){const i=/defined\((.+)\)/.exec(e);if(i&&i.length)return new bc(i[1].trim(),e[0]==="!");const n=["==","!=",">=","<=","<",">"];let r="",a=0;for(r of n)if(a=e.indexOf(r),a>-1)break;if(a===-1)return new bc(e);const o=e.substring(0,a).trim(),l=e.substring(a+r.length).trim();return new AT(o,r,l)}static _BuildSubExpression(e){e=e.replace(TT,"defined[$1]");const t=Xt.infixToPostfix(e),i=[];for(const r of t)if(r!=="||"&&r!=="&&")i.push(r);else if(i.length>=2){let a=i[i.length-1],o=i[i.length-2];i.length-=2;const l=r=="&&"?new yT:new vT;typeof a=="string"&&(a=a.replace(Hh,"defined($1)")),typeof o=="string"&&(o=o.replace(Hh,"defined($1)")),l.leftOperand=typeof o=="string"?this._ExtractOperation(o):o,l.rightOperand=typeof a=="string"?this._ExtractOperation(a):a,i.push(l)}let n=i[i.length-1];return typeof n=="string"&&(n=n.replace(Hh,"defined($1)")),typeof n=="string"?this._ExtractOperation(n):n}static _BuildExpression(e,t){const i=new ET,n=e.substring(0,t);let r=e.substring(t);return r=r.substring(0,(r.indexOf("//")+1||r.length+1)-1).trim(),n==="#ifdef"?i.testExpression=new bc(r):n==="#ifndef"?i.testExpression=new bc(r,!0):i.testExpression=this._BuildSubExpression(r),i}static _MoveCursorWithinIf(e,t,i){let n=e.currentLine;for(;this._MoveCursor(e,i);){n=e.currentLine;const r=n.substring(0,5).toLowerCase();if(r==="#else"){const a=new hl;t.children.push(a),this._MoveCursor(e,a);return}else if(r==="#elif"){const a=this._BuildExpression(n,5);t.children.push(a),i=a}}}static _MoveCursor(e,t){for(;e.canRead;){e.lineIndex++;const i=e.currentLine;if(i.indexOf("#")>=0){const r=xs._MoveCursorRegex.exec(i);if(r&&r.length){switch(r[0]){case"#ifdef":{const o=new zh;t.children.push(o);const l=this._BuildExpression(i,6);o.children.push(l),this._MoveCursorWithinIf(e,o,l);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const o=new zh;t.children.push(o);const l=this._BuildExpression(i,7);o.children.push(l),this._MoveCursorWithinIf(e,o,l);break}case"#if":{const o=new zh,l=this._BuildExpression(i,3);t.children.push(o),o.children.push(l),this._MoveCursorWithinIf(e,o,l);break}}continue}}const n=new hl;if(n.line=i,t.children.push(n),i[0]==="#"&&i[1]==="d"){const r=i.replace(";","").split(" ");n.additionalDefineKey=r[1],r.length===3&&(n.additionalDefineValue=r[2])}}return!1}static _EvaluatePreProcessors(e,t,i){const n=new hl,r=new gT;return r.lineIndex=-1,r.lines=e.split(`
`),this._MoveCursor(r,n),n.process(t,i)}static _PreparePreProcessors(e,t){var i;const n=e.defines,r={};for(const a of n){const l=a.replace("#define","").replace(";","").trim().split(" ");r[l[0]]=l.length>1?l[1]:""}return((i=e.processor)===null||i===void 0?void 0:i.shaderLanguage)===Ai.GLSL&&(r.GL_ES="true"),r.__VERSION__=e.version,r[e.platformName]="true",t._getGlobalDefines(r),r}static _ProcessShaderConversion(e,t,i){let n=this._ProcessPrecision(e,t);if(!t.processor||t.processor.shaderLanguage===Ai.GLSL&&n.indexOf("#version 3")!==-1&&(n=n.replace("#version 300 es",""),!t.processor.parseGLES3))return n;const r=t.defines,a=this._PreparePreProcessors(t,i);return t.processor.preProcessor&&(n=t.processor.preProcessor(n,r,t.isFragment,t.processingContext)),n=this._EvaluatePreProcessors(n,a,t),t.processor.postProcessor&&(n=t.processor.postProcessor(n,r,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(n=i.inlineShaderCode(n)),n}static _ApplyPreProcessing(e,t,i){var n,r;let a=e;const o=t.defines,l=this._PreparePreProcessors(t,i);return!((n=t.processor)===null||n===void 0)&&n.preProcessor&&(a=t.processor.preProcessor(a,o,t.isFragment,t.processingContext)),a=this._EvaluatePreProcessors(a,l,t),!((r=t.processor)===null||r===void 0)&&r.postProcessor&&(a=t.processor.postProcessor(a,o,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(a=i.inlineShaderCode(a)),a}static _ProcessIncludes(e,t,i){xc.length=0;let n;for(;(n=ST.exec(e))!==null;)xc.push(n);let r=String(e),a=[e],o=!1;for(const l of xc){let c=l[1];if(c.indexOf("__decl__")!==-1&&(c=c.replace(CT,""),t.supportsUniformBuffers&&(c=c.replace("Vertex","Ubo").replace("Fragment","Ubo")),c=c+"Declaration"),t.includesShadersStore[c]){let u=t.includesShadersStore[c];if(l[2]){const d=l[3].split(",");for(let f=0;f<d.length;f+=2){const p=new RegExp(d[f],"g"),m=d[f+1];u=u.replace(p,m)}}if(l[4]){const d=l[5];if(d.indexOf("..")!==-1){const f=d.split(".."),p=parseInt(f[0]);let m=parseInt(f[1]),_=u.slice(0);u="",isNaN(m)&&(m=t.indexParameters[f[1]]);for(let E=p;E<m;E++)t.supportsUniformBuffers||(_=_.replace(M_,(v,y)=>y+"{X}")),u+=_.replace(P_,E.toString())+`
`}else t.supportsUniformBuffers||(u=u.replace(M_,(f,p)=>p+"{X}")),u=u.replace(P_,d)}const h=[];for(const d of a){const f=d.split(l[0]);for(let p=0;p<f.length-1;p++)h.push(f[p]),h.push(u);h.push(f[f.length-1])}a=h,o=o||u.indexOf("#include<")>=0||u.indexOf("#include <")>=0}else{const u=t.shadersRepository+"ShadersInclude/"+c+".fx";xs._FileToolsLoadFile(u,h=>{t.includesShadersStore[c]=h,this._ProcessIncludes(a.join(""),t,i)});return}}xc.length=0,r=a.join(""),o?this._ProcessIncludes(r.toString(),t,i):i(r)}static _FileToolsLoadFile(e,t,i,n,r,a){throw De("FileTools")}}xs._MoveCursorRegex=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/;class Q{static GetShadersRepository(e=Ai.GLSL){return e===Ai.GLSL?Q.ShadersRepository:Q.ShadersRepositoryWGSL}static GetShadersStore(e=Ai.GLSL){return e===Ai.GLSL?Q.ShadersStore:Q.ShadersStoreWGSL}static GetIncludesShadersStore(e=Ai.GLSL){return e===Ai.GLSL?Q.IncludesShadersStore:Q.IncludesShadersStoreWGSL}}Q.ShadersRepository="src/Shaders/";Q.ShadersStore={};Q.IncludesShadersStore={};Q.ShadersRepositoryWGSL="src/ShadersWGSL/";Q.ShadersStoreWGSL={};Q.IncludesShadersStoreWGSL={};let bi=class La{static get ShadersRepository(){return Q.ShadersRepository}static set ShadersRepository(e){Q.ShadersRepository=e}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new O),this._onBindObservable}constructor(e,t,i,n=null,r,a=null,o=null,l=null,c=null,u,h="",d=Ai.GLSL){var f,p,m;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new O,this.onErrorObservable=new O,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!1,this._wasPreviouslyUsingInstances=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this.name=e,this._key=h;let _,E=null;if(t.attributes){const x=t;if(this._engine=i,this._attributesNames=x.attributes,this._uniformsNames=x.uniformsNames.concat(x.samplers),this._samplerList=x.samplers.slice(),this.defines=x.defines,this.onError=x.onError,this.onCompiled=x.onCompiled,this._fallbacks=x.fallbacks,this._indexParameters=x.indexParameters,this._transformFeedbackVaryings=x.transformFeedbackVaryings||null,this._multiTarget=!!x.multiTarget,this._shaderLanguage=(f=x.shaderLanguage)!==null&&f!==void 0?f:Ai.GLSL,x.uniformBuffersNames){this._uniformBuffersNamesList=x.uniformBuffersNames.slice();for(let F=0;F<x.uniformBuffersNames.length;F++)this._uniformBuffersNames[x.uniformBuffersNames[F]]=F}E=(p=x.processFinalCode)!==null&&p!==void 0?p:null,_=(m=x.processCodeAfterIncludes)!==null&&m!==void 0?m:void 0}else this._engine=r,this.defines=a==null?"":a,this._uniformsNames=i.concat(n),this._samplerList=n?n.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=d,this.onError=c,this.onCompiled=l,this._indexParameters=u,this._fallbacks=o;this._attributeLocationByName={},this.uniqueId=La._UniqueIdSeed++;let v,y;const A=vi()?this._engine.getHostDocument():null;e.vertexSource?v="source:"+e.vertexSource:e.vertexElement?(v=A?A.getElementById(e.vertexElement):null,v||(v=e.vertexElement)):v=e.vertex||e,e.fragmentSource?y="source:"+e.fragmentSource:e.fragmentElement?(y=A?A.getElementById(e.fragmentElement):null,y||(y=e.fragmentElement)):y=e.fragment||e,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);let I={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:Q.GetShadersRepository(this._shaderLanguage),includesShadersStore:Q.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:_};const T=[void 0,void 0],R=()=>{if(T[0]&&T[1]){I.isFragment=!0;const[x,F]=T;xs.Process(F,I,(L,V)=>{this._fragmentSourceCodeBeforeMigration=V,E&&(L=E("fragment",L));const Z=xs.Finalize(x,L,I);I=null,this._useFinalCode(Z.vertexCode,Z.fragmentCode,e)},this._engine)}};this._loadShader(v,"Vertex","",x=>{xs.Initialize(I),xs.Process(x,I,(F,L)=>{this._rawVertexSourceCode=x,this._vertexSourceCodeBeforeMigration=L,E&&(F=E("vertex",F)),T[0]=F,R()},this._engine)}),this._loadShader(y,"Fragment","Pixel",x=>{this._rawFragmentSourceCode=x,T[1]=x,R()})}_useFinalCode(e,t,i){if(i){const n=i.vertexElement||i.vertex||i.spectorName||i,r=i.fragmentElement||i.fragment||i.spectorName||i;this._vertexSourceCode=(this._shaderLanguage===Ai.WGSL?"//":"")+"#define SHADER_NAME vertex:"+n+`
`+e,this._fragmentSourceCode=(this._shaderLanguage===Ai.WGSL?"//":"")+"#define SHADER_NAME fragment:"+r+`
`+t}else this._vertexSourceCode=e,this._fragmentSourceCode=t;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch(e){return!1}}_isReadyInternal(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16)}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){this._processCompilationErrors(t,e);return}this._isDisposed||setTimeout(()=>{this._checkIsReady(e)},16)}_loadShader(e,t,i,n){if(typeof HTMLElement!="undefined"&&e instanceof HTMLElement){const o=lE(e);n(o);return}if(e.substr(0,7)==="source:"){n(e.substr(7));return}if(e.substr(0,7)==="base64:"){const o=window.atob(e.substr(7));n(o);return}const r=Q.GetShadersStore(this._shaderLanguage);if(r[e+t+"Shader"]){n(r[e+t+"Shader"]);return}if(i&&r[e+i+"Shader"]){n(r[e+i+"Shader"]);return}let a;e[0]==="."||e[0]==="/"||e.indexOf("http")>-1?a=e:a=Q.GetShadersRepository(this._shaderLanguage)+e,this._engine._loadFile(a+"."+t.toLowerCase()+".fx",n)}get vertexSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getVertexShaderCode())!==null&&t!==void 0?t:this._vertexSourceCode}get fragmentSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getFragmentShaderCode())!==null&&t!==void 0?t:this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}_rebuildProgram(e,t,i,n){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(r,a)=>{n&&n(a)},this.onCompiled=()=>{const r=this.getEngine().scenes;if(r)for(let a=0;a<r.length;a++)r[a].markAllMaterialsAsDirty(63);this._pipelineContext._handlesSpectorRebuildCallback(i)},this._fallbacks=null,this._prepareEffect()}_prepareEffect(){const e=this._attributesNames,t=this.defines,i=this._pipelineContext;this._isReady=!1;try{const n=this._engine;this._pipelineContext=n.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key;const r=this._rebuildProgram.bind(this);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?n._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,r,null,this._transformFeedbackVaryings,this._key):n._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,r,t,this._transformFeedbackVaryings,this._key),n._executeWhenRenderingStateIsCompiled(this._pipelineContext,()=>{if(this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,e,this._attributes),e)for(let a=0;a<e.length;a++){const o=e[a];this._attributeLocationByName[o]=this._attributes[a]}n.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),i&&this.getEngine()._deletePipelineContext(i)}),this._pipelineContext.isAsync&&this._checkIsReady(i)}catch(n){this._processCompilationErrors(n,i)}}_getShaderCodeAndErrorLine(e,t,i){const n=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let r=null;if(t&&e){const a=t.match(n);if(a&&a.length===2){const o=parseInt(a[1]),l=e.split(`
`,-1);l.length>=o&&(r=`Offending line [${o}] in ${i?"fragment":"vertex"} code: ${l[o-1]}`)}}return[e,r]}_processCompilationErrors(e,t=null){var i,n,r;this._compilationError=e.message;const a=this._attributesNames,o=this._fallbacks;if(U.Error("Unable to compile effect:"),U.Error("Uniforms: "+this._uniformsNames.map(function(c){return" "+c})),U.Error("Attributes: "+a.map(function(c){return" "+c})),U.Error(`Defines:
`+this.defines),La.LogShaderCodeOnCompilationError){let c=null,u=null,h=null;!((i=this._pipelineContext)===null||i===void 0)&&i._getVertexShaderCode()&&([h,c]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),h&&(U.Error("Vertex code:"),U.Error(h))),!((n=this._pipelineContext)===null||n===void 0)&&n._getFragmentShaderCode()&&([h,u]=this._getShaderCodeAndErrorLine((r=this._pipelineContext)===null||r===void 0?void 0:r._getFragmentShaderCode(),this._compilationError,!0),h&&(U.Error("Fragment code:"),U.Error(h))),c&&U.Error(c),u&&U.Error(u)}U.Error("Error: "+this._compilationError);const l=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)};t&&(this._pipelineContext=t,this._isReady=!0,l()),o?(this._pipelineContext=null,o.hasMoreFallbacks?(this._allFallbacksProcessed=!1,U.Error("Trying next fallback."),this.defines=o.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,l(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||l())}get isSupported(){return this._compilationError===""}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setDepthStencilTexture(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){const i=e+"Ex";if(this._samplerList.indexOf(i+"0")===-1){const n=this._samplerList.indexOf(e);for(let a=1;a<t.length;a++){const o=i+(a-1).toString();this._samplerList.splice(n+a,0,o)}let r=0;for(const a of this._samplerList)this._samplers[a]=r,r+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}setTextureFromPostProcess(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)}setTextureFromPostProcessOutput(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)}bindUniformBuffer(e,t){const i=this._uniformBuffersNames[t];i===void 0||La._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(La._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setInt3(e,t,i,n){return this._pipelineContext.setInt3(e,t,i,n),this}setInt4(e,t,i,n,r){return this._pipelineContext.setInt4(e,t,i,n,r),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setInt(e,t),this}setUInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setUInt3(e,t,i,n){return this._pipelineContext.setInt3(e,t,i,n),this}setUInt4(e,t,i,n,r){return this._pipelineContext.setInt4(e,t,i,n,r),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,i){return this._pipelineContext.setFloat2(e,t,i),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,i,n){return this._pipelineContext.setFloat3(e,t,i,n),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,i,n,r){return this._pipelineContext.setFloat4(e,t,i,n,r),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,i){return this._pipelineContext.setColor4(e,t,i),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0}static RegisterShader(e,t,i,n=Ai.GLSL){t&&(Q.GetShadersStore(n)[`${e}PixelShader`]=t),i&&(Q.GetShadersStore(n)[`${e}VertexShader`]=i)}static ResetCache(){La._BaseCache={}}};bi.LogShaderCodeOnCompilationError=!0;bi._UniqueIdSeed=0;bi._BaseCache={};bi.ShadersStore=Q.ShadersStore;bi.IncludesShadersStore=Q.IncludesShadersStore;class IT{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}class js{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=js.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=js.KEEP,this.opDepthFail=js.KEEP,this.opStencilDepthPass=js.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}js.ALWAYS=519;js.KEEP=7680;js.REPLACE=7681;class RT{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,i,n){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===n||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=n,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,i,n){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===n||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=n,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}}class bT{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,i=1,n=1,r=2,a=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=n,this.samplingMode=r,this._comparisonFunction=a,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}var Pt;(function(s){s[s.Unknown=0]="Unknown",s[s.Url=1]="Url",s[s.Temp=2]="Temp",s[s.Raw=3]="Raw",s[s.Dynamic=4]="Dynamic",s[s.RenderTarget=5]="RenderTarget",s[s.MultiRenderTarget=6]="MultiRenderTarget",s[s.Cube=7]="Cube",s[s.CubeRaw=8]="CubeRaw",s[s.CubePrefiltered=9]="CubePrefiltered",s[s.Raw3D=10]="Raw3D",s[s.Raw2DArray=11]="Raw2DArray",s[s.DepthStencil=12]="DepthStencil",s[s.CubeRawRGBD=13]="CubeRawRGBD",s[s.Depth=14]="Depth"})(Pt||(Pt={}));class dn extends bT{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(e,t,i=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new O,this.onErrorObservable=new O,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=Pt.Unknown,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._engine=e,this._source=t,this._uniqueId=dn._Counter++,i||(this._hardwareTexture=e._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,t,i=1){this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i}_rebuild(){var e;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const i=this.onRebuildCallback(this),n=r=>{r._swapAndDie(this,!1),this.isReady=i.isReady};i.isAsync?i.proxy.then(n):n(i.proxy);return}let t;switch(this.source){case Pt.Temp:break;case Pt.Url:t=this._engine.createTexture((e=this._originalUrl)!==null&&e!==void 0?e:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,i=>{i._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case Pt.Raw:t=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer),t._swapAndDie(this,!1),this.isReady=!0;break;case Pt.Raw3D:t=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case Pt.Raw2DArray:t=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case Pt.Dynamic:t=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),t._swapAndDie(this,!1),this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);break;case Pt.Cube:t=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{t._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer);return;case Pt.CubeRaw:t=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),t._swapAndDie(this,!1),this.isReady=!0;break;case Pt.CubeRawRGBD:return;case Pt.CubePrefiltered:t=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,i=>{i&&i._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),t._sphericalPolynomial=this._sphericalPolynomial;return}}_swapAndDie(e,t=!0){var i;(i=this._hardwareTexture)===null||i===void 0||i.setUsage(e._source,this.generateMipMaps,this.isCube,this.width,this.height),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);const n=this._engine.getLoadedTexturesCache();let r=n.indexOf(this);r!==-1&&n.splice(r,1),r=n.indexOf(e),r===-1&&n.push(e)}dispose(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._references===0&&(this._engine._releaseTexture(this),this._hardwareTexture=null)}}dn._Counter=0;class xT{constructor(){this.shaderLanguage=Ai.GLSL}postProcessor(e,t,i,n,r){if(!r.getCaps().drawBuffersExtension){const a=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(a,"")}return e}}const MT=/(flat\s)?\s*varying\s*.*/;class PT{constructor(){this.shaderLanguage=Ai.GLSL}attributeProcessor(e){return e.replace("attribute","in")}varyingCheck(e,t){return MT.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const n=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,r=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(r,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){const a=e.search(/layout *\(location *= *0\) *out/g)!==-1;e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(n||a?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(")}else if(t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}}class Ql{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=Ql._Counter++}}Ql._Counter=0;class Ol extends Ql{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}class DT{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null,this._isDisposed=!1}get isAsync(){return this.isParallelCompiled}get isReady(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}_fillEffectInformation(e,t,i,n,r,a,o,l){const c=this.engine;if(c.supportsUniformBuffers)for(const d in t)e.bindUniformBlock(d,t[d]);this.engine.getUniforms(this,i).forEach((d,f)=>{n[i[f]]=d}),this._uniforms=n;let h;for(h=0;h<r.length;h++)e.getUniform(r[h])==null&&(r.splice(h,1),h--);r.forEach((d,f)=>{a[d]=f});for(const d of c.getAttributes(this,o))l.push(d)}dispose(){this._uniforms={},this._isDisposed=!0}_cacheMatrix(e,t){const i=this._valueCache[e],n=t.updateFlag;return i!==void 0&&i===n?!1:(this._valueCache[e]=n,!0)}_cacheFloat2(e,t,i){let n=this._valueCache[e];if(!n||n.length!==2)return n=[t,i],this._valueCache[e]=n,!0;let r=!1;return n[0]!==t&&(n[0]=t,r=!0),n[1]!==i&&(n[1]=i,r=!0),r}_cacheFloat3(e,t,i,n){let r=this._valueCache[e];if(!r||r.length!==3)return r=[t,i,n],this._valueCache[e]=r,!0;let a=!1;return r[0]!==t&&(r[0]=t,a=!0),r[1]!==i&&(r[1]=i,a=!0),r[2]!==n&&(r[2]=n,a=!0),a}_cacheFloat4(e,t,i,n,r){let a=this._valueCache[e];if(!a||a.length!==4)return a=[t,i,n,r],this._valueCache[e]=a,!0;let o=!1;return a[0]!==t&&(a[0]=t,o=!0),a[1]!==i&&(a[1]=i,o=!0),a[2]!==n&&(a[2]=n,o=!0),a[3]!==r&&(a[3]=r,o=!0),o}setInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,n){this._cacheFloat3(e,t,i,n)&&(this.engine.setInt3(this._uniforms[e],t,i,n)||(this._valueCache[e]=null))}setInt4(e,t,i,n,r){this._cacheFloat4(e,t,i,n,r)&&(this.engine.setInt4(this._uniforms[e],t,i,n,r)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,n){this._cacheFloat3(e,t,i,n)&&(this.engine.setUInt3(this._uniforms[e],t,i,n)||(this._valueCache[e]=null))}setUInt4(e,t,i,n,r){this._cacheFloat4(e,t,i,n,r)&&(this.engine.setUInt4(this._uniforms[e],t,i,n,r)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,n){this._cacheFloat3(e,t,i,n)&&(this.engine.setFloat3(this._uniforms[e],t,i,n)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,n,r){this._cacheFloat4(e,t,i,n,r)&&(this.engine.setFloat4(this._uniforms[e],t,i,n,r)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}class hE{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&(e=t.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}class Lr{static IsWrapper(e){return e.getPipelineContext===void 0}static GetEffect(e){return e.getPipelineContext===void 0?e.effect:e}constructor(e,t=!0){this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,i=!0){var n;this.effect=e,t!==void 0&&(this.defines=t),i&&((n=this.drawContext)===null||n===void 0||n.reset())}dispose(){var e;(e=this.drawContext)===null||e===void 0||e.dispose()}}class OT{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){var e;this.stencilMaterial=void 0,(e=this.stencilGlobal)===null||e===void 0||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){var t;if(!e)return;const i=!this.useStencilGlobalOnly&&!!(!((t=this.stencilMaterial)===null||t===void 0)&&t.enabled);this.enabled=i?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=i?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=i?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=i?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=i?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=i?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=i?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=i?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}}class wT{}class _e{static get NpmPackage(){return"babylonjs@6.18.0"}static get Version(){return"6.18.0"}get description(){let e=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}get isDisposed(){return this._isDisposed}static get ShadersRepository(){return bi.ShadersRepository}static set ShadersRepository(e){bi.ShadersRepository=e}_getShaderProcessor(e){return this._shaderProcessor}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)}get frameId(){return this._frameId}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}getCreationOptions(){return this._creationOptions}get _shouldUseHighPrecisionShader(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get activeRenderLoops(){return this._activeRenderLoops}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}get currentViewport(){return this._cachedViewport}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get isWebGPU(){return this._isWebGPU}get shaderPlatformName(){return this._shaderPlatformName}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return this._snapshotRenderingMode}set snapshotRenderingMode(e){this._snapshotRenderingMode=e}snapshotRenderingReset(){this.snapshotRendering=!1}static _CreateCanvas(e,t){if(typeof document=="undefined")return new OffscreenCanvas(e,t);const i=document.createElement("canvas");return i.width=e,i.height=t,i}createCanvas(e,t){return _e._CreateCanvas(e,t)}createCanvasImage(){return document.createElement("img")}constructor(e,t,i,n){var r,a,o,l,c,u,h,d,f,p,m;this._name="WebGL",this._isDisposed=!1,this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new O,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new O,this.onContextRestoredObservable=new O,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new IT,this._stencilStateComposer=new OT,this._stencilState=new js,this._alphaState=new RT,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=new Array,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new O,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},this.startTime=Mn.Now;let _=null;i=i||{},this._creationOptions=i,this.adaptToDeviceRatio=n!=null?n:!1,this._stencilStateComposer.stencilGlobal=this._stencilState,fi.SetMatrixPrecision(!!i.useHighPrecisionMatrix),i.antialias=t!=null?t:i.antialias,i.deterministicLockstep=(r=i.deterministicLockstep)!==null&&r!==void 0?r:!1,i.lockstepMaxSteps=(a=i.lockstepMaxSteps)!==null&&a!==void 0?a:4,i.timeStep=(o=i.timeStep)!==null&&o!==void 0?o:1/60,i.audioEngine=(l=i.audioEngine)!==null&&l!==void 0?l:!0,i.stencil=(c=i.stencil)!==null&&c!==void 0?c:!0,this._audioContext=(h=(u=i.audioEngineOptions)===null||u===void 0?void 0:u.audioContext)!==null&&h!==void 0?h:null,this._audioDestination=(f=(d=i.audioEngineOptions)===null||d===void 0?void 0:d.audioDestination)!==null&&f!==void 0?f:null,this.premultipliedAlpha=(p=i.premultipliedAlpha)!==null&&p!==void 0?p:!0,this.useExactSrgbConversions=(m=i.useExactSrgbConversions)!==null&&m!==void 0?m:!1,this._doNotHandleContextLost=!!i.doNotHandleContextLost,this._isStencilEnable=!!i.stencil,n=n||i.adaptToDeviceRatio||!1;const E=vi()&&window.devicePixelRatio||1,v=i.limitDeviceRatio||E;if(this._hardwareScalingLevel=n?1/Math.min(v,E):1,this._lastDevicePixelRatio=E,!e)return;if(e.getContext){if(_=e,this._renderingCanvas=_,i.preserveDrawingBuffer===void 0&&(i.preserveDrawingBuffer=!1),i.xrCompatible===void 0&&(i.xrCompatible=!0),navigator&&navigator.userAgent){this._setupMobileChecks();const A=navigator.userAgent;for(const I of _e.ExceptionList){const T=I.key,R=I.targets;if(new RegExp(T).test(A)){if(I.capture&&I.captureConstraint){const F=I.capture,L=I.captureConstraint,Z=new RegExp(F).exec(A);if(Z&&Z.length>0&&parseInt(Z[Z.length-1])>=L)continue}for(const F of R)switch(F){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":i.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost||(this._onContextLost=A=>{A.preventDefault(),this._contextWasLost=!0,U.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(this._initGLContext.bind(this))},_.addEventListener("webglcontextlost",this._onContextLost,!1),_.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference=i.powerPreference||"high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=_.getContext("webgl2",i)||_.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(A){}if(!this._gl){if(!_)throw new Error("The provided canvas is null or undefined.");try{this._gl=_.getContext("webgl",i)||_.getContext("experimental-webgl",i)}catch(A){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const A=this._gl.getContextAttributes();A&&(i.stencil=A.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),i.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let A=0;A<this._caps.maxVertexAttribs;A++)this._currentBufferPointers[A]=new wT;this._shaderProcessor=this.webGLVersion>1?new PT:new xT,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);const y=`Babylon.js v${_e.Version}`;console.log(y+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",y)}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{const e=navigator.userAgent;this.hostInformation.isMobile=e.indexOf("Mobile")!==-1||e.indexOf("Mac")!==-1&&cl()&&"ontouchend"in document},this._checkForMobile(),vi()&&window.addEventListener("resize",this._checkForMobile))}_restoreEngineAfterContextLost(e){setTimeout(()=>Ie(this,null,function*(){var t;this._dummyFramebuffer=null;const i=this._depthCullingState.depthTest,n=this._depthCullingState.depthFunc,r=this._depthCullingState.depthMask,a=this._stencilState.stencilTest;yield e(),this.wipeCaches(!0),this._rebuildEffects(),(t=this._rebuildComputeEffects)===null||t===void 0||t.call(this),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0),this._depthCullingState.depthTest=i,this._depthCullingState.depthFunc=n,this._depthCullingState.depthMask=r,this._stencilState.stencilTest=a,U.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1}),0)}_sharedInit(e){this._renderingCanvas=e}_getShaderProcessingContext(e){return null}_rebuildInternalTextures(){const e=this._internalTexturesCache.slice();for(const t of e)t._rebuild()}_rebuildRenderTargetWrappers(){const e=this._renderTargetWrapperCache.slice();for(const t of e)t._rebuild()}_rebuildEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}bi.ResetCache()}areAllEffectsReady(){for(const e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_rebuildBuffers(){for(const e of this._uniformBuffers)e._rebuild();for(const e of this._storageBuffers)e._rebuild()}_initGLContext(){var e;this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:this._webGLVersion!==1,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1},this._glVersion=this._gl.getParameter(this._gl.VERSION);const t=this._gl.getExtension("WEBGL_debug_renderer_info");if(t!=null&&(this._glRenderer=this._gl.getParameter(t.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(t.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=((e=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))!==null&&e!==void 0?e:0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{const i=this._gl.getExtension("WEBGL_draw_buffers");if(i!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=i.drawBuffersWEBGL.bind(i),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let n=0;n<16;n++)this._gl["COLOR_ATTACHMENT"+n+"_WEBGL"]=i["COLOR_ATTACHMENT"+n+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const i=this._gl.getExtension("WEBGL_depth_texture");i!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=i.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const i=this._gl.getExtension("OES_vertex_array_object");i!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=i.createVertexArrayOES.bind(i),this._gl.bindVertexArray=i.bindVertexArrayOES.bind(i),this._gl.deleteVertexArray=i.deleteVertexArrayOES.bind(i))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const i=this._gl.getExtension("ANGLE_instanced_arrays");i!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=i.drawArraysInstancedANGLE.bind(i),this._gl.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i),this._gl.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const i=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),n=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);i&&n&&(this._caps.highPrecisionShaderSupported=i.precision!==0&&n.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const i=this._gl.getExtension("EXT_blend_minmax");i!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=i.MAX_EXT,this._gl.MIN=i.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const i=this._gl.getExtension("EXT_sRGB");i!=null&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:i.SRGB_EXT,SRGB8:i.SRGB_ALPHA_EXT,SRGB8_ALPHA8:i.SRGB_ALPHA_EXT})}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!!(this._creationOptions&&this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let i=0;i<this._maxSimultaneousTextures;i++)this._nextFreeTextureSlots.push(i);this._glRenderer==="Mali-G72"&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}get isStencilEnable(){return this._isStencilEnable}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}resetTextureCache(){for(const e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}getLoadedTexturesCache(){return this._internalTexturesCache}getCaps(){return this._caps}stopRenderLoop(e){if(!e){this._activeRenderLoops.length=0,this._cancelFrame();return}const t=this._activeRenderLoops.indexOf(e);t>=0&&(this._activeRenderLoops.splice(t,1),this._activeRenderLoops.length==0&&this._cancelFrame())}_cancelFrame(){if(this._renderingQueueLaunched&&this._frameHandler){if(this._renderingQueueLaunched=!1,vi()){const{cancelAnimationFrame:e}=this.getHostWindow()||window;if(typeof e=="function")return e(this._frameHandler)}else if(typeof cancelAnimationFrame=="function")return cancelAnimationFrame(this._frameHandler);return clearTimeout(this._frameHandler)}}_renderLoop(){if(!this._contextWasLost){let e=!0;if((this._isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e){this.beginFrame();for(let t=0;t<this._activeRenderLoops.length;t++){const i=this._activeRenderLoops[t];i()}this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}getHostWindow(){return vi()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}_queueNewFrame(e,t){return _e.QueueNewFrame(e,t)}runRenderLoop(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}clear(e,t,i,n=!1){var r,a;const o=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=o;let l=0;if(t&&e){let c=!0;if(this._currentRenderTarget){const u=(r=this._currentRenderTarget.texture)===null||r===void 0?void 0:r.format;if(u===8||u===9||u===10||u===11){const h=(a=this._currentRenderTarget.texture)===null||a===void 0?void 0:a.type;h===7||h===5?(_e._TempClearColorUint32[0]=e.r*255,_e._TempClearColorUint32[1]=e.g*255,_e._TempClearColorUint32[2]=e.b*255,_e._TempClearColorUint32[3]=e.a*255,this._gl.clearBufferuiv(this._gl.COLOR,0,_e._TempClearColorUint32),c=!1):(_e._TempClearColorInt32[0]=e.r*255,_e._TempClearColorInt32[1]=e.g*255,_e._TempClearColorInt32[2]=e.b*255,_e._TempClearColorInt32[3]=e.a*255,this._gl.clearBufferiv(this._gl.COLOR,0,_e._TempClearColorInt32),c=!1)}}c&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),l|=this._gl.COLOR_BUFFER_BIT)}i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),l|=this._gl.DEPTH_BUFFER_BIT),n&&(this._gl.clearStencil(0),l|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(l)}_viewport(e,t,i,n){(e!==this._viewportCached.x||t!==this._viewportCached.y||i!==this._viewportCached.z||n!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=n,this._gl.viewport(e,t,i,n))}setViewport(e,t,i){const n=t||this.getRenderWidth(),r=i||this.getRenderHeight(),a=e.x||0,o=e.y||0;this._cachedViewport=e,this._viewport(a*n,o*r,n*e.width,r*e.height)}beginFrame(){}endFrame(){this._badOS&&this.flushFramebuffer(),this._frameId++}resize(e=!1){let t,i;if(this.adaptToDeviceRatio){const n=vi()&&window.devicePixelRatio||1,r=this._lastDevicePixelRatio/n;this._lastDevicePixelRatio=n,this._hardwareScalingLevel*=r}if(vi()&&cl())if(this._renderingCanvas){const n=this._renderingCanvas.getBoundingClientRect?this._renderingCanvas.getBoundingClientRect():{width:this._renderingCanvas.width*this._hardwareScalingLevel,height:this._renderingCanvas.height*this._hardwareScalingLevel};t=this._renderingCanvas.clientWidth||n.width||this._renderingCanvas.width||100,i=this._renderingCanvas.clientHeight||n.height||this._renderingCanvas.height||100}else t=window.innerWidth,i=window.innerHeight;else t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100;this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e)}setSize(e,t,i=!1){return!this._renderingCanvas||(e=e|0,t=t|0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t)?!1:(this._renderingCanvas.width=e,this._renderingCanvas.height=t,!0)}bindFramebuffer(e,t=0,i,n,r,a=0,o=0){var l,c,u,h,d;const f=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(f._MSAAFramebuffer?f._MSAAFramebuffer:f._framebuffer);const p=this._gl;e.isMulti||(e.is2DArray?p.framebufferTextureLayer(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,(l=e.texture._hardwareTexture)===null||l===void 0?void 0:l.underlyingResource,a,o):e.isCube&&p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_CUBE_MAP_POSITIVE_X+t,(c=e.texture._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource,a));const m=e._depthStencilTexture;if(m){const _=e._depthStencilTextureWithStencil?p.DEPTH_STENCIL_ATTACHMENT:p.DEPTH_ATTACHMENT;e.is2DArray?p.framebufferTextureLayer(p.FRAMEBUFFER,_,(u=m._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,a,o):e.isCube?p.framebufferTexture2D(p.FRAMEBUFFER,_,p.TEXTURE_CUBE_MAP_POSITIVE_X+t,(h=m._hardwareTexture)===null||h===void 0?void 0:h.underlyingResource,a):p.framebufferTexture2D(p.FRAMEBUFFER,_,p.TEXTURE_2D,(d=m._hardwareTexture)===null||d===void 0?void 0:d.underlyingResource,a)}this._cachedViewport&&!r?this.setViewport(this._cachedViewport,i,n):(i||(i=e.width,a&&(i=i/Math.pow(2,a))),n||(n=e.height,a&&(n=n/Math.pow(2,a))),this._viewport(0,0,i,n)),this.wipeCaches()}setState(e,t=0,i,n=!1,r,a,o=0){var l,c;(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);const u=!((c=(l=this.cullBackFaces)!==null&&l!==void 0?l:r)!==null&&c!==void 0)||c?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==u||i)&&(this._depthCullingState.cullFace=u),this.setZOffset(t),this.setZOffsetUnits(o);const h=n?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==h||i)&&(this._depthCullingState.frontFace=h),this._stencilStateComposer.stencilMaterial=a}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){const e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){const e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}unBindFramebuffer(e,t=!1,i){var n;const r=e;this._currentRenderTarget=null;const a=this._gl;if(r._MSAAFramebuffer){if(e.isMulti){this.unBindMultiColorAttachmentFramebuffer(e,t,i);return}a.bindFramebuffer(a.READ_FRAMEBUFFER,r._MSAAFramebuffer),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,r._framebuffer),a.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,a.COLOR_BUFFER_BIT,a.NEAREST)}!((n=e.texture)===null||n===void 0)&&n.generateMipMaps&&!t&&!e.isCube&&this.generateMipmaps(e.texture),i&&(r._MSAAFramebuffer&&this._bindUnboundFramebuffer(r._framebuffer),i()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");const n=new Ol(i);return this.bindArrayBuffer(n),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),this._resetVertexBufferBinding(),n.references=1,n}createDynamicVertexBuffer(e){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t){const i=this._gl.createBuffer(),n=new Ol(i);if(!i)throw new Error("Unable to create index buffer");this.bindIndexBuffer(n);const r=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,r,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),n.references=1,n.is32Bits=r.BYTES_PER_ELEMENT===4,n}_normalizeIndexData(e){if(e.BYTES_PER_ELEMENT===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let i=0;i<e.length;i++)if(e[i]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,i){const n=e.program,r=this._gl.getUniformBlockIndex(n,t);this._gl.uniformBlockBinding(n,r,i)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,i,n,r,a,o){const l=this._currentBufferPointers[t];if(!l)return;let c=!1;l.active?(l.buffer!==e&&(l.buffer=e,c=!0),l.size!==i&&(l.size=i,c=!0),l.type!==n&&(l.type=n,c=!0),l.normalized!==r&&(l.normalized=r,c=!0),l.stride!==a&&(l.stride=a,c=!0),l.offset!==o&&(l.offset=o,c=!0)):(c=!0,l.active=!0,l.index=t,l.size=i,l.type=n,l.normalized=r,l.stride=a,l.offset=o,l.buffer=e),(c||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),n===this._gl.UNSIGNED_INT||n===this._gl.INT?this._gl.vertexAttribIPointer(t,i,n,a,o):this._gl.vertexAttribPointer(t,i,n,r,a,o))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,i){const n=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let r=0;r<n.length;r++){const a=t.getAttributeLocation(r);if(a>=0){const o=n[r];let l=null;if(i&&(l=i[o]),l||(l=e[o]),!l)continue;this._gl.enableVertexAttribArray(a),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[a]=!0);const c=l.getBuffer();c&&(this._vertexAttribPointer(c,a,l.getSize(),l.type,l.normalized,l.byteStride,l.byteOffset),l.getIsInstanced()&&(this._gl.vertexAttribDivisor(a,l.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(c))))}}}recordVertexArrayObject(e,t,i,n){const r=this._gl.createVertexArray();if(!r)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(r),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,n),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),r}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,i,n,r){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==r){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=r;const a=r.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let o=0;for(let l=0;l<a;l++)if(l<i.length){const c=r.getAttributeLocation(l);c>=0&&(this._gl.enableVertexAttribArray(c),this._vertexAttribArraysEnabled[c]=!0,this._vertexAttribPointer(e,c,i[l],this._gl.FLOAT,!1,n,o)),o+=i[l]*4}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,i,n){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,n)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,i=this._currentInstanceLocations.length;t<i;t++){const n=this._currentInstanceBuffers[t];e!=n&&n.references&&(e=n,this.bindArrayBuffer(n));const r=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(r,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),i[0].index!==void 0)this.bindInstancesBuffer(e,i,!0);else for(let n=0;n<4;n++){const r=i[n];this._vertexAttribArraysEnabled[r]||(this._gl.enableVertexAttribArray(r),this._vertexAttribArraysEnabled[r]=!0),this._vertexAttribPointer(e,r,4,this._gl.FLOAT,!1,64,n*16),this._gl.vertexAttribDivisor(r,1),this._currentInstanceLocations.push(r),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,i=!0){this.bindArrayBuffer(e);let n=0;if(i)for(let r=0;r<t.length;r++){const a=t[r];n+=a.attributeSize*4}for(let r=0;r<t.length;r++){const a=t[r];a.index===void 0&&(a.index=this._currentEffect.getAttributeLocationByName(a.attributeName)),!(a.index<0)&&(this._vertexAttribArraysEnabled[a.index]||(this._gl.enableVertexAttribArray(a.index),this._vertexAttribArraysEnabled[a.index]=!0),this._vertexAttribPointer(e,a.index,a.attributeSize,a.attributeType||this._gl.FLOAT,a.normalized||!1,n,a.offset),this._gl.vertexAttribDivisor(a.index,a.divisor===void 0?1:a.divisor),this._currentInstanceLocations.push(a.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t=!1,i;for(;(i=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(i,1),this._currentInstanceBuffers.splice(i,1),t=!0,i=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,i,n){this.drawElementsType(e?0:1,t,i,n)}drawPointClouds(e,t,i){this.drawArraysType(2,e,t,i)}drawUnIndexed(e,t,i,n){this.drawArraysType(e?0:1,t,i,n)}drawElementsType(e,t,i,n){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e),a=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;n?this._gl.drawElementsInstanced(r,i,a,t*o,n):this._gl.drawElements(r,i,a,t*o)}drawArraysType(e,t,i,n){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e);n?this._gl.drawArraysInstanced(r,t,i,n):this._gl.drawArrays(r,t,i)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_reportDrawCall(){}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){const t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(t.program))}_getGlobalDefines(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{let t="";return this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+=`
`),t+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(t&&(t+=`
`),t+="#define USE_EXACT_SRGB_CONVERSIONS"),t}}createEffect(e,t,i,n,r,a,o,l,c,u=Ai.GLSL){var h;const d=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,f=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,p=this._getGlobalDefines();let m=(h=r!=null?r:t.defines)!==null&&h!==void 0?h:"";p&&(m+=p);const _=d+"+"+f+"@"+m;if(this._compiledEffects[_]){const v=this._compiledEffects[_];return o&&v.isReady()&&o(v),v}const E=new bi(e,t,i,n,this,r,a,o,l,c,_,u);return this._compiledEffects[_]=E,E}static _ConcatenateShader(e,t,i=""){return i+(t?t+`
`:"")+e}_compileShader(e,t,i,n){return this._compileRawShader(_e._ConcatenateShader(e,i,n),t)}_compileRawShader(e,t){const i=this._gl,n=i.createShader(t==="vertex"?i.VERTEX_SHADER:i.FRAGMENT_SHADER);if(!n){let r=i.NO_ERROR,a=i.NO_ERROR;for(;(a=i.getError())!==i.NO_ERROR;)r=a;throw new Error(`Something went wrong while creating a gl ${t} shader object. gl error=${r}, gl isContextLost=${i.isContextLost()}, _contextWasLost=${this._contextWasLost}`)}return i.shaderSource(n,e),i.compileShader(n),n}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,i,n,r=null){n=n||this._gl;const a=this._compileRawShader(t,"vertex"),o=this._compileRawShader(i,"fragment");return this._createShaderProgram(e,a,o,n,r)}createShaderProgram(e,t,i,n,r,a=null){r=r||this._gl;const o=this._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",l=this._compileShader(t,"vertex",n,o),c=this._compileShader(i,"fragment",n,o);return this._createShaderProgram(e,l,c,r,a)}inlineShaderCode(e){return e}createPipelineContext(e){const t=new DT;return t.engine=this,this._caps.parallelShaderCompile&&(t.isParallelCompiled=!0),t}createMaterialContext(){}createDrawContext(){}_createShaderProgram(e,t,i,n,r=null){const a=n.createProgram();if(e.program=a,!a)throw new Error("Unable to create program");return n.attachShader(a,t),n.attachShader(a,i),n.linkProgram(a),e.context=n,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),a}_finalizePipelineContext(e){const t=e.context,i=e.vertexShader,n=e.fragmentShader,r=e.program;if(!t.getProgramParameter(r,t.LINK_STATUS)){if(!this._gl.getShaderParameter(i,this._gl.COMPILE_STATUS)){const l=this._gl.getShaderInfoLog(i);if(l)throw e.vertexCompilationError=l,new Error("VERTEX SHADER "+l)}if(!this._gl.getShaderParameter(n,this._gl.COMPILE_STATUS)){const l=this._gl.getShaderInfoLog(n);if(l)throw e.fragmentCompilationError=l,new Error("FRAGMENT SHADER "+l)}const o=t.getProgramInfoLog(r);if(o)throw e.programLinkError=o,new Error(o)}if(this.validateShaderPrograms&&(t.validateProgram(r),!t.getProgramParameter(r,t.VALIDATE_STATUS))){const l=t.getProgramInfoLog(r);if(l)throw e.programValidationError=l,new Error(l)}t.deleteShader(i),t.deleteShader(n),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)}_preparePipelineContext(e,t,i,n,r,a,o,l,c,u){const h=e;n?h.program=this.createRawShaderProgram(h,t,i,void 0,c):h.program=this.createShaderProgram(h,t,i,l,void 0,c),h.program.__SPECTOR_rebuildProgram=o}_isRenderingStateCompiled(e){const t=e;return this._isDisposed||t._isDisposed?!1:this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)?(this._finalizePipelineContext(t),!0):!1}_executeWhenRenderingStateIsCompiled(e,t){const i=e;if(!i.isParallelCompiled){t();return}const n=i.onCompiled;n?i.onCompiled=()=>{n(),t()}:i.onCompiled=t}getUniforms(e,t){const i=new Array,n=e;for(let r=0;r<t.length;r++)i.push(this._gl.getUniformLocation(n.program,t[r]));return i}getAttributes(e,t){const i=[],n=e;for(let r=0;r<t.length;r++)try{i.push(this._gl.getAttribLocation(n.program,t[r]))}catch(a){i.push(-1)}return i}enableEffect(e){e=e!==null&&Lr.IsWrapper(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,e=e,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return e?(this._gl.uniform1i(e,t),!0):!1}setInt2(e,t,i){return e?(this._gl.uniform2i(e,t,i),!0):!1}setInt3(e,t,i,n){return e?(this._gl.uniform3i(e,t,i,n),!0):!1}setInt4(e,t,i,n,r){return e?(this._gl.uniform4i(e,t,i,n,r),!0):!1}setIntArray(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1}setIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2iv(e,t),!0)}setIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3iv(e,t),!0)}setIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4iv(e,t),!0)}setUInt(e,t){return e?(this._gl.uniform1ui(e,t),!0):!1}setUInt2(e,t,i){return e?(this._gl.uniform2ui(e,t,i),!0):!1}setUInt3(e,t,i,n){return e?(this._gl.uniform3ui(e,t,i,n),!0):!1}setUInt4(e,t,i,n,r){return e?(this._gl.uniform4ui(e,t,i,n,r),!0):!1}setUIntArray(e,t){return e?(this._gl.uniform1uiv(e,t),!0):!1}setUIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2uiv(e,t),!0)}setUIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3uiv(e,t),!0)}setUIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4uiv(e,t),!0)}setArray(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)}setArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2fv(e,t),!0)}setArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3fv(e,t),!0)}setArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4fv(e,t),!0)}setMatrices(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1}setMatrix3x3(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1}setMatrix2x2(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1}setFloat(e,t){return e?(this._gl.uniform1f(e,t),!0):!1}setFloat2(e,t,i){return e?(this._gl.uniform2f(e,t,i),!0):!1}setFloat3(e,t,i,n){return e?(this._gl.uniform3f(e,t,i,n),!0):!1}setFloat4(e,t,i,n,r){return e?(this._gl.uniform4f(e,t,i,n,r),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}clearInternalTexturesCache(){this._internalTexturesCache.length=0}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){const i=this._gl;let n=i.NEAREST,r=i.NEAREST;switch(e){case 11:n=i.LINEAR,t?r=i.LINEAR_MIPMAP_NEAREST:r=i.LINEAR;break;case 3:n=i.LINEAR,t?r=i.LINEAR_MIPMAP_LINEAR:r=i.LINEAR;break;case 8:n=i.NEAREST,t?r=i.NEAREST_MIPMAP_LINEAR:r=i.NEAREST;break;case 4:n=i.NEAREST,t?r=i.NEAREST_MIPMAP_NEAREST:r=i.NEAREST;break;case 5:n=i.NEAREST,t?r=i.LINEAR_MIPMAP_NEAREST:r=i.LINEAR;break;case 6:n=i.NEAREST,t?r=i.LINEAR_MIPMAP_LINEAR:r=i.LINEAR;break;case 7:n=i.NEAREST,r=i.LINEAR;break;case 1:n=i.NEAREST,r=i.NEAREST;break;case 9:n=i.LINEAR,t?r=i.NEAREST_MIPMAP_NEAREST:r=i.NEAREST;break;case 10:n=i.LINEAR,t?r=i.NEAREST_MIPMAP_LINEAR:r=i.NEAREST;break;case 2:n=i.LINEAR,r=i.LINEAR;break;case 12:n=i.LINEAR,r=i.NEAREST;break}return{min:r,mag:n}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new hE(this._createTexture(),this._gl)}_createInternalTexture(e,t,i=!0,n=Pt.Unknown){var r;let a=!1,o=0,l=3,c=5,u=!1,h=1,d;t!==void 0&&typeof t=="object"?(a=!!t.generateMipMaps,o=t.type===void 0?0:t.type,l=t.samplingMode===void 0?3:t.samplingMode,c=t.format===void 0?5:t.format,u=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer,h=(r=t.samples)!==null&&r!==void 0?r:1,d=t.label):a=!!t,u&&(u=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(o===1&&!this._caps.textureFloatLinearFiltering||o===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l=1),o===1&&!this._caps.textureFloat&&(o=0,U.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const f=this._gl,p=new dn(this,n),m=e.width||e,_=e.height||e,E=e.layers||0,v=this._getSamplingParameters(l,a),y=E!==0?f.TEXTURE_2D_ARRAY:f.TEXTURE_2D,A=this._getRGBABufferInternalSizedFormat(o,c,u),I=this._getInternalFormat(c),T=this._getWebGLTextureType(o);return this._bindTextureDirectly(y,p),E!==0?(p.is2DArray=!0,f.texImage3D(y,0,A,m,_,E,0,I,T,null)):f.texImage2D(y,0,A,m,_,0,I,T,null),f.texParameteri(y,f.TEXTURE_MAG_FILTER,v.mag),f.texParameteri(y,f.TEXTURE_MIN_FILTER,v.min),f.texParameteri(y,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(y,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),a&&this._gl.generateMipmap(y),this._bindTextureDirectly(y,null),p._useSRGBBuffer=u,p.baseWidth=m,p.baseHeight=_,p.width=m,p.height=_,p.depth=E,p.isReady=!0,p.samples=h,p.generateMipMaps=a,p.samplingMode=l,p.type=o,p.format=c,p.label=d,this._internalTexturesCache.push(p),p}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||t)}_createTextureBase(e,t,i,n,r=3,a=null,o=null,l,c,u=null,h=null,d=null,f=null,p,m,_){e=e||"";const E=e.substr(0,5)==="data:",v=e.substr(0,5)==="blob:",y=E&&e.indexOf(";base64,")!==-1,A=h||new dn(this,Pt.Url);A!==h&&(A.label=e.substring(0,60));const I=e;this._transformTextureUrl&&!y&&!h&&!u&&(e=this._transformTextureUrl(e)),I!==e&&(A._originalUrl=I);const T=e.lastIndexOf(".");let R=f||(T>-1?e.substring(T).toLowerCase():""),x=null;R.indexOf("?")>-1&&(R=R.split("?")[0]);for(const Z of _e._TextureLoaders)if(Z.canLoad(R,p)){x=Z;break}n&&n.addPendingData(A),A.url=e,A.generateMipMaps=!t,A.samplingMode=r,A.invertY=i,A._useSRGBBuffer=this._getUseSRGBBuffer(!!_,t),this._doNotHandleContextLost||(A._buffer=u);let L=null;a&&!h&&(L=A.onLoadedObservable.add(a)),h||this._internalTexturesCache.push(A);const V=(Z,ne)=>{n&&n.removePendingData(A),e===I?(L&&A.onLoadedObservable.remove(L),Fe.UseFallbackTexture&&this._createTextureBase(Fe.FallbackTexture,t,A.invertY,n,r,null,o,l,c,u,A),Z=(Z||"Unknown error")+(Fe.UseFallbackTexture?" - Fallback texture was used":""),A.onErrorObservable.notifyObservers({message:Z,exception:ne}),o&&o(Z,ne)):(U.Warn(`Failed to load ${e}, falling back to ${I}`),this._createTextureBase(I,t,A.invertY,n,r,a,o,l,c,u,A,d,f,p,m,_))};if(x){const Z=ne=>{x.loadData(ne,A,(ae,Ue,Ve,$e,re,ge)=>{ge?V("TextureLoader failed to load data"):l(A,R,n,{width:ae,height:Ue},A.invertY,!Ve,$e,()=>(re(),!1),r)},m)};u?u instanceof ArrayBuffer?Z(new Uint8Array(u)):ArrayBuffer.isView(u)?Z(u):o&&o("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,ne=>Z(new Uint8Array(ne)),void 0,n?n.offlineProvider:void 0,!0,(ne,ae)=>{V("Unable to load "+(ne&&ne.responseURL,ae))})}else{const Z=ne=>{v&&!this._doNotHandleContextLost&&(A._buffer=ne),l(A,R,n,ne,A.invertY,t,!1,c,r)};!E||y?u&&(typeof u.decoding=="string"||u.close)?Z(u):_e._FileToolsLoadImage(e,Z,V,n?n.offlineProvider:null,p,A.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):typeof u=="string"||u instanceof ArrayBuffer||ArrayBuffer.isView(u)||u instanceof Blob?_e._FileToolsLoadImage(u,Z,V,n?n.offlineProvider:null,p,A.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):u&&Z(u)}return A}createTexture(e,t,i,n,r=3,a=null,o=null,l=null,c=null,u=null,h=null,d,f,p,m){return this._createTextureBase(e,t,i,n,r,a,o,this._prepareWebGLTexture.bind(this),(_,E,v,y,A,I)=>{const T=this._gl,R=v.width===_&&v.height===E,x=u?this._getInternalFormat(u,A._useSRGBBuffer):y===".jpg"&&!A._useSRGBBuffer?T.RGB:A._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:T.RGBA;let F=u?this._getInternalFormat(u):y===".jpg"&&!A._useSRGBBuffer?T.RGB:T.RGBA;if(A._useSRGBBuffer&&this.webGLVersion===1&&(F=x),R)return T.texImage2D(T.TEXTURE_2D,0,x,F,T.UNSIGNED_BYTE,v),!1;const L=this._caps.maxTextureSize;if(v.width>L||v.height>L||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=_,this._workingCanvas.height=E,this._workingContext.drawImage(v,0,0,v.width,v.height,0,0,_,E),T.texImage2D(T.TEXTURE_2D,0,x,F,T.UNSIGNED_BYTE,this._workingCanvas),A.width=_,A.height=E),!1;{const V=new dn(this,Pt.Temp);this._bindTextureDirectly(T.TEXTURE_2D,V,!0),T.texImage2D(T.TEXTURE_2D,0,x,F,T.UNSIGNED_BYTE,v),this._rescaleTexture(V,A,n,x,()=>{this._releaseTexture(V),this._bindTextureDirectly(T.TEXTURE_2D,A,!0),I()})}return!0},l,c,u,h,d,f,m)}static _FileToolsLoadImage(e,t,i,n,r,a){throw De("FileTools")}_rescaleTexture(e,t,i,n,r){}createRawTexture(e,t,i,n,r,a,o,l=null,c=0,u=0,h=!1){throw De("Engine.RawTexture")}createRawCubeTexture(e,t,i,n,r,a,o,l=null){throw De("Engine.RawTexture")}createRawTexture3D(e,t,i,n,r,a,o,l,c=null,u=0){throw De("Engine.RawTexture")}createRawTexture2DArray(e,t,i,n,r,a,o,l,c=null,u=0){throw De("Engine.RawTexture")}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,i=!1){const n=this._getTextureTarget(t),r=this._getSamplingParameters(e,t.useMipMaps||i);this._setTextureParameterInteger(n,this._gl.TEXTURE_MAG_FILTER,r.mag,t),this._setTextureParameterInteger(n,this._gl.TEXTURE_MIN_FILTER,r.min),i&&(t.generateMipMaps=!0,this._gl.generateMipmap(n)),this._bindTextureDirectly(n,null),t.samplingMode=e}updateTextureDimensions(e,t,i,n=1){}updateTextureWrappingMode(e,t,i=null,n=null){const r=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),i!==null&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&n!==null&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(n),e),e._cachedWrapR=n),this._bindTextureDirectly(r,null)}_setupDepthStencilTexture(e,t,i,n,r,a=1){const o=t.width||t,l=t.height||t,c=t.layers||0;e.baseWidth=o,e.baseHeight=l,e.width=o,e.height=l,e.is2DArray=c>0,e.depth=c,e.isReady=!0,e.samples=a,e.generateMipMaps=!1,e.samplingMode=n?2:1,e.type=0,e._comparisonFunction=r;const u=this._gl,h=this._getTextureTarget(e),d=this._getSamplingParameters(e.samplingMode,!1);u.texParameteri(h,u.TEXTURE_MAG_FILTER,d.mag),u.texParameteri(h,u.TEXTURE_MIN_FILTER,d.min),u.texParameteri(h,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(h,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),this.webGLVersion>1&&(r===0?(u.texParameteri(h,u.TEXTURE_COMPARE_FUNC,515),u.texParameteri(h,u.TEXTURE_COMPARE_MODE,u.NONE)):(u.texParameteri(h,u.TEXTURE_COMPARE_FUNC,r),u.texParameteri(h,u.TEXTURE_COMPARE_MODE,u.COMPARE_REF_TO_TEXTURE)))}_uploadCompressedDataToTextureDirectly(e,t,i,n,r,a=0,o=0){const l=this._gl;let c=l.TEXTURE_2D;if(e.isCube&&(c=l.TEXTURE_CUBE_MAP_POSITIVE_X+a),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=l.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=l.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=l.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=l.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(c,o,t,i,n,0,r)}_uploadDataToTextureDirectly(e,t,i=0,n=0,r,a=!1){const o=this._gl,l=this._getWebGLTextureType(e.type),c=this._getInternalFormat(e.format),u=r===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(r,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let h=o.TEXTURE_2D;e.isCube&&(h=o.TEXTURE_CUBE_MAP_POSITIVE_X+i);const d=Math.round(Math.log(e.width)*Math.LOG2E),f=Math.round(Math.log(e.height)*Math.LOG2E),p=a?e.width:Math.pow(2,Math.max(d-n,0)),m=a?e.height:Math.pow(2,Math.max(f-n,0));o.texImage2D(h,n,u,p,m,0,c,l,t)}updateTextureData(e,t,i,n,r,a,o=0,l=0,c=!1){const u=this._gl,h=this._getWebGLTextureType(e.type),d=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let f=u.TEXTURE_2D,p=u.TEXTURE_2D;e.isCube&&(p=u.TEXTURE_CUBE_MAP_POSITIVE_X+o,f=u.TEXTURE_CUBE_MAP),this._bindTextureDirectly(f,e,!0),u.texSubImage2D(p,l,i,n,r,a,d,h,t),c&&this._gl.generateMipmap(p),this._bindTextureDirectly(f,null)}_uploadArrayBufferViewToTexture(e,t,i=0,n=0){const r=this._gl,a=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(a,e,!0),this._uploadDataToTextureDirectly(e,t,i,n),this._bindTextureDirectly(a,null,!0)}_prepareWebGLTextureContinuation(e,t,i,n,r){const a=this._gl;if(!a)return;const o=this._getSamplingParameters(r,!i);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,o.mag),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,o.min),!i&&!n&&a.generateMipmap(a.TEXTURE_2D),this._bindTextureDirectly(a.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,i,n,r,a,o,l,c=3){const u=this.getCaps().maxTextureSize,h=Math.min(u,this.needPOTTextures?_e.GetExponentOfTwo(n.width,u):n.width),d=Math.min(u,this.needPOTTextures?_e.GetExponentOfTwo(n.height,u):n.height),f=this._gl;if(f){if(!e._hardwareTexture){i&&i.removePendingData(e);return}this._bindTextureDirectly(f.TEXTURE_2D,e,!0),this._unpackFlipY(r===void 0?!0:!!r),e.baseWidth=n.width,e.baseHeight=n.height,e.width=h,e.height=d,e.isReady=!0,!l(h,d,n,t,e,()=>{this._prepareWebGLTextureContinuation(e,i,a,o,c)})&&this._prepareWebGLTextureContinuation(e,i,a,o,c)}}_setupFramebufferDepthAttachments(e,t,i,n,r=1){const a=this._gl;if(e&&t)return this._createRenderBuffer(i,n,r,a.DEPTH_STENCIL,a.DEPTH24_STENCIL8,a.DEPTH_STENCIL_ATTACHMENT);if(t){let o=a.DEPTH_COMPONENT16;return this._webGLVersion>1&&(o=a.DEPTH_COMPONENT32F),this._createRenderBuffer(i,n,r,o,o,a.DEPTH_ATTACHMENT)}return e?this._createRenderBuffer(i,n,r,a.STENCIL_INDEX8,a.STENCIL_INDEX8,a.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,i,n,r,a,o=!0){const c=this._gl.createRenderbuffer();return this._updateRenderBuffer(c,e,t,i,n,r,a,o)}_updateRenderBuffer(e,t,i,n,r,a,o,l=!0){const c=this._gl;return c.bindRenderbuffer(c.RENDERBUFFER,e),n>1&&c.renderbufferStorageMultisample?c.renderbufferStorageMultisample(c.RENDERBUFFER,n,a,t,i):c.renderbufferStorage(c.RENDERBUFFER,r,t,i),c.framebufferRenderbuffer(c.FRAMEBUFFER,o,c.RENDERBUFFER,e),l&&c.bindRenderbuffer(c.RENDERBUFFER,null),e}_releaseTexture(e){var t;this._deleteTexture((t=e._hardwareTexture)===null||t===void 0?void 0:t.underlyingResource),this.unbindAllTextures();const i=this._internalTexturesCache.indexOf(e);i!==-1&&this._internalTexturesCache.splice(i,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_releaseRenderTargetWrapper(e){const t=this._renderTargetWrapperCache.indexOf(e);t!==-1&&this._renderTargetWrapperCache.splice(t,1)}_deleteTexture(e){e&&this._gl.deleteTexture(e)}_setProgram(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let n=0;n<i.length;n++){const r=e.getUniform(i[n]);r&&(this._boundUniforms[n]=r)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,i=!1,n=!1){var r,a;let o=!1;const l=t&&t._associatedChannel>-1;if(i&&l&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||n){if(this._activateCurrentTexture(),t&&t.isMultiview)throw console.error(e,t),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,(a=(r=t==null?void 0:t._hardwareTexture)===null||r===void 0?void 0:r.underlyingResource)!==null&&a!==void 0?a:null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else i&&(o=!0,this._activateCurrentTexture());return l&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),o}_bindTexture(e,t,i){if(e===void 0)return;t&&(t._associatedChannel=e),this._activeChannel=e;const n=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(n,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,i,n){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))}_bindSamplerUniformToChannel(e,t){const i=this._boundUniforms[e];!i||i._currentState===t||(this._gl.uniform1i(i,t),i._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,i=!1,n=!1,r=""){if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video){this._activeChannel=e;const c=t.getInternalTexture();c&&(c._associatedChannel=e),t.update()}else if(t.delayLoadState===4)return t.delayLoad(),!1;let a;n?a=t.depthStencilTexture:t.isReady()?a=t.getInternalTexture():t.isCube?a=this.emptyCubeTexture:t.is3D?a=this.emptyTexture3D:t.is2DArray?a=this.emptyTexture2DArray:a=this.emptyTexture,!i&&a&&(a._associatedChannel=e);let o=!0;this._boundTexturesCache[e]===a&&(i||this._bindSamplerUniformToChannel(a._associatedChannel,e),o=!1),this._activeChannel=e;const l=this._getTextureTarget(a);if(o&&this._bindTextureDirectly(l,a,i),a&&!a.isMultiview){if(a.isCube&&a._cachedCoordinatesMode!==t.coordinatesMode){a._cachedCoordinatesMode=t.coordinatesMode;const c=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=c,t.wrapV=c}a._cachedWrapU!==t.wrapU&&(a._cachedWrapU=t.wrapU,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),a)),a._cachedWrapV!==t.wrapV&&(a._cachedWrapV=t.wrapV,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),a)),a.is3D&&a._cachedWrapR!==t.wrapR&&(a._cachedWrapR=t.wrapR,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),a)),this._setAnisotropicLevel(l,a,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,i,n){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==i.length)&&(this._textureUnits=new Int32Array(i.length));for(let r=0;r<i.length;r++){const a=i[r].getInternalTexture();a?(this._textureUnits[r]=e+r,a._associatedChannel=e+r):this._textureUnits[r]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let r=0;r<i.length;r++)this._setTexture(this._textureUnits[r],i[r],!0)}}_setAnisotropicLevel(e,t,i){const n=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(i=1),n&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,n.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)}_setTextureParameterFloat(e,t,i,n){this._bindTextureDirectly(e,n,!0,!0),this._gl.texParameterf(e,t,i)}_setTextureParameterInteger(e,t,i,n){n&&this._bindTextureDirectly(e,n,!0,!0),this._gl.texParameteri(e,t,i)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}dispose(){var e;this._isDisposed=!0,this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),(e=this.releaseComputeEffects)===null||e===void 0||e.call(this),this.unbindAllAttributes(),this._boundUniforms={},vi()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,bi.ResetCache();for(const t of this._activeRequests)t.abort();this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){const t=this._gl;for(;t.getError()!==t.NO_ERROR;);let i=!0;const n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const r=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,r),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,n,0);const a=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&a===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);const o=t.RGBA,l=t.UNSIGNED_BYTE,c=new Uint8Array(4);t.readPixels(0,0,1,1,o,l,c),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(n),t.deleteFramebuffer(r),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:i=this._gl.RED;break;case 7:i=this._gl.RG;break;case 4:i=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER;break}return i}_getRGBABufferInternalSizedFormat(e,t,i=!1){if(this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}_getRGBAMultiSampleBufferFormat(e,t=5){switch(e){case 1:switch(t){case 6:return this._gl.R32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;default:return this._gl.RGBA16F}}return this._gl.RGBA8}_loadFile(e,t,i,n,r,a){const o=_e._FileToolsLoadFile(e,t,i,n,r,a);return this._activeRequests.push(o),o.onCompleteObservable.add(l=>{this._activeRequests.splice(this._activeRequests.indexOf(l),1)}),o}static _FileToolsLoadFile(e,t,i,n,r,a){throw De("FileTools")}readPixels(e,t,i,n,r=!0,a=!0){const o=r?4:3,l=r?this._gl.RGBA:this._gl.RGB,c=new Uint8Array(n*i*o);return a&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,n,l,this._gl.UNSIGNED_BYTE,c),Promise.resolve(c)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{const e=this._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch(e){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{const e=this._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch(e){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}static CeilingPOT(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e}static FloorPOT(e){return e=e|e>>1,e=e|e>>2,e=e|e>>4,e=e|e>>8,e=e|e>>16,e-(e>>1)}static NearestPOT(e){const t=_e.CeilingPOT(e),i=_e.FloorPOT(e);return t-e>e-i?i:t}static GetExponentOfTwo(e,t,i=2){let n;switch(i){case 1:n=_e.FloorPOT(e);break;case 2:n=_e.NearestPOT(e);break;case 3:default:n=_e.CeilingPOT(e);break}return Math.min(n,t)}static QueueNewFrame(e,t){if(vi()){const{requestAnimationFrame:i}=t||window;if(typeof i=="function")return i(e)}else if(typeof requestAnimationFrame=="function")return requestAnimationFrame(e);return setTimeout(e,16)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:cl()?document:null}}_e._TempClearColorUint32=new Uint32Array(4);_e._TempClearColorInt32=new Int32Array(4);_e.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}];_e._TextureLoaders=[];_e.CollisionsEpsilon=.001;_e._IsSupported=null;_e._HasMajorPerformanceCaveat=null;class yu{static SetImmediate(e){vi()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)}}const dE=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class wl extends Os{constructor(e,t){super(e,Fr.LoadFileError),this.name="LoadFileError",yo._setPrototypeOf(this,wl.prototype),t instanceof ln?this.request=t:this.file=t}}class Au extends Os{constructor(e,t){super(e,Fr.RequestFileError),this.request=t,this.name="RequestFileError",yo._setPrototypeOf(this,Au.prototype)}}class Zp extends Os{constructor(e,t){super(e,Fr.ReadFileError),this.file=t,this.name="ReadFileError",yo._setPrototypeOf(this,Zp.prototype)}}const xi={DefaultRetryStrategy:fT.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:s=>s},fE=s=>(s=s.replace(/#/gm,"%23"),s),qp=(s,e)=>{if(!(s&&s.indexOf("data:")===0)&&xi.CorsBehavior)if(typeof xi.CorsBehavior=="string"||xi.CorsBehavior instanceof String)e.crossOrigin=xi.CorsBehavior;else{const t=xi.CorsBehavior(s);t&&(e.crossOrigin=t)}},Zl=(s,e,t,i,n="",r)=>{var a;let o,l=!1;s instanceof ArrayBuffer||ArrayBuffer.isView(s)?typeof Blob!="undefined"&&typeof URL!="undefined"?(o=URL.createObjectURL(new Blob([s],{type:n})),l=!0):o=`data:${n};base64,`+Qp(s):s instanceof Blob?(o=URL.createObjectURL(s),l=!0):(o=fE(s),o=xi.PreprocessUrl(s));const c=Fe.LastCreatedEngine,u=T=>{if(t){const R=o||s.toString();t(`Error while trying to load image: ${R.indexOf("http")===0||R.length<=128?R:R.slice(0,128)+"..."}`,T)}};if(typeof Image=="undefined"||(a=c==null?void 0:c._features.forceBitmapOverHTMLImageElement)!==null&&a!==void 0&&a)return Vr(o,T=>{c.createImageBitmap(new Blob([T],{type:n}),Object.assign({premultiplyAlpha:"none"},r)).then(R=>{e(R),l&&URL.revokeObjectURL(o)}).catch(R=>{t&&t("Error while trying to load image: "+s,R)})},void 0,i||void 0,!0,(T,R)=>{u(R)}),null;const h=new Image;qp(o,h);const d=[],f=()=>{d.forEach(T=>{T.target.addEventListener(T.name,T.handler)})},p=()=>{d.forEach(T=>{T.target.removeEventListener(T.name,T.handler)}),d.length=0},m=()=>{p(),e(h),l&&h.src&&URL.revokeObjectURL(h.src)},_=T=>{p(),u(T),l&&h.src&&URL.revokeObjectURL(h.src)},E=T=>{if(T.blockedURI!==h.src)return;p();const R=new Error(`CSP violation of policy ${T.effectiveDirective} ${T.blockedURI}. Current policy is ${T.originalPolicy}`);Fe.UseFallbackTexture=!1,u(R),l&&h.src&&URL.revokeObjectURL(h.src),h.src=""};d.push({target:h,name:"load",handler:m}),d.push({target:h,name:"error",handler:_}),d.push({target:document,name:"securitypolicyviolation",handler:E}),f();const v=o.substring(0,5)==="blob:",y=o.substring(0,5)==="data:",A=()=>{v||y?h.src=o:Vr(o,(T,R,x)=>{const F=!n&&x?x:n,L=new Blob([T],{type:F}),V=URL.createObjectURL(L);l=!0,h.src=V},void 0,i||void 0,!0,(T,R)=>{u(R)})},I=()=>{i&&i.loadImage(o,h)};if(!v&&!y&&i&&i.enableTexturesOffline)i.open(I,A);else{if(o.indexOf("file:")!==-1){const T=decodeURIComponent(o.substring(5).toLowerCase());if(ul.FilesToLoad[T]&&typeof URL!="undefined"){try{let R;try{R=URL.createObjectURL(ul.FilesToLoad[T])}catch(x){R=URL.createObjectURL(ul.FilesToLoad[T])}h.src=R,l=!0}catch(R){h.src=""}return h}}A()}return h},Fl=(s,e,t,i,n)=>{const r=new FileReader,a={onCompleteObservable:new O,abort:()=>r.abort()};return r.onloadend=()=>a.onCompleteObservable.notifyObservers(a),n&&(r.onerror=()=>{n(new Zp(`Unable to read ${s.name}`,s))}),r.onload=o=>{e(o.target.result)},t&&(r.onprogress=t),i?r.readAsArrayBuffer(s):r.readAsText(s),a},Vr=(s,e,t,i,n,r,a)=>{if(s.name)return Fl(s,e,t,n,r?u=>{r(void 0,u)}:void 0);const o=s;if(o.indexOf("file:")!==-1){let u=decodeURIComponent(o.substring(5).toLowerCase());u.indexOf("./")===0&&(u=u.substring(2));const h=ul.FilesToLoad[u];if(h)return Fl(h,e,t,n,r?d=>r(void 0,new wl(d.message,d.file)):void 0)}const{match:l,type:c}=FT(o);if(l){const u={onCompleteObservable:new O,abort:()=>()=>{}};try{const h=n?ql(o):mE(o);e(h,void 0,c)}catch(h){r?r(void 0,h):U.Error(h.message||"Failed to parse the Data URL")}return yu.SetImmediate(()=>{u.onCompleteObservable.notifyObservers(u)}),u}return jp(o,(u,h)=>{e(u,h==null?void 0:h.responseURL,h==null?void 0:h.getResponseHeader("content-type"))},t,i,n,r?u=>{r(u.request,new wl(u.message,u.request))}:void 0,a)},jp=(s,e,t,i,n,r,a)=>{s=fE(s),s=xi.PreprocessUrl(s);const o=xi.BaseUrl+s;let l=!1;const c={onCompleteObservable:new O,abort:()=>l=!0},u=()=>{let h=new ln,d=null,f;const p=()=>{h&&(t&&h.removeEventListener("progress",t),f&&h.removeEventListener("readystatechange",f),h.removeEventListener("loadend",m))};let m=()=>{p(),c.onCompleteObservable.notifyObservers(c),c.onCompleteObservable.clear(),t=void 0,f=null,m=null,r=void 0,a=void 0,e=void 0};c.abort=()=>{l=!0,m&&m(),h&&h.readyState!==(XMLHttpRequest.DONE||4)&&h.abort(),d!==null&&(clearTimeout(d),d=null),h=null};const _=v=>{const y=v.message||"Unknown error";r&&h?r(new Au(y,h)):U.Error(y)},E=v=>{if(h){if(h.open("GET",o),a)try{a(h)}catch(y){_(y);return}n&&(h.responseType="arraybuffer"),t&&h.addEventListener("progress",t),m&&h.addEventListener("loadend",m),f=()=>{if(!(l||!h)&&h.readyState===(XMLHttpRequest.DONE||4)){if(f&&h.removeEventListener("readystatechange",f),h.status>=200&&h.status<300||h.status===0&&(!vi()||pE())){try{e&&e(n?h.response:h.responseText,h)}catch(I){_(I)}return}const y=xi.DefaultRetryStrategy;if(y){const I=y(o,h,v);if(I!==-1){p(),h=new ln,d=setTimeout(()=>E(v+1),I);return}}const A=new Au("Error status: "+h.status+" "+h.statusText+" - Unable to load "+o,h);r&&r(A)}},h.addEventListener("readystatechange",f),h.send()}};E(0)};if(i&&i.enableSceneOffline){const h=f=>{f&&f.status>400?r&&r(f):u()},d=()=>{i&&i.loadFile(xi.BaseUrl+s,f=>{!l&&e&&e(f),c.onCompleteObservable.notifyObservers(c)},t?f=>{!l&&t&&t(f)}:void 0,h,n)};i.open(d,h)}else u();return c},pE=()=>typeof location!="undefined"&&location.protocol==="file:",ju=s=>dE.test(s),FT=s=>{const e=dE.exec(s);return e===null||e.length===0?{match:!1,type:""}:{match:!0,type:e[0].replace("data:","").replace("base64,","")}};function ql(s){return uE(s.split(",")[1])}const mE=s=>cE(s.split(",")[1]),LT=()=>{_e._FileToolsLoadImage=Zl,_e._FileToolsLoadFile=Vr,xs._FileToolsLoadFile=Vr};LT();let Xo;const NT=(s,e,t,i,n,r,a,o,l,c)=>{Xo={DecodeBase64UrlToBinary:s,DecodeBase64UrlToString:e,DefaultRetryStrategy:t.DefaultRetryStrategy,BaseUrl:t.BaseUrl,CorsBehavior:t.CorsBehavior,PreprocessUrl:t.PreprocessUrl,IsBase64DataUrl:i,IsFileURL:n,LoadFile:r,LoadImage:a,ReadFile:o,RequestFile:l,SetCorsBehavior:c},Object.defineProperty(Xo,"DefaultRetryStrategy",{get:function(){return t.DefaultRetryStrategy},set:function(u){t.DefaultRetryStrategy=u}}),Object.defineProperty(Xo,"BaseUrl",{get:function(){return t.BaseUrl},set:function(u){t.BaseUrl=u}}),Object.defineProperty(Xo,"PreprocessUrl",{get:function(){return t.PreprocessUrl},set:function(u){t.PreprocessUrl=u}}),Object.defineProperty(Xo,"CorsBehavior",{get:function(){return t.CorsBehavior},set:function(u){t.CorsBehavior=u}})};NT(ql,mE,xi,ju,pE,Vr,Zl,Fl,jp,qp);class dl{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];const t=hn(e);if(t)return t;U.Warn(e+" not found, you may have missed an import.");const i=e.split(".");let n=window||this;for(let r=0,a=i.length;r<a;r++)n=n[i[r]];return typeof n!="function"?null:n}}dl.RegisteredExternalClasses={};function $p(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}class q{static get BaseUrl(){return xi.BaseUrl}static set BaseUrl(e){xi.BaseUrl=e}static get DefaultRetryStrategy(){return xi.DefaultRetryStrategy}static set DefaultRetryStrategy(e){xi.DefaultRetryStrategy=e}static get CorsBehavior(){return xi.CorsBehavior}static set CorsBehavior(e){xi.CorsBehavior=e}static get UseFallbackTexture(){return Fe.UseFallbackTexture}static set UseFallbackTexture(e){Fe.UseFallbackTexture=e}static get RegisteredExternalClasses(){return dl.RegisteredExternalClasses}static set RegisteredExternalClasses(e){dl.RegisteredExternalClasses=e}static get fallbackTexture(){return Fe.FallbackTexture}static set fallbackTexture(e){Fe.FallbackTexture=e}static FetchToRef(e,t,i,n,r,a){const o=Math.abs(e)*i%i|0,l=Math.abs(t)*n%n|0,c=(o+l*i)*4;a.r=r[c]/255,a.g=r[c+1]/255,a.b=r[c+2]/255,a.a=r[c+3]/255}static Mix(e,t,i){return e*(1-i)+t*i}static Instantiate(e){return dl.Instantiate(e)}static SetImmediate(e){yu.SetImmediate(e)}static IsExponentOfTwo(e){let t=1;do t*=2;while(t<e);return t===e}static FloatRound(e){return Math.fround?Math.fround(e):(q._TmpFloatArray[0]=e,q._TmpFloatArray[0])}static GetFilename(e){const t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){const i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}static ToDegrees(e){return e*180/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,i=.9){const n=this.ToRadians(e),r=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(r)+i*Math.sin(n),(1-i)*Math.cos(r)+i*Math.cos(n)))}static MakeArray(e,t){return t!==!0&&(e===void 0||e==null)?null:Array.isArray(e)?e:[e]}static GetPointerPrefix(e){let t="pointer";return vi()&&!window.PointerEvent&&(t="mouse"),e._badDesktopOS&&!e._badOS&&!(document&&"ontouchend"in document)&&(t="mouse"),t}static SetCorsBehavior(e,t){qp(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static CleanUrl(e){return e=e.replace(/#/gm,"%23"),e}static get PreprocessUrl(){return xi.PreprocessUrl}static set PreprocessUrl(e){xi.PreprocessUrl=e}static LoadImage(e,t,i,n,r,a){return Zl(e,t,i,n,r,a)}static LoadFile(e,t,i,n,r,a){return Vr(e,t,i,n,r,a)}static LoadFileAsync(e,t=!0){return new Promise((i,n)=>{Vr(e,r=>{i(r)},void 0,void 0,t,(r,a)=>{n(a)})})}static LoadScript(e,t,i,n){if(typeof importScripts=="function"){try{importScripts(e),t()}catch(o){i==null||i(`Unable to load script '${e}' in worker`,o)}return}else if(!vi()){i==null||i(`Cannot load script '${e}' outside of a window or a worker`);return}const r=document.getElementsByTagName("head")[0],a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("src",e),n&&(a.id=n),a.onload=()=>{t&&t()},a.onerror=o=>{i&&i(`Unable to load script '${e}'`,o)},r.appendChild(a)}static LoadScriptAsync(e){return new Promise((t,i)=>{this.LoadScript(e,()=>{t()},(n,r)=>{i(r||new Error(n))})})}static ReadFileAsDataURL(e,t,i){const n=new FileReader,r={onCompleteObservable:new O,abort:()=>n.abort()};return n.onloadend=()=>{r.onCompleteObservable.notifyObservers(r)},n.onload=a=>{t(a.target.result)},n.onprogress=i,n.readAsDataURL(e),r}static ReadFile(e,t,i,n,r){return Fl(e,t,i,n,r)}static FileAsURL(e){const t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,i,n){On.DeepCopy(e,t,i,n)}static IsEmpty(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const n=t[i];e.addEventListener(n.name,n.handler,!1);try{window.parent&&window.parent.addEventListener(n.name,n.handler,!1)}catch(r){}}}static UnregisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const n=t[i];e.removeEventListener(n.name,n.handler);try{e.parent&&e.parent.removeEventListener(n.name,n.handler)}catch(r){}}}static DumpFramebuffer(e,t,i,n,r="image/png",a,o){return Ie(this,null,function*(){throw De("DumpTools")})}static DumpData(e,t,i,n,r="image/png",a,o=!1,l=!1,c){throw De("DumpTools")}static DumpDataAsync(e,t,i,n="image/png",r,a=!1,o=!1,l){throw De("DumpTools")}static _IsOffScreenCanvas(e){return e.convertToBlob!==void 0}static ToBlob(e,t,i="image/png",n){!q._IsOffScreenCanvas(e)&&!e.toBlob&&(e.toBlob=function(r,a,o){setTimeout(()=>{const l=atob(this.toDataURL(a,o).split(",")[1]),c=l.length,u=new Uint8Array(c);for(let h=0;h<c;h++)u[h]=l.charCodeAt(h);r(new Blob([u]))})}),q._IsOffScreenCanvas(e)?e.convertToBlob({type:i,quality:n}).then(r=>t(r)):e.toBlob(function(r){t(r)},i,n)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){const i=new Date;t="screenshot_"+((i.getFullYear()+"-"+(i.getMonth()+1)).slice(2)+"-"+i.getDate()+"_"+i.getHours()+"-"+("0"+i.getMinutes()).slice(-2))+".png"}q.Download(e,t)}else if(e&&typeof URL!="undefined"){const i=URL.createObjectURL(e),n=window.open("");if(!n)return;const r=n.document.createElement("img");r.onload=function(){URL.revokeObjectURL(i)},r.src=i,n.document.body.appendChild(r)}}static EncodeScreenshotCanvasData(e,t,i="image/png",n,r){if(typeof n=="string"||!t)this.ToBlob(e,function(a){a&&q.DownloadBlob(a,n),t&&t("")},i,r);else if(t){if(q._IsOffScreenCanvas(e)){e.convertToBlob({type:i,quality:r}).then(o=>{const l=new FileReader;l.readAsDataURL(o),l.onloadend=()=>{const c=l.result;t(c)}});return}const a=e.toDataURL(i,r);t(a)}}static Download(e,t){if(typeof URL=="undefined")return;const i=window.URL.createObjectURL(e),n=document.createElement("a");document.body.appendChild(n),n.style.display="none",n.href=i,n.download=t,n.addEventListener("click",()=>{n.parentElement&&n.parentElement.removeChild(n)}),n.click(),window.URL.revokeObjectURL(i)}static BackCompatCameraNoPreventDefault(e){return typeof e[0]=="boolean"?e[0]:typeof e[1]=="boolean"?e[1]:!1}static CreateScreenshot(e,t,i,n,r="image/png",a=!1,o){throw De("ScreenshotTools")}static CreateScreenshotAsync(e,t,i,n="image/png",r){throw De("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,i,n,r="image/png",a=1,o=!1,l,c=!1,u=!1,h=!0,d){throw De("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(e,t,i,n="image/png",r=1,a=!1,o,l=!1,c=!1,u=!0,h){throw De("ScreenshotTools")}static RandomId(){return $p()}static IsBase64(e){return ju(e)}static DecodeBase64(e){return ql(e)}static get errorsCount(){return U.errorsCount}static Log(e){U.Log(e)}static Warn(e){U.Warn(e)}static Error(e){U.Error(e)}static get LogCache(){return U.LogCache}static ClearLogCache(){U.ClearLogCache()}static set LogLevels(e){U.LogLevels=e}static set PerformanceLogLevel(e){if((e&q.PerformanceUserMarkLogLevel)===q.PerformanceUserMarkLogLevel){q.StartPerformanceCounter=q._StartUserMark,q.EndPerformanceCounter=q._EndUserMark;return}if((e&q.PerformanceConsoleLogLevel)===q.PerformanceConsoleLogLevel){q.StartPerformanceCounter=q._StartPerformanceConsole,q.EndPerformanceCounter=q._EndPerformanceConsole;return}q.StartPerformanceCounter=q._StartPerformanceCounterDisabled,q.EndPerformanceCounter=q._EndPerformanceCounterDisabled}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!q._Performance){if(!vi())return;q._Performance=window.performance}!t||!q._Performance.mark||q._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){!t||!q._Performance.mark||(q._Performance.mark(e+"-End"),q._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){t&&(q._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){t&&(q._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return Mn.Now}static GetClassName(e,t=!1){let i=null;return!t&&e.getClassName?i=e.getClassName():(e instanceof Object&&(i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),i||(i=typeof e)),i}static First(e,t){for(const i of e)if(t(i))return i;return null}static getFullClassName(e,t=!1){let i=null,n=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){const r=t?e:Object.getPrototypeOf(e);i=r.constructor.__bjsclassName__,n=r.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(n!=null?n+".":"")+i:null}static DelayAsync(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}static IsSafari(){return Kc()?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1}}q.UseCustomRequestHeaders=!1;q.CustomRequestHeaders=ln.CustomRequestHeaders;q._TmpFloatArray=new Float32Array(1);q.GetDOMTextContent=lE;q.GetAbsoluteUrl=typeof document=="object"?s=>{const e=document.createElement("a");return e.href=s,e.href}:typeof URL=="function"&&typeof location=="object"?s=>new URL(s,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")};q.NoneLogLevel=U.NoneLogLevel;q.MessageLogLevel=U.MessageLogLevel;q.WarningLogLevel=U.WarningLogLevel;q.ErrorLogLevel=U.ErrorLogLevel;q.AllLogLevel=U.AllLogLevel;q.IsWindowObjectExist=vi;q.PerformanceNoneLogLevel=0;q.PerformanceUserMarkLogLevel=1;q.PerformanceConsoleLogLevel=2;q.StartPerformanceCounter=q._StartPerformanceCounterDisabled;q.EndPerformanceCounter=q._EndPerformanceCounterDisabled;class Tu{constructor(e,t,i,n=0){this.iterations=e,this.index=n-1,this._done=!1,this._fn=t,this._successCallback=i}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,t,i,n=0){const r=new Tu(e,t,i,n);return r.executeNext(),r}static SyncAsyncForLoop(e,t,i,n,r,a=0){return Tu.Run(Math.ceil(e/t),o=>{r&&r()?o.breakLoop():setTimeout(()=>{for(let l=0;l<t;++l){const c=o.index*t+l;if(c>=e)break;if(i(c),r&&r()){o.breakLoop();break}}o.executeNext()},a)},n)}}Fe.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";function S(s,e,t,i){var n=arguments.length,r=n<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(s,e,t,i);else for(var o=s.length-1;o>=0;o--)(a=s[o])&&(r=(n<3?a(r):n>3?a(e,t,r):a(e,t))||r);return n>3&&r&&Object.defineProperty(e,t,r),r}class ta{static Eval(e,t){return e.match(/\([^()]*\)/g)?e=e.replace(/\([^()]*\)/g,i=>(i=i.slice(1,i.length-1),ta._HandleParenthesisContent(i,t))):e=ta._HandleParenthesisContent(e,t),e==="true"?!0:e==="false"?!1:ta.Eval(e,t)}static _HandleParenthesisContent(e,t){t=t||(r=>r==="true");let i;const n=e.split("||");for(const r in n)if(Object.prototype.hasOwnProperty.call(n,r)){let a=ta._SimplifyNegation(n[r].trim());const o=a.split("&&");if(o.length>1)for(let l=0;l<o.length;++l){const c=ta._SimplifyNegation(o[l].trim());if(c!=="true"&&c!=="false"?c[0]==="!"?i=!t(c.substring(1)):i=t(c):i=c==="true",!i){a="false";break}}if(i||a==="true"){i=!0;break}a!=="true"&&a!=="false"?a[0]==="!"?i=!t(a.substring(1)):i=t(a):i=a==="true"}return i?"true":"false"}static _SimplifyNegation(e){return e=e.replace(/^[\s!]+/,t=>(t=t.replace(/[\s]/g,()=>""),t.length%2?"!":"")),e=e.trim(),e==="!true"?e="false":e==="!false"&&(e="true"),e}}class Ye{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>Ye.HasTags(e),e.addTags=t=>Ye.AddTagsTo(e,t),e.removeTags=t=>Ye.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>Ye.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const t=e._tags;for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){const i=[];for(const n in e._tags)Object.prototype.hasOwnProperty.call(e._tags,n)&&e._tags[n]===!0&&i.push(n);return i.join(" ")}else return e._tags}static AddTagsTo(e,t){if(!t||typeof t!="string")return;t.split(" ").forEach(function(n){Ye._AddTagTo(e,n)})}static _AddTagTo(e,t){t=t.trim(),!(t===""||t==="true"||t==="false")&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(Ye.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!Ye.HasTags(e))return;const i=t.split(" ");for(const n in i)Ye._RemoveTagFrom(e,i[n])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return t===void 0?!0:t===""?Ye.HasTags(e):ta.Eval(t,i=>Ye.HasTags(e)&&e._tags[i])}}const Qc={},Mc={},D_=function(s,e,t,i={}){const n=s();Ye&&Ye.HasTags(e)&&Ye.AddTagsTo(n,Ye.GetTags(e,!0));const r=Jd(n),a={};for(const o in r){const l=r[o],c=e[o],u=l.type;if(c!=null&&(o!=="uniqueId"||Pe.AllowLoadingUniqueId))switch(u){case 0:case 6:case 11:n[o]=c;break;case 1:i.cloneTexturesOnlyOnce&&a[c.uniqueId]?n[o]=a[c.uniqueId]:(n[o]=t||c.isRenderTarget?c:c.clone(),a[c.uniqueId]=n[o]);break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:n[o]=t?c:c.clone();break}}return n};function BT(s){const e=s.getClassName();return Qc[e]||(Qc[e]={}),Qc[e]}function Jd(s){const e=s.getClassName();if(Mc[e])return Mc[e];Mc[e]={};const t=Mc[e];let i=s,n=e;for(;n;){const r=Qc[n];for(const l in r)t[l]=r[l];let a,o=!1;do{if(a=Object.getPrototypeOf(i),!a.getClassName){o=!0;break}if(a.getClassName()!==n)break;i=a}while(a);if(o)break;n=a.getClassName(),i=a}return t}function ss(s,e){return(t,i)=>{const n=BT(t);n[i]||(n[i]={type:s,sourceName:e})}}function kT(s,e=null){return(t,i)=>{const n=e||"_"+i;Object.defineProperty(t,i,{get:function(){return this[n]},set:function(r){typeof this.equals=="function"&&this.equals(r)||this[n]!==r&&(this[n]=r,t[s].apply(this))},enumerable:!0,configurable:!0})}}function K(s,e=null){return kT(s,e)}function b(s){return ss(0,s)}function ht(s){return ss(1,s)}function Gi(s){return ss(2,s)}function jl(s){return ss(3,s)}function _E(s){return ss(4,s)}function gn(s){return ss(5,s)}function gE(s){return ss(6,s)}function UT(s){return ss(7,s)}function EE(s){return ss(8,s)}function VT(s){return ss(9,s)}function GT(s){return ss(10,s)}function vE(s){return ss(12,s)}class Pe{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let i=0;i<e.animations.length;i++){const n=e.animations[i];t.animations.push(n.serialize())}}}static Serialize(e,t){t||(t={}),Ye&&(t.tags=Ye.GetTags(e));const i=Jd(e);for(const n in i){const r=i[n],a=r.sourceName||n,o=r.type,l=e[n];if(l!=null&&(n!=="uniqueId"||Pe.AllowLoadingUniqueId))switch(o){case 0:t[a]=l;break;case 1:t[a]=l.serialize();break;case 2:t[a]=l.asArray();break;case 3:t[a]=l.serialize();break;case 4:t[a]=l.asArray();break;case 5:t[a]=l.asArray();break;case 6:t[a]=l.id;break;case 7:t[a]=l.serialize();break;case 8:t[a]=l.asArray();break;case 9:t[a]=l.serialize();break;case 10:t[a]=l.asArray();break;case 11:t[a]=l.id;break;case 12:t[a]=l.asArray();break}}return t}static ParseProperties(e,t,i,n){n||(n="");const r=Jd(t);for(const a in r){const o=r[a],l=e[o.sourceName||a],c=o.type;if(l!=null&&(a!=="uniqueId"||Pe.AllowLoadingUniqueId)){const u=t;switch(c){case 0:u[a]=l;break;case 1:i&&(u[a]=Pe._TextureParser(l,i,n));break;case 2:u[a]=G.FromArray(l);break;case 3:u[a]=Pe._FresnelParametersParser(l);break;case 4:u[a]=j.FromArray(l);break;case 5:u[a]=g.FromArray(l);break;case 6:i&&(u[a]=i.getLastMeshById(l));break;case 7:u[a]=Pe._ColorCurvesParser(l);break;case 8:u[a]=pe.FromArray(l);break;case 9:u[a]=Pe._ImageProcessingConfigurationParser(l);break;case 10:u[a]=ee.FromArray(l);break;case 11:i&&(u[a]=i.getCameraById(l));break;case 12:u[a]=D.FromArray(l);break}}}}static Parse(e,t,i,n=null){const r=e();return Ye&&Ye.AddTagsTo(r,t.tags),Pe.ParseProperties(t,r,i,n),r}static Clone(e,t,i={}){return D_(e,t,!1,i)}static Instanciate(e,t){return D_(e,t,!0)}}Pe.AllowLoadingUniqueId=!1;Pe._ImageProcessingConfigurationParser=s=>{throw De("ImageProcessingConfiguration")};Pe._FresnelParametersParser=s=>{throw De("FresnelParameters")};Pe._ColorCurvesParser=s=>{throw De("ColorCurves")};Pe._TextureParser=(s,e,t)=>{throw De("Texture")};function Gr(s,e,t,i){const n=t.value;t.value=(...r)=>{let a=n;if(typeof _native!="undefined"&&_native[e]){const o=_native[e];i?a=(...l)=>i(...l)?o(...l):n(...l):a=o}return s[e]=a,a(...r)}}Gr.filter=function(s){return(e,t,i)=>Gr(e,t,i,s)};class Mi{constructor(e){this.length=0,this.data=new Array(e),this._id=Mi._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){const t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return this.indexOf(e)!==-1}}Mi._GlobalId=0;class Jr extends Mi{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(e),!0)}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++){const i=(e.data||e)[t];this.pushNoDuplicate(i)}}}}class zT{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new O,this._onClonedObservable=new O}}let oi=class ef{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,n){const r=this._NodeConstructors[e];return r?r(t,i,n):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return this._nodeDataStorage._doNotSerialize?!0:this._parentNode?this._parentNode.doNotSerialize:!1}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const t=this._parentNode;if(this._parentNode&&this._parentNode._children!==void 0&&this._parentNode._children!==null){const i=this._parentNode._children.indexOf(this);i!==-1&&this._parentNode._children.splice(i,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._parentNode&&((this._parentNode._children===void 0||this._parentNode._children===null)&&(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){this._nodeDataStorage._sceneRootNodesIndex===-1&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(this._nodeDataStorage._sceneRootNodesIndex!==-1){const e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null){this._isDirty=!1,this._nodeDataStorage=new zT,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new O,this._parentContainer=null,this.animations=new Array,this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=D.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new O,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||Fe.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return this._behaviors.indexOf(e)!==-1?this:(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(()=>{e.attach(this)}):e.attach(this),this._behaviors.push(e),this)}removeBehavior(e){const t=this._behaviors.indexOf(e);return t===-1?this:(this._behaviors[t].detach(),this._behaviors.splice(t,1),this)}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={},this._cache.parent=void 0}updateCache(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return this._parentNode?this._parentNode._isDirty||this._parentUpdateId!==this._parentNode._childUpdateId?!1:this._parentNode.isSynchronized():!0}isSynchronized(){return this._cache.parent!==this._parentNode?(this._cache.parent=this._parentNode,!1):this._parentNode&&!this.isSynchronizedWithParent()?!1:this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return e===!1?this._nodeDataStorage._isEnabled:this._nodeDataStorage._isEnabled?this._nodeDataStorage._isParentEnabled:!1}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=this._parentNode?this._parentNode.isEnabled():!0,this._children&&this._children.forEach(e=>{e._syncParentEnabledState()})}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1}_getDescendants(e,t=!1,i){if(this._children)for(let n=0;n<this._children.length;n++){const r=this._children[n];(!i||i(r))&&e.push(r),t||r._getDescendants(e,!1,i)}}getDescendants(e,t){const i=new Array;return this._getDescendants(i,e,t),i}getChildMeshes(e,t){const i=[];return this._getDescendants(i,e,n=>(!t||t(n))&&n.cullingStrategy!==void 0),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){if(e!==this._nodeDataStorage._isReady){if(!e){this._nodeDataStorage._isReady=!1;return}this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){const i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=ef._AnimationRangeFactory(e,t,i);for(let n=0,r=this.animations.length;n<r;n++)this.animations[n]&&this.animations[n].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,n=this.animations.length;i<n;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}clone(e,t,i){const n=Pe.Clone(()=>new ef(e,this.getScene()),this);if(t&&(n.parent=t),!i){const r=this.getDescendants(!0);for(let a=0;a<r.length;a++){const o=r[a];o.clone(e+"."+o.name,n)}}return n}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,n){const r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,t,i,n):null}serializeAnimationRanges(){const e=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const n={};n.name=t,n.from=i.from,n.to=i.to,e.push(n)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=D.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){const i=this.getDescendants(!0);for(const n of i)n.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const i of this._behaviors)i.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let n=0;n<t.ranges.length;n++){const r=t.ranges[n];e.createAnimationRange(r.name,r.from,r.to)}}getHierarchyBoundingVectors(e=!0,t=null){this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);let i,n;const r=this;if(r.getBoundingInfo&&r.subMeshes){const a=r.getBoundingInfo();i=a.boundingBox.minimumWorld.clone(),n=a.boundingBox.maximumWorld.clone()}else i=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new g(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const a=this.getDescendants(!1);for(const o of a){const l=o;if(l.computeWorldMatrix(!0),t&&!t(l)||!l.getBoundingInfo||l.getTotalVertices()===0)continue;const u=l.getBoundingInfo().boundingBox,h=u.minimumWorld,d=u.maximumWorld;g.CheckExtends(h,i,n),g.CheckExtends(d,i,n)}}return{min:i,max:n}}};oi._AnimationRangeFactory=(s,e,t)=>{throw De("AnimationRange")};oi._NodeConstructors={};S([b()],oi.prototype,"name",void 0);S([b()],oi.prototype,"id",void 0);S([b()],oi.prototype,"uniqueId",void 0);S([b()],oi.prototype,"state",void 0);S([b()],oi.prototype,"metadata",void 0);class Ll{constructor(e,t,i,n){this.x=e,this.y=t,this.width=i,this.height=n}toGlobal(e,t){return new Ll(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new Ll(this.x,this.y,this.width,this.height)}}class Zn{constructor(e,t,i,n){this.normal=new g(e,t,i),this.d=n}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new Zn(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=e*397^(this.d|0),e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return e!==0&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=Zn._TmpMatrix;e.invertToRef(t);const i=t.m,n=this.normal.x,r=this.normal.y,a=this.normal.z,o=this.d,l=n*i[0]+r*i[1]+a*i[2]+o*i[3],c=n*i[4]+r*i[5]+a*i[6]+o*i[7],u=n*i[8]+r*i[9]+a*i[10]+o*i[11],h=n*i[12]+r*i[13]+a*i[14]+o*i[15];return new Zn(l,c,u,h)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){const n=t.x-e.x,r=t.y-e.y,a=t.z-e.z,o=i.x-e.x,l=i.y-e.y,c=i.z-e.z,u=r*c-a*l,h=a*o-n*c,d=n*l-r*o,f=Math.sqrt(u*u+h*h+d*d);let p;return f!==0?p=1/f:p=0,this.normal.x=u*p,this.normal.y=h*p,this.normal.z=d*p,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return g.Dot(this.normal,e)<=t}signedDistanceTo(e){return g.Dot(e,this.normal)+this.d}static FromArray(e){return new Zn(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){const n=new Zn(0,0,0,0);return n.copyFromPoints(e,t,i),n}static FromPositionAndNormal(e,t){const i=new Zn(0,0,0,0);return t.normalize(),i.normal=t,i.d=-(t.x*e.x+t.y*e.y+t.z*e.z),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){const n=-(t.x*e.x+t.y*e.y+t.z*e.z);return g.Dot(i,t)+n}}Zn._TmpMatrix=D.Identity();class Yn{static GetPlanes(e){const t=[];for(let i=0;i<6;i++)t.push(new Zn(0,0,0,0));return Yn.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}static GetFarPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}static GetLeftPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}static GetRightPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}static GetTopPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}static GetBottomPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}static GetPlanesToRef(e,t){Yn.GetNearPlaneToRef(e,t[0]),Yn.GetFarPlaneToRef(e,t[1]),Yn.GetLeftPlaneToRef(e,t[2]),Yn.GetRightPlaneToRef(e,t[3]),Yn.GetTopPlaneToRef(e,t[4]),Yn.GetBottomPlaneToRef(e,t[5])}static IsPointInFrustum(e,t){for(let i=0;i<6;i++)if(t[i].dotCoordinate(e)<0)return!1;return!0}}class Ee extends oi{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){var e,t,i,n;let r=0,a=0;if(this.mode===Ee.PERSPECTIVE_CAMERA)this.fovMode===Ee.FOVMODE_VERTICAL_FIXED?(a=this.minZ*2*Math.tan(this.fov/2),r=this.getEngine().getAspectRatio(this)*a):(r=this.minZ*2*Math.tan(this.fov/2),a=r/this.getEngine().getAspectRatio(this));else{const o=this.getEngine().getRenderWidth()/2,l=this.getEngine().getRenderHeight()/2;r=((e=this.orthoRight)!==null&&e!==void 0?e:o)-((t=this.orthoLeft)!==null&&t!==void 0?t:-o),a=((i=this.orthoTop)!==null&&i!==void 0?i:l)-((n=this.orthoBottom)!==null&&n!==void 0?n:-l)}return r*a}set orthoLeft(e){this._orthoLeft=e;for(const t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(const t of this._rigCameras)t.mode=e}get mode(){return this._mode}constructor(e,t,i,n=!0){super(e,i),this._position=g.Zero(),this._upVector=g.Up(),this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=Ee.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new Ll(0,0,1,1),this.layerMask=268435455,this.fovMode=Ee.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=Ee.RIG_MODE_NONE,this.customRenderTargets=new Array,this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new O,this.onProjectionMatrixChangedObservable=new O,this.onAfterCheckInputsObservable=new O,this.onRestoreStateObservable=new O,this.isRigCamera=!1,this._rigCameras=new Array,this._webvrViewMatrix=D.Identity(),this._skipRendering=!1,this._projectionMatrix=new D,this._postProcesses=new Array,this._activeMeshes=new Mi(256),this._globalPosition=g.Zero(),this._computedViewMatrix=D.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=D.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=ee.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),n&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}_restoreStateValues(){return this._stateStored?(this.fov=this._storedFov,!0):!1}restoreState(){return this._restoreStateValues()?(this.onRestoreStateObservable.notifyObservers(this),!0):!1}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}isReady(e=!1){if(e){for(const t of this._postProcesses)if(t&&!t.isReady())return!1}return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return super._isSynchronized()?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;const t=this.getEngine();return this.mode===Ee.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),e}attachControl(e,t){}detachControl(e){}update(){this._checkInputs(),this.cameraRigMode!==Ee.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(this._postProcesses[e]!==null)return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let t=0,i=this._rigCameras.length;t<i;t++){const n=this._rigCameras[t],r=n._rigPostProcess;r?(r.getEffectName()==="pass"&&(n.isIntermediate=this._postProcesses.length===0),n._postProcesses=this._postProcesses.slice(0).concat(r),r.markTextureDirty()):n._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(U.Error("You're trying to reuse a post process not defined as reusable."),0):(t==null||t<0?this._postProcesses.push(e):this._postProcesses[t]===null?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)}_getViewMatrix(){return D.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,e!==void 0&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){var t,i,n,r,a,o,l,c;if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;const u=this.getEngine(),h=this.getScene(),d=u.useReverseDepthBuffer;if(this.mode===Ee.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=u.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1);let f;h.useRightHandedSystem?f=D.PerspectiveFovRHToRef:f=D.PerspectiveFovLHToRef,f(this.fov,u.getAspectRatio(this),d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===Ee.FOVMODE_VERTICAL_FIXED,u.isNDCHalfZRange,this.projectionPlaneTilt,d)}else{const f=u.getRenderWidth()/2,p=u.getRenderHeight()/2;h.useRightHandedSystem?D.OrthoOffCenterRHToRef((t=this.orthoLeft)!==null&&t!==void 0?t:-f,(i=this.orthoRight)!==null&&i!==void 0?i:f,(n=this.orthoBottom)!==null&&n!==void 0?n:-p,(r=this.orthoTop)!==null&&r!==void 0?r:p,d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,u.isNDCHalfZRange):D.OrthoOffCenterLHToRef((a=this.orthoLeft)!==null&&a!==void 0?a:-f,(o=this.orthoRight)!==null&&o!==void 0?o:f,(l=this.orthoBottom)!==null&&l!==void 0?l:-p,(c=this.orthoTop)!==null&&c!==void 0?c:p,d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,u.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=u.getRenderWidth(),this._cache.renderHeight=u.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?Yn.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Yn.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let i=!1;return this.rigCameras.forEach(n=>{n._updateFrustumPlanes(),i=i||e.isInFrustum(n._frustumPlanes)}),i}else return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw De("Ray")}getForwardRayToRef(e,t=100,i,n){throw De("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const n=this._rigCameras.pop();n&&n.dispose()}if(this._parentContainer){const n=this._parentContainer.cameras.indexOf(this);n>-1&&this._parentContainer.cameras.splice(n,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==Ee.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let n=this._postProcesses.length;for(;--n>=0;){const r=this._postProcesses[n];r&&r.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const i=this._rigCameras.pop();i&&i.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=q.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==Ee.RIG_MODE_NONE){const i=this.createRigCamera(this.name+"_L",0);i&&(i._isLeftCamera=!0);const n=this.createRigCamera(this.name+"_R",1);n&&(n._isRightCamera=!0),i&&n&&(this._rigCameras.push(i),this._rigCameras.push(n))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return D.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}_updateCameraRotationMatrix(){}_updateWebVRCameraRotationMatrix(){}_getWebVRProjectionMatrix(){return D.Identity()}_getWebVRViewMatrix(){return D.Identity()}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,e==="interaxialDistance"&&(this._cameraRigParams.stereoHalfAngle=q.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===Ee.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){const e=Pe.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),Pe.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){const i=Pe.Clone(Ee.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){const t=g.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){g.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,n=0,r=!0){const a=oi.Construct(e,t,i,{interaxial_distance:n,isStereoscopicSideBySide:r});return a||(()=>Ee._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){const i=e.type,n=Ee.GetConstructorFromName(i,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),r=Pe.Parse(n,e,t);if(e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),r.inputs&&(r.inputs.parse(e),r._setupInputs()),e.upVector&&(r.upVector=g.FromArray(e.upVector)),r.setPosition&&(r.position.copyFromFloats(0,0,0),r.setPosition(g.FromArray(e.position))),e.target&&r.setTarget&&r.setTarget(g.FromArray(e.target)),e.cameraRigMode){const a=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};r.setCameraRigMode(e.cameraRigMode,a)}if(e.animations){for(let a=0;a<e.animations.length;a++){const o=e.animations[a],l=hn("BABYLON.Animation");l&&r.animations.push(l.Parse(o))}oi.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&r.setEnabled(e.isEnabled),r}}Ee._CreateDefaultParsedCamera=(s,e)=>{throw De("UniversalCamera")};Ee.PERSPECTIVE_CAMERA=0;Ee.ORTHOGRAPHIC_CAMERA=1;Ee.FOVMODE_VERTICAL_FIXED=0;Ee.FOVMODE_HORIZONTAL_FIXED=1;Ee.RIG_MODE_NONE=0;Ee.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;Ee.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;Ee.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;Ee.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;Ee.RIG_MODE_STEREOSCOPIC_INTERLACED=14;Ee.RIG_MODE_VR=20;Ee.RIG_MODE_WEBVR=21;Ee.RIG_MODE_CUSTOM=22;Ee.ForceAttachControlToAlwaysPreventDefault=!1;S([gn("position")],Ee.prototype,"_position",void 0);S([gn("upVector")],Ee.prototype,"_upVector",void 0);S([b()],Ee.prototype,"orthoLeft",null);S([b()],Ee.prototype,"orthoRight",null);S([b()],Ee.prototype,"orthoBottom",null);S([b()],Ee.prototype,"orthoTop",null);S([b()],Ee.prototype,"fov",void 0);S([b()],Ee.prototype,"projectionPlaneTilt",void 0);S([b()],Ee.prototype,"minZ",void 0);S([b()],Ee.prototype,"maxZ",void 0);S([b()],Ee.prototype,"inertia",void 0);S([b()],Ee.prototype,"mode",null);S([b()],Ee.prototype,"layerMask",void 0);S([b()],Ee.prototype,"fovMode",void 0);S([b()],Ee.prototype,"cameraRigMode",void 0);S([b()],Ee.prototype,"interaxialDistance",void 0);S([b()],Ee.prototype,"isStereoscopicSideBySide",void 0);class HT{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new WT(e)}sampleFrame(e=Mn.Now){if(this._enabled){if(this._lastFrameTimeMs!=null){const t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return e===0?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class WT{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){const i=this._samples[this._pos];t=i-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(i-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const t=this._samples.length;return(e%t+t)%t}}class Ms{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,t){Ms.Enabled&&(this._current+=e,t&&this._fetchResult())}beginMonitoring(){Ms.Enabled&&(this._startMonitoringTime=Mn.Now)}endMonitoring(e=!0){if(!Ms.Enabled)return;e&&this.fetchNewFrame();const t=Mn.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}endFrame(){this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const e=Mn.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}Ms.Enabled=!0;_e.prototype.setAlphaConstants=function(s,e,t,i){this._alphaState.setAlphaBlendConstants(s,e,t,i)};_e.prototype.setAlphaMode=function(s,e=!1){if(this._alphaMode===s){if(!e){const t=s===0;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}return}switch(s){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break}e||(this.depthCullingState.depthMask=s===0),this._alphaMode=s};_e.prototype.getAlphaMode=function(){return this._alphaMode};_e.prototype.setAlphaEquation=function(s){if(this._alphaEquation!==s){switch(s){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774);break}this._alphaEquation=s}};_e.prototype.getAlphaEquation=function(){return this._alphaEquation};function XT(s,e,t=!1,i){switch(s){case 3:{const r=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);return i&&r.set(new Int8Array(i)),r}case 0:{const r=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&r.set(new Uint8Array(i)),r}case 4:{const r=e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);return i&&r.set(new Int16Array(i)),r}case 5:case 8:case 9:case 10:case 2:{const r=e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);return i&&r.set(new Uint16Array(i)),r}case 6:{const r=e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);return i&&r.set(new Int32Array(i)),r}case 7:case 11:case 12:case 13:case 14:case 15:{const r=e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);return i&&r.set(new Uint32Array(i)),r}case 1:{const r=e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e);return i&&r.set(new Float32Array(i)),r}}const n=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&n.set(new Uint8Array(i)),n}_e.prototype._readTexturePixelsSync=function(s,e,t,i=-1,n=0,r=null,a=!0,o=!1,l=0,c=0){var u,h;const d=this._gl;if(!d)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const p=d.createFramebuffer();if(!p)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=p}d.bindFramebuffer(d.FRAMEBUFFER,this._dummyFramebuffer),i>-1?d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_CUBE_MAP_POSITIVE_X+i,(u=s._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,n):d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,(h=s._hardwareTexture)===null||h===void 0?void 0:h.underlyingResource,n);let f=s.type!==void 0?this._getWebGLTextureType(s.type):d.UNSIGNED_BYTE;if(o)r||(r=XT(s.type,4*e*t));else switch(f){case d.UNSIGNED_BYTE:r||(r=new Uint8Array(4*e*t)),f=d.UNSIGNED_BYTE;break;default:r||(r=new Float32Array(4*e*t)),f=d.FLOAT;break}return a&&this.flushFramebuffer(),d.readPixels(l,c,e,t,d.RGBA,f,r),d.bindFramebuffer(d.FRAMEBUFFER,this._currentFramebuffer),r};_e.prototype._readTexturePixels=function(s,e,t,i=-1,n=0,r=null,a=!0,o=!1,l=0,c=0){return Promise.resolve(this._readTexturePixelsSync(s,e,t,i,n,r,a,o,l,c))};_e.prototype.updateDynamicIndexBuffer=function(s,e,t=0){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(s);let i;s.is32Bits?i=e instanceof Uint32Array?e:new Uint32Array(e):i=e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};_e.prototype.updateDynamicVertexBuffer=function(s,e,t,i){this.bindArrayBuffer(s),t===void 0&&(t=0);const n=e.byteLength||e.length;i===void 0||i>=n&&t===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(e).subarray(t,t+i)):(e instanceof ArrayBuffer?e=new Uint8Array(e,t,i):e=new Uint8Array(e.buffer,e.byteOffset+t,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)),this._resetVertexBufferBinding()};class k extends _e{static get NpmPackage(){return _e.NpmPackage}static get Version(){return _e.Version}static get Instances(){return Fe.Instances}static get LastCreatedEngine(){return Fe.LastCreatedEngine}static get LastCreatedScene(){return Fe.LastCreatedScene}_createImageBitmapFromSource(e,t){return new Promise((n,r)=>{const a=new Image;a.onload=()=>{a.decode().then(()=>{this.createImageBitmap(a,t).then(o=>{n(o)})})},a.onerror=()=>{r(`Error loading image ${a.src}`)},a.src=e})}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,i){const r=this.createCanvas(t,i).getContext("2d");if(!r)throw new Error("Unable to get 2d context for resizeImageBitmap");return r.drawImage(e,0,0),r.getImageData(0,0,t,i).data}static MarkAllMaterialsAsDirty(e,t){for(let i=0;i<k.Instances.length;i++){const n=k.Instances[i];for(let r=0;r<n.scenes.length;r++)n.scenes[r].markAllMaterialsAsDirty(e,t)}}static DefaultLoadingScreenFactory(e){throw De("LoadingScreen")}get _supportsHardwareTextureRescaling(){return!!k._RescalePostProcessFactory}get performanceMonitor(){return this._performanceMonitor}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}getInputElement(){return this._renderingCanvas}constructor(e,t,i,n=!1){if(super(e,t,i,n),this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.scenes=new Array,this._virtualScenes=new Array,this.onNewSceneAddedObservable=new O,this.postProcesses=new Array,this.isPointerLock=!1,this.onResizeObservable=new O,this.onCanvasBlurObservable=new O,this.onCanvasFocusObservable=new O,this.onCanvasPointerOutObservable=new O,this.onBeginFrameObservable=new O,this.customAnimationFrameRequester=null,this.onEndFrameObservable=new O,this.onBeforeShaderCompilationObservable=new O,this.onAfterShaderCompilationObservable=new O,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this._fps=60,this._deltaTime=0,this._drawCalls=new Ms,this.canvasTabIndex=1,this.disablePerformanceMonitorInBackground=!1,this._performanceMonitor=new HT,this._compatibilityMode=!0,this.currentRenderPassId=0,this._renderPassNames=["main"],k.Instances.push(this),!!e){if(this._features.supportRenderPasses=!0,i=this._creationOptions,e.getContext){const r=e;this._sharedInit(r),this._connectVREvents()}this._prepareVRComponent(),i.autoEnableWebVR&&this.initWebVR()}}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),this._onCanvasFocus=()=>{this.onCanvasFocusObservable.notifyObservers(this)},this._onCanvasBlur=()=>{this.onCanvasBlurObservable.notifyObservers(this)},this._onCanvasContextMenu=i=>{this.disableContextMenu&&i.preventDefault()},e.addEventListener("focus",this._onCanvasFocus),e.addEventListener("blur",this._onCanvasBlur),e.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.disable(),this._windowIsBackground=!0},this._onFocus=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.enable(),this._windowIsBackground=!1},this._onCanvasPointerOut=i=>{document.elementFromPoint(i.clientX,i.clientY)!==e&&this.onCanvasPointerOutObservable.notifyObservers(i)};const t=this.getHostWindow();t&&typeof t.addEventListener=="function"&&(t.addEventListener("blur",this._onBlur),t.addEventListener("focus",this._onFocus)),e.addEventListener("pointerout",this._onCanvasPointerOut),this._creationOptions.doNotHandleTouchAction||this._disableTouchAction(),!k.audioEngine&&this._creationOptions.audioEngine&&k.AudioEngineFactory&&(k.audioEngine=k.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination())),cl()&&(this._onFullscreenChange=()=>{this.isFullscreen=!!document.fullscreenElement,this.isFullscreen&&this._pointerLockRequested&&e&&k._RequestPointerlock(e)},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=()=>{this.isPointerLock=document.pointerLockElement===e},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1)),this.enableOfflineSupport=k.OfflineProviderFactory!==void 0,this._deterministicLockstep=!!this._creationOptions.deterministicLockstep,this._lockstepMaxSteps=this._creationOptions.lockstepMaxSteps||0,this._timeStep=this._creationOptions.timeStep||1/60}_verifyPointerLock(){var e;(e=this._onPointerLockChange)===null||e===void 0||e.call(this)}getAspectRatio(e,t=!1){const i=e.viewport;return this.getRenderWidth(t)*i.width/(this.getRenderHeight(t)*i.height)}getScreenAspectRatio(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)}getRenderingCanvasClientRect(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null}getInputElementClientRect(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return this._timeStep*1e3}generateMipMapsForCubemap(e,t=!0){if(e.generateMipMaps){const i=this._gl;this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,e,!0),i.generateMipmap(i.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)}}getDepthWrite(){return this._depthCullingState.depthMask}setDepthWrite(e){this._depthCullingState.depthMask=e}getStencilBuffer(){return this._stencilState.stencilTest}setStencilBuffer(e){this._stencilState.stencilTest=e}getStencilMask(){return this._stencilState.stencilMask}setStencilMask(e){this._stencilState.stencilMask=e}getStencilFunction(){return this._stencilState.stencilFunc}getStencilFunctionReference(){return this._stencilState.stencilFuncRef}getStencilFunctionMask(){return this._stencilState.stencilFuncMask}setStencilFunction(e){this._stencilState.stencilFunc=e}setStencilFunctionReference(e){this._stencilState.stencilFuncRef=e}setStencilFunctionMask(e){this._stencilState.stencilFuncMask=e}getStencilOperationFail(){return this._stencilState.stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilState.stencilOpDepthFail}getStencilOperationPass(){return this._stencilState.stencilOpStencilDepthPass}setStencilOperationFail(e){this._stencilState.stencilOpStencilFail=e}setStencilOperationDepthFail(e){this._stencilState.stencilOpDepthFail=e}setStencilOperationPass(e){this._stencilState.stencilOpStencilDepthPass=e}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}getDepthFunction(){return this._depthCullingState.depthFunc}setDepthFunction(e){this._depthCullingState.depthFunc=e}setDepthFunctionToGreater(){this.setDepthFunction(516)}setDepthFunctionToGreaterOrEqual(){this.setDepthFunction(518)}setDepthFunctionToLess(){this.setDepthFunction(513)}setDepthFunctionToLessOrEqual(){this.setDepthFunction(515)}cacheStencilState(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()}restoreStencilState(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}setDirectViewport(e,t,i,n){const r=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,n),r}scissorClear(e,t,i,n,r){this.enableScissor(e,t,i,n),this.clear(r,!0,!0,!0),this.disableScissor()}enableScissor(e,t,i,n){const r=this._gl;r.enable(r.SCISSOR_TEST),r.scissor(e,t,i,n)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}_reportDrawCall(e=1){this._drawCalls.addCount(e,!1)}initWebVR(){throw De("WebVRCamera")}_prepareVRComponent(){}_connectVREvents(e,t){}_submitVRFrame(){}disableVR(){}isVRPresenting(){return!1}_requestVRFrame(){}_loadFileAsync(e,t,i){return new Promise((n,r)=>{this._loadFile(e,a=>{n(a)},void 0,t,i,(a,o)=>{r(o)})})}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}setDepthStencilTexture(e,t,i,n){e!==void 0&&(t&&(this._boundUniforms[e]=t),!i||!i.depthStencilTexture?this._setTexture(e,null,void 0,void 0,n):this._setTexture(e,i,!1,!0,n))}setTextureFromPostProcess(e,t,i){var n;let r=null;t&&(t._forcedOutputTexture?r=t._forcedOutputTexture:t._textures.data[t._currentRenderTextureInd]&&(r=t._textures.data[t._currentRenderTextureInd])),this._bindTexture(e,(n=r==null?void 0:r.texture)!==null&&n!==void 0?n:null,i)}setTextureFromPostProcessOutput(e,t,i){var n,r;this._bindTexture(e,(r=(n=t==null?void 0:t._outputTexture)===null||n===void 0?void 0:n.texture)!==null&&r!==void 0?r:null,i)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();super._rebuildBuffers()}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){const t=this._activeRenderLoops[e];t()}}_cancelFrame(){if(this._renderingQueueLaunched&&this.customAnimationFrameRequester){this._renderingQueueLaunched=!1;const{cancelAnimationFrame:e}=this.customAnimationFrameRequester;e&&e(this.customAnimationFrameRequester.requestID)}else super._cancelFrame()}_renderLoop(){if(!this._contextWasLost){let e=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}_renderViews(){return!1}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&k._RequestFullscreen(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&k._ExitFullscreen()}enterPointerlock(){this._renderingCanvas&&k._RequestPointerlock(this._renderingCanvas)}exitPointerlock(){k._ExitPointerlock()}beginFrame(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),super.beginFrame()}endFrame(){super.endFrame(),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)}resize(e=!1){this.isVRPresenting()||super.resize(e)}setSize(e,t,i=!1){if(!this._renderingCanvas||!super.setSize(e,t,i))return!1;if(this.scenes){for(let n=0;n<this.scenes.length;n++){const r=this.scenes[n];for(let a=0;a<r.cameras.length;a++){const o=r.cameras[a];o._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,i,n,r,a=null){r=r||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const o=super.createShaderProgram(e,t,i,n,r,a);return this.onAfterShaderCompilationObservable.notifyObservers(this),o}_createShaderProgram(e,t,i,n,r=null){const a=n.createProgram();if(e.program=a,!a)throw new Error("Unable to create program");if(n.attachShader(a,t),n.attachShader(a,i),this.webGLVersion>1&&r){const o=this.createTransformFeedback();this.bindTransformFeedback(o),this.setTranformFeedbackVaryings(a,r),e.transformFeedback=o}return n.linkProgram(a),this.webGLVersion>1&&r&&this.bindTransformFeedback(null),e.context=n,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),a}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach(t=>{t.postProcesses.forEach(i=>{i._outputTexture===e&&(i._outputTexture=null)}),t.cameras.forEach(i=>{i._postProcesses.forEach(n=>{n&&n._outputTexture===e&&(n._outputTexture=null)})})})}getRenderPassNames(){return this._renderPassNames}getCurrentRenderPassName(){return this._renderPassNames[this.currentRenderPassId]}createRenderPassId(e){const t=++k._RenderPassIdCounter;return this._renderPassNames[t]=e!=null?e:"NONAME",t}releaseRenderPassId(e){this._renderPassNames[e]=void 0;for(let t=0;t<this.scenes.length;++t){const i=this.scenes[t];for(let n=0;n<i.meshes.length;++n){const r=i.meshes[n];if(r.subMeshes)for(let a=0;a<r.subMeshes.length;++a)r.subMeshes[a]._removeDrawWrapper(e)}}}_rescaleTexture(e,t,i,n,r){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const a=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&k._RescalePostProcessFactory&&(this._rescalePostProcess=k._RescalePostProcessFactory(this)),this._rescalePostProcess&&(this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled(()=>{this._rescalePostProcess.onApply=function(l){l._bindTexture("textureSampler",e)};let o=i;o||(o=this.scenes[this.scenes.length-1]),o.postProcessManager.directRender([this._rescalePostProcess],a,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,n,0,0,t.width,t.height,0),this.unBindFramebuffer(a),a.dispose(),r&&r()}))}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}wrapWebGLTexture(e,t=!1,i=3){const n=new hE(e,this._gl),r=new dn(this,Pt.Unknown,!0);return r._hardwareTexture=n,r.isReady=!0,r.useMipMaps=t,this.updateTextureSamplingMode(i,r),r}_uploadImageToTexture(e,t,i=0,n=0){const r=this._gl,a=this._getWebGLTextureType(e.type),o=this._getInternalFormat(e.format),l=this._getRGBABufferInternalSizedFormat(e.type,o),c=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(c,e,!0),this._unpackFlipY(e.invertY);let u=r.TEXTURE_2D;e.isCube&&(u=r.TEXTURE_CUBE_MAP_POSITIVE_X+i),r.texImage2D(u,n,l,o,a,t),this._bindTextureDirectly(c,null,!0)}updateTextureComparisonFunction(e,t){if(this.webGLVersion===1){U.Error("WebGL 1 does not support texture comparison.");return}const i=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),t===0?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),t===0?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const i=new Ol(t);return i.capacity=e,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),i.references=1,i}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,t=0,i=10){const n=this._gl;return new Promise((r,a)=>{const o=()=>{const l=n.clientWaitSync(e,t,0);if(l==n.WAIT_FAILED){a();return}if(l==n.TIMEOUT_EXPIRED){setTimeout(o,i);return}r()};o()})}_readPixelsAsync(e,t,i,n,r,a,o){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const l=this._gl,c=l.createBuffer();l.bindBuffer(l.PIXEL_PACK_BUFFER,c),l.bufferData(l.PIXEL_PACK_BUFFER,o.byteLength,l.STREAM_READ),l.readPixels(e,t,i,n,r,a,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null);const u=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);return u?(l.flush(),this._clientWaitAsync(u,0,10).then(()=>(l.deleteSync(u),l.bindBuffer(l.PIXEL_PACK_BUFFER,c),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,o),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(c),o))):null}dispose(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();Fe.Instances.length===1&&k.audioEngine&&(k.audioEngine.dispose(),k.audioEngine=null),this.disableVR();const e=this.getHostWindow();e&&typeof e.removeEventListener=="function"&&(e.removeEventListener("blur",this._onBlur),e.removeEventListener("focus",this._onFocus)),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),cl()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)),super.dispose();const t=Fe.Instances.indexOf(this);t>=0&&Fe.Instances.splice(t,1),k.Instances.length||Fe.OnEnginesDisposedObservable.notifyObservers(this),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}_disableTouchAction(){!this._renderingCanvas||!this._renderingCanvas.setAttribute||(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")}displayLoadingUI(){if(!vi())return;const e=this.loadingScreen;e&&e.displayLoadingUI()}hideLoadingUI(){if(!vi())return;const e=this._loadingScreen;e&&e.hideLoadingUI()}get loadingScreen(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=k.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen}set loadingScreen(e){this._loadingScreen=e}set loadingUIText(e){this.loadingScreen.loadingUIText=e}set loadingUIBackgroundColor(e){this.loadingScreen.loadingUIBackgroundColor=e}createVideoElement(e){return document.createElement("video")}static _RequestPointerlock(e){if(e.requestPointerLock){const t=e.requestPointerLock();t instanceof Promise?t.then(()=>{e.focus()}).catch(()=>{}):e.focus()}}static _ExitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}static _RequestFullscreen(e){const t=e.requestFullscreen||e.webkitRequestFullscreen;t&&t.call(e)}static _ExitFullscreen(){const e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen()}getFontOffset(e){const t=document.createElement("span");t.innerHTML="Hg",t.setAttribute("style",`font: ${e} !important`);const i=document.createElement("div");i.style.display="inline-block",i.style.width="1px",i.style.height="0px",i.style.verticalAlign="bottom";const n=document.createElement("div");n.style.whiteSpace="nowrap",n.appendChild(t),n.appendChild(i),document.body.appendChild(n);let r=0,a=0;try{a=i.getBoundingClientRect().top-t.getBoundingClientRect().top,i.style.verticalAlign="baseline",r=i.getBoundingClientRect().top-t.getBoundingClientRect().top}finally{document.body.removeChild(n)}return{ascent:r,height:a,descent:a-r}}}k.ALPHA_DISABLE=0;k.ALPHA_ADD=1;k.ALPHA_COMBINE=2;k.ALPHA_SUBTRACT=3;k.ALPHA_MULTIPLY=4;k.ALPHA_MAXIMIZED=5;k.ALPHA_ONEONE=6;k.ALPHA_PREMULTIPLIED=7;k.ALPHA_PREMULTIPLIED_PORTERDUFF=8;k.ALPHA_INTERPOLATE=9;k.ALPHA_SCREENMODE=10;k.DELAYLOADSTATE_NONE=0;k.DELAYLOADSTATE_LOADED=1;k.DELAYLOADSTATE_LOADING=2;k.DELAYLOADSTATE_NOTLOADED=4;k.NEVER=512;k.ALWAYS=519;k.LESS=513;k.EQUAL=514;k.LEQUAL=515;k.GREATER=516;k.GEQUAL=518;k.NOTEQUAL=517;k.KEEP=7680;k.REPLACE=7681;k.INCR=7682;k.DECR=7683;k.INVERT=5386;k.INCR_WRAP=34055;k.DECR_WRAP=34056;k.TEXTURE_CLAMP_ADDRESSMODE=0;k.TEXTURE_WRAP_ADDRESSMODE=1;k.TEXTURE_MIRROR_ADDRESSMODE=2;k.TEXTUREFORMAT_ALPHA=0;k.TEXTUREFORMAT_LUMINANCE=1;k.TEXTUREFORMAT_LUMINANCE_ALPHA=2;k.TEXTUREFORMAT_RGB=4;k.TEXTUREFORMAT_RGBA=5;k.TEXTUREFORMAT_RED=6;k.TEXTUREFORMAT_R=6;k.TEXTUREFORMAT_RG=7;k.TEXTUREFORMAT_RED_INTEGER=8;k.TEXTUREFORMAT_R_INTEGER=8;k.TEXTUREFORMAT_RG_INTEGER=9;k.TEXTUREFORMAT_RGB_INTEGER=10;k.TEXTUREFORMAT_RGBA_INTEGER=11;k.TEXTURETYPE_UNSIGNED_BYTE=0;k.TEXTURETYPE_UNSIGNED_INT=0;k.TEXTURETYPE_FLOAT=1;k.TEXTURETYPE_HALF_FLOAT=2;k.TEXTURETYPE_BYTE=3;k.TEXTURETYPE_SHORT=4;k.TEXTURETYPE_UNSIGNED_SHORT=5;k.TEXTURETYPE_INT=6;k.TEXTURETYPE_UNSIGNED_INTEGER=7;k.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;k.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;k.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;k.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;k.TEXTURETYPE_UNSIGNED_INT_24_8=12;k.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;k.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;k.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;k.TEXTURE_NEAREST_SAMPLINGMODE=1;k.TEXTURE_BILINEAR_SAMPLINGMODE=2;k.TEXTURE_TRILINEAR_SAMPLINGMODE=3;k.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;k.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;k.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;k.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;k.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;k.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;k.TEXTURE_NEAREST_LINEAR=7;k.TEXTURE_NEAREST_NEAREST=1;k.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;k.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;k.TEXTURE_LINEAR_LINEAR=2;k.TEXTURE_LINEAR_NEAREST=12;k.TEXTURE_EXPLICIT_MODE=0;k.TEXTURE_SPHERICAL_MODE=1;k.TEXTURE_PLANAR_MODE=2;k.TEXTURE_CUBIC_MODE=3;k.TEXTURE_PROJECTION_MODE=4;k.TEXTURE_SKYBOX_MODE=5;k.TEXTURE_INVCUBIC_MODE=6;k.TEXTURE_EQUIRECTANGULAR_MODE=7;k.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;k.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;k.SCALEMODE_FLOOR=1;k.SCALEMODE_NEAREST=2;k.SCALEMODE_CEILING=3;k._RescalePostProcessFactory=null;k._RenderPassIdCounter=0;var rt;(function(s){s[s.LOCAL=0]="LOCAL",s[s.WORLD=1]="WORLD",s[s.BONE=2]="BONE"})(rt||(rt={}));class Aa{}Aa.X=new g(1,0,0);Aa.Y=new g(0,1,0);Aa.Z=new g(0,0,1);var ia;(function(s){s[s.X=0]="X",s[s.Y=1]="Y",s[s.Z=2]="Z"})(ia||(ia={}));class di extends Ee{constructor(e,t,i,n=!0){super(e,t,i,n),this._tmpUpVector=g.Zero(),this._tmpTargetVector=g.Zero(),this.cameraDirection=new g(0,0,0),this.cameraRotation=new j(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new ee,this.rotation=new g(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=g.Zero(),this._initialFocalDistance=1,this._viewMatrix=D.Zero(),this._camMatrix=D.Zero(),this._cameraTransformMatrix=D.Zero(),this._cameraRotationMatrix=D.Zero(),this._referencePoint=new g(0,0,1),this._transformedReferencePoint=g.Zero(),this._deferredPositionUpdate=new g,this._deferredRotationQuaternionUpdate=new ee,this._deferredRotationUpdate=new g,this._deferredUpdated=!1,this._deferOnly=!1,this._defaultUp=g.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(e){this.getWorldMatrix();const t=this.getTarget().subtract(this.position);return t.normalize(),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){const e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0):!1}_initCache(){super._initCache(),this._cache.lockedTarget=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new ee(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();const t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;const e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(e.getFps()*100))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=lt),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),D.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);const t=e.subtract(this.position);t.x>=0?this.rotation.y=-Math.atan(t.z/t.x)+Math.PI/2:this.rotation.y=-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&ee.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent){this.parent.getWorldMatrix().invertToRef(w.Matrix[0]),g.TransformNormalToRef(this.cameraDirection,w.Matrix[0],w.Vector3[0]),this._deferredPositionUpdate.addInPlace(w.Vector3[0]),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate);return}this._deferredPositionUpdate.addInPlace(this.cameraDirection),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate)}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=this.cameraRotation.x||this.cameraRotation.y;this._deferredUpdated=!1,this._deferredRotationUpdate.copyFrom(this.rotation),this._deferredPositionUpdate.copyFrom(this.position),this.rotationQuaternion&&this._deferredRotationQuaternionUpdate.copyFrom(this.rotationQuaternion),t&&this._updatePosition(),i&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this._deferredRotationUpdate),this._deferredRotationUpdate.x+=this.cameraRotation.x*e,this._deferredRotationUpdate.y+=this.cameraRotation.y*e,this.noRotationConstraint||(this._deferredRotationUpdate.x>1.570796&&(this._deferredRotationUpdate.x=1.570796),this._deferredRotationUpdate.x<-1.570796&&(this._deferredRotationUpdate.x=-1.570796)),this._deferOnly?this._deferredUpdated=!0:this.rotation.copyFrom(this._deferredRotationUpdate),this.rotationQuaternion&&this._deferredRotationUpdate.lengthSquared()&&(ee.RotationYawPitchRollToRef(this._deferredRotationUpdate.y,this._deferredRotationUpdate.x,this._deferredRotationUpdate.z,this._deferredRotationQuaternionUpdate),this._deferOnly?this._deferredUpdated=!0:this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate))),t&&(Math.abs(this.cameraDirection.x)<this.speed*lt&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*lt&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*lt&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*lt&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*lt&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):D.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return g.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),g.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?Aa.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(ee.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),Aa.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.ignoreParentScaling){if(this.parent){const n=this.parent.getWorldMatrix();g.TransformCoordinatesToRef(e,n,this._globalPosition),g.TransformCoordinatesToRef(t,n,this._tmpTargetVector),g.TransformNormalToRef(i,n,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(t),this._tmpUpVector.copyFrom(i);this.getScene().useRightHandedSystem?D.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):D.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix);return}if(this.getScene().useRightHandedSystem?D.LookAtRHToRef(e,t,i,this._viewMatrix):D.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){const n=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(n,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==Ee.RIG_MODE_NONE){const i=new di(e,this.position.clone(),this.getScene());return i.isRigCamera=!0,i.rigParent=this,(this.cameraRigMode===Ee.RIG_MODE_VR||this.cameraRigMode===Ee.RIG_MODE_WEBVR)&&(this.rotationQuaternion||(this.rotationQuaternion=new ee),i._cameraRigParams={},i.rotationQuaternion=new ee),i.mode=this.mode,i.orthoLeft=this.orthoLeft,i.orthoRight=this.orthoRight,i.orthoTop=this.orthoTop,i.orthoBottom=this.orthoBottom,i}return null}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case Ee.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ee.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ee.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case Ee.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ee.RIG_MODE_STEREOSCOPIC_INTERLACED:{const i=this.cameraRigMode===Ee.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,n=this.cameraRigMode===Ee.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*n,t);break}case Ee.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position);break}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,di._TargetFocalPoint),di._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const n=di._TargetFocalPoint.addInPlace(this.position);D.TranslationToRef(-n.x,-n.y,-n.z,di._TargetTransformMatrix),di._TargetTransformMatrix.multiplyToRef(D.RotationAxis(t.upVector,e),di._RigCamTransformMatrix),D.TranslationToRef(n.x,n.y,n.z,di._TargetTransformMatrix),di._RigCamTransformMatrix.multiplyToRef(di._TargetTransformMatrix,di._RigCamTransformMatrix),g.TransformCoordinatesToRef(this.position,di._RigCamTransformMatrix,t.position),t.setTarget(n)}getClassName(){return"TargetCamera"}}di._RigCamTransformMatrix=new D;di._TargetTransformMatrix=new D;di._TargetFocalPoint=new g;S([gn()],di.prototype,"rotation",void 0);S([b()],di.prototype,"speed",void 0);S([gE("lockedTargetId")],di.prototype,"lockedTarget",void 0);var rr={};class yE{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){const t=e.getSimpleName();if(this.attached[t]){U.Warn("camera input of type "+t+" already exists on camera");return}this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault)}remove(e){for(const t in this.attached){const i=this.attached[t];if(i===e){i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck();return}}}removeByType(e){for(const t in this.attached){const i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){const t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=Ee.ForceAttachControlToAlwaysPreventDefault?!1:e,this.attachedToElement=!0,this.noPreventDefault=e;for(const t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(const t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){const t={};for(const i in this.attached){const n=this.attached[i],r=Pe.Serialize(n);t[n.getClassName()]=r}e.inputsmgr=t}parse(e){const t=e.inputsmgr;if(t){this.clear();for(const i in t){const n=rr[i];if(n){const r=t[i],a=Pe.Parse(()=>new n,r,null);this.add(a)}}}else for(const i in this.attached){const n=rr[this.attached[i].getClassName()];if(n){const r=Pe.Parse(()=>new n,e,null);this.remove(this.attached[i]),this.add(r)}}}}class Ao{}Ao.KEYDOWN=1;Ao.KEYUP=2;class tf{constructor(e,t){this.type=e,this.event=t}}class O_ extends tf{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}class Hn{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===Ao.KEYDOWN)(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1){const n=this._keys.indexOf(i.keyCode);n>=0&&this._keys.splice(n,1),e||i.preventDefault()}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],n=e._computeLocalCameraSpeed();this.keysLeft.indexOf(i)!==-1?e._localDirection.copyFromFloats(-n,0,0):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,n):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(n,0,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-n):this.keysUpward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,n,0):this.keysDownward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-n,0):this.keysRotateLeft.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):this.keysRotateRight.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):this.keysRotateUp.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):this.keysRotateDown.indexOf(i)!==-1&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),g.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){let e=this.rotationSpeed*this._engine.getDeltaTime()/1e3;return this.camera.getScene().useRightHandedSystem&&(e*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}}S([b()],Hn.prototype,"keysUp",void 0);S([b()],Hn.prototype,"keysUpward",void 0);S([b()],Hn.prototype,"keysDown",void 0);S([b()],Hn.prototype,"keysDownward",void 0);S([b()],Hn.prototype,"keysLeft",void 0);S([b()],Hn.prototype,"keysRight",void 0);S([b()],Hn.prototype,"rotationSpeed",void 0);S([b()],Hn.prototype,"keysRotateLeft",void 0);S([b()],Hn.prototype,"keysRotateRight",void 0);S([b()],Hn.prototype,"keysRotateUp",void 0);S([b()],Hn.prototype,"keysRotateDown",void 0);rr.FreeCameraKeyboardMoveInput=Hn;class Ce{}Ce.POINTERDOWN=1;Ce.POINTERUP=2;Ce.POINTERMOVE=4;Ce.POINTERWHEEL=8;Ce.POINTERPICK=16;Ce.POINTERTAP=32;Ce.POINTERDOUBLETAP=64;class AE{constructor(e,t){this.type=e,this.event=t}}class YT extends AE{constructor(e,t,i,n){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new j(i,n)}}class Us extends AE{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,n=null){super(e,t),this._pickInfo=i,this._inputManager=n}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}class $u{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new O,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=n=>{const r=n.event,a=r.pointerType==="touch";if(t.isInVRExclusivePointerMode||!this.touchEnabled&&a||n.type!==Ce.POINTERMOVE&&this.buttons.indexOf(r.button)===-1)return;const o=r.target;if(n.type===Ce.POINTERDOWN){if(a&&this._activePointerId!==-1||!a&&this._currentActiveButton!==-1)return;this._activePointerId=r.pointerId;try{o==null||o.setPointerCapture(r.pointerId)}catch(l){}this._currentActiveButton===-1&&(this._currentActiveButton=r.button),this._previousPosition={x:r.clientX,y:r.clientY},e||(r.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(n.event)}else if(n.type===Ce.POINTERUP){if(a&&this._activePointerId!==r.pointerId||!a&&this._currentActiveButton!==r.button)return;try{o==null||o.releasePointerCapture(r.pointerId)}catch(l){}this._currentActiveButton=-1,this._previousPosition=null,e||r.preventDefault(),this._activePointerId=-1}else if(n.type===Ce.POINTERMOVE&&(this._activePointerId===r.pointerId||!a)){if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(n.event);else if(this._previousPosition){let l=r.clientX-this._previousPosition.x;const c=r.clientY-this._previousPosition.y;this.camera.getScene().useRightHandedSystem&&(l*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(l*=-1),this._allowCameraRotation&&(this.camera.cameraRotation.y+=l/this.angularSensibility,this.camera.cameraRotation.x+=c/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:l,offsetY:c}),this._previousPosition={x:r.clientX,y:r.clientY},e||r.preventDefault()}}}),this._onMouseMove=n=>{if(!t.isPointerLock||t.isInVRExclusivePointerMode)return;let r=n.movementX;this.camera.getScene().useRightHandedSystem&&(r*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(r*=-1),this.camera.cameraRotation.y+=r/this.angularSensibility;const a=n.movementY;this.camera.cameraRotation.x+=a/this.angularSensibility,this._previousPosition=null,e||n.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ce.POINTERDOWN|Ce.POINTERUP|Ce.POINTERMOVE),i&&(this._contextMenuBind=this.onContextMenu.bind(this),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}S([b()],$u.prototype,"buttons",void 0);S([b()],$u.prototype,"angularSensibility",void 0);rr.FreeCameraMouseInput=$u;var w_;(function(s){s[s.PointerMove=0]="PointerMove",s[s.PointerDown=1]="PointerDown",s[s.PointerUp=2]="PointerUp"})(w_||(w_={}));class Do{}Do.DOM_DELTA_PIXEL=0;Do.DOM_DELTA_LINE=1;Do.DOM_DELTA_PAGE=2;class Ju{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new O,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Ce.POINTERWHEEL)return;const i=t.event,n=i.deltaMode===Do.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*n*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*n*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*n*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Ce.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}S([b()],Ju.prototype,"wheelPrecisionX",void 0);S([b()],Ju.prototype,"wheelPrecisionY",void 0);S([b()],Ju.prototype,"wheelPrecisionZ",void 0);var Et;(function(s){s[s.MoveRelative=0]="MoveRelative",s[s.RotateRelative=1]="RotateRelative",s[s.MoveScene=2]="MoveScene"})(Et||(Et={}));class gs extends Ju{constructor(){super(...arguments),this._moveRelative=g.Zero(),this._rotateRelative=g.Zero(),this._moveScene=g.Zero(),this._wheelXAction=Et.MoveRelative,this._wheelXActionCoordinate=ia.X,this._wheelYAction=Et.MoveRelative,this._wheelYActionCoordinate=ia.Z,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){e===null&&this._wheelXAction!==Et.MoveRelative||(this._wheelXAction=Et.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==Et.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){e===null&&this._wheelYAction!==Et.MoveRelative||(this._wheelYAction=Et.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==Et.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){e===null&&this._wheelZAction!==Et.MoveRelative||(this._wheelZAction=Et.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==Et.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){e===null&&this._wheelXAction!==Et.RotateRelative||(this._wheelXAction=Et.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==Et.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){e===null&&this._wheelYAction!==Et.RotateRelative||(this._wheelYAction=Et.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==Et.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){e===null&&this._wheelZAction!==Et.RotateRelative||(this._wheelZAction=Et.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==Et.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){e===null&&this._wheelXAction!==Et.MoveScene||(this._wheelXAction=Et.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==Et.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){e===null&&this._wheelYAction!==Et.MoveScene||(this._wheelYAction=Et.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==Et.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){e===null&&this._wheelZAction!==Et.MoveScene||(this._wheelZAction=Et.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==Et.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=D.Zero();this.camera.getViewMatrix().invertToRef(e);const t=g.Zero();g.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(e===0||t===null||i===null)return;let n=null;switch(t){case Et.MoveRelative:n=this._moveRelative;break;case Et.RotateRelative:n=this._rotateRelative;break;case Et.MoveScene:n=this._moveScene;break}switch(i){case ia.X:n.set(e,0,0);break;case ia.Y:n.set(0,e,0);break;case ia.Z:n.set(0,0,e);break}}}S([b()],gs.prototype,"wheelXMoveRelative",null);S([b()],gs.prototype,"wheelYMoveRelative",null);S([b()],gs.prototype,"wheelZMoveRelative",null);S([b()],gs.prototype,"wheelXRotateRelative",null);S([b()],gs.prototype,"wheelYRotateRelative",null);S([b()],gs.prototype,"wheelZRotateRelative",null);S([b()],gs.prototype,"wheelXMoveScene",null);S([b()],gs.prototype,"wheelYMoveScene",null);S([b()],gs.prototype,"wheelZMoveScene",null);rr.FreeCameraMouseWheelInput=gs;class eh{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=q.IsSafari()}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments);let t=null;if(this._pointerInput===void 0&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{const n=i.event,r=n.pointerType==="mouse"||this._isSafari&&typeof n.pointerType=="undefined";if(!(!this.allowMouse&&r)){if(i.type===Ce.POINTERDOWN){if(e||n.preventDefault(),this._pointerPressed.push(n.pointerId),this._pointerPressed.length!==1)return;t={x:n.clientX,y:n.clientY}}else if(i.type===Ce.POINTERUP){e||n.preventDefault();const a=this._pointerPressed.indexOf(n.pointerId);if(a===-1||(this._pointerPressed.splice(a,1),a!=0))return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===Ce.POINTERMOVE){if(e||n.preventDefault(),!t||this._pointerPressed.indexOf(n.pointerId)!=0)return;this._offsetX=n.clientX-t.x,this._offsetY=-(n.clientY-t.y)}}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ce.POINTERDOWN|Ce.POINTERUP|Ce.POINTERMOVE),this._onLostFocus){const n=this.camera.getEngine().getInputElement();n&&n.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(this._offsetX===null||this._offsetY===null||this._offsetX===0&&this._offsetY===0)return;const e=this.camera;if(e.cameraRotation.y=this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&this._pointerPressed.length===1||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const i=e._computeLocalCameraSpeed(),n=new g(0,0,this.touchMoveSensibility!==0?i*this._offsetY/this.touchMoveSensibility:0);D.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(g.TransformCoordinates(n,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}S([b()],eh.prototype,"touchAngularSensibility",void 0);S([b()],eh.prototype,"touchMoveSensibility",void 0);rr.FreeCameraTouchInput=eh;class KT extends yE{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new Hn),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new $u(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new gs,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new eh),this}clear(){super.clear(),this._mouseInput=null}}class $l extends di{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,n=!0){super(e,t,i,n),this.ellipsoid=new g(.5,1,.5),this.ellipsoidOffset=new g(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=g.Zero(),this._diffPosition=g.Zero(),this._newPosition=g.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(r,a,o=null)=>{this._newPosition.copyFrom(a),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>k.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&o&&this.onCollide(o))},this.inputs=new KT(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=q.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new g(0,0,0),this.cameraRotation=new j(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=g.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let n=e;this.applyGravity&&(n=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,n,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=g.Zero(),this._transformedDirection=g.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}S([gn()],$l.prototype,"ellipsoid",void 0);S([gn()],$l.prototype,"ellipsoidOffset",void 0);S([b()],$l.prototype,"checkCollisions",void 0);S([b()],$l.prototype,"applyGravity",void 0);var Su;(function(s){s[s.NONE=0]="NONE",s[s.STEP=1]="STEP"})(Su||(Su={}));class To{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new To(this.name,this.from,this.to)}}class qn{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=this.width|0;return e=e*397^(this.height|0),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new qn(this.width*e,this.height*t)}clone(){return new qn(this.width,this.height)}equals(e){return e?this.width===e.width&&this.height===e.height:!1}get surface(){return this.width*this.height}static Zero(){return new qn(0,0)}add(e){return new qn(this.width+e.width,this.height+e.height)}subtract(e){return new qn(this.width-e.width,this.height-e.height)}static Lerp(e,t,i){const n=e.width+(t.width-e.width)*i,r=e.height+(t.height-e.height)*i;return new qn(n,r)}}class B{static _PrepareAnimation(e,t,i,n,r,a,o,l){let c;if(!isNaN(parseFloat(r))&&isFinite(r)?c=B.ANIMATIONTYPE_FLOAT:r instanceof ee?c=B.ANIMATIONTYPE_QUATERNION:r instanceof g?c=B.ANIMATIONTYPE_VECTOR3:r instanceof j?c=B.ANIMATIONTYPE_VECTOR2:r instanceof G?c=B.ANIMATIONTYPE_COLOR3:r instanceof pe?c=B.ANIMATIONTYPE_COLOR4:r instanceof qn&&(c=B.ANIMATIONTYPE_SIZE),c==null)return null;const u=new B(e,t,i,c,o),h=[{frame:0,value:r},{frame:n,value:a}];return u.setKeys(h),l!==void 0&&u.setEasingFunction(l),u}static CreateAnimation(e,t,i,n){const r=new B(e+"Animation",e,i,t,B.ANIMATIONLOOPMODE_CONSTANT);return r.setEasingFunction(n),r}static CreateAndStartAnimation(e,t,i,n,r,a,o,l,c,u,h){const d=B._PrepareAnimation(e,i,n,r,a,o,l,c);return!d||(t.getScene&&(h=t.getScene()),!h)?null:h.beginDirectAnimation(t,[d],0,r,d.loopMode===1,1,u)}static CreateAndStartHierarchyAnimation(e,t,i,n,r,a,o,l,c,u,h){const d=B._PrepareAnimation(e,n,r,a,o,l,c,u);return d?t.getScene().beginDirectHierarchyAnimation(t,i,[d],0,a,d.loopMode===1,1,h):null}static CreateMergeAndStartAnimation(e,t,i,n,r,a,o,l,c,u){const h=B._PrepareAnimation(e,i,n,r,a,o,l,c);return h?(t.animations.push(h),t.getScene().beginAnimation(t,0,r,h.loopMode===1,1,u)):null}static MakeAnimationAdditive(e,t=0,i,n=!1,r){let a=e;if(n&&(a=e.clone(),a.name=r||a.name),!a._keys.length)return a;t=t>=0?t:0;let o=0;const l=a._keys[0];let c=a._keys.length-1;const u=a._keys[c],h={referenceValue:l.value,referencePosition:w.Vector3[0],referenceQuaternion:w.Quaternion[0],referenceScaling:w.Vector3[1],keyPosition:w.Vector3[2],keyQuaternion:w.Quaternion[1],keyScaling:w.Vector3[3]};let d=!1,f=l.frame,p=u.frame;if(i){const v=a.getRange(i);v&&(f=v.from,p=v.to)}let m=l.frame===f,_=u.frame===p;if(a._keys.length===1){const v=a._getKeyValue(a._keys[0]);h.referenceValue=v.clone?v.clone():v,d=!0}else if(t<=l.frame){const v=a._getKeyValue(l.value);h.referenceValue=v.clone?v.clone():v,d=!0}else if(t>=u.frame){const v=a._getKeyValue(u.value);h.referenceValue=v.clone?v.clone():v,d=!0}let E=0;for(;!d||!m||!_&&E<a._keys.length-1;){const v=a._keys[E],y=a._keys[E+1];if(!d&&t>=v.frame&&t<=y.frame){let A;if(t===v.frame)A=a._getKeyValue(v.value);else if(t===y.frame)A=a._getKeyValue(y.value);else{const I={key:E,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT};A=a._interpolate(t,I)}h.referenceValue=A.clone?A.clone():A,d=!0}if(!m&&f>=v.frame&&f<=y.frame){if(f===v.frame)o=E;else if(f===y.frame)o=E+1;else{const A={key:E,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT},I=a._interpolate(f,A),T={frame:f,value:I.clone?I.clone():I};a._keys.splice(E+1,0,T),o=E+1}m=!0}if(!_&&p>=v.frame&&p<=y.frame){if(p===v.frame)c=E;else if(p===y.frame)c=E+1;else{const A={key:E,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT},I=a._interpolate(p,A),T={frame:p,value:I.clone?I.clone():I};a._keys.splice(E+1,0,T),c=E+1}_=!0}E++}for(a.dataType===B.ANIMATIONTYPE_QUATERNION?h.referenceValue.normalize().conjugateInPlace():a.dataType===B.ANIMATIONTYPE_MATRIX&&(h.referenceValue.decompose(h.referenceScaling,h.referenceQuaternion,h.referencePosition),h.referenceQuaternion.normalize().conjugateInPlace()),E=o;E<=c;E++){const v=a._keys[E];if(!(E&&a.dataType!==B.ANIMATIONTYPE_FLOAT&&v.value===l.value))switch(a.dataType){case B.ANIMATIONTYPE_MATRIX:v.value.decompose(h.keyScaling,h.keyQuaternion,h.keyPosition),h.keyPosition.subtractInPlace(h.referencePosition),h.keyScaling.divideInPlace(h.referenceScaling),h.referenceQuaternion.multiplyToRef(h.keyQuaternion,h.keyQuaternion),D.ComposeToRef(h.keyScaling,h.keyQuaternion,h.keyPosition,v.value);break;case B.ANIMATIONTYPE_QUATERNION:h.referenceValue.multiplyToRef(v.value,v.value);break;case B.ANIMATIONTYPE_VECTOR2:case B.ANIMATIONTYPE_VECTOR3:case B.ANIMATIONTYPE_COLOR3:case B.ANIMATIONTYPE_COLOR4:v.value.subtractToRef(h.referenceValue,v.value);break;case B.ANIMATIONTYPE_SIZE:v.value.width-=h.referenceValue.width,v.value.height-=h.referenceValue.height;break;default:v.value-=h.referenceValue}}return a}static TransitionTo(e,t,i,n,r,a,o,l=null){if(o<=0)return i[e]=t,l&&l(),null;const c=r*(o/1e3);a.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:c,value:t}]),i.animations||(i.animations=[]),i.animations.push(a);const u=n.beginAnimation(i,0,c,!1);return u.onAnimationEnd=l,u}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,t,i,n,r,a){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=n,this.loopMode=r,this.enableBlending=a,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=n,this.loopMode=r===void 0?B.ANIMATIONLOOPMODE_CYCLE:r,this.uniqueId=B._UniqueIdGenerator++}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let i=!0;for(const n in this._ranges)i&&(t+=", ",i=!1),t+=n;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort((t,i)=>t.frame-i.frame)}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new To(e,t,i))}deleteRange(e,t=!0){const i=this._ranges[e];if(i){if(t){const n=i.from,r=i.to;for(let a=this._keys.length-1;a>=0;a--)this._keys[a].frame>=n&&this._keys[a].frame<=r&&this._keys.splice(a,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return W.Lerp(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,n,r){return W.Hermite(e,t,i,n,r)}quaternionInterpolateFunction(e,t,i){return ee.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,n,r){return ee.Hermite(e,t,i,n,r).normalize()}vector3InterpolateFunction(e,t,i){return g.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,n,r){return g.Hermite(e,t,i,n,r)}vector2InterpolateFunction(e,t,i){return j.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,n,r){return j.Hermite(e,t,i,n,r)}sizeInterpolateFunction(e,t,i){return qn.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return G.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,n,r){return G.Hermite(e,t,i,n,r)}color4InterpolateFunction(e,t,i){return pe.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,n,r){return pe.Hermite(e,t,i,n,r)}_getKeyValue(e){return typeof e=="function"?e():e}evaluate(e){return this._interpolate(e,{key:0,repeatCount:0,loopMode:B.ANIMATIONLOOPMODE_CONSTANT})}_interpolate(e,t){if(t.loopMode===B.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const i=this._keys,n=i.length;let r=t.key;for(;r>=0&&e<i[r].frame;)--r;for(;r+1<=n-1&&e>=i[r+1].frame;)++r;if(t.key=r,r<0)return this._getKeyValue(i[0].value);if(r+1>n-1)return this._getKeyValue(i[n-1].value);const a=i[r],o=i[r+1],l=this._getKeyValue(a.value),c=this._getKeyValue(o.value);if(a.interpolation===Su.STEP)return o.frame>e?l:c;const u=a.outTangent!==void 0&&o.inTangent!==void 0,h=o.frame-a.frame;let d=(e-a.frame)/h;const f=this.getEasingFunction();switch(f!==null&&(d=f.ease(d)),this.dataType){case B.ANIMATIONTYPE_FLOAT:{const p=u?this.floatInterpolateFunctionWithTangents(l,a.outTangent*h,c,o.inTangent*h,d):this.floatInterpolateFunction(l,c,d);switch(t.loopMode){case B.ANIMATIONLOOPMODE_CYCLE:case B.ANIMATIONLOOPMODE_CONSTANT:case B.ANIMATIONLOOPMODE_YOYO:return p;case B.ANIMATIONLOOPMODE_RELATIVE:return t.offsetValue*t.repeatCount+p}break}case B.ANIMATIONTYPE_QUATERNION:{const p=u?this.quaternionInterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),d):this.quaternionInterpolateFunction(l,c,d);switch(t.loopMode){case B.ANIMATIONLOOPMODE_CYCLE:case B.ANIMATIONLOOPMODE_CONSTANT:case B.ANIMATIONLOOPMODE_YOYO:return p;case B.ANIMATIONLOOPMODE_RELATIVE:return p.addInPlace(t.offsetValue.scale(t.repeatCount))}return p}case B.ANIMATIONTYPE_VECTOR3:{const p=u?this.vector3InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),d):this.vector3InterpolateFunction(l,c,d);switch(t.loopMode){case B.ANIMATIONLOOPMODE_CYCLE:case B.ANIMATIONLOOPMODE_CONSTANT:case B.ANIMATIONLOOPMODE_YOYO:return p;case B.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case B.ANIMATIONTYPE_VECTOR2:{const p=u?this.vector2InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),d):this.vector2InterpolateFunction(l,c,d);switch(t.loopMode){case B.ANIMATIONLOOPMODE_CYCLE:case B.ANIMATIONLOOPMODE_CONSTANT:case B.ANIMATIONLOOPMODE_YOYO:return p;case B.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case B.ANIMATIONTYPE_SIZE:{switch(t.loopMode){case B.ANIMATIONLOOPMODE_CYCLE:case B.ANIMATIONLOOPMODE_CONSTANT:case B.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(l,c,d);case B.ANIMATIONLOOPMODE_RELATIVE:return this.sizeInterpolateFunction(l,c,d).add(t.offsetValue.scale(t.repeatCount))}break}case B.ANIMATIONTYPE_COLOR3:{const p=u?this.color3InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),d):this.color3InterpolateFunction(l,c,d);switch(t.loopMode){case B.ANIMATIONLOOPMODE_CYCLE:case B.ANIMATIONLOOPMODE_CONSTANT:case B.ANIMATIONLOOPMODE_YOYO:return p;case B.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case B.ANIMATIONTYPE_COLOR4:{const p=u?this.color4InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),d):this.color4InterpolateFunction(l,c,d);switch(t.loopMode){case B.ANIMATIONLOOPMODE_CYCLE:case B.ANIMATIONLOOPMODE_CONSTANT:case B.ANIMATIONLOOPMODE_YOYO:return p;case B.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case B.ANIMATIONTYPE_MATRIX:{switch(t.loopMode){case B.ANIMATIONLOOPMODE_CYCLE:case B.ANIMATIONLOOPMODE_CONSTANT:case B.ANIMATIONLOOPMODE_YOYO:return B.AllowMatricesInterpolation?this.matrixInterpolateFunction(l,c,d,t.workValue):l;case B.ANIMATIONLOOPMODE_RELATIVE:return l}break}}return 0}matrixInterpolateFunction(e,t,i,n){return B.AllowMatrixDecomposeForInterpolation?n?(D.DecomposeLerpToRef(e,t,i,n),n):D.DecomposeLerp(e,t,i):n?(D.LerpToRef(e,t,i,n),n):D.Lerp(e,t,i)}clone(){const e=new B(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const i=this._ranges[t];i&&(e._ranges[t]=i.clone())}}return e}setKeys(e){this._keys=e.slice(0)}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const t=this.dataType;e.keys=[];const i=this.getKeys();for(let n=0;n<i.length;n++){const r=i[n],a={};switch(a.frame=r.frame,t){case B.ANIMATIONTYPE_FLOAT:a.values=[r.value],r.inTangent!==void 0&&a.values.push(r.inTangent),r.outTangent!==void 0&&(r.inTangent===void 0&&a.values.push(void 0),a.values.push(r.outTangent)),r.interpolation!==void 0&&(r.inTangent===void 0&&a.values.push(void 0),r.outTangent===void 0&&a.values.push(void 0),a.values.push(r.interpolation));break;case B.ANIMATIONTYPE_QUATERNION:case B.ANIMATIONTYPE_MATRIX:case B.ANIMATIONTYPE_VECTOR3:case B.ANIMATIONTYPE_COLOR3:case B.ANIMATIONTYPE_COLOR4:a.values=r.value.asArray(),r.inTangent!=null&&a.values.push(r.inTangent.asArray()),r.outTangent!=null&&(r.inTangent===void 0&&a.values.push(void 0),a.values.push(r.outTangent.asArray())),r.interpolation!==void 0&&(r.inTangent===void 0&&a.values.push(void 0),r.outTangent===void 0&&a.values.push(void 0),a.values.push(r.interpolation));break}e.keys.push(a)}e.ranges=[];for(const n in this._ranges){const r=this._ranges[n];if(!r)continue;const a={};a.name=n,a.from=r.from,a.to=r.to,e.ranges.push(a)}return e}static _UniversalLerp(e,t,i){const n=e.constructor;return n.Lerp?n.Lerp(e,t,i):n.Slerp?n.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){const t=new B(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,n=[];let r,a;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),a=0;a<e.keys.length;a++){const o=e.keys[a];let l,c,u;switch(i){case B.ANIMATIONTYPE_FLOAT:r=o.values[0],o.values.length>=2&&(l=o.values[1]),o.values.length>=3&&(c=o.values[2]),o.values.length>=4&&(u=o.values[3]);break;case B.ANIMATIONTYPE_QUATERNION:if(r=ee.FromArray(o.values),o.values.length>=8){const d=ee.FromArray(o.values.slice(4,8));d.equals(ee.Zero())||(l=d)}if(o.values.length>=12){const d=ee.FromArray(o.values.slice(8,12));d.equals(ee.Zero())||(c=d)}o.values.length>=13&&(u=o.values[12]);break;case B.ANIMATIONTYPE_MATRIX:r=D.FromArray(o.values),o.values.length>=17&&(u=o.values[16]);break;case B.ANIMATIONTYPE_COLOR3:r=G.FromArray(o.values),o.values[3]&&(l=G.FromArray(o.values[3])),o.values[4]&&(c=G.FromArray(o.values[4])),o.values[5]&&(u=o.values[5]);break;case B.ANIMATIONTYPE_COLOR4:r=pe.FromArray(o.values),o.values[4]&&(l=pe.FromArray(o.values[4])),o.values[5]&&(c=pe.FromArray(o.values[5])),o.values[6]&&(u=pe.FromArray(o.values[6]));break;case B.ANIMATIONTYPE_VECTOR3:default:r=g.FromArray(o.values),o.values[3]&&(l=g.FromArray(o.values[3])),o.values[4]&&(c=g.FromArray(o.values[4])),o.values[5]&&(u=o.values[5]);break}const h={};h.frame=o.frame,h.value=r,l!=null&&(h.inTangent=l),c!=null&&(h.outTangent=c),u!=null&&(h.interpolation=u),n.push(h)}if(t.setKeys(n),e.ranges)for(a=0;a<e.ranges.length;a++)r=e.ranges[a],t.createRange(r.name,r.from,r.to);return t}static AppendSerializedAnimations(e,t){Pe.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise((i,n)=>{const r=new ln;r.addEventListener("readystatechange",()=>{if(r.readyState==4)if(r.status==200){let a=JSON.parse(r.responseText);if(a.animations&&(a=a.animations),a.length){const o=new Array;for(const l of a)o.push(this.Parse(l));i(o)}else{const o=this.Parse(a);e&&(o.name=e),i(o)}}else n("Unable to load the animation")}),r.open("GET",t),r.send()})}static ParseFromSnippetAsync(e){return new Promise((t,i)=>{const n=new ln;n.addEventListener("readystatechange",()=>{if(n.readyState==4)if(n.status==200){const r=JSON.parse(JSON.parse(n.responseText).jsonPayload);if(r.animations){const a=JSON.parse(r.animations),o=new Array;for(const l of a.animations){const c=this.Parse(l);c.snippetId=e,o.push(c)}t(o)}else{const a=JSON.parse(r.animation),o=this.Parse(a);o.snippetId=e,t(o)}}else i("Unable to load the snippet "+e)}),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()})}}B._UniqueIdGenerator=0;B.AllowMatricesInterpolation=!1;B.AllowMatrixDecomposeForInterpolation=!0;B.SnippetUrl="https://snippet.babylonjs.com";B.ANIMATIONTYPE_FLOAT=0;B.ANIMATIONTYPE_VECTOR3=1;B.ANIMATIONTYPE_QUATERNION=2;B.ANIMATIONTYPE_MATRIX=3;B.ANIMATIONTYPE_COLOR3=4;B.ANIMATIONTYPE_COLOR4=7;B.ANIMATIONTYPE_VECTOR2=5;B.ANIMATIONTYPE_SIZE=6;B.ANIMATIONLOOPMODE_RELATIVE=0;B.ANIMATIONLOOPMODE_CYCLE=1;B.ANIMATIONLOOPMODE_CONSTANT=2;B.ANIMATIONLOOPMODE_YOYO=4;B.CreateFromSnippetAsync=B.ParseFromSnippetAsync;Rt("BABYLON.Animation",B);oi._AnimationRangeFactory=(s,e,t)=>new To(s,e,t);class QT{getClassName(){return"TargetedAnimation"}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class ao{syncWithMask(){if(this.mask)for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];this.mask.retainsTarget(t.target.name)?t.paused&&t.restart():t.paused||t.pause()}}removeUnmaskedAnimations(){if(this.mask){for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];this.mask.retainsTarget(t.target.name)||(t.stop(),this._animatables.splice(e,1),--e)}for(let e=0;e<this._targetedAnimations.length;e++){const t=this._targetedAnimations[e];this.mask.retainsTarget(t.target.name)||(this._targetedAnimations.splice(e,1),--e)}}}get from(){return this._from}get to(){return this._to}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.speedRatio=this._speedRatio}}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.loopAnimation=this._loopAnimation}}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.isAdditive=this._isAdditive}}}get weight(){return this._weight}set weight(e){this._weight!==e&&(this._weight=e,this.setWeightForAllAnimatables(this._weight))}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}get playOrder(){return this._playOrder}set playOrder(e){if(this._playOrder!==e&&(this._playOrder=e,this._animatables.length>0)){for(let t=0;t<this._animatables.length;t++)this._animatables[t].playOrder=this._playOrder;this._scene.sortActiveAnimatables()}}enableBlending(e){for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.enableBlending=!0,this._targetedAnimations[t].animation.blendingSpeed=e}disableBlending(){for(let e=0;e<this._targetedAnimations.length;++e)this._targetedAnimations[e].animation.enableBlending=!1}static MergeAnimationGroups(e,t=!0,i=!1,n){if(e.length===0)return null;n=n!=null?n:e[0].weight;let r=Number.MAX_VALUE,a=Number.MIN_VALUE;if(i)for(const l of e)l.from<r&&(r=l.from),l.to>a&&(a=l.to);const o=new ao(e[0].name+"_merged",e[0]._scene,n);for(const l of e){i&&l.normalize(r,a);for(const c of l.targetedAnimations)o.addTargetedAnimation(c.animation,c.target);t&&l.dispose()}return o}constructor(e,t=null,i=-1,n=0){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._weight=-1,this._playOrder=0,this._parentContainer=null,this.onAnimationEndObservable=new O,this.onAnimationLoopObservable=new O,this.onAnimationGroupLoopObservable=new O,this.onAnimationGroupEndObservable=new O,this.onAnimationGroupPauseObservable=new O,this.onAnimationGroupPlayObservable=new O,this.metadata=null,this._animationLoopFlags=[],this._scene=t||Fe.LastCreatedScene,this._weight=i,this._playOrder=n,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){const i=new QT;i.animation=e,i.target=t;const n=e.getKeys();return this._from>n[0].frame&&(this._from=n[0].frame),this._to<n[n.length-1].frame&&(this._to=n[n.length-1].frame),this._targetedAnimations.push(i),i}removeTargetedAnimation(e){for(let t=this._targetedAnimations.length-1;t>-1;t--)this._targetedAnimations[t].animation===e&&this._targetedAnimations.splice(t,1)}normalize(e=null,t=null){e==null&&(e=this._from),t==null&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){const r=this._targetedAnimations[i].animation.getKeys(),a=r[0],o=r[r.length-1];if(a.frame>e){const l={frame:e,value:a.value,inTangent:a.inTangent,outTangent:a.outTangent,interpolation:a.interpolation};r.splice(0,0,l)}if(o.frame<t){const l={frame:t,value:o.value,inTangent:o.inTangent,outTangent:o.outTangent,interpolation:o.interpolation};r.push(l)}}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),!this._animationLoopFlags[i]&&(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._targetedAnimations.length&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,n,r){if(this._isStarted||this._targetedAnimations.length===0)return this;this._loopAnimation=e,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let a=0;a<this._targetedAnimations.length;a++){const o=this._targetedAnimations[a],l=this._scene.beginDirectAnimation(o.target,[o.animation],i!==void 0?i:this._from,n!==void 0?n:this._to,e,t,void 0,void 0,r!==void 0?r:this._isAdditive);l.weight=this._weight,l.playOrder=this._playOrder,l.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(o),this._checkAnimationGroupEnded(l)},this._processLoop(l,o,a),this._animatables.push(l)}return this.syncWithMask(),this._scene.sortActiveAnimatables(),this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length===this._targetedAnimations.length?(e!==void 0&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this._isPaused=!1,this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(){if(!this._isStarted)return this;const e=this._animatables.slice();for(let i=0;i<e.length;i++)e[i].stop(void 0,void 0,!0);let t=0;for(let i=0;i<this._scene._activeAnimatables.length;i++){const n=this._scene._activeAnimatables[i];n._runtimeAnimations.length>0&&(this._scene._activeAnimatables[t++]=n)}return this._scene._activeAnimatables.length=t,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.weight=e}return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e){if(!this._isStarted)return this;for(let t=0;t<this._animatables.length;t++)this._animatables[t].goToFrame(e);return this}dispose(){this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const t=this._parentContainer.animationGroups.indexOf(this);t>-1&&this._parentContainer.animationGroups.splice(t,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e){const t=this._animatables.indexOf(e);t>-1&&this._animatables.splice(t,1),this._animatables.length===0&&(this._isStarted=!1,this.onAnimationGroupEndObservable.notifyObservers(this))}clone(e,t,i=!1){const n=new ao(e||this.name,this._scene);for(const r of this._targetedAnimations)n.addTargetedAnimation(i?r.animation.clone():r.animation,t?t(r.target):r.target);return n}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){const i=this.targetedAnimations[t];e.targetedAnimations[t]=i.serialize()}return Ye&&Ye.HasTags(this)&&(e.tags=Ye.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){const i=new ao(e.name,t);for(let n=0;n<e.targetedAnimations.length;n++){const r=e.targetedAnimations[n],a=B.Parse(r.animation),o=r.targetId;if(r.animation.property==="influence"){const l=t.getMorphTargetById(o);l&&i.addTargetedAnimation(a,l)}else{const l=t.getNodeById(o);l!=null&&i.addTargetedAnimation(a,l)}}return e.from!==null&&e.to!==null&&i.normalize(e.from,e.to),Ye&&Ye.AddTagsTo(i,e.tags),e.metadata!==void 0&&(i.metadata=e.metadata),i}static MakeAnimationAdditive(e,t=0,i,n=!1,r){let a=e;n&&(a=e.clone(r||a.name));const o=a.targetedAnimations;for(let l=0;l<o.length;l++){const c=o[l];B.MakeAnimationAdditive(c.animation,t,i)}return a.isAdditive=!0,a}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}}class Tt extends oi{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){e.updateFlag===this._localMatrix.updateFlag&&!this._needToCompose||(this._needToCompose=!1,this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,n=null,r=null,a=null,o=null){var l;super(e,t.getScene()),this.name=e,this.children=new Array,this.animations=new Array,this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=(l=n==null?void 0:n.clone())!==null&&l!==void 0?l:D.Identity(),this._restMatrix=r!=null?r:this._localMatrix.clone(),this._bindMatrix=a!=null?a:this._localMatrix.clone(),this._index=o,this._absoluteMatrix=new D,this._absoluteBindMatrix=new D,this._absoluteInverseBindMatrix=new D,this._finalMatrix=new D,t.bones.push(this),this.setParent(i,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const i=this.parent.children.indexOf(this);i!==-1&&this.parent.children.splice(i,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(e){this._restMatrix.copyFrom(e)}setRestPose(e){this.setRestMatrix(e)}getBindPose(){return this.getBindMatrix()}setBindMatrix(e){this.updateMatrix(e)}setBindPose(e){this.setBindMatrix(e)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){var e;if(this._linkedTransformNode){const t=w.Vector3[0],i=w.Quaternion[0],n=w.Vector3[1];this.getRestMatrix().decompose(t,i,n),this._linkedTransformNode.position.copyFrom(n),this._linkedTransformNode.rotationQuaternion=(e=this._linkedTransformNode.rotationQuaternion)!==null&&e!==void 0?e:ee.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(i),this._linkedTransformNode.scaling.copyFrom(t)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._absoluteMatrix}getAbsoluteTransform(){return this._absoluteMatrix}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=g.Zero(),this._localRotation=ee.Zero(),this._localPosition=g.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,D.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(e,t=!0,i=!0){this._bindMatrix.copyFrom(e),t&&this._updateAbsoluteBindMatrices(),i?this._matrix=e:this.markAsDirty()}_updateAbsoluteBindMatrices(e,t=!0){if(e||(e=this._bindMatrix),this.parent?e.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(e),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),t)for(let i=0;i<this.children.length;i++)this.children[i]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(e,t=rt.LOCAL,i,n=!0){const r=this.getLocalMatrix();if(t==rt.LOCAL)n?(r.addAtIndex(12,e.x),r.addAtIndex(13,e.y),r.addAtIndex(14,e.z)):r.setTranslationFromFloats(e.x,e.y,e.z);else{let a=null;i&&(a=i.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const o=Tt._TmpMats[0],l=Tt._TmpVecs[0];this.parent?i&&a?(o.copyFrom(this.parent.getAbsoluteMatrix()),o.multiplyToRef(a,o)):o.copyFrom(this.parent.getAbsoluteMatrix()):D.IdentityToRef(o),n&&o.setTranslationFromFloats(0,0,0),o.invert(),g.TransformCoordinatesToRef(e,o,l),n?(r.addAtIndex(12,l.x),r.addAtIndex(13,l.y),r.addAtIndex(14,l.z)):r.setTranslationFromFloats(l.x,l.y,l.z)}this._markAsDirtyAndDecompose()}translate(e,t=rt.LOCAL,i){this._updatePosition(e,t,i,!0)}setPosition(e,t=rt.LOCAL,i){this._updatePosition(e,t,i,!1)}setAbsolutePosition(e,t){this.setPosition(e,rt.WORLD,t)}scale(e,t,i,n=!1){const r=this.getLocalMatrix(),a=Tt._TmpMats[0];D.ScalingToRef(e,t,i,a),a.multiplyToRef(r,r),a.invert();for(const o of this.children){const l=o.getLocalMatrix();l.multiplyToRef(a,l),l.multiplyAtIndex(12,e),l.multiplyAtIndex(13,t),l.multiplyAtIndex(14,i),o._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),n)for(const o of this.children)o.scale(e,t,i,n)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,n=rt.LOCAL,r){if(n===rt.LOCAL){const l=Tt._TmpQuat;ee.RotationYawPitchRollToRef(e,t,i,l),this.setRotationQuaternion(l,n,r);return}const a=Tt._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(a,r))return;const o=Tt._TmpMats[1];D.RotationYawPitchRollToRef(e,t,i,o),a.multiplyToRef(o,o),this._rotateWithMatrix(o,n,r)}rotate(e,t,i=rt.LOCAL,n){const r=Tt._TmpMats[0];r.setTranslationFromFloats(0,0,0),D.RotationAxisToRef(e,t,r),this._rotateWithMatrix(r,i,n)}setAxisAngle(e,t,i=rt.LOCAL,n){if(i===rt.LOCAL){const o=Tt._TmpQuat;ee.RotationAxisToRef(e,t,o),this.setRotationQuaternion(o,i,n);return}const r=Tt._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,n))return;const a=Tt._TmpMats[1];D.RotationAxisToRef(e,t,a),r.multiplyToRef(a,a),this._rotateWithMatrix(a,i,n)}setRotation(e,t=rt.LOCAL,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=rt.LOCAL,i){if(t===rt.LOCAL){this._decompose(),this._localRotation.copyFrom(e),this._markAsDirtyAndCompose();return}const n=Tt._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,i))return;const r=Tt._TmpMats[1];D.FromQuaternionToRef(e,r),n.multiplyToRef(r,r),this._rotateWithMatrix(r,t,i)}setRotationMatrix(e,t=rt.LOCAL,i){if(t===rt.LOCAL){const a=Tt._TmpQuat;ee.FromRotationMatrixToRef(e,a),this.setRotationQuaternion(a,t,i);return}const n=Tt._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,i))return;const r=Tt._TmpMats[1];r.copyFrom(e),n.multiplyToRef(e,r),this._rotateWithMatrix(r,t,i)}_rotateWithMatrix(e,t=rt.LOCAL,i){const n=this.getLocalMatrix(),r=n.m[12],a=n.m[13],o=n.m[14],l=this.getParent(),c=Tt._TmpMats[3],u=Tt._TmpMats[4];l&&t==rt.WORLD?(i?(c.copyFrom(i.getWorldMatrix()),l.getAbsoluteMatrix().multiplyToRef(c,c)):c.copyFrom(l.getAbsoluteMatrix()),u.copyFrom(c),u.invert(),n.multiplyToRef(c,n),n.multiplyToRef(e,n),n.multiplyToRef(u,n)):t==rt.WORLD&&i?(c.copyFrom(i.getWorldMatrix()),u.copyFrom(c),u.invert(),n.multiplyToRef(c,n),n.multiplyToRef(e,n),n.multiplyToRef(u,n)):n.multiplyToRef(e,n),n.setTranslationFromFloats(r,a,o),this.computeAbsoluteMatrices(),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(e,t){const i=Tt._TmpMats[2];return e.copyFrom(this.getAbsoluteMatrix()),t?(e.multiplyToRef(t.getWorldMatrix(),e),D.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):D.IdentityToRef(i),e.invert(),isNaN(e.m[0])?!1:(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=rt.LOCAL,t=null){const i=g.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=rt.LOCAL,t,i){if(e==rt.LOCAL){const n=this.getLocalMatrix();i.x=n.m[12],i.y=n.m[13],i.z=n.m[14]}else{let n=null;t&&(n=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let r=Tt._TmpMats[0];t&&n?(r.copyFrom(this.getAbsoluteMatrix()),r.multiplyToRef(n,r)):r=this.getAbsoluteMatrix(),i.x=r.m[12],i.y=r.m[13],i.z=r.m[14]}}getAbsolutePosition(e=null){const t=g.Zero();return this.getPositionToRef(rt.WORLD,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(rt.WORLD,e,t)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);const i=this._skeleton.getPoseMatrix();i&&this._absoluteMatrix.multiplyToRef(i,this._absoluteMatrix)}const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(e,t=null){const i=g.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let n=null;t&&(n=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const r=Tt._TmpMats[0];r.copyFrom(this.getAbsoluteMatrix()),t&&n&&r.multiplyToRef(n,r),g.TransformNormalToRef(e,r,i),i.normalize()}getRotation(e=rt.LOCAL,t=null){const i=g.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=rt.LOCAL,t=null,i){const n=Tt._TmpQuat;this.getRotationQuaternionToRef(e,t,n),n.toEulerAnglesToRef(i)}getRotationQuaternion(e=rt.LOCAL,t=null){const i=ee.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=rt.LOCAL,t=null,i){if(e==rt.LOCAL)this._decompose(),i.copyFrom(this._localRotation);else{const n=Tt._TmpMats[0],r=this.getAbsoluteMatrix();t?r.multiplyToRef(t.getWorldMatrix(),n):n.copyFrom(r),n.multiplyAtIndex(0,this._scalingDeterminant),n.multiplyAtIndex(1,this._scalingDeterminant),n.multiplyAtIndex(2,this._scalingDeterminant),n.decompose(void 0,i,void 0)}}getRotationMatrix(e=rt.LOCAL,t){const i=D.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=rt.LOCAL,t,i){if(e==rt.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(i);else{const n=Tt._TmpMats[0],r=this.getAbsoluteMatrix();t?r.multiplyToRef(t.getWorldMatrix(),n):n.copyFrom(r),n.multiplyAtIndex(0,this._scalingDeterminant),n.multiplyAtIndex(1,this._scalingDeterminant),n.multiplyAtIndex(2,this._scalingDeterminant),n.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){const i=g.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let n=null;t&&(n=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const r=Tt._TmpMats[0];r.copyFrom(this.getAbsoluteMatrix()),t&&n&&r.multiplyToRef(n,r),g.TransformCoordinatesToRef(e,r,i)}getLocalPositionFromAbsolute(e,t=null){const i=g.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let n=null;t&&(n=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const r=Tt._TmpMats[0];r.copyFrom(this.getAbsoluteMatrix()),t&&n&&r.multiplyToRef(n,r),r.invert(),g.TransformCoordinatesToRef(e,r,i)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}}Tt._TmpVecs=mi.BuildArray(2,g.Zero);Tt._TmpQuat=ee.Identity();Tt._TmpMats=mi.BuildArray(5,D.Identity);class Jp{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return this._texture?this._texture.isCube:!1}set isCube(e){this._texture&&(this._texture.isCube=e)}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return(e==null?void 0:e._shareDepth)!==void 0}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=qn.Zero(),this._cachedBaseSize=qn.Zero(),this._initialSamplingMode=2,this._texture=Jp._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine())}isReady(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}class _t extends Jp{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}get gammaSpace(){if(this._texture)this._texture._gammaSpace===null&&(this._texture._gammaSpace=this._gammaSpace);else return this._gammaSpace;return this._texture._gammaSpace&&!this._texture._useSRGBBuffer}set gammaSpace(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}this._markAllSubMeshesAsTexturesDirty()}get isRGBD(){return this._texture!=null&&this._texture._isRGBD}set isRGBD(e){this._texture&&(this._texture._isRGBD=e)}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return this._texture?this._texture._linearSpecularLOD:!1}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=$p()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=_t.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=new Array,this.onDisposeObservable=new O,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?_t._IsScene(e)?this._scene=e:this._engine=e:this._scene=Fe.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}checkTransformsAreIdentical(e){return e!==null}getTextureMatrix(){return D.IdentityReadOnly}getReflectionTextureMatrix(){return D.IdentityReadOnly}getRefractionTextureMatrix(){return this.getReflectionTextureMatrix()}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,i,n,r,a){const o=this._getEngine();if(!o)return null;const l=o._getUseSRGBBuffer(!!r,t),c=o.getLoadedTexturesCache();for(let u=0;u<c.length;u++){const h=c[u];if((r===void 0||l===h._useSRGBBuffer)&&(n===void 0||n===h.invertY)&&h.url===e&&h.generateMipMaps===!t&&(!i||i===h.samplingMode)&&(a===void 0||a===h.isCube))return h.incrementReferences(),h}return null}_rebuild(){}clone(){return null}get textureType(){return this._texture&&this._texture.type!==void 0?this._texture.type:0}get textureFormat(){return this._texture&&this._texture.format!==void 0?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,i=null,n=!0,r=!1,a=0,o=0,l=Number.MAX_VALUE,c=Number.MAX_VALUE){if(!this._texture)return null;const u=this._getEngine();if(!u)return null;const h=this.getSize();let d=h.width,f=h.height;t!==0&&(d=d/Math.pow(2,t),f=f/Math.pow(2,t),d=Math.round(d),f=Math.round(f)),l=Math.min(d,l),c=Math.min(f,c);try{return this._texture.isCube?u._readTexturePixels(this._texture,l,c,e,t,i,n,r,a,o):u._readTexturePixels(this._texture,l,c,-1,t,i,n,r,a,o)}catch(p){return null}}_readPixelsSync(e=0,t=0,i=null,n=!0,r=!1){if(!this._texture)return null;const a=this.getSize();let o=a.width,l=a.height;const c=this._getEngine();if(!c)return null;t!=0&&(o=o/Math.pow(2,t),l=l/Math.pow(2,t),o=Math.round(o),l=Math.round(l));try{return this._texture.isCube?c._readTexturePixelsSync(this._texture,o,l,e,t,i,n,r):c._readTexturePixelsSync(this._texture,o,l,-1,t,i,n,r)}catch(u){return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const t=this._parentContainer.textures.indexOf(this);t>-1&&this._parentContainer.textures.splice(t,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;const t=Pe.Serialize(this);return Pe.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let i=e.length;if(i===0){t();return}for(let n=0;n<e.length;n++){const r=e[n];if(r.isReady())--i===0&&t();else{const a=r.onLoadObservable;a?a.addOnce(()=>{--i===0&&t()}):--i===0&&t()}}}static _IsScene(e){return e.getClassName()==="Scene"}}_t.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4;S([b()],_t.prototype,"uniqueId",void 0);S([b()],_t.prototype,"name",void 0);S([b()],_t.prototype,"metadata",void 0);S([b("hasAlpha")],_t.prototype,"_hasAlpha",void 0);S([b("getAlphaFromRGB")],_t.prototype,"_getAlphaFromRGB",void 0);S([b()],_t.prototype,"level",void 0);S([b("coordinatesIndex")],_t.prototype,"_coordinatesIndex",void 0);S([b()],_t.prototype,"optimizeUVAllocation",void 0);S([b("coordinatesMode")],_t.prototype,"_coordinatesMode",void 0);S([b()],_t.prototype,"wrapU",null);S([b()],_t.prototype,"wrapV",null);S([b()],_t.prototype,"wrapR",void 0);S([b()],_t.prototype,"anisotropicFilteringLevel",void 0);S([b()],_t.prototype,"isCube",null);S([b()],_t.prototype,"is3D",null);S([b()],_t.prototype,"is2DArray",null);S([b()],_t.prototype,"gammaSpace",null);S([b()],_t.prototype,"invertZ",void 0);S([b()],_t.prototype,"lodLevelInAlpha",void 0);S([b()],_t.prototype,"lodGenerationOffset",null);S([b()],_t.prototype,"lodGenerationScale",null);S([b()],_t.prototype,"linearSpecularLOD",null);S([ht()],_t.prototype,"irradianceTexture",null);S([b()],_t.prototype,"isRenderTarget",void 0);function TE(s,e,t=!1){const i=e.width,n=e.height;if(s instanceof Float32Array){let c=s.byteLength/s.BYTES_PER_ELEMENT;const u=new Uint8Array(c);for(;--c>=0;){let h=s[c];h<0?h=0:h>1&&(h=1),u[c]=h*255}s=u}const r=document.createElement("canvas");r.width=i,r.height=n;const a=r.getContext("2d");if(!a)return null;const o=a.createImageData(i,n);if(o.data.set(s),a.putImageData(o,0,0),t){const c=document.createElement("canvas");c.width=i,c.height=n;const u=c.getContext("2d");return u?(u.translate(0,n),u.scale(1,-1),u.drawImage(r,0,0),c.toDataURL("image/png")):null}return r.toDataURL("image/png")}function ZT(s,e=0,t=0){const i=s.getInternalTexture();if(!i)return null;const n=s._readPixelsSync(e,t);return n?TE(n,s.getSize(),i.invertY):null}function qT(s,e=0,t=0){return Ie(this,null,function*(){const i=s.getInternalTexture();if(!i)return null;const n=yield s.readPixels(e,t);return n?TE(n,s.getSize(),i.invertY):null})}class Pi{}Pi.UseOpenGLOrientationForUV=!1;class H extends _t{get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,t,i,n,r=H.TRILINEAR_SAMPLINGMODE,a=null,o=null,l=null,c=!1,u,h,d,f,p){var m,_,E,v,y,A,I,T,R;super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new O,this._isBlocking=!0,this.name=e||"",this.url=e;let x,F=!1,L=null;typeof i=="object"&&i!==null?(x=(m=i.noMipmap)!==null&&m!==void 0?m:!1,n=(_=i.invertY)!==null&&_!==void 0?_:!Pi.UseOpenGLOrientationForUV,r=(E=i.samplingMode)!==null&&E!==void 0?E:H.TRILINEAR_SAMPLINGMODE,a=(v=i.onLoad)!==null&&v!==void 0?v:null,o=(y=i.onError)!==null&&y!==void 0?y:null,l=(A=i.buffer)!==null&&A!==void 0?A:null,c=(I=i.deleteBuffer)!==null&&I!==void 0?I:!1,u=i.format,h=i.mimeType,d=i.loaderOptions,f=i.creationFlags,F=(T=i.useSRGBBuffer)!==null&&T!==void 0?T:!1,L=(R=i.internalTexture)!==null&&R!==void 0?R:null):x=!!i,this._noMipmap=x,this._invertY=n===void 0?!Pi.UseOpenGLOrientationForUV:n,this._initialSamplingMode=r,this._buffer=l,this._deleteBuffer=c,this._mimeType=h,this._loaderOptions=d,this._creationFlags=f,this._useSRGBBuffer=F,this._forcedExtension=p,u&&(this._format=u);const V=this.getScene(),Z=this._getEngine();if(!Z)return;Z.onBeforeTextureInitObservable.notifyObservers(this);const ne=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),this._texture._cachedWrapU!==null&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),this._texture._cachedWrapV!==null&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),this._texture._cachedWrapR!==null&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),a&&a(),!this.isBlocking&&V&&V.resetCachedMaterial()},ae=(Ue,Ve)=>{this._loadingError=!0,this._errorObject={message:Ue,exception:Ve},o&&o(Ue,Ve),H.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!L){this._delayedOnLoad=ne,this._delayedOnError=ae;return}if(this._texture=L!=null?L:this._getFromCache(this.url,x,r,this._invertY,F),this._texture)if(this._texture.isReady)yu.SetImmediate(()=>ne());else{const Ue=this._texture.onLoadedObservable.add(ne);this._texture.onErrorObservable.add(Ve=>{var $e;ae(Ve.message,Ve.exception),($e=this._texture)===null||$e===void 0||$e.onLoadedObservable.remove(Ue)})}else if(!V||!V.useDelayedTextureLoading){try{this._texture=Z.createTexture(this.url,x,this._invertY,V,r,ne,ae,this._buffer,void 0,this._format,this._forcedExtension,h,d,f,F)}catch(Ue){throw ae("error loading",Ue),Ue}c&&(this._buffer=null)}else this.delayLoadState=4,this._delayedOnLoad=ne,this._delayedOnError=ae}updateURL(e,t=null,i,n){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1)),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=n,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(this.delayLoadState!==4)return;const e=this.getScene();e&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer),this._texture?this._delayedOnLoad&&(this._texture.isReady?yu.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,i,n){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,g.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,n),n.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,n.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,n.z+=this.wRotationCenter}checkTransformsAreIdentical(e){return e!==null&&this.uOffset===e.uOffset&&this.vOffset===e.vOffset&&this.uScale===e.uScale&&this.vScale===e.vScale&&this.uAng===e.uAng&&this.vAng===e.vAng&&this.wAng===e.wAng}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=D.Zero(),this._rowGenerationMatrix=new D,this._t0=g.Zero(),this._t1=g.Zero(),this._t2=g.Zero()),D.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(D.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,w.Matrix[0]),D.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,w.Matrix[1]),D.ScalingToRef(this._cachedUScale,this._cachedVScale,0,w.Matrix[2]),D.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,w.Matrix[3]),w.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(w.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(w.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(w.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),D.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const t=this.getScene();return t?(this.optimizeUVAllocation&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)),this._cachedTextureMatrix):this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode)if(this.coordinatesMode===H.PROJECTION_MODE){if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}else return this._cachedReflectionTextureMatrix;this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=D.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=D.Zero());const t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case H.PLANAR_MODE:{D.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break}case H.PROJECTION_MODE:{D.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const i=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=i.updateFlag,i.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:D.IdentityToRef(this._cachedReflectionTextureMatrix);break}return t&&e.markAllMaterialsAsDirty(1,i=>i.getActiveTextures().indexOf(this)!==-1),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return Pe.Clone(()=>new H(this._texture?this._texture.url:null,this.getScene(),e),this)}serialize(){var e,t;const i=this.name;H.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const n=super.serialize(H._SerializeInternalTextureUniqueId);return n?((H.SerializeBuffers||H.ForceSerializeBuffers)&&(typeof this._buffer=="string"&&this._buffer.substr(0,5)==="data:"?(n.base64String=this._buffer,n.name=n.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?n.base64String="data:image/png;base64,"+Qp(this._buffer):(H.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(n.base64String=!this._engine||this._engine._features.supportSyncTextureRead?ZT(this):qT(this))),n.invertY=this._invertY,n.samplingMode=this.samplingMode,n._creationFlags=this._creationFlags,n._useSRGBBuffer=this._useSRGBBuffer,H._SerializeInternalTextureUniqueId&&(n.internalTextureUniqueId=(t=(e=this._texture)===null||e===void 0?void 0:e.uniqueId)!==null&&t!==void 0?t:void 0),this.name=i,n):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,t,i){if(e.customType){const c=dl.Instantiate(e.customType).Parse(e,t,i);return e.samplingMode&&c.updateSamplingMode&&c._samplingMode&&c._samplingMode!==e.samplingMode&&c.updateSamplingMode(e.samplingMode),c}if(e.isCube&&!e.isRenderTarget)return H._CubeTextureParser(e,t,i);const n=e.internalTextureUniqueId!==void 0;if(!e.name&&!e.isRenderTarget&&!n)return null;let r;if(n){const l=t.getEngine().getLoadedTexturesCache();for(const c of l)if(c.uniqueId===e.internalTextureUniqueId){r=c;break}}const a=l=>{var c;if(l&&l._texture&&(l._texture._cachedWrapU=null,l._texture._cachedWrapV=null,l._texture._cachedWrapR=null),e.samplingMode){const u=e.samplingMode;l&&l.samplingMode!==u&&l.updateSamplingMode(u)}if(l&&e.animations)for(let u=0;u<e.animations.length;u++){const h=e.animations[u],d=hn("BABYLON.Animation");d&&l.animations.push(d.Parse(h))}n&&!r&&((c=l==null?void 0:l._texture)===null||c===void 0||c._setUniqueId(e.internalTextureUniqueId))};return Pe.Parse(()=>{var l,c,u;let h=!0;if(e.noMipmap&&(h=!1),e.mirrorPlane){const d=H._CreateMirror(e.name,e.renderTargetSize,t,h);return d._waitingRenderList=e.renderList,d.mirrorPlane=Zn.FromArray(e.mirrorPlane),a(d),d}else if(e.isRenderTarget){let d=null;if(e.isCube){if(t.reflectionProbes)for(let f=0;f<t.reflectionProbes.length;f++){const p=t.reflectionProbes[f];if(p.name===e.name)return p.cubeTexture}}else d=H._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,h,(l=e._creationFlags)!==null&&l!==void 0?l:0),d._waitingRenderList=e.renderList;return a(d),d}else{let d;if(e.base64String&&!r)d=H.CreateFromBase64String(e.base64String,e.base64String,t,!h,e.invertY,e.samplingMode,()=>{a(d)},(c=e._creationFlags)!==null&&c!==void 0?c:0,(u=e._useSRGBBuffer)!==null&&u!==void 0?u:!1),d.name=e.name;else{let f;e.name&&(e.name.indexOf("://")>0||e.name.startsWith("data:"))?f=e.name:f=i+e.name,e.url&&(e.url.startsWith("data:")||H.UseSerializedUrlIfAny)&&(f=e.url);const p={noMipmap:!h,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{a(d)},internalTexture:r};d=new H(f,t,p)}return d}},e,t)}static CreateFromBase64String(e,t,i,n,r,a=H.TRILINEAR_SAMPLINGMODE,o=null,l=null,c=5,u){return new H("data:"+t,i,n,r,a,o,l,e,!1,c,void 0,void 0,u)}static LoadFromDataString(e,t,i,n=!1,r,a=!0,o=H.TRILINEAR_SAMPLINGMODE,l=null,c=null,u=5,h){return e.substr(0,5)!=="data:"&&(e="data:"+e),new H(e,i,r,a,o,l,c,t,n,u,void 0,void 0,h)}}H.SerializeBuffers=!0;H.ForceSerializeBuffers=!1;H.OnTextureLoadErrorObservable=new O;H._SerializeInternalTextureUniqueId=!1;H._CubeTextureParser=(s,e,t)=>{throw De("CubeTexture")};H._CreateMirror=(s,e,t,i)=>{throw De("MirrorTexture")};H._CreateRenderTargetTexture=(s,e,t,i,n)=>{throw De("RenderTargetTexture")};H.NEAREST_SAMPLINGMODE=1;H.NEAREST_NEAREST_MIPLINEAR=8;H.BILINEAR_SAMPLINGMODE=2;H.LINEAR_LINEAR_MIPNEAREST=11;H.TRILINEAR_SAMPLINGMODE=3;H.LINEAR_LINEAR_MIPLINEAR=3;H.NEAREST_NEAREST_MIPNEAREST=4;H.NEAREST_LINEAR_MIPNEAREST=5;H.NEAREST_LINEAR_MIPLINEAR=6;H.NEAREST_LINEAR=7;H.NEAREST_NEAREST=1;H.LINEAR_NEAREST_MIPNEAREST=9;H.LINEAR_NEAREST_MIPLINEAR=10;H.LINEAR_LINEAR=2;H.LINEAR_NEAREST=12;H.EXPLICIT_MODE=0;H.SPHERICAL_MODE=1;H.PLANAR_MODE=2;H.CUBIC_MODE=3;H.PROJECTION_MODE=4;H.SKYBOX_MODE=5;H.INVCUBIC_MODE=6;H.EQUIRECTANGULAR_MODE=7;H.FIXED_EQUIRECTANGULAR_MODE=8;H.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;H.CLAMP_ADDRESSMODE=0;H.WRAP_ADDRESSMODE=1;H.MIRROR_ADDRESSMODE=2;H.UseSerializedUrlIfAny=!1;S([b()],H.prototype,"url",void 0);S([b()],H.prototype,"uOffset",void 0);S([b()],H.prototype,"vOffset",void 0);S([b()],H.prototype,"uScale",void 0);S([b()],H.prototype,"vScale",void 0);S([b()],H.prototype,"uAng",void 0);S([b()],H.prototype,"vAng",void 0);S([b()],H.prototype,"wAng",void 0);S([b()],H.prototype,"uRotationCenter",void 0);S([b()],H.prototype,"vRotationCenter",void 0);S([b()],H.prototype,"wRotationCenter",void 0);S([b()],H.prototype,"homogeneousRotationInUVTransform",void 0);S([b()],H.prototype,"isBlocking",null);Rt("BABYLON.Texture",H);Pe._TextureParser=H.Parse;_e.prototype.updateRawTexture=function(s,e,t,i,n=null,r=0,a=!1){if(!s)return;const o=this._getRGBABufferInternalSizedFormat(r,t,a),l=this._getInternalFormat(t),c=this._getWebGLTextureType(r);this._bindTextureDirectly(this._gl.TEXTURE_2D,s,!0),this._unpackFlipY(i===void 0?!0:!!i),this._doNotHandleContextLost||(s._bufferView=e,s.format=t,s.type=r,s.invertY=i,s._compression=n),s.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[n],s.width,s.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,o,s.width,s.height,0,l,c,e),s.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),s.isReady=!0};_e.prototype.createRawTexture=function(s,e,t,i,n,r,a,o=null,l=0,c=0,u=!1){const h=new dn(this,Pt.Raw);h.baseWidth=e,h.baseHeight=t,h.width=e,h.height=t,h.format=i,h.generateMipMaps=n,h.samplingMode=a,h.invertY=r,h._compression=o,h.type=l,h._useSRGBBuffer=this._getUseSRGBBuffer(u,!n),this._doNotHandleContextLost||(h._bufferView=s),this.updateRawTexture(h,s,i,r,o,l,h._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,h,!0);const d=this._getSamplingParameters(a,n);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,d.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,d.min),n&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(h),h};_e.prototype.createRawCubeTexture=function(s,e,t,i,n,r,a,o=null){const l=this._gl,c=new dn(this,Pt.CubeRaw);c.isCube=!0,c.format=t,c.type=i,this._doNotHandleContextLost||(c._bufferViewArray=s);const u=this._getWebGLTextureType(i);let h=this._getInternalFormat(t);h===l.RGB&&(h=l.RGBA),u===l.FLOAT&&!this._caps.textureFloatLinearFiltering?(n=!1,a=1,U.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):u===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(n=!1,a=1,U.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):u===l.FLOAT&&!this._caps.textureFloatRender?(n=!1,U.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):u===l.HALF_FLOAT&&!this._caps.colorBufferFloat&&(n=!1,U.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));const d=e,f=d;if(c.width=d,c.height=f,c.invertY=r,c._compression=o,!this.needPOTTextures||q.IsExponentOfTwo(c.width)&&q.IsExponentOfTwo(c.height)||(n=!1),s)this.updateRawCubeTexture(c,s,t,i,r,o);else{const _=this._getRGBABufferInternalSizedFormat(i),E=0;this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,c,!0);for(let v=0;v<6;v++)o?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+v,E,this.getCaps().s3tc[o],c.width,c.height,0,void 0):l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+v,E,_,c.width,c.height,0,h,u,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,c,!0),s&&n&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const m=this._getSamplingParameters(a,n);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,m.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,m.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),c.generateMipMaps=n,c.samplingMode=a,c.isReady=!0,c};_e.prototype.updateRawCubeTexture=function(s,e,t,i,n,r=null,a=0){s._bufferViewArray=e,s.format=t,s.type=i,s.invertY=n,s._compression=r;const o=this._gl,l=this._getWebGLTextureType(i);let c=this._getInternalFormat(t);const u=this._getRGBABufferInternalSizedFormat(i);let h=!1;c===o.RGB&&(c=o.RGBA,h=!0),this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,s,!0),this._unpackFlipY(n===void 0?!0:!!n),s.width%4!==0&&o.pixelStorei(o.UNPACK_ALIGNMENT,1);for(let f=0;f<6;f++){let p=e[f];r?o.compressedTexImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+f,a,this.getCaps().s3tc[r],s.width,s.height,0,p):(h&&(p=SE(p,s.width,s.height,i)),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+f,a,u,s.width,s.height,0,c,l,p))}(!this.needPOTTextures||q.IsExponentOfTwo(s.width)&&q.IsExponentOfTwo(s.height))&&s.generateMipMaps&&a===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),s.isReady=!0};_e.prototype.createRawCubeTextureFromUrl=function(s,e,t,i,n,r,a,o,l=null,c=null,u=3,h=!1){const d=this._gl,f=this.createRawCubeTexture(null,t,i,n,!r,h,u,null);e==null||e.addPendingData(f),f.url=s,f.isReady=!1,this._internalTexturesCache.push(f);const p=(_,E)=>{e==null||e.removePendingData(f),c&&_&&c(_.status+" "+_.statusText,E)},m=_=>{const E=f.width,v=a(_);if(v){if(o){const y=this._getWebGLTextureType(n);let A=this._getInternalFormat(i);const I=this._getRGBABufferInternalSizedFormat(n);let T=!1;A===d.RGB&&(A=d.RGBA,T=!0),this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,f,!0),this._unpackFlipY(!1);const R=o(v);for(let x=0;x<R.length;x++){const F=E>>x;for(let L=0;L<6;L++){let V=R[x][L];T&&(V=SE(V,F,F,n)),d.texImage2D(L,x,I,F,F,0,A,y,V)}}this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(f,v,i,n,h);f.isReady=!0,e==null||e.removePendingData(f),f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),l&&l()}};return this._loadFile(s,_=>{m(_)},void 0,e==null?void 0:e.offlineProvider,!0,p),f};function SE(s,e,t,i){let n,r=1;i===1?n=new Float32Array(e*t*4):i===2?(n=new Uint16Array(e*t*4),r=15360):i===7?n=new Uint32Array(e*t*4):n=new Uint8Array(e*t*4);for(let a=0;a<e;a++)for(let o=0;o<t;o++){const l=(o*e+a)*3,c=(o*e+a)*4;n[c+0]=s[l+0],n[c+1]=s[l+1],n[c+2]=s[l+2],n[c+3]=r}return n}function CE(s){return function(e,t,i,n,r,a,o,l,c=null,u=0){const h=s?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,d=s?Pt.Raw3D:Pt.Raw2DArray,f=new dn(this,d);f.baseWidth=t,f.baseHeight=i,f.baseDepth=n,f.width=t,f.height=i,f.depth=n,f.format=r,f.type=u,f.generateMipMaps=a,f.samplingMode=l,s?f.is3D=!0:f.is2DArray=!0,this._doNotHandleContextLost||(f._bufferView=e),s?this.updateRawTexture3D(f,e,r,o,c,u):this.updateRawTexture2DArray(f,e,r,o,c,u),this._bindTextureDirectly(h,f,!0);const p=this._getSamplingParameters(l,a);return this._gl.texParameteri(h,this._gl.TEXTURE_MAG_FILTER,p.mag),this._gl.texParameteri(h,this._gl.TEXTURE_MIN_FILTER,p.min),a&&this._gl.generateMipmap(h),this._bindTextureDirectly(h,null),this._internalTexturesCache.push(f),f}}_e.prototype.createRawTexture2DArray=CE(!1);_e.prototype.createRawTexture3D=CE(!0);function IE(s){return function(e,t,i,n,r=null,a=0){const o=s?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(a),c=this._getInternalFormat(i),u=this._getRGBABufferInternalSizedFormat(a,i);this._bindTextureDirectly(o,e,!0),this._unpackFlipY(n===void 0?!0:!!n),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=n,e._compression=r),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&t?this._gl.compressedTexImage3D(o,0,this.getCaps().s3tc[r],e.width,e.height,e.depth,0,t):this._gl.texImage3D(o,0,u,e.width,e.height,e.depth,0,c,l,t),e.generateMipMaps&&this._gl.generateMipmap(o),this._bindTextureDirectly(o,null),e.isReady=!0}}_e.prototype.updateRawTexture2DArray=IE(!1);_e.prototype.updateRawTexture3D=IE(!0);class an extends H{constructor(e,t,i,n,r,a=!0,o=!1,l=3,c=0,u,h){super(null,r,!a,o,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,u),this.format=n,this._engine&&(!this._engine._caps.textureFloatLinearFiltering&&c===1&&(l=1),!this._engine._caps.textureHalfFloatLinearFiltering&&c===2&&(l=1),this._texture=this._engine.createRawTexture(e,t,i,n,a,o,l,null,c,u!=null?u:0,h!=null?h:!1),this.wrapU=H.CLAMP_ADDRESSMODE,this.wrapV=H.CLAMP_ADDRESSMODE)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)}static CreateLuminanceTexture(e,t,i,n,r=!0,a=!1,o=3){return new an(e,t,i,1,n,r,a,o)}static CreateLuminanceAlphaTexture(e,t,i,n,r=!0,a=!1,o=3){return new an(e,t,i,2,n,r,a,o)}static CreateAlphaTexture(e,t,i,n,r=!0,a=!1,o=3){return new an(e,t,i,0,n,r,a,o)}static CreateRGBTexture(e,t,i,n,r=!0,a=!1,o=3,l=0,c=0,u=!1){return new an(e,t,i,4,n,r,a,o,l,c,u)}static CreateRGBATexture(e,t,i,n,r=!0,a=!1,o=3,l=0,c=0,u=!1){return new an(e,t,i,5,n,r,a,o,l,c,u)}static CreateRGBAStorageTexture(e,t,i,n,r=!0,a=!1,o=3,l=0,c=!1){return new an(e,t,i,5,n,r,a,o,l,1,c)}static CreateRTexture(e,t,i,n,r=!0,a=!1,o=H.TRILINEAR_SAMPLINGMODE,l=1){return new an(e,t,i,6,n,r,a,o,l)}static CreateRStorageTexture(e,t,i,n,r=!0,a=!1,o=H.TRILINEAR_SAMPLINGMODE,l=1){return new an(e,t,i,6,n,r,a,o,l,1)}}class Cu{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,i){this.name=e,this.id=t,this.bones=new Array,this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=D.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new O,this.bones=[],this._scene=i||Fe.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const n=this._scene.getEngine().getCaps();this._canUseTextureForBones=n.textureFloat&&n.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){return this.needInitialSkinMatrix?(e._bonesTransformMatrices||this.prepare(),e._bonesTransformMatrices):((!this._transformMatrices||this._isDirty)&&this.prepare(),this._transformMatrices)}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let i=!0;for(const n in this._ranges)i&&(t+=", ",i=!1),t+=n;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new To(e,t,i);for(let n=0,r=this.bones.length;n<r;n++)this.bones[n].animations[0]&&this.bones[n].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,n=this.bones.length;i<n;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let n=!0;const r=this._getHighestAnimationFrame()+1,a={},o=e.bones;let l,c;for(c=0,l=o.length;c<l;c++)a[o[c].name]=o[c];this.bones.length!==o.length&&(U.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${o.length}`),n=!1);const u=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(c=0,l=this.bones.length;c<l;c++){const d=this.bones[c].name,f=a[d];f?n=n&&this.bones[c].copyAnimationRange(f,t,r,i,u):(U.Warn("copyAnimationRange: not same rig, missing source bone "+d),n=!1)}const h=e.getAnimationRange(t);return h&&(this._ranges[t]=new To(t,h.from+r,h.to+r)),n}returnToRest(){for(const e of this.bones)e._index!==-1&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){const n=this.bones[t].animations[0].getHighestFrame();e<n&&(e=n)}return e}beginAnimation(e,t,i,n){const r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,t,i,n):null}static MakeAnimationAdditive(e,t=0,i){const n=e.getAnimationRange(i);if(!n)return null;const r=e._scene.getAllAnimatablesByTarget(e);let a=null;for(let l=0;l<r.length;l++){const c=r[l];if(c.fromFrame===(n==null?void 0:n.from)&&c.toFrame===(n==null?void 0:n.to)){a=c;break}}const o=e.getAnimatables();for(let l=0;l<o.length;l++){const u=o[l].animations;if(u)for(let h=0;h<u.length;h++)B.MakeAnimationAdditive(u[h],t,i)}return a&&(a.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){const n=this.bones[i];n._childUpdateId++;const r=n.getParent();if(r?n.getLocalMatrix().multiplyToRef(r.getFinalMatrix(),n.getFinalMatrix()):t?n.getLocalMatrix().multiplyToRef(t,n.getFinalMatrix()):n.getFinalMatrix().copyFrom(n.getLocalMatrix()),n._index!==-1){const a=n._index===null?i:n._index;n.getAbsoluteInverseBindMatrix().multiplyToArray(n.getFinalMatrix(),e,a*16)}}this._identity.copyToArray(e,this.bones.length*16)}prepare(e=!1){if(!e){const t=this.getScene().getRenderId();if(this._currentRenderId===t)return;this._currentRenderId=t}if(this._numBonesWithLinkedTransformNode>0){for(const t of this.bones)if(t._linkedTransformNode){const i=t._linkedTransformNode;t.position=i.position,i.rotationQuaternion?t.rotationQuaternion=i.rotationQuaternion:t.rotation=i.rotation,t.scaling=i.scaling}}if(this.needInitialSkinMatrix)for(const t of this._meshesWithPoseMatrix){const i=t.getPoseMatrix();let n=this._isDirty;if((!t._bonesTransformMatrices||t._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(t._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),n=!0),!!n){if(this._synchronizedWithMesh!==t){this._synchronizedWithMesh=t;for(const r of this.bones)r.getParent()||(r.getBindMatrix().multiplyToRef(i,w.Matrix[1]),r._updateAbsoluteBindMatrices(w.Matrix[1]));if(this.isUsingTextureForMatrices){const r=(this.bones.length+1)*4;(!t._transformMatrixTexture||t._transformMatrixTexture.getSize().width!==r)&&(t._transformMatrixTexture&&t._transformMatrixTexture.dispose(),t._transformMatrixTexture=an.CreateRGBATexture(t._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(t._bonesTransformMatrices,i),this.isUsingTextureForMatrices&&t._transformMatrixTexture&&t._transformMatrixTexture.update(t._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=an.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){const i=new Cu(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let n=0;n<this.bones.length;n++){const r=this.bones[n];let a=null;const o=r.getParent();if(o){const c=this.bones.indexOf(o);a=i.bones[c]}const l=new Tt(r.name,i,a,r.getBindMatrix().clone(),r.getRestMatrix().clone());l._index=r._index,r._linkedTransformNode&&l.linkTransformNode(r._linkedTransformNode),On.DeepCopy(r.animations,l.animations)}if(this._ranges){i._ranges={};for(const n in this._ranges){const r=this._ranges[n];r&&(i._ranges[n]=r.clone())}}return this._isDirty=!0,i.prepare(!0),i}enableBlending(e=.01){this.bones.forEach(t=>{t.animations.forEach(i=>{i.enableBlending=!0,i.blendingSpeed=e})})}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){var e;const t={};t.name=this.name,t.id=this.id,this.dimensionsAtRest&&(t.dimensionsAtRest=this.dimensionsAtRest.asArray()),t.bones=[],t.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let i=0;i<this.bones.length;i++){const n=this.bones[i],r=n.getParent(),a={parentBoneIndex:r?this.bones.indexOf(r):-1,index:n.getIndex(),name:n.name,id:n.id,matrix:n.getBindMatrix().toArray(),rest:n.getRestMatrix().toArray(),linkedTransformNodeId:(e=n.getTransformNode())===null||e===void 0?void 0:e.id};t.bones.push(a),n.length&&(a.length=n.length),n.metadata&&(a.metadata=n.metadata),n.animations&&n.animations.length>0&&(a.animation=n.animations[0].serialize()),t.ranges=[];for(const o in this._ranges){const l=this._ranges[o];if(!l)continue;const c={};c.name=o,c.from=l.from,c.to=l.to,t.ranges.push(c)}}return t}static Parse(e,t){const i=new Cu(e.name,e.id,t);e.dimensionsAtRest&&(i.dimensionsAtRest=g.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix;let n;for(n=0;n<e.bones.length;n++){const r=e.bones[n],a=e.bones[n].index;let o=null;r.parentBoneIndex>-1&&(o=i.bones[r.parentBoneIndex]);const l=r.rest?D.FromArray(r.rest):null,c=new Tt(r.name,i,o,D.FromArray(r.matrix),l,null,a);r.id!==void 0&&r.id!==null&&(c.id=r.id),r.length&&(c.length=r.length),r.metadata&&(c.metadata=r.metadata),r.animation&&c.animations.push(B.Parse(r.animation)),r.linkedTransformNodeId!==void 0&&r.linkedTransformNodeId!==null&&(i._hasWaitingData=!0,c._waitingTransformNodeId=r.linkedTransformNodeId)}if(e.ranges)for(n=0;n<e.ranges.length;n++){const r=e.ranges[n];i.createAnimationRange(r.name,r.from,r.to)}return i}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=new Array,t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;const n=this.bones[e];if(!n)return;n._index===void 0&&(n._index=e);const r=n.getParent();r&&this._sortBones(this.bones.indexOf(r),t,i),t.push(n)}setCurrentPoseAsRest(){this.bones.forEach(e=>{e.setCurrentPoseAsRest()})}}class zr{constructor(e,t,i,n=0,r=!1,a=!1,o=!1,l){this._isAlreadyOwned=!1,e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=a,this._divisor=l||1,t instanceof Ql?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=o?n:n*Float32Array.BYTES_PER_ELEMENT,r||this.create()}createVertexBuffer(e,t,i,n,r,a=!1,o){const l=a?t:t*Float32Array.BYTES_PER_ELEMENT,c=n?a?n:n*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new C(this._engine,this,e,this._updatable,!0,c,r===void 0?this._instanced:r,l,i,void 0,void 0,!0,this._divisor||o)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e),this._data=e):this._buffer=this._engine.createVertexBuffer(e)))}_rebuild(){this._buffer=null,this.create(this._data)}update(e){this.create(e)}updateDirectly(e,t,i,n=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,n?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),t===0&&i===void 0?this._data=e:this._data=null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null,this._data=null)}}class C{get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=e!=0;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}constructor(e,t,i,n,r,a,o,l,c,u,h=!1,d=!1,f=1,p=!1){if(t instanceof zr?(this._buffer=t,this._ownsBuffer=p):(this._buffer=new zr(e,t,n,a,r,o,d),this._ownsBuffer=!0),this.uniqueId=C._Counter++,this._kind=i,u==null){const _=this.getData();this.type=C.FLOAT,_ instanceof Int8Array?this.type=C.BYTE:_ instanceof Uint8Array?this.type=C.UNSIGNED_BYTE:_ instanceof Int16Array?this.type=C.SHORT:_ instanceof Uint16Array?this.type=C.UNSIGNED_SHORT:_ instanceof Int32Array?this.type=C.INT:_ instanceof Uint32Array&&(this.type=C.UNSIGNED_INT)}else this.type=u;const m=C.GetTypeByteLength(this.type);d?(this._size=c||(a?a/m:C.DeduceStride(i)),this.byteStride=a||this._buffer.byteStride||this._size*m,this.byteOffset=l||0):(this._size=c||a||C.DeduceStride(i),this.byteStride=a?a*m:this._buffer.byteStride||this._size*m,this.byteOffset=(l||0)*m),this.normalized=h,this._instanced=o!==void 0?o:!1,this._instanceDivisor=o?f:0,this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){this._buffer&&this._buffer._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const i=this.getData();if(!i)return null;const n=this.getSize()*C.GetTypeByteLength(this.type),r=e*this.getSize();if(this.type!==C.FLOAT||this.byteStride!==n){const a=new Float32Array(r);return this.forEach(r,(o,l)=>a[l]=o),a}if(!(i instanceof Array||i instanceof Float32Array)||this.byteOffset!==0||i.length!==r)if(i instanceof Array){const a=this.byteOffset/4;return i.slice(a,a+r)}else{if(i instanceof ArrayBuffer)return new Float32Array(i,this.byteOffset,r);{let a=i.byteOffset+this.byteOffset;if(t){const l=new Float32Array(r),c=new Float32Array(i.buffer,a,r);return l.set(c),l}const o=a%4;return o&&(a=Math.max(0,a-o)),new Float32Array(i.buffer,a,r)}}return t?i.slice():i}getBuffer(){return this._buffer.getBuffer()}getStrideSize(){return this.byteStride/C.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/C.GetTypeByteLength(this.type)}getSize(e=!1){return e?this._size*C.GetTypeByteLength(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e)}update(e){this._buffer.update(e)}updateDirectly(e,t,i=!1){this._buffer.updateDirectly(e,t,void 0,i)}dispose(){this._ownsBuffer&&this._buffer.dispose()}forEach(e,t){C.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,t)}static DeduceStride(e){switch(e){case C.UVKind:case C.UV2Kind:case C.UV3Kind:case C.UV4Kind:case C.UV5Kind:case C.UV6Kind:return 2;case C.NormalKind:case C.PositionKind:return 3;case C.ColorKind:case C.MatricesIndicesKind:case C.MatricesIndicesExtraKind:case C.MatricesWeightsKind:case C.MatricesWeightsExtraKind:case C.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetTypeByteLength(e){switch(e){case C.BYTE:case C.UNSIGNED_BYTE:return 1;case C.SHORT:case C.UNSIGNED_SHORT:return 2;case C.INT:case C.UNSIGNED_INT:case C.FLOAT:return 4;default:throw new Error(`Invalid type '${e}'`)}}static ForEach(e,t,i,n,r,a,o,l){if(e instanceof Array){let c=t/4;const u=i/4;for(let h=0;h<a;h+=n){for(let d=0;d<n;d++)l(e[c+d],h+d);c+=u}}else{const c=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),u=C.GetTypeByteLength(r);for(let h=0;h<a;h+=n){let d=t;for(let f=0;f<n;f++){const p=C._GetFloatValue(c,r,d,o);l(p,h+f),d+=u}t+=i}}}static _GetFloatValue(e,t,i,n){switch(t){case C.BYTE:{let r=e.getInt8(i);return n&&(r=Math.max(r/127,-1)),r}case C.UNSIGNED_BYTE:{let r=e.getUint8(i);return n&&(r=r/255),r}case C.SHORT:{let r=e.getInt16(i,!0);return n&&(r=Math.max(r/32767,-1)),r}case C.UNSIGNED_SHORT:{let r=e.getUint16(i,!0);return n&&(r=r/65535),r}case C.INT:return e.getInt32(i,!0);case C.UNSIGNED_INT:return e.getUint32(i,!0);case C.FLOAT:return e.getFloat32(i,!0);default:throw new Error(`Invalid component type ${t}`)}}}C._Counter=0;C.BYTE=5120;C.UNSIGNED_BYTE=5121;C.SHORT=5122;C.UNSIGNED_SHORT=5123;C.INT=5124;C.UNSIGNED_INT=5125;C.FLOAT=5126;C.PositionKind="position";C.NormalKind="normal";C.TangentKind="tangent";C.UVKind="uv";C.UV2Kind="uv2";C.UV3Kind="uv3";C.UV4Kind="uv4";C.UV5Kind="uv5";C.UV6Kind="uv6";C.ColorKind="color";C.ColorInstanceKind="instanceColor";C.MatricesIndicesKind="matricesIndices";C.MatricesWeightsKind="matricesWeights";C.MatricesIndicesExtraKind="matricesIndicesExtra";C.MatricesWeightsExtraKind="matricesWeightsExtra";class nf{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0}}class Xs{constructor(e,t,i){this.vectors=mi.BuildArray(8,g.Zero),this.center=g.Zero(),this.centerWorld=g.Zero(),this.extendSize=g.Zero(),this.extendSizeWorld=g.Zero(),this.directions=mi.BuildArray(3,g.Zero),this.vectorsWorld=mi.BuildArray(8,g.Zero),this.minimumWorld=g.Zero(),this.maximumWorld=g.Zero(),this.minimum=g.Zero(),this.maximum=g.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){const n=e.x,r=e.y,a=e.z,o=t.x,l=t.y,c=t.z,u=this.vectors;this.minimum.copyFromFloats(n,r,a),this.maximum.copyFromFloats(o,l,c),u[0].copyFromFloats(n,r,a),u[1].copyFromFloats(o,l,c),u[2].copyFromFloats(o,r,a),u[3].copyFromFloats(n,l,a),u[4].copyFromFloats(n,r,c),u[5].copyFromFloats(o,l,a),u[6].copyFromFloats(n,l,c),u[7].copyFromFloats(o,r,c),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||D.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){const t=Xs._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),n=i.length();i.normalizeFromLength(n);const r=n*e,a=i.scaleInPlace(r*.5),o=this.center.subtractToRef(a,t[1]),l=this.center.addToRef(a,t[2]);return this.reConstruct(o,l,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){const t=this.minimumWorld,i=this.maximumWorld,n=this.directions,r=this.vectorsWorld,a=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let o=0;o<8;++o)r[o].copyFrom(a[o]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let o=0;o<8;++o){const l=r[o];g.TransformCoordinatesToRef(a[o],e,l),t.minimizeInPlace(l),i.maximizeInPlace(l)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}g.FromArrayToRef(e.m,0,n[0]),g.FromArrayToRef(e.m,4,n[1]),g.FromArrayToRef(e.m,8,n[2]),this._worldMatrix=e}isInFrustum(e){return Xs.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return Xs.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){const t=this.minimumWorld,i=this.maximumWorld,n=t.x,r=t.y,a=t.z,o=i.x,l=i.y,c=i.z,u=e.x,h=e.y,d=e.z,f=-lt;return!(o-u<f||f>u-n||l-h<f||f>h-r||c-d<f||f>d-a)}intersectsSphere(e){return Xs.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){const i=this.minimumWorld,n=this.maximumWorld,r=i.x,a=i.y,o=i.z,l=n.x,c=n.y,u=n.z,h=e.x,d=e.y,f=e.z,p=t.x,m=t.y,_=t.z;return!(l<h||r>p||c<d||a>m||u<f||o>_)}dispose(){var e,t;(e=this._drawWrapperFront)===null||e===void 0||e.dispose(),(t=this._drawWrapperBack)===null||t===void 0||t.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,n){const r=Xs._TmpVector3[0];return g.ClampToRef(i,e,t,r),g.DistanceSquared(i,r)<=n*n}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){const n=t[i];for(let r=0;r<8;++r)if(n.dotCoordinate(e[r])<0)return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let n=!0;const r=t[i];for(let a=0;a<8;++a)if(r.dotCoordinate(e[a])>=0){n=!1;break}if(n)return!1}return!0}}Xs._TmpVector3=mi.BuildArray(3,g.Zero);class ca{constructor(e,t,i){this.center=g.Zero(),this.centerWorld=g.Zero(),this.minimum=g.Zero(),this.maximum=g.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);const n=g.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=n*.5,this._update(i||D.IdentityReadOnly)}scale(e){const t=this.radius*e,i=ca._TmpVector3,n=i[0].setAll(t),r=this.center.subtractToRef(n,i[1]),a=this.center.addToRef(n,i[2]);return this.reConstruct(r,a,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{g.TransformCoordinatesToRef(this.center,e,this.centerWorld);const t=ca._TmpVector3[0];g.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){const t=this.centerWorld,i=this.radiusWorld;for(let n=0;n<6;n++)if(e[n].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){const t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){const t=g.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){const i=g.DistanceSquared(e.centerWorld,t.centerWorld),n=e.radiusWorld+t.radiusWorld;return!(n*n<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);const n=new ca(this._TmpVector3[0],this._TmpVector3[2]);return i?n._worldMatrix=i:n._worldMatrix=D.Identity(),n}}ca._TmpVector3=mi.BuildArray(3,g.Zero);const Wh={min:0,max:0},Xh={min:0,max:0},F_=(s,e,t)=>{const i=g.Dot(e.centerWorld,s),n=Math.abs(g.Dot(e.directions[0],s))*e.extendSize.x,r=Math.abs(g.Dot(e.directions[1],s))*e.extendSize.y,a=Math.abs(g.Dot(e.directions[2],s))*e.extendSize.z,o=n+r+a;t.min=i-o,t.max=i+o},tn=(s,e,t)=>(F_(s,e,Wh),F_(s,t,Xh),!(Wh.min>Xh.max||Xh.min>Wh.max));class Pn{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new Xs(e,t,i),this.boundingSphere=new ca(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){const i=Pn._TmpVector3[0].copyFrom(e).subtractInPlace(t),n=Pn._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,n,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,n,this.boundingBox.getWorldMatrix()),this}encapsulate(e){const t=g.Minimize(this.minimum,e),i=g.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){const t=w.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(t);const i=w.Vector3[0];return g.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,i),this.encapsulate(i),g.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,i),this.encapsulate(i),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return(t===2||t===3)&&this.boundingSphere.isCenterInFrustum(e)?!0:this.boundingSphere.isInFrustum(e)?t===1||t===3?!0:this.boundingBox.isInFrustum(e):!1}get diagonalLength(){const e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,Pn._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))}intersects(e,t){if(!ca.Intersects(this.boundingSphere,e.boundingSphere)||!Xs.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;const i=this.boundingBox,n=e.boundingBox;return!(!tn(i.directions[0],i,n)||!tn(i.directions[1],i,n)||!tn(i.directions[2],i,n)||!tn(n.directions[0],i,n)||!tn(n.directions[1],i,n)||!tn(n.directions[2],i,n)||!tn(g.Cross(i.directions[0],n.directions[0]),i,n)||!tn(g.Cross(i.directions[0],n.directions[1]),i,n)||!tn(g.Cross(i.directions[0],n.directions[2]),i,n)||!tn(g.Cross(i.directions[1],n.directions[0]),i,n)||!tn(g.Cross(i.directions[1],n.directions[1]),i,n)||!tn(g.Cross(i.directions[1],n.directions[2]),i,n)||!tn(g.Cross(i.directions[2],n.directions[0]),i,n)||!tn(g.Cross(i.directions[2],n.directions[1]),i,n)||!tn(g.Cross(i.directions[2],n.directions[2]),i,n))}}Pn._TmpVector3=mi.BuildArray(2,g.Zero);class th{static extractMinAndMaxIndexed(e,t,i,n,r,a){for(let o=i;o<i+n;o++){const l=t[o]*3,c=e[l],u=e[l+1],h=e[l+2];r.minimizeInPlaceFromFloats(c,u,h),a.maximizeInPlaceFromFloats(c,u,h)}}static extractMinAndMax(e,t,i,n,r,a){for(let o=t,l=t*n;o<t+i;o++,l+=n){const c=e[l],u=e[l+1],h=e[l+2];r.minimizeInPlaceFromFloats(c,u,h),a.maximizeInPlaceFromFloats(c,u,h)}}}S([Gr.filter((...[s,e])=>!Array.isArray(s)&&!Array.isArray(e))],th,"extractMinAndMaxIndexed",null);S([Gr.filter((...[s])=>!Array.isArray(s))],th,"extractMinAndMax",null);function jT(s,e,t,i,n=null){const r=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new g(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return th.extractMinAndMaxIndexed(s,e,t,i,r,a),n&&(r.x-=r.x*n.x+n.y,r.y-=r.y*n.x+n.y,r.z-=r.z*n.x+n.y,a.x+=a.x*n.x+n.y,a.y+=a.y*n.x+n.y,a.z+=a.z*n.x+n.y),{minimum:r,maximum:a}}function RE(s,e,t,i=null,n){const r=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new g(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return n||(n=3),th.extractMinAndMax(s,e,t,n,r,a),i&&(r.x-=r.x*i.x+i.y,r.y-=r.y*i.x+i.y,r.z-=r.z*i.x+i.y,a.x+=a.x*i.x+i.y,a.y+=a.y*i.x+i.y,a.z+=a.z*i.x+i.y),{minimum:r,maximum:a}}class Jn{get materialDefines(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:(e=this._getDrawWrapper())===null||e===void 0?void 0:e.defines}set materialDefines(e){var t;const i=(t=this._mainDrawWrapperOverride)!==null&&t!==void 0?t:this._getDrawWrapper(void 0,!0);i.defines=e}_getDrawWrapper(e,t=!1){e=e!=null?e:this._engine.currentRenderPassId;let i=this._drawWrappers[e];return!i&&t&&(this._drawWrappers[e]=i=new Lr(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0){var i;t&&((i=this._drawWrappers[e])===null||i===void 0||i.dispose()),this._drawWrappers[e]=void 0}get effect(){var e,t;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:(t=(e=this._getDrawWrapper())===null||e===void 0?void 0:e.effect)!==null&&t!==void 0?t:null}get _drawWrapper(){var e;return(e=this._mainDrawWrapperOverride)!==null&&e!==void 0?e:this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,i,n=!0){const r=this._drawWrapper;r.setEffect(e,t,n),i!==void 0&&(r.materialContext=i),e||(r.defines=null,r.materialContext=void 0)}resetDrawCache(e){if(this._drawWrappers)if(e!==void 0){this._removeDrawWrapper(e);return}else for(const t of this._drawWrappers)t==null||t.dispose();this._drawWrappers=[]}static AddToMesh(e,t,i,n,r,a,o,l=!0){return new Jn(e,t,i,n,r,a,o,l)}constructor(e,t,i,n,r,a,o,l=!0,c=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=n,this.indexCount=r,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=a,this._renderingMesh=o||a,c&&a.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=a.subMeshes.length-1,l&&(this.refreshBoundingInfo(),a.computeWorldMatrix(!0))}get IsGlobal(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){const e=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return e||this._renderingMesh}getMaterial(e=!0){var t;const i=(t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))!==null&&t!==void 0?t:this._renderingMesh.material;if(i){if(this._isMultiMaterial(i)){const n=i.getSubMaterial(this.materialIndex);return this._currentMaterial!==n&&(this._currentMaterial=n,this.resetDrawCache()),n}}else return e?this._mesh.getScene().defaultMaterial:null;return i}_isMultiMaterial(e){return e.getSubMaterial!==void 0}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(C.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;const t=this._renderingMesh.getIndices();let i;if(this.indexStart===0&&this.indexCount===t.length){const n=this._renderingMesh.getBoundingInfo();i={minimum:n.minimum.clone(),maximum:n.maximum.clone()}}else i=jT(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Pn(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){const t=this.getBoundingInfo();return t?t.isInFrustum(e,this._mesh.cullingStrategy):!1}isCompletelyInFrustum(e){const t=this.getBoundingInfo();return t?t.isCompletelyInFrustum(e):!1}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){const i=[];for(let n=this.indexStart;n<this.indexStart+this.indexCount;n+=3)i.push(e[n],e[n+1],e[n+1],e[n+2],e[n+2],e[n]);this._linesIndexBuffer=t.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer}canIntersects(e){const t=this.getBoundingInfo();return t?e.intersectsBox(t.boundingBox):!1}intersects(e,t,i,n,r){const a=this.getMaterial();if(!a)return null;let o=3,l=!1;switch(a.fillMode){case 3:case 5:case 6:case 8:return null;case 7:o=1,l=!0;break}return a.fillMode===4?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,n):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,n):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,n,r):this._intersectTriangles(e,t,i,o,l,n,r)}_intersectLines(e,t,i,n,r){let a=null;for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=2){const l=t[i[o]],c=t[i[o+1]],u=e.intersectionSegment(l,c,n);if(!(u<0)&&(r||!a||u<a.distance)&&(a=new nf(null,null,u),a.faceId=o/2,r))break}return a}_intersectUnIndexedLines(e,t,i,n,r){let a=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=2){const l=t[o],c=t[o+1],u=e.intersectionSegment(l,c,n);if(!(u<0)&&(r||!a||u<a.distance)&&(a=new nf(null,null,u),a.faceId=o/2,r))break}return a}_intersectTriangles(e,t,i,n,r,a,o){let l=null,c=-1;for(let u=this.indexStart;u<this.indexStart+this.indexCount-(3-n);u+=n){c++;const h=i[u],d=i[u+1],f=i[u+2];if(r&&f===4294967295){u+=2;continue}const p=t[h],m=t[d],_=t[f];if(!p||!m||!_||o&&!o(p,m,_,e,h,d,f))continue;const E=e.intersectsTriangle(p,m,_);if(E){if(E.distance<0)continue;if((a||!l||E.distance<l.distance)&&(l=E,l.faceId=c,a))break}}return l}_intersectUnIndexedTriangles(e,t,i,n,r){let a=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=3){const l=t[o],c=t[o+1],u=t[o+2];if(r&&!r(l,c,u,e,-1,-1,-1))continue;const h=e.intersectsTriangle(l,c,u);if(h){if(h.distance<0)continue;if((n||!a||h.distance<a.distance)&&(a=h,a.faceId=o/3,n))break}}return a}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){const i=new Jn(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){const n=this.getBoundingInfo();if(!n)return i;i._boundingInfo=new Pn(n.minimum,n.maximum)}return i}dispose(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);const e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,i,n,r,a=!0){let o=Number.MAX_VALUE,l=-Number.MAX_VALUE;const u=(r||n).getIndices();for(let h=t;h<t+i;h++){const d=u[h];d<o&&(o=d),d>l&&(l=d)}return new Jn(e,o,l-o+1,t,i,n,r,a)}}_e.prototype.createUniformBuffer=function(s){const e=this._gl.createBuffer();if(!e)throw new Error("Unable to create uniform buffer");const t=new Ol(e);return this.bindUniformBuffer(t),s instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,s,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(s),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};_e.prototype.createDynamicUniformBuffer=function(s){const e=this._gl.createBuffer();if(!e)throw new Error("Unable to create dynamic uniform buffer");const t=new Ol(e);return this.bindUniformBuffer(t),s instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,s,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(s),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};_e.prototype.updateUniformBuffer=function(s,e,t,i){this.bindUniformBuffer(s),t===void 0&&(t=0),i===void 0?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+i)),this.bindUniformBuffer(null)};_e.prototype.bindUniformBuffer=function(s){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,s?s.underlyingResource:null)};_e.prototype.bindUniformBufferBase=function(s,e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,s?s.underlyingResource:null)};_e.prototype.bindUniformBlock=function(s,e,t){const i=s.program,n=this._gl.getUniformBlockIndex(i,e);n!==4294967295&&this._gl.uniformBlockBinding(i,n,t)};class le{constructor(e,t,i,n,r=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||r,this._dynamic=i,this._name=n!=null?n:"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic!==void 0}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(e<=2?t=e:t=4,this._uniformLocationPointer%t!==0){const i=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const n=this._uniformLocationPointer-i;for(let r=0;r<n;r++)this._data.push(0)}}addUniform(e,t,i=0){if(this._noUBO||this._uniformLocations[e]!==void 0)return;let n;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},t==16)t=t*i;else{const a=(4-t)*i;t=t*i+a}n=[];for(let r=0;r<t;r++)n.push(0)}else{if(t instanceof Array)n=t,t=n.length;else{t=t,n=[];for(let r=0;r<t;r++)n.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let r=0;r<t;r++)this._data.push(n[r]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))}addFloat2(e,t,i){const n=[t,i];this.addUniform(e,n)}addFloat3(e,t,i,n){const r=[t,i,n];this.addUniform(e,r)}addColor3(e,t){const i=[t.r,t.g,t.b];this.addUniform(e,i)}addColor4(e,t,i){const n=[t.r,t.g,t.b,i];this.addUniform(e,n)}addVector3(e,t){const i=[t.x,t.y,t.z];this.addUniform(e,i)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_rebuild(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData):this._buffer=this._engine.createUniformBuffer(this._bufferData),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(le._UpdatedUbosInFrame[this._name]||(le._UpdatedUbosInFrame[this._name]=0),le._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let n=this._uniformLocations[e];if(n===void 0){if(this._buffer){U.Error("Cannot add an uniform after UBO has been created.");return}this.addUniform(e,i),n=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let r=0;r<i;r++)this._bufferData[n+r]=t[r];else{let r=!1;for(let a=0;a<i;a++)(i===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[n+a]!==q.FloatRound(t[a]))&&(r=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[n+a]=t[a]);this._needSync=this._needSync||r}}updateUniformArray(e,t,i){this._checkNewFrame();const n=this._uniformLocations[e];if(n===void 0){U.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");return}this._buffer||this.create();const r=this._uniformArraySizes[e];if(this._dynamic)for(let a=0;a<i;a++)this._bufferData[n+a]=t[a];else{let a=!1,o=0,l=0;for(let c=0;c<i;c++)if(this._bufferData[n+l*4+o]!==q.FloatRound(t[c])&&(a=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[n+l*4+o]=t[c]),o++,o===r.strideSize){for(;o<4;o++)this._bufferData[n+l*4+o]=0;o=0,l++}this._needSync=this._needSync||a}}_cacheMatrix(e,t){this._checkNewFrame();const i=this._valueCache[e],n=t.updateFlag;return i!==void 0&&i===n?!1:(this._valueCache[e]=n,!0)}_updateMatrix3x3ForUniform(e,t){for(let i=0;i<3;i++)le._TempBuffer[i*4]=t[i*3],le._TempBuffer[i*4+1]=t[i*3+1],le._TempBuffer[i*4+2]=t[i*3+2],le._TempBuffer[i*4+3]=0;this.updateUniform(e,le._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let i=0;i<2;i++)le._TempBuffer[i*4]=t[i*2],le._TempBuffer[i*4+1]=t[i*2+1],le._TempBuffer[i*4+2]=0,le._TempBuffer[i*4+3]=0;this.updateUniform(e,le._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){le._TempBuffer[0]=t,this.updateUniform(e,le._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,n=""){this._currentEffect.setFloat2(e+n,t,i)}_updateFloat2ForUniform(e,t,i){le._TempBuffer[0]=t,le._TempBuffer[1]=i,this.updateUniform(e,le._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,n,r=""){this._currentEffect.setFloat3(e+r,t,i,n)}_updateFloat3ForUniform(e,t,i,n){le._TempBuffer[0]=t,le._TempBuffer[1]=i,le._TempBuffer[2]=n,this.updateUniform(e,le._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,n,r,a=""){this._currentEffect.setFloat4(e+a,t,i,n,r)}_updateFloat4ForUniform(e,t,i,n,r){le._TempBuffer[0]=t,le._TempBuffer[1]=i,le._TempBuffer[2]=n,le._TempBuffer[3]=r,this.updateUniform(e,le._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){le._TempBufferInt32View.set(t),this.updateUniformArray(e,le._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){le._TempBufferUInt32View.set(t),this.updateUniformArray(e,le._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.toArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){le._TempBuffer[0]=t.x,le._TempBuffer[1]=t.y,le._TempBuffer[2]=t.z,this.updateUniform(e,le._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){le._TempBuffer[0]=t.x,le._TempBuffer[1]=t.y,le._TempBuffer[2]=t.z,le._TempBuffer[3]=t.w,this.updateUniform(e,le._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){le._TempBuffer[0]=t.r,le._TempBuffer[1]=t.g,le._TempBuffer[2]=t.b,this.updateUniform(e,le._TempBuffer,3)}_updateColor4ForEffect(e,t,i,n=""){this._currentEffect.setColor4(e+n,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){le._TempBuffer[0]=t.r,le._TempBuffer[1]=t.g,le._TempBuffer[2]=t.b,le._TempBuffer[3]=i,this.updateUniform(e,le._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){le._TempBuffer[0]=t.r,le._TempBuffer[1]=t.g,le._TempBuffer[2]=t.b,le._TempBuffer[3]=t.a,this.updateUniform(e,le._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){le._TempBufferInt32View[0]=t,this.updateUniform(e,le._TempBuffer,1)}_updateInt2ForEffect(e,t,i,n=""){this._currentEffect.setInt2(e+n,t,i)}_updateInt2ForUniform(e,t,i){le._TempBufferInt32View[0]=t,le._TempBufferInt32View[1]=i,this.updateUniform(e,le._TempBuffer,2)}_updateInt3ForEffect(e,t,i,n,r=""){this._currentEffect.setInt3(e+r,t,i,n)}_updateInt3ForUniform(e,t,i,n){le._TempBufferInt32View[0]=t,le._TempBufferInt32View[1]=i,le._TempBufferInt32View[2]=n,this.updateUniform(e,le._TempBuffer,3)}_updateInt4ForEffect(e,t,i,n,r,a=""){this._currentEffect.setInt4(e+a,t,i,n,r)}_updateInt4ForUniform(e,t,i,n,r){le._TempBufferInt32View[0]=t,le._TempBufferInt32View[1]=i,le._TempBufferInt32View[2]=n,le._TempBufferInt32View[3]=r,this.updateUniform(e,le._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){le._TempBufferUInt32View[0]=t,this.updateUniform(e,le._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,n=""){this._currentEffect.setUInt2(e+n,t,i)}_updateUInt2ForUniform(e,t,i){le._TempBufferUInt32View[0]=t,le._TempBufferUInt32View[1]=i,this.updateUniform(e,le._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,n,r=""){this._currentEffect.setUInt3(e+r,t,i,n)}_updateUInt3ForUniform(e,t,i,n){le._TempBufferUInt32View[0]=t,le._TempBufferUInt32View[1]=i,le._TempBufferUInt32View[2]=n,this.updateUniform(e,le._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,n,r,a=""){this._currentEffect.setUInt4(e+a,t,i,n,r)}_updateUInt4ForUniform(e,t,i,n,r){le._TempBufferUInt32View[0]=t,le._TempBufferUInt32View[1]=i,le._TempBufferUInt32View[2]=n,le._TempBufferUInt32View[3]=r,this.updateUniform(e,le._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let i=0;i<this._buffers.length;++i){const n=this._buffers[i][0];this._engine._releaseBuffer(n)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}le._UpdatedUbosInFrame={};le._MAX_UNIFORM_SIZE=256;le._TempBuffer=new Float32Array(le._MAX_UNIFORM_SIZE);le._TempBufferInt32View=new Int32Array(le._TempBuffer.buffer);le._TempBufferUInt32View=new Uint32Array(le._TempBuffer.buffer);class L_{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach((t,i)=>this.add(t,i))}get(e){const t=this._data[e];if(t!==void 0)return t}getOrAddWithFactory(e,t){let i=this.get(e);return i!==void 0||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){const i=this.get(e);return i!==void 0?i:(this.add(e,t),t)}contains(e){return this._data[e]!==void 0}add(e,t){return this._data[e]!==void 0?!1:(this._data[e]=t,++this._count,!0)}set(e,t){return this._data[e]===void 0?!1:(this._data[e]=t,!0)}getAndRemove(e){const t=this.get(e);return t!==void 0?(delete this._data[e],--this._count,t):null}remove(e){return this.contains(e)?(delete this._data[e],--this._count,!0):!1}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(const t in this._data){const i=this._data[t];e(t,i)}}first(e){for(const t in this._data){const i=this._data[t],n=e(t,i);if(n)return n}return null}}class Oo{constructor(){this.rootNodes=new Array,this.cameras=new Array,this.lights=new Array,this.meshes=new Array,this.skeletons=new Array,this.particleSystems=new Array,this.animations=[],this.animationGroups=new Array,this.multiMaterials=new Array,this.materials=new Array,this.morphTargetManagers=new Array,this.geometries=new Array,this.transformNodes=new Array,this.actionManagers=new Array,this.textures=new Array,this._environmentTexture=null,this.postProcesses=new Array}static AddParser(e,t){this._BabylonFileParsers[e]=t}static GetParser(e){return this._BabylonFileParsers[e]?this._BabylonFileParsers[e]:null}static AddIndividualParser(e,t){this._IndividualBabylonFileParsers[e]=t}static GetIndividualParser(e){return this._IndividualBabylonFileParsers[e]?this._IndividualBabylonFileParsers[e]:null}static Parse(e,t,i,n){for(const r in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,r)&&this._BabylonFileParsers[r](e,t,i,n)}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=new Array;return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(t=>e=e.concat(t.bones)),e}}Oo._BabylonFileParsers={};Oo._IndividualBabylonFileParsers={};class Fs{constructor(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!1,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(const e of Object.keys(this))e[0]!=="_"&&this._keys.push(e);if(this._externalProperties)for(const e in this._externalProperties)this._keys.indexOf(e)===-1&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];if(this[i]!==e[i])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){const i=this._keys[t];e[i]=this[i]}}reset(){this._keys.forEach(e=>this._setDefaultValue(e))}_setDefaultValue(e){var t,i,n,r,a;const o=(n=(i=(t=this._externalProperties)===null||t===void 0?void 0:t[e])===null||i===void 0?void 0:i.type)!==null&&n!==void 0?n:typeof this[e],l=(a=(r=this._externalProperties)===null||r===void 0?void 0:r[e])===null||a===void 0?void 0:a.default;switch(o){case"number":this[e]=l!=null?l:0;break;case"string":this[e]=l!=null?l:"";break;default:this[e]=l!=null?l:!1;break}}toString(){let e="";for(let t=0;t<this._keys.length;t++){const i=this._keys[t],n=this[i];switch(typeof n){case"number":case"string":e+="#define "+i+" "+n+`
`;break;default:n&&(e+="#define "+i+`
`);break}}return e}}class Nt{constructor(){this._dirty=!0,this._tempColor=new pe(0,0,0,0),this._globalCurve=new pe(0,0,0,0),this._highlightsCurve=new pe(0,0,0,0),this._midtonesCurve=new pe(0,0,0,0),this._shadowsCurve=new pe(0,0,0,0),this._positiveCurve=new pe(0,0,0,0),this._negativeCurve=new pe(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",n="vCameraColorCurveNeutral",r="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(n,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(r,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}static PrepareUniforms(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}_getColorGradingDataToRef(e,t,i,n,r){e!=null&&(e=Nt._Clamp(e,0,360),t=Nt._Clamp(t,-100,100),i=Nt._Clamp(i,-100,100),n=Nt._Clamp(n,-100,100),t=Nt._ApplyColorGradingSliderNonlinear(t),t*=.5,n=Nt._ApplyColorGradingSliderNonlinear(n),t<0&&(t*=-1,e=(e+180)%360),Nt._FromHSBToRef(e,t,50+.25*n,r),r.scaleToRef(2,r),r.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,n){let r=Nt._Clamp(e,0,360);const a=Nt._Clamp(t/100,0,1),o=Nt._Clamp(i/100,0,1);if(a===0)n.r=o,n.g=o,n.b=o;else{r/=60;const l=Math.floor(r),c=r-l,u=o*(1-a),h=o*(1-a*c),d=o*(1-a*(1-c));switch(l){case 0:n.r=o,n.g=d,n.b=u;break;case 1:n.r=h,n.g=o,n.b=u;break;case 2:n.r=u,n.g=o,n.b=d;break;case 3:n.r=u,n.g=h,n.b=o;break;case 4:n.r=d,n.g=u,n.b=o;break;default:n.r=o,n.g=u,n.b=h;break}}n.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return Pe.Clone(()=>new Nt,this)}serialize(){return Pe.Serialize(this)}static Parse(e){return Pe.Parse(()=>new Nt,e,null,null)}}S([b()],Nt.prototype,"_globalHue",void 0);S([b()],Nt.prototype,"_globalDensity",void 0);S([b()],Nt.prototype,"_globalSaturation",void 0);S([b()],Nt.prototype,"_globalExposure",void 0);S([b()],Nt.prototype,"_highlightsHue",void 0);S([b()],Nt.prototype,"_highlightsDensity",void 0);S([b()],Nt.prototype,"_highlightsSaturation",void 0);S([b()],Nt.prototype,"_highlightsExposure",void 0);S([b()],Nt.prototype,"_midtonesHue",void 0);S([b()],Nt.prototype,"_midtonesDensity",void 0);S([b()],Nt.prototype,"_midtonesSaturation",void 0);S([b()],Nt.prototype,"_midtonesExposure",void 0);Pe._ColorCurvesParser=Nt.Parse;class $T extends Fs{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class je{constructor(){this.colorCurves=new Nt,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=je.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new pe(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=je.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new O}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}static PrepareUniforms(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),(t.VIGNETTE||t.DITHER)&&e.push("vInverseScreenSize"),t.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&Nt.PrepareUniforms(e),t.DITHER&&e.push("ditherIntensity")}static PrepareSamplers(e,t){t.COLORGRADING&&e.push("txColorTransform")}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}switch(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===je._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,e.TONEMAPPING=this.toneMappingEnabled,this._toneMappingType){case je.TONEMAPPING_ACES:e.TONEMAPPING_ACES=!0;break;default:e.TONEMAPPING_ACES=!1;break}e.CONTRAST=this.contrast!==1,e.EXPOSURE=this.exposure!==1,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&Nt.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const i=1/e.getEngine().getRenderWidth(),n=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",i,n),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const r=t!=null?t:n/i;let a=Math.tan(this.vignetteCameraFov*.5),o=a*r;const l=Math.sqrt(o*a);o=q.Mix(o,l,this.vignetteStretch),a=q.Mix(a,l,this.vignetteStretch),e.setFloat4("vignetteSettings1",o,a,-o*this.vignetteCenterX,-a*this.vignetteCenterY);const c=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,c)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const i=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(i-1)/i,.5/i,i,this.colorGradingTexture.level)}}clone(){return Pe.Clone(()=>new je,this)}serialize(){return Pe.Serialize(this)}static Parse(e){const t=Pe.Parse(()=>new je,e,null,null);return e.vignetteCentreX!==void 0&&(t.vignetteCenterX=e.vignetteCentreX),e.vignetteCentreY!==void 0&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}je.TONEMAPPING_STANDARD=0;je.TONEMAPPING_ACES=1;je._VIGNETTEMODE_MULTIPLY=0;je._VIGNETTEMODE_OPAQUE=1;S([UT()],je.prototype,"colorCurves",void 0);S([b()],je.prototype,"_colorCurvesEnabled",void 0);S([ht("colorGradingTexture")],je.prototype,"_colorGradingTexture",void 0);S([b()],je.prototype,"_colorGradingEnabled",void 0);S([b()],je.prototype,"_colorGradingWithGreenDepth",void 0);S([b()],je.prototype,"_colorGradingBGR",void 0);S([b()],je.prototype,"_exposure",void 0);S([b()],je.prototype,"_toneMappingEnabled",void 0);S([b()],je.prototype,"_toneMappingType",void 0);S([b()],je.prototype,"_contrast",void 0);S([b()],je.prototype,"vignetteStretch",void 0);S([b()],je.prototype,"vignetteCenterX",void 0);S([b()],je.prototype,"vignetteCenterY",void 0);S([b()],je.prototype,"vignetteWeight",void 0);S([EE()],je.prototype,"vignetteColor",void 0);S([b()],je.prototype,"vignetteCameraFov",void 0);S([b()],je.prototype,"_vignetteBlendMode",void 0);S([b()],je.prototype,"_vignetteEnabled",void 0);S([b()],je.prototype,"_ditheringEnabled",void 0);S([b()],je.prototype,"_ditheringIntensity",void 0);S([b()],je.prototype,"_skipFinalColorClamp",void 0);S([b()],je.prototype,"_applyByPostProcess",void 0);S([b()],je.prototype,"_isEnabled",void 0);Pe._ImageProcessingConfigurationParser=je.Parse;class ar{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(C.NormalKind))return null;let i=this.pickedMesh.getIndices();(i==null?void 0:i.length)===0&&(i=null);let n;const r=w.Vector3[0],a=w.Vector3[1],o=w.Vector3[2];if(t){const c=this.pickedMesh.getVerticesData(C.NormalKind);let u=i?g.FromArrayToRef(c,i[this.faceId*3]*3,r):r.copyFromFloats(c[this.faceId*3*3],c[this.faceId*3*3+1],c[this.faceId*3*3+2]),h=i?g.FromArrayToRef(c,i[this.faceId*3+1]*3,a):a.copyFromFloats(c[(this.faceId*3+1)*3],c[(this.faceId*3+1)*3+1],c[(this.faceId*3+1)*3+2]),d=i?g.FromArrayToRef(c,i[this.faceId*3+2]*3,o):o.copyFromFloats(c[(this.faceId*3+2)*3],c[(this.faceId*3+2)*3+1],c[(this.faceId*3+2)*3+2]);u=u.scale(this.bu),h=h.scale(this.bv),d=d.scale(1-this.bu-this.bv),n=new g(u.x+h.x+d.x,u.y+h.y+d.y,u.z+h.z+d.z)}else{const c=this.pickedMesh.getVerticesData(C.PositionKind),u=i?g.FromArrayToRef(c,i[this.faceId*3]*3,r):r.copyFromFloats(c[this.faceId*3*3],c[this.faceId*3*3+1],c[this.faceId*3*3+2]),h=i?g.FromArrayToRef(c,i[this.faceId*3+1]*3,a):a.copyFromFloats(c[(this.faceId*3+1)*3],c[(this.faceId*3+1)*3+1],c[(this.faceId*3+1)*3+2]),d=i?g.FromArrayToRef(c,i[this.faceId*3+2]*3,o):o.copyFromFloats(c[(this.faceId*3+2)*3],c[(this.faceId*3+2)*3+1],c[(this.faceId*3+2)*3+2]),f=u.subtract(h),p=d.subtract(h);n=g.Cross(f,p)}const l=(c,u)=>{let h=c.getWorldMatrix();c.nonUniformScaling&&(w.Matrix[0].copyFrom(h),h=w.Matrix[0],h.setTranslationFromFloats(0,0,0),h.invert(),h.transposeToRef(w.Matrix[1]),h=w.Matrix[1]),g.TransformNormalToRef(u,h,u)};if(e&&l(this.pickedMesh,n),this.ray){const c=w.Vector3[0].copyFrom(n);e||l(this.pickedMesh,c),g.Dot(c,this.ray.direction)>0&&n.negateInPlace()}return n.normalize(),n}getTextureCoordinates(e=C.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;const t=this.pickedMesh.getIndices();if(!t)return null;const i=this.pickedMesh.getVerticesData(e);if(!i)return null;let n=j.FromArray(i,t[this.faceId*3]*2),r=j.FromArray(i,t[this.faceId*3+1]*2),a=j.FromArray(i,t[this.faceId*3+2]*2);return n=n.scale(this.bu),r=r.scale(this.bv),a=a.scale(1-this.bu-this.bv),new j(n.x+r.x+a.x,n.y+r.y+a.y)}}class gi{constructor(e,t,i,n,r,a){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=n,this.sourceEvent=r,this.additionalData=a}static CreateNew(e,t,i){const n=e.getScene();return new gi(e,n.pointerX,n.pointerY,n.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,n){return new gi(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,n)}static CreateNewFromScene(e,t){return new gi(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,n){return new gi(e,t.x,t.y,null,i,n)}}class sf{constructor(e){this._vertexBuffers={},this._scene=e}_prepareBuffers(){if(this._vertexBuffers[C.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[C.PositionKind]=new C(this._scene.getEngine(),e,C.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[C.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const i=this._scene.activeCamera;return!i||(t=t||i._postProcesses.filter(n=>n!=null),!t||t.length===0||!this._scene.postProcessesEnabled)?!1:(t[0].activate(i,e,t!=null),!0)}directRender(e,t=null,i=!1,n=0,r=0,a=!1){var o;const l=this._scene.getEngine();for(let c=0;c<e.length;c++){c<e.length-1?e[c+1].activate(this._scene.activeCamera,t==null?void 0:t.texture):(t?l.bindFramebuffer(t,n,void 0,void 0,i,r):a||l.restoreDefaultFramebuffer(),(o=l._debugInsertMarker)===null||o===void 0||o.call(l,`post process ${e[c].name} output`));const u=e[c],h=u.apply();h&&(u.onBeforeRenderObservable.notifyObservers(h),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,h),l.drawElementsType(0,0,6),u.onAfterRenderObservable.notifyObservers(h))}l.setDepthBuffer(!0),l.setDepthWrite(!0)}_finalizeFrame(e,t,i,n,r=!1){var a;const o=this._scene.activeCamera;if(!o||(n=n||o._postProcesses.filter(c=>c!=null),n.length===0||!this._scene.postProcessesEnabled))return;const l=this._scene.getEngine();for(let c=0,u=n.length;c<u;c++){const h=n[c];if(c<u-1?h._outputTexture=n[c+1].activate(o,t==null?void 0:t.texture):(t?(l.bindFramebuffer(t,i,void 0,void 0,r),h._outputTexture=t):(l.restoreDefaultFramebuffer(),h._outputTexture=null),(a=l._debugInsertMarker)===null||a===void 0||a.call(l,`post process ${n[c].name} output`)),e)break;const d=h.apply();d&&(h.onBeforeRenderObservable.notifyObservers(d),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,d),l.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(d))}l.setDepthBuffer(!0),l.setDepthWrite(!0),l.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[C.PositionKind];e&&(e.dispose(),this._vertexBuffers[C.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}class ls{set opaqueSortCompareFn(e){e?this._opaqueSortCompareFn=e:this._opaqueSortCompareFn=ls.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){e?this._alphaTestSortCompareFn=e:this._alphaTestSortCompareFn=ls.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){e?this._transparentSortCompareFn=e:this._transparentSortCompareFn=ls.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,i=null,n=null,r=null){this.index=e,this._opaqueSubMeshes=new Mi(256),this._transparentSubMeshes=new Mi(256),this._alphaTestSubMeshes=new Mi(256),this._depthOnlySubMeshes=new Mi(256),this._particleSystems=new Mi(256),this._spriteManagers=new Mi(256),this._empty=!0,this._edgesRenderers=new Jr(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=n,this.transparentSortCompareFn=r}render(e,t,i,n){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}const r=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(r.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),r.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);const a=r.getStencilBuffer();if(r.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(n),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(r.setStencilBuffer(a),this._scene.useOrderIndependentTransparency){const o=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);o.length&&this._renderTransparent(o)}else this._renderTransparent(this._transparentSubMeshes);r.setAlphaMode(0)}if(r.setStencilBuffer(!1),this._edgesRenderers.length){for(let o=0;o<this._edgesRenderers.length;o++)this._edgesRenderers.data[o].render();r.setAlphaMode(0)}r.setStencilBuffer(a)}_renderOpaqueSorted(e){return ls._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){return ls._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){return ls._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,i,n){let r=0,a;const o=i?i.globalPosition:ls._ZeroVector;if(n)for(;r<e.length;r++)a=e.data[r],a._alphaIndex=a.getMesh().alphaIndex,a._distanceToCamera=g.Distance(a.getBoundingInfo().boundingSphere.centerWorld,o);const l=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&l.sort(t);const c=l[0].getMesh().getScene();for(r=0;r<l.length;r++)if(a=l[r],!(c._activeMeshesFrozenButKeepClipping&&!a.isInFrustum(c._frustumPlanes))){if(n){const u=a.getMaterial();if(u&&u.needDepthPrePass){const h=u.getScene().getEngine();h.setColorWrite(!1),h.setAlphaMode(0),a.render(!1),h.setColorWrite(!0)}}a.render(n)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:ls.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const i=e.getMesh(),n=t.getMesh();return i.material&&n.material?i.material.uniqueId-n.material.uniqueId:i.uniqueId-n.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),i===void 0&&(i=e.getMaterial()),i!=null&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(this._particleSystems.length===0)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){const n=this._particleSystems.data[i];if((t&&t.layerMask&n.layerMask)===0)continue;const r=n.emitter;(!r.position||!e||e.indexOf(r)!==-1)&&this._scene._activeParticles.addCount(n.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const i=this._spriteManagers.data[t];(e&&e.layerMask&i.layerMask)!==0&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}ls._ZeroVector=g.Zero();class JT{}class Oi{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){if(e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,!this._maintainStateBetweenFrames)){for(const t of this._scene.meshes)if(t.subMeshes)for(const i of t.subMeshes)i._wasDispatched=!1;if(this._scene.spriteManagers)for(const t of this._scene.spriteManagers)t._wasDispatched=!1;for(const t of this._scene.particleSystems)t._wasDispatched=!1}}constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new JT,this._maintainStateBetweenFrames=!1,this._scene=e;for(let t=Oi.MIN_RENDERINGGROUPS;t<Oi.MAX_RENDERINGGROUPS;t++)this._autoClearDepthStencil[t]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){const t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,i,n){const r=this._renderingGroupInfo;if(r.scene=this._scene,r.camera=this._scene.activeCamera,this._scene.spriteManagers&&n)for(let a=0;a<this._scene.spriteManagers.length;a++){const o=this._scene.spriteManagers[a];this.dispatchSprites(o)}for(let a=Oi.MIN_RENDERINGGROUPS;a<Oi.MAX_RENDERINGGROUPS;a++){this._depthStencilBufferAlreadyCleaned=a===Oi.MIN_RENDERINGGROUPS;const o=this._renderingGroups[a];if(!o||o._empty)continue;const l=Math.pow(2,a);if(r.renderingGroupId=a,this._scene.onBeforeRenderingGroupObservable.notifyObservers(r,l),Oi.AUTOCLEAR){const c=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(a):this._autoClearDepthStencil[a];c&&c.autoClear&&this._clearDepthStencilBuffer(c.depth,c.stencil)}for(const c of this._scene._beforeRenderingGroupDrawStage)c.action(a);o.render(e,n,i,t);for(const c of this._scene._afterRenderingGroupDrawStage)c.action(a);this._scene.onAfterRenderingGroupObservable.notifyObservers(r,l)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=Oi.MIN_RENDERINGGROUPS;e<Oi.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=Oi.MIN_RENDERINGGROUPS;e<Oi.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=Oi.MIN_RENDERINGGROUPS;e<Oi.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new ls(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),!(this.maintainStateBetweenFrames&&e._wasDispatched)&&(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,i))}setRenderingOrder(e,t=null,i=null,n=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=n,this._renderingGroups[e]){const r=this._renderingGroups[e];r.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],r.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],r.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,i=!0,n=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:n}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}Oi.MAX_RENDERINGGROUPS=4;Oi.MIN_RENDERINGGROUPS=0;Oi.AUTOCLEAR=!0;class ye{}ye.NAME_EFFECTLAYER="EffectLayer";ye.NAME_LAYER="Layer";ye.NAME_LENSFLARESYSTEM="LensFlareSystem";ye.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer";ye.NAME_PARTICLESYSTEM="ParticleSystem";ye.NAME_GAMEPAD="Gamepad";ye.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue";ye.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer";ye.NAME_PREPASSRENDERER="PrePassRenderer";ye.NAME_DEPTHRENDERER="DepthRenderer";ye.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer";ye.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager";ye.NAME_SPRITE="Sprite";ye.NAME_SUBSURFACE="SubSurface";ye.NAME_OUTLINERENDERER="Outline";ye.NAME_PROCEDURALTEXTURE="ProceduralTexture";ye.NAME_SHADOWGENERATOR="ShadowGenerator";ye.NAME_OCTREE="Octree";ye.NAME_PHYSICSENGINE="PhysicsEngine";ye.NAME_AUDIO="Audio";ye.NAME_FLUIDRENDERER="FluidRenderer";ye.STEP_ISREADYFORMESH_EFFECTLAYER=0;ye.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0;ye.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0;ye.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0;ye.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1;ye.STEP_BEFORECAMERADRAW_PREPASS=0;ye.STEP_BEFORECAMERADRAW_EFFECTLAYER=1;ye.STEP_BEFORECAMERADRAW_LAYER=2;ye.STEP_BEFORERENDERTARGETDRAW_PREPASS=0;ye.STEP_BEFORERENDERTARGETDRAW_LAYER=1;ye.STEP_BEFORERENDERINGMESH_PREPASS=0;ye.STEP_BEFORERENDERINGMESH_OUTLINE=1;ye.STEP_AFTERRENDERINGMESH_PREPASS=0;ye.STEP_AFTERRENDERINGMESH_OUTLINE=1;ye.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0;ye.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1;ye.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0;ye.STEP_BEFORECAMERAUPDATE_GAMEPAD=1;ye.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0;ye.STEP_BEFORECLEAR_PREPASS=1;ye.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0;ye.STEP_AFTERRENDERTARGETDRAW_PREPASS=0;ye.STEP_AFTERRENDERTARGETDRAW_LAYER=1;ye.STEP_AFTERCAMERADRAW_PREPASS=0;ye.STEP_AFTERCAMERADRAW_EFFECTLAYER=1;ye.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2;ye.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3;ye.STEP_AFTERCAMERADRAW_LAYER=4;ye.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5;ye.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0;ye.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0;ye.STEP_AFTERRENDER_AUDIO=0;ye.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0;ye.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1;ye.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2;ye.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3;ye.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0;ye.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1;ye.STEP_POINTERMOVE_SPRITE=0;ye.STEP_POINTERDOWN_SPRITE=0;ye.STEP_POINTERUP_SPRITE=0;class Zt extends Array{constructor(e){super(...e)}static Create(){return Object.create(Zt.prototype)}registerStep(e,t,i){let n=0,r=Number.MAX_VALUE;for(;n<this.length&&(r=this[n].index,!(e<r));n++);this.splice(n,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}class Sn{constructor(){this.hoverCursor="",this.actions=new Array,this.isRecursive=!1}static get HasTriggers(){for(const e in Sn.Triggers)if(Object.prototype.hasOwnProperty.call(Sn.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(const e in Sn.Triggers)if(Object.prototype.hasOwnProperty.call(Sn.Triggers,e)){const t=parseInt(e);if(t>=1&&t<=7)return!0}return!1}static HasSpecificTrigger(e){for(const t in Sn.Triggers)if(Object.prototype.hasOwnProperty.call(Sn.Triggers,t)&&parseInt(t)===e)return!0;return!1}}Sn.Triggers={};var de;(function(s){s[s.Generic=0]="Generic",s[s.Keyboard=1]="Keyboard",s[s.Mouse=2]="Mouse",s[s.Touch=3]="Touch",s[s.DualShock=4]="DualShock",s[s.Xbox=5]="Xbox",s[s.Switch=6]="Switch",s[s.DualSense=7]="DualSense"})(de||(de={}));var Re;(function(s){s[s.Horizontal=0]="Horizontal",s[s.Vertical=1]="Vertical",s[s.LeftClick=2]="LeftClick",s[s.MiddleClick=3]="MiddleClick",s[s.RightClick=4]="RightClick",s[s.BrowserBack=5]="BrowserBack",s[s.BrowserForward=6]="BrowserForward",s[s.MouseWheelX=7]="MouseWheelX",s[s.MouseWheelY=8]="MouseWheelY",s[s.MouseWheelZ=9]="MouseWheelZ",s[s.Move=12]="Move"})(Re||(Re={}));var Iu;(function(s){s[s.Horizontal=0]="Horizontal",s[s.Vertical=1]="Vertical",s[s.LeftClick=2]="LeftClick",s[s.MiddleClick=3]="MiddleClick",s[s.RightClick=4]="RightClick",s[s.BrowserBack=5]="BrowserBack",s[s.BrowserForward=6]="BrowserForward",s[s.MouseWheelX=7]="MouseWheelX",s[s.MouseWheelY=8]="MouseWheelY",s[s.MouseWheelZ=9]="MouseWheelZ",s[s.DeltaHorizontal=10]="DeltaHorizontal",s[s.DeltaVertical=11]="DeltaVertical"})(Iu||(Iu={}));var N_;(function(s){s[s.Cross=0]="Cross",s[s.Circle=1]="Circle",s[s.Square=2]="Square",s[s.Triangle=3]="Triangle",s[s.L1=4]="L1",s[s.R1=5]="R1",s[s.L2=6]="L2",s[s.R2=7]="R2",s[s.Share=8]="Share",s[s.Options=9]="Options",s[s.L3=10]="L3",s[s.R3=11]="R3",s[s.DPadUp=12]="DPadUp",s[s.DPadDown=13]="DPadDown",s[s.DPadLeft=14]="DPadLeft",s[s.DPadRight=15]="DPadRight",s[s.Home=16]="Home",s[s.TouchPad=17]="TouchPad",s[s.LStickXAxis=18]="LStickXAxis",s[s.LStickYAxis=19]="LStickYAxis",s[s.RStickXAxis=20]="RStickXAxis",s[s.RStickYAxis=21]="RStickYAxis"})(N_||(N_={}));var B_;(function(s){s[s.Cross=0]="Cross",s[s.Circle=1]="Circle",s[s.Square=2]="Square",s[s.Triangle=3]="Triangle",s[s.L1=4]="L1",s[s.R1=5]="R1",s[s.L2=6]="L2",s[s.R2=7]="R2",s[s.Create=8]="Create",s[s.Options=9]="Options",s[s.L3=10]="L3",s[s.R3=11]="R3",s[s.DPadUp=12]="DPadUp",s[s.DPadDown=13]="DPadDown",s[s.DPadLeft=14]="DPadLeft",s[s.DPadRight=15]="DPadRight",s[s.Home=16]="Home",s[s.TouchPad=17]="TouchPad",s[s.LStickXAxis=18]="LStickXAxis",s[s.LStickYAxis=19]="LStickYAxis",s[s.RStickXAxis=20]="RStickXAxis",s[s.RStickYAxis=21]="RStickYAxis"})(B_||(B_={}));var k_;(function(s){s[s.A=0]="A",s[s.B=1]="B",s[s.X=2]="X",s[s.Y=3]="Y",s[s.LB=4]="LB",s[s.RB=5]="RB",s[s.LT=6]="LT",s[s.RT=7]="RT",s[s.Back=8]="Back",s[s.Start=9]="Start",s[s.LS=10]="LS",s[s.RS=11]="RS",s[s.DPadUp=12]="DPadUp",s[s.DPadDown=13]="DPadDown",s[s.DPadLeft=14]="DPadLeft",s[s.DPadRight=15]="DPadRight",s[s.Home=16]="Home",s[s.LStickXAxis=17]="LStickXAxis",s[s.LStickYAxis=18]="LStickYAxis",s[s.RStickXAxis=19]="RStickXAxis",s[s.RStickYAxis=20]="RStickYAxis"})(k_||(k_={}));var U_;(function(s){s[s.B=0]="B",s[s.A=1]="A",s[s.Y=2]="Y",s[s.X=3]="X",s[s.L=4]="L",s[s.R=5]="R",s[s.ZL=6]="ZL",s[s.ZR=7]="ZR",s[s.Minus=8]="Minus",s[s.Plus=9]="Plus",s[s.LS=10]="LS",s[s.RS=11]="RS",s[s.DPadUp=12]="DPadUp",s[s.DPadDown=13]="DPadDown",s[s.DPadLeft=14]="DPadLeft",s[s.DPadRight=15]="DPadRight",s[s.Home=16]="Home",s[s.Capture=17]="Capture",s[s.LStickXAxis=18]="LStickXAxis",s[s.LStickYAxis=19]="LStickYAxis",s[s.RStickXAxis=20]="RStickXAxis",s[s.RStickYAxis=21]="RStickYAxis"})(U_||(U_={}));class ea{static CreateDeviceEvent(e,t,i,n,r,a,o){switch(e){case de.Keyboard:return this._CreateKeyboardEvent(i,n,r,a);case de.Mouse:if(i===Re.MouseWheelX||i===Re.MouseWheelY||i===Re.MouseWheelZ)return this._CreateWheelEvent(e,t,i,n,r,a);case de.Touch:return this._CreatePointerEvent(e,t,i,n,r,a,o);default:throw`Unable to generate event for device ${de[e]}`}}static _CreatePointerEvent(e,t,i,n,r,a,o){const l=this._CreateMouseEvent(e,t,i,n,r,a);e===de.Mouse?(l.deviceType=de.Mouse,l.pointerId=1,l.pointerType="mouse"):(l.deviceType=de.Touch,l.pointerId=o!=null?o:t,l.pointerType="touch");let c=0;return c+=r.pollInput(e,t,Re.LeftClick),c+=r.pollInput(e,t,Re.RightClick)*2,c+=r.pollInput(e,t,Re.MiddleClick)*4,l.buttons=c,i===Re.Move?l.type="pointermove":i>=Re.LeftClick&&i<=Re.RightClick&&(l.type=n===1?"pointerdown":"pointerup",l.button=i-2),l}static _CreateWheelEvent(e,t,i,n,r,a){const o=this._CreateMouseEvent(e,t,i,n,r,a);switch(o.pointerId=1,o.type="wheel",o.deltaMode=Do.DOM_DELTA_PIXEL,o.deltaX=0,o.deltaY=0,o.deltaZ=0,i){case Re.MouseWheelX:o.deltaX=n;break;case Re.MouseWheelY:o.deltaY=n;break;case Re.MouseWheelZ:o.deltaZ=n;break}return o}static _CreateMouseEvent(e,t,i,n,r,a){const o=this._CreateEvent(a),l=r.pollInput(e,t,Re.Horizontal),c=r.pollInput(e,t,Re.Vertical);return a?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-a.getBoundingClientRect().x,o.offsetY=o.movementY-a.getBoundingClientRect().y):(o.movementX=r.pollInput(e,t,Iu.DeltaHorizontal),o.movementY=r.pollInput(e,t,Iu.DeltaVertical),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,r),o.clientX=l,o.clientY=c,o.x=l,o.y=c,o.deviceType=e,o.deviceSlot=t,o.inputIndex=i,o}static _CreateKeyboardEvent(e,t,i,n){const r=this._CreateEvent(n);return this._CheckNonCharacterKeys(r,i),r.deviceType=de.Keyboard,r.deviceSlot=0,r.inputIndex=e,r.type=t===1?"keydown":"keyup",r.key=String.fromCharCode(e),r.keyCode=e,r}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(de.Keyboard),n=i&&t.pollInput(de.Keyboard,0,18)===1,r=i&&t.pollInput(de.Keyboard,0,17)===1,a=i&&(t.pollInput(de.Keyboard,0,91)===1||t.pollInput(de.Keyboard,0,92)===1||t.pollInput(de.Keyboard,0,93)===1),o=i&&t.pollInput(de.Keyboard,0,16)===1;e.altKey=n,e.ctrlKey=r,e.metaKey=a,e.shiftKey=o}static _CreateEvent(e){const t={};return t.preventDefault=()=>{},t.target=e,t}}class eS{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(n,r,a,o)=>{const l=ea.CreateDeviceEvent(n,r,a,o,this);i(n,r,l)}):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===de.Mouse||e===de.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}const V_=255,G_=Object.keys(Re).length/2;class tS{constructor(e,t,i,n){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=q.IsSafari(),this._usingMacOS=Kc()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=r=>{},this._keyboardUpEvent=r=>{},this._keyboardBlurEvent=r=>{},this._pointerMoveEvent=r=>{},this._pointerDownEvent=r=>{},this._pointerUpEvent=r=>{},this._pointerCancelEvent=r=>{},this._pointerWheelEvent=r=>{},this._pointerBlurEvent=r=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=Kc()&&navigator.userAgent&&navigator.userAgent.indexOf("Firefox")!==-1,this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=r=>{},this._gamepadDisconnectedEvent=r=>{},this._eventPrefix=q.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=n,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){const n=this._inputs[e][t];if(!n)throw`Unable to find device ${de[e]}`;e>=de.DualShock&&e<=de.DualSense&&this._updateDevice(e,t,i);const r=n[i];if(r===void 0)throw`Unable to find input ${i} for device ${de[e]} in slot ${t}`;return i===Re.Move&&q.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),r}isDeviceAvailable(e){return this._inputs[e]!==void 0}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=this===null||this===void 0?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs){for(const t of this._inputs)if(t)for(const i in t){const n=+i,r=t[n];if(r)for(let a=0;a<r.length;a++)r[a]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=this._elementToAttachTo.tabIndex!==-1?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}typeof matchMedia=="function"&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(de.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,n){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,G_);const r=this._inputs[e][t];r[0]=i,r[1]=n}_registerDevice(e,t,i){if(t===void 0)throw`Unable to register device ${de[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const n=new Array(i);n.fill(0),this._inputs[e][t]=n,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(de.Keyboard,0,V_));const t=this._inputs[de.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&e.key!=="Meta"&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(de.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(de.Keyboard,0,V_));const t=this._inputs[de.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOS&&e.key==="Meta"&&this._metaKeys.length>0){for(const n of this._metaKeys){const r=ea.CreateDeviceEvent(de.Keyboard,0,n,0,this,this._elementToAttachTo);t[n]=0,this._onInputChanged(de.Keyboard,0,r)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(de.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[de.Keyboard][0];for(let t=0;t<e.length;t++)if(e[t]!==0){e[t]=0;const i=ea.CreateDeviceEvent(de.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(de.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=Kc()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let i=0;i<this._maxTouchPoints;i++)this._activeTouchIds[i]=-1;this._pointerMoveEvent=i=>{const n=this._getPointerType(i);let r=n===de.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(n===de.Touch&&r===-1){const o=this._activeTouchIds.indexOf(-1);if(o>=0)r=o,this._activeTouchIds[o]=i.pointerId,this._onDeviceConnected(n,r);else{q.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[n]||(this._inputs[n]={}),this._inputs[n][r]||this._addPointerDevice(n,r,i.clientX,i.clientY);const a=this._inputs[n][r];if(a){const o=i;o.inputIndex=Re.Move,a[Re.Horizontal]=i.clientX,a[Re.Vertical]=i.clientY,n===de.Touch&&a[Re.LeftClick]===0&&(a[Re.LeftClick]=1),i.pointerId===void 0&&(i.pointerId=this._mouseId),this._onInputChanged(n,r,o),!this._usingSafari&&i.button!==-1&&(o.inputIndex=i.button+2,a[i.button+2]=a[i.button+2]?0:1,this._onInputChanged(n,r,o))}},this._pointerDownEvent=i=>{const n=this._getPointerType(i);let r=n===de.Mouse?0:i.pointerId;if(n===de.Touch){const o=this._activeTouchIds.indexOf(-1);if(o>=0)r=o,this._activeTouchIds[o]=i.pointerId;else{q.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[n]||(this._inputs[n]={}),this._inputs[n][r]?n===de.Touch&&this._onDeviceConnected(n,r):this._addPointerDevice(n,r,i.clientX,i.clientY);const a=this._inputs[n][r];if(a){const o=a[Re.Horizontal],l=a[Re.Vertical];if(n===de.Mouse){if(i.pointerId===void 0&&(i.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch(u){}}else if(i.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(i.pointerId)}catch(u){}a[Re.Horizontal]=i.clientX,a[Re.Vertical]=i.clientY,a[i.button+2]=1;const c=i;c.inputIndex=i.button+2,this._onInputChanged(n,r,c),(o!==i.clientX||l!==i.clientY)&&(c.inputIndex=Re.Move,this._onInputChanged(n,r,c))}},this._pointerUpEvent=i=>{var n,r,a,o,l;const c=this._getPointerType(i),u=c===de.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(c===de.Touch){if(u===-1)return;this._activeTouchIds[u]=-1}const h=(n=this._inputs[c])===null||n===void 0?void 0:n[u];if(h&&h[i.button+2]!==0){const d=h[Re.Horizontal],f=h[Re.Vertical];h[Re.Horizontal]=i.clientX,h[Re.Vertical]=i.clientY,h[i.button+2]=0;const p=i;i.pointerId===void 0&&(i.pointerId=this._mouseId),(d!==i.clientX||f!==i.clientY)&&(p.inputIndex=Re.Move,this._onInputChanged(c,u,p)),p.inputIndex=i.button+2,c===de.Mouse&&this._mouseId>=0&&(!((a=(r=this._elementToAttachTo).hasPointerCapture)===null||a===void 0)&&a.call(r,this._mouseId))?this._elementToAttachTo.releasePointerCapture(this._mouseId):i.pointerId&&(!((l=(o=this._elementToAttachTo).hasPointerCapture)===null||l===void 0)&&l.call(o,i.pointerId))&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._onInputChanged(c,u,p),c===de.Touch&&this._onDeviceDisconnected(c,u)}},this._pointerCancelEvent=i=>{var n,r,a,o;if(i.pointerType==="mouse"){const l=this._inputs[de.Mouse][0];this._mouseId>=0&&(!((r=(n=this._elementToAttachTo).hasPointerCapture)===null||r===void 0)&&r.call(n,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let c=Re.LeftClick;c<=Re.BrowserForward;c++)if(l[c]===1){l[c]=0;const u=ea.CreateDeviceEvent(de.Mouse,0,c,0,this,this._elementToAttachTo);this._onInputChanged(de.Mouse,0,u)}}else{const l=this._activeTouchIds.indexOf(i.pointerId);if(l===-1)return;!((o=(a=this._elementToAttachTo).hasPointerCapture)===null||o===void 0)&&o.call(a,i.pointerId)&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._inputs[de.Touch][l][Re.LeftClick]=0;const c=ea.CreateDeviceEvent(de.Touch,l,Re.LeftClick,0,this,this._elementToAttachTo,i.pointerId);this._onInputChanged(de.Touch,l,c),this._activeTouchIds[l]=-1,this._onDeviceDisconnected(de.Touch,l)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch(i){}this._pointerBlurEvent=()=>{var i,n,r,a,o;if(this.isDeviceAvailable(de.Mouse)){const l=this._inputs[de.Mouse][0];this._mouseId>=0&&(!((n=(i=this._elementToAttachTo).hasPointerCapture)===null||n===void 0)&&n.call(i,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let c=Re.LeftClick;c<=Re.BrowserForward;c++)if(l[c]===1){l[c]=0;const u=ea.CreateDeviceEvent(de.Mouse,0,c,0,this,this._elementToAttachTo);this._onInputChanged(de.Mouse,0,u)}}if(this.isDeviceAvailable(de.Touch)){const l=this._inputs[de.Touch];for(let c=0;c<this._activeTouchIds.length;c++){const u=this._activeTouchIds[c];if(!((a=(r=this._elementToAttachTo).hasPointerCapture)===null||a===void 0)&&a.call(r,u)&&this._elementToAttachTo.releasePointerCapture(u),u!==-1&&((o=l[c])===null||o===void 0?void 0:o[Re.LeftClick])===1){l[c][Re.LeftClick]=0;const h=ea.CreateDeviceEvent(de.Touch,c,Re.LeftClick,0,this,this._elementToAttachTo,u);this._onInputChanged(de.Touch,c,h),this._activeTouchIds[c]=-1,this._onDeviceDisconnected(de.Touch,c)}}}},this._pointerWheelEvent=i=>{const n=de.Mouse,r=0;this._inputs[n]||(this._inputs[n]=[]),this._inputs[n][r]||(this._pointerActive=!0,this._registerDevice(n,r,G_));const a=this._inputs[n][r];if(a){a[Re.MouseWheelX]=i.deltaX||0,a[Re.MouseWheelY]=i.deltaY||i.wheelDelta||0,a[Re.MouseWheelZ]=i.deltaZ||0;const o=i;i.pointerId===void 0&&(i.pointerId=this._mouseId),a[Re.MouseWheelX]!==0&&(o.inputIndex=Re.MouseWheelX,this._onInputChanged(n,r,o)),a[Re.MouseWheelY]!==0&&(o.inputIndex=Re.MouseWheelY,this._onInputChanged(n,r,o)),a[Re.MouseWheelZ]!==0&&(o.inputIndex=Re.MouseWheelZ,this._onInputChanged(n,r,o))}},this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,e?{passive:!1}:!1),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(de.Mouse)){const i=this._inputs[de.Mouse][0];i[Re.MouseWheelX]=0,i[Re.MouseWheelY]=0,i[Re.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){const n=navigator.getGamepads()[t];if(n&&e===this._gamepads[t]){const r=this._inputs[e][t];i>=n.buttons.length?r[i]=n.axes[i-n.buttons.length].valueOf():r[i]=n.buttons[i].value}}_getGamepadDeviceType(e){return e.indexOf("054c")!==-1?e.indexOf("0ce6")!==-1?de.DualSense:de.DualShock:e.indexOf("Xbox One")!==-1||e.search("Xbox 360")!==-1||e.search("xinput")!==-1?de.Xbox:e.indexOf("057e")!==-1?de.Switch:de.Generic}_getPointerType(e){let t=de.Mouse;return(e.pointerType==="touch"||e.pointerType==="pen"||e.touches)&&(t=de.Touch),t}}class z_{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new O,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}class iS{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=a=>{for(let o=0;o<this._devices.length;o++){const l=this._devices[o];for(const c in l){const u=+c;a._addDevice(new z_(this._deviceInputSystem,o,u))}}this._registeredManagers.push(a)},this.unregisterManager=a=>{const o=this._registeredManagers.indexOf(a);o>-1&&this._registeredManagers.splice(o,1)};const t=Object.keys(de).length/2;this._devices=new Array(t);const i=(a,o)=>{this._devices[a]||(this._devices[a]=new Array),this._devices[a][o]||(this._devices[a][o]=o);for(const l of this._registeredManagers){const c=new z_(this._deviceInputSystem,a,o);l._addDevice(c)}},n=(a,o)=>{var l;!((l=this._devices[a])===null||l===void 0)&&l[o]&&delete this._devices[a][o];for(const c of this._registeredManagers)c._removeDevice(a,o)},r=(a,o,l)=>{if(l)for(const c of this._registeredManagers)c._onInputChanged(a,o,l)};typeof _native!="undefined"?this._deviceInputSystem=new eS(i,n,r):this._deviceInputSystem=new tS(e,i,n,r)}dispose(){this._deviceInputSystem.dispose()}}class nS{getDeviceSource(e,t){if(t===void 0){if(this._firstDevice[e]===void 0)return null;t=this._firstDevice[e]}return!this._devices[e]||this._devices[e][t]===void 0?null:this._devices[e][t]}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(t=>!!t):[]}constructor(e){const t=Object.keys(de).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new iS(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new O(i=>{for(const n of this._devices)if(n)for(const r of n)r&&this.onDeviceConnectedObservable.notifyObserver(i,r)}),this.onDeviceDisconnectedObservable=new O,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){var i,n;const r=(i=this._devices[e])===null||i===void 0?void 0:i[t];this.onDeviceDisconnectedObservable.notifyObservers(r),!((n=this._devices[e])===null||n===void 0)&&n[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){var n,r;(r=(n=this._devices[e])===null||n===void 0?void 0:n[t])===null||r===void 0||r.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case de.Keyboard:case de.Mouse:this._firstDevice[e]=0;break;case de.Touch:case de.DualSense:case de.DualShock:case de.Xbox:case de.Switch:case de.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t){for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}}break}}}}class H_{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}}class qt{constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new j(0,0),this._previousStartingPointerPosition=new j(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=e||Fe.LastCreatedScene,this._scene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new j(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){const t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,t){const i=this._scene,n=i.getEngine(),r=n.getInputElement();r&&(r.tabIndex=n.canvasTabIndex,i.doNotHandleCursors||(r.style.cursor=i.defaultCursor)),this._setCursorAndPointerOverMesh(e,t,i);for(const l of i._pointerMoveStage){e=e||this._pickMove(t);const c=!!(e!=null&&e.pickedMesh);e=l.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,c,r)}const a=t.inputIndex>=Re.MouseWheelX&&t.inputIndex<=Re.MouseWheelZ?Ce.POINTERWHEEL:Ce.POINTERMOVE;i.onPointerMove&&(e=e||this._pickMove(t),i.onPointerMove(t,e,a));let o;e?(o=new Us(a,t,e),this._setRayOnPointerInfo(e,t)):(o=new Us(a,t,null,this),this._movePointerInfo=o),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(o,a)}_setRayOnPointerInfo(e,t){const i=this._scene;e&&i._pickingAvailable&&(e.ray||(e.ray=i.createPickingRay(t.offsetX,t.offsetY,D.Identity(),i.activeCamera)))}_addCameraPointerObserver(e,t){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,t)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,t,i){const n=this._scene,r=new YT(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(r.originalPickingInfo=e,r.ray=e.ray,e.originMesh&&(r.nearInteractionPickingInfo=e)),n.onPrePointerObservable.notifyObservers(r,i),!!r.skipOnPointerObservable}_pickMove(e){const t=this._scene,i=t.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,t.pointerMovePredicate,t.pointerMoveFastCheck,t.cameraToUseForPointers,t.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(i,e,t),i}_setCursorAndPointerOverMesh(e,t,i){const r=i.getEngine().getInputElement();if(e!=null&&e.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,t.pointerId,e,t),!i.doNotHandleCursors&&r&&this._pointerOverMesh){const a=this._pointerOverMesh._getActionManagerForTrigger();a&&a.hasPointerTriggers&&(r.style.cursor=a.hoverCursor||i.hoverCursor)}}else this.setPointerOverMesh(null,t.pointerId,e,t)}simulatePointerMove(e,t){const i=new PointerEvent("pointermove",t);i.inputIndex=Re.Move,!this._checkPrePointerObservable(e,i,Ce.POINTERMOVE)&&this._processPointerMove(e,i)}simulatePointerDown(e,t){const i=new PointerEvent("pointerdown",t);i.inputIndex=i.button+2,!this._checkPrePointerObservable(e,i,Ce.POINTERDOWN)&&this._processPointerDown(e,i)}_processPointerDown(e,t){const i=this._scene;if(e!=null&&e.pickedMesh){this._pickedDownMesh=e.pickedMesh;const a=e.pickedMesh._getActionManagerForTrigger();if(a){if(a.hasPickTriggers)switch(a.processTrigger(5,gi.CreateNew(e.pickedMesh,t,e)),t.button){case 0:a.processTrigger(2,gi.CreateNew(e.pickedMesh,t,e));break;case 1:a.processTrigger(4,gi.CreateNew(e.pickedMesh,t,e));break;case 2:a.processTrigger(3,gi.CreateNew(e.pickedMesh,t,e));break}a.hasSpecificTrigger(8)&&window.setTimeout(()=>{const o=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,l=>l.isPickable&&l.isVisible&&l.isReady()&&l.actionManager&&l.actionManager.hasSpecificTrigger(8)&&l===this._pickedDownMesh,!1,i.cameraToUseForPointers);o!=null&&o.pickedMesh&&a&&this._totalPointersPressed!==0&&Date.now()-this._startingPointerTime>qt.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,a.processTrigger(8,gi.CreateNew(o.pickedMesh,t)))},qt.LongPressDelay)}}else for(const a of i._pointerDownStage)e=a.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,!1);let n;const r=Ce.POINTERDOWN;e?(i.onPointerDown&&i.onPointerDown(t,e,r),n=new Us(r,t,e),this._setRayOnPointerInfo(e,t)):n=new Us(r,t,null,this),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(n,r)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,t,i){const n=new PointerEvent("pointerup",t);n.inputIndex=Re.Move;const r=new H_;i?r.doubleClick=!0:r.singleClick=!0,!this._checkPrePointerObservable(e,n,Ce.POINTERUP)&&this._processPointerUp(e,n,r)}_processPointerUp(e,t,i){const n=this._scene;if(e!=null&&e.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(n.onPointerPick&&n.onPointerPick(t,e),i.singleClick&&!i.ignore&&n.onPointerObservable.observers.length>this._cameraObserverCount)){const a=Ce.POINTERPICK,o=new Us(a,t,e);this._setRayOnPointerInfo(e,t),n.onPointerObservable.notifyObservers(o,a)}const r=e.pickedMesh._getActionManagerForTrigger();if(r&&!i.ignore){r.processTrigger(7,gi.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&r.processTrigger(1,gi.CreateNew(e.pickedMesh,t,e));const a=e.pickedMesh._getActionManagerForTrigger(6);i.doubleClick&&a&&a.processTrigger(6,gi.CreateNew(e.pickedMesh,t,e))}}else if(!i.ignore)for(const r of n._pointerUpStage)e=r.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,i.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const r=this._pickedDownMesh._getActionManagerForTrigger(16);r&&r.processTrigger(16,gi.CreateNew(this._pickedDownMesh,t))}if(!i.ignore){const r=new Us(Ce.POINTERUP,t,e);if(this._setRayOnPointerInfo(e,t),n.onPointerObservable.notifyObservers(r,Ce.POINTERUP),n.onPointerUp&&n.onPointerUp(t,e,Ce.POINTERUP),!i.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let a=0;if(i.singleClick?a=Ce.POINTERTAP:i.doubleClick&&(a=Ce.POINTERDOUBLETAP),a){const o=new Us(a,t,e);n.onPointerObservable.hasObservers()&&n.onPointerObservable.hasSpecificMask(a)&&n.onPointerObservable.notifyObservers(o,a)}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=!0,t=!0,i=!0,n=null){const r=this._scene,a=r.getEngine();n||(n=a.getInputElement()),this._alreadyAttached&&this.detachControl(),n&&(this._alreadyAttachedTo=n),this._deviceSourceManager=new nS(a),this._initActionManager=o=>{if(!this._meshPickProceed){const l=r.skipPointerUpPicking||r._registeredActions===0&&!this._checkForPicking()&&!r.onPointerUp?null:r.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,r.pointerUpPredicate,r.pointerUpFastCheck,r.cameraToUseForPointers);this._currentPickResult=l,l&&(o=l.hit&&l.pickedMesh?l.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return o},this._delayedSimpleClick=(o,l,c)=>{if((Date.now()-this._previousStartingPointerTime>qt.DoubleClickDelay&&!this._doubleClickOccured||o!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,l.singleClick=!0,l.ignore=!1,this._delayedClicks[o])){const u=this._delayedClicks[o].evt,h=Ce.POINTERTAP,d=new Us(h,u,this._currentPickResult);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(h)&&r.onPointerObservable.notifyObservers(d,h),this._delayedClicks[o]=null}},this._initClickEvent=(o,l,c,u)=>{var h,d;const f=new H_;this._currentPickResult=null;let p=null,m=o.hasSpecificMask(Ce.POINTERPICK)||l.hasSpecificMask(Ce.POINTERPICK)||o.hasSpecificMask(Ce.POINTERTAP)||l.hasSpecificMask(Ce.POINTERTAP)||o.hasSpecificMask(Ce.POINTERDOUBLETAP)||l.hasSpecificMask(Ce.POINTERDOUBLETAP);!m&&Sn&&(p=this._initActionManager(p,f),p&&(m=p.hasPickTriggers));let _=!1;if(m){const E=c.button;if(f.hasSwiped=this._isPointerSwiping(),!f.hasSwiped){let v=!qt.ExclusiveDoubleClickMode;if(v||(v=!o.hasSpecificMask(Ce.POINTERDOUBLETAP)&&!l.hasSpecificMask(Ce.POINTERDOUBLETAP),v&&!Sn.HasSpecificTrigger(6)&&(p=this._initActionManager(p,f),p&&(v=!p.hasSpecificTrigger(6)))),v)(Date.now()-this._previousStartingPointerTime>qt.DoubleClickDelay||E!==this._previousButtonPressed)&&(f.singleClick=!0,u(f,this._currentPickResult),_=!0);else{const A={evt:c,clickInfo:f,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,E,f,u),qt.DoubleClickDelay)};this._delayedClicks[E]=A}let y=o.hasSpecificMask(Ce.POINTERDOUBLETAP)||l.hasSpecificMask(Ce.POINTERDOUBLETAP);!y&&Sn.HasSpecificTrigger(6)&&(p=this._initActionManager(p,f),p&&(y=p.hasSpecificTrigger(6))),y&&(E===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<qt.DoubleClickDelay&&!this._doubleClickOccured?(!f.hasSwiped&&!this._isPointerSwiping()?(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,f.doubleClick=!0,f.ignore=!1,qt.ExclusiveDoubleClickMode&&this._delayedClicks[E]&&(clearTimeout((h=this._delayedClicks[E])===null||h===void 0?void 0:h.timeoutId),this._delayedClicks[E]=null),u(f,this._currentPickResult)):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=E,qt.ExclusiveDoubleClickMode?(this._delayedClicks[E]&&(clearTimeout((d=this._delayedClicks[E])===null||d===void 0?void 0:d.timeoutId),this._delayedClicks[E]=null),u(f,this._previousPickResult)):u(f,this._currentPickResult)),_=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=E))}}_||u(f,this._currentPickResult)},this._onPointerMove=o=>{if(this._updatePointerPosition(o),!this._isSwiping&&this._swipeButtonPressed!==-1&&(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>qt.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>qt.DragMovementThreshold),a.isPointerLock&&a._verifyPointerLock(),this._checkPrePointerObservable(null,o,o.inputIndex>=Re.MouseWheelX&&o.inputIndex<=Re.MouseWheelZ?Ce.POINTERWHEEL:Ce.POINTERMOVE)||!r.cameraToUseForPointers&&!r.activeCamera)return;if(r.skipPointerMovePicking){this._processPointerMove(new ar,o);return}r.pointerMovePredicate||(r.pointerMovePredicate=c=>c.isPickable&&c.isVisible&&c.isReady()&&c.isEnabled()&&(c.enablePointerMoveEvents||r.constantlyUpdateMeshUnderPointer||c._getActionManagerForTrigger()!==null)&&(!r.cameraToUseForPointers||(r.cameraToUseForPointers.layerMask&c.layerMask)!==0));const l=r._registeredActions>0||r.constantlyUpdateMeshUnderPointer?this._pickMove(o):null;this._processPointerMove(l,o)},this._onPointerDown=o=>{var l;if(this._totalPointersPressed++,this._pickedDownMesh=null,this._meshPickProceed=!1,qt.ExclusiveDoubleClickMode){for(let u=0;u<this._delayedClicks.length;u++)if(this._delayedClicks[u])if(o.button===u)clearTimeout((l=this._delayedClicks[u])===null||l===void 0?void 0:l.timeoutId);else{const h=this._delayedClicks[u].clickInfo;this._doubleClickOccured=!1,h.singleClick=!0,h.ignore=!1;const d=this._delayedClicks[u].evt,f=Ce.POINTERTAP,p=new Us(f,d,this._currentPickResult);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(f)&&r.onPointerObservable.notifyObservers(p,f),this._delayedClicks[u]=null}}if(this._updatePointerPosition(o),this._swipeButtonPressed===-1&&(this._swipeButtonPressed=o.button),r.preventDefaultOnPointerDown&&n&&(o.preventDefault(),n.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,o,Ce.POINTERDOWN)||!r.cameraToUseForPointers&&!r.activeCamera)return;this._pointerCaptures[o.pointerId]=!0,r.pointerDownPredicate||(r.pointerDownPredicate=u=>u.isPickable&&u.isVisible&&u.isReady()&&u.isEnabled()&&(!r.cameraToUseForPointers||(r.cameraToUseForPointers.layerMask&u.layerMask)!==0)),this._pickedDownMesh=null;let c;r.skipPointerDownPicking||r._registeredActions===0&&!this._checkForPicking()&&!r.onPointerDown?c=new ar:c=r.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,r.pointerDownPredicate,r.pointerDownFastCheck,r.cameraToUseForPointers),this._processPointerDown(c,o)},this._onPointerUp=o=>{this._totalPointersPressed!==0&&(this._totalPointersPressed--,this._pickedUpMesh=null,this._meshPickProceed=!1,this._updatePointerPosition(o),r.preventDefaultOnPointerUp&&n&&(o.preventDefault(),n.focus()),this._initClickEvent(r.onPrePointerObservable,r.onPointerObservable,o,(l,c)=>{if(r.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!l.ignore)){if(this._checkPrePointerObservable(null,o,Ce.POINTERUP)){this._swipeButtonPressed===o.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1),o.buttons===0&&(this._pointerCaptures[o.pointerId]=!1);return}l.hasSwiped||(l.singleClick&&r.onPrePointerObservable.hasSpecificMask(Ce.POINTERTAP)&&this._checkPrePointerObservable(null,o,Ce.POINTERTAP)&&(this._skipPointerTap=!0),l.doubleClick&&r.onPrePointerObservable.hasSpecificMask(Ce.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,o,Ce.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}if(!this._pointerCaptures[o.pointerId]){this._swipeButtonPressed===o.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1);return}o.buttons===0&&(this._pointerCaptures[o.pointerId]=!1),!(!r.cameraToUseForPointers&&!r.activeCamera)&&(r.pointerUpPredicate||(r.pointerUpPredicate=u=>u.isPickable&&u.isVisible&&u.isReady()&&u.isEnabled()&&(!r.cameraToUseForPointers||(r.cameraToUseForPointers.layerMask&u.layerMask)!==0)),!this._meshPickProceed&&(Sn&&Sn.HasTriggers||this._checkForPicking()||r.onPointerUp)&&this._initActionManager(null,l),c||(c=this._currentPickResult),this._processPointerUp(c,o,l),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===o.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))}))},this._onKeyDown=o=>{const l=Ao.KEYDOWN;if(r.onPreKeyboardObservable.hasObservers()){const c=new O_(l,o);if(r.onPreKeyboardObservable.notifyObservers(c,l),c.skipOnKeyboardObservable)return}if(r.onKeyboardObservable.hasObservers()){const c=new tf(l,o);r.onKeyboardObservable.notifyObservers(c,l)}r.actionManager&&r.actionManager.processTrigger(14,gi.CreateNewFromScene(r,o))},this._onKeyUp=o=>{const l=Ao.KEYUP;if(r.onPreKeyboardObservable.hasObservers()){const c=new O_(l,o);if(r.onPreKeyboardObservable.notifyObservers(c,l),c.skipOnKeyboardObservable)return}if(r.onKeyboardObservable.hasObservers()){const c=new tf(l,o);r.onKeyboardObservable.notifyObservers(c,l)}r.actionManager&&r.actionManager.processTrigger(15,gi.CreateNewFromScene(r,o))},this._deviceSourceManager.onDeviceConnectedObservable.add(o=>{o.deviceType===de.Mouse?o.onInputChangedObservable.add(l=>{l.inputIndex===Re.LeftClick||l.inputIndex===Re.MiddleClick||l.inputIndex===Re.RightClick||l.inputIndex===Re.BrowserBack||l.inputIndex===Re.BrowserForward?t&&o.getInput(l.inputIndex)===1?this._onPointerDown(l):e&&o.getInput(l.inputIndex)===0&&this._onPointerUp(l):i&&(l.inputIndex===Re.Move?this._onPointerMove(l):(l.inputIndex===Re.MouseWheelX||l.inputIndex===Re.MouseWheelY||l.inputIndex===Re.MouseWheelZ)&&this._onPointerMove(l))}):o.deviceType===de.Touch?o.onInputChangedObservable.add(l=>{l.inputIndex===Re.LeftClick&&(t&&o.getInput(l.inputIndex)===1?(this._onPointerDown(l),this._totalPointersPressed>1&&(this._isMultiTouchGesture=!0)):e&&o.getInput(l.inputIndex)===0&&(this._onPointerUp(l),this._totalPointersPressed===0&&(this._isMultiTouchGesture=!1))),i&&l.inputIndex===Re.Move&&this._onPointerMove(l)}):o.deviceType===de.Keyboard&&o.onInputChangedObservable.add(l=>{l.type==="keydown"?this._onKeyDown(l):l.type==="keyup"&&this._onKeyUp(l)})}),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,t=0,i,n){if(this._meshUnderPointerId[t]===e&&(!e||!e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const r=this._meshUnderPointerId[t];let a;r&&(a=r._getActionManagerForTrigger(10),a&&a.processTrigger(10,gi.CreateNew(r,n,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,a=e._getActionManagerForTrigger(9),a&&a.processTrigger(9,gi.CreateNew(e,n,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null)}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(const t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]}}qt.DragMovementThreshold=10;qt.LongPressDelay=500;qt.DoubleClickDelay=300;qt.ExclusiveDoubleClickMode=!1;class bE{static get UniqueId(){const e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}bE._UniqueIdCounter=1;class ft{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}ft.FALLOFF_DEFAULT=0;ft.FALLOFF_PHYSICAL=1;ft.FALLOFF_GLTF=2;ft.FALLOFF_STANDARD=3;ft.LIGHTMAP_DEFAULT=0;ft.LIGHTMAP_SPECULAR=1;ft.LIGHTMAP_SHADOWSONLY=2;ft.INTENSITYMODE_AUTOMATIC=0;ft.INTENSITYMODE_LUMINOUSPOWER=1;ft.INTENSITYMODE_LUMINOUSINTENSITY=2;ft.INTENSITYMODE_ILLUMINANCE=3;ft.INTENSITYMODE_LUMINANCE=4;ft.LIGHTTYPEID_POINTLIGHT=0;ft.LIGHTTYPEID_DIRECTIONALLIGHT=1;ft.LIGHTTYPEID_SPOTLIGHT=2;ft.LIGHTTYPEID_HEMISPHERICLIGHT=3;class sS{constructor(){this.pointerDownFastCheck=!1,this.pointerUpFastCheck=!1,this.pointerMoveFastCheck=!1,this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1}}var hs;(function(s){s[s.BackwardCompatible=0]="BackwardCompatible",s[s.Intermediate=1]="Intermediate",s[s.Aggressive=2]="Aggressive"})(hs||(hs={}));class Le extends Oo{static DefaultMaterialFactory(e){throw De("StandardMaterial")}static CollisionCoordinatorFactory(){throw De("DefaultCollisionCoordinator")}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.markAllMaterialsAsDirty(1))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case hs.BackwardCompatible:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case hs.Intermediate:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case hs.Aggressive:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1;break}this.onScenePerformancePriorityChangedObservable.notifyObservers(e)}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get pointerDownPredicate(){return this._pointerPickingConfiguration.pointerDownPredicate}set pointerDownPredicate(e){this._pointerPickingConfiguration.pointerDownPredicate=e}get pointerUpPredicate(){return this._pointerPickingConfiguration.pointerUpPredicate}set pointerUpPredicate(e){this._pointerPickingConfiguration.pointerUpPredicate=e}get pointerMovePredicate(){return this._pointerPickingConfiguration.pointerMovePredicate}set pointerMovePredicate(e){this._pointerPickingConfiguration.pointerMovePredicate=e}get pointerDownFastCheck(){return this._pointerPickingConfiguration.pointerDownFastCheck}set pointerDownFastCheck(e){this._pointerPickingConfiguration.pointerDownFastCheck=e}get pointerUpFastCheck(){return this._pointerPickingConfiguration.pointerUpFastCheck}set pointerUpFastCheck(e){this._pointerPickingConfiguration.pointerUpFastCheck=e}get pointerMoveFastCheck(){return this._pointerPickingConfiguration.pointerMoveFastCheck}set pointerMoveFastCheck(e){this._pointerPickingConfiguration.pointerMoveFastCheck=e}get skipPointerMovePicking(){return this._pointerPickingConfiguration.skipPointerMovePicking}set skipPointerMovePicking(e){this._pointerPickingConfiguration.skipPointerMovePicking=e}get skipPointerDownPicking(){return this._pointerPickingConfiguration.skipPointerDownPicking}set skipPointerDownPicking(e){this._pointerPickingConfiguration.skipPointerDownPicking=e}get skipPointerUpPicking(){return this._pointerPickingConfiguration.skipPointerUpPicking}set skipPointerUpPicking(e){this._pointerPickingConfiguration.skipPointerUpPicking=e}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return qt.DragMovementThreshold}static set DragMovementThreshold(e){qt.DragMovementThreshold=e}static get LongPressDelay(){return qt.LongPressDelay}static set LongPressDelay(e){qt.LongPressDelay=e}static get DoubleClickDelay(){return qt.DoubleClickDelay}static set DoubleClickDelay(e){qt.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return qt.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){qt.ExclusiveDoubleClickMode=e}bindEyePosition(e,t="vEyePosition",i=!1){var n;const r=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:(n=this.activeCamera.globalPosition)!==null&&n!==void 0?n:this.activeCamera.devicePosition,a=this.useRightHandedSystem===(this._mirroredCameraPosition!=null);return w.Vector4[0].set(r.x,r.y,r.z,a?-1:1),e&&(i?e.setFloat3(t,w.Vector4[0].x,w.Vector4[0].y,w.Vector4[0].z):e.setVector4(t,w.Vector4[0])),w.Vector4[0]}finalizeSceneUbo(){const e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",t.x,t.y,t.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=aE(e,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=Le.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=Le.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);const t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(e){for(const t of this._components)if(t.name===e)return t;return null}constructor(e,t){super(),this._inputManager=new qt(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new pe(.2,.2,.3,1),this.ambientColor=new G(0,0,0),this.environmentIntensity=1,this._performancePriority=hs.BackwardCompatible,this.onScenePerformancePriorityChangedObservable=new O,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=new Array,this.onDisposeObservable=new O,this._onDisposeObserver=null,this.onBeforeRenderObservable=new O,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new O,this.onAfterRenderCameraObservable=new O,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new O,this.onAfterAnimationsObservable=new O,this.onBeforeDrawPhaseObservable=new O,this.onAfterDrawPhaseObservable=new O,this.onReadyObservable=new O,this.onBeforeCameraRenderObservable=new O,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new O,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new O,this.onAfterActiveMeshesEvaluationObservable=new O,this.onBeforeParticlesRenderingObservable=new O,this.onAfterParticlesRenderingObservable=new O,this.onDataLoadedObservable=new O,this.onNewCameraAddedObservable=new O,this.onCameraRemovedObservable=new O,this.onNewLightAddedObservable=new O,this.onLightRemovedObservable=new O,this.onNewGeometryAddedObservable=new O,this.onGeometryRemovedObservable=new O,this.onNewTransformNodeAddedObservable=new O,this.onTransformNodeRemovedObservable=new O,this.onNewMeshAddedObservable=new O,this.onMeshRemovedObservable=new O,this.onNewSkeletonAddedObservable=new O,this.onSkeletonRemovedObservable=new O,this.onNewMaterialAddedObservable=new O,this.onNewMultiMaterialAddedObservable=new O,this.onMaterialRemovedObservable=new O,this.onMultiMaterialRemovedObservable=new O,this.onNewTextureAddedObservable=new O,this.onTextureRemovedObservable=new O,this.onBeforeRenderTargetsRenderObservable=new O,this.onAfterRenderTargetsRenderObservable=new O,this.onBeforeStepObservable=new O,this.onAfterStepObservable=new O,this.onActiveCameraChanged=new O,this.onActiveCamerasChanged=new O,this.onBeforeRenderingGroupObservable=new O,this.onAfterRenderingGroupObservable=new O,this.onMeshImportedObservable=new O,this.onAnimationFileImportedObservable=new O,this._registeredForLateAnimationBindings=new Jr(256),this._pointerPickingConfiguration=new sS,this.onPrePointerObservable=new O,this.onPointerObservable=new O,this.onPreKeyboardObservable=new O,this.onKeyboardObservable=new O,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=Le.FOGMODE_NONE,this.fogColor=new G(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new g(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=new Array,this.importedMeshesFiles=new Array,this.probesEnabled=!0,this._meshesForIntersections=new Jr(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new Ms,this._activeIndices=new Ms,this._activeParticles=new Ms,this._activeBones=new Ms,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new Mi(256),this._processedMaterials=new Mi(256),this._renderTargets=new Jr(256),this._materialsRenderTargets=new Jr(256),this._activeParticleSystems=new Mi(256),this._activeSkeletons=new Jr(32),this._softwareSkinnedMeshes=new Jr(32),this._activeAnimatables=new Array,this._transformMatrix=D.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=Zt.Create(),this._beforeClearStage=Zt.Create(),this._beforeRenderTargetClearStage=Zt.Create(),this._gatherRenderTargetsStage=Zt.Create(),this._gatherActiveCameraRenderTargetsStage=Zt.Create(),this._isReadyForMeshStage=Zt.Create(),this._beforeEvaluateActiveMeshStage=Zt.Create(),this._evaluateSubMeshStage=Zt.Create(),this._preActiveMeshStage=Zt.Create(),this._cameraDrawRenderTargetStage=Zt.Create(),this._beforeCameraDrawStage=Zt.Create(),this._beforeRenderTargetDrawStage=Zt.Create(),this._beforeRenderingGroupDrawStage=Zt.Create(),this._beforeRenderingMeshStage=Zt.Create(),this._afterRenderingMeshStage=Zt.Create(),this._afterRenderingGroupDrawStage=Zt.Create(),this._afterCameraDrawStage=Zt.Create(),this._afterCameraPostProcessStage=Zt.Create(),this._afterRenderTargetDrawStage=Zt.Create(),this._afterRenderTargetPostProcessStage=Zt.Create(),this._afterRenderStage=Zt.Create(),this._pointerMoveStage=Zt.Create(),this._pointerDownStage=Zt.Create(),this._pointerUpStage=Zt.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=new Array;const i=Object.assign({useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1},t);this._engine=e||Fe.LastCreatedEngine,i.virtual?this._engine._virtualScenes.push(this):(Fe._LastCreatedScene=this,this._engine.scenes.push(this)),this._uid=null,this._renderingManager=new Oi(this),sf&&(this.postProcessManager=new sf(this)),vi()&&this.attachControl(),this._createUbo(),je&&(this._imageProcessingConfiguration=new je),this.setDefaultCandidateProviders(),i.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=i.useMaterialMeshMap,this.useClonedMeshMap=i.useClonedMeshMap,(!t||!t.virtual)&&this._engine.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=this._getDefaultMeshCandidates.bind(this),this.getActiveSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getIntersectingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getCollidingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,i=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return this._animationRatio!==void 0?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,i=!0){this._inputManager.attachControl(e,t,i)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){var t,i,n;if(this._isDisposed)return!1;let r;const a=this.getEngine(),o=a.currentRenderPassId;a.currentRenderPassId=(i=(t=this.activeCamera)===null||t===void 0?void 0:t.renderPassId)!==null&&i!==void 0?i:o;let l=!0;for(this._pendingData.length>0&&(l=!1),(n=this.prePassRenderer)===null||n===void 0||n.update(),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),r=0;r<this.meshes.length;r++){const c=this.meshes[r];if(!c.subMeshes||c.subMeshes.length===0)continue;if(!c.isReady(!0)){l=!1;continue}const u=c.hasThinInstances||c.getClassName()==="InstancedMesh"||c.getClassName()==="InstancedLinesMesh"||a.getCaps().instancedArrays&&c.instances.length>0;for(const d of this._isReadyForMeshStage)d.action(c,u)||(l=!1);if(!e)continue;const h=c.material||this.defaultMaterial;if(h)if(h._storeEffectOnSubMeshes)for(const d of c.subMeshes){const f=d.getMaterial();f&&f.hasRenderTargetTextures&&f.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(f)===-1&&(this._processedMaterials.push(f),this._materialsRenderTargets.concatWithNoDuplicate(f.getRenderTargetTextures()))}else h.hasRenderTargetTextures&&h.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(h)===-1&&(this._processedMaterials.push(h),this._materialsRenderTargets.concatWithNoDuplicate(h.getRenderTargetTextures()))}if(e)for(r=0;r<this._materialsRenderTargets.length;++r)this._materialsRenderTargets.data[r].isReadyForRendering()||(l=!1);for(r=0;r<this.geometries.length;r++)this.geometries[r].delayLoadState===2&&(l=!1);if(this.activeCameras&&this.activeCameras.length>0)for(const c of this.activeCameras)c.isReady(!0)||(l=!1);else this.activeCamera&&(this.activeCamera.isReady(!0)||(l=!1));for(const c of this.particleSystems)c.isReady()||(l=!1);if(this.layers)for(const c of this.layers)c.isReady()||(l=!1);return a.areAllEffectsReady()||(l=!1),a.currentRenderPassId=o,l}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){const t=()=>{e(),setTimeout(()=>{this.unregisterBeforeRender(t)})};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){t!==void 0?setTimeout(()=>{this._executeOnceBeforeRender(e)},t):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){const t=this.isLoading,i=this._pendingData.indexOf(e);i!==-1&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.addOnce(e),this._executeWhenReadyTimeoutId===null&&this._checkIsReady(t)}whenReadyAsync(e=!1){return new Promise(t=>{this.executeWhenReady(()=>{t()},e)})}_checkIsReady(e=!1){if(this._registerTransientComponents(),this.isReady(e)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(e)},100)}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=Mn.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,i,n){!i&&!n&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),!(this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag)&&(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?Yn.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Yn.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,n):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e){const t=new le(this._engine,void 0,!1,e!=null?e:"scene");return t.addUniform("viewProjection",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return bE.UniqueId}addMesh(e,t=!1){this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(i=>{this.addMesh(i)}))}removeMesh(e,t=!1){const i=this.meshes.indexOf(e);return i!==-1&&(this.meshes[i]=this.meshes[this.meshes.length-1],this.meshes.pop(),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(n=>{this.removeMesh(n)}),i}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneTransformNodesArray!==-1||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){const t=e._indexInSceneTransformNodesArray;if(t!==-1){if(t!==this.transformNodes.length-1){const i=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=i,i._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){const t=this.skeletons.indexOf(e);return t!==-1&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){const t=this.morphTargetManagers.indexOf(e);return t!==-1&&this.morphTargetManagers.splice(t,1),t}removeLight(e){const t=this.lights.indexOf(e);if(t!==-1){for(const i of this.meshes)i._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){const t=this.cameras.indexOf(e);if(t!==-1&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){const i=this.activeCameras.indexOf(e);i!==-1&&this.activeCameras.splice(i,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){const t=this.particleSystems.indexOf(e);return t!==-1&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),t}removeAnimation(e){const t=this.animations.indexOf(e);return t!==-1&&this.animations.splice(t,1),t}stopAnimation(e,t,i){}removeAnimationGroup(e){const t=this.animationGroups.indexOf(e);return t!==-1&&this.animationGroups.splice(t,1),t}removeMultiMaterial(e){const t=this.multiMaterials.indexOf(e);return t!==-1&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){const t=e._indexInSceneMaterialArray;if(t!==-1&&t<this.materials.length){if(t!==this.materials.length-1){const i=this.materials[this.materials.length-1];this.materials[t]=i,i._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){const t=this.actionManagers.indexOf(e);return t!==-1&&this.actionManagers.splice(t,1),t}removeTexture(e){const t=this.textures.indexOf(e);return t!==-1&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(const t of this.meshes)t.lightSources.indexOf(e)===-1&&(t.lightSources.push(e),t._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(e)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(ft.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),this.onNewCameraAddedObservable.notifyObservers(e),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),this.onNewSkeletonAddedObservable.notifyObservers(e))}addParticleSystem(e){this._blockEntityCollection||this.particleSystems.push(e)}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||this.animationGroups.push(e)}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),this.onNewMultiMaterialAddedObservable.notifyObservers(e))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneMaterialArray!==-1||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),this.onNewMaterialAddedObservable.notifyObservers(e))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}switchActiveCamera(e,t=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){const t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){const t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let i=0;i<this.materials.length;i++){const n=this.materials[i];if(t(n))return n}if(e)for(let i=0;i<this.multiMaterials.length;i++){const n=this.multiMaterials[i];if(t(n))return n}return null}getMaterialByUniqueID(e,t=!1){return this._getMaterial(t,i=>i.uniqueId===e)}getMaterialById(e,t=!1){return this._getMaterial(t,i=>i.id===e)}getMaterialByName(e,t=!1){return this._getMaterial(t,i=>i.name===e)}getLastMaterialById(e,t=!1){for(let i=this.materials.length-1;i>=0;i--)if(this.materials[i].id===e)return this.materials[i];if(t){for(let i=this.multiMaterials.length-1;i>=0;i--)if(this.multiMaterials[i].id===e)return this.multiMaterials[i]}return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let n=0;n<i.bones.length;n++)if(i.bones[n].id===e)return i.bones[n]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let n=0;n<i.bones.length;n++)if(i.bones[n].name===e)return i.bones[n]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){const t=this._geometriesByUniqueId[e];if(t!==void 0)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}pushGeometry(e,t){return!t&&this._getGeometryByUniqueId(e.uniqueId)?!1:(this.addGeometry(e),this.onNewGeometryAddedObservable.notifyObservers(e),!0)}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(t=this._geometriesByUniqueId[e.uniqueId],t===void 0)return!1}else if(t=this.geometries.indexOf(e),t<0)return!1;if(t!==this.geometries.length-1){const i=this.geometries[this.geometries.length-1];i&&(this.geometries[t]=i,this._geometriesByUniqueId&&(this._geometriesByUniqueId[i.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter(function(t){return t.id===e})}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter(function(t){return t.id===e})}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastTransformNodeById(e){for(let t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){const t=this.getMeshById(e);if(t)return t;const i=this.getTransformNodeById(e);if(i)return i;const n=this.getLightById(e);if(n)return n;const r=this.getCameraById(e);if(r)return r;const a=this.getBoneById(e);return a||null}getNodeByName(e){const t=this.getMeshByName(e);if(t)return t;const i=this.getTransformNodeByName(e);if(i)return i;const n=this.getLightByName(e);if(n)return n;const r=this.getCameraByName(e);if(r)return r;const a=this.getBoneByName(e);return a||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let n=0;n<i.numTargets;++n){const r=i.getTarget(n);if(r.id===e)return r}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let n=0;n<i.numTargets;++n){const r=i.getTarget(n);if(r.name===e)return r}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){const i=this.postProcesses[t];if(i.name===e)return i}return null}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}get uid(){return this._uid||(this._uid=q.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new L_),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new L_),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,i,n){if(n||e.isInFrustum(this._frustumPlanes)){for(const a of this._evaluateSubMeshStage)a.action(t,e);const r=e.getMaterial();r!=null&&(r.hasRenderTargetTextures&&r.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(r)===-1&&(this._processedMaterials.push(r),this._materialsRenderTargets.concatWithNoDuplicate(r.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,r))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){const t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,i,n=!0,r=!1){return this.executeWhenReady(()=>{if(!this.activeCamera){i&&i("No active camera found");return}if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=r,this._skipEvaluateActiveMeshesCompletely=e,n)for(let a=0;a<this._activeMeshes.length;a++)this._activeMeshes.data[a]._freeze();t&&t()}),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){!(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>e.dispose())}_evaluateActiveMeshes(){var e;if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1){this._activeMeshes.length>0&&((e=this.activeCamera)===null||e===void 0||e._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const n=this._activeMeshes.length;for(let r=0;r<n;r++)this._activeMeshes.data[r].computeWorldMatrix()}if(this._activeParticleSystems){const n=this._activeParticleSystems.length;for(let r=0;r<n;r++)this._activeParticleSystems.data[r].animate()}this._renderingManager.resetSprites();return}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const n of this._beforeEvaluateActiveMeshStage)n.action();const t=this.getActiveMeshCandidates(),i=t.length;for(let n=0;n<i;n++){const r=t.data[n];if(r._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,r.isBlocked||(this._totalVertices.addCount(r.getTotalVertices(),!1),!r.isReady()||!r.isEnabled()||r.scaling.hasAZeroComponent))continue;r.computeWorldMatrix(),r.actionManager&&r.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(r);let a=this.customLODSelector?this.customLODSelector(r,this.activeCamera):r.getLOD(this.activeCamera);if(r._internalAbstractMeshDataInfo._currentLOD=a,r._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,a!=null&&(a!==r&&a.billboardMode!==0&&a.computeWorldMatrix(),r._preActivate(),r.isVisible&&r.visibility>0&&r.layerMask&this.activeCamera.layerMask&&(this._skipFrustumClipping||r.alwaysSelectAsActiveMesh||r.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(r),this.activeCamera._activeMeshes.push(r),a!==r&&a._activate(this._renderId,!1);for(const o of this._preActiveMeshStage)o.action(r);r._activate(this._renderId,!1)&&(r.isAnInstance?r._internalAbstractMeshDataInfo._actAsRegularMesh&&(a=r):a._internalAbstractMeshDataInfo._onlyForInstances=!1,a._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(r,a)),r._postActivate()}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let n=0;n<this.particleSystems.length;n++){const r=this.particleSystems[n];if(!r.isStarted()||!r.emitter)continue;const a=r.emitter;(!a.position||a.isEnabled())&&(this._activeParticleSystems.push(r),r.animate(),this._renderingManager.dispatchParticles(r))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_activeMesh(e,t){this._skeletonsEnabled&&t.skeleton!==null&&t.skeleton!==void 0&&(this._activeSkeletons.pushNoDuplicate(t.skeleton)&&(t.skeleton.prepare(),this._activeBones.addCount(t.skeleton.bones.length,!1)),t.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(t));let i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){const n=this.getActiveSubMeshCandidates(t),r=n.length;i=i||r===1;for(let a=0;a<r;a++){const o=n.data[a];this._evaluateSubMesh(o,t,e,i)}}}updateTransformMatrix(e){if(this.activeCamera)if(this.activeCamera._renderingMultiview){const t=this.activeCamera._rigCameras[0],i=this.activeCamera._rigCameras[1];this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e),i.getViewMatrix(),i.getProjectionMatrix(e))}else this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(!(e&&e._multiviewTexture))if(e&&e.outputRenderTarget&&!e._renderingMultiview){const t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):t.skipInitialClear||(this.autoClear&&this._engine.clear(t.clearColor||this.clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,i=!0){var n,r,a;if(e&&e._skipRendering)return;const o=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(o.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i){let c=!0;e._renderingMultiview&&e.outputRenderTarget&&(c=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=c)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let c=0;c<this._softwareSkinnedMeshes.length;c++){const u=this._softwareSkinnedMeshes.data[c];u.applySkeleton(u.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const c of this._gatherActiveCameraRenderTargetsStage)c.action(this._renderTargets);let l=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){q.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let c=0;c<this._renderTargets.length;c++){const u=this._renderTargets.data[c];if(u._shouldRender()){this._renderId++;const h=u.activeCamera&&u.activeCamera!==this.activeCamera;u.render(h,this.dumpNextRenderTargets),l=!0}}q.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(const c of this._cameraDrawRenderTargetStage)l=c.action(this.activeCamera)||l;this._intermediateRendering=!1}this._engine.currentRenderPassId=(a=(r=(n=e.outputRenderTarget)===null||n===void 0?void 0:n.renderPassId)!==null&&r!==void 0?r:e.renderPassId)!==null&&a!==void 0?a:0,l&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!e._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(const c of this._beforeCameraDrawStage)c.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),o.snapshotRendering&&o.snapshotRenderingMode===1&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const c of this._afterCameraDrawStage)c.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){const c=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,c)}for(const c of this._afterCameraPostProcessStage)c.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(e.cameraRigMode===0||e._renderingMultiview){e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),this.onAfterRenderCameraObservable.notifyObservers(e);return}if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let i=0;i<e._rigCameras.length;i++)this._renderForCamera(e._rigCameras[i],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){const t=this._meshesForIntersections.data[e];if(t.actionManager)for(let i=0;t.actionManager&&i<t.actionManager.actions.length;i++){const n=t.actionManager.actions[i];if(n.trigger===12||n.trigger===13){const r=n.getTriggerParameter(),a=r.mesh?r.mesh:r,o=a.intersectsMesh(t,r.usePreciseIntersection),l=t._intersectionsInProgress.indexOf(a);o&&l===-1?n.trigger===12?(n._executeCurrent(gi.CreateNew(t,void 0,a)),t._intersectionsInProgress.push(a)):n.trigger===13&&t._intersectionsInProgress.push(a):!o&&l>-1&&(n.trigger===13&&n._executeCurrent(gi.CreateNew(t,void 0,a)),(!t.actionManager.hasSpecificTrigger(13,c=>{const u=c.mesh?c.mesh:c;return a===u})||n.trigger===13)&&t._intersectionsInProgress.splice(l,1))}}}}_advancePhysicsEngineStep(e){}_animate(){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(Le.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Le.MaxDeltaTime))+this._timeAccumulator;const t=this._engine.getTimeStep(),i=1e3/t/1e3;let n=0;const r=this._engine.getLockstepMaxSteps();let a=Math.floor(e/t);for(a=Math.min(a,r);e>0&&n<a;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*i,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,n++,e-=t;this._timeAccumulator=e<0?0:e}else{const e=this.useConstantAnimationDeltaTime?16:Math.max(Le.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Le.MaxDeltaTime));this._animationRatio=e*(60/1e3),this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){var t;if(e!=null&&e.outputRenderTarget&&!(e!=null&&e.isRigCamera)&&(e.outputRenderTarget._cleared=!1),!((t=e==null?void 0:e.rigCameras)===null||t===void 0)&&t.length)for(let i=0;i<e.rigCameras.length;++i){const n=e.rigCameras[i].outputRenderTarget;n&&(n._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(const t of this.meshes)t.resetDrawCache(e)}render(e=!0,t=!1){var i,n,r;if(this.isDisposed)return;this.onReadyObservable.hasObservers()&&this._executeWhenReadyTimeoutId===null&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),!((i=this.activeCameras)===null||i===void 0)&&i.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate();for(const l of this._beforeCameraUpdateStage)l.action();if(e){if(this.activeCameras&&this.activeCameras.length>0)for(let l=0;l<this.activeCameras.length;l++){const c=this.activeCameras[l];if(c.update(),c.cameraRigMode!==0)for(let u=0;u<c._rigCameras.length;u++)c._rigCameras[u].update()}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==0))for(let l=0;l<this.activeCamera._rigCameras.length;l++)this.activeCamera._rigCameras[l].update()}this.onBeforeRenderObservable.notifyObservers(this);const a=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const o=!((n=this.activeCameras)===null||n===void 0)&&n.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){q.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let l=0;l<this.customRenderTargets.length;l++){const c=this.customRenderTargets[l];if(c._shouldRender()){if(this._renderId++,this.activeCamera=c.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");a.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),c.render(o!==this.activeCamera,this.dumpNextRenderTargets)}}q.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=(r=o==null?void 0:o.renderPassId)!==null&&r!==void 0?r:0,this.activeCamera=o,this._activeCamera&&this._activeCamera.cameraRigMode!==22&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const l of this._beforeClearStage)l.action();this._clearFrameBuffer(this.activeCamera);for(const l of this._gatherRenderTargetsStage)l.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let l=0;l<this.activeCameras.length;l++)this._processSubCameras(this.activeCameras[l],l>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._checkIntersections();for(const l of this._afterRenderStage)l.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let l=0;l<this._toBeDisposed.length;l++){const c=this._toBeDisposed[l];c&&c.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=new Array,this.stopAllAnimations&&(this._activeAnimatables.forEach(r=>{r.onAnimationEndObservable.clear(),r.onAnimationEnd=null}),this.stopAllAnimations()),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const e=this._activeRequests.slice();for(const r of e)r.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(r){console.error("An error occurred while calling onDisposeObservable!",r)}if(this.detachControl(),this._engine.getInputElement())for(let r=0;r<this.cameras.length;r++)this.cameras[r].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,r=>r.dispose(!0)),this._disposeList(this.transformNodes,r=>r.dispose(!0));const i=this.cameras;this._disposeList(i),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let n=this._engine.scenes.indexOf(this);n>-1&&this._engine.scenes.splice(n,1),Fe._LastCreatedScene===this&&(this._engine.scenes.length>0?Fe._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:Fe._LastCreatedScene=null),n=this._engine._virtualScenes.indexOf(this),n>-1&&this._engine._virtualScenes.splice(n,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this._isDisposed=!0}_disposeList(e,t){const i=e.slice(0);t=t!=null?t:n=>n.dispose();for(const n of i)t(n);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){const i=this.meshes[e].geometry;i&&i.clearCachedData()}}cleanCachedTextureBuffer(){for(const e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){const t=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new g(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return e=e||(()=>!0),this.meshes.filter(e).forEach(n=>{if(n.computeWorldMatrix(!0),!n.subMeshes||n.subMeshes.length===0||n.infiniteDistance)return;const r=n.getBoundingInfo(),a=r.boundingBox.minimumWorld,o=r.boundingBox.maximumWorld;g.CheckExtends(a,t,i),g.CheckExtends(o,t,i)}),{min:t,max:i}}createPickingRay(e,t,i,n,r=!1){throw De("Ray")}createPickingRayToRef(e,t,i,n,r,a=!1,o=!1){throw De("Ray")}createPickingRayInCameraSpace(e,t,i){throw De("Ray")}createPickingRayInCameraSpaceToRef(e,t,i,n){throw De("Ray")}get _pickingAvailable(){return!1}pick(e,t,i,n,r,a){return new ar}pickWithBoundingInfo(e,t,i,n,r){return new ar}pickWithRay(e,t,i,n){throw De("Ray")}multiPick(e,t,i,n,r){throw De("Ray")}multiPickWithRay(e,t,i){throw De("Ray")}setPointerOverMesh(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const e of this._components)e.rebuild();for(const e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(const e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(const e of this.textures)e._rebuild();this.markAllMaterialsAsDirty(1)}_getByTags(e,t,i){if(t===void 0)return e;const n=[];i=i||(r=>{});for(const r in e){const a=e[r];Ye&&Ye.MatchesQuery(a,t)&&(n.push(a),i(a))}return n}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,i=null,n=null){this._renderingManager.setRenderingOrder(e,t,i,n)}setRenderingAutoClearDepthStencil(e,t,i=!0,n=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,n)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(const i of this.materials)t&&!t(i)||i.markAsDirty(e)}_loadFile(e,t,i,n,r,a,o){const l=Vr(e,t,i,n?this.offlineProvider:void 0,r,a,o);return this._activeRequests.push(l),l.onCompleteObservable.add(c=>{this._activeRequests.splice(this._activeRequests.indexOf(c),1)}),l}_loadFileAsync(e,t,i,n,r){return new Promise((a,o)=>{this._loadFile(e,l=>{a(l)},t,i,n,(l,c)=>{o(c)},r)})}_requestFile(e,t,i,n,r,a,o){const l=jp(e,t,i,n?this.offlineProvider:void 0,r,a,o);return this._activeRequests.push(l),l.onCompleteObservable.add(c=>{this._activeRequests.splice(this._activeRequests.indexOf(c),1)}),l}_requestFileAsync(e,t,i,n,r){return new Promise((a,o)=>{this._requestFile(e,l=>{a(l)},t,i,n,l=>{o(l)},r)})}_readFile(e,t,i,n,r){const a=Fl(e,t,i,n,r);return this._activeRequests.push(a),a.onCompleteObservable.add(o=>{this._activeRequests.splice(this._activeRequests.indexOf(o),1)}),a}_readFileAsync(e,t,i){return new Promise((n,r)=>{this._readFile(e,a=>{n(a)},t,i,a=>{r(a)})})}getPerfCollector(){throw De("performanceViewerSceneExtension")}setActiveCameraByID(e){return this.setActiveCameraById(e)}getMaterialByID(e){return this.getMaterialById(e)}getLastMaterialByID(e){return this.getLastMaterialById(e)}getTextureByUniqueID(e){return this.getTextureByUniqueId(e)}getCameraByID(e){return this.getCameraById(e)}getCameraByUniqueID(e){return this.getCameraByUniqueId(e)}getBoneByID(e){return this.getBoneById(e)}getLightByID(e){return this.getLightById(e)}getLightByUniqueID(e){return this.getLightByUniqueId(e)}getParticleSystemByID(e){return this.getParticleSystemById(e)}getGeometryByID(e){return this.getGeometryById(e)}getMeshByID(e){return this.getMeshById(e)}getMeshByUniqueID(e){return this.getMeshByUniqueId(e)}getLastMeshByID(e){return this.getLastMeshById(e)}getMeshesByID(e){return this.getMeshesById(e)}getTransformNodeByID(e){return this.getTransformNodeById(e)}getTransformNodeByUniqueID(e){return this.getTransformNodeByUniqueId(e)}getTransformNodesByID(e){return this.getTransformNodesById(e)}getNodeByID(e){return this.getNodeById(e)}getLastEntryByID(e){return this.getLastEntryById(e)}getLastSkeletonByID(e){return this.getLastSkeletonById(e)}}Le.FOGMODE_NONE=0;Le.FOGMODE_EXP=1;Le.FOGMODE_EXP2=2;Le.FOGMODE_LINEAR=3;Le.MinDeltaTime=1;Le.MaxDeltaTime=1e3;function em(s){s.indexOf("vClipPlane")===-1&&s.push("vClipPlane"),s.indexOf("vClipPlane2")===-1&&s.push("vClipPlane2"),s.indexOf("vClipPlane3")===-1&&s.push("vClipPlane3"),s.indexOf("vClipPlane4")===-1&&s.push("vClipPlane4"),s.indexOf("vClipPlane5")===-1&&s.push("vClipPlane5"),s.indexOf("vClipPlane6")===-1&&s.push("vClipPlane6")}function rS(s,e,t){var i,n,r,a,o,l;const c=!!((i=s.clipPlane)!==null&&i!==void 0?i:e.clipPlane),u=!!((n=s.clipPlane2)!==null&&n!==void 0?n:e.clipPlane2),h=!!((r=s.clipPlane3)!==null&&r!==void 0?r:e.clipPlane3),d=!!((a=s.clipPlane4)!==null&&a!==void 0?a:e.clipPlane4),f=!!((o=s.clipPlane5)!==null&&o!==void 0?o:e.clipPlane5),p=!!((l=s.clipPlane6)!==null&&l!==void 0?l:e.clipPlane6);c&&t.push("#define CLIPPLANE"),u&&t.push("#define CLIPPLANE2"),h&&t.push("#define CLIPPLANE3"),d&&t.push("#define CLIPPLANE4"),f&&t.push("#define CLIPPLANE5"),p&&t.push("#define CLIPPLANE6")}function aS(s,e,t){var i,n,r,a,o,l;let c=!1;const u=!!((i=s.clipPlane)!==null&&i!==void 0?i:e.clipPlane),h=!!((n=s.clipPlane2)!==null&&n!==void 0?n:e.clipPlane2),d=!!((r=s.clipPlane3)!==null&&r!==void 0?r:e.clipPlane3),f=!!((a=s.clipPlane4)!==null&&a!==void 0?a:e.clipPlane4),p=!!((o=s.clipPlane5)!==null&&o!==void 0?o:e.clipPlane5),m=!!((l=s.clipPlane6)!==null&&l!==void 0?l:e.clipPlane6);return t.CLIPPLANE!==u&&(t.CLIPPLANE=u,c=!0),t.CLIPPLANE2!==h&&(t.CLIPPLANE2=h,c=!0),t.CLIPPLANE3!==d&&(t.CLIPPLANE3=d,c=!0),t.CLIPPLANE4!==f&&(t.CLIPPLANE4=f,c=!0),t.CLIPPLANE5!==p&&(t.CLIPPLANE5=p,c=!0),t.CLIPPLANE6!==m&&(t.CLIPPLANE6=m,c=!0),c}function tm(s,e,t){var i,n,r,a,o,l;let c=(i=e.clipPlane)!==null&&i!==void 0?i:t.clipPlane;xa(s,"vClipPlane",c),c=(n=e.clipPlane2)!==null&&n!==void 0?n:t.clipPlane2,xa(s,"vClipPlane2",c),c=(r=e.clipPlane3)!==null&&r!==void 0?r:t.clipPlane3,xa(s,"vClipPlane3",c),c=(a=e.clipPlane4)!==null&&a!==void 0?a:t.clipPlane4,xa(s,"vClipPlane4",c),c=(o=e.clipPlane5)!==null&&o!==void 0?o:t.clipPlane5,xa(s,"vClipPlane5",c),c=(l=e.clipPlane6)!==null&&l!==void 0?l:t.clipPlane6,xa(s,"vClipPlane6",c)}function xa(s,e,t){t&&s.setFloat4(e,t.normal.x,t.normal.y,t.normal.z,t.d)}class se{static BindSceneUniformBuffer(e,t){t.bindToEffect(e,"Scene")}static PrepareDefinesForMergedUV(e,t,i){t._needUVs=!0,t[i]=!0,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(t[i+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[i+"DIRECTUV"]=0}static BindTextureMatrix(e,t,i){const n=e.getTextureMatrix();t.updateMatrix(i+"Matrix",n)}static GetFogState(e,t){return t.fogEnabled&&e.applyFog&&t.fogMode!==Le.FOGMODE_NONE}static PrepareDefinesForMisc(e,t,i,n,r,a,o,l=!1){o._areMiscDirty&&(o.LOGARITHMICDEPTH=i,o.POINTSIZE=n,o.FOG=r&&this.GetFogState(e,t),o.NONUNIFORMSCALING=e.nonUniformScaling,o.ALPHATEST=a,o.DECAL_AFTER_DETAIL=l)}static PrepareDefinesForCamera(e,t){let i=!1;if(e.activeCamera){const n=t.CAMERA_ORTHOGRAPHIC?1:0,r=t.CAMERA_PERSPECTIVE?1:0,a=e.activeCamera.mode===Ee.ORTHOGRAPHIC_CAMERA?1:0,o=e.activeCamera.mode===Ee.PERSPECTIVE_CAMERA?1:0;(n^a||r^o)&&(t.CAMERA_ORTHOGRAPHIC=a===1,t.CAMERA_PERSPECTIVE=o===1,i=!0)}return i}static PrepareDefinesForFrameBoundValues(e,t,i,n,r,a=null,o=!1){let l=se.PrepareDefinesForCamera(e,n);a!==!1&&(l=aS(i,e,n)),n.DEPTHPREPASS!==!t.getColorWrite()&&(n.DEPTHPREPASS=!n.DEPTHPREPASS,l=!0),n.INSTANCES!==r&&(n.INSTANCES=r,l=!0),n.THIN_INSTANCES!==o&&(n.THIN_INSTANCES=o,l=!0),l&&n.markAsUnprocessed()}static PrepareDefinesForBones(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;const i=t.BONETEXTURE!==void 0;if(e.skeleton.isUsingTextureForMatrices&&i)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=i?!1:void 0;const n=e.getScene().prePassRenderer;if(n&&n.enabled){const r=n.excludedSkinnedMesh.indexOf(e)===-1;t.BONES_VELOCITY_ENABLED=r}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,t.BONETEXTURE!==void 0&&(t.BONETEXTURE=!1)}static PrepareDefinesForMorphTargets(e,t){const i=e.morphTargetManager;i?(t.MORPHTARGETS_UV=i.supportsUVs&&t.UV1,t.MORPHTARGETS_TANGENT=i.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=i.supportsNormals&&t.NORMAL,t.MORPHTARGETS=i.numInfluencers>0,t.NUM_MORPH_INFLUENCERS=i.numInfluencers,t.MORPHTARGETS_TEXTURE=i.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)}static PrepareDefinesForBakedVertexAnimation(e,t){const i=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!!(i&&i.isEnabled)}static PrepareDefinesForAttributes(e,t,i,n,r=!1,a=!0,o=!0){if(!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(C.NormalKind),t._needNormals&&e.isVerticesDataPresent(C.TangentKind)&&(t.TANGENT=!0);for(let l=1;l<=6;++l)t["UV"+l]=t._needUVs?e.isVerticesDataPresent(`uv${l===1?"":l}`):!1;if(i){const l=e.useVertexColors&&e.isVerticesDataPresent(C.ColorKind);t.VERTEXCOLOR=l,t.VERTEXALPHA=e.hasVertexAlpha&&l&&a}return e.isVerticesDataPresent(C.ColorInstanceKind)&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),n&&this.PrepareDefinesForBones(e,t),r&&this.PrepareDefinesForMorphTargets(e,t),o&&this.PrepareDefinesForBakedVertexAnimation(e,t),!0}static PrepareDefinesForMultiview(e,t){if(e.activeCamera){const i=t.MULTIVIEW;t.MULTIVIEW=e.activeCamera.outputRenderTarget!==null&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=i&&t.markAsUnprocessed()}}static PrepareDefinesForOIT(e,t,i){const n=t.ORDER_INDEPENDENT_TRANSPARENCY,r=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&i,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,(n!==t.ORDER_INDEPENDENT_TRANSPARENCY||r!==t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&t.markAsUnprocessed()}static PrepareDefinesForPrePass(e,t,i){const n=t.PREPASS;if(!t._arePrePassDirty)return;const r=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&i){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount;for(let a=0;a<r.length;a++){const o=e.prePassRenderer.getIndex(r[a].type);o!==-1?(t[r[a].define]=!0,t[r[a].index]=o):t[r[a].define]=!1}}else{t.PREPASS=!1;for(let a=0;a<r.length;a++)t[r[a].define]=!1}t.PREPASS!=n&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}static PrepareDefinesForLight(e,t,i,n,r,a,o){var l;switch(o.needNormals=!0,r["LIGHT"+n]===void 0&&(o.needRebuild=!0),r["LIGHT"+n]=!0,r["SPOTLIGHT"+n]=!1,r["HEMILIGHT"+n]=!1,r["POINTLIGHT"+n]=!1,r["DIRLIGHT"+n]=!1,i.prepareLightSpecificDefines(r,n),r["LIGHT_FALLOFF_PHYSICAL"+n]=!1,r["LIGHT_FALLOFF_GLTF"+n]=!1,r["LIGHT_FALLOFF_STANDARD"+n]=!1,i.falloffType){case ft.FALLOFF_GLTF:r["LIGHT_FALLOFF_GLTF"+n]=!0;break;case ft.FALLOFF_PHYSICAL:r["LIGHT_FALLOFF_PHYSICAL"+n]=!0;break;case ft.FALLOFF_STANDARD:r["LIGHT_FALLOFF_STANDARD"+n]=!0;break}if(a&&!i.specular.equalsFloats(0,0,0)&&(o.specularEnabled=!0),r["SHADOW"+n]=!1,r["SHADOWCSM"+n]=!1,r["SHADOWCSMDEBUG"+n]=!1,r["SHADOWCSMNUM_CASCADES"+n]=!1,r["SHADOWCSMUSESHADOWMAXZ"+n]=!1,r["SHADOWCSMNOBLEND"+n]=!1,r["SHADOWCSM_RIGHTHANDED"+n]=!1,r["SHADOWPCF"+n]=!1,r["SHADOWPCSS"+n]=!1,r["SHADOWPOISSON"+n]=!1,r["SHADOWESM"+n]=!1,r["SHADOWCLOSEESM"+n]=!1,r["SHADOWCUBE"+n]=!1,r["SHADOWLOWQUALITY"+n]=!1,r["SHADOWMEDIUMQUALITY"+n]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&i.shadowEnabled){const c=(l=i.getShadowGenerator(e.activeCamera))!==null&&l!==void 0?l:i.getShadowGenerator();if(c){const u=c.getShadowMap();u&&u.renderList&&u.renderList.length>0&&(o.shadowEnabled=!0,c.prepareDefines(r,n))}}i.lightmapMode!=ft.LIGHTMAP_DEFAULT?(o.lightmapMode=!0,r["LIGHTMAPEXCLUDED"+n]=!0,r["LIGHTMAPNOSPECULAR"+n]=i.lightmapMode==ft.LIGHTMAP_SHADOWSONLY):(r["LIGHTMAPEXCLUDED"+n]=!1,r["LIGHTMAPNOSPECULAR"+n]=!1)}static PrepareDefinesForLights(e,t,i,n,r=4,a=!1){if(!i._areLightsDirty)return i._needNormals;let o=0;const l={needNormals:i._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!a){for(const u of t.lightSources)if(this.PrepareDefinesForLight(e,t,u,o,i,n,l),o++,o===r)break}i.SPECULARTERM=l.specularEnabled,i.SHADOWS=l.shadowEnabled;for(let u=o;u<r;u++)i["LIGHT"+u]!==void 0&&(i["LIGHT"+u]=!1,i["HEMILIGHT"+u]=!1,i["POINTLIGHT"+u]=!1,i["DIRLIGHT"+u]=!1,i["SPOTLIGHT"+u]=!1,i["SHADOW"+u]=!1,i["SHADOWCSM"+u]=!1,i["SHADOWCSMDEBUG"+u]=!1,i["SHADOWCSMNUM_CASCADES"+u]=!1,i["SHADOWCSMUSESHADOWMAXZ"+u]=!1,i["SHADOWCSMNOBLEND"+u]=!1,i["SHADOWCSM_RIGHTHANDED"+u]=!1,i["SHADOWPCF"+u]=!1,i["SHADOWPCSS"+u]=!1,i["SHADOWPOISSON"+u]=!1,i["SHADOWESM"+u]=!1,i["SHADOWCLOSEESM"+u]=!1,i["SHADOWCUBE"+u]=!1,i["SHADOWLOWQUALITY"+u]=!1,i["SHADOWMEDIUMQUALITY"+u]=!1);const c=e.getEngine().getCaps();return i.SHADOWFLOAT===void 0&&(l.needRebuild=!0),i.SHADOWFLOAT=l.shadowEnabled&&(c.textureFloatRender&&c.textureFloatLinearFiltering||c.textureHalfFloatRender&&c.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=l.lightmapMode,l.needRebuild&&i.rebuild(),l.needNormals}static PrepareUniformsAndSamplersForLight(e,t,i,n,r=null,a=!1){r&&r.push("Light"+e),!a&&(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),i.push("shadowSampler"+e),i.push("depthSampler"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),n&&(i.push("projectionLightSampler"+e),t.push("textureProjectionMatrix"+e)))}static PrepareUniformsAndSamplersList(e,t,i,n=4){let r,a=null;if(e.uniformsNames){const o=e;r=o.uniformsNames,a=o.uniformBuffersNames,t=o.samplers,i=o.defines,n=o.maxSimultaneousLights||0}else r=e,t||(t=[]);for(let o=0;o<n&&i["LIGHT"+o];o++)this.PrepareUniformsAndSamplersForLight(o,r,t,i["PROJECTEDLIGHTTEXTURE"+o],a);i.NUM_MORPH_INFLUENCERS&&r.push("morphTargetInfluences"),i.BAKED_VERTEX_ANIMATION_TEXTURE&&(r.push("bakedVertexAnimationSettings"),r.push("bakedVertexAnimationTextureSizeInverted"),r.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))}static HandleFallbacksForShadows(e,t,i=4,n=0){let r=0;for(let a=0;a<i&&e["LIGHT"+a];a++)a>0&&(r=n+a,t.addFallback(r,"LIGHT"+a)),e.SHADOWS||(e["SHADOW"+a]&&t.addFallback(n,"SHADOW"+a),e["SHADOWPCF"+a]&&t.addFallback(n,"SHADOWPCF"+a),e["SHADOWPCSS"+a]&&t.addFallback(n,"SHADOWPCSS"+a),e["SHADOWPOISSON"+a]&&t.addFallback(n,"SHADOWPOISSON"+a),e["SHADOWESM"+a]&&t.addFallback(n,"SHADOWESM"+a),e["SHADOWCLOSEESM"+a]&&t.addFallback(n,"SHADOWCLOSEESM"+a));return r++}static PrepareAttributesForMorphTargetsInfluencers(e,t,i){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=i,this.PrepareAttributesForMorphTargets(e,t,this._TmpMorphInfluencers)}static PrepareAttributesForMorphTargets(e,t,i){const n=i.NUM_MORPH_INFLUENCERS;if(n>0&&Fe.LastCreatedEngine){const r=Fe.LastCreatedEngine.getCaps().maxVertexAttribs,a=t.morphTargetManager;if(a!=null&&a.isUsingTextureForTargets)return;const o=a&&a.supportsNormals&&i.NORMAL,l=a&&a.supportsTangents&&i.TANGENT,c=a&&a.supportsUVs&&i.UV1;for(let u=0;u<n;u++)e.push(C.PositionKind+u),o&&e.push(C.NormalKind+u),l&&e.push(C.TangentKind+u),c&&e.push(C.UVKind+"_"+u),e.length>r&&U.Error("Cannot add more vertex attributes for mesh "+t.name)}}static PrepareAttributesForBakedVertexAnimation(e,t,i){i.BAKED_VERTEX_ANIMATION_TEXTURE&&i.INSTANCES&&e.push("bakedVertexAnimationSettingsInstanced")}static PrepareAttributesForBones(e,t,i,n){i.NUM_BONE_INFLUENCERS>0&&(n.addCPUSkinningFallback(0,t),e.push(C.MatricesIndicesKind),e.push(C.MatricesWeightsKind),i.NUM_BONE_INFLUENCERS>4&&(e.push(C.MatricesIndicesExtraKind),e.push(C.MatricesWeightsExtraKind)))}static PrepareAttributesForInstances(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&this.PushAttributesForInstances(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push(C.ColorInstanceKind)}static PushAttributesForInstances(e,t=!1){e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))}static BindLightProperties(e,t,i){e.transferToEffect(t,i+"")}static BindLight(e,t,i,n,r,a=!0){e._bindLight(t,i,n,r,a)}static BindLights(e,t,i,n,r=4){const a=Math.min(t.lightSources.length,r);for(let o=0;o<a;o++){const l=t.lightSources[o];this.BindLight(l,o,e,i,typeof n=="boolean"?n:n.SPECULARTERM,t.receiveShadows)}}static BindFogParameters(e,t,i,n=!1){e.fogEnabled&&t.applyFog&&e.fogMode!==Le.FOGMODE_NONE&&(i.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),n?(e.fogColor.toLinearSpaceToRef(this._TempFogColor,e.getEngine().useExactSrgbConversions),i.setColor3("vFogColor",this._TempFogColor)):i.setColor3("vFogColor",e.fogColor))}static BindBonesParameters(e,t,i){if(!(!t||!e)&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){const n=e.skeleton;if(n.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){const r=n.getTransformMatrixTexture(e);t.setTexture("boneSampler",r),t.setFloat("boneTextureWidth",4*(n.bones.length+1))}else{const r=n.getTransformMatrices(e);r&&(t.setMatrices("mBones",r),i&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2)&&(i.previousBones[e.uniqueId]||(i.previousBones[e.uniqueId]=r.slice()),t.setMatrices("mPreviousBones",i.previousBones[e.uniqueId]),se._CopyBonesTransformationMatrices(r,i.previousBones[e.uniqueId])))}}}static _CopyBonesTransformationMatrices(e,t){return t.set(e),t}static BindMorphTargetParameters(e,t){const i=e.morphTargetManager;!e||!i||t.setFloatArray("morphTargetInfluences",i.influences)}static BindLogDepth(e,t,i){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf("LOGARITHMICDEPTH")>=0){const n=i.activeCamera;n.mode===Ee.ORTHOGRAPHIC_CAMERA&&U.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(n.maxZ+1)/Math.LN2))}}}se._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0};se._TempFogColor=G.Black();class lr{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){Pe.Clone(()=>e,this)}serialize(){return Pe.Serialize(this)}parse(e,t,i){Pe.Parse(()=>this,e,t,i)}}S([b()],lr.prototype,"func",null);S([b()],lr.prototype,"funcRef",null);S([b()],lr.prototype,"funcMask",null);S([b()],lr.prototype,"opStencilFail",null);S([b()],lr.prototype,"opDepthFail",null);S([b()],lr.prototype,"opStencilDepthPass",null);S([b()],lr.prototype,"mask",null);S([b()],lr.prototype,"enabled",null);var yi;(function(s){s[s.Created=1]="Created",s[s.Disposed=2]="Disposed",s[s.GetDefineNames=4]="GetDefineNames",s[s.PrepareUniformBuffer=8]="PrepareUniformBuffer",s[s.IsReadyForSubMesh=16]="IsReadyForSubMesh",s[s.PrepareDefines=32]="PrepareDefines",s[s.BindForSubMesh=64]="BindForSubMesh",s[s.PrepareEffect=128]="PrepareEffect",s[s.GetAnimatables=256]="GetAnimatables",s[s.GetActiveTextures=512]="GetActiveTextures",s[s.HasTexture=1024]="HasTexture",s[s.FillRenderTargetTextures=2048]="FillRenderTargetTextures",s[s.HasRenderTargetTextures=4096]="HasRenderTargetTextures",s[s.HardBindForSubMesh=8192]="HardBindForSubMesh"})(yi||(yi={}));class z{get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;const t=this._alpha;this._alpha=e,(t===1||e===1)&&this.markAsDirty(z.MiscDirtyFlag+z.PrePassDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(z.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(z.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new O),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new O),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new O),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(z.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(z.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case z.WireFrameFillMode:case z.LineListDrawMode:case z.LineLoopDrawMode:case z.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?z.WireFrameFillMode:z.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case z.PointFillMode:case z.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?z.PointFillMode:z.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(z.MiscDirtyFlag))}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}constructor(e,t,i){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new O,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new lr,this._useUBO=!1,this._fillMode=z.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=e;const n=t||Fe.LastCreatedScene;n&&(this._scene=n,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||q.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new Lr(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._scene.useRightHandedSystem?this.sideOrientation=z.ClockWiseSideOrientation:this.sideOrientation=z.CounterClockWiseSideOrientation,this._uniformBuffer=new le(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),z.OnEventObservable.notifyObservers(this,yi.Created))}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,i){const n=t.materialDefines;return n?(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh):!1}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===z.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _disableAlphaBlending(){return this._transparencyMode===z.MATERIAL_OPAQUE||this._transparencyMode===z.MATERIAL_ALPHATEST}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1}needAlphaBlendingForMesh(e){return e.visibility<1?!0:this._disableAlphaBlending?!1:e.hasVertexAlpha||this.needAlphaBlending()}needAlphaTesting(){return!!this._forceAlphaTest}_shouldTurnAlphaTestOn(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=!1){const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const n of i.subMeshes)n.getMaterial()===this&&n.effect&&(n.effect._wasPreviouslyReady=!1,n.effect._wasPreviouslyUsingInstances=null,n.effect._forceRebindOnNextCall=e);e&&this.markAsDirty(z.AllDirtyFlag)}_preBind(e,t=null){const i=this._scene.getEngine(),r=(t==null?this.sideOrientation:t)===z.ClockWiseSideOrientation;return i.enableEffect(e||this._getDrawWrapper()),i.setState(this.backFaceCulling,this.zOffset,!1,r,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),r}bind(e,t){}buildUniformLayout(){const e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(yi.PrepareUniformBuffer,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,i){const n=i.effect;n&&(this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),n._forceRebindOnNextCall=!1)}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,se.BindSceneUniformBuffer(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),e?this._scene._cachedVisibility=e.visibility:this._scene._cachedVisibility=1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){const i=this._scene.getEngine();this._cachedDepthWriteState=i.getDepthWrite(),i.setDepthWrite(!1)}if(this.disableColorWrite){const i=this._scene.getEngine();this._cachedColorWriteState=i.getColorWrite(),i.setColorWrite(!1)}if(this.depthFunction!==0){const i=this._scene.getEngine();this._cachedDepthFunctionState=i.getDepthFunction()||0,i.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),this.depthFunction!==0&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(yi.GetAnimatables,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(yi.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(yi.HasTexture,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}_clonePlugins(e,t){const i={};if(this._serializePlugins(i),z._parsePlugins(i,e,this._scene,t),this.pluginManager)for(const n of this.pluginManager._plugins){const r=e.pluginManager.getPlugin(n.name);n.copyTo(r)}}getBindedMeshes(){if(this.meshMap){const e=new Array;for(const t in this.meshMap){const i=this.meshMap[t];i&&e.push(i)}return e}else return this._scene.meshes.filter(t=>t.material===this)}forceCompilation(e,t,i,n){const r=Object.assign({clipPlane:!1,useInstances:!1},i),a=this.getScene(),o=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;const l=()=>{if(!this._scene||!this._scene.getEngine())return;const c=a.clipPlane;if(r.clipPlane&&(a.clipPlane=new Zn(0,0,0,1)),this._storeEffectOnSubMeshes){let u=!0,h=null;if(e.subMeshes){const d=new Jn(0,0,0,0,0,e,void 0,!1,!1);d.materialDefines&&(d.materialDefines._renderId=-1),this.isReadyForSubMesh(e,d,r.useInstances)||(d.effect&&d.effect.getCompilationError()&&d.effect.allFallbacksProcessed()?h=d.effect.getCompilationError():(u=!1,setTimeout(l,16)))}u&&(this.allowShaderHotSwapping=o,h&&n&&n(h),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=o,t&&t(this)):setTimeout(l,16);r.clipPlane&&(a.clipPlane=c)};l()}forceCompilationAsync(e,t){return new Promise((i,n)=>{this.forceCompilation(e,()=>{i()},t,r=>{n(r)})})}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(z._DirtyCallbackArray.length=0,e&z.TextureDirtyFlag&&z._DirtyCallbackArray.push(z._TextureDirtyCallBack),e&z.LightDirtyFlag&&z._DirtyCallbackArray.push(z._LightsDirtyCallBack),e&z.FresnelDirtyFlag&&z._DirtyCallbackArray.push(z._FresnelDirtyCallBack),e&z.AttributesDirtyFlag&&z._DirtyCallbackArray.push(z._AttributeDirtyCallBack),e&z.MiscDirtyFlag&&z._DirtyCallbackArray.push(z._MiscDirtyCallBack),e&z.PrePassDirtyFlag&&z._DirtyCallbackArray.push(z._PrePassDirtyCallBack),z._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(z._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){const e=this.getScene().meshes;for(const t of e)if(t.subMeshes)for(const i of t.subMeshes)i.getMaterial()===this&&i.resetDrawCache()}_markAllSubMeshesAsDirty(e){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const t=this.getScene().meshes;for(const i of t)if(i.subMeshes){for(const n of i.subMeshes)if(n.getMaterial(!1)===this)for(const r of n._drawWrappers)!r||!r.defines||!r.defines.markAllAsDirty||this._materialContext===r.materialContext&&e(r.defines)}}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(z._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(z._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(z._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(z._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(z._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(z._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(z._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(z._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(z._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(z._TextureAndMiscDirtyCallBack)}_checkScenePerformancePriority(){if(this._scene.performancePriority!==hs.BackwardCompatible){this.checkReadyOnlyOnce=!0;const e=this._scene.onScenePerformancePriorityChangedObservable.addOnce(()=>{this.checkReadyOnlyOnce=!1});this.onDisposeObservable.add(()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e)})}}setPrePassRenderer(e){return!1}dispose(e,t,i){const n=this.getScene();if(n.stopAnimation(this),n.freeProcessedMaterials(),n.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(yi.Disposed,this._eventInfo),this._parentContainer){const r=this._parentContainer.materials.indexOf(this);r>-1&&this._parentContainer.materials.splice(r,1),this._parentContainer=null}if(i!==!0)if(this.meshMap)for(const r in this.meshMap){const a=this.meshMap[r];a&&(a.material=null,this.releaseVertexArrayObject(a,e))}else{const r=n.meshes;for(const a of r)a.material===this&&!a.sourceMesh&&(a.material=null,this.releaseVertexArrayObject(a,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}releaseVertexArrayObject(e,t){if(e.geometry){const i=e.geometry;if(this._storeEffectOnSubMeshes)for(const n of e.subMeshes)i._releaseVertexArrayObject(n.effect),t&&n.effect&&n.effect.dispose();else i._releaseVertexArrayObject(this._drawWrapper.effect)}}serialize(){const e=Pe.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,this._serializePlugins(e),e}_serializePlugins(e){if(e.plugins={},this.pluginManager)for(const t of this.pluginManager._plugins)e.plugins[t.getClassName()]=t.serialize()}static Parse(e,t,i){if(!e.customType)e.customType="BABYLON.StandardMaterial";else if(e.customType==="BABYLON.PBRMaterial"&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return U.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null;const r=q.Instantiate(e.customType).Parse(e,t,i);return r._loadedUniqueId=e.uniqueId,r}static _parsePlugins(e,t,i,n){var r;if(e.plugins)for(const a in e.plugins){const o=e.plugins[a];let l=(r=t.pluginManager)===null||r===void 0?void 0:r.getPlugin(o.name);if(!l){const c=q.Instantiate("BABYLON."+a);c&&(l=new c(t))}l==null||l.parse(o,i,n)}}}z.TriangleFillMode=0;z.WireFrameFillMode=1;z.PointFillMode=2;z.PointListDrawMode=3;z.LineListDrawMode=4;z.LineLoopDrawMode=5;z.LineStripDrawMode=6;z.TriangleStripDrawMode=7;z.TriangleFanDrawMode=8;z.ClockWiseSideOrientation=0;z.CounterClockWiseSideOrientation=1;z.TextureDirtyFlag=1;z.LightDirtyFlag=2;z.FresnelDirtyFlag=4;z.AttributesDirtyFlag=8;z.MiscDirtyFlag=16;z.PrePassDirtyFlag=32;z.AllDirtyFlag=63;z.MATERIAL_OPAQUE=0;z.MATERIAL_ALPHATEST=1;z.MATERIAL_ALPHABLEND=2;z.MATERIAL_ALPHATESTANDBLEND=3;z.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0;z.MATERIAL_NORMALBLENDMETHOD_RNM=1;z.OnEventObservable=new O;z._AllDirtyCallBack=s=>s.markAllAsDirty();z._ImageProcessingDirtyCallBack=s=>s.markAsImageProcessingDirty();z._TextureDirtyCallBack=s=>s.markAsTexturesDirty();z._FresnelDirtyCallBack=s=>s.markAsFresnelDirty();z._MiscDirtyCallBack=s=>s.markAsMiscDirty();z._PrePassDirtyCallBack=s=>s.markAsPrePassDirty();z._LightsDirtyCallBack=s=>s.markAsLightDirty();z._AttributeDirtyCallBack=s=>s.markAsAttributesDirty();z._FresnelAndMiscDirtyCallBack=s=>{z._FresnelDirtyCallBack(s),z._MiscDirtyCallBack(s)};z._TextureAndMiscDirtyCallBack=s=>{z._TextureDirtyCallBack(s),z._MiscDirtyCallBack(s)};z._DirtyCallbackArray=[];z._RunDirtyCallBacks=s=>{for(const e of z._DirtyCallbackArray)e(s)};S([b()],z.prototype,"id",void 0);S([b()],z.prototype,"uniqueId",void 0);S([b()],z.prototype,"name",void 0);S([b()],z.prototype,"metadata",void 0);S([b()],z.prototype,"checkReadyOnEveryCall",void 0);S([b()],z.prototype,"checkReadyOnlyOnce",void 0);S([b()],z.prototype,"state",void 0);S([b("alpha")],z.prototype,"_alpha",void 0);S([b("backFaceCulling")],z.prototype,"_backFaceCulling",void 0);S([b("cullBackFaces")],z.prototype,"_cullBackFaces",void 0);S([b()],z.prototype,"sideOrientation",void 0);S([b("alphaMode")],z.prototype,"_alphaMode",void 0);S([b()],z.prototype,"_needDepthPrePass",void 0);S([b()],z.prototype,"disableDepthWrite",void 0);S([b()],z.prototype,"disableColorWrite",void 0);S([b()],z.prototype,"forceDepthWrite",void 0);S([b()],z.prototype,"depthFunction",void 0);S([b()],z.prototype,"separateCullingPass",void 0);S([b("fogEnabled")],z.prototype,"_fogEnabled",void 0);S([b()],z.prototype,"pointSize",void 0);S([b()],z.prototype,"zOffset",void 0);S([b()],z.prototype,"zOffsetUnits",void 0);S([b()],z.prototype,"pointsCloud",null);S([b()],z.prototype,"fillMode",null);S([b()],z.prototype,"transparencyMode",null);const oS="postprocessVertexShader",lS=`attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;Q.ShadersStore[oS]=lS;class cS{get depthStencilTexture(){return this._depthStencilTexture}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get size(){return this.width}get width(){return this._size.width||this._size}get height(){return this._size.height||this._size}get layers(){return this._size.layers||0}get texture(){var e,t;return(t=(e=this._textures)===null||e===void 0?void 0:e[0])!==null&&t!==void 0?t:null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}get samples(){return this._samples}setSamples(e,t=!0,i=!1){if(this.samples===e&&!i)return e;const n=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,n}constructor(e,t,i,n){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=e,this._isCube=t,this._size=i,this._engine=n,this._depthStencilTexture=null}setTextures(e){Array.isArray(e)?this._textures=e:e?this._textures=[e]:this._textures=null}setTexture(e,t=0,i=!0){this._textures||(this._textures=[]),this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e}setLayerAndFaceIndices(e,t){this._layerIndices=e,this._faceIndices=t}setLayerAndFaceIndex(e=0,t,i){this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),t!==void 0&&t>=0&&(this._layerIndices[e]=t),i!==void 0&&i>=0&&(this._faceIndices[e]=i)}createDepthStencilTexture(e=0,t=!0,i=!1,n=1,r=14,a){var o;return(o=this._depthStencilTexture)===null||o===void 0||o.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:n,depthTextureFormat:r,label:a},this),this._depthStencilTexture}_shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){var e,t,i,n,r,a,o,l;let c=null;if(this._isMulti){const u=this.textures;if(u&&u.length>0){let h=!1,d=u.length;const f=u[u.length-1]._source;(f===Pt.Depth||f===Pt.DepthStencil)&&(h=!0,d--);const p=[],m=[],_=[],E=[],v=[],y=[],A=[],I={};for(let x=0;x<d;++x){const F=u[x];p.push(F.samplingMode),m.push(F.type),_.push(F.format),I[F.uniqueId]!==void 0?(E.push(-1),A.push(0)):(I[F.uniqueId]=x,F.is2DArray?(E.push(35866),A.push(F.depth)):F.isCube?(E.push(34067),A.push(0)):F.is3D?(E.push(32879),A.push(F.depth)):(E.push(3553),A.push(0))),this._faceIndices&&v.push((e=this._faceIndices[x])!==null&&e!==void 0?e:0),this._layerIndices&&y.push((t=this._layerIndices[x])!==null&&t!==void 0?t:0)}const T={samplingModes:p,generateMipMaps:u[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:h,types:m,formats:_,textureCount:d,targetTypes:E,faceIndex:v,layerIndex:y,layerCounts:A},R={width:this.width,height:this.height};c=this._engine.createMultipleRenderTarget(R,T);for(let x=0;x<d;++x){if(E[x]!==-1)continue;const F=I[u[x].uniqueId];c.setTexture(c.textures[F],x)}}}else{const u={};if(u.generateDepthBuffer=this._generateDepthBuffer,u.generateMipMaps=(n=(i=this.texture)===null||i===void 0?void 0:i.generateMipMaps)!==null&&n!==void 0?n:!1,u.generateStencilBuffer=this._generateStencilBuffer,u.samplingMode=(r=this.texture)===null||r===void 0?void 0:r.samplingMode,u.type=(a=this.texture)===null||a===void 0?void 0:a.type,u.format=(o=this.texture)===null||o===void 0?void 0:o.format,this.isCube)c=this._engine.createRenderTargetCubeTexture(this.width,u);else{const h={width:this.width,height:this.height,layers:this.is2DArray?(l=this.texture)===null||l===void 0?void 0:l.depth:void 0};c=this._engine.createRenderTargetTexture(h,u)}c.texture.isReady=!0}return c}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){const t=this._depthStencilTexture.samplingMode,i=t===2||t===3||t===11;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,i,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){var e,t;if(this._textures)for(let i=0;(t=i<((e=this._textures)===null||e===void 0?void 0:e.length))!==null&&t!==void 0&&t;++i)this._textures[i].dispose();this._textures=null}dispose(e=!1){var t;e||((t=this._depthStencilTexture)===null||t===void 0||t.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}class uS extends cS{constructor(e,t,i,n,r){super(e,t,i,n),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._context=r}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}_shareDepth(e){super._shareDepth(e);const t=this._context,i=this._depthStencilBuffer,n=e._MSAAFramebuffer||e._framebuffer;e._depthStencilBuffer&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=this._depthStencilBuffer,this._engine._bindUnboundFramebuffer(n),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,i),this._engine._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,i,n=0){var r,a,o,l;if(!e._hardwareTexture)return;const c=this._framebuffer,u=this._engine._currentFramebuffer;if(this._engine._bindUnboundFramebuffer(c),this._engine.webGLVersion>1){const h=this._context,d=h["COLOR_ATTACHMENT"+t];e.is2DArray||e.is3D?(i=(a=i!=null?i:(r=this.layerIndices)===null||r===void 0?void 0:r[t])!==null&&a!==void 0?a:0,h.framebufferTextureLayer(h.FRAMEBUFFER,d,e._hardwareTexture.underlyingResource,n,i)):e.isCube?(i=(l=i!=null?i:(o=this.faceIndices)===null||o===void 0?void 0:o[t])!==null&&l!==void 0?l:0,h.framebufferTexture2D(h.FRAMEBUFFER,d,h.TEXTURE_CUBE_MAP_POSITIVE_X+i,e._hardwareTexture.underlyingResource,n)):h.framebufferTexture2D(h.FRAMEBUFFER,d,h.TEXTURE_2D,e._hardwareTexture.underlyingResource,n)}else{const h=this._context,d=h["COLOR_ATTACHMENT"+t+"_WEBGL"],f=i!==void 0?h.TEXTURE_CUBE_MAP_POSITIVE_X+i:h.TEXTURE_2D;h.framebufferTexture2D(h.FRAMEBUFFER,d,f,e._hardwareTexture.underlyingResource,n)}this._engine._bindUnboundFramebuffer(u)}setTexture(e,t=0,i=!0){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t)}setLayerAndFaceIndices(e,t){var i,n;if(super.setLayerAndFaceIndices(e,t),!this.textures||!this.layerIndices||!this.faceIndices)return;const r=(n=(i=this._attachments)===null||i===void 0?void 0:i.length)!==null&&n!==void 0?n:this.textures.length;for(let a=0;a<r;a++){const o=this.textures[a];o&&(o.is2DArray||o.is3D?this._bindTextureRenderTarget(o,a,this.layerIndices[a]):o.isCube?this._bindTextureRenderTarget(o,a,this.faceIndices[a]):this._bindTextureRenderTarget(o,a))}}setLayerAndFaceIndex(e=0,t,i){if(super.setLayerAndFaceIndex(e,t,i),!this.textures||!this.layerIndices||!this.faceIndices)return;const n=this.textures[e];n.is2DArray||n.is3D?this._bindTextureRenderTarget(this.textures[e],e,this.layerIndices[e]):n.isCube&&this._bindTextureRenderTarget(this.textures[e],e,this.faceIndices[e])}dispose(e=this._disposeOnlyFramebuffers){const t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}_e.prototype._createHardwareRenderTargetWrapper=function(s,e,t){const i=new uS(s,e,t,this,this._gl);return this._renderTargetWrapperCache.push(i),i};_e.prototype.createRenderTargetTexture=function(s,e){var t,i;const n=this._createHardwareRenderTargetWrapper(!1,!1,s);let r=!0,a=!1,o=!1,l,c=1;e!==void 0&&typeof e=="object"&&(r=(t=e.generateDepthBuffer)!==null&&t!==void 0?t:!0,a=!!e.generateStencilBuffer,o=!!e.noColorAttachment,l=e.colorAttachment,c=(i=e.samples)!==null&&i!==void 0?i:1);const u=l||(o?null:this._createInternalTexture(s,e,!0,Pt.RenderTarget)),h=s.width||s,d=s.height||s,f=this._currentFramebuffer,p=this._gl,m=p.createFramebuffer();return this._bindUnboundFramebuffer(m),n._depthStencilBuffer=this._setupFramebufferDepthAttachments(a,r,h,d),u&&!u.is2DArray&&p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,u._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(f),n._framebuffer=m,n._generateDepthBuffer=r,n._generateStencilBuffer=a,n.setTextures(u),this.updateRenderTargetTextureSampleCount(n,c),n};_e.prototype.createDepthStencilTexture=function(s,e,t){if(e.isCube){const i=s.width||s;return this._createDepthStencilCubeTexture(i,e,t)}else return this._createDepthStencilTexture(s,e,t)};_e.prototype._createDepthStencilTexture=function(s,e,t){const i=this._gl,n=s.layers||0,r=n!==0?i.TEXTURE_2D_ARRAY:i.TEXTURE_2D,a=new dn(this,Pt.DepthStencil);if(!this._caps.depthTextureExtension)return U.Error("Depth texture is not supported by your browser or hardware."),a;const o=Object.assign({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},e);if(this._bindTextureDirectly(r,a,!0),this._setupDepthStencilTexture(a,s,o.generateStencil,o.comparisonFunction===0?!1:o.bilinearFiltering,o.comparisonFunction,o.samples),o.depthTextureFormat!==void 0){if(o.depthTextureFormat!==15&&o.depthTextureFormat!==16&&o.depthTextureFormat!==17&&o.depthTextureFormat!==13&&o.depthTextureFormat!==14&&o.depthTextureFormat!==18)return U.Error("Depth texture format is not supported."),a;a.format=o.depthTextureFormat}else a.format=o.generateStencil?13:16;const l=a.format===17||a.format===13||a.format===18;t._depthStencilTexture=a,t._depthStencilTextureWithStencil=l;let c=i.UNSIGNED_INT;a.format===15?c=i.UNSIGNED_SHORT:a.format===17||a.format===13?c=i.UNSIGNED_INT_24_8:a.format===14?c=i.FLOAT:a.format===18&&(c=i.FLOAT_32_UNSIGNED_INT_24_8_REV);const u=l?i.DEPTH_STENCIL:i.DEPTH_COMPONENT;let h=u;this.webGLVersion>1&&(a.format===15?h=i.DEPTH_COMPONENT16:a.format===16?h=i.DEPTH_COMPONENT24:a.format===17||a.format===13?h=i.DEPTH24_STENCIL8:a.format===14?h=i.DEPTH_COMPONENT32F:a.format===18&&(h=i.DEPTH32F_STENCIL8)),a.is2DArray?i.texImage3D(r,0,h,a.width,a.height,n,0,u,c,null):i.texImage2D(r,0,h,a.width,a.height,0,u,c,null),this._bindTextureDirectly(r,null),this._internalTexturesCache.push(a);const d=t;if(d._depthStencilBuffer){const f=this._currentFramebuffer;this._bindUnboundFramebuffer(d._framebuffer),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,null),this._bindUnboundFramebuffer(f),i.deleteRenderbuffer(d._depthStencilBuffer),d._depthStencilBuffer=null}return a};_e.prototype.updateRenderTargetTextureSampleCount=function(s,e){if(this.webGLVersion<2||!s||!s.texture)return 1;if(s.samples===e)return e;const t=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),s._depthStencilBuffer&&(t.deleteRenderbuffer(s._depthStencilBuffer),s._depthStencilBuffer=null),s._MSAAFramebuffer&&(t.deleteFramebuffer(s._MSAAFramebuffer),s._MSAAFramebuffer=null);const i=s.texture._hardwareTexture;if(i.releaseMSAARenderBuffers(),e>1&&typeof t.renderbufferStorageMultisample=="function"){const n=t.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");s._MSAAFramebuffer=n,this._bindUnboundFramebuffer(s._MSAAFramebuffer);const r=this._createRenderBuffer(s.texture.width,s.texture.height,e,-1,this._getRGBAMultiSampleBufferFormat(s.texture.type),t.COLOR_ATTACHMENT0,!1);if(!r)throw new Error("Unable to create multi sampled framebuffer");i.addMSAARenderBuffer(r)}else this._bindUnboundFramebuffer(s._framebuffer);return s.texture.samples=e,s._samples=e,s._depthStencilBuffer=this._setupFramebufferDepthAttachments(s._generateStencilBuffer,s._generateDepthBuffer,s.texture.width,s.texture.height,e),this._bindUnboundFramebuffer(null),e};class Dt{static RegisterShaderCodeProcessing(e,t){if(!t){delete Dt._CustomShaderCodeProcessing[e!=null?e:""];return}Dt._CustomShaderCodeProcessing[e!=null?e:""]=t}static _GetShaderCodeProcessing(e){var t;return(t=Dt._CustomShaderCodeProcessing[e])!==null&&t!==void 0?t:Dt._CustomShaderCodeProcessing[""]}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(t=>{t.setSamples(this._samples)})}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,i,n,r,a,o=1,l,c,u=null,h=0,d="postprocess",f,p=!1,m=5,_=Ai.GLSL){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.alphaMode=0,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new Mi(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new j(1,1),this._texelSize=j.Zero(),this.onActivateObservable=new O,this.onSizeChangedObservable=new O,this.onApplyObservable=new O,this.onBeforeRenderObservable=new O,this.onAfterRenderObservable=new O,this.name=e,a!=null?(this._camera=a,this._scene=a.getScene(),a.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):l&&(this._engine=l,this._engine.postProcesses.push(this)),this._options=r,this.renderTargetSamplingMode=o||1,this._reusable=c||!1,this._textureType=h,this._textureFormat=m,this._shaderLanguage=_,this._samplers=n||[],this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=d,this._parameters=i||[],this._parameters.push("scale"),this._indexParameters=f,this._drawWrapper=new Lr(this._engine),p||this.updateEffect(u)}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){this._textures.length==0&&(this._textures=new Mi(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,i=null,n,r,a,o,l){var c,u;const h=Dt._GetShaderCodeProcessing(this.name);if(h!=null&&h.defineCustomBindings){const d=(c=t==null?void 0:t.slice())!==null&&c!==void 0?c:[];d.push(...this._parameters);const f=(u=i==null?void 0:i.slice())!==null&&u!==void 0?u:[];f.push(...this._samplers),e=h.defineCustomBindings(this.name,e,d,f),t=d,i=f}this._postProcessDefines=e,this._drawWrapper.effect=this._engine.createEffect({vertex:o!=null?o:this._vertexUrl,fragment:l!=null?l:this._fragmentUrl},{attributes:["position"],uniformsNames:t||this._parameters,uniformBuffersNames:[],samplers:i||this._samplers,defines:e!==null?e:"",fallbacks:null,onCompiled:r!=null?r:null,onError:a!=null?a:null,indexParameters:n||this._indexParameters,processCodeAfterIncludes:h!=null&&h.processCodeAfterIncludes?(d,f)=>h.processCodeAfterIncludes(this.name,d,f):null,processFinalCode:h!=null&&h.processFinalCode?(d,f)=>h.processFinalCode(this.name,d,f):null,shaderLanguage:this._shaderLanguage},this._engine)}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,i=0){for(let r=0;r<this._textureCache.length;r++)if(this._textureCache[r].texture.width===e.width&&this._textureCache[r].texture.height===e.height&&this._textureCache[r].postProcessChannel===i&&this._textureCache[r].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[r].texture.samples===t.samples)return this._textureCache[r].texture;const n=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:n,postProcessChannel:i,lastUsedRenderId:-1}),n}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let i=!1;for(let n=0;n<this._textures.length;n++)if(this._textures.data[n]===this._textureCache[t].texture){i=!0;break}i||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}_resize(e,t,i,n,r){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let a=null;for(let c=0;c<i._postProcesses.length;c++)if(i._postProcesses[c]!==null){a=i._postProcesses[c];break}const o={width:this.width,height:this.height},l={generateMipMaps:n,generateDepthBuffer:r||a===this,generateStencilBuffer:(r||a===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(o,l,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(o,l,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}activate(e,t=null,i){var n,r;e=e||this._camera;const a=e.getScene(),o=a.getEngine(),l=o.getCaps().maxTextureSize;let c=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0;const u=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0,h=e.parent;h&&(h.leftCamera==e||h.rightCamera==e)&&(c/=2);let d=this._options.width||c,f=this._options.height||u;const p=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const _=o.currentViewport;_&&(d*=_.width,f*=_.height)}(p||this.alwaysForcePOT)&&(this._options.width||(d=o.needPOTTextures?k.GetExponentOfTwo(d,l,this.scaleMode):d),this._options.height||(f=o.needPOTTextures?k.GetExponentOfTwo(f,l,this.scaleMode):f)),(this.width!==d||this.height!==f)&&this._resize(d,f,e,p,i),this._textures.forEach(_=>{_.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(_,this.samples)}),this._flushTextureCache(),this._renderId++}let m;if(this._shareOutputWithPostProcess)m=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)m=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{m=this.inputTexture;let _;for(let E=0;E<this._textureCache.length;E++)if(this._textureCache[E].texture===m){_=this._textureCache[E];break}_&&(_.lastUsedRenderId=this._renderId)}return this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(c/d,u/f),this._engine.bindFramebuffer(m,0,c,u,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(m,0,void 0,void 0,this.forceFullscreenViewport)),(r=(n=this._engine)._debugInsertMarker)===null||r===void 0||r.call(n,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(e),this.autoClear&&(this.alphaMode===0||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:a.clearColor,a._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),m}get isSupported(){return this._drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){var e,t;return(t=(e=this._drawWrapper.effect)===null||e===void 0?void 0:e.isReady())!==null&&t!==void 0?t:!1}apply(){var e,t,i;if(!(!((e=this._drawWrapper.effect)===null||e===void 0)&&e.isReady()))return null;this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);let n;return this._shareOutputWithPostProcess?n=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?n=this._forcedOutputTexture:n=this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",n==null?void 0:n.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),(i=(t=Dt._GetShaderCodeProcessing(this.name))===null||t===void 0?void 0:t.bindCustomBindings)===null||i===void 0||i.call(t,this.name,this._drawWrapper.effect),this._drawWrapper.effect}_disposeTextures(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1}dispose(e){e=e||this._camera,this._disposeTextures();let t;if(this._scene&&(t=this._scene.postProcesses.indexOf(this),t!==-1&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const i=this._parentContainer.postProcesses.indexOf(this);i>-1&&this._parentContainer.postProcesses.splice(i,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),t!==-1&&this._engine.postProcesses.splice(t,1),!!e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),t===0&&e._postProcesses.length>0){const i=this._camera._getFirstPostProcess();i&&i.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}}serialize(){const e=Pe.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=Dt.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,i){const n=hn(e.customType);if(!n||!n._Parse)return null;const r=t?t.getCameraById(e.cameraId):null;return n._Parse(e,r,t,i)}static _Parse(e,t,i,n){return Pe.Parse(()=>new Dt(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,i,n)}}Dt._CustomShaderCodeProcessing={};S([b()],Dt.prototype,"uniqueId",void 0);S([b()],Dt.prototype,"name",void 0);S([b()],Dt.prototype,"width",void 0);S([b()],Dt.prototype,"height",void 0);S([b()],Dt.prototype,"renderTargetSamplingMode",void 0);S([EE()],Dt.prototype,"clearColor",void 0);S([b()],Dt.prototype,"autoClear",void 0);S([b()],Dt.prototype,"forceAutoClearInAlphaMode",void 0);S([b()],Dt.prototype,"alphaMode",void 0);S([b()],Dt.prototype,"alphaConstants",void 0);S([b()],Dt.prototype,"enablePixelPerfectMode",void 0);S([b()],Dt.prototype,"forceFullscreenViewport",void 0);S([b()],Dt.prototype,"scaleMode",void 0);S([b()],Dt.prototype,"alwaysForcePOT",void 0);S([b("samples")],Dt.prototype,"_samples",void 0);S([b()],Dt.prototype,"adaptScaleToCurrentViewport",void 0);Rt("BABYLON.PostProcess",Dt);const hS="helperFunctions",dS=`const float PI=3.1415926535897932384626433832795;const float HALF_MIN=5.96046448e-08; 
const float LinearEncodePowerApprox=2.2;const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);const float Epsilon=0.0000001;
#define saturate(x) clamp(x,0.0,1.0)
#define absEps(x) abs(x)+Epsilon
#define maxEps(x) max(x,Epsilon)
#define saturateEps(x) clamp(x,Epsilon,1.0)
mat3 transposeMat3(mat3 inMatrix) {vec3 i0=inMatrix[0];vec3 i1=inMatrix[1];vec3 i2=inMatrix[2];mat3 outMatrix=mat3(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);return outMatrix;}
mat3 inverseMat3(mat3 inMatrix) {float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),
b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),
b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}
#if USE_EXACT_SRGB_CONVERSIONS
vec3 toLinearSpaceExact(vec3 color)
{vec3 nearZeroSection=0.0773993808*color;vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));
#else
return
vec3(
color.r<=0.04045 ? nearZeroSection.r : remainingSection.r,
color.g<=0.04045 ? nearZeroSection.g : remainingSection.g,
color.b<=0.04045 ? nearZeroSection.b : remainingSection.b);
#endif
}
vec3 toGammaSpaceExact(vec3 color)
{vec3 nearZeroSection=12.92*color;vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));
#else
return
vec3(
color.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,
color.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,
color.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);
#endif
}
#endif
float toLinearSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=0.0773993808*color;float remainingSection=pow(0.947867299*(color+0.055),2.4);return color<=0.04045 ? nearZeroSection : remainingSection;
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
vec3 toLinearSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3(LinearEncodePowerApprox));
#endif
}
vec4 toLinearSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);
#endif
}
float toGammaSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=12.92*color;float remainingSection=1.055*pow(color,0.41666)-0.055;return color<=0.0031308 ? nearZeroSection : remainingSection;
#else
return pow(color,GammaEncodePowerApprox);
#endif
}
vec3 toGammaSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3(GammaEncodePowerApprox));
#endif
}
vec4 toGammaSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);
#endif
}
float square(float value)
{return value*value;}
vec3 square(vec3 value)
{return value*value;}
float pow5(float value) {float sq=value*value;return sq*sq*value;}
float getLuminance(vec3 color)
{return clamp(dot(color,LuminanceEncodeApprox),0.,1.);}
float getRand(vec2 seed) {return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);}
float dither(vec2 seed,float varianceAmount) {float rand=getRand(seed);float normVariance=varianceAmount/255.0;float dither=mix(-normVariance,normVariance,rand);return dither;}
const float rgbdMaxRange=255.0;vec4 toRGBD(vec3 color) {float maxRGB=maxEps(max(color.r,max(color.g,color.b)));float D =max(rgbdMaxRange/maxRGB,1.);D =clamp(floor(D)/255.0,0.,1.);vec3 rgb=color.rgb*D;rgb=toGammaSpace(rgb);return vec4(clamp(rgb,0.,1.),D); }
vec3 fromRGBD(vec4 rgbd) {rgbd.rgb=toLinearSpace(rgbd.rgb);return rgbd.rgb/rgbd.a;}
vec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {vec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;vec3 halfSize=cubeSize*0.5;vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);vec3 intersectPositionWS=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}
`;Q.IncludesShadersStore[hS]=dS;const fS="rgbdDecodePixelShader",pS=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);}`;Q.ShadersStore[fS]=pS;_e.prototype.createRenderTargetCubeTexture=function(s,e){const t=this._createHardwareRenderTargetWrapper(!1,!0,s),i=Object.assign({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5},e);i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,(i.type===1&&!this._caps.textureFloatLinearFiltering||i.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(i.samplingMode=1);const n=this._gl,r=new dn(this,Pt.RenderTarget);this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,r,!0);const a=this._getSamplingParameters(i.samplingMode,i.generateMipMaps);i.type===1&&!this._caps.textureFloat&&(i.type=0,U.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MAG_FILTER,a.mag),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MIN_FILTER,a.min),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);for(let l=0;l<6;l++)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,this._getRGBABufferInternalSizedFormat(i.type,i.format),s,s,0,this._getInternalFormat(i.format),this._getWebGLTextureType(i.type),null);const o=n.createFramebuffer();return this._bindUnboundFramebuffer(o),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(i.generateStencilBuffer,i.generateDepthBuffer,s,s),i.generateMipMaps&&n.generateMipmap(n.TEXTURE_CUBE_MAP),this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),t._framebuffer=o,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer,r.width=s,r.height=s,r.isReady=!0,r.isCube=!0,r.samples=1,r.generateMipMaps=i.generateMipMaps,r.samplingMode=i.samplingMode,r.type=i.type,r.format=i.format,this._internalTexturesCache.push(r),t.setTextures(r),t};const Yh={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class xE{constructor(e,t=Yh){var i,n;this._fullscreenViewport=new Ll(0,0,1,1);const r=(i=t.positions)!==null&&i!==void 0?i:Yh.positions,a=(n=t.indices)!==null&&n!==void 0?n:Yh.indices;this.engine=e,this._vertexBuffers={[C.PositionKind]:new C(e,r,C.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(a),this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{this._indexBuffer=e.createIndexBuffer(a);for(const o in this._vertexBuffers)this._vertexBuffers[o]._rebuild()})}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e._drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return e.renderTarget!==void 0}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();const i=t===null?null:this._isRenderTargetTexture(t)?t.renderTarget:t;i&&this.engine.bindFramebuffer(i),this.applyEffectWrapper(e),this.draw(),i&&this.engine.unBindFramebuffer(i),this.restoreStates()}dispose(){const e=this._vertexBuffers[C.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[C.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class ME{get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){this.onApplyObservable=new O;let t;const i=e.uniformNames||[];e.vertexShader?t={fragmentSource:e.fragmentShader,vertexSource:e.vertexShader,spectorName:e.name||"effectWrapper"}:(i.push("scale"),t={fragmentSource:e.fragmentShader,vertex:"postprocess",spectorName:e.name||"effectWrapper"},this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)}));const n=e.defines?e.defines.join(`
`):"";this._drawWrapper=new Lr(e.engine),e.useShaderStore?(t.fragment=t.fragmentSource,t.vertex||(t.vertex=t.vertexSource),delete t.fragmentSource,delete t.vertexSource,this.effect=e.engine.createEffect(t,e.attributeNames||["position"],i,e.samplerNames,n,void 0,e.onCompiled,void 0,void 0,e.shaderLanguage)):(this.effect=new bi(t,e.attributeNames||["position"],i,e.samplerNames,e.engine,n,void 0,e.onCompiled,void 0,void 0,void 0,e.shaderLanguage),this._onContextRestoredObserver=e.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._wasPreviouslyReady=!1,this.effect._prepareEffect()}))}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.effect.dispose()}}const PE="passPixelShader",DE=`varying vec2 vUV;uniform sampler2D textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=texture2D(textureSampler,vUV);}`;Q.ShadersStore[PE]=DE;const W_={name:PE,shader:DE};class Yi{static _CreateDumpRenderer(){if(!Yi._DumpToolsEngine){let e=new OffscreenCanvas(100,100),t=null;const i={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1};try{t=new _e(e,!1,i)}catch(a){e=document.createElement("canvas"),t=new _e(e,!1,i)}t.getCaps().parallelShaderCompile=void 0;const n=new xE(t),r=new ME({engine:t,name:W_.name,fragmentShader:W_.shader,samplerNames:["textureSampler"]});Yi._DumpToolsEngine={canvas:e,engine:t,renderer:n,wrapper:r}}return Yi._DumpToolsEngine}static DumpFramebuffer(e,t,i,n,r="image/png",a,o){return Ie(this,null,function*(){const l=yield i.readPixels(0,0,e,t),c=new Uint8Array(l.buffer);Yi.DumpData(e,t,c,n,r,a,!0,void 0,o)})}static DumpDataAsync(e,t,i,n="image/png",r,a=!1,o=!1,l){return new Promise(c=>{Yi.DumpData(e,t,i,u=>c(u),n,r,a,o,l)})}static DumpData(e,t,i,n,r="image/png",a,o=!1,l=!1,c){const u=Yi._CreateDumpRenderer();if(u.engine.setSize(e,t,!0),i instanceof Float32Array){const d=new Uint8Array(i.length);let f=i.length;for(;f--;){const p=i[f];d[f]=Math.round(W.Clamp(p)*255)}i=d}const h=u.engine.createRawTexture(i,e,t,5,!1,!o,1);u.renderer.setViewport(),u.renderer.applyEffectWrapper(u.wrapper),u.wrapper.effect._bindTexture("textureSampler",h),u.renderer.draw(),l?q.ToBlob(u.canvas,d=>{const f=new FileReader;f.onload=p=>{const m=p.target.result;n&&n(m)},f.readAsArrayBuffer(d)},r,c):q.EncodeScreenshotCanvasData(u.canvas,n,r,a,c),h.dispose()}static Dispose(){Yi._DumpToolsEngine&&(Yi._DumpToolsEngine.wrapper.dispose(),Yi._DumpToolsEngine.renderer.dispose(),Yi._DumpToolsEngine.engine.dispose()),Yi._DumpToolsEngine=null}}const mS=()=>{q.DumpData=Yi.DumpData,q.DumpDataAsync=Yi.DumpDataAsync,q.DumpFramebuffer=Yi.DumpFramebuffer};mS();class er extends H{get renderList(){return this._renderList}set renderList(e){this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=aE(e,this._renderListHasChanged)),this._renderList=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(e,t){let i;Array.isArray(e)?i=e:i=[e];for(let n=0;n<i.length;++n)for(let r=0;r<this._renderPassIds.length;++r)i[n].setMaterialForRenderPass(this._renderPassIds[r],t!==void 0?Array.isArray(t)?t[r]:t:void 0)}get isMulti(){var e,t;return(t=(e=this._renderTarget)===null||e===void 0?void 0:e.isMulti)!==null&&t!==void 0?t:!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var e,t;return(t=(e=this._renderTarget)===null||e===void 0?void 0:e._depthStencilTexture)!==null&&t!==void 0?t:null}constructor(e,t,i,n=!1,r=!0,a=0,o=!1,l=H.TRILINEAR_SAMPLINGMODE,c=!0,u=!1,h=!1,d=5,f=!1,p,m,_=!1,E=!1){var v,y,A,I,T,R;let x;if(typeof n=="object"){const L=n;n=!!L.generateMipMaps,r=(v=L.doNotChangeAspectRatio)!==null&&v!==void 0?v:!0,a=(y=L.type)!==null&&y!==void 0?y:0,o=!!L.isCube,l=(A=L.samplingMode)!==null&&A!==void 0?A:H.TRILINEAR_SAMPLINGMODE,c=(I=L.generateDepthBuffer)!==null&&I!==void 0?I:!0,u=!!L.generateStencilBuffer,h=!!L.isMulti,d=(T=L.format)!==null&&T!==void 0?T:5,f=!!L.delayAllocation,p=L.samples,m=L.creationFlags,_=!!L.noColorAttachment,E=!!L.useSRGBBuffer,x=L.colorAttachment}if(super(null,i,!n,void 0,l,void 0,void 0,void 0,void 0,d),this._unObserveRenderList=null,this._renderListHasChanged=(L,V)=>{var Z;const ne=this._renderList?this._renderList.length:0;(V===0&&ne>0||ne===0)&&((Z=this.getScene())===null||Z===void 0||Z.meshes.forEach(ae=>{ae._markSubMeshesAsLightDirty()}))},this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new O,this.onAfterUnbindObservable=new O,this.onBeforeRenderObservable=new O,this.onAfterRenderObservable=new O,this.onClearObservable=new O,this.onResizeObservable=new O,this._cleared=!1,this.skipInitialClear=!1,this._currentRefreshId=-1,this._refreshRate=1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=g.Zero(),i=this.getScene(),!i)return;const F=this.getScene().getEngine();this._coordinatesMode=H.PROJECTION_MODE,this.renderList=new Array,this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._renderPassIds=[],this._isCubeData=o,this._processSizeParameter(t),this.renderPassId=this._renderPassIds[0],this._resizeObserver=F.onResizeObservable.add(()=>{}),this._generateMipMaps=!!n,this._doNotChangeAspectRatio=r,this._renderingManager=new Oi(i),this._renderingManager._useSceneAutoClearSetup=!0,!h&&(this._renderTargetOptions={generateMipMaps:n,type:a,format:(R=this._format)!==null&&R!==void 0?R:void 0,samplingMode:this.samplingMode,generateDepthBuffer:c,generateStencilBuffer:u,samples:p,creationFlags:m,noColorAttachment:_,useSRGBBuffer:E,colorAttachment:x,label:this.name},this.samplingMode===H.NEAREST_SAMPLINGMODE&&(this.wrapU=H.CLAMP_ADDRESSMODE,this.wrapV=H.CLAMP_ADDRESSMODE),f||(o?(this._renderTarget=i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=H.INVCUBIC_MODE,this._textureMatrix=D.Identity()):this._renderTarget=i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,p!==void 0&&(this.samples=p)))}createDepthStencilTexture(e=0,t=!0,i=!1,n=1,r=14){var a;(a=this._renderTarget)===null||a===void 0||a.createDepthStencilTexture(e,t,i,n,r)}_releaseRenderPassId(){if(this._scene){const e=this._scene.getEngine();for(let t=0;t<this._renderPassIds.length;++t)e.releaseRenderPassId(this._renderPassIds[t])}this._renderPassIds=[]}_createRenderPassId(){this._releaseRenderPassId();const e=this._scene.getEngine(),t=this._isCubeData?6:this.getRenderLayers()||1;for(let i=0;i<t;++i)this._renderPassIds[i]=e.createRenderPassId(`RenderTargetTexture - ${this.name}#${i}`)}_processSizeParameter(e,t=!0){if(e.ratio){this._sizeRatio=e.ratio;const i=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(i.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(i.getRenderHeight(),this._sizeRatio)}}else this._size=e;t&&this._createRenderPassId()}get samples(){var e,t;return(t=(e=this._renderTarget)===null||e===void 0?void 0:e.samples)!==null&&t!==void 0?t:this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}addPostProcess(e){if(!this._postProcessManager){const t=this.getScene();if(!t)return;this._postProcessManager=new sf(t),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(const t of this._postProcesses)t.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;const t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}_shouldRender(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const e=this._size.layers;return e||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){const t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){var t;const i=this.isCube;(t=this._renderTarget)===null||t===void 0||t.dispose(),this._renderTarget=null;const n=this.getScene();n&&(this._processSizeParameter(e,!1),i?this._renderTarget=n.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=n.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){return this._render(!1,!1,!0)}_render(e=!1,t=!1,i=!1){var n;const r=this.getScene();if(!r)return i;const a=r.getEngine();if(this.useCameraPostProcesses!==void 0&&(e=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(let h=0;h<this._waitingRenderList.length;h++){const d=this._waitingRenderList[h],f=r.getMeshById(d);f&&this.renderList.push(f)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const h=this.getScene();if(!h)return i;const d=h.meshes;for(let f=0;f<d.length;f++){const p=d[f];this.renderListPredicate(p)&&this.renderList.push(p)}}const o=a.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);const l=(n=this.activeCamera)!==null&&n!==void 0?n:r.activeCamera,c=r.activeCamera;l&&(l!==r.activeCamera&&(r.setTransformMatrix(l.getViewMatrix(),l.getProjectionMatrix(!0)),r.activeCamera=l),a.setViewport(l.rigParent?l.rigParent.viewport:l.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;let u=i;if(i){r.getViewMatrix()||r.updateTransformMatrix();const h=this.is2DArray?this.getRenderLayers():this.isCube?6:1;for(let d=0;d<h&&u;d++){let f=null;const p=this.renderList?this.renderList:r.getActiveMeshes().data,m=this.renderList?this.renderList.length:r.getActiveMeshes().length;a.currentRenderPassId=this._renderPassIds[d],this.onBeforeRenderObservable.notifyObservers(d),this.getCustomRenderList&&(f=this.getCustomRenderList(d,p,m)),f||(f=p),this._doNotChangeAspectRatio||r.updateTransformMatrix(!0);for(let _=0;_<f.length&&u;++_){const E=f[_];if(!(!E.isEnabled()||E.isBlocked||!E.isVisible||!E.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(E,this.refreshRate,i)){u=!1;continue}}else if(!E.isReady(!0)){u=!1;continue}}}this.onAfterRenderObservable.notifyObservers(d),(this.is2DArray||this.isCube)&&(r.incrementRenderId(),r.resetCachedMaterial())}}else if(this.is2DArray&&!this.isMulti)for(let h=0;h<this.getRenderLayers();h++)this._renderToTarget(0,e,t,h,l),r.incrementRenderId(),r.resetCachedMaterial();else if(this.isCube&&!this.isMulti)for(let h=0;h<6;h++)this._renderToTarget(h,e,t,void 0,l),r.incrementRenderId(),r.resetCachedMaterial();else this._renderToTarget(0,e,t,void 0,l);return this.onAfterUnbindObservable.notifyObservers(this),a.currentRenderPassId=o,c&&(r.activeCamera=c,(r.getEngine().scenes.length>1||this.activeCamera&&this.activeCamera!==r.activeCamera)&&r.setTransformMatrix(r.activeCamera.getViewMatrix(),r.activeCamera.getProjectionMatrix(!0)),a.setViewport(r.activeCamera.viewport)),r.resetCachedMaterial(),u}_bestReflectionRenderTargetDimension(e,t){const n=e*t,r=k.NearestPOT(n+128*128/(128+n));return Math.min(k.FloorPOT(e),r)}_prepareRenderingManager(e,t,i,n){const r=this.getScene();if(!r)return;this._renderingManager.reset();const a=r.getRenderId();for(let o=0;o<t;o++){const l=e[o];if(l&&!l.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(l,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!l.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}if(!l._internalAbstractMeshDataInfo._currentLODIsUpToDate&&r.activeCamera&&(l._internalAbstractMeshDataInfo._currentLOD=r.customLODSelector?r.customLODSelector(l,this.activeCamera||r.activeCamera):l.getLOD(this.activeCamera||r.activeCamera),l._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!l._internalAbstractMeshDataInfo._currentLOD)continue;let c=l._internalAbstractMeshDataInfo._currentLOD;c._preActivateForIntermediateRendering(a);let u;if(n&&i?u=(l.layerMask&i.layerMask)===0:u=!1,l.isEnabled()&&l.isVisible&&l.subMeshes&&!u&&(c!==l&&c._activate(a,!0),l._activate(a,!0)&&l.subMeshes.length)){l.isAnInstance?l._internalAbstractMeshDataInfo._actAsRegularMesh&&(c=l):c._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,c._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(let h=0;h<c.subMeshes.length;h++){const d=c.subMeshes[h];this._renderingManager.dispatch(d,c)}}}}for(let o=0;o<r.particleSystems.length;o++){const l=r.particleSystems[o],c=l.emitter;!l.isStarted()||!c||c.position&&!c.isEnabled()||this._renderingManager.dispatchParticles(l)}}_bindFrameBuffer(e=0,t=0){const i=this.getScene();if(!i)return;const n=i.getEngine();this._renderTarget&&n.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}_prepareFrame(e,t,i,n){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!n||!e.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(t,i)}_renderToTarget(e,t,i,n=0,r=null){var a,o,l,c,u,h;const d=this.getScene();if(!d)return;const f=d.getEngine();if((a=f._debugPushGroup)===null||a===void 0||a.call(f,`render to face #${e} layer #${n}`,1),this._prepareFrame(d,e,n,t),this.is2DArray?(f.currentRenderPassId=this._renderPassIds[n],this.onBeforeRenderObservable.notifyObservers(n)):(f.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e)),f.snapshotRendering&&f.snapshotRenderingMode===1)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(f):this.skipInitialClear||f.clear(this.clearColor||d.clearColor,!0,!0,!0);else{let m=null;const _=this.renderList?this.renderList:d.getActiveMeshes().data,E=this.renderList?this.renderList.length:d.getActiveMeshes().length;this.getCustomRenderList&&(m=this.getCustomRenderList(this.is2DArray?n:e,_,E)),m?this._prepareRenderingManager(m,m.length,r,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(_,E,r,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),m=_);for(const y of d._beforeRenderTargetClearStage)y.action(this,e,n);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(f):this.skipInitialClear||f.clear(this.clearColor||d.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||d.updateTransformMatrix(!0);for(const y of d._beforeRenderTargetDrawStage)y.action(this,e,n);this._renderingManager.render(this.customRenderFunction,m,this.renderParticles,this.renderSprites);for(const y of d._afterRenderTargetDrawStage)y.action(this,e,n);const v=(l=(o=this._texture)===null||o===void 0?void 0:o.generateMipMaps)!==null&&l!==void 0?l:!1;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,(c=this._renderTarget)!==null&&c!==void 0?c:void 0,e,this._postProcesses,this.ignoreCameraViewport):t&&d.postProcessManager._finalizeFrame(!1,(u=this._renderTarget)!==null&&u!==void 0?u:void 0,e);for(const y of d._afterRenderTargetPostProcessStage)y.action(this,e,n);this._texture&&(this._texture.generateMipMaps=v),this._doNotChangeAspectRatio||d.updateTransformMatrix(!0),i&&Yi.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),f)}this._unbindFrameBuffer(f,e),this._texture&&this.isCube&&e===5&&f.generateMipMapsForCubemap(this._texture),(h=f._debugPopGroup)===null||h===void 0||h.call(f,1)}setRenderingOrder(e,t=null,i=null,n=null){this._renderingManager.setRenderingOrder(e,t,i,n)}setRenderingAutoClearDepthStencil(e,t){this._renderingManager.setRenderingAutoClearDepthStencil(e,t),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const e=this.getSize(),t=new er(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){var e;(e=this._renderTarget)===null||e===void 0||e.dispose(!0)}releaseInternalTexture(){var e;(e=this._renderTarget)===null||e===void 0||e.releaseTextures(),this._texture=null}dispose(){var e;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;const t=this.getScene();if(!t)return;let i=t.customRenderTargets.indexOf(this);i>=0&&t.customRenderTargets.splice(i,1);for(const n of t.cameras)i=n.customRenderTargets.indexOf(this),i>=0&&n.customRenderTargets.splice(i,1);(e=this._renderTarget)===null||e===void 0||e.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this.refreshRate===er.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=er.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}getViewCount(){return 1}}er.REFRESHRATE_RENDER_ONCE=0;er.REFRESHRATE_RENDER_ONEVERYFRAME=1;er.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2;H._CreateRenderTargetTexture=(s,e,t,i,n)=>new er(s,e,t,i);const _S="passCubePixelShader",gS=`varying vec2 vUV;uniform samplerCube textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec2 uv=vUV*2.0-1.0;
#ifdef POSITIVEX
gl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));
#endif
#ifdef NEGATIVEX
gl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));
#endif
#ifdef POSITIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));
#endif
#ifdef NEGATIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));
#endif
#ifdef POSITIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,1.001));
#endif
#ifdef NEGATIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));
#endif
}`;Q.ShadersStore[_S]=gS;class ih extends Dt{getClassName(){return"PassPostProcess"}constructor(e,t,i=null,n,r,a,o=0,l=!1){super(e,"pass",null,null,t,i,n,r,a,void 0,o,void 0,null,l)}static _Parse(e,t,i,n){return Pe.Parse(()=>new ih(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,i,n)}}Rt("BABYLON.PassPostProcess",ih);k._RescalePostProcessFactory=s=>new ih("rescale",1,null,2,s,!1,0);function ES(s,e,t,i,n,r,a,o){const l=e.getEngine();return e.isReady=!1,n=n!=null?n:e.samplingMode,i=i!=null?i:e.type,r=r!=null?r:e.format,a=a!=null?a:e.width,o=o!=null?o:e.height,i===-1&&(i=0),new Promise(c=>{const u=new Dt("postprocess",s,null,null,1,null,n,l,!1,void 0,i,void 0,null,!1,r);u.externalTextureSamplerBinding=!0;const h=l.createRenderTargetTexture({width:a,height:o},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:n,type:i,format:r});u.getEffect().executeWhenCompiled(()=>{u.onApply=d=>{d._bindTexture("textureSampler",e),d.setFloat2("scale",1,1)},t.postProcessManager.directRender([u],h,!0),l.restoreDefaultFramebuffer(),l._releaseTexture(e),u&&u.dispose(),h._swapAndDie(e),e.type=i,e.format=5,e.isReady=!0,c(e)})})}let Pc,X_;function Kh(s){Pc||(Pc=new Float32Array(1),X_=new Int32Array(Pc.buffer)),Pc[0]=s;const e=X_[0];let t=e>>16&32768,i=e>>12&2047;const n=e>>23&255;return n<103?t:n>142?(t|=31744,t|=(n==255?0:1)&&e&8388607,t):n<113?(i|=2048,t|=(i>>114-n)+(i>>113-n&1),t):(t|=n-112<<10|i>>1,t+=i&1,t)}class Y_{static ExpandRGBDTexture(e){const t=e._texture;if(!t||!e.isRGBD)return;const i=t.getEngine(),n=i.getCaps(),r=t.isReady;let a=!1;n.textureHalfFloatRender&&n.textureHalfFloatLinearFiltering?(a=!0,t.type=2):n.textureFloatRender&&n.textureFloatLinearFiltering&&(a=!0,t.type=1),a&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);const o=()=>{if(a){const l=new Dt("rgbdDecode","rgbdDecode",null,null,1,null,3,i,!1,void 0,t.type,void 0,null,!1);l.externalTextureSamplerBinding=!0;const c=i.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});l.getEffect().executeWhenCompiled(()=>{l.onApply=u=>{u._bindTexture("textureSampler",t),u.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([l],c,!0),i.restoreDefaultFramebuffer(),i._releaseTexture(t),l&&l.dispose(),c._swapAndDie(t),t.isReady=!0})}};r?o():e.onLoadObservable.addOnce(o)}static EncodeTextureToRGBD(e,t,i=0){return ES("rgbdEncode",e,t,i,1,5)}}const vS="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==";let yS=0;const OE=s=>{if(!s.environmentBRDFTexture){const e=s.useDelayedTextureLoading;s.useDelayedTextureLoading=!1;const t=s._blockEntityCollection;s._blockEntityCollection=!1;const i=H.CreateFromBase64String(vS,"EnvironmentBRDFTexture"+yS++,s,!0,!1,H.BILINEAR_SAMPLINGMODE);s._blockEntityCollection=t;const n=s.getEngine().getLoadedTexturesCache(),r=n.indexOf(i.getInternalTexture());r!==-1&&n.splice(r,1),i.isRGBD=!0,i.wrapU=H.CLAMP_ADDRESSMODE,i.wrapV=H.CLAMP_ADDRESSMODE,s.environmentBRDFTexture=i,s.useDelayedTextureLoading=e,Y_.ExpandRGBDTexture(i);const a=s.getEngine().onContextRestoredObservable.add(()=>{i.isRGBD=!0;const o=()=>{i.isReady()?Y_.ExpandRGBDTexture(i):q.SetImmediate(o)};o()});s.onDisposeObservable.add(()=>{s.getEngine().onContextRestoredObservable.remove(a)})}return s.environmentBRDFTexture},AS=new RegExp("^([gimus]+)!");class Cr{constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}_addPlugin(e){for(let n=0;n<this._plugins.length;++n)if(this._plugins[n].name===e.name)return!1;if(this._material._uniformBufferLayoutBuilt)throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.`;const t=e.getClassName();Cr._MaterialPluginClassToMainDefine[t]||(Cr._MaterialPluginClassToMainDefine[t]="MATERIALPLUGIN_"+ ++Cr._MaterialPluginCounter),this._material._callbackPluginEventGeneric=this._handlePluginEvent.bind(this),this._plugins.push(e),this._plugins.sort((n,r)=>n.priority-r.priority),this._codeInjectionPoints={};const i={};i[Cr._MaterialPluginClassToMainDefine[t]]={type:"boolean",default:!0};for(const n of this._plugins)n.collectDefines(i),this._collectPointNames("vertex",n.getCustomCode("vertex")),this._collectPointNames("fragment",n.getCustomCode("fragment"));return this._defineNamesFromPlugins=i,!0}_activatePlugin(e){this._activePlugins.indexOf(e)===-1&&(this._activePlugins.push(e),this._activePlugins.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null}_handlePluginEventIsReadyForSubMesh(e){let t=!0;for(const i of this._activePlugins)t=t&&i.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=t}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(const t of this._activePlugins)t.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}_handlePluginEventPrepareDefines(e){for(const t of this._activePlugins)t.prepareDefines(e.defines,this._scene,e.mesh)}_handlePluginEventHardBindForSubMesh(e){for(const t of this._activePluginsForExtraEvents)t.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventBindForSubMesh(e){for(const t of this._activePlugins)t.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventHasRenderTargetTextures(e){let t=!1;for(const i of this._activePluginsForExtraEvents)if(t=i.hasRenderTargetTextures(),t)break;e.hasRenderTargetTextures=t}_handlePluginEventFillRenderTargetTextures(e){for(const t of this._activePluginsForExtraEvents)t.fillRenderTargetTextures(e.renderTargets)}_handlePluginEvent(e,t){var i;switch(e){case yi.GetActiveTextures:{const n=t;for(const r of this._activePlugins)r.getActiveTextures(n.activeTextures);break}case yi.GetAnimatables:{const n=t;for(const r of this._activePlugins)r.getAnimatables(n.animatables);break}case yi.HasTexture:{const n=t;let r=!1;for(const a of this._activePlugins)if(r=a.hasTexture(n.texture),r)break;n.hasTexture=r;break}case yi.Disposed:{const n=t;for(const r of this._plugins)r.dispose(n.forceDisposeTextures);break}case yi.GetDefineNames:{const n=t;n.defineNames=this._defineNamesFromPlugins;break}case yi.PrepareEffect:{const n=t;for(const r of this._activePlugins)n.fallbackRank=r.addFallbacks(n.defines,n.fallbacks,n.fallbackRank),r.getAttributes(n.attributes,this._scene,n.mesh);this._uniformList.length>0&&n.uniforms.push(...this._uniformList),this._samplerList.length>0&&n.samplers.push(...this._samplerList),this._uboList.length>0&&n.uniformBuffersNames.push(...this._uboList),n.customCode=this._injectCustomCode(n,n.customCode);break}case yi.PrepareUniformBuffer:{const n=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(const r of this._plugins){const a=r.getUniforms();if(a){if(a.ubo)for(const o of a.ubo){if(o.size&&o.type){const l=(i=o.arraySize)!==null&&i!==void 0?i:0;n.ubo.addUniform(o.name,o.size,l),this._uboDeclaration+=`${o.type} ${o.name}${l>0?`[${l}]`:""};
`}this._uniformList.push(o.name)}a.vertex&&(this._vertexDeclaration+=a.vertex+`
`),a.fragment&&(this._fragmentDeclaration+=a.fragment+`
`)}r.getSamplers(this._samplerList),r.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(e,t){if(t)for(const i in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][i]=!0}_injectCustomCode(e,t){return(i,n)=>{var r,a;t&&(n=t(i,n)),this._uboDeclaration&&(n=n.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(n=n.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(n=n.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const o=(r=this._codeInjectionPoints)===null||r===void 0?void 0:r[i];if(!o)return n;let l=null;for(let c in o){let u="";for(const h of this._activePlugins){let d=(a=h.getCustomCode(i))===null||a===void 0?void 0:a[c];if(d){if(h.resolveIncludes){if(l===null){const f=Ai.GLSL;l={defines:[],indexParameters:e.indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:void 0,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:Q.GetShadersRepository(f),includesShadersStore:Q.GetIncludesShadersStore(f),version:void 0,platformName:this._engine.shaderPlatformName,processingContext:void 0,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:void 0}}l.isFragment=i==="fragment",xs._ProcessIncludes(d,l,f=>d=f)}u+=d+`
`}}if(u.length>0)if(c.charAt(0)==="!"){c=c.substring(1);let h="g";if(c.charAt(0)==="!")h="",c=c.substring(1);else{const m=AS.exec(c);m&&m.length>=2&&(h=m[1],c=c.substring(h.length+1))}h.indexOf("g")<0&&(h+="g");const d=n,f=new RegExp(c,h);let p=f.exec(d);for(;p!==null;){let m=u;for(let _=0;_<p.length;++_)m=m.replace("$"+_,p[_]);n=n.replace(p[0],m),p=f.exec(d)}}else{const h="#define "+c;n=n.replace(h,`
`+u+`
`+h)}}return n}}}Cr._MaterialPluginClassToMainDefine={};Cr._MaterialPluginCounter=0;Fe.OnEnginesDisposedObservable.add(()=>{SS()});const TS=[];let K_=null;function SS(){TS.length=0,z.OnEventObservable.remove(K_),K_=null}class Es{_enable(e){e&&this._pluginManager._activatePlugin(this)}constructor(e,t,i,n,r=!0,a=!1,o=!1){this.priority=500,this.resolveIncludes=!1,this.registerForExtraEvents=!1,this._material=e,this.name=t,this.priority=i,this.resolveIncludes=o,e.pluginManager||(e.pluginManager=new Cr(e),e.onDisposeObservable.add(()=>{e.pluginManager=void 0})),this._pluginDefineNames=n,this._pluginManager=e.pluginManager,r&&this._pluginManager._addPlugin(this),a&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,t,i,n){return!0}hardBindForSubMesh(e,t,i,n){}bindForSubMesh(e,t,i,n){}dispose(e){}getCustomCode(e){return null}collectDefines(e){if(this._pluginDefineNames)for(const t of Object.keys(this._pluginDefineNames)){if(t[0]==="_")continue;const i=typeof this._pluginDefineNames[t];e[t]={type:i==="number"?"number":i==="string"?"string":i==="boolean"?"boolean":"object",default:this._pluginDefineNames[t]}}}prepareDefinesBeforeAttributes(e,t,i){}prepareDefines(e,t,i){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,i){return i}getSamplers(e){}getAttributes(e,t,i){}getUniformBuffersNames(e){}getUniforms(){return{}}copyTo(e){Pe.Clone(()=>e,this)}serialize(){return Pe.Serialize(this)}parse(e,t,i){Pe.Parse(()=>this,e,t,i)}}S([b()],Es.prototype,"name",void 0);S([b()],Es.prototype,"priority",void 0);S([b()],Es.prototype,"resolveIncludes",void 0);S([b()],Es.prototype,"registerForExtraEvents",void 0);class CS extends Fs{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1}}class Fi extends Es{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}constructor(e,t=!0){super(e,"PBRBRDF",90,new CS,t),this._useEnergyConservation=Fi.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=Fi.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=Fi.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=Fi.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=Fi.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=Fi.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=Fi.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=Fi.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation}getClassName(){return"PBRBRDFConfiguration"}}Fi.DEFAULT_USE_ENERGY_CONSERVATION=!0;Fi.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0;Fi.DEFAULT_USE_SPHERICAL_HARMONICS=!0;Fi.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0;S([b(),K("_markAllSubMeshesAsMiscDirty")],Fi.prototype,"useEnergyConservation",void 0);S([b(),K("_markAllSubMeshesAsMiscDirty")],Fi.prototype,"useSmithVisibilityHeightCorrelated",void 0);S([b(),K("_markAllSubMeshesAsMiscDirty")],Fi.prototype,"useSphericalHarmonics",void 0);S([b(),K("_markAllSubMeshesAsMiscDirty")],Fi.prototype,"useSpecularGlossinessInputEnergyConservation",void 0);class Ru{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,i,n,r){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&t.prePassRenderer.getIndex(2)!==-1){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=n.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());const a=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=a.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==a.frameId&&(this._lastUpdateFrameId=a.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=n.clone()}}}class wE extends z{constructor(e,t,i=!0){super(e,t),this._normalMatrix=new D,this._storeEffectOnSubMeshes=i}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return e?!this._storeEffectOnSubMeshes||!e.subMeshes||e.subMeshes.length===0?!0:this.isReadyForSubMesh(e,e.subMeshes[0],t):!1}_isReadyForSubMesh(e){const t=e.materialDefines;return!!(!this.checkReadyOnEveryCall&&e.effect&&t&&t._renderId===this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,t){t&&this.bindForSubMesh(e,t,t.subMeshes[0])}_afterBind(e,t=null){super._afterBind(e,t),this.getScene()._cachedEffect=t,t&&(t._forceRebindOnNextCall=!1)}_mustRebind(e,t,i=1){return e.isCachedMaterialInvalid(this,t,i)}dispose(e,t,i){this._activeEffect=void 0,super.dispose(e,t,i)}}class Y{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(e){this._DecalMapEnabled!==e&&(this._DecalMapEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,k.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}}Y._DiffuseTextureEnabled=!0;Y._DetailTextureEnabled=!0;Y._DecalMapEnabled=!0;Y._AmbientTextureEnabled=!0;Y._OpacityTextureEnabled=!0;Y._ReflectionTextureEnabled=!0;Y._EmissiveTextureEnabled=!0;Y._SpecularTextureEnabled=!0;Y._BumpTextureEnabled=!0;Y._LightmapTextureEnabled=!0;Y._RefractionTextureEnabled=!0;Y._ColorGradingTextureEnabled=!0;Y._FresnelEnabled=!0;Y._ClearCoatTextureEnabled=!0;Y._ClearCoatBumpTextureEnabled=!0;Y._ClearCoatTintTextureEnabled=!0;Y._SheenTextureEnabled=!0;Y._AnisotropicTextureEnabled=!0;Y._ThicknessTextureEnabled=!0;Y._RefractionIntensityTextureEnabled=!0;Y._TranslucencyIntensityTextureEnabled=!0;Y._IridescenceTextureEnabled=!0;var Q_;(function(s){s[s.CW=0]="CW",s[s.CCW=1]="CCW"})(Q_||(Q_={}));class So{constructor(e,t=null,i,n=!1){this.path=e,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:g.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:D.Identity()};for(let r=0;r<e.length;r++)this._curve[r]=e[r].clone();this._raw=i||!1,this._alignTangentsWithPath=n,this._compute(t,n)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(e){return this._updatePointAtData(e).point}getTangentAt(e,t=!1){return this._updatePointAtData(e,t),t?g.TransformCoordinates(g.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(e,t=!1){return this._updatePointAtData(e,t),t?g.TransformCoordinates(g.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(e,t=!1){return this._updatePointAtData(e,t),t?g.TransformCoordinates(g.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(e){return this.length()*e}getPreviousPointIndexAt(e){return this._updatePointAtData(e),this._pointAtData.previousPointArrayIndex}getSubPositionAt(e){return this._updatePointAtData(e),this._pointAtData.subPosition}getClosestPositionTo(e){let t=Number.MAX_VALUE,i=0;for(let n=0;n<this._curve.length-1;n++){const r=this._curve[n+0],a=this._curve[n+1].subtract(r).normalize(),o=this._distances[n+1]-this._distances[n+0],l=Math.min(Math.max(g.Dot(a,e.subtract(r).normalize()),0)*g.Distance(r,e)/o,1),c=g.Distance(r.add(a.scale(l*o)),e);c<t&&(t=c,i=(this._distances[n+0]+o*l)/this.length())}return i}slice(e=0,t=1){if(e<0&&(e=1-e*-1%1),t<0&&(t=1-t*-1%1),e>t){const c=e;e=t,t=c}const i=this.getCurve(),n=this.getPointAt(e);let r=this.getPreviousPointIndexAt(e);const a=this.getPointAt(t),o=this.getPreviousPointIndexAt(t)+1,l=[];return e!==0&&(r++,l.push(n)),l.push(...i.slice(r,o)),(t!==1||e===1)&&l.push(a),new So(l,this.getNormalAt(e),this._raw,this._alignTangentsWithPath)}update(e,t=null,i=!1){for(let n=0;n<e.length;n++)this._curve[n].x=e[n].x,this._curve[n].y=e[n].y,this._curve[n].z=e[n].z;return this._compute(t,i),this}_compute(e,t=!1){const i=this._curve.length;if(i<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[i-1]=this._curve[i-1].subtract(this._curve[i-2]),this._raw||this._tangents[i-1].normalize();const n=this._tangents[0],r=this._normalVector(n,e);this._normals[0]=r,this._raw||this._normals[0].normalize(),this._binormals[0]=g.Cross(n,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;let a,o,l,c,u;for(let h=1;h<i;h++)a=this._getLastNonNullVector(h),h<i-1&&(o=this._getFirstNonNullVector(h),this._tangents[h]=t?o:a.add(o),this._tangents[h].normalize()),this._distances[h]=this._distances[h-1]+this._curve[h].subtract(this._curve[h-1]).length(),l=this._tangents[h],u=this._binormals[h-1],this._normals[h]=g.Cross(u,l),this._raw||(this._normals[h].length()===0?(c=this._normals[h-1],this._normals[h]=c.clone()):this._normals[h].normalize()),this._binormals[h]=g.Cross(l,this._normals[h]),this._raw||this._binormals[h].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(e){let t=1,i=this._curve[e+t].subtract(this._curve[e]);for(;i.length()===0&&e+t+1<this._curve.length;)t++,i=this._curve[e+t].subtract(this._curve[e]);return i}_getLastNonNullVector(e){let t=1,i=this._curve[e].subtract(this._curve[e-t]);for(;i.length()===0&&e>t+1;)t++,i=this._curve[e].subtract(this._curve[e-t]);return i}_normalVector(e,t){let i,n=e.length();if(n===0&&(n=1),t==null){let r;W.WithinEpsilon(Math.abs(e.y)/n,1,lt)?W.WithinEpsilon(Math.abs(e.x)/n,1,lt)?W.WithinEpsilon(Math.abs(e.z)/n,1,lt)?r=g.Zero():r=new g(0,0,1):r=new g(1,0,0):r=new g(0,-1,0),i=g.Cross(e,r)}else i=g.Cross(e,t),g.CrossToRef(i,e,i);return i.normalize(),i}_updatePointAtData(e,t=!1){if(this._pointAtData.id===e)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=e;const i=this.getPoints();if(e<=0)return this._setPointAtData(0,0,i[0],0,t);if(e>=1)return this._setPointAtData(1,1,i[i.length-1],i.length-1,t);let n=i[0],r,a=0;const o=e*this.length();for(let l=1;l<i.length;l++){r=i[l];const c=g.Distance(n,r);if(a+=c,a===o)return this._setPointAtData(e,1,r,l,t);if(a>o){const h=(a-o)/c,d=n.subtract(r),f=r.add(d.scaleInPlace(h));return this._setPointAtData(e,1-h,f,l-1,t)}n=r}return this._pointAtData}_setPointAtData(e,t,i,n,r){return this._pointAtData.point=i,this._pointAtData.position=e,this._pointAtData.subPosition=t,this._pointAtData.previousPointArrayIndex=n,this._pointAtData.interpolateReady=r,r&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=D.Identity();const e=this._pointAtData.previousPointArrayIndex;if(e!==this._tangents.length-1){const t=e+1,i=this._tangents[e].clone(),n=this._normals[e].clone(),r=this._binormals[e].clone(),a=this._tangents[t].clone(),o=this._normals[t].clone(),l=this._binormals[t].clone(),c=ee.RotationQuaternionFromAxis(n,r,i),u=ee.RotationQuaternionFromAxis(o,l,a);ee.Slerp(c,u,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}const Cs=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],IS=[()=>1,s=>s.y,s=>s.z,s=>s.x,s=>s.x*s.y,s=>s.y*s.z,s=>3*s.z*s.z-1,s=>s.x*s.z,s=>s.x*s.x-s.y*s.y],Vs=(s,e)=>Cs[s]*IS[s](e),Gs=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class Co{constructor(){this.preScaled=!1,this.l00=g.Zero(),this.l1_1=g.Zero(),this.l10=g.Zero(),this.l11=g.Zero(),this.l2_2=g.Zero(),this.l2_1=g.Zero(),this.l20=g.Zero(),this.l21=g.Zero(),this.l22=g.Zero()}addLight(e,t,i){w.Vector3[0].set(t.r,t.g,t.b);const n=w.Vector3[0],r=w.Vector3[1];n.scaleToRef(i,r),r.scaleToRef(Vs(0,e),w.Vector3[2]),this.l00.addInPlace(w.Vector3[2]),r.scaleToRef(Vs(1,e),w.Vector3[2]),this.l1_1.addInPlace(w.Vector3[2]),r.scaleToRef(Vs(2,e),w.Vector3[2]),this.l10.addInPlace(w.Vector3[2]),r.scaleToRef(Vs(3,e),w.Vector3[2]),this.l11.addInPlace(w.Vector3[2]),r.scaleToRef(Vs(4,e),w.Vector3[2]),this.l2_2.addInPlace(w.Vector3[2]),r.scaleToRef(Vs(5,e),w.Vector3[2]),this.l2_1.addInPlace(w.Vector3[2]),r.scaleToRef(Vs(6,e),w.Vector3[2]),this.l20.addInPlace(w.Vector3[2]),r.scaleToRef(Vs(7,e),w.Vector3[2]),this.l21.addInPlace(w.Vector3[2]),r.scaleToRef(Vs(8,e),w.Vector3[2]),this.l22.addInPlace(w.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(Gs[0]),this.l1_1.scaleInPlace(Gs[1]),this.l10.scaleInPlace(Gs[2]),this.l11.scaleInPlace(Gs[3]),this.l2_2.scaleInPlace(Gs[4]),this.l2_1.scaleInPlace(Gs[5]),this.l20.scaleInPlace(Gs[6]),this.l21.scaleInPlace(Gs[7]),this.l22.scaleInPlace(Gs[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(Cs[0]),this.l1_1.scaleInPlace(Cs[1]),this.l10.scaleInPlace(Cs[2]),this.l11.scaleInPlace(Cs[3]),this.l2_2.scaleInPlace(Cs[4]),this.l2_1.scaleInPlace(Cs[5]),this.l20.scaleInPlace(Cs[6]),this.l21.scaleInPlace(Cs[7]),this.l22.scaleInPlace(Cs[8])}updateFromArray(e){return g.FromArrayToRef(e[0],0,this.l00),g.FromArrayToRef(e[1],0,this.l1_1),g.FromArrayToRef(e[2],0,this.l10),g.FromArrayToRef(e[3],0,this.l11),g.FromArrayToRef(e[4],0,this.l2_2),g.FromArrayToRef(e[5],0,this.l2_1),g.FromArrayToRef(e[6],0,this.l20),g.FromArrayToRef(e[7],0,this.l21),g.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return g.FromFloatsToRef(e[0],e[1],e[2],this.l00),g.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),g.FromFloatsToRef(e[6],e[7],e[8],this.l10),g.FromFloatsToRef(e[9],e[10],e[11],this.l11),g.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),g.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),g.FromFloatsToRef(e[18],e[19],e[20],this.l20),g.FromFloatsToRef(e[21],e[22],e[23],this.l21),g.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return new Co().updateFromArray(e)}static FromPolynomial(e){const t=new Co;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}}class Nl{constructor(){this.x=g.Zero(),this.y=g.Zero(),this.z=g.Zero(),this.xx=g.Zero(),this.yy=g.Zero(),this.zz=g.Zero(),this.xy=g.Zero(),this.yz=g.Zero(),this.zx=g.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=Co.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){w.Vector3[0].copyFromFloats(e.r,e.g,e.b);const t=w.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),w.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),w.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(w.Vector3[0]).addInPlace(w.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(w.Vector3[0]).subtractInPlace(w.Vector3[1]),this.zz.copyFrom(e.l00),w.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(w.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return new Nl().updateFromHarmonics(e)}static FromArray(e){const t=new Nl;return g.FromArrayToRef(e[0],0,t.x),g.FromArrayToRef(e[1],0,t.y),g.FromArrayToRef(e[2],0,t.z),g.FromArrayToRef(e[3],0,t.xx),g.FromArrayToRef(e[4],0,t.yy),g.FromArrayToRef(e[5],0,t.zz),g.FromArrayToRef(e[6],0,t.yz),g.FromArrayToRef(e[7],0,t.zx),g.FromArrayToRef(e[8],0,t.xy),t}}class Ma{constructor(e,t,i,n){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=i,this.worldAxisForFileY=n}}class Jl{static ConvertCubeMapTextureToSphericalPolynomial(e){var t;if(!e.isCube)return null;(t=e.getScene())===null||t===void 0||t.getEngine().flushFramebuffer();const i=e.getSize().width,n=e.readPixels(0,void 0,void 0,!1),r=e.readPixels(1,void 0,void 0,!1);let a,o;e.isRenderTarget?(a=e.readPixels(3,void 0,void 0,!1),o=e.readPixels(2,void 0,void 0,!1)):(a=e.readPixels(2,void 0,void 0,!1),o=e.readPixels(3,void 0,void 0,!1));const l=e.readPixels(4,void 0,void 0,!1),c=e.readPixels(5,void 0,void 0,!1),u=e.gammaSpace,h=5;let d=0;return(e.textureType==1||e.textureType==2)&&(d=1),new Promise(f=>{Promise.all([r,n,a,o,l,c]).then(([p,m,_,E,v,y])=>{const A={size:i,right:m,left:p,up:_,down:E,front:v,back:y,format:h,type:d,gammaSpace:u};f(this.ConvertCubeMapToSphericalPolynomial(A))})})}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new Co;let i=0;const n=2/e.size,r=n,a=.5*n,o=a-1;for(let d=0;d<6;d++){const f=this._FileFaces[d],p=e[f.name];let m=o;const _=e.format===5?4:3;for(let E=0;E<e.size;E++){let v=o;for(let y=0;y<e.size;y++){const A=f.worldAxisForFileX.scale(v).add(f.worldAxisForFileY.scale(m)).add(f.worldAxisForNormal);A.normalize();const I=this._AreaElement(v-a,m-a)-this._AreaElement(v-a,m+a)-this._AreaElement(v+a,m-a)+this._AreaElement(v+a,m+a);let T=p[E*e.size*_+y*_+0],R=p[E*e.size*_+y*_+1],x=p[E*e.size*_+y*_+2];isNaN(T)&&(T=0),isNaN(R)&&(R=0),isNaN(x)&&(x=0),e.type===0&&(T/=255,R/=255,x/=255),e.gammaSpace&&(T=Math.pow(W.Clamp(T),Yc),R=Math.pow(W.Clamp(R),Yc),x=Math.pow(W.Clamp(x),Yc));const F=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const V=Math.max(T,R,x);if(V>F){const Z=F/V;T*=Z,R*=Z,x*=Z}}else T=W.Clamp(T,0,F),R=W.Clamp(R,0,F),x=W.Clamp(x,0,F);const L=new G(T,R,x);t.addLight(A,L,I),i+=I,v+=n}m+=r}}const h=4*Math.PI*6/6/i;return t.scaleInPlace(h),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),Nl.FromHarmonics(t)}}Jl._FileFaces=[new Ma("right",new g(1,0,0),new g(0,0,-1),new g(0,-1,0)),new Ma("left",new g(-1,0,0),new g(0,0,1),new g(0,-1,0)),new Ma("up",new g(0,1,0),new g(1,0,0),new g(0,0,1)),new Ma("down",new g(0,-1,0),new g(1,0,0),new g(0,0,-1)),new Ma("front",new g(0,0,1),new g(1,0,0),new g(0,-1,0)),new Ma("back",new g(0,0,-1),new g(-1,0,0),new g(0,-1,0))];Jl.MAX_HDRI_VALUE=4096;Jl.PRESERVE_CLAMPED_COLORS=!1;_t.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(_t.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=Jl.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(s=>{this._texture._sphericalPolynomial=s,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(s){this._texture&&(this._texture._sphericalPolynomial=s)},enumerable:!0,configurable:!0});const RS="prePassDeclaration",bS=`#ifdef PREPASS
#extension GL_EXT_draw_buffers : require
layout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;
#ifdef PREPASS_DEPTH
varying highp vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
varying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;
#endif
#endif
`;Q.IncludesShadersStore[RS]=bS;const xS="oitDeclaration",MS=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#extension GL_EXT_draw_buffers : require
layout(location=0) out vec2 depth; 
layout(location=1) out vec4 frontColor;layout(location=2) out vec4 backColor;
#define MAX_DEPTH 99999.0
highp vec4 gl_FragColor;uniform sampler2D oitDepthSampler;uniform sampler2D oitFrontColorSampler;
#endif
`;Q.IncludesShadersStore[xS]=MS;const PS="decalFragmentDeclaration",DS=`#ifdef DECAL
uniform vec4 vDecalInfos;
#endif
`;Q.IncludesShadersStore[PS]=DS;const OS="pbrFragmentDeclaration",wS=`uniform vec4 vEyePosition;uniform vec3 vReflectionColor;uniform vec4 vAlbedoColor;uniform vec4 vLightingIntensity;uniform vec4 vReflectivityColor;uniform vec4 vMetallicReflectanceFactors;uniform vec3 vEmissiveColor;uniform float visibility;uniform vec3 vAmbientColor;
#ifdef ALBEDO
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform vec4 vAmbientInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef OPACITY
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; 
#endif
#endif
#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; 
#endif
#ifdef CLEARCOAT
uniform vec2 vClearCoatParams;uniform vec4 vClearCoatRefractionParams;
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform vec2 vClearCoatTangentSpaceParams;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT
uniform vec4 vClearCoatTintParams;uniform float clearCoatColorAtDistance;
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#endif
#ifdef IRIDESCENCE
uniform vec4 vIridescenceParams;
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
uniform vec3 vAnisotropy;
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
uniform vec4 vSheenColor;
#ifdef SHEEN_ROUGHNESS
uniform float vSheenRoughness;
#endif
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionMicrosurfaceInfos;uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#ifdef REALTIME_FILTERING
uniform vec2 vRefractionFilteringInfo;
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
uniform vec2 vThicknessParam;uniform vec3 vDiffusionDistance;uniform vec4 vTintColor;uniform vec3 vSubSurfaceIntensity;
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;Q.IncludesShadersStore[OS]=wS;const FS="sceneUboDeclaration",LS=`layout(std140,column_major) uniform;uniform Scene {mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
mat4 view;mat4 projection;vec4 vEyePosition;};
`;Q.IncludesShadersStore[FS]=LS;const NS="meshUboDeclaration",BS=`#ifdef WEBGL2
uniform mat4 world;uniform float visibility;
#else
layout(std140,column_major) uniform;uniform Mesh
{mat4 world;float visibility;};
#endif
#define WORLD_UBO
`;Q.IncludesShadersStore[NS]=BS;const kS="pbrUboDeclaration",US=`layout(std140,column_major) uniform;uniform Material {vec2 vAlbedoInfos;vec4 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec3 vReflectivityInfos;vec2 vMicroSurfaceSamplerInfos;vec2 vReflectionInfos;vec2 vReflectionFilteringInfo;vec3 vReflectionPosition;vec3 vReflectionSize;vec3 vBumpInfos;mat4 albedoMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 reflectivityMatrix;mat4 microSurfaceSamplerMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;mat4 reflectionMatrix;vec3 vReflectionColor;vec4 vAlbedoColor;vec4 vLightingIntensity;vec3 vReflectionMicrosurfaceInfos;float pointSize;vec4 vReflectivityColor;vec3 vEmissiveColor;vec3 vAmbientColor;vec2 vDebugMode;vec4 vMetallicReflectanceFactors;vec2 vMetallicReflectanceInfos;mat4 metallicReflectanceMatrix;vec2 vReflectanceInfos;mat4 reflectanceMatrix;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;Q.IncludesShadersStore[kS]=US;const VS="mainUVVaryingDeclaration",GS=`#ifdef MAINUV{X}
varying vec2 vMainUV{X};
#endif
`;Q.IncludesShadersStore[VS]=GS;const zS="pbrFragmentExtraDeclaration",HS=`varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
`;Q.IncludesShadersStore[zS]=HS;const WS="lightFragmentDeclaration",XS=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};uniform highp sampler2DArray depthSampler{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X};
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightSampler{X};
#endif
#endif
`;Q.IncludesShadersStore[WS]=XS;const YS="lightUboDeclaration",KS=`#ifdef LIGHT{X}
uniform Light{X}
{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;vec2 depthValues;} light{X};
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightSampler{X};
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};uniform highp sampler2DArray depthSampler{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X}; 
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;Q.IncludesShadersStore[YS]=KS;const QS="samplerFragmentDeclaration",ZS=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
uniform sampler2D _SAMPLERNAME_Sampler;
#endif
`;Q.IncludesShadersStore[QS]=ZS;const qS="samplerFragmentAlternateDeclaration",jS=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
#endif
`;Q.IncludesShadersStore[qS]=jS;const $S="pbrFragmentSamplersDeclaration",JS=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D clearCoatRoughnessSampler;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D sheenRoughnessSampler;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
#define sampleRefraction(s,c) textureCube(s,c)
uniform samplerCube refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube refractionSamplerLow;uniform samplerCube refractionSamplerHigh;
#endif
#else
#define sampleRefraction(s,c) texture2D(s,c)
uniform sampler2D refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D refractionSamplerLow;uniform sampler2D refractionSamplerHigh;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#endif
`;Q.IncludesShadersStore[$S]=JS;const eC="imageProcessingDeclaration",tC=`#ifdef EXPOSURE
uniform float exposureLinear;
#endif
#ifdef CONTRAST
uniform float contrast;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vec2 vInverseScreenSize;
#endif
#ifdef VIGNETTE
uniform vec4 vignetteSettings1;uniform vec4 vignetteSettings2;
#endif
#ifdef COLORCURVES
uniform vec4 vCameraColorCurveNegative;uniform vec4 vCameraColorCurveNeutral;uniform vec4 vCameraColorCurvePositive;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
uniform highp sampler3D txColorTransform;
#else
uniform sampler2D txColorTransform;
#endif
uniform vec4 colorTransformSettings;
#endif
#ifdef DITHER
uniform float ditherIntensity;
#endif
`;Q.IncludesShadersStore[eC]=tC;const iC="clipPlaneFragmentDeclaration",nC=`#ifdef CLIPPLANE
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
varying float fClipDistance6;
#endif
`;Q.IncludesShadersStore[iC]=nC;const sC="logDepthDeclaration",rC=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;varying float vFragmentDepth;
#endif
`;Q.IncludesShadersStore[sC]=rC;const aC="fogFragmentDeclaration",oC=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;uniform vec3 vFogColor;varying vec3 vFogDistance;float CalcFogFactor()
{float fogCoeff=1.0;float fogStart=vFogInfos.y;float fogEnd=vFogInfos.z;float fogDensity=vFogInfos.w;float fogDistance=length(vFogDistance);if (FOGMODE_LINEAR==vFogInfos.x)
{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}
else if (FOGMODE_EXP==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}
else if (FOGMODE_EXP2==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}
return clamp(fogCoeff,0.0,1.0);}
#endif
`;Q.IncludesShadersStore[aC]=oC;const lC="subSurfaceScatteringFunctions",cC=`bool testLightingForSSS(float diffusionProfile)
{return diffusionProfile<1.;}`;Q.IncludesShadersStore[lC]=cC;const uC="importanceSampling",hC=`vec3 hemisphereCosSample(vec2 u) {float phi=2.*PI*u.x;float cosTheta2=1.-u.y;float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDggx(vec2 u,float a) {float phi=2.*PI*u.x;float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { 
float phi=2.*PI*u.x;float sinTheta=pow(u.y,a/(2.*a+1.));float cosTheta=sqrt(1.-sinTheta*sinTheta);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}`;Q.IncludesShadersStore[uC]=hC;const dC="pbrHelperFunctions",fC=`#define RECIPROCAL_PI2 0.15915494
#define RECIPROCAL_PI 0.31830988618
#define MINIMUMVARIANCE 0.0005
float convertRoughnessToAverageSlope(float roughness)
{return square(roughness)+MINIMUMVARIANCE;}
float fresnelGrazingReflectance(float reflectance0) {float reflectance90=saturate(reflectance0*25.0);return reflectance90;}
vec2 getAARoughnessFactors(vec3 normalVector) {
#ifdef SPECULARAA
vec3 nDfdx=dFdx(normalVector.xyz);vec3 nDfdy=dFdy(normalVector.xyz);float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);float geometricAlphaGFactor=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2(0.);
#endif
}
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_LEGACY
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 anisotropicFrameDirection=anisotropy>=0.0 ? B : T;vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}
#else
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG,MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 bentNormal=cross(B,V);bentNormal=normalize(cross(bentNormal,B));float a=square(square(1.0-anisotropy*(1.0-roughness)));bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}
#endif
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
vec3 cocaLambert(vec3 alpha,float distance) {return exp(-alpha*distance);}
vec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}
vec3 computeColorAtDistanceInMedia(vec3 color,float distance) {return -log(color)/distance;}
vec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 clearCoatAbsorption=mix(vec3(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);return clearCoatAbsorption;}
#endif
#ifdef MICROSURFACEAUTOMATIC
float computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)
{const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;float reflectivityLuminance=getLuminance(reflectivityColor);float reflectivityLuma=sqrt(reflectivityLuminance);microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return microSurface;}
#endif
`;Q.IncludesShadersStore[dC]=fC;const pC="imageProcessingFunctions",mC=`#if defined(COLORGRADING) && !defined(COLORGRADING3D)
/** 
* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.
* sampler3dSetting.x=textureOffset (0.5/textureSize).
* sampler3dSetting.y=textureSize.
*/
#define inline
vec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)
{float sliceSize=2.0*sampler3dSetting.x; 
#ifdef SAMPLER3DGREENDEPTH
float sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;
#else
float sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;
#endif
float sliceInteger=floor(sliceContinuous);float sliceFraction=sliceContinuous-sliceInteger;
#ifdef SAMPLER3DGREENDEPTH
vec2 sliceUV=color.rb;
#else
vec2 sliceUV=color.rg;
#endif
sliceUV.x*=sliceSize;sliceUV.x+=sliceInteger*sliceSize;sliceUV=saturate(sliceUV);vec4 slice0Color=texture2D(colorTransform,sliceUV);sliceUV.x+=sliceSize;sliceUV=saturate(sliceUV);vec4 slice1Color=texture2D(colorTransform,sliceUV);vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);
#ifdef SAMPLER3DBGRMAP
color.rgb=result.rgb;
#else
color.rgb=result.bgr;
#endif
return color;}
#endif
#ifdef TONEMAPPING_ACES
const mat3 ACESInputMat=mat3(
vec3(0.59719,0.07600,0.02840),
vec3(0.35458,0.90834,0.13383),
vec3(0.04823,0.01566,0.83777)
);const mat3 ACESOutputMat=mat3(
vec3( 1.60475,-0.10208,-0.00327),
vec3(-0.53108, 1.10813,-0.07276),
vec3(-0.07367,-0.00605, 1.07602)
);vec3 RRTAndODTFit(vec3 v)
{vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}
vec3 ACESFitted(vec3 color)
{color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;color=saturate(color);return color;}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
vec4 applyImageProcessing(vec4 result) {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
#ifdef EXPOSURE
result.rgb*=exposureLinear;
#endif
#ifdef VIGNETTE
vec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);float vignetteTerm=dot(vignetteXY1,vignetteXY1);float vignette=pow(vignetteTerm,vignetteSettings2.w);vec3 vignetteColor=vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
vec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);result.rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
result.rgb=mix(vignetteColor,result.rgb,vignette);
#endif
#endif
#ifdef TONEMAPPING
#ifdef TONEMAPPING_ACES
result.rgb=ACESFitted(result.rgb);
#else
const float tonemappingCalibration=1.590579;result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);
#endif
#endif
result.rgb=toGammaSpace(result.rgb);result.rgb=saturate(result.rgb);
#ifdef CONTRAST
vec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);if (contrast<1.0) {result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);} else {result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);}
#endif
#ifdef COLORGRADING
vec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;
#ifdef COLORGRADING3D
vec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;
#else
vec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;
#endif
result.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);
#endif
#ifdef COLORCURVES
float luma=getLuminance(result.rgb);vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;result.rgb*=colorCurve.rgb;result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);
#endif
#ifdef DITHER
float rand=getRand(gl_FragCoord.xy*vInverseScreenSize);float dither=mix(-ditherIntensity,ditherIntensity,rand);result.rgb=saturate(result.rgb+vec3(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return result;}`;Q.IncludesShadersStore[pC]=mC;const _C="shadowsFragmentFunctions",gC=`#ifdef SHADOWS
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
#ifndef SHADOWFLOAT
float unpack(vec4 color)
{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}
#endif
float computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)
{float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}
#define inline
float computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)
{vec3 directionToLight=vPositionW-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadow=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadow=textureCube(shadowSampler,directionToLight).x;
#endif
return depth>shadow ? darkness : 1.0;}
#define inline
float computeShadowWithPoissonSamplingCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)
{vec3 directionToLight=vPositionW-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;float visibility=1.;vec3 poissonDisk[4];poissonDisk[0]=vec3(-1.0,1.0,-1.0);poissonDisk[1]=vec3(1.0,-1.0,-1.0);poissonDisk[2]=vec3(-1.0,-1.0,-1.0);poissonDisk[3]=vec3(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;
#else
if (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;
#endif
return min(1.0,visibility+darkness);}
#define inline
float computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{vec3 directionToLight=vPositionW-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); 
return esm;}
#define inline
float computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{vec3 directionToLight=vPositionW-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define inline
float computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);vec3 uvLayer=vec3(uv.x,uv.y,layer);float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uvLayer));
#else
float shadow=texture2D(shadowSampler,uvLayer).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}
#endif
#define inline
float computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}}
#define inline
float computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);float visibility=1.;vec2 poissonDisk[4];poissonDisk[0]=vec2(-0.94201624,-0.39906216);poissonDisk[1]=vec2(0.94558609,-0.76890725);poissonDisk[2]=vec2(-0.094184101,-0.92938870);poissonDisk[3]=vec2(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
#else
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
#ifdef IS_NDC_HALF_ZRANGE
#define ZINCLIP clipSpace.z
#else
#define ZINCLIP uvDepth.z
#endif
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define GREATEST_LESS_THAN_ONE 0.99999994
#define inline
float computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float shadow=texture2D(shadowSampler,uvDepthLayer);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
const vec3 PoissonSamplers32[64]=vec3[64](
vec3(0.06407013,0.05409927,0.),
vec3(0.7366577,0.5789394,0.),
vec3(-0.6270542,-0.5320278,0.),
vec3(-0.4096107,0.8411095,0.),
vec3(0.6849564,-0.4990818,0.),
vec3(-0.874181,-0.04579735,0.),
vec3(0.9989998,0.0009880066,0.),
vec3(-0.004920578,-0.9151649,0.),
vec3(0.1805763,0.9747483,0.),
vec3(-0.2138451,0.2635818,0.),
vec3(0.109845,0.3884785,0.),
vec3(0.06876755,-0.3581074,0.),
vec3(0.374073,-0.7661266,0.),
vec3(0.3079132,-0.1216763,0.),
vec3(-0.3794335,-0.8271583,0.),
vec3(-0.203878,-0.07715034,0.),
vec3(0.5912697,0.1469799,0.),
vec3(-0.88069,0.3031784,0.),
vec3(0.5040108,0.8283722,0.),
vec3(-0.5844124,0.5494877,0.),
vec3(0.6017799,-0.1726654,0.),
vec3(-0.5554981,0.1559997,0.),
vec3(-0.3016369,-0.3900928,0.),
vec3(-0.5550632,-0.1723762,0.),
vec3(0.925029,0.2995041,0.),
vec3(-0.2473137,0.5538505,0.),
vec3(0.9183037,-0.2862392,0.),
vec3(0.2469421,0.6718712,0.),
vec3(0.3916397,-0.4328209,0.),
vec3(-0.03576927,-0.6220032,0.),
vec3(-0.04661255,0.7995201,0.),
vec3(0.4402924,0.3640312,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.)
);const vec3 PoissonSamplers64[64]=vec3[64](
vec3(-0.613392,0.617481,0.),
vec3(0.170019,-0.040254,0.),
vec3(-0.299417,0.791925,0.),
vec3(0.645680,0.493210,0.),
vec3(-0.651784,0.717887,0.),
vec3(0.421003,0.027070,0.),
vec3(-0.817194,-0.271096,0.),
vec3(-0.705374,-0.668203,0.),
vec3(0.977050,-0.108615,0.),
vec3(0.063326,0.142369,0.),
vec3(0.203528,0.214331,0.),
vec3(-0.667531,0.326090,0.),
vec3(-0.098422,-0.295755,0.),
vec3(-0.885922,0.215369,0.),
vec3(0.566637,0.605213,0.),
vec3(0.039766,-0.396100,0.),
vec3(0.751946,0.453352,0.),
vec3(0.078707,-0.715323,0.),
vec3(-0.075838,-0.529344,0.),
vec3(0.724479,-0.580798,0.),
vec3(0.222999,-0.215125,0.),
vec3(-0.467574,-0.405438,0.),
vec3(-0.248268,-0.814753,0.),
vec3(0.354411,-0.887570,0.),
vec3(0.175817,0.382366,0.),
vec3(0.487472,-0.063082,0.),
vec3(-0.084078,0.898312,0.),
vec3(0.488876,-0.783441,0.),
vec3(0.470016,0.217933,0.),
vec3(-0.696890,-0.549791,0.),
vec3(-0.149693,0.605762,0.),
vec3(0.034211,0.979980,0.),
vec3(0.503098,-0.308878,0.),
vec3(-0.016205,-0.872921,0.),
vec3(0.385784,-0.393902,0.),
vec3(-0.146886,-0.859249,0.),
vec3(0.643361,0.164098,0.),
vec3(0.634388,-0.049471,0.),
vec3(-0.688894,0.007843,0.),
vec3(0.464034,-0.188818,0.),
vec3(-0.440840,0.137486,0.),
vec3(0.364483,0.511704,0.),
vec3(0.034028,0.325968,0.),
vec3(0.099094,-0.308023,0.),
vec3(0.693960,-0.366253,0.),
vec3(0.678884,-0.204688,0.),
vec3(0.001801,0.780328,0.),
vec3(0.145177,-0.898984,0.),
vec3(0.062655,-0.611866,0.),
vec3(0.315226,-0.604297,0.),
vec3(-0.780145,0.486251,0.),
vec3(-0.371868,0.882138,0.),
vec3(0.200476,0.494430,0.),
vec3(-0.494552,-0.711051,0.),
vec3(0.612476,0.705252,0.),
vec3(-0.578845,-0.768792,0.),
vec3(-0.772454,-0.090976,0.),
vec3(0.504440,0.372295,0.),
vec3(0.155736,0.065157,0.),
vec3(0.391522,0.849605,0.),
vec3(-0.620106,-0.328104,0.),
vec3(0.789239,-0.419965,0.),
vec3(-0.545396,0.538133,0.),
vec3(-0.178564,-0.596057,0.)
);
#define inline
float computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}
float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec4 offset=vec4(poissonSamplers[i],0.);offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);}
shadow/=float(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);if (numBlocker<1.0) {return 1.0;}
else
{return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}
if (numBlocker<1.0) {return 1.0;}
else
{float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec3 offset=poissonSamplers[i];offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);}
shadow/=float(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}}
#define inline
float computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}
#define inline
float computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}
#define inline
float computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}
#define inline
float computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#define inline
float computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#define inline
float computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#endif
#endif
`;Q.IncludesShadersStore[_C]=gC;const EC="harmonicsFunctions",vC=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
vec3 computeEnvironmentIrradiance(vec3 normal) {return vSphericalL00
+ vSphericalL1_1*(normal.y)
+ vSphericalL10*(normal.z)
+ vSphericalL11*(normal.x)
+ vSphericalL2_2*(normal.y*normal.x)
+ vSphericalL2_1*(normal.y*normal.z)
+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ vSphericalL21*(normal.z*normal.x)
+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}
#else
vec3 computeEnvironmentIrradiance(vec3 normal) {float Nx=normal.x;float Ny=normal.y;float Nz=normal.z;vec3 C1=vSphericalZZ.rgb;vec3 Cx=vSphericalX.rgb;vec3 Cy=vSphericalY.rgb;vec3 Cz=vSphericalZ.rgb;vec3 Cxx_zz=vSphericalXX_ZZ.rgb;vec3 Cyy_zz=vSphericalYY_ZZ.rgb;vec3 Cxy=vSphericalXY.rgb;vec3 Cyz=vSphericalYZ.rgb;vec3 Czx=vSphericalZX.rgb;vec3 a1=Cyy_zz*Ny+Cy;vec3 a2=Cyz*Nz+a1;vec3 b1=Czx*Nz+Cx;vec3 b2=Cxy*Ny+b1;vec3 b3=Cxx_zz*Nx+b2;vec3 t1=Cz *Nz+C1;vec3 t2=a2 *Ny+t1;vec3 t3=b3 *Nx+t2;return t3;}
#endif
#endif
`;Q.IncludesShadersStore[EC]=vC;const yC="pbrDirectLightingSetupFunctions",AC=`struct preLightingInfo
{vec3 lightOffset;float lightDistanceSquared;float lightDistance;float attenuation;vec3 L;vec3 H;float NdotV;float NdotLUnclamped;float NdotL;float VdotH;float roughness;
#ifdef IRIDESCENCE
float iridescenceIntensity;
#endif
};preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightOffset=lightData.xyz-vPositionW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
preLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
preLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));
#endif
return result;}`;Q.IncludesShadersStore[yC]=AC;const TC="pbrDirectLightingFalloffFunctions",SC=`float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)
{return max(0.,1.0-length(lightOffset)/range);}
float computeDistanceLightFalloff_Physical(float lightDistanceSquared)
{return 1.0/maxEps(lightDistanceSquared);}
float computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)
{float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);float factor=lightDistanceSquared*inverseSquaredRange;float attenuation=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}
float computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
float computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)
{float falloff=0.0;float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)
{falloff=max(0.,pow(cosAngle,exponent));}
return falloff;}
float computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)
{const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; 
float concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}
float computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)
{float cd=dot(-lightDirection,directionToLightCenterW);float falloff=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}
float computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;Q.IncludesShadersStore[TC]=SC;const CC="pbrBRDFFunctions",IC=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}
#endif
#ifdef ENVIRONMENTBRDF
vec3 getBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(NdotV,perceptualRoughness);vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup.rgb=fromRGBD(brdfLookup.rgba);
#endif
return brdfLookup.rgb;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
float getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)
{float c=1.0-NdotV;float c3=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
vec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
vec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}
#endif
vec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
float fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
#ifdef CLEARCOAT
vec3 getR0RemappedForClearCoat(vec3 f0) {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturate(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
vec3 s=sqrt(f0);vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);return square(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const mat3 XYZ_TO_REC709=mat3(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);vec3 getIORTfromAirToSurfaceR0(vec3 f0) {vec3 sqrtF0=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}
vec3 getR0fromIORs(vec3 iorT,float iorI) {return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));}
float getR0fromIORs(float iorT,float iorI) {return square((iorT-iorI)/(iorT+iorI));}
vec3 evalSensitivity(float opd,vec3 shift) {float phase=2.0*PI*opd*1.0e-9;const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_TO_REC709*xyz;return srgb;}
vec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {vec3 I=vec3(1.0);float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}
float cosTheta2=sqrt(cosTheta2Sq);float R0=getR0fromIORs(iridescenceIOR,outsideIOR);float R12=fresnelSchlickGGX(cosTheta1,R0,1.);float R21=R12;float T121=1.0-R12;float phi12=0.0;if (iridescenceIOR<outsideIOR) phi12=PI;float phi21=PI-phi12;vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); 
vec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));vec3 phi23=vec3(0.0);if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for (int m=1; m<=2; ++m)
{Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);I+=Cm*Sm;}
return max(I,vec3(0.0));}
#endif
float normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)
{float a2=square(alphaG);float d=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}
#ifdef SHEEN
float normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)
{float invR=1./alphaG;float cos2h=NdotH*NdotH;float sin2h=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}
#endif
#ifdef ANISOTROPIC
float normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {float a2=alphaTB.x*alphaTB.y;vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {
#ifdef MOBILE
float GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);
#else
float a2=alphaG*alphaG;float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);
#endif
}
#else
float smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
float alphaSquared=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
float smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)
{float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}
#endif
#ifdef ANISOTROPIC
float smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));float v=0.5/(lambdaV+lambdaL);return v;}
#endif
#ifdef CLEARCOAT
float visibility_Kelemen(float VdotH) {return 0.25/(VdotH*VdotH); }
#endif
#ifdef SHEEN
float visibility_Ashikhmin(float NdotL,float NdotV)
{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}
/* NOT USED
#ifdef SHEEN_SOFTER
float l(float x,float alphaG)
{float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}
float lambdaSheen(float cosTheta,float alphaG)
{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}
float visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)
{float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}
#endif
*/
#endif
float diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;float fresnel =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}
#ifdef SS_TRANSLUCENCY
vec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {vec3 S=1./maxEps(diffusionDistance);vec3 temp=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}
float computeWrappedDiffuseNdotL(float NdotL,float w) {float t=1.0+w;float invt2=1.0/square(t);return saturate((NdotL+w)*invt2);}
#endif
`;Q.IncludesShadersStore[CC]=IC;const RC="hdrFilteringFunctions",bC=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
float radicalInverse_VdC(uint bits) 
{bits=(bits<<16u) | (bits>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return float(bits)*2.3283064365386963e-10; }
vec2 hammersley(uint i,uint N)
{return vec2(float(i)/float(N),radicalInverse_VdC(i));}
#else
float vanDerCorpus(int n,int base)
{float invBase=1.0/float(base);float denom =1.0;float result =0.0;for(int i=0; i<32; ++i)
{if(n>0)
{denom =mod(float(n),2.0);result+=denom*invBase;invBase=invBase/2.0;n =int(float(n)/2.0);}}
return result;}
vec2 hammersley(int i,int N)
{return vec2(float(i)/float(N),vanDerCorpus(i,2));}
#endif
float log4(float x) {return log2(x)/2.;}
const float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;const float K=4.;
#define inline
vec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{vec3 n=normalize(inputN);vec3 result=vec3(0.0);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 Ls=hemisphereCosSample(Xi);Ls=normalize(Ls);vec3 Ns=vec3(0.,0.,1.);float NoL=dot(Ns,Ls);if (NoL>0.) {float pdf_inversed=PI/NoL;float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(l,0.0,maxLevel);vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c;}}
result=result*NUM_SAMPLES_FLOAT_INVERSED;return result;}
#define inline
vec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{vec3 n=normalize(inputN);if (alphaG==0.) {vec3 c=textureCube(inputTexture,n).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;} else {vec3 result=vec3(0.);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);float NoV=1.;float NoH=H.z;float NoH2=H.z*H.z;float NoL=2.*NoH2-1.;vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}}
#endif
#endif
`;Q.IncludesShadersStore[RC]=bC;const xC="pbrDirectLightingFunctions",MC=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef CLEARCOAT
vec4 clearCoat;
#endif
#ifdef SHEEN
vec3 sheen;
#endif
};float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
float lightRoughness=lightRadius/lightDistance;float totalRoughness=saturate(lightRoughness+roughness);return totalRoughness;
#else
return roughness;
#endif
}
vec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {return mix(groundColor,lightColor,info.NdotL);}
vec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*info.attenuation*info.NdotL*lightColor;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return toLinearSpace(textureColor);}
#ifdef SS_TRANSLUCENCY
vec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {float NdotL=absEps(info.NdotLUnclamped);float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);float trAdapt=step(0.,info.NdotLUnclamped);vec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;}
#endif
#ifdef SPECULARTERM
vec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
float smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef ANISOTROPIC
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLEARCOAT
vec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {float NccdotL=saturateEps(dot(Ncc,info.L));float NccdotH=saturateEps(dot(Ncc,info.H));float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);float kelemenVisibility=visibility_Kelemen(info.VdotH);float clearCoatTerm=fresnel*distribution*kelemenVisibility;return vec4(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);}
vec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);float NdotLRefract=saturateEps(dot(Ncc,LRefract));vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}
#endif
#ifdef SHEEN
vec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);float fresnel=1.;float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER
float visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
float visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */
float sheenTerm=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}
#endif
`;Q.IncludesShadersStore[xC]=MC;const PC="pbrIBLFunctions",DC=`#if defined(REFLECTION) || defined(SS_REFRACTION)
float getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;float lod=log2(microsurfaceAverageSlopeTexels);return lod;}
float getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {float lod=log2(cubeMapDimensionPixels)*roughness;return lod;}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
float environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {float temp=NdotVUnclamped+ambientOcclusion;return saturate(square(temp)-1.0+ambientOcclusion);}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
float environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {vec3 reflection=reflect(view,normal);float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));return square(temp);}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
#define UNPACK_LOD(x) (1.0-x)*255.0
float getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {float microsurfaceAverageSlope=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}
#endif
`;Q.IncludesShadersStore[PC]=DC;const OC="bumpFragmentMainFunctions",wC=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#if defined(WEBGL2) || defined(WEBGPU)
mat4 toNormalMatrix(mat4 wMatrix)
{mat4 ret=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]=vec4(0.,0.,0.,1.);return ret;}
#else
mat4 toNormalMatrix(mat4 m)
{float
a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],
a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],
a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],
a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],
b00=a00*a11-a01*a10,
b01=a00*a12-a02*a10,
b02=a00*a13-a03*a10,
b03=a01*a12-a02*a11,
b04=a01*a13-a03*a11,
b05=a02*a13-a03*a12,
b06=a20*a31-a21*a30,
b07=a20*a32-a22*a30,
b08=a20*a33-a23*a30,
b09=a21*a32-a22*a31,
b10=a21*a33-a23*a31,
b11=a22*a33-a23*a32,
det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;mat4 mi=mat4(
a11*b11-a12*b10+a13*b09,
a02*b10-a01*b11-a03*b09,
a31*b05-a32*b04+a33*b03,
a22*b04-a21*b05-a23*b03,
a12*b08-a10*b11-a13*b07,
a00*b11-a02*b08+a03*b07,
a32*b02-a30*b05-a33*b01,
a20*b05-a22*b02+a23*b01,
a10*b10-a11*b08+a13*b06,
a01*b08-a00*b10-a03*b06,
a30*b04-a31*b02+a33*b00,
a21*b02-a20*b04-a23*b00,
a11*b07-a10*b09-a12*b06,
a00*b09-a01*b07+a02*b06,
a31*b01-a30*b03-a32*b00,
a20*b03-a21*b01+a22*b00)/det;return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{vec3 dp1=dFdx(p);vec3 dp2=dFdy(p);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;float det=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=det==0.0 ? 0.0 : inversesqrt(det);return mat3(tangent*invmax,bitangent*invmax,normal);}
#endif
`;Q.IncludesShadersStore[OC]=wC;const FC="bumpFragmentFunctions",LC=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const float minSamples=4.;const float maxSamples=15.;const int iMaxSamples=15;vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;vec2 vOffsetDir=normalize(vViewDirCoT.xy);vec2 vMaxOffset=vOffsetDir*parallaxLimit;float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));float stepSize=1.0/numSamples;float currRayHeight=1.0;vec2 vCurrOffset=vec2(0,0);vec2 vLastOffset=vec2(0,0);float lastSampledHeight=1.0;float currSampledHeight=1.0;bool keepWorking=true;for (int i=0; i<iMaxSamples; i++)
{currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{float delta1=currSampledHeight-currRayHeight;float delta2=(currRayHeight+stepSize)-lastSampledHeight;float ratio=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;vCurrOffset+=stepSize*vMaxOffset;lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{float height=texture2D(bumpSampler,vBumpUV).w;vec2 texCoordOffset=heightScale*viewDir.xy*height;return -texCoordOffset;}
#endif
`;Q.IncludesShadersStore[FC]=LC;const NC="reflectionFunction",BC=`vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0); }
vec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(1.0-s,t,0); }
vec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);vec3 r=normalize(reflect(cameraToVertex,worldNormal));r=vec3(reflectionMatrix*vec4(r,0));float lon=atan(r.z,r.x);float lat=acos(r.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0);}
vec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)
{vec3 viewDir=normalize(vec3(view*worldPos));vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));vec3 r=reflect(viewDir,viewNormal);r=vec3(reflectionMatrix*vec4(r,0));r.z=r.z-1.0;float m=2.0*length(r);return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);}
vec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 viewDir=worldPos.xyz-eyePosition;vec3 coords=normalize(reflect(viewDir,worldNormal));return vec3(reflectionMatrix*vec4(coords,1));}
vec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
vec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)
{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
vec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)
{return vec3(reflectionMatrix*(view*worldPos));}
vec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)
{return vec3(reflectionMatrix*vec4(positionW,1.));}
#ifdef REFLECTION
vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(vPositionUVW,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3(0,0,0);
#endif
}
#endif
`;Q.IncludesShadersStore[NC]=BC;const kC="decalFragment",UC=`#ifdef DECAL
#ifdef GAMMADECAL
decalColor.rgb=toLinearSpace(decalColor.rgb);
#endif
#ifdef DECAL_SMOOTHALPHA
decalColor.a*=decalColor.a;
#endif
surfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,decalColor.rgb,decalColor.a);
#endif
`;Q.IncludesShadersStore[kC]=UC;const VC="pbrBlockAlbedoOpacity",GC=`struct albedoOpacityOutParams
{vec3 surfaceAlbedo;float alpha;};
#define pbr_inline
void albedoOpacityBlock(
in vec4 vAlbedoColor,
#ifdef ALBEDO
in vec4 albedoTexture,
in vec2 albedoInfos,
#endif
#ifdef OPACITY
in vec4 opacityMap,
in vec2 vOpacityInfos,
#endif
#ifdef DETAIL
in vec4 detailColor,
in vec4 vDetailInfos,
#endif
#ifdef DECAL
in vec4 decalColor,
in vec4 vDecalInfos,
#endif
out albedoOpacityOutParams outParams
)
{vec3 surfaceAlbedo=vAlbedoColor.rgb;float alpha=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpace(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifndef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=vColor.rgb;
#endif
#ifdef DETAIL
float detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#ifdef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST 
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;}
`;Q.IncludesShadersStore[VC]=GC;const zC="pbrBlockReflectivity",HC=`struct reflectivityOutParams
{float microSurface;float roughness;vec3 surfaceReflectivityColor;
#ifdef METALLICWORKFLOW
vec3 surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
vec3 ambientOcclusionColor;
#endif
#if DEBUGMODE>0
#ifdef METALLICWORKFLOW
vec2 metallicRoughness;
#ifdef REFLECTIVITY
vec4 surfaceMetallicColorMap;
#endif
#ifndef FROSTBITE_REFLECTANCE
vec3 metallicF0;
#endif
#else
#ifdef REFLECTIVITY
vec4 surfaceReflectivityColorMap;
#endif
#endif
#endif
};
#define pbr_inline
void reflectivityBlock(
in vec4 vReflectivityColor,
#ifdef METALLICWORKFLOW
in vec3 surfaceAlbedo,
in vec4 metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
in vec3 reflectivityInfos,
in vec4 surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
in vec3 ambientOcclusionColorIn,
#endif
#ifdef MICROSURFACEMAP
in vec4 microSurfaceTexel,
#endif
#ifdef DETAIL
in vec4 detailColor,
in vec4 vDetailInfos,
#endif
out reflectivityOutParams outParams
)
{float microSurface=vReflectivityColor.a;vec3 surfaceReflectivityColor=vReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec2 metallicRoughness=surfaceReflectivityColor.rg;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
vec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#if DEBUGMODE>0
outParams.metallicRoughness=metallicRoughness;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;vec3 baseColor=surfaceAlbedo;
#ifdef FROSTBITE_REFLECTANCE
outParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);
#else
vec3 metallicF0=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=metallicF0;
#endif
outParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
#endif
microSurface=saturate(microSurface);float roughness=1.-microSurface;outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.surfaceReflectivityColor=surfaceReflectivityColor;}
`;Q.IncludesShadersStore[zC]=HC;const WC="pbrBlockAmbientOcclusion",XC=`struct ambientOcclusionOutParams
{vec3 ambientOcclusionColor;
#if DEBUGMODE>0 && defined(AMBIENT)
vec3 ambientOcclusionColorMap;
#endif
};
#define pbr_inline
void ambientOcclusionBlock(
#ifdef AMBIENT
in vec3 ambientOcclusionColorMap_,
in vec4 vAmbientInfos,
#endif
out ambientOcclusionOutParams outParams
)
{vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;}
`;Q.IncludesShadersStore[WC]=XC;const YC="pbrBlockAlphaFresnel",KC=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{float alpha;};
#define pbr_inline
void alphaFresnelBlock(
in vec3 normalW,
in vec3 viewDirectionW,
in float alpha,
in float microSurface,
out alphaFresnelOutParams outParams
)
{float opacityPerceptual=alpha;
#ifdef LINEARALPHAFRESNEL
float opacity0=opacityPerceptual;
#else
float opacity0=opacityPerceptual*opacityPerceptual;
#endif
float opacity90=fresnelGrazingReflectance(opacity0);vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
}
#endif
#endif
`;Q.IncludesShadersStore[YC]=KC;const QC="pbrBlockAnisotropic",ZC=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;vec3 anisotropicNormal;
#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)
vec3 anisotropyMapData;
#endif
};
#define pbr_inline
void anisotropicBlock(
in vec3 vAnisotropy,
in float roughness,
#ifdef ANISOTROPIC_TEXTURE
in vec3 anisotropyMapData,
#endif
in mat3 TBN,
in vec3 normalW,
in vec3 viewDirectionW,
out anisotropicOutParams outParams
)
{float anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
anisotropy*=anisotropyMapData.b;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
anisotropyMapData.rg=anisotropyMapData.rg*2.0-1.0;
#ifdef ANISOTROPIC_LEGACY
anisotropyDirection.rg*=anisotropyMapData.rg;
#else
anisotropyDirection.xy=mat2(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(anisotropyMapData.rg);
#endif
#endif
mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);}
#endif
`;Q.IncludesShadersStore[QC]=ZC;const qC="pbrBlockReflection",jC=`#ifdef REFLECTION
struct reflectionOutParams
{vec4 environmentRadiance;vec3 environmentIrradiance;
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords;
#else
vec2 reflectionCoords;
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
vec3 irradianceVector;
#endif
#endif
#endif
};
#define pbr_inline
void createReflectionCoords(
in vec3 vPositionW,
in vec3 normalW,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REFLECTIONMAP_3D
out vec3 reflectionCoords
#else
out vec2 reflectionCoords
#endif
)
{
#ifdef ANISOTROPIC
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
}
#define pbr_inline
#define inline
void sampleReflectionTexture(
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
const vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
const vec2 reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out vec4 environmentRadiance
)
{
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
float automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);
#else
float requestedReflectionLOD=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#else
float lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);} else {environmentRadiance=mix(
environmentMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
environmentRadiance.rgb*=vReflectionInfos.x;environmentRadiance.rgb*=vReflectionColor.rgb;}
#define pbr_inline
#define inline
void reflectionBlock(
in vec3 vPositionW,
in vec3 normalW,
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
#else
in sampler2D reflectionSampler,
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
in vec3 vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
in mat4 reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
in samplerCube irradianceSampler,
#else
in sampler2D irradianceSampler,
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out reflectionOutParams outParams
)
{vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.);
#else
vec2 reflectionCoords=vec2(0.);
#endif
createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
reflectionCoords
);sampleReflectionTexture(
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
#ifdef REFLECTIONMAP_3D
reflectionSampler,
reflectionCoords,
#else
reflectionSampler,
reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentRadiance
);vec3 environmentIrradiance=vec3(0.,0.,0.);
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#ifdef ANISOTROPIC
vec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;
#else
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb;outParams.environmentRadiance=environmentRadiance;outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;}
#endif
`;Q.IncludesShadersStore[qC]=jC;const $C="pbrBlockSheen",JC=`#ifdef SHEEN
struct sheenOutParams
{float sheenIntensity;vec3 sheenColor;float sheenRoughness;
#ifdef SHEEN_LINKWITHALBEDO
vec3 surfaceAlbedo;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
float sheenAlbedoScaling;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 finalSheenRadianceScaled;
#endif
#if DEBUGMODE>0
#ifdef SHEEN_TEXTURE
vec4 sheenMapData;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 sheenEnvironmentReflectance;
#endif
#endif
};
#define pbr_inline
#define inline
void sheenBlock(
in vec4 vSheenColor,
#ifdef SHEEN_ROUGHNESS
in float vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
in vec4 sheenMapRoughnessData,
#endif
#endif
in float roughness,
#ifdef SHEEN_TEXTURE
in vec4 sheenMapData,
in float sheenMapLevel,
#endif
in float reflectance,
#ifdef SHEEN_LINKWITHALBEDO
in vec3 baseColor,
in vec3 surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
in float NdotV,
in vec3 environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
in vec2 AARoughnessFactors,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
in vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
in vec2 reflectionCoords,
#endif
in float NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
in float seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
in float eho,
#endif
#endif
out sheenOutParams outParams
)
{float sheenIntensity=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
float sheenFactor=pow5(1.0-sheenIntensity);vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);float sheenRoughness=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
vec3 sheenColor=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor.rgb*=toLinearSpace(sheenMapData.rgb);
#else
sheenColor.rgb*=sheenMapData.rgb;
#endif
sheenColor.rgb*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
float sheenRoughness=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
#ifdef SHEEN_TEXTURE_ROUGHNESS_IDENTICAL
sheenRoughness*=sheenMapData.a;
#else
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#endif
#else
float sheenRoughness=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
vec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
vec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);
#else
vec3 environmentSheenBrdf=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
float sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
vec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);sampleReflectionTexture(
sheenAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
sheenRoughness,
#endif
reflectionSampler,
reflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentSheenRadiance
);vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;}
#endif
`;Q.IncludesShadersStore[$C]=JC;const eI="pbrBlockClearcoat",tI=`struct clearcoatOutParams
{vec3 specularEnvironmentR0;float conservationFactor;vec3 clearCoatNormalW;vec2 clearCoatAARoughnessFactors;float clearCoatIntensity;float clearCoatRoughness;
#ifdef REFLECTION
vec3 finalClearCoatRadianceScaled;
#endif
#ifdef CLEARCOAT_TINT
vec3 absorption;float clearCoatNdotVRefract;vec3 clearCoatColor;float clearCoatThickness;
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
vec3 energyConservationFactorClearCoat;
#endif
#if DEBUGMODE>0
#ifdef CLEARCOAT_BUMP
mat3 TBNClearCoat;
#endif
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData;
#endif
#ifdef REFLECTION
vec4 environmentClearCoatRadiance;vec3 clearCoatEnvironmentReflectance;
#endif
float clearCoatNdotV;
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
#define inline
void clearcoatBlock(
in vec3 vPositionW,
in vec3 geometricNormalW,
in vec3 viewDirectionW,
in vec2 vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
in vec4 clearCoatMapRoughnessData,
#endif
in vec3 specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
in vec2 clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
in vec4 vClearCoatTintParams,
in float clearCoatColorAtDistance,
in vec4 vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
in vec4 clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
in vec2 vClearCoatBumpInfos,
in vec4 clearCoatBumpMapData,
in vec2 vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
in mat3 vTBN,
#else
in vec2 vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
in mat4 normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
in vec3 faceNormal,
#endif
#ifdef REFLECTION
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
#else
in sampler2D reflectionSampler,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
in float ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
in float frontFacingMultiplier,
#endif
out clearcoatOutParams outParams
)
{float clearCoatIntensity=vClearCoatParams.x;float clearCoatRoughness=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL
clearCoatRoughness*=clearCoatMapData.y;
#else
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
#endif
outParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
vec3 clearCoatColor=vClearCoatTintParams.rgb;float clearCoatThickness=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
vec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
vec3 specularEnvironmentR0Updated=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);vec3 clearCoatNormalW=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
float clearCoatNormalScale=1.0;
#else
float clearCoatNormalScale=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBNClearCoat=vTBN;
#else
vec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
vec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
vec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
float clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
vec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 clearCoatReflectionCoords=clearCoatReflectionVector;
#else
vec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
sampleReflectionTexture(
clearCoatAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
clearCoatNdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
clearCoatRoughness,
#endif
reflectionSampler,
clearCoatReflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentClearCoatRadiance
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
vec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
float fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
}
#endif
`;Q.IncludesShadersStore[eI]=tI;const iI="pbrBlockIridescence",nI=`struct iridescenceOutParams
{float iridescenceIntensity;float iridescenceIOR;float iridescenceThickness;vec3 specularEnvironmentR0;};
#ifdef IRIDESCENCE
#define pbr_inline
#define inline
void iridescenceBlock(
in vec4 vIridescenceParams,
in float viewAngle,
in vec3 specularEnvironmentR0,
#ifdef IRIDESCENCE_TEXTURE
in vec2 iridescenceMapData,
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
in vec2 iridescenceThicknessMapData,
#endif
#ifdef CLEARCOAT
in float NdotVUnclamped,
#ifdef CLEARCOAT_TEXTURE
in vec2 clearCoatMapData,
#endif
#endif
out iridescenceOutParams outParams
)
{float iridescenceIntensity=vIridescenceParams.x;float iridescenceIOR=vIridescenceParams.y;float iridescenceThicknessMin=vIridescenceParams.z;float iridescenceThicknessMax=vIridescenceParams.w;float iridescenceThicknessWeight=1.;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#ifdef IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE
iridescenceThicknessWeight=iridescenceMapData.g;
#endif
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
float iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);float topIor=1.; 
#ifdef CLEARCOAT
float clearCoatIntensity=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));
#endif
vec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;}
#endif
`;Q.IncludesShadersStore[iI]=nI;const sI="pbrBlockSubSurface",rI=`struct subSurfaceOutParams
{vec3 specularEnvironmentReflectance;
#ifdef SS_REFRACTION
vec3 finalRefraction;vec3 surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
float alpha;
#endif
#ifdef REFLECTION
float refractionFactorForIrradiance;
#endif
#endif
#ifdef SS_TRANSLUCENCY
vec3 transmittance;float translucencyIntensity;
#ifdef REFLECTION
vec3 refractionIrradiance;
#endif
#endif
#if DEBUGMODE>0
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction;vec3 refractionTransmittance;
#endif
#endif
};
#ifdef SUBSURFACE
#define pbr_inline
#define inline
void subSurfaceBlock(
in vec3 vSubSurfaceIntensity,
in vec2 vThicknessParam,
in vec4 vTintColor,
in vec3 normalW,
in vec3 specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
in vec4 thicknessMap,
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
in vec4 refractionIntensityMap,
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
in vec4 translucencyIntensityMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
in mat4 reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
in vec3 irradianceVector_,
#endif
#if defined(REALTIME_FILTERING)
in samplerCube reflectionSampler,
in vec2 vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
in samplerCube irradianceSampler,
#else
in sampler2D irradianceSampler,
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
in vec3 surfaceAlbedo,
#endif
#ifdef SS_REFRACTION
in vec3 vPositionW,
in vec3 viewDirectionW,
in mat4 view,
in vec4 vRefractionInfos,
in mat4 refractionMatrix,
in vec4 vRefractionMicrosurfaceInfos,
in vec4 vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
in float alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
in float NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
in float roughness,
#endif
in float alphaG,
#ifdef SS_REFRACTIONMAP_3D
in samplerCube refractionSampler,
#ifndef LODBASEDMICROSFURACE
in samplerCube refractionSamplerLow,
in samplerCube refractionSamplerHigh,
#endif
#else
in sampler2D refractionSampler,
#ifndef LODBASEDMICROSFURACE
in sampler2D refractionSamplerLow,
in sampler2D refractionSamplerHigh,
#endif
#endif
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
in vec2 vRefractionFilteringInfo,
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
in vec3 refractionPosition,
in vec3 refractionSize,
#endif
#endif
#ifdef SS_TRANSLUCENCY
in vec3 vDiffusionDistance,
#endif
out subSurfaceOutParams outParams
)
{outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
float refractionIntensity=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
float translucencyIntensity=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#if defined(SS_USE_GLTF_TEXTURES)
float thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
float thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#ifdef SS_MASK_FROM_THICKNESS_TEXTURE
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE)
#if defined(SS_USE_GLTF_TEXTURES)
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE)
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
float thickness=vThicknessParam.y;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);vec3 transmittance=transmittanceBRDF_Burley(vTintColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef ANISOTROPIC
vec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,vRefractionInfos.y);
#else
vec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec3 refractionCoords=refractionVector;refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
#endif
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef SS_HAS_THICKNESS
float ior=vRefractionInfos.y;
#else
float ior=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
float refractionRoughness=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
#ifdef LODBASEDMICROSFURACE
refractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
float automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);
#else
float requestedRefractionLOD=refractionLOD;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
float lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(
sampleRefraction(refractionSamplerHigh,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);} else {environmentRefraction=mix(
environmentRefractionMid,
sampleRefraction(refractionSamplerLow,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);}
#endif
#ifdef SS_RGBDREFRACTION
environmentRefraction.rgb=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
environmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);
#endif
environmentRefraction.rgb*=vRefractionInfos.x;
#endif
#ifdef SS_REFRACTION
vec3 refractionTransmittance=vec3(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
float maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);environmentRefraction.rgb*=volumeAlbedo;
#else
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction.rgb*=surfaceAlbedo.rgb;
#endif
outParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);
#ifdef REFLECTION
outParams.refractionFactorForIrradiance=(1.-refractionIntensity);
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
vec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
refractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
vec3 irradianceVector=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
vec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);
#else
vec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec3 irradianceCoords=irradianceVector;
#else
vec2 irradianceCoords=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
vec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);
#ifdef RGBDREFLECTION
refractionIrradiance.rgb=fromRGBD(refractionIrradiance);
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);
#endif
#else
vec4 refractionIrradiance=vec4(0.);
#endif
refractionIrradiance.rgb*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance.rgb*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance.rgb;
#endif
}
#endif
`;Q.IncludesShadersStore[sI]=rI;const aI="clipPlaneFragment",oI=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fClipDistance>0.0)
{discard;}
#endif
#ifdef CLIPPLANE2
else if (fClipDistance2>0.0)
{discard;}
#endif
#ifdef CLIPPLANE3
else if (fClipDistance3>0.0)
{discard;}
#endif
#ifdef CLIPPLANE4
else if (fClipDistance4>0.0)
{discard;}
#endif
#ifdef CLIPPLANE5
else if (fClipDistance5>0.0)
{discard;}
#endif
#ifdef CLIPPLANE6
else if (fClipDistance6>0.0)
{discard;}
#endif
`;Q.IncludesShadersStore[aI]=oI;const lI="pbrBlockNormalGeometric",cI=`vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
vec3 geometricNormalW=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;
#endif
`;Q.IncludesShadersStore[lI]=cI;const uI="bumpFragment",hI=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(BUMP)
float normalScale=vBumpInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(BUMP)
vec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);vec2 detailNormalRG=detailColor.wy*2.0-1.0;float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);
#else
vec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;bumpNormal+=vec3(0.0,0.0,1.0);detailNormal*=vec3(-1.0,-1.0,1.0);vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;Q.IncludesShadersStore[uI]=hI;const dI="pbrBlockNormalFinal",fI=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
`;Q.IncludesShadersStore[dI]=fI;const pI="depthPrePass",mI=`#ifdef DEPTHPREPASS
gl_FragColor=vec4(0.,0.,0.,1.0);return;
#endif
`;Q.IncludesShadersStore[pI]=mI;const _I="pbrBlockLightmapInit",gI=`#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor.rgb=toLinearSpace(lightmapColor.rgb);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
`;Q.IncludesShadersStore[_I]=gI;const EI="pbrBlockGeometryInfo",vI=`float NdotVUnclamped=dot(normalW,viewDirectionW);float NdotV=absEps(NdotVUnclamped);float alphaG=convertRoughnessToAverageSlope(roughness);vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
vec3 environmentBrdf=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
float ambientMonochrome=aoOut.ambientOcclusionColor.r;
#else
float ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);
#endif
float seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;Q.IncludesShadersStore[EI]=vI;const yI="pbrBlockReflectance0",AI=`float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);
#else 
vec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);
#endif
#ifdef ALPHAFRESNEL
float reflectance90=fresnelGrazingReflectance(reflectance);specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;Q.IncludesShadersStore[yI]=AI;const TI="pbrBlockReflectance",SI=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);
#ifdef RADIANCEOCCLUSION
specularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
specularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
vec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
specularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
specularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;Q.IncludesShadersStore[TI]=SI;const CI="pbrBlockDirectLighting",II=`vec3 diffuseBase=vec3(0.,0.,0.);
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
#ifdef CLEARCOAT
vec3 clearCoatBase=vec3(0.,0.,0.);
#endif
#ifdef SHEEN
vec3 sheenBase=vec3(0.,0.,0.);
#endif
preLightingInfo preInfo;lightingInfo info;float shadow=1.; 
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
vec3 absorption=vec3(0.);
#endif
`;Q.IncludesShadersStore[CI]=II;const RI="lightFragment",bI=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
#ifdef PBR
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#ifdef HEMILIGHT{X}
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);
#elif defined(SS_TRANSLUCENCY)
info.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#else
info.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) 
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;
#else
diff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {index{X}=i;break;}}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
float frustumLength=frustumLengths{X}[index{X}];float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{index{X}+=1;float nextShadow=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else 
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;Q.IncludesShadersStore[RI]=bI;const xI="pbrBlockFinalLitComponents",MI=`#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef REFLECTION
vec3 finalIrradiance=reflectionOut.environmentIrradiance;
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
finalIrradiance*=surfaceAlbedo.rgb;finalIrradiance*=vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase;finalSpecular=max(finalSpecular,0.0);vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
vec3 finalRadiance=reflectionOut.environmentRadiance.rgb;finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
vec3 finalSheen=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,0.0);vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
vec3 finalClearCoat=clearCoatBase;finalClearCoat=max(finalClearCoat,0.0);vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
float luminanceOverAlpha=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;Q.IncludesShadersStore[xI]=MI;const PI="pbrBlockFinalUnlitComponents",DI=`vec3 finalDiffuse=diffuseBase;finalDiffuse*=surfaceAlbedo.rgb;finalDiffuse=max(finalDiffuse,0.0);finalDiffuse*=vLightingIntensity.x;vec3 finalAmbient=vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;vec3 finalEmissive=vEmissiveColor;
#ifdef EMISSIVE
vec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpace(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= vEmissiveInfos.y;
#endif
finalEmissive*=vLightingIntensity.y;
#ifdef AMBIENT
vec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);
#else
vec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;Q.IncludesShadersStore[PI]=DI;const OI="pbrBlockFinalColorComposition",wI=`vec4 finalColor=vec4(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor.rgb*=lightmapColor.rgb;
#else
finalColor.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
finalColor.rgb+=finalEmissive;
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,0.0);
`;Q.IncludesShadersStore[OI]=wI;const FI="logDepthFragment",LI=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;Q.IncludesShadersStore[FI]=LI;const NI="fogFragment",BI=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;Q.IncludesShadersStore[NI]=BI;const kI="pbrBlockImageProcessing",UI=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor.rgb=clamp(finalColor.rgb,0.,30.0);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor.a*=visibility;
#ifdef PREMULTIPLYALPHA
finalColor.rgb*=finalColor.a;
#endif
`;Q.IncludesShadersStore[kI]=UI;const VI="oitFragment",GI=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
float fragDepth=gl_FragCoord.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
uint halfFloat=packHalf2x16(vec2(fragDepth));vec2 full=unpackHalf2x16(halfFloat);fragDepth=full.x;
#endif
ivec2 fragCoord=ivec2(gl_FragCoord.xy);vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);depth.rg=vec2(-MAX_DEPTH);frontColor=lastFrontColor;backColor=vec4(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
float furthestDepth=-lastDepth.x;float nearestDepth=lastDepth.y;
#else
float nearestDepth=-lastDepth.x;float furthestDepth=lastDepth.y;
#endif
float alphaMultiplier=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return;}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
depth.rg=vec2(-fragDepth,fragDepth);return;}
#endif
`;Q.IncludesShadersStore[VI]=GI;const zI="pbrDebug",HI=`#if DEBUGMODE>0
if (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {
#if DEBUGMODE==1
gl_FragColor.rgb=vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
gl_FragColor.rgb=vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
gl_FragColor.rgb=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
gl_FragColor.rgb=vec3(vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
gl_FragColor.rgb=vec3(vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
gl_FragColor.rgb=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
gl_FragColor.rgb=albedoTexture.rgb;
#ifndef GAMMAALBEDO
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==21 && defined(AMBIENT)
gl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
gl_FragColor.rgb=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
gl_FragColor.rgb=emissiveColorTex.rgb;
#ifndef GAMMAEMISSIVE
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==24 && defined(LIGHTMAP)
gl_FragColor.rgb=lightmapColor.rgb;
#ifndef GAMMALIGHTMAP
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
gl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
gl_FragColor.rgb=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
gl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
gl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==32 && defined(BUMP)
gl_FragColor.rgb=texture2D(bumpSampler,vBumpUV).rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
gl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
gl_FragColor.rgb=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
gl_FragColor.rgb=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
gl_FragColor.rgb=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
gl_FragColor.rgb=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==60
gl_FragColor.rgb=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
gl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
gl_FragColor.rgb=vec3(roughness);
#elif DEBUGMODE==64
gl_FragColor.rgb=vec3(alphaG);
#elif DEBUGMODE==65
gl_FragColor.rgb=vec3(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
gl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
gl_FragColor.rgb=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==72
gl_FragColor.rgb=vec3(microSurface);
#elif DEBUGMODE==73
gl_FragColor.rgb=vAlbedoColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=vReflectivityColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==75
gl_FragColor.rgb=vEmissiveColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
gl_FragColor.rgb=vec3(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION)
gl_FragColor.rgb=vec3(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
gl_FragColor.rgb=vec3(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=specularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
gl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
gl_FragColor.rgb=vec3(luminanceOverAlpha);
#elif DEBUGMODE==87
gl_FragColor.rgb=vec3(alpha);
#elif DEBUGMODE==88 && defined(ALBEDO)
gl_FragColor.rgb=vec3(albedoTexture.a);
#else
float stripeWidth=30.;float stripePos=floor((gl_FragCoord.x+gl_FragCoord.y)/stripeWidth);float whichColor=mod(stripePos,2.);vec3 color1=vec3(.6,.2,.2);vec3 color2=vec3(.3,.1,.1);gl_FragColor.rgb=mix(color1,color2,whichColor);
#endif
gl_FragColor.rgb*=vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
gl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
gl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);
#endif
gl_FragColor.a=1.0;
#ifdef PREPASS
gl_FragData[0]=toLinearSpace(gl_FragColor); 
gl_FragData[1]=vec4(0.,0.,0.,0.); 
#endif
}
#endif
`;Q.IncludesShadersStore[zI]=HI;const WI="pbrPixelShader",XI=`#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
precision highp float;
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<__decl__pbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
albedoOpacityOutParams albedoOpacityOut;
#ifdef ALBEDO
vec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
#ifdef DECAL
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#endif
albedoOpacityBlock(
vAlbedoColor,
#ifdef ALBEDO
albedoTexture,
vAlbedoInfos,
#endif
#ifdef OPACITY
opacityMap,
vOpacityInfos,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
#ifdef DECAL
decalColor,
vDecalInfos,
#endif
albedoOpacityOut
);vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;float alpha=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
ambientOcclusionOutParams aoOut;
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;
#endif
ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
vAmbientInfos,
#endif
aoOut
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
vec3 diffuseBase=vec3(1.,1.,1.);
#else
vec3 baseColor=surfaceAlbedo;reflectivityOutParams reflectivityOut;
#if defined(REFLECTIVITY)
vec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;
#endif
#endif
#if defined(MICROSURFACEMAP)
vec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
vec4 metallicReflectanceFactors=vMetallicReflectanceFactors;
#ifdef REFLECTANCE
vec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);
#endif
metallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;
#endif
#ifdef METALLIC_REFLECTANCE
vec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;
#endif
metallicReflectanceFactors*=metallicReflectanceFactorsMap.a;
#endif
#endif
reflectivityBlock(
vReflectivityColor,
#ifdef METALLICWORKFLOW
surfaceAlbedo,
metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
vReflectivityInfos,
surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor,
#endif
#ifdef MICROSURFACEMAP
microSurfaceTexel,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
reflectivityOut
);float microSurface=reflectivityOut.microSurface;float roughness=reflectivityOut.roughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
alphaFresnelOutParams alphaFresnelOut;alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface,
alphaFresnelOut
);alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
anisotropicOutParams anisotropicOut;
#ifdef ANISOTROPIC_TEXTURE
vec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;
#endif
anisotropicBlock(
vAnisotropy,
roughness,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW,
anisotropicOut
);
#endif
#ifdef REFLECTION
reflectionOutParams reflectionOut;
#ifndef USE_CUSTOM_REFLECTION
reflectionBlock(
vPositionW,
normalW,
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
reflectionSampler,
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
reflectionOut
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
sheenOutParams sheenOut;
#ifdef SHEEN_TEXTURE
vec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;
#endif
sheenBlock(
vSheenColor,
#ifdef SHEEN_ROUGHNESS
vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
sheenMapRoughnessData,
#endif
#endif
roughness,
#ifdef SHEEN_TEXTURE
sheenMapData,
vSheenInfos.y,
#endif
reflectance,
#ifdef SHEEN_LINKWITHALBEDO
baseColor,
surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
NdotV,
environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
AARoughnessFactors,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
reflectionOut.reflectionCoords,
NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
eho,
#endif
#endif
sheenOut
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
iridescenceOutParams iridescenceOut;
#ifdef IRIDESCENCE_TEXTURE
vec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
vec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;
#endif
iridescenceBlock(
vIridescenceParams,
NdotV,
specularEnvironmentR0,
#ifdef IRIDESCENCE_TEXTURE
iridescenceMapData,
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
iridescenceThicknessMapData,
#endif
#ifdef CLEARCOAT
NdotVUnclamped,
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData,
#endif
#endif
iridescenceOut
);float iridescenceIntensity=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
clearcoatOutParams clearcoatOut;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
vec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);
#endif
clearcoatBlock(
vPositionW,
geometricNormalW,
viewDirectionW,
vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatMapRoughnessData,
#endif
specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
vClearCoatTintParams,
clearCoatColorAtDistance,
vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
vClearCoatBumpInfos,
clearCoatBumpMapData,
vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
vTBN,
#else
vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
faceNormal,
#endif
#ifdef REFLECTION
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
(gl_FrontFacing ? 1. : -1.),
#endif
clearcoatOut
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
subSurfaceOutParams subSurfaceOut;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
vec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
vec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);
#endif
subSurfaceBlock(
vSubSurfaceIntensity,
vThicknessParam,
vTintColor,
normalW,
specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
thicknessMap,
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
refractionIntensityMap,
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
translucencyIntensityMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionOut.irradianceVector,
#endif
#if defined(REALTIME_FILTERING)
reflectionSampler,
vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
surfaceAlbedo,
#endif
#ifdef SS_REFRACTION
vPositionW,
viewDirectionW,
view,
vRefractionInfos,
refractionMatrix,
vRefractionMicrosurfaceInfos,
vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
roughness,
#endif
alphaG,
refractionSampler,
#ifndef LODBASEDMICROSFURACE
refractionSamplerLow,
refractionSamplerHigh,
#endif
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
vRefractionFilteringInfo,
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
vRefractionPosition,
vRefractionSize,
#endif
#endif
#ifdef SS_TRANSLUCENCY
vDiffusionDistance,
#endif
subSurfaceOut
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=finalColor.a>0.4 ? 1.0 : 0.0;
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
vec3 sqAlbedo=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
vec3 irradiance=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
gl_FragData[0]=vec4(finalColor.rgb-irradiance,finalColor.a); 
irradiance/=sqAlbedo;
#else
gl_FragData[0]=finalColor; 
float scatteringDiffusionProfile=255.;
#endif
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); 
#else
gl_FragData[0]=vec4(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;Q.ShadersStore[WI]=XI;const YI="decalVertexDeclaration",KI=`#ifdef DECAL
uniform vec4 vDecalInfos;uniform mat4 decalMatrix;
#endif
`;Q.IncludesShadersStore[YI]=KI;const QI="pbrVertexDeclaration",ZI=`uniform mat4 view;uniform mat4 viewProjection;
#ifdef ALBEDO
uniform mat4 albedoMatrix;uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec4 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#ifdef REFLECTIVITY 
uniform vec3 vReflectivityInfos;uniform mat4 reflectivityMatrix;
#endif
#ifdef METALLIC_REFLECTANCE
uniform vec2 vMetallicReflectanceInfos;uniform mat4 metallicReflectanceMatrix;
#endif
#ifdef REFLECTANCE
uniform vec2 vReflectanceInfos;uniform mat4 reflectanceMatrix;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;uniform mat4 microSurfaceSamplerMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#ifdef IRIDESCENCE
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;Q.IncludesShadersStore[QI]=ZI;const qI="uvAttributeDeclaration",jI=`#ifdef UV{X}
attribute vec2 uv{X};
#endif
`;Q.IncludesShadersStore[qI]=jI;const $I="bonesDeclaration",JI=`#if NUM_BONE_INFLUENCERS>0
attribute vec4 matricesIndices;attribute vec4 matricesWeights;
#if NUM_BONE_INFLUENCERS>4
attribute vec4 matricesIndicesExtra;attribute vec4 matricesWeightsExtra;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
uniform sampler2D boneSampler;uniform float boneTextureWidth;
#else
uniform mat4 mBones[BonesPerMesh];
#ifdef BONES_VELOCITY_ENABLED
uniform mat4 mPreviousBones[BonesPerMesh];
#endif
#endif
#ifdef BONETEXTURE
#define inline
mat4 readMatrixFromRawSampler(sampler2D smp,float index)
{float offset=index *4.0;float dx=1.0/boneTextureWidth;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));return mat4(m0,m1,m2,m3);}
#endif
#endif
#endif
`;Q.IncludesShadersStore[$I]=JI;const eR="bakedVertexAnimationDeclaration",tR=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform float bakedVertexAnimationTime;uniform vec2 bakedVertexAnimationTextureSizeInverted;uniform vec4 bakedVertexAnimationSettings;uniform sampler2D bakedVertexAnimationTexture;
#ifdef INSTANCES
attribute vec4 bakedVertexAnimationSettingsInstanced;
#endif
#define inline
mat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)
{float offset=index*4.0;float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;float dx=bakedVertexAnimationTextureSizeInverted.x;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));return mat4(m0,m1,m2,m3);}
#endif
`;Q.IncludesShadersStore[eR]=tR;const iR="instancesDeclaration",nR=`#ifdef INSTANCES
attribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;
#ifdef INSTANCESCOLOR
attribute vec4 instanceColor;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
attribute vec4 previousWorld0;attribute vec4 previousWorld1;attribute vec4 previousWorld2;attribute vec4 previousWorld3;
#ifdef THIN_INSTANCES
uniform mat4 previousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
uniform mat4 previousWorld;
#endif
#endif
`;Q.IncludesShadersStore[iR]=nR;const sR="prePassVertexDeclaration",rR=`#ifdef PREPASS
#ifdef PREPASS_DEPTH
varying vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
uniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#endif
`;Q.IncludesShadersStore[sR]=rR;const aR="samplerVertexDeclaration",oR=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying vec2 v_VARYINGNAME_UV;
#endif
`;Q.IncludesShadersStore[aR]=oR;const lR="bumpVertexDeclaration",cR=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;Q.IncludesShadersStore[lR]=cR;const uR="clipPlaneVertexDeclaration",hR=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;varying float fClipDistance6;
#endif
`;Q.IncludesShadersStore[uR]=hR;const dR="fogVertexDeclaration",fR=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;Q.IncludesShadersStore[dR]=fR;const pR="lightVxFragmentDeclaration",mR=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#endif
`;Q.IncludesShadersStore[pR]=mR;const _R="lightVxUboDeclaration",gR=`#ifdef LIGHT{X}
uniform Light{X}
{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;vec2 depthValues;} light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;Q.IncludesShadersStore[_R]=gR;const ER="morphTargetsVertexGlobalDeclaration",vR=`#ifdef MORPHTARGETS
uniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];
#ifdef MORPHTARGETS_TEXTURE 
precision mediump sampler2DArray; 
uniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];uniform vec3 morphTargetTextureInfo;uniform sampler2DArray morphTargets;vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)
{ 
float y=floor(vertexIndex/morphTargetTextureInfo.y);float x=vertexIndex-y*morphTargetTextureInfo.y;vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);return texture(morphTargets,textureUV).xyz;}
#endif
#endif
`;Q.IncludesShadersStore[ER]=vR;const yR="morphTargetsVertexDeclaration",AR=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
attribute vec3 position{X};
#ifdef MORPHTARGETS_NORMAL
attribute vec3 normal{X};
#endif
#ifdef MORPHTARGETS_TANGENT
attribute vec3 tangent{X};
#endif
#ifdef MORPHTARGETS_UV
attribute vec2 uv_{X};
#endif
#endif
#endif
`;Q.IncludesShadersStore[yR]=AR;const TR="morphTargetsVertexGlobal",SR=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
float vertexID;
#endif
#endif
`;Q.IncludesShadersStore[TR]=SR;const CR="morphTargetsVertex",IR=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE 
vertexID=float(gl_VertexID)*morphTargetTextureInfo.x;positionUpdated+=(readVector3FromRawSampler({X},vertexID)-position)*morphTargetInfluences[{X}];vertexID+=1.0;
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(readVector3FromRawSampler({X},vertexID) -normal)*morphTargetInfluences[{X}];vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(readVector3FromRawSampler({X},vertexID).xy-uv)*morphTargetInfluences[{X}];vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*morphTargetInfluences[{X}];
#endif
#else
positionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];
#endif
#endif
#endif
`;Q.IncludesShadersStore[CR]=IR;const RR="instancesVertex",bR=`#ifdef INSTANCES
mat4 finalWorld=mat4(world0,world1,world2,world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
finalWorld=world*finalWorld;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
mat4 finalWorld=world;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=previousWorld;
#endif
#endif
`;Q.IncludesShadersStore[RR]=bR;const xR="bonesVertex",MR=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
mat4 influence;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];
#endif
#else
influence=mBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=mBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=mBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=mBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;Q.IncludesShadersStore[xR]=MR;const PR="bakedVertexAnimation",DR=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
#define BVASNAME bakedVertexAnimationSettingsInstanced
#else
#define BVASNAME bakedVertexAnimationSettings
#endif
float VATStartFrame=BVASNAME.x;float VATEndFrame=BVASNAME.y;float VATOffsetFrame=BVASNAME.z;float VATSpeed=BVASNAME.w;float totalFrames=VATEndFrame-VATStartFrame+1.0;float time=bakedVertexAnimationTime*VATSpeed/totalFrames;float frameCorrection=time<1.0 ? 0.0 : 1.0;float numOfFrames=totalFrames-frameCorrection;float VATFrameNum=fract(time)*numOfFrames;VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);VATFrameNum=floor(VATFrameNum);VATFrameNum+=VATStartFrame+frameCorrection;mat4 VATInfluence;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;}
#endif
`;Q.IncludesShadersStore[PR]=DR;const OR="prePassVertex",wR=`#ifdef PREPASS_DEPTH
vViewPos=(view*worldPos).rgb;
#endif
#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
`;Q.IncludesShadersStore[OR]=wR;const FR="uvVariableDeclaration",LR=`#if !defined(UV{X}) && defined(MAINUV{X})
vec2 uv{X}=vec2(0.,0.);
#endif
#ifdef MAINUV{X}
vMainUV{X}=uv{X};
#endif
`;Q.IncludesShadersStore[FR]=LR;const NR="samplerVertexImplementation",BR=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (v_INFONAME_==0.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));}
#ifdef UV2
else if (v_INFONAME_==1.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));}
#endif
#ifdef UV3
else if (v_INFONAME_==2.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));}
#endif
#ifdef UV4
else if (v_INFONAME_==3.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));}
#endif
#ifdef UV5
else if (v_INFONAME_==4.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));}
#endif
#ifdef UV6
else if (v_INFONAME_==5.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));}
#endif
#endif
`;Q.IncludesShadersStore[NR]=BR;const kR="bumpVertex",UR=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);vec3 tbnTangent=normalize(tangentUpdated.xyz);vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;Q.IncludesShadersStore[kR]=UR;const VR="clipPlaneVertex",GR=`#ifdef CLIPPLANE
fClipDistance=dot(worldPos,vClipPlane);
#endif
#ifdef CLIPPLANE2
fClipDistance2=dot(worldPos,vClipPlane2);
#endif
#ifdef CLIPPLANE3
fClipDistance3=dot(worldPos,vClipPlane3);
#endif
#ifdef CLIPPLANE4
fClipDistance4=dot(worldPos,vClipPlane4);
#endif
#ifdef CLIPPLANE5
fClipDistance5=dot(worldPos,vClipPlane5);
#endif
#ifdef CLIPPLANE6
fClipDistance6=dot(worldPos,vClipPlane6);
#endif
`;Q.IncludesShadersStore[VR]=GR;const zR="fogVertex",HR=`#ifdef FOG
vFogDistance=(view*worldPos).xyz;
#endif
`;Q.IncludesShadersStore[zR]=HR;const WR="shadowsVertex",XR=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vPositionFromCamera{X}=view*worldPos;for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
}
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vPositionFromLight{X}=lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;Q.IncludesShadersStore[WR]=XR;const YR="vertexColorMixing",KR=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vColor=vec4(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vColor*=color;
#else
vColor.rgb*=color.rgb;
#endif
#endif
#ifdef INSTANCESCOLOR
vColor*=instanceColor;
#endif
#endif
`;Q.IncludesShadersStore[YR]=KR;const QR="logDepthVertex",ZR=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;Q.IncludesShadersStore[QR]=ZR;const qR="pbrVertexShader",jR=`precision highp float;
#include<__decl__pbrVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#endif
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);
#include<prePassVertex>
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;Q.ShadersStore[qR]=jR;class FE{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;const i=this._mesh.getScene();for(let n=0;n<i.meshes.length;n++){const r=i.meshes[n];if(!r.material){!this._mesh.material&&r.computeBonesUsingShaders&&r.numBoneInfluencers>0&&(r.computeBonesUsingShaders=!1);continue}if(!(!r.computeBonesUsingShaders||r.numBoneInfluencers===0)){if(r.material.getEffect()===t)r.computeBonesUsingShaders=!1;else if(r.subMeshes){for(const a of r.subMeshes)if(a.effect===t){r.computeBonesUsingShaders=!1;break}}}}}else{const i=this._defines[this._currentRank];if(i)for(let n=0;n<i.length;n++)e=e.replace("#define "+i[n],"");this._currentRank++}return e}}class $R extends Fs{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class Si extends Es{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRClearCoat",100,new $R,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=Si._DefaultIndexOfRefraction,this.indexOfRefraction=Si._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=G.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;const n=this._material._disableBumpMap;return!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Y.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&Y.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||i.getCaps().standardDerivatives&&this._bumpTexture&&Y.ClearCoatBumpTextureEnabled&&!n&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&Y.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((i=this._textureRoughness)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Y.ClearCoatTextureEnabled?se.PrepareDefinesForMergedUV(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&Y.ClearCoatTextureEnabled?se.PrepareDefinesForMergedUV(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&Y.ClearCoatBumpTextureEnabled?se.PrepareDefinesForMergedUV(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===Si._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&Y.ClearCoatTintTextureEnabled?(se.PrepareDefinesForMergedUV(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,n){var r,a,o,l,c,u,h,d;if(!this._isEnabled)return;const f=n.materialDefines,p=this._material.isFrozen,m=this._material._disableBumpMap,_=this._material._invertNormalMapX,E=this._material._invertNormalMapY,v=f.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL;if(!e.useUbo||!p||!e.isSync){v&&Y.ClearCoatTextureEnabled?(e.updateFloat4("vClearCoatInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),se.BindTextureMatrix(this._texture,e,"clearCoat")):(this._texture||this._textureRoughness)&&Y.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",(a=(r=this._texture)===null||r===void 0?void 0:r.coordinatesIndex)!==null&&a!==void 0?a:0,(l=(o=this._texture)===null||o===void 0?void 0:o.level)!==null&&l!==void 0?l:0,(u=(c=this._textureRoughness)===null||c===void 0?void 0:c.coordinatesIndex)!==null&&u!==void 0?u:0,(d=(h=this._textureRoughness)===null||h===void 0?void 0:h.level)!==null&&d!==void 0?d:0),this._texture&&se.BindTextureMatrix(this._texture,e,"clearCoat"),this._textureRoughness&&!v&&!f.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&se.BindTextureMatrix(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&Y.ClearCoatTextureEnabled&&!m&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),se.BindTextureMatrix(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",_?1:-1,E?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",_?-1:1,E?-1:1)),this._tintTexture&&Y.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),se.BindTextureMatrix(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const y=1-this._indexOfRefraction,A=1+this._indexOfRefraction,I=Math.pow(-y/A,2),T=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",I,T,y,A),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&Y.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!v&&!f.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&Y.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&Y.ClearCoatBumpTextureEnabled&&!m&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&Y.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){var t,i,n,r;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._textureRoughness)===null||i===void 0||i.dispose(),(n=this._bumpTexture)===null||n===void 0||n.dispose(),(r=this._tintTexture)===null||r===void 0||r.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}Si._DefaultIndexOfRefraction=1.5;S([b(),K("_markAllSubMeshesAsTexturesDirty")],Si.prototype,"isEnabled",void 0);S([b()],Si.prototype,"intensity",void 0);S([b()],Si.prototype,"roughness",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],Si.prototype,"indexOfRefraction",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],Si.prototype,"texture",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],Si.prototype,"useRoughnessFromMainTexture",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],Si.prototype,"textureRoughness",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],Si.prototype,"remapF0OnInterfaceChange",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],Si.prototype,"bumpTexture",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],Si.prototype,"isTintEnabled",void 0);S([Gi()],Si.prototype,"tintColor",void 0);S([b()],Si.prototype,"tintColorAtDistance",void 0);S([b()],Si.prototype,"tintThickness",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],Si.prototype,"tintTexture",void 0);class JR extends Fs{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0,this.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1}}class fn extends Es{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRIridescence",110,new JR,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=fn._DefaultMinimumThickness,this.maximumThickness=fn._DefaultMaximumThickness,this.indexOfRefraction=fn._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Y.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._thicknessTexture&&Y.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.IRIDESCENCE=!0,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=this._texture!==null&&this._texture._texture===((i=this._thicknessTexture)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._thicknessTexture),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Y.IridescenceTextureEnabled?se.PrepareDefinesForMergedUV(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,!e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&this._thicknessTexture&&Y.IridescenceTextureEnabled?se.PrepareDefinesForMergedUV(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t,i,n){var r,a,o,l,c,u,h,d;if(!this._isEnabled)return;const f=n.materialDefines,p=this._material.isFrozen,m=f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE;(!e.useUbo||!p||!e.isSync)&&(m&&Y.IridescenceTextureEnabled?(e.updateFloat4("vIridescenceInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),se.BindTextureMatrix(this._texture,e,"iridescence")):(this._texture||this._thicknessTexture)&&Y.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",(a=(r=this._texture)===null||r===void 0?void 0:r.coordinatesIndex)!==null&&a!==void 0?a:0,(l=(o=this._texture)===null||o===void 0?void 0:o.level)!==null&&l!==void 0?l:0,(u=(c=this._thicknessTexture)===null||c===void 0?void 0:c.coordinatesIndex)!==null&&u!==void 0?u:0,(d=(h=this._thicknessTexture)===null||h===void 0?void 0:h.level)!==null&&d!==void 0?d:0),this._texture&&se.BindTextureMatrix(this._texture,e,"iridescence"),this._thicknessTexture&&!m&&!f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&se.BindTextureMatrix(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&Y.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&!m&&!f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&Y.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){var t,i;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._thicknessTexture)===null||i===void 0||i.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}fn._DefaultMinimumThickness=100;fn._DefaultMaximumThickness=400;fn._DefaultIndexOfRefraction=1.3;S([b(),K("_markAllSubMeshesAsTexturesDirty")],fn.prototype,"isEnabled",void 0);S([b()],fn.prototype,"intensity",void 0);S([b()],fn.prototype,"minimumThickness",void 0);S([b()],fn.prototype,"maximumThickness",void 0);S([b()],fn.prototype,"indexOfRefraction",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],fn.prototype,"texture",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],fn.prototype,"thicknessTexture",void 0);class eb extends Fs{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.ANISOTROPIC_LEGACY=!1,this.MAINUV1=!1}}class wo extends Es{set angle(e){this.direction.x=Math.cos(e),this.direction.y=Math.sin(e)}get angle(){return Math.atan2(this.direction.y,this.direction.x)}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markAllSubMeshesAsMiscDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsMiscDirty()}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new eb,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new j(1,0),this._texture=null,this.texture=null,this._legacy=!1,this.legacy=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&Y.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking()):!0}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(C.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Y.AnisotropicTextureEnabled?se.PrepareDefinesForMergedUV(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1),e._areMiscDirty&&(e.ANISOTROPIC_LEGACY=this._legacy)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.ANISOTROPIC_LEGACY=!1)}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&(this._texture&&Y.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),se.BindTextureMatrix(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&Y.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}parse(e,t,i){super.parse(e,t,i),e.legacy===void 0&&(this.legacy=!0)}}S([b(),K("_markAllSubMeshesAsTexturesDirty")],wo.prototype,"isEnabled",void 0);S([b()],wo.prototype,"intensity",void 0);S([_E()],wo.prototype,"direction",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],wo.prototype,"texture",void 0);S([b(),K("_markAllSubMeshesAsMiscDirty")],wo.prototype,"legacy",void 0);class tb extends Fs{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1}}class Ls extends Es{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"Sheen",120,new tb,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=G.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Y.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&Y.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=this._roughness!==null,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((i=this._textureRoughness)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Y.SheenTextureEnabled?(se.PrepareDefinesForMergedUV(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&Y.SheenTextureEnabled?se.PrepareDefinesForMergedUV(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,n){var r,a,o,l,c,u,h,d;if(!this._isEnabled)return;const f=n.materialDefines,p=this._material.isFrozen,m=f.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;(!e.useUbo||!p||!e.isSync)&&(m&&Y.SheenTextureEnabled?(e.updateFloat4("vSheenInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),se.BindTextureMatrix(this._texture,e,"sheen")):(this._texture||this._textureRoughness)&&Y.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",(a=(r=this._texture)===null||r===void 0?void 0:r.coordinatesIndex)!==null&&a!==void 0?a:0,(l=(o=this._texture)===null||o===void 0?void 0:o.level)!==null&&l!==void 0?l:0,(u=(c=this._textureRoughness)===null||c===void 0?void 0:c.coordinatesIndex)!==null&&u!==void 0?u:0,(d=(h=this._textureRoughness)===null||h===void 0?void 0:h.level)!==null&&d!==void 0?d:0),this._texture&&se.BindTextureMatrix(this._texture,e,"sheen"),this._textureRoughness&&!m&&!f.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&se.BindTextureMatrix(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),this._roughness!==null&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&Y.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!m&&!f.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&Y.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){var t,i;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._textureRoughness)===null||i===void 0||i.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}S([b(),K("_markAllSubMeshesAsTexturesDirty")],Ls.prototype,"isEnabled",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],Ls.prototype,"linkSheenWithAlbedo",void 0);S([b()],Ls.prototype,"intensity",void 0);S([Gi()],Ls.prototype,"color",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],Ls.prototype,"texture",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],Ls.prototype,"useRoughnessFromMainTexture",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],Ls.prototype,"roughness",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],Ls.prototype,"textureRoughness",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],Ls.prototype,"albedoScaling",void 0);class ib extends Fs{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_SCATTERING=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_MASK_FROM_THICKNESS_TEXTURE=!1,this.SS_USE_GLTF_TEXTURES=!1}}class $t extends Es{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){e>=1?this._volumeIndexOfRefraction=e:this._volumeIndexOfRefraction=-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}constructor(e,t=!0){super(e,"PBRSubSurface",130,new ib,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=G.White(),this.tintColorAtDistance=1,this.diffusionDistance=G.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this._useGltfStyleTextures=!1,this.useGltfStyleTextures=!1,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&Y.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;const i=this._getRefractionTexture(t);if(i&&Y.RefractionTextureEnabled&&!i.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled){e.SUBSURFACE=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1;return}if(e._areTexturesDirty){e.SUBSURFACE=!0,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1;const i=!!this._thicknessTexture&&!!this._refractionIntensityTexture&&this._refractionIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._refractionIntensityTexture._texture===this._thicknessTexture._texture,n=!!this._thicknessTexture&&!!this._translucencyIntensityTexture&&this._translucencyIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._translucencyIntensityTexture._texture===this._thicknessTexture._texture,r=(i||!this._refractionIntensityTexture)&&(n||!this._translucencyIntensityTexture);if(e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&Y.ThicknessTextureEnabled&&se.PrepareDefinesForMergedUV(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&Y.RefractionIntensityTextureEnabled&&!r&&se.PrepareDefinesForMergedUV(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&Y.TranslucencyIntensityTextureEnabled&&!r&&se.PrepareDefinesForMergedUV(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!==0,e.SS_MASK_FROM_THICKNESS_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture||!!this._translucencyIntensityTexture)&&r,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture)&&r,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._translucencyIntensityTexture)&&r,this._isRefractionEnabled&&t.texturesEnabled){const a=this._getRefractionTexture(t);a&&Y.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=a.isCube,e.SS_GAMMAREFRACTION=a.gammaSpace,e.SS_RGBDREFRACTION=a.isRGBD,e.SS_LINEARSPECULARREFRACTION=a.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=this._scene.useRightHandedSystem&&a.isCube?!a.invertZ:a.invertZ,e.SS_LODINREFRACTIONALPHA=a.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=a.isCube&&a.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,n){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;n.getRenderingMesh().getWorldMatrix().decompose(w.Vector3[0]);const r=Math.max(Math.abs(w.Vector3[0].x),Math.abs(w.Vector3[0].y),Math.abs(w.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*r,(this.maximumThickness-this.minimumThickness)*r)}bindForSubMesh(e,t,i,n){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const r=n.materialDefines,a=this._material.isFrozen,o=this._material.realTimeFiltering,l=r.LODBASEDMICROSFURACE,c=this._getRefractionTexture(t);if(!e.useUbo||!a||!e.isSync){if(this._thicknessTexture&&Y.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),se.BindTextureMatrix(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&Y.RefractionIntensityTextureEnabled&&r.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),se.BindTextureMatrix(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyIntensityTexture&&Y.TranslucencyIntensityTextureEnabled&&r.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),se.BindTextureMatrix(this._translucencyIntensityTexture,e,"translucencyIntensity")),c&&Y.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",c.getRefractionTextureMatrix());let u=1;c.isCube||c.depth&&(u=c.depth);const h=c.getSize().width,d=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",c.level,1/d,u,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",h,c.lodGenerationScale,c.lodGenerationOffset,1/this.indexOfRefraction),o&&e.updateFloat2("vRefractionFilteringInfo",h,W.Log2(h)),c.boundingBoxSize){const f=c;e.updateVector3("vRefractionPosition",f.boundingBoxPosition),e.updateVector3("vRefractionSize",f.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0)}t.texturesEnabled&&(this._thicknessTexture&&Y.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&Y.RefractionIntensityTextureEnabled&&r.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&Y.TranslucencyIntensityTextureEnabled&&r.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),c&&Y.RefractionTextureEnabled&&(l?e.setTexture("refractionSampler",c):(e.setTexture("refractionSampler",c._lodTextureMid||c),e.setTexture("refractionSamplerLow",c._lodTextureLow||c),e.setTexture("refractionSamplerHigh",c._lodTextureHigh||c))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){Y.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e}hasRenderTargetTextures(){return!!(Y.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"}]}}}S([b(),K("_markAllSubMeshesAsTexturesDirty")],$t.prototype,"isRefractionEnabled",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],$t.prototype,"isTranslucencyEnabled",void 0);S([b(),K("_markScenePrePassDirty")],$t.prototype,"isScatteringEnabled",void 0);S([b()],$t.prototype,"_scatteringDiffusionProfileIndex",void 0);S([b()],$t.prototype,"refractionIntensity",void 0);S([b()],$t.prototype,"translucencyIntensity",void 0);S([b()],$t.prototype,"useAlbedoToTintRefraction",void 0);S([b()],$t.prototype,"useAlbedoToTintTranslucency",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],$t.prototype,"thicknessTexture",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],$t.prototype,"refractionTexture",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],$t.prototype,"indexOfRefraction",void 0);S([b()],$t.prototype,"_volumeIndexOfRefraction",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],$t.prototype,"volumeIndexOfRefraction",null);S([b(),K("_markAllSubMeshesAsTexturesDirty")],$t.prototype,"invertRefractionY",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],$t.prototype,"linkRefractionWithTransparency",void 0);S([b()],$t.prototype,"minimumThickness",void 0);S([b()],$t.prototype,"maximumThickness",void 0);S([b()],$t.prototype,"useThicknessAsDepth",void 0);S([Gi()],$t.prototype,"tintColor",void 0);S([b()],$t.prototype,"tintColorAtDistance",void 0);S([Gi()],$t.prototype,"diffusionDistance",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],$t.prototype,"useMaskFromThicknessTexture",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],$t.prototype,"refractionIntensityTexture",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],$t.prototype,"translucencyIntensityTexture",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],$t.prototype,"useGltfStyleTextures",void 0);class nb extends Fs{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class Kr extends Es{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"DetailMap",140,new nb,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=z.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&Y.DetailTextureEnabled&&!this._texture.isReady()):!0}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&Y.DetailTextureEnabled&&this._isEnabled?(se.PrepareDefinesForMergedUV(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&this._texture&&Y.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),se.BindTextureMatrix(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&Y.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){var t;e&&((t=this._texture)===null||t===void 0||t.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}S([ht("detailTexture"),K("_markAllSubMeshesAsTexturesDirty")],Kr.prototype,"texture",void 0);S([b()],Kr.prototype,"diffuseBlendLevel",void 0);S([b()],Kr.prototype,"roughnessBlendLevel",void 0);S([b()],Kr.prototype,"bumpLevel",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],Kr.prototype,"normalBlendMethod",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],Kr.prototype,"isEnabled",void 0);const Pa={effect:null,subMesh:null};class Z_ extends Fs{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DECAL_AFTER_DETAIL=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class St extends wE{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}constructor(e,t){super(e,t),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new dt(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=St.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=G.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new G(0,0,0),this._albedoColor=new G(1,1,1),this._reflectivityColor=new G(1,1,1),this._reflectionColor=new G(1,1,1),this._emissiveColor=new G(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=St.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._forceAlphaTest=!1,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new Mi(16),this._globalAmbientColor=new G(0,0,0),this._useLogarithmicDepth=!1,this._unlit=!1,this._applyDecalMapAfterDetailMap=!1,this._debugMode=0,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new Fi(this),this.clearCoat=new Si(this),this.iridescence=new fn(this),this.anisotropy=new wo(this),this.sheen=new Ls(this),this.subSurface=new $t(this),this.detailMap=new Kr(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),Y.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=OE(this.getScene()),this.prePassConfiguration=new Ru}get hasRenderTargetTextures(){return Y.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}get _disableAlphaBlending(){var e;return this._transparencyMode===St.PBRMATERIAL_OPAQUE||this._transparencyMode===St.PBRMATERIAL_ALPHATEST||((e=this.subSurface)===null||e===void 0?void 0:e.disableAlphaBlending)}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()}needAlphaTesting(){var e;return this._forceAlphaTest?!0:!((e=this.subSurface)===null||e===void 0)&&e.disableAlphaBlending?!1:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===St.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==St.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){var n;if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(yi.GetDefineNames,this._eventInfo),t.materialDefines=new Z_(this._eventInfo.defineNames));const r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const a=this.getScene(),o=a.getEngine();if(r._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,a.texturesEnabled)){if(this._albedoTexture&&Y.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._ambientTexture&&Y.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&Y.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;const d=this._getReflectionTexture();if(d&&Y.ReflectionTextureEnabled){if(!d.isReadyOrNotBlocking())return!1;if(d.irradianceTexture){if(!d.irradianceTexture.isReadyOrNotBlocking())return!1}else if(!d.sphericalPolynomial&&(!((n=d.getInternalTexture())===null||n===void 0)&&n._sphericalPolynomialPromise))return!1}if(this._lightmapTexture&&Y.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&Y.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(Y.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(o.getCaps().standardDerivatives&&this._bumpTexture&&Y.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&Y.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||r._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;!o.getCaps().standardDerivatives&&!e.isVerticesDataPresent(C.NormalKind)&&(e.createNormals(!0),U.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const l=t.effect,c=r._areLightsDisposed;let u=this._prepareEffect(e,r,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances),h=!1;if(u)if(this._onEffectCreatedObservable&&(Pa.effect=u,Pa.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Pa)),this.allowShaderHotSwapping&&l&&!u.isReady()){if(u=l,r.markAsUnprocessed(),h=this.isFrozen,c)return r._areLightsDisposed=!0,!1}else a.resetCachedMaterial(),t.setEffect(u,r,this._materialContext);return!t.effect||!t.effect.isReady()?!1:(r._renderId=a.getRenderId(),t.effect._wasPreviouslyReady=!h,t.effect._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),!0)}isMetallicWorkflow(){return!!(this._metallic!=null||this._roughness!=null||this._metallicTexture)}_prepareEffect(e,t,i=null,n=null,r=null,a=null,o){if(this._prepareDefines(e,t,r,a,o),!t.isDirty)return null;t.markAsProcessed();const c=this.getScene().getEngine(),u=new FE;let h=0;t.USESPHERICALINVERTEX&&u.addFallback(h++,"USESPHERICALINVERTEX"),t.FOG&&u.addFallback(h,"FOG"),t.SPECULARAA&&u.addFallback(h,"SPECULARAA"),t.POINTSIZE&&u.addFallback(h,"POINTSIZE"),t.LOGARITHMICDEPTH&&u.addFallback(h,"LOGARITHMICDEPTH"),t.PARALLAX&&u.addFallback(h,"PARALLAX"),t.PARALLAXOCCLUSION&&u.addFallback(h++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&u.addFallback(h++,"ENVIRONMENTBRDF"),t.TANGENT&&u.addFallback(h++,"TANGENT"),t.BUMP&&u.addFallback(h++,"BUMP"),h=se.HandleFallbacksForShadows(t,u,this._maxSimultaneousLights,h++),t.SPECULARTERM&&u.addFallback(h++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&u.addFallback(h++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&u.addFallback(h++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&u.addFallback(h++,"LIGHTMAP"),t.NORMAL&&u.addFallback(h++,"NORMAL"),t.AMBIENT&&u.addFallback(h++,"AMBIENT"),t.EMISSIVE&&u.addFallback(h++,"EMISSIVE"),t.VERTEXCOLOR&&u.addFallback(h++,"VERTEXCOLOR"),t.MORPHTARGETS&&u.addFallback(h++,"MORPHTARGETS"),t.MULTIVIEW&&u.addFallback(0,"MULTIVIEW");const d=[C.PositionKind];t.NORMAL&&d.push(C.NormalKind),t.TANGENT&&d.push(C.TangentKind);for(let I=1;I<=6;++I)t["UV"+I]&&d.push(`uv${I===1?"":I}`);t.VERTEXCOLOR&&d.push(C.ColorKind),t.INSTANCESCOLOR&&d.push(C.ColorInstanceKind),se.PrepareAttributesForBones(d,e,t,u),se.PrepareAttributesForInstances(d,t),se.PrepareAttributesForMorphTargets(d,e,t),se.PrepareAttributesForBakedVertexAnimation(d,e,t);let f="pbr";const p=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],m=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],_=["Material","Scene","Mesh"],E={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=u,this._eventInfo.fallbackRank=h,this._eventInfo.defines=t,this._eventInfo.uniforms=p,this._eventInfo.attributes=d,this._eventInfo.samplers=m,this._eventInfo.uniformBuffersNames=_,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=E,this._callbackPluginEventGeneric(yi.PrepareEffect,this._eventInfo),Ru.AddUniforms(p),em(p),je&&(je.PrepareUniforms(p,t),je.PrepareSamplers(m,t)),se.PrepareUniformsAndSamplersList({uniformsNames:p,uniformBuffersNames:_,samplers:m,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});const v={};this.customShaderNameResolve&&(f=this.customShaderNameResolve(f,p,_,m,t,d,v));const y=t.toString(),A=c.createEffect(f,{attributes:d,uniformsNames:p,uniformBuffersNames:_,samplers:m,defines:y,fallbacks:u,onCompiled:i,onError:n,indexParameters:E,processFinalCode:v.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS},c);return this._eventInfo.customCode=void 0,A}_prepareDefines(e,t,i=null,n=null,r=!1){var a;const o=this.getScene(),l=o.getEngine();se.PrepareDefinesForLights(o,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,se.PrepareDefinesForMultiview(o,t);const c=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(se.PrepareDefinesForPrePass(o,t,this.canRenderToMRT&&!c),se.PrepareDefinesForOIT(o,t,c),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){t._needUVs=!1;for(let u=1;u<=6;++u)t["MAINUV"+u]=!1;if(o.texturesEnabled){t.ALBEDODIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,l.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&Y.DiffuseTextureEnabled?(se.PrepareDefinesForMergedUV(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._ambientTexture&&Y.AmbientTextureEnabled?(se.PrepareDefinesForMergedUV(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&Y.OpacityTextureEnabled?(se.PrepareDefinesForMergedUV(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;const u=this._getReflectionTexture();if(u&&Y.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=u.gammaSpace,t.RGBDREFLECTION=u.isRGBD,t.LODINREFLECTIONALPHA=u.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=u.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,l._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0):t.REALTIME_FILTERING=!1,t.INVERTCUBICMAP=u.coordinatesMode===H.INVCUBIC_MODE,t.REFLECTIONMAP_3D=u.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!u.invertZ:u.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,u.coordinatesMode){case H.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case H.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case H.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case H.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case H.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case H.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case H.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case H.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case H.CUBIC_MODE:case H.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!u.boundingBoxSize;break}u.coordinatesMode!==H.SKYBOX_MODE&&(u.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1):u.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||l.getCaps().maxVaryingVectors<=8?t.USESPHERICALINVERTEX=!1:t.USESPHERICALINVERTEX=!0))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;if(this._lightmapTexture&&Y.LightmapTextureEnabled?(se.PrepareDefinesForMergedUV(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&Y.EmissiveTextureEnabled?(se.PrepareDefinesForMergedUV(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,Y.SpecularTextureEnabled){if(this._metallicTexture?(se.PrepareDefinesForMergedUV(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(se.PrepareDefinesForMergedUV(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture){const h=this._metallicReflectanceTexture!==null&&this._metallicReflectanceTexture._texture===((a=this._reflectanceTexture)===null||a===void 0?void 0:a._texture)&&this._metallicReflectanceTexture.checkTransformsAreIdentical(this._reflectanceTexture);t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture&&!h,this._metallicReflectanceTexture?(se.PrepareDefinesForMergedUV(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&!h&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(se.PrepareDefinesForMergedUV(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1}else t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1;this._microSurfaceTexture?se.PrepareDefinesForMergedUV(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1}else t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1;l.getCaps().standardDerivatives&&this._bumpTexture&&Y.BumpTextureEnabled&&!this._disableBumpMap?(se.PrepareDefinesForMergedUV(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&Y.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAXOCCLUSION=!1,t.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&Y.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?t.ALPHAFROMALBEDO=!0:t.ALPHAFROMALBEDO=!1}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===St.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===St.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?t.TWOSIDEDLIGHTING=!0:t.TWOSIDEDLIGHTING=!1,t.SPECULARAA=l.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1===0?".":""}`,t.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&(se.PrepareDefinesForMisc(e,o,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t,this._applyDecalMapAfterDetailMap),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(C.NormalKind),t.DEBUGMODE=this._debugMode),se.PrepareDefinesForFrameBoundValues(o,l,this,t,!!i,n,r),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),se.PrepareDefinesForAttributes(e,t,!0,!0,!0,this._transparencyMode!==St.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){const n=Object.assign({clipPlane:!1,useInstances:!1},i);this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(yi.GetDefineNames,this._eventInfo);const r=new Z_(this._eventInfo.defineNames),a=this._prepareEffect(e,r,void 0,void 0,n.useInstances,n.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(Pa.effect=a,Pa.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Pa)),a.isReady()?t&&t(this):a.onCompileObservable.add(()=>{t&&t(this)})}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var n,r,a,o;const l=this.getScene(),c=i.materialDefines;if(!c)return;const u=i.effect;if(!u)return;this._activeEffect=u,t.getMeshUniformBuffer().bindToEffect(u,"Mesh"),t.transferToEffect(e);const h=l.getEngine();this._uniformBuffer.bindToEffect(u,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,l,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),c.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const d=u._forceRebindOnNextCall||this._mustRebind(l,u,t.visibility);se.BindBonesParameters(t,this._activeEffect,this.prePassConfiguration);let f=null;const p=this._uniformBuffer;if(d){if(this.bindViewProjection(u),f=this._getReflectionTexture(),!p.useUbo||!this.isFrozen||!p.isSync||u._forceRebindOnNextCall){if(l.texturesEnabled){if(this._albedoTexture&&Y.DiffuseTextureEnabled&&(p.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),se.BindTextureMatrix(this._albedoTexture,p,"albedo")),this._ambientTexture&&Y.AmbientTextureEnabled&&(p.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),se.BindTextureMatrix(this._ambientTexture,p,"ambient")),this._opacityTexture&&Y.OpacityTextureEnabled&&(p.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),se.BindTextureMatrix(this._opacityTexture,p,"opacity")),f&&Y.ReflectionTextureEnabled){if(p.updateMatrix("reflectionMatrix",f.getReflectionTextureMatrix()),p.updateFloat2("vReflectionInfos",f.level,0),f.boundingBoxSize){const m=f;p.updateVector3("vReflectionPosition",m.boundingBoxPosition),p.updateVector3("vReflectionSize",m.boundingBoxSize)}if(this.realTimeFiltering){const m=f.getSize().width;p.updateFloat2("vReflectionFilteringInfo",m,W.Log2(m))}if(!c.USEIRRADIANCEMAP){const m=f.sphericalPolynomial;if(c.USESPHERICALFROMREFLECTIONMAP&&m)if(c.SPHERICAL_HARMONICS){const _=m.preScaledHarmonics;p.updateVector3("vSphericalL00",_.l00),p.updateVector3("vSphericalL1_1",_.l1_1),p.updateVector3("vSphericalL10",_.l10),p.updateVector3("vSphericalL11",_.l11),p.updateVector3("vSphericalL2_2",_.l2_2),p.updateVector3("vSphericalL2_1",_.l2_1),p.updateVector3("vSphericalL20",_.l20),p.updateVector3("vSphericalL21",_.l21),p.updateVector3("vSphericalL22",_.l22)}else p.updateFloat3("vSphericalX",m.x.x,m.x.y,m.x.z),p.updateFloat3("vSphericalY",m.y.x,m.y.y,m.y.z),p.updateFloat3("vSphericalZ",m.z.x,m.z.y,m.z.z),p.updateFloat3("vSphericalXX_ZZ",m.xx.x-m.zz.x,m.xx.y-m.zz.y,m.xx.z-m.zz.z),p.updateFloat3("vSphericalYY_ZZ",m.yy.x-m.zz.x,m.yy.y-m.zz.y,m.yy.z-m.zz.z),p.updateFloat3("vSphericalZZ",m.zz.x,m.zz.y,m.zz.z),p.updateFloat3("vSphericalXY",m.xy.x,m.xy.y,m.xy.z),p.updateFloat3("vSphericalYZ",m.yz.x,m.yz.y,m.yz.z),p.updateFloat3("vSphericalZX",m.zx.x,m.zx.y,m.zx.z)}p.updateFloat3("vReflectionMicrosurfaceInfos",f.getSize().width,f.lodGenerationScale,f.lodGenerationOffset)}this._emissiveTexture&&Y.EmissiveTextureEnabled&&(p.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),se.BindTextureMatrix(this._emissiveTexture,p,"emissive")),this._lightmapTexture&&Y.LightmapTextureEnabled&&(p.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),se.BindTextureMatrix(this._lightmapTexture,p,"lightmap")),Y.SpecularTextureEnabled&&(this._metallicTexture?(p.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),se.BindTextureMatrix(this._metallicTexture,p,"reflectivity")):this._reflectivityTexture&&(p.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),se.BindTextureMatrix(this._reflectivityTexture,p,"reflectivity")),this._metallicReflectanceTexture&&(p.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),se.BindTextureMatrix(this._metallicReflectanceTexture,p,"metallicReflectance")),this._reflectanceTexture&&c.REFLECTANCE&&(p.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),se.BindTextureMatrix(this._reflectanceTexture,p,"reflectance")),this._microSurfaceTexture&&(p.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),se.BindTextureMatrix(this._microSurfaceTexture,p,"microSurfaceSampler"))),this._bumpTexture&&h.getCaps().standardDerivatives&&Y.BumpTextureEnabled&&!this._disableBumpMap&&(p.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),se.BindTextureMatrix(this._bumpTexture,p,"bump"),l._mirroredCameraPosition?p.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):p.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&p.updateFloat("pointSize",this.pointSize),c.METALLICWORKFLOW){jn.Color3[0].r=this._metallic===void 0||this._metallic===null?1:this._metallic,jn.Color3[0].g=this._roughness===void 0||this._roughness===null?1:this._roughness,p.updateColor4("vReflectivityColor",jn.Color3[0],1);const m=(r=(n=this.subSurface)===null||n===void 0?void 0:n._indexOfRefraction)!==null&&r!==void 0?r:1.5,_=1,E=Math.pow((m-_)/(m+_),2);this._metallicReflectanceColor.scaleToRef(E*this._metallicF0Factor,jn.Color3[0]);const v=this._metallicF0Factor;p.updateColor4("vMetallicReflectanceFactors",jn.Color3[0],v)}else p.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);p.updateColor3("vEmissiveColor",Y.EmissiveTextureEnabled?this._emissiveColor:G.BlackReadOnly),p.updateColor3("vReflectionColor",this._reflectionColor),!c.SS_REFRACTION&&(!((a=this.subSurface)===null||a===void 0)&&a._linkRefractionWithTransparency)?p.updateColor4("vAlbedoColor",this._albedoColor,1):p.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*l.environmentIntensity,this._lightingInfos.w=this._specularIntensity,p.updateVector4("vLightingIntensity",this._lightingInfos),l.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),p.updateColor3("vAmbientColor",this._globalAmbientColor),p.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}l.texturesEnabled&&(this._albedoTexture&&Y.DiffuseTextureEnabled&&p.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&Y.AmbientTextureEnabled&&p.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&Y.OpacityTextureEnabled&&p.setTexture("opacitySampler",this._opacityTexture),f&&Y.ReflectionTextureEnabled&&(c.LODBASEDMICROSFURACE?p.setTexture("reflectionSampler",f):(p.setTexture("reflectionSampler",f._lodTextureMid||f),p.setTexture("reflectionSamplerLow",f._lodTextureLow||f),p.setTexture("reflectionSamplerHigh",f._lodTextureHigh||f)),c.USEIRRADIANCEMAP&&p.setTexture("irradianceSampler",f.irradianceTexture)),c.ENVIRONMENTBRDF&&p.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&Y.EmissiveTextureEnabled&&p.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&Y.LightmapTextureEnabled&&p.setTexture("lightmapSampler",this._lightmapTexture),Y.SpecularTextureEnabled&&(this._metallicTexture?p.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&p.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&p.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&c.REFLECTANCE&&p.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&p.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&h.getCaps().standardDerivatives&&Y.BumpTextureEnabled&&!this._disableBumpMap&&p.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(u),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),tm(this._activeEffect,this,l),this.bindEyePosition(u)}else l.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(d||!this.isFrozen)&&(l.lightsEnabled&&!this._disableLighting&&se.BindLights(l,t,this._activeEffect,c,this._maxSimultaneousLights),(l.fogEnabled&&t.applyFog&&l.fogMode!==Le.FOGMODE_NONE||f||t.receiveShadows||c.PREPASS)&&this.bindView(u),se.BindFogParameters(l,t,this._activeEffect,!0),c.NUM_MORPH_INFLUENCERS&&se.BindMorphTargetParameters(t,this._activeEffect),c.BAKED_VERTEX_ANIMATION_TEXTURE&&((o=t.bakedVertexAnimationManager)===null||o===void 0||o.bind(u,c.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),se.BindLogDepth(c,this._activeEffect,l)),this._afterBind(t,this._activeEffect),p.update()}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._albedoTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e)}setPrePassRenderer(){var e;if(!(!((e=this.subSurface)===null||e===void 0)&&e.isScatteringEnabled))return!1;const t=this.getScene().enableSubSurfaceForPrePass();return t&&(t.enabled=!0),!0}dispose(e,t){var i,n,r,a,o,l,c,u,h,d,f,p;t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),(i=this._albedoTexture)===null||i===void 0||i.dispose(),(n=this._ambientTexture)===null||n===void 0||n.dispose(),(r=this._opacityTexture)===null||r===void 0||r.dispose(),(a=this._reflectionTexture)===null||a===void 0||a.dispose(),(o=this._emissiveTexture)===null||o===void 0||o.dispose(),(l=this._metallicTexture)===null||l===void 0||l.dispose(),(c=this._reflectivityTexture)===null||c===void 0||c.dispose(),(u=this._bumpTexture)===null||u===void 0||u.dispose(),(h=this._lightmapTexture)===null||h===void 0||h.dispose(),(d=this._metallicReflectanceTexture)===null||d===void 0||d.dispose(),(f=this._reflectanceTexture)===null||f===void 0||f.dispose(),(p=this._microSurfaceTexture)===null||p===void 0||p.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}}St.PBRMATERIAL_OPAQUE=z.MATERIAL_OPAQUE;St.PBRMATERIAL_ALPHATEST=z.MATERIAL_ALPHATEST;St.PBRMATERIAL_ALPHABLEND=z.MATERIAL_ALPHABLEND;St.PBRMATERIAL_ALPHATESTANDBLEND=z.MATERIAL_ALPHATESTANDBLEND;St.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0;St.LIGHTFALLOFF_PHYSICAL=0;St.LIGHTFALLOFF_GLTF=1;St.LIGHTFALLOFF_STANDARD=2;S([VT()],St.prototype,"_imageProcessingConfiguration",void 0);S([K("_markAllSubMeshesAsMiscDirty")],St.prototype,"debugMode",void 0);S([b()],St.prototype,"useLogarithmicDepth",null);class oe extends St{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===St.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=St.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=St.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===St.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=St.LIGHTFALLOFF_GLTF:this._lightFalloff=St.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}constructor(e,t){super(e,t),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=oe.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=G.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new G(0,0,0),this.albedoColor=new G(1,1,1),this.reflectivityColor=new G(1,1,1),this.reflectionColor=new G(1,1,1),this.emissiveColor=new G(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.applyDecalMapAfterDetailMap=!1,this._environmentBRDFTexture=OE(this.getScene())}getClassName(){return"PBRMaterial"}clone(e,t=!0,i=""){const n=Pe.Clone(()=>new oe(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return n.id=e,n.name=e,this.stencil.copyTo(n.stencil),this._clonePlugins(n,i),n}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e}static Parse(e,t,i){const n=Pe.Parse(()=>new oe(e.name,t),e,t,i);return e.stencil&&n.stencil.parse(e.stencil,t,i),z._parsePlugins(e,n,t,i),e.clearCoat&&n.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&n.anisotropy.parse(e.anisotropy,t,i),e.brdf&&n.brdf.parse(e.brdf,t,i),e.sheen&&n.sheen.parse(e.sheen,t,i),e.subSurface&&n.subSurface.parse(e.subSurface,t,i),e.iridescence&&n.iridescence.parse(e.iridescence,t,i),n}}oe.PBRMATERIAL_OPAQUE=St.PBRMATERIAL_OPAQUE;oe.PBRMATERIAL_ALPHATEST=St.PBRMATERIAL_ALPHATEST;oe.PBRMATERIAL_ALPHABLEND=St.PBRMATERIAL_ALPHABLEND;oe.PBRMATERIAL_ALPHATESTANDBLEND=St.PBRMATERIAL_ALPHATESTANDBLEND;oe.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=St.DEFAULT_AO_ON_ANALYTICAL_LIGHTS;S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"directIntensity",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"emissiveIntensity",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"environmentIntensity",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"specularIntensity",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"disableBumpMap",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"albedoTexture",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"ambientTexture",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"ambientTextureStrength",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"ambientTextureImpactOnAnalyticalLights",void 0);S([ht(),K("_markAllSubMeshesAsTexturesAndMiscDirty")],oe.prototype,"opacityTexture",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"reflectionTexture",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"emissiveTexture",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"reflectivityTexture",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"metallicTexture",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"metallic",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"roughness",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"metallicF0Factor",void 0);S([Gi(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"metallicReflectanceColor",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"metallicReflectanceTexture",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"reflectanceTexture",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"microSurfaceTexture",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"bumpTexture",void 0);S([ht(),K("_markAllSubMeshesAsTexturesDirty",null)],oe.prototype,"lightmapTexture",void 0);S([Gi("ambient"),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"ambientColor",void 0);S([Gi("albedo"),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"albedoColor",void 0);S([Gi("reflectivity"),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"reflectivityColor",void 0);S([Gi("reflection"),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"reflectionColor",void 0);S([Gi("emissive"),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"emissiveColor",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"microSurface",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useLightmapAsShadowmap",void 0);S([b(),K("_markAllSubMeshesAsTexturesAndMiscDirty")],oe.prototype,"useAlphaFromAlbedoTexture",void 0);S([b(),K("_markAllSubMeshesAsTexturesAndMiscDirty")],oe.prototype,"forceAlphaTest",void 0);S([b(),K("_markAllSubMeshesAsTexturesAndMiscDirty")],oe.prototype,"alphaCutOff",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useSpecularOverAlpha",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useRoughnessFromMetallicTextureAlpha",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useRoughnessFromMetallicTextureGreen",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useMetallnessFromMetallicTextureBlue",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useAmbientInGrayScale",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0);S([b()],oe.prototype,"usePhysicalLightFalloff",null);S([b()],oe.prototype,"useGLTFLightFalloff",null);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useRadianceOverAlpha",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useObjectSpaceNormalMap",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useParallax",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useParallaxOcclusion",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"parallaxScaleBias",void 0);S([b(),K("_markAllSubMeshesAsLightsDirty")],oe.prototype,"disableLighting",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"forceIrradianceInFragment",void 0);S([b(),K("_markAllSubMeshesAsLightsDirty")],oe.prototype,"maxSimultaneousLights",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"invertNormalMapX",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"invertNormalMapY",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"twoSidedLighting",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useAlphaFresnel",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useLinearAlphaFresnel",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"environmentBRDFTexture",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"forceNormalForward",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"enableSpecularAntiAliasing",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useHorizonOcclusion",void 0);S([b(),K("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useRadianceOcclusion",void 0);S([b(),K("_markAllSubMeshesAsMiscDirty")],oe.prototype,"unlit",void 0);S([b(),K("_markAllSubMeshesAsMiscDirty")],oe.prototype,"applyDecalMapAfterDetailMap",void 0);Rt("BABYLON.PBRMaterial",oe);const sb=D.Compose(g.One(),ee.FromEulerAngles(0,Math.PI,0),g.Zero());class Me extends oi{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=(this._billboardMode&Me.BILLBOARDMODE_USE_POSITION)!==0,this._computeUseBillboardPath())}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e,this._computeUseBillboardPath())}_computeUseBillboardPath(){this._cache.useBillboardPath=this._billboardMode!==Me.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,t=null,i=!0){super(e,t),this._forward=new g(0,0,1),this._up=new g(0,1,0),this._right=new g(1,0,0),this._position=g.Zero(),this._rotation=g.Zero(),this._rotationQuaternion=null,this._scaling=g.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=Me.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=D.Zero(),this._usePivotMatrix=!1,this._absolutePosition=g.Zero(),this._absoluteScaling=g.Zero(),this._absoluteRotationQuaternion=ee.Identity(),this._pivotMatrix=D.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new O,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._isDirty=!0}isUsingPivotMatrix(){return this._usePivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._isDirty=!0}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._isDirty=!0}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._isDirty=!0}get forward(){return g.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return g.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return g.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=D.Identity()),this._poseMatrix}_isSynchronized(){const e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==Me.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();const e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1,e.useBillboardPath=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=D.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){const n=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);n&&i&&i(this,n);for(const r of this.getChildTransformNodes(!0))r.instantiateHierarchy(n,t,i);return n}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||ee.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,n;if(e.x===void 0){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],n=arguments[2]}else t=e.x,i=e.y,n=e.z;if(this.parent){const r=w.Matrix[0];this.parent.getWorldMatrix().invertToRef(r),g.TransformCoordinatesFromFloatsToRef(t,i,n,r,this.position)}else this.position.x=t,this.position.y=i,this.position.z=n;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=g.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const e=w.Matrix[0];return this._localMatrix.invertToRef(e),g.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=g.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,n=0,r=rt.LOCAL){const a=Me._LookAtVectorCache,o=r===rt.LOCAL?this.position:this.getAbsolutePosition();if(e.subtractToRef(o,a),this.setDirection(a,t,i,n),r===rt.WORLD&&this.parent)if(this.rotationQuaternion){const l=w.Matrix[0];this.rotationQuaternion.toRotationMatrix(l);const c=w.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(c),c.invert(),l.multiplyToRef(c,l),this.rotationQuaternion.fromRotationMatrix(l)}else{const l=w.Quaternion[0];ee.FromEulerVectorToRef(this.rotation,l);const c=w.Matrix[0];l.toRotationMatrix(c);const u=w.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(u),u.invert(),c.multiplyToRef(u,c),l.fromRotationMatrix(c),l.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){const t=g.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return g.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,n=0){const r=-Math.atan2(e.z,e.x)+Math.PI/2,a=Math.sqrt(e.x*e.x+e.z*e.z),o=-Math.atan2(e.y,a);return this.rotationQuaternion?ee.RotationYawPitchRollToRef(r+t,o+i,n,this.rotationQuaternion):(this.rotation.x=o+i,this.rotation.y=r+t,this.rotation.z=n),this}setPivotPoint(e,t=rt.LOCAL){this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);const i=this.getWorldMatrix();if(t==rt.WORLD){const n=w.Matrix[0];i.invertToRef(n),e=g.TransformCoordinates(e,n)}return this.setPivotMatrix(D.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){const e=g.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){const e=g.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),g.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(const t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;const n=w.Quaternion[0],r=w.Vector3[0],a=w.Vector3[1],o=w.Matrix[1];D.IdentityToRef(o);const l=w.Matrix[0];this.computeWorldMatrix(!0);let c=this.rotationQuaternion;return c||(c=Me._TmpRotation,ee.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,c)),D.ComposeToRef(this.scaling,c,this.position,l),this.parent&&l.multiplyToRef(this.parent.computeWorldMatrix(!0),l),e&&(e.computeWorldMatrix(!0).invertToRef(o),l.multiplyToRef(o,l)),l.decompose(a,n,r,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(n):n.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(a),this.position.copyFrom(r),this.parent=e,i&&this.setPivotMatrix(D.Identity()),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling===e?!1:(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(!0),e.getFinalMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,e?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));let n;if(!i||i===rt.LOCAL)n=ee.RotationAxisToRef(e,t,Me._RotationAxisCache),this.rotationQuaternion.multiplyToRef(n,this.rotationQuaternion);else{if(this.parent){const r=w.Matrix[0];this.parent.getWorldMatrix().invertToRef(r),e=g.TransformNormal(e,r)}n=ee.RotationAxisToRef(e,t,Me._RotationAxisCache),n.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=ee.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const n=w.Vector3[0],r=w.Vector3[1],a=w.Vector3[2],o=w.Quaternion[0],l=w.Matrix[0],c=w.Matrix[1],u=w.Matrix[2],h=w.Matrix[3];return e.subtractToRef(this.position,n),D.TranslationToRef(n.x,n.y,n.z,l),D.TranslationToRef(-n.x,-n.y,-n.z,c),D.RotationAxisToRef(t,i,u),c.multiplyToRef(u,h),h.multiplyToRef(l,h),h.decompose(r,o,a),this.position.addInPlace(a),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){const n=e.scale(t);if(!i||i===rt.LOCAL){const r=this.getPositionExpressedInLocalSpace().add(n);this.setPositionWithLocalVector(r)}else this.setAbsolutePosition(this.getAbsolutePosition().add(n));return this}addRotation(e,t,i){let n;this.rotationQuaternion?n=this.rotationQuaternion:(n=w.Quaternion[1],ee.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,n));const r=w.Quaternion[0];return ee.RotationYawPitchRollToRef(t,e,i,r),n.multiplyInPlace(r),this.rotationQuaternion||n.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==Me.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}computeWorldMatrix(e=!1,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;const i=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();const n=this._cache;n.pivotMatrixUpdated=!1,n.billboardMode=this.billboardMode,n.infiniteDistance=this.infiniteDistance,n.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;const r=this._getEffectiveParent(),a=Me._TmpScaling;let o=this._position;if(this._infiniteDistance&&!this.parent&&t){const c=t.getWorldMatrix(),u=new g(c.m[12],c.m[13],c.m[14]);o=Me._TmpTranslation,o.copyFromFloats(this._position.x+u.x,this._position.y+u.y,this._position.z+u.z)}a.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);let l;if(this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,l=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(ee.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(l=Me._TmpRotation,ee.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),this._usePivotMatrix){const c=w.Matrix[1];D.ScalingToRef(a.x,a.y,a.z,c);const u=w.Matrix[0];l.toRotationMatrix(u),this._pivotMatrix.multiplyToRef(c,w.Matrix[4]),w.Matrix[4].multiplyToRef(u,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(o.x,o.y,o.z)}else D.ComposeToRef(a,l,o,this._localMatrix);if(r&&r.getWorldMatrix){if(e&&r.computeWorldMatrix(e),n.useBillboardPath){if(this._transformToBoneReferal){const d=this.parent;d.getSkeleton().prepare(),d.getFinalMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),w.Matrix[7])}else w.Matrix[7].copyFrom(r.getWorldMatrix());const c=w.Vector3[5],u=w.Vector3[6],h=w.Quaternion[0];w.Matrix[7].decompose(u,h,c),D.ScalingToRef(u.x,u.y,u.z,w.Matrix[7]),w.Matrix[7].setTranslation(c),Me.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(h,c),this._localMatrix.setTranslation(c)),this._localMatrix.multiplyToRef(w.Matrix[7],this._worldMatrix)}else if(this._transformToBoneReferal){const c=this.parent;c.getSkeleton().prepare(),this._localMatrix.multiplyToRef(c.getFinalMatrix(),w.Matrix[6]),w.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)}else this._localMatrix.multiplyToRef(r.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(n.useBillboardPath&&t&&this.billboardMode&&!n.useBillboardPosition){const c=w.Vector3[0];if(this._worldMatrix.getTranslationToRef(c),w.Matrix[1].copyFrom(t.getViewMatrix()),this._scene.useRightHandedSystem&&w.Matrix[1].multiplyToRef(sb,w.Matrix[1]),w.Matrix[1].setTranslationFromFloats(0,0,0),w.Matrix[1].invertToRef(w.Matrix[0]),(this.billboardMode&Me.BILLBOARDMODE_ALL)!==Me.BILLBOARDMODE_ALL){w.Matrix[0].decompose(void 0,w.Quaternion[0],void 0);const u=w.Vector3[1];w.Quaternion[0].toEulerAnglesToRef(u),(this.billboardMode&Me.BILLBOARDMODE_X)!==Me.BILLBOARDMODE_X&&(u.x=0),(this.billboardMode&Me.BILLBOARDMODE_Y)!==Me.BILLBOARDMODE_Y&&(u.y=0),(this.billboardMode&Me.BILLBOARDMODE_Z)!==Me.BILLBOARDMODE_Z&&(u.z=0),D.RotationYawPitchRollToRef(u.y,u.x,u.z,w.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(w.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(w.Vector3[0])}else if(n.useBillboardPath&&t&&n.useBillboardPosition){const c=w.Vector3[0];this._worldMatrix.getTranslationToRef(c);const u=t.globalPosition;this._worldMatrix.invertToRef(w.Matrix[1]);const h=w.Vector3[1];g.TransformCoordinatesToRef(u,w.Matrix[1],h),h.normalize();const d=-Math.atan2(h.z,h.x)+Math.PI/2,f=Math.sqrt(h.x*h.x+h.z*h.z),p=-Math.atan2(h.y,f);if(ee.RotationYawPitchRollToRef(d,p,0,w.Quaternion[0]),(this.billboardMode&Me.BILLBOARDMODE_ALL)!==Me.BILLBOARDMODE_ALL){const m=w.Vector3[1];w.Quaternion[0].toEulerAnglesToRef(m),(this.billboardMode&Me.BILLBOARDMODE_X)!==Me.BILLBOARDMODE_X&&(m.x=0),(this.billboardMode&Me.BILLBOARDMODE_Y)!==Me.BILLBOARDMODE_Y&&(m.y=0),(this.billboardMode&Me.BILLBOARDMODE_Z)!==Me.BILLBOARDMODE_Z&&(m.z=0),D.RotationYawPitchRollToRef(m.y,m.x,m.z,w.Matrix[0])}else D.FromQuaternionToRef(w.Quaternion[0],w.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(w.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(w.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):r&&r._nonUniformScaling?this._updateNonUniformScalingState(r._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=D.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){const t=this.getChildren();for(let i=0;i<t.length;++i){const n=t[i];if(n){n.computeWorldMatrix();const r=w.Matrix[0];n._localMatrix.multiplyToRef(this._localMatrix,r);const a=w.Quaternion[0];r.decompose(n.scaling,a,n.position),n.rotationQuaternion?n.rotationQuaternion.copyFrom(a):a.toEulerAnglesToRef(n.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=ee.Identity()),this._worldMatrix=D.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),g.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){const n=Pe.Clone(()=>new Me(e,this.getScene()),this);if(n.name=e,n.id=e,t&&(n.parent=t),!i){const r=this.getDescendants(!0);for(let a=0;a<r.length;a++){const o=r[a];o.clone&&o.clone(e+"."+o.name,n)}}return n}serialize(e){const t=Pe.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),t}static Parse(e,t,i){const n=Pe.Parse(()=>new Me(e.name,t),e,t,i);return e.localMatrix?n.setPreTransformMatrix(D.FromArray(e.localMatrix)):e.pivotMatrix&&n.setPivotMatrix(D.FromArray(e.pivotMatrix)),n.setEnabled(e.isEnabled),n._waitingParsedUniqueId=e.uniqueId,e.parentId!==void 0&&(n._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(n._waitingParentInstanceIndex=e.parentInstanceIndex),n}getChildTransformNodes(e,t){const i=[];return this._getDescendants(i,e,n=>(!t||t(n))&&n instanceof Me),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){const i=this._parentContainer.transformNodes.indexOf(this);i>-1&&this._parentContainer.transformNodes.splice(i,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){const i=this.getChildTransformNodes(!0);for(const n of i)n.parent=null,n.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let n=null,r=null;t&&(this.rotationQuaternion?(r=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(n=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const a=this.getHierarchyBoundingVectors(e,i),o=a.max.subtract(a.min),l=Math.max(o.x,o.y,o.z);if(l===0)return this;const c=1/l;return this.scaling.scaleInPlace(c),t&&(this.rotationQuaternion&&r?this.rotationQuaternion.copyFrom(r):this.rotation&&n&&this.rotation.copyFrom(n)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}}Me.BILLBOARDMODE_NONE=0;Me.BILLBOARDMODE_X=1;Me.BILLBOARDMODE_Y=2;Me.BILLBOARDMODE_Z=4;Me.BILLBOARDMODE_ALL=7;Me.BILLBOARDMODE_USE_POSITION=128;Me.BillboardUseParentOrientation=!1;Me._TmpRotation=ee.Zero();Me._TmpScaling=g.Zero();Me._TmpTranslation=g.Zero();Me._LookAtVectorCache=new g(0,0,0);Me._RotationAxisCache=new ee;S([gn("position")],Me.prototype,"_position",void 0);S([gn("rotation")],Me.prototype,"_rotation",void 0);S([GT("rotationQuaternion")],Me.prototype,"_rotationQuaternion",void 0);S([gn("scaling")],Me.prototype,"_scaling",void 0);S([b("billboardMode")],Me.prototype,"_billboardMode",void 0);S([b()],Me.prototype,"scalingDeterminant",void 0);S([b("infiniteDistance")],Me.prototype,"_infiniteDistance",void 0);S([b()],Me.prototype,"ignoreNonUniformScaling",void 0);S([b()],Me.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);function bu(s,e,t){try{const i=s.next();i.done?e(i):i.value?i.value.then(()=>{i.value=void 0,e(i)},t):e(i)}catch(i){t(i)}}function rb(s=25){let e;return(t,i,n)=>{const r=performance.now();e===void 0||r-e>s?(e=r,setTimeout(()=>{bu(t,i,n)},0)):bu(t,i,n)}}function LE(s,e,t,i,n){const r=()=>{let a;const o=l=>{l.done?t(l.value):a===void 0?a=!0:r()};do a=void 0,!n||!n.aborted?e(s,o,i):i(new Error("Aborted")),a===void 0&&(a=!1);while(a)};r()}function im(s,e){let t;return LE(s,bu,i=>t=i,i=>{throw i},e),t}function NE(s,e,t){return new Promise((i,n)=>{LE(s,e,i,n,t)})}function ab(s,e){return(...t)=>im(s(...t),e)}class Qh{}class fe{constructor(){this.uniqueId=0,this.metadata={},this._applyTo=ab(this._applyToCoroutine.bind(this)),this.uniqueId=fe._UniqueIDGenerator,fe._UniqueIDGenerator++}set(e,t){switch(e.length||U.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case C.PositionKind:this.positions=e;break;case C.NormalKind:this.normals=e;break;case C.TangentKind:this.tangents=e;break;case C.UVKind:this.uvs=e;break;case C.UV2Kind:this.uvs2=e;break;case C.UV3Kind:this.uvs3=e;break;case C.UV4Kind:this.uvs4=e;break;case C.UV5Kind:this.uvs5=e;break;case C.UV6Kind:this.uvs6=e;break;case C.ColorKind:this.colors=e;break;case C.MatricesIndicesKind:this.matricesIndices=e;break;case C.MatricesWeightsKind:this.matricesWeights=e;break;case C.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case C.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;break}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,i){if(this.positions&&(e.setVerticesData(C.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(C.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(C.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(C.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(C.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(C.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(C.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(C.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(C.UV6Kind,this.uvs6,t),i&&(yield)),this.colors&&(e.setVerticesData(C.ColorKind,this.colors,t),i&&(yield)),this.matricesIndices&&(e.setVerticesData(C.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(C.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(C.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(C.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),e.subMeshes&&this.materialInfos&&this.materialInfos.length>1){const n=e;n.subMeshes=[];for(const r of this.materialInfos)new Jn(r.materialIndex,r.verticesStart,r.verticesCount,r.indexStart,r.indexCount,n)}return this}_update(e,t,i){return this.positions&&e.updateVerticesData(C.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(C.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(C.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(C.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(C.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(C.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(C.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(C.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(C.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(C.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(C.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(C.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(C.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(C.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,n=e.length){const r=w.Vector3[0],a=w.Vector3[1];for(let o=i;o<i+n;o+=3)g.FromArrayToRef(e,o,r),g.TransformCoordinatesToRef(r,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z}static _TransformVector3Normals(e,t,i=0,n=e.length){const r=w.Vector3[0],a=w.Vector3[1];for(let o=i;o<i+n;o+=3)g.FromArrayToRef(e,o,r),g.TransformNormalToRef(r,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z}static _TransformVector4Normals(e,t,i=0,n=e.length){const r=w.Vector4[0],a=w.Vector4[1];for(let o=i;o<i+n;o+=4)dt.FromArrayToRef(e,o,r),dt.TransformNormalToRef(r,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z,e[o+3]=a.w}static _FlipFaces(e,t=0,i=e.length){for(let n=t;n<t+i;n+=3){const r=e[n+1];e[n+1]=e[n+2],e[n+2]=r}}transform(e){const t=e.determinant()<0;return this.positions&&fe._TransformVector3Coordinates(this.positions,e),this.normals&&fe._TransformVector3Normals(this.normals,e),this.tangents&&fe._TransformVector4Normals(this.tangents,e),t&&this.indices&&fe._FlipFaces(this.indices),this}splitBasedOnMaterialID(){if(!this.materialInfos||this.materialInfos.length<2)return[this];const e=new Array;for(const t of this.materialInfos){const i=new fe;if(this.positions&&(i.positions=this.positions.slice(t.verticesStart*3,(t.verticesCount+t.verticesStart)*3)),this.normals&&(i.normals=this.normals.slice(t.verticesStart*3,(t.verticesCount+t.verticesStart)*3)),this.tangents&&(i.tangents=this.tangents.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.colors&&(i.colors=this.colors.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.uvs&&(i.uvs=this.uvs.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs2&&(i.uvs2=this.uvs2.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs3&&(i.uvs3=this.uvs3.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs4&&(i.uvs4=this.uvs4.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs5&&(i.uvs5=this.uvs5.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs6&&(i.uvs6=this.uvs6.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.matricesIndices&&(i.matricesIndices=this.matricesIndices.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesIndicesExtra&&(i.matricesIndicesExtra=this.matricesIndicesExtra.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesWeights&&(i.matricesWeights=this.matricesWeights.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesWeightsExtra&&(i.matricesWeightsExtra=this.matricesWeightsExtra.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.indices){i.indices=[];for(let r=t.indexStart;r<t.indexStart+t.indexCount;r++)i.indices.push(this.indices[r]-t.verticesStart)}const n=new Qh;n.indexStart=0,n.indexCount=i.indices?i.indices.length:0,n.materialIndex=t.materialIndex,n.verticesStart=0,n.verticesCount=(i.positions?i.positions.length:0)/3,i.materialInfos=[n],e.push(i)}return e}merge(e,t=!1,i=!1,n=!1,r=!1){const a=Array.isArray(e)?e.map(o=>({vertexData:o})):[{vertexData:e}];return im(this._mergeCoroutine(void 0,a,t,!1,i,n,r))}*_mergeCoroutine(e,t,i=!1,n,r,a=!1,o=!1){var l,c,u,h;this._validate();let d=t.map(E=>E.vertexData),f=this;for(const E of d)if(E){if(E._validate(),o)!this.normals!=!E.normals&&(this.normals?E.normals=Array.from(this.normals):this.normals=Array.from(E.normals)),!this.tangents!=!E.tangents&&(this.tangents?E.tangents=Array.from(this.tangents):this.tangents=Array.from(E.tangents)),!this.uvs!=!E.uvs&&(this.uvs?E.uvs=Array.from(this.uvs):this.uvs=Array.from(E.uvs)),!this.uvs2!=!E.uvs2&&(this.uvs2?E.uvs2=Array.from(this.uvs2):this.uvs2=Array.from(E.uvs2)),!this.uvs3!=!E.uvs3&&(this.uvs3?E.uvs3=Array.from(this.uvs3):this.uvs3=Array.from(E.uvs3)),!this.uvs4!=!E.uvs4&&(this.uvs4?E.uvs4=Array.from(this.uvs4):this.uvs4=Array.from(E.uvs4)),!this.uvs5!=!E.uvs5&&(this.uvs5?E.uvs5=Array.from(this.uvs5):this.uvs5=Array.from(E.uvs5)),!this.uvs6!=!E.uvs6&&(this.uvs6?E.uvs6=Array.from(this.uvs6):this.uvs6=Array.from(E.uvs6)),!this.colors!=!E.colors&&(this.colors?E.colors=Array.from(this.colors):this.colors=Array.from(E.colors)),!this.matricesIndices!=!E.matricesIndices&&(this.matricesIndices?E.matricesIndices=Array.from(this.matricesIndices):this.matricesIndices=Array.from(E.matricesIndices)),!this.matricesWeights!=!E.matricesWeights&&(this.matricesWeights?E.matricesWeights=Array.from(this.matricesWeights):this.matricesWeights=Array.from(E.matricesWeights)),!this.matricesIndicesExtra!=!E.matricesIndicesExtra&&(this.matricesIndicesExtra?E.matricesIndicesExtra=Array.from(this.matricesIndicesExtra):this.matricesIndicesExtra=Array.from(E.matricesIndicesExtra)),!this.matricesWeightsExtra!=!E.matricesWeightsExtra&&(this.matricesWeightsExtra?E.matricesWeightsExtra=Array.from(this.matricesWeightsExtra):this.matricesWeightsExtra=Array.from(E.matricesWeightsExtra));else if(!this.normals!=!E.normals||!this.tangents!=!E.tangents||!this.uvs!=!E.uvs||!this.uvs2!=!E.uvs2||!this.uvs3!=!E.uvs3||!this.uvs4!=!E.uvs4||!this.uvs5!=!E.uvs5||!this.uvs6!=!E.uvs6||!this.colors!=!E.colors||!this.matricesIndices!=!E.matricesIndices||!this.matricesWeights!=!E.matricesWeights||!this.matricesIndicesExtra!=!E.matricesIndicesExtra||!this.matricesWeightsExtra!=!E.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes")}if(a){let E=0,v=0,y=0;const A=[];let I=null;const T=[];for(const x of this.splitBasedOnMaterialID())T.push({vertexData:x,transform:e});for(const x of t)for(const F of x.vertexData.splitBasedOnMaterialID())T.push({vertexData:F,transform:x.transform});T.sort((x,F)=>{const L=x.vertexData.materialInfos?x.vertexData.materialInfos[0].materialIndex:0,V=F.vertexData.materialInfos?F.vertexData.materialInfos[0].materialIndex:0;return L>V?1:L===V?0:-1});for(const x of T){const F=x.vertexData;if(F.materialInfos?E=F.materialInfos[0].materialIndex:E=0,I&&I.materialIndex===E)I.indexCount+=F.indices.length,I.verticesCount+=F.positions.length/3;else{const L=new Qh;L.materialIndex=E,L.indexStart=v,L.indexCount=F.indices.length,L.verticesStart=y,L.verticesCount=F.positions.length/3,A.push(L),I=L}v+=F.indices.length,y+=F.positions.length/3}const R=T.splice(0,1)[0];f=R.vertexData,e=R.transform,d=T.map(x=>x.vertexData),t=T,this.materialInfos=A}const p=d.reduce((E,v)=>{var y,A;return E+((A=(y=v.indices)===null||y===void 0?void 0:y.length)!==null&&A!==void 0?A:0)},(c=(l=f.indices)===null||l===void 0?void 0:l.length)!==null&&c!==void 0?c:0);let _=r||d.some(E=>E.indices===f.indices)?(u=f.indices)===null||u===void 0?void 0:u.slice():f.indices;if(p>0){let E=(h=_==null?void 0:_.length)!==null&&h!==void 0?h:0;if(_||(_=new Array(p)),_.length!==p){if(Array.isArray(_))_.length=p;else{const y=i||_ instanceof Uint32Array?new Uint32Array(p):new Uint16Array(p);y.set(_),_=y}e&&e.determinant()<0&&fe._FlipFaces(_,0,E)}let v=f.positions?f.positions.length/3:0;for(const{vertexData:y,transform:A}of t)if(y.indices){for(let I=0;I<y.indices.length;I++)_[E+I]=y.indices[I]+v;A&&A.determinant()<0&&fe._FlipFaces(_,E,y.indices.length),v+=y.positions.length/3,E+=y.indices.length,n&&(yield)}}return this.indices=_,this.positions=fe._MergeElement(C.PositionKind,f.positions,e,t.map(E=>[E.vertexData.positions,E.transform])),n&&(yield),f.normals&&(this.normals=fe._MergeElement(C.NormalKind,f.normals,e,t.map(E=>[E.vertexData.normals,E.transform])),n&&(yield)),f.tangents&&(this.tangents=fe._MergeElement(C.TangentKind,f.tangents,e,t.map(E=>[E.vertexData.tangents,E.transform])),n&&(yield)),f.uvs&&(this.uvs=fe._MergeElement(C.UVKind,f.uvs,e,t.map(E=>[E.vertexData.uvs,E.transform])),n&&(yield)),f.uvs2&&(this.uvs2=fe._MergeElement(C.UV2Kind,f.uvs2,e,t.map(E=>[E.vertexData.uvs2,E.transform])),n&&(yield)),f.uvs3&&(this.uvs3=fe._MergeElement(C.UV3Kind,f.uvs3,e,t.map(E=>[E.vertexData.uvs3,E.transform])),n&&(yield)),f.uvs4&&(this.uvs4=fe._MergeElement(C.UV4Kind,f.uvs4,e,t.map(E=>[E.vertexData.uvs4,E.transform])),n&&(yield)),f.uvs5&&(this.uvs5=fe._MergeElement(C.UV5Kind,f.uvs5,e,t.map(E=>[E.vertexData.uvs5,E.transform])),n&&(yield)),f.uvs6&&(this.uvs6=fe._MergeElement(C.UV6Kind,f.uvs6,e,t.map(E=>[E.vertexData.uvs6,E.transform])),n&&(yield)),f.colors&&(this.colors=fe._MergeElement(C.ColorKind,f.colors,e,t.map(E=>[E.vertexData.colors,E.transform])),n&&(yield)),f.matricesIndices&&(this.matricesIndices=fe._MergeElement(C.MatricesIndicesKind,f.matricesIndices,e,t.map(E=>[E.vertexData.matricesIndices,E.transform])),n&&(yield)),f.matricesWeights&&(this.matricesWeights=fe._MergeElement(C.MatricesWeightsKind,f.matricesWeights,e,t.map(E=>[E.vertexData.matricesWeights,E.transform])),n&&(yield)),f.matricesIndicesExtra&&(this.matricesIndicesExtra=fe._MergeElement(C.MatricesIndicesExtraKind,f.matricesIndicesExtra,e,t.map(E=>[E.vertexData.matricesIndicesExtra,E.transform])),n&&(yield)),f.matricesWeightsExtra&&(this.matricesWeightsExtra=fe._MergeElement(C.MatricesWeightsExtraKind,f.matricesWeightsExtra,e,t.map(E=>[E.vertexData.matricesWeightsExtra,E.transform]))),this}static _MergeElement(e,t,i,n){const r=n.filter(l=>l[0]!==null&&l[0]!==void 0);if(!t&&r.length==0)return t;if(!t)return this._MergeElement(e,r[0][0],r[0][1],r.slice(1));const a=r.reduce((l,c)=>l+c[0].length,t.length),o=e===C.PositionKind?fe._TransformVector3Coordinates:e===C.NormalKind?fe._TransformVector3Normals:e===C.TangentKind?fe._TransformVector4Normals:()=>{};if(t instanceof Float32Array){const l=new Float32Array(a);l.set(t),i&&o(l,i,0,t.length);let c=t.length;for(const[u,h]of r)l.set(u,c),h&&o(l,h,c,u.length),c+=u.length;return l}else{const l=new Array(a);for(let u=0;u<t.length;u++)l[u]=t[u];i&&o(l,i,0,t.length);let c=t.length;for(const[u,h]of r){for(let d=0;d<u.length;d++)l[c+d]=u[d];h&&o(l,h,c,u.length),c+=u.length}return l}}_validate(){if(!this.positions)throw new Os("Positions are required",Fr.MeshInvalidPositionsError);const e=(n,r)=>{const a=C.DeduceStride(n);if(r.length%a!==0)throw new Error("The "+n+"s array count must be a multiple of "+a);return r.length/a},t=e(C.PositionKind,this.positions),i=(n,r)=>{const a=e(n,r);if(a!==t)throw new Error("The "+n+"s element count ("+a+") does not match the positions count ("+t+")")};this.normals&&i(C.NormalKind,this.normals),this.tangents&&i(C.TangentKind,this.tangents),this.uvs&&i(C.UVKind,this.uvs),this.uvs2&&i(C.UV2Kind,this.uvs2),this.uvs3&&i(C.UV3Kind,this.uvs3),this.uvs4&&i(C.UV4Kind,this.uvs4),this.uvs5&&i(C.UV5Kind,this.uvs5),this.uvs6&&i(C.UV6Kind,this.uvs6),this.colors&&i(C.ColorKind,this.colors),this.matricesIndices&&i(C.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(C.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(C.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(C.MatricesWeightsExtraKind,this.matricesWeightsExtra)}clone(){const e=this.serialize();return fe.Parse(e)}serialize(){const e={};if(this.positions&&(e.positions=Array.from(this.positions)),this.normals&&(e.normals=Array.from(this.normals)),this.tangents&&(e.tangents=Array.from(this.tangents)),this.uvs&&(e.uvs=Array.from(this.uvs)),this.uvs2&&(e.uvs2=Array.from(this.uvs2)),this.uvs3&&(e.uvs3=Array.from(this.uvs3)),this.uvs4&&(e.uvs4=Array.from(this.uvs4)),this.uvs5&&(e.uvs5=Array.from(this.uvs5)),this.uvs6&&(e.uvs6=Array.from(this.uvs6)),this.colors&&(e.colors=Array.from(this.colors)),this.matricesIndices&&(e.matricesIndices=Array.from(this.matricesIndices),e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=Array.from(this.matricesWeights)),this.matricesIndicesExtra&&(e.matricesIndicesExtra=Array.from(this.matricesIndicesExtra),e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=Array.from(this.matricesWeightsExtra)),e.indices=Array.from(this.indices),this.materialInfos){e.materialInfos=[];for(const t of this.materialInfos){const i={indexStart:t.indexStart,indexCount:t.indexCount,materialIndex:t.materialIndex,verticesStart:t.verticesStart,verticesCount:t.verticesCount};e.materialInfos.push(i)}}return e}static ExtractFromMesh(e,t,i){return fe._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return fe._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){const n=new fe;return e.isVerticesDataPresent(C.PositionKind)&&(n.positions=e.getVerticesData(C.PositionKind,t,i)),e.isVerticesDataPresent(C.NormalKind)&&(n.normals=e.getVerticesData(C.NormalKind,t,i)),e.isVerticesDataPresent(C.TangentKind)&&(n.tangents=e.getVerticesData(C.TangentKind,t,i)),e.isVerticesDataPresent(C.UVKind)&&(n.uvs=e.getVerticesData(C.UVKind,t,i)),e.isVerticesDataPresent(C.UV2Kind)&&(n.uvs2=e.getVerticesData(C.UV2Kind,t,i)),e.isVerticesDataPresent(C.UV3Kind)&&(n.uvs3=e.getVerticesData(C.UV3Kind,t,i)),e.isVerticesDataPresent(C.UV4Kind)&&(n.uvs4=e.getVerticesData(C.UV4Kind,t,i)),e.isVerticesDataPresent(C.UV5Kind)&&(n.uvs5=e.getVerticesData(C.UV5Kind,t,i)),e.isVerticesDataPresent(C.UV6Kind)&&(n.uvs6=e.getVerticesData(C.UV6Kind,t,i)),e.isVerticesDataPresent(C.ColorKind)&&(n.colors=e.getVerticesData(C.ColorKind,t,i)),e.isVerticesDataPresent(C.MatricesIndicesKind)&&(n.matricesIndices=e.getVerticesData(C.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(C.MatricesWeightsKind)&&(n.matricesWeights=e.getVerticesData(C.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(C.MatricesIndicesExtraKind)&&(n.matricesIndicesExtra=e.getVerticesData(C.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(C.MatricesWeightsExtraKind)&&(n.matricesWeightsExtra=e.getVerticesData(C.MatricesWeightsExtraKind,t,i)),n.indices=e.getIndices(t,i),n}static CreateRibbon(e){throw De("ribbonBuilder")}static CreateBox(e){throw De("boxBuilder")}static CreateTiledBox(e){throw De("tiledBoxBuilder")}static CreateTiledPlane(e){throw De("tiledPlaneBuilder")}static CreateSphere(e){throw De("sphereBuilder")}static CreateCylinder(e){throw De("cylinderBuilder")}static CreateTorus(e){throw De("torusBuilder")}static CreateLineSystem(e){throw De("linesBuilder")}static CreateDashedLines(e){throw De("linesBuilder")}static CreateGround(e){throw De("groundBuilder")}static CreateTiledGround(e){throw De("groundBuilder")}static CreateGroundFromHeightMap(e){throw De("groundBuilder")}static CreatePlane(e){throw De("planeBuilder")}static CreateDisc(e){throw De("discBuilder")}static CreatePolygon(e,t,i,n,r,a,o){throw De("polygonBuilder")}static CreateIcoSphere(e){throw De("icoSphereBuilder")}static CreatePolyhedron(e){throw De("polyhedronBuilder")}static CreateCapsule(e={orientation:g.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw De("capsuleBuilder")}static CreateTorusKnot(e){throw De("torusKnotBuilder")}static ComputeNormals(e,t,i,n){let r=0,a=0,o=0,l=0,c=0,u=0,h=0,d=0,f=0,p=0,m=0,_=0,E=0,v=0,y=0,A=0,I=0,T=0,R=0,x=0,F=!1,L=!1,V=!1,Z=!1,ne=1,ae=0,Ue=null;n&&(F=!!n.facetNormals,L=!!n.facetPositions,V=!!n.facetPartitioning,ne=n.useRightHandedSystem===!0?-1:1,ae=n.ratio||0,Z=!!n.depthSort,Ue=n.distanceTo,Z&&Ue===void 0&&(Ue=g.Zero()));let Ve=0,$e=0,re=0,ge=0;for(V&&n&&n.bbSize&&(Ve=n.subDiv.X*ae/n.bbSize.x,$e=n.subDiv.Y*ae/n.bbSize.y,re=n.subDiv.Z*ae/n.bbSize.z,ge=n.subDiv.max*n.subDiv.max,n.facetPartitioning.length=0),r=0;r<e.length;r++)i[r]=0;const be=t.length/3|0;for(r=0;r<be;r++){if(_=t[r*3]*3,E=_+1,v=_+2,y=t[r*3+1]*3,A=y+1,I=y+2,T=t[r*3+2]*3,R=T+1,x=T+2,a=e[_]-e[y],o=e[E]-e[A],l=e[v]-e[I],c=e[T]-e[y],u=e[R]-e[A],h=e[x]-e[I],d=ne*(o*h-l*u),f=ne*(l*c-a*h),p=ne*(a*u-o*c),m=Math.sqrt(d*d+f*f+p*p),m=m===0?1:m,d/=m,f/=m,p/=m,F&&n&&(n.facetNormals[r].x=d,n.facetNormals[r].y=f,n.facetNormals[r].z=p),L&&n&&(n.facetPositions[r].x=(e[_]+e[y]+e[T])/3,n.facetPositions[r].y=(e[E]+e[A]+e[R])/3,n.facetPositions[r].z=(e[v]+e[I]+e[x])/3),V&&n){const ze=Math.floor((n.facetPositions[r].x-n.bInfo.minimum.x*ae)*Ve),Ke=Math.floor((n.facetPositions[r].y-n.bInfo.minimum.y*ae)*$e),Ut=Math.floor((n.facetPositions[r].z-n.bInfo.minimum.z*ae)*re),st=Math.floor((e[_]-n.bInfo.minimum.x*ae)*Ve),Jt=Math.floor((e[E]-n.bInfo.minimum.y*ae)*$e),Wt=Math.floor((e[v]-n.bInfo.minimum.z*ae)*re),ii=Math.floor((e[y]-n.bInfo.minimum.x*ae)*Ve),$i=Math.floor((e[A]-n.bInfo.minimum.y*ae)*$e),Ji=Math.floor((e[I]-n.bInfo.minimum.z*ae)*re),en=Math.floor((e[T]-n.bInfo.minimum.x*ae)*Ve),vn=Math.floor((e[R]-n.bInfo.minimum.y*ae)*$e),Ne=Math.floor((e[x]-n.bInfo.minimum.z*ae)*re),Xe=st+n.subDiv.max*Jt+ge*Wt,_i=ii+n.subDiv.max*$i+ge*Ji,yt=en+n.subDiv.max*vn+ge*Ne,Ge=ze+n.subDiv.max*Ke+ge*Ut;n.facetPartitioning[Ge]=n.facetPartitioning[Ge]?n.facetPartitioning[Ge]:new Array,n.facetPartitioning[Xe]=n.facetPartitioning[Xe]?n.facetPartitioning[Xe]:new Array,n.facetPartitioning[_i]=n.facetPartitioning[_i]?n.facetPartitioning[_i]:new Array,n.facetPartitioning[yt]=n.facetPartitioning[yt]?n.facetPartitioning[yt]:new Array,n.facetPartitioning[Xe].push(r),_i!=Xe&&n.facetPartitioning[_i].push(r),yt==_i||yt==Xe||n.facetPartitioning[yt].push(r),Ge==Xe||Ge==_i||Ge==yt||n.facetPartitioning[Ge].push(r)}if(Z&&n&&n.facetPositions){const ze=n.depthSortedFacets[r];ze.ind=r*3,ze.sqDistance=g.DistanceSquared(n.facetPositions[r],Ue)}i[_]+=d,i[E]+=f,i[v]+=p,i[y]+=d,i[A]+=f,i[I]+=p,i[T]+=d,i[R]+=f,i[x]+=p}for(r=0;r<i.length/3;r++)d=i[r*3],f=i[r*3+1],p=i[r*3+2],m=Math.sqrt(d*d+f*f+p*p),m=m===0?1:m,d/=m,f/=m,p/=m,i[r*3]=d,i[r*3+1]=f,i[r*3+2]=p}static _ComputeSides(e,t,i,n,r,a,o){const l=i.length,c=n.length;let u,h;switch(e=e||fe.DEFAULTSIDE,e){case fe.FRONTSIDE:break;case fe.BACKSIDE:for(u=0;u<l;u+=3){const d=i[u];i[u]=i[u+2],i[u+2]=d}for(h=0;h<c;h++)n[h]=-n[h];break;case fe.DOUBLESIDE:{const d=t.length,f=d/3;for(let _=0;_<d;_++)t[d+_]=t[_];for(u=0;u<l;u+=3)i[u+l]=i[u+2]+f,i[u+1+l]=i[u+1]+f,i[u+2+l]=i[u]+f;for(h=0;h<c;h++)n[c+h]=-n[h];const p=r.length;let m=0;for(m=0;m<p;m++)r[m+p]=r[m];for(a=a||new dt(0,0,1,1),o=o||new dt(0,0,1,1),m=0,u=0;u<p/2;u++)r[m]=a.x+(a.z-a.x)*r[m],r[m+1]=a.y+(a.w-a.y)*r[m+1],r[m+p]=o.x+(o.z-o.x)*r[m+p],r[m+p+1]=o.y+(o.w-o.y)*r[m+p+1],m+=2;break}}}static Parse(e){const t=new fe,i=e.positions;i&&t.set(i,C.PositionKind);const n=e.normals;n&&t.set(n,C.NormalKind);const r=e.tangents;r&&t.set(r,C.TangentKind);const a=e.uvs;a&&t.set(a,C.UVKind);const o=e.uvs2;o&&t.set(o,C.UV2Kind);const l=e.uvs3;l&&t.set(l,C.UV3Kind);const c=e.uvs4;c&&t.set(c,C.UV4Kind);const u=e.uvs5;u&&t.set(u,C.UV5Kind);const h=e.uvs6;h&&t.set(h,C.UV6Kind);const d=e.colors;d&&t.set(pe.CheckColors4(d,i.length/3),C.ColorKind);const f=e.matricesIndices;f&&t.set(f,C.MatricesIndicesKind);const p=e.matricesWeights;p&&t.set(p,C.MatricesWeightsKind);const m=e.indices;m&&(t.indices=m);const _=e.materialInfos;if(_){t.materialInfos=[];for(const E of _){const v=new Qh;v.indexCount=E.indexCount,v.indexStart=E.indexStart,v.verticesCount=E.verticesCount,v.verticesStart=E.verticesStart,v.materialIndex=E.materialIndex,t.materialInfos.push(v)}}return t}static ImportVertexData(e,t){const i=fe.Parse(e);t.setAllVerticesData(i,e.updatable)}}fe.FRONTSIDE=0;fe.BACKSIDE=1;fe.DOUBLESIDE=2;fe.DEFAULTSIDE=0;fe._UniqueIDGenerator=0;S([Gr.filter((...[s])=>!Array.isArray(s))],fe,"_TransformVector3Coordinates",null);S([Gr.filter((...[s])=>!Array.isArray(s))],fe,"_TransformVector3Normals",null);S([Gr.filter((...[s])=>!Array.isArray(s))],fe,"_TransformVector4Normals",null);S([Gr.filter((...[s])=>!Array.isArray(s))],fe,"_FlipFaces",null);class ri{static get ForceFullSceneLoadingForIncremental(){return ri._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){ri._ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return ri._ShowLoadingScreen}static set ShowLoadingScreen(e){ri._ShowLoadingScreen=e}static get loggingLevel(){return ri._LoggingLevel}static set loggingLevel(e){ri._LoggingLevel=e}static get CleanBoneMatrixWeights(){return ri._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){ri._CleanBoneMatrixWeights=e}}ri._ForceFullSceneLoadingForIncremental=!1;ri._ShowLoadingScreen=!0;ri._CleanBoneMatrixWeights=!1;ri._LoggingLevel=0;class Ki{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){const t=new Ki(Ki.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,t,i,n=!1,r=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||Fe.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=n,i?this.setAllVerticesData(i,n):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),r&&(this.applyToMesh(r),r.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return this.delayLoadState===1||this.delayLoadState===0}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable));for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,i=!1,n){i&&Array.isArray(t)&&(t=new Float32Array(t));const r=new C(this._engine,t,e,i,this._meshes.length===0,n);this.setVerticesBuffer(r)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,i=!0){const n=e.getKind();this._vertexBuffers[n]&&i&&this._vertexBuffers[n].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[n]=e;const r=this._meshes,a=r.length;if(n===C.PositionKind){const o=e.getData();t!=null?this._totalVertices=t:o!=null&&(this._totalVertices=o.length/(e.type===C.BYTE?e.byteStride:e.byteStride/4)),this._updateExtend(o),this._resetPointsArrayCache();for(let l=0;l<a;l++){const c=r[l];c.buildBoundingInfo(this._extend.minimum,this._extend.maximum),c._createGlobalSubMesh(c.isUnIndexed),c.computeWorldMatrix(!0),c.synchronizeInstances()}}this._notifyUpdate(n)}updateVerticesDataDirectly(e,t,i,n=!1){const r=this.getVertexBuffer(e);r&&(r.updateDirectly(t,i,n),this._notifyUpdate(e))}updateVerticesData(e,t,i=!1){const n=this.getVertexBuffer(e);n&&(n.update(t),e===C.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){const i=this._meshes;for(const n of i){n.hasBoundingInfo?n.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):n.buildBoundingInfo(this._extend.minimum,this._extend.maximum);const r=n.subMeshes;for(const a of r)a.refreshBoundingInfo()}}}_bind(e,t,i,n){if(!e)return;t===void 0&&(t=this._indexBuffer);const r=this.getVertexBuffers();if(!r)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!n){this._engine.bindBuffers(r,t,e,i);return}const a=n||this._vertexArrayObjects;a[e.key]||(a[e.key]=this._engine.recordVertexArrayObject(r,t,e,i)),this._engine.bindVertexArrayObject(a[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){const n=this.getVertexBuffer(e);return n?n.getFloatData(this._totalVertices,i||t&&this._meshes.length!==1):null}isVertexBufferUpdatable(e){const t=this._vertexBuffers[e];return t?t.isUpdatable():!1}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?this._vertexBuffers[e]!==void 0:this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}getVerticesDataKinds(){const e=[];let t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=!1){if(this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(e,null,!0);else{const n=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),n)for(const r of this._meshes)r._createGlobalSubMesh(!0)}}setIndices(e,t=null,i=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i)),t!=null&&(this._totalVertices=t);for(const n of this._meshes)n._createGlobalSubMesh(!0),n.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;const i=this._indices;return!t&&(!e||this._meshes.length===1)?i:i.slice()}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){const i=this._meshes,n=i.indexOf(e);n!==-1&&(i.splice(n,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,i.length===0&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;const t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();const i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&(e=this.getVerticesData(C.PositionKind),!e))return;this._extend=RE(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){const t=this._meshes.length;for(const i in this._vertexBuffers)t===1&&this._vertexBuffers[i].create(),i===C.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());t===1&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(const t of this._meshes)t._markSubMeshesAsAttributesDirty()}load(e,t){if(this.delayLoadState!==2){if(this.isReady()){t&&t();return}this.delayLoadState=2,this._queueLoad(e,t)}}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);const n=this._meshes,r=n.length;for(let a=0;a<r;a++)this._applyToMesh(n[a]);t&&t()},void 0,!0))}toLeftHanded(){const e=this.getIndices(!1);if(e!=null&&e.length>0){for(let n=0;n<e.length;n+=3){const r=e[n+0];e[n+0]=e[n+2],e[n+2]=r}this.setIndices(e)}const t=this.getVerticesData(C.PositionKind,!1);if(t!=null&&t.length>0){for(let n=0;n<t.length;n+=3)t[n+2]=-t[n+2];this.setVerticesData(C.PositionKind,t,!1)}const i=this.getVerticesData(C.NormalKind,!1);if(i!=null&&i.length>0){for(let n=0;n<i.length;n+=3)i[n+2]=-i[n+2];this.setVerticesData(C.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;const e=this.getVerticesData(C.PositionKind);if(!e||e.length===0)return!1;for(let t=this._positionsCache.length*3,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=g.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(const i in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[i]);this._vertexArrayObjects={};const e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject()}}dispose(){const e=this._meshes,t=e.length;let i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(const n in this._vertexBuffers)this._vertexBuffers[n].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){const n=this._parentContainer.geometries.indexOf(this);n>-1&&this._parentContainer.geometries.splice(n,1),this._parentContainer=null}this._isDisposed=!0}copy(e){const t=new fe;t.indices=[];const i=this.getIndices();if(i)for(let l=0;l<i.length;l++)t.indices.push(i[l]);let n=!1,r=!1,a;for(a in this._vertexBuffers){const l=this.getVerticesData(a);if(l&&(l instanceof Float32Array?t.set(new Float32Array(l),a):t.set(l.slice(0),a),!r)){const c=this.getVertexBuffer(a);c&&(n=c.isUpdatable(),r=!n)}}const o=new Ki(e,this._scene,t,n);o.delayLoadState=this.delayLoadState,o.delayLoadingFile=this.delayLoadingFile,o._delayLoadingFunction=this._delayLoadingFunction;for(a in this._delayInfo)o._delayInfo=o._delayInfo||[],o._delayInfo.push(a);return o._boundingInfo=new Pn(this._extend.minimum,this._extend.maximum),o}serialize(){const e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,Ye&&Ye.HasTags(this)&&(e.tags=Ye.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(const e in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){const e=this.serialize();return this.isVerticesDataPresent(C.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(C.PositionKind)),this.isVertexBufferUpdatable(C.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(C.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(C.NormalKind)),this.isVertexBufferUpdatable(C.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(C.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(C.TangentKind)),this.isVertexBufferUpdatable(C.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(C.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(C.UVKind)),this.isVertexBufferUpdatable(C.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(C.UV2Kind)&&(e.uv2s=this._toNumberArray(this.getVerticesData(C.UV2Kind)),this.isVertexBufferUpdatable(C.UV2Kind)&&(e.uv2s._updatable=!0)),this.isVerticesDataPresent(C.UV3Kind)&&(e.uv3s=this._toNumberArray(this.getVerticesData(C.UV3Kind)),this.isVertexBufferUpdatable(C.UV3Kind)&&(e.uv3s._updatable=!0)),this.isVerticesDataPresent(C.UV4Kind)&&(e.uv4s=this._toNumberArray(this.getVerticesData(C.UV4Kind)),this.isVertexBufferUpdatable(C.UV4Kind)&&(e.uv4s._updatable=!0)),this.isVerticesDataPresent(C.UV5Kind)&&(e.uv5s=this._toNumberArray(this.getVerticesData(C.UV5Kind)),this.isVertexBufferUpdatable(C.UV5Kind)&&(e.uv5s._updatable=!0)),this.isVerticesDataPresent(C.UV6Kind)&&(e.uv6s=this._toNumberArray(this.getVerticesData(C.UV6Kind)),this.isVertexBufferUpdatable(C.UV6Kind)&&(e.uv6s._updatable=!0)),this.isVerticesDataPresent(C.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(C.ColorKind)),this.isVertexBufferUpdatable(C.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(C.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(C.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(C.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(C.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(C.MatricesWeightsKind)),this.isVertexBufferUpdatable(C.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){const i=e._geometry;return i?i.copy(t):null}static RandomId(){return q.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){const i=t.getScene(),n=e.geometryUniqueId,r=e.geometryId;if(n||r){const a=n?this._GetGeometryByLoadedUniqueId(n,i):i.getGeometryById(r);a&&a.applyToMesh(t)}else if(e instanceof ArrayBuffer){const a=t._binaryInfo;if(a.positionsAttrDesc&&a.positionsAttrDesc.count>0){const o=new Float32Array(e,a.positionsAttrDesc.offset,a.positionsAttrDesc.count);t.setVerticesData(C.PositionKind,o,!1)}if(a.normalsAttrDesc&&a.normalsAttrDesc.count>0){const o=new Float32Array(e,a.normalsAttrDesc.offset,a.normalsAttrDesc.count);t.setVerticesData(C.NormalKind,o,!1)}if(a.tangetsAttrDesc&&a.tangetsAttrDesc.count>0){const o=new Float32Array(e,a.tangetsAttrDesc.offset,a.tangetsAttrDesc.count);t.setVerticesData(C.TangentKind,o,!1)}if(a.uvsAttrDesc&&a.uvsAttrDesc.count>0){const o=new Float32Array(e,a.uvsAttrDesc.offset,a.uvsAttrDesc.count);if(Pi.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(C.UVKind,o,!1)}if(a.uvs2AttrDesc&&a.uvs2AttrDesc.count>0){const o=new Float32Array(e,a.uvs2AttrDesc.offset,a.uvs2AttrDesc.count);if(Pi.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(C.UV2Kind,o,!1)}if(a.uvs3AttrDesc&&a.uvs3AttrDesc.count>0){const o=new Float32Array(e,a.uvs3AttrDesc.offset,a.uvs3AttrDesc.count);if(Pi.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(C.UV3Kind,o,!1)}if(a.uvs4AttrDesc&&a.uvs4AttrDesc.count>0){const o=new Float32Array(e,a.uvs4AttrDesc.offset,a.uvs4AttrDesc.count);if(Pi.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(C.UV4Kind,o,!1)}if(a.uvs5AttrDesc&&a.uvs5AttrDesc.count>0){const o=new Float32Array(e,a.uvs5AttrDesc.offset,a.uvs5AttrDesc.count);if(Pi.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(C.UV5Kind,o,!1)}if(a.uvs6AttrDesc&&a.uvs6AttrDesc.count>0){const o=new Float32Array(e,a.uvs6AttrDesc.offset,a.uvs6AttrDesc.count);if(Pi.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(C.UV6Kind,o,!1)}if(a.colorsAttrDesc&&a.colorsAttrDesc.count>0){const o=new Float32Array(e,a.colorsAttrDesc.offset,a.colorsAttrDesc.count);t.setVerticesData(C.ColorKind,o,!1,a.colorsAttrDesc.stride)}if(a.matricesIndicesAttrDesc&&a.matricesIndicesAttrDesc.count>0){const o=new Int32Array(e,a.matricesIndicesAttrDesc.offset,a.matricesIndicesAttrDesc.count),l=[];for(let c=0;c<o.length;c++){const u=o[c];l.push(u&255),l.push((u&65280)>>8),l.push((u&16711680)>>16),l.push(u>>24&255)}t.setVerticesData(C.MatricesIndicesKind,l,!1)}if(a.matricesIndicesExtraAttrDesc&&a.matricesIndicesExtraAttrDesc.count>0){const o=new Int32Array(e,a.matricesIndicesExtraAttrDesc.offset,a.matricesIndicesExtraAttrDesc.count),l=[];for(let c=0;c<o.length;c++){const u=o[c];l.push(u&255),l.push((u&65280)>>8),l.push((u&16711680)>>16),l.push(u>>24&255)}t.setVerticesData(C.MatricesIndicesExtraKind,l,!1)}if(a.matricesWeightsAttrDesc&&a.matricesWeightsAttrDesc.count>0){const o=new Float32Array(e,a.matricesWeightsAttrDesc.offset,a.matricesWeightsAttrDesc.count);t.setVerticesData(C.MatricesWeightsKind,o,!1)}if(a.indicesAttrDesc&&a.indicesAttrDesc.count>0){const o=new Int32Array(e,a.indicesAttrDesc.offset,a.indicesAttrDesc.count);t.setIndices(o,null)}if(a.subMeshesAttrDesc&&a.subMeshesAttrDesc.count>0){const o=new Int32Array(e,a.subMeshesAttrDesc.offset,a.subMeshesAttrDesc.count*5);t.subMeshes=[];for(let l=0;l<a.subMeshesAttrDesc.count;l++){const c=o[l*5+0],u=o[l*5+1],h=o[l*5+2],d=o[l*5+3],f=o[l*5+4];Jn.AddToMesh(c,u,h,d,f,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(C.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(C.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(C.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(C.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(C.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(C.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(C.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(C.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(C.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(C.ColorKind,pe.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(C.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{const a=[];for(let o=0;o<e.matricesIndices.length;o++){const l=e.matricesIndices[o];a.push(l&255),a.push((l&65280)>>8),a.push((l&16711680)>>16),a.push(l>>24&255)}t.setVerticesData(C.MatricesIndicesKind,a,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(C.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{const a=[];for(let o=0;o<e.matricesIndicesExtra.length;o++){const l=e.matricesIndicesExtra[o];a.push(l&255),a.push((l&65280)>>8),a.push((l&16711680)>>16),a.push(l>>24&255)}t.setVerticesData(C.MatricesIndicesExtraKind,a,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(Ki._CleanMatricesWeights(e,t),t.setVerticesData(C.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(C.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let a=0;a<e.subMeshes.length;a++){const o=e.subMeshes[a];Jn.AddToMesh(o.materialIndex,o.verticesStart,o.verticesCount,o.indexStart,o.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){if(!ri.CleanBoneMatrixWeights)return;let n=0;if(e.skeletonId>-1){const h=t.getScene().getLastSkeletonById(e.skeletonId);if(!h)return;n=h.bones.length}else return;const r=t.getVerticesData(C.MatricesIndicesKind),a=t.getVerticesData(C.MatricesIndicesExtraKind),o=e.matricesWeights,l=e.matricesWeightsExtra,c=e.numBoneInfluencer,u=o.length;for(let h=0;h<u;h+=4){let d=0,f=-1;for(let p=0;p<4;p++){const m=o[h+p];d+=m,m<.001&&f<0&&(f=p)}if(l)for(let p=0;p<4;p++){const m=l[h+p];d+=m,m<.001&&f<0&&(f=p+4)}if((f<0||f>c-1)&&(f=c-1),d>.001){const p=1/d;for(let m=0;m<4;m++)o[h+m]*=p;if(l)for(let m=0;m<4;m++)l[h+m]*=p}else f>=4?(l[h+f-4]=1-d,a[h+f-4]=n):(o[h+f]=1-d,r[h+f]=n)}t.setVerticesData(C.MatricesIndicesKind,r),e.matricesWeightsExtra&&t.setVerticesData(C.MatricesIndicesExtraKind,a)}static Parse(e,t,i){const n=new Ki(e.id,t,void 0,e.updatable);return n._loadedUniqueId=e.uniqueId,Ye&&Ye.AddTagsTo(n,e.tags),e.delayLoadingFile?(n.delayLoadState=4,n.delayLoadingFile=i+e.delayLoadingFile,n._boundingInfo=new Pn(g.FromArray(e.boundingBoxMinimum),g.FromArray(e.boundingBoxMaximum)),n._delayInfo=[],e.hasUVs&&n._delayInfo.push(C.UVKind),e.hasUVs2&&n._delayInfo.push(C.UV2Kind),e.hasUVs3&&n._delayInfo.push(C.UV3Kind),e.hasUVs4&&n._delayInfo.push(C.UV4Kind),e.hasUVs5&&n._delayInfo.push(C.UV5Kind),e.hasUVs6&&n._delayInfo.push(C.UV6Kind),e.hasColors&&n._delayInfo.push(C.ColorKind),e.hasMatricesIndices&&n._delayInfo.push(C.MatricesIndicesKind),e.hasMatricesWeights&&n._delayInfo.push(C.MatricesWeightsKind),n._delayLoadingFunction=fe.ImportVertexData):fe.ImportVertexData(e,n),t.pushGeometry(n,!0),n}}class ob{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new g(0,0,0),this._diffPositionForCollisions=new g(0,0,0),this._collisionResponse=!0}}class lb{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=g.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}}class cb{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new lb,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new ob,this._enableDistantPicking=!1,this._rawBoundingInfo=null}}class wn extends Me{static get BILLBOARDMODE_NONE(){return Me.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return Me.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return Me.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return Me.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return Me.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return Me.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return super._updateNonUniformScalingState(e)?(this._markSubMeshesAsMiscDirty(),!0):!1}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(e){this._internalAbstractMeshDataInfo._rawBoundingInfo=e}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;const t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(t===1&&e!==1||t!==1&&e===1)&&this._markSubMeshesAsDirty(i=>{i.markAsMiscDirty(),i.markAsPrePassDirty()})}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}getMaterialForRenderPass(e){var t;return(t=this._internalAbstractMeshDataInfo._materialForRenderPass)===null||t===void 0?void 0:t[e]}setMaterialForRenderPass(e,t){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}get _positions(){return null}set skeleton(e){const t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(e,t=null){switch(super(e,t,!1),this._internalAbstractMeshDataInfo=new cb,this._waitingMaterialId=null,this.cullingStrategy=wn.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new O,this.onCollisionPositionChangeObservable=new O,this.onMaterialChangedObservable=new O,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=G.Red(),this.outlineWidth=.02,this.overlayColor=G.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new g(.5,1,.5),this.ellipsoidOffset=new g(0,0,0),this.edgesWidth=1,this.edgesColor=new pe(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new O,this._onCollisionPositionChange=(i,n,r=null)=>{n.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>k.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),r&&this.onCollideObservable.notifyObservers(r),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},t=this.getScene(),t.addMesh(this),this._resyncLightSources(),this._uniformBuffer=new le(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),t.performancePriority){case hs.Aggressive:this.doNotSyncBoundingInfo=!0;case hs.Intermediate:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1;break}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(e){const t=this._uniformBuffer;t.updateMatrix("world",e),t.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),t.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(e){let t="Name: "+this.name+", isInstance: "+(this.getClassName()!=="InstancedMesh"?"YES":"NO");t+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const i=this._internalAbstractMeshDataInfo._skeleton;return i&&(t+=", skeleton: "+i.name),e&&(t+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],t+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),t}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==Me.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,t=!0){if(this.actionManager&&(t||this.actionManager.isRecursive))if(e){if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes)for(const t of this.subMeshes)t._rebuild()}_resyncLightSources(){this._lightSources.length=0;for(const e of this.getScene().lights)e.isEnabled()&&e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){const t=e.isEnabled()&&e.canAffectMesh(this),i=this._lightSources.indexOf(e);let n=!1;if(i===-1){if(!t)return;this._lightSources.push(e)}else{if(t)return;n=!0,this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty(n)}_unBindEffect(){for(const e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,t){const i=this._lightSources.indexOf(e);i!==-1&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(t))}_markSubMeshesAsDirty(e){if(this.subMeshes)for(const t of this.subMeshes)for(let i=0;i<t._drawWrappers.length;++i){const n=t._drawWrappers[i];!n||!n.defines||!n.defines.markAllAsDirty||e(n.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty(t=>t.markAsLightDirty(e))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(e=>e.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(e=>e.markAsMiscDirty())}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}resetDrawCache(e){if(this.subMeshes)for(const t of this.subMeshes)t.resetDrawCache(e)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,t,i,n){return this}updateVerticesData(e,t,i,n){return this}setIndices(e,t){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){var e;return(e=this.rawBoundingInfo)!==null&&e!==void 0?e:this.getBoundingInfo()}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return this._boundingInfo!==null}buildBoundingInfo(e,t,i){return this._boundingInfo=new Pn(e,t,i),this._boundingInfo}normalizeToUnitCube(e=!0,t=!1,i){return super.normalizeToUnitCube(e,t,i)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(C.MatricesIndicesKind)&&this.isVerticesDataPresent(C.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,t){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===Me.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,t,i){return this.position.addInPlace(this.calcMovePOV(e,t,i)),this}calcMovePOV(e,t,i){const n=new D;(this.rotationQuaternion?this.rotationQuaternion:ee.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(n);const a=g.Zero(),o=this.definedFacingForward?-1:1;return g.TransformCoordinatesFromFloatsToRef(e*o,t,i*o,n,a),a}rotatePOV(e,t,i){return this.rotation.addInPlace(this.calcRotatePOV(e,t,i)),this}calcRotatePOV(e,t,i){const n=this.definedFacingForward?1:-1;return new g(e*n,t,i*n)}refreshBoundingInfo(e=!1,t=!1){return this._boundingInfo&&this._boundingInfo.isLocked?this:(this._refreshBoundingInfo(this._getPositionData(e,t),null),this)}_refreshBoundingInfo(e,t){if(e){const i=RE(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Pn(i.minimum,i.maximum)}if(this.subMeshes)for(let i=0;i<this.subMeshes.length;i++)this.subMeshes[i].refreshBoundingInfo(e);this._updateBoundingInfo()}_getData(e=!1,t=!1,i,n=C.PositionKind){if(i=i!=null?i:this.getVerticesData(n).slice(),i&&t&&this.morphTargetManager){let r=0,a=0;for(let o=0;o<i.length;o++){for(let l=0;l<this.morphTargetManager.numTargets;l++){const c=this.morphTargetManager.getTarget(l),u=c.influence;if(u>0){const h=c.getPositions();h&&(i[o]+=(h[o]-i[o])*u)}}if(r++,n===C.PositionKind&&this._positions&&r===3){r=0;const l=a*3;this._positions[a++].copyFromFloats(i[l],i[l+1],i[l+2])}}}if(i&&e&&this.skeleton){const r=this.getVerticesData(C.MatricesIndicesKind),a=this.getVerticesData(C.MatricesWeightsKind);if(a&&r){const o=this.numBoneInfluencers>4,l=o?this.getVerticesData(C.MatricesIndicesExtraKind):null,c=o?this.getVerticesData(C.MatricesWeightsExtraKind):null,u=this.skeleton.getTransformMatrices(this),h=w.Vector3[0],d=w.Matrix[0],f=w.Matrix[1];let p=0;for(let m=0;m<i.length;m+=3,p+=4){d.reset();let _,E;for(_=0;_<4;_++)E=a[p+_],E>0&&(D.FromFloat32ArrayToRefScaled(u,Math.floor(r[p+_]*16),E,f),d.addToSelf(f));if(o)for(_=0;_<4;_++)E=c[p+_],E>0&&(D.FromFloat32ArrayToRefScaled(u,Math.floor(l[p+_]*16),E,f),d.addToSelf(f));n===C.NormalKind?g.TransformNormalFromFloatsToRef(i[m],i[m+1],i[m+2],d,h):g.TransformCoordinatesFromFloatsToRef(i[m],i[m+1],i[m+2],d,h),h.toArray(i,m),n===C.PositionKind&&this._positions&&this._positions[m/3].copyFrom(h)}}}return i}getNormalsData(e=!1,t=!1){return this._getData(e,t,null,C.NormalKind)}getPositionData(e=!1,t=!1,i){return this._getData(e,t,i,C.PositionKind)}_getPositionData(e,t){var i;let n=this.getVerticesData(C.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),n&&(e&&this.skeleton||t&&this.morphTargetManager)){if(n=n.slice(),this._generatePointsArray(),this._positions){const r=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(r.length);for(let a=0;a<r.length;a++)this._internalAbstractMeshDataInfo._positions[a]=((i=r[a])===null||i===void 0?void 0:i.clone())||new g}return this.getPositionData(e,t,n)}return n}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new Pn(g.Zero(),g.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;const t=this.subMeshes.length;for(let i=0;i<t;i++){const n=this.subMeshes[i];(t>1||!n.IsGlobal)&&n.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,t=!1,i){const n=this.getBoundingInfo(),r=e.getBoundingInfo();if(n.intersects(r,t))return!0;if(i){for(const a of this.getChildMeshes())if(a.intersectsMesh(e,t,!0))return!0}return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);const i=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=i.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,i.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(e,t,i){var n;if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];const r=e.verticesStart,a=e.verticesStart+e.verticesCount;for(let o=r;o<a;o++)e._lastColliderWorldVertices.push(g.TransformCoordinates(this._positions[o],t))}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),((n=e.getMaterial())===null||n===void 0?void 0:n.fillMode)===7),this}_processCollisionsForSubMeshes(e,t){const i=this._scene.getCollidingSubMeshCandidates(this,e),n=i.length;for(let r=0;r<n;r++){const a=i.data[r];n>1&&!a._checkCollision(e)||this._collideForSubMesh(a,t,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;const t=w.Matrix[0],i=w.Matrix[1];return D.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,i),this._processCollisionsForSubMeshes(e,i),this}_generatePointsArray(){return!1}intersects(e,t,i,n=!1,r,a=!1){const o=new ar,l=this.getClassName(),c=l==="InstancedLinesMesh"||l==="LinesMesh"||l==="GreasedLineMesh"?this.intersectionThreshold:0,u=this.getBoundingInfo();if(!this.subMeshes||!a&&(!e.intersectsSphere(u.boundingSphere,c)||!e.intersectsBox(u.boundingBox,c)))return o;if(n)return o.hit=!a,o.pickedMesh=a?null:this,o.distance=a?0:g.Distance(e.origin,u.boundingSphere.center),o.subMeshId=0,o;if(!this._generatePointsArray())return o;let h=null;const d=this._scene.getIntersectingSubMeshCandidates(this,e),f=d.length;let p=!1;for(let m=0;m<f;m++){const E=d.data[m].getMaterial();if(E&&(E.fillMode==7||E.fillMode==0||E.fillMode==1||E.fillMode==2||E.fillMode==4)){p=!0;break}}if(!p)return o.hit=!0,o.pickedMesh=this,o.distance=g.Distance(e.origin,u.boundingSphere.center),o.subMeshId=-1,o;for(let m=0;m<f;m++){const _=d.data[m];if(f>1&&!_.canIntersects(e))continue;const E=_.intersects(e,this._positions,this.getIndices(),t,i);if(E&&(t||!h||E.distance<h.distance)&&(h=E,h.subMeshId=m,t))break}if(h){const m=r!=null?r:this.getWorldMatrix(),_=w.Vector3[0],E=w.Vector3[1];g.TransformCoordinatesToRef(e.origin,m,_),e.direction.scaleToRef(h.distance,E);const y=g.TransformNormal(E,m).addInPlace(_);return o.hit=!0,o.distance=g.Distance(_,y),o.pickedPoint=y,o.pickedMesh=this,o.bu=h.bu||0,o.bv=h.bv||0,o.subMeshFaceId=h.faceId,o.faceId=h.faceId+d.data[h.subMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),o.subMeshId=h.subMeshId,o}return o}clone(e,t,i){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array;return this}dispose(e,t=!1){let i;for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),i=0;i<this._intersectionsInProgress.length;i++){const a=this._intersectionsInProgress[i],o=a._intersectionsInProgress.indexOf(this);a._intersectionsInProgress.splice(o,1)}this._intersectionsInProgress.length=0,this.getScene().lights.forEach(a=>{let o=a.includedOnlyMeshes.indexOf(this);o!==-1&&a.includedOnlyMeshes.splice(o,1),o=a.excludedMeshes.indexOf(this),o!==-1&&a.excludedMeshes.splice(o,1);const l=a.getShadowGenerators();if(l){const c=l.values();for(let u=c.next();u.done!==!0;u=c.next()){const d=u.value.getShadowMap();d&&d.renderList&&(o=d.renderList.indexOf(this),o!==-1&&d.renderList.splice(o,1))}}}),(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes();const r=this.getScene().getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,r.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),r.wipeCaches(),this.getScene().removeMesh(this),this._parentContainer){const a=this._parentContainer.meshes.indexOf(this);a>-1&&this._parentContainer.meshes.splice(a,1),this._parentContainer=null}if(t&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(i=0;i<this.getScene().particleSystems.length;i++)this.getScene().particleSystems[i].emitter===this&&(this.getScene().particleSystems[i].dispose(),i--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,t)}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.setParent(null,t),this}_initFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=new Array),e.facetPositions||(e.facetPositions=new Array),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let t=0;t<e.facetNb;t++)e.facetNormals[t]=g.Zero(),e.facetPositions[t]=g.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();const t=this.getVerticesData(C.PositionKind),i=this.getIndices(),n=this.getVerticesData(C.NormalKind),r=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,i instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(i);else{let o=!1;for(let l=0;l<i.length;l++)if(i[l]>65535){o=!0;break}o?e.depthSortedIndices=new Uint32Array(i):e.depthSortedIndices=new Uint16Array(i)}if(e.facetDepthSortFunction=function(o,l){return l.sqDistance-o.sqDistance},!e.facetDepthSortFrom){const o=this.getScene().activeCamera;e.facetDepthSortFrom=o?o.position:g.Zero()}e.depthSortedFacets=[];for(let o=0;o<e.facetNb;o++){const l={ind:o*3,sqDistance:0};e.depthSortedFacets.push(l)}e.invertedMatrix=D.Identity(),e.facetDepthSortOrigin=g.Zero()}e.bbSize.x=r.maximum.x-r.minimum.x>lt?r.maximum.x-r.minimum.x:lt,e.bbSize.y=r.maximum.y-r.minimum.y>lt?r.maximum.y-r.minimum.y:lt,e.bbSize.z=r.maximum.z-r.minimum.z>lt?r.maximum.z-r.minimum.z:lt;let a=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(a=a>e.bbSize.z?a:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/a),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/a),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/a),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=r,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),g.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,n&&fe.ComputeNormals(t,i,n,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);const o=e.depthSortedIndices.length/3|0;for(let l=0;l<o;l++){const c=e.depthSortedFacets[l].ind;e.depthSortedIndices[l*3]=i[c],e.depthSortedIndices[l*3+1]=i[c+1],e.depthSortedIndices[l*3+2]=i[c+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){const t=g.Zero();return this.getFacetPositionToRef(e,t),t}getFacetPositionToRef(e,t){const i=this.getFacetLocalPositions()[e],n=this.getWorldMatrix();return g.TransformCoordinatesToRef(i,n,t),this}getFacetNormal(e){const t=g.Zero();return this.getFacetNormalToRef(e,t),t}getFacetNormalToRef(e,t){const i=this.getFacetLocalNormals()[e];return g.TransformNormalToRef(i,this.getWorldMatrix(),t),this}getFacetsAtLocalCoordinates(e,t,i){const n=this.getBoundingInfo(),r=this._internalAbstractMeshDataInfo._facetData,a=Math.floor((e-n.minimum.x*r.partitioningBBoxRatio)*r.subDiv.X*r.partitioningBBoxRatio/r.bbSize.x),o=Math.floor((t-n.minimum.y*r.partitioningBBoxRatio)*r.subDiv.Y*r.partitioningBBoxRatio/r.bbSize.y),l=Math.floor((i-n.minimum.z*r.partitioningBBoxRatio)*r.subDiv.Z*r.partitioningBBoxRatio/r.bbSize.z);return a<0||a>r.subDiv.max||o<0||o>r.subDiv.max||l<0||l>r.subDiv.max?null:r.facetPartitioning[a+r.subDiv.max*o+r.subDiv.max*r.subDiv.max*l]}getClosestFacetAtCoordinates(e,t,i,n,r=!1,a=!0){const o=this.getWorldMatrix(),l=w.Matrix[5];o.invertToRef(l);const c=w.Vector3[8];g.TransformCoordinatesFromFloatsToRef(e,t,i,l,c);const u=this.getClosestFacetAtLocalCoordinates(c.x,c.y,c.z,n,r,a);return n&&g.TransformCoordinatesFromFloatsToRef(n.x,n.y,n.z,o,n),u}getClosestFacetAtLocalCoordinates(e,t,i,n,r=!1,a=!0){let o=null,l=0,c=0,u=0,h=0,d=0,f=0,p=0,m=0;const _=this.getFacetLocalPositions(),E=this.getFacetLocalNormals(),v=this.getFacetsAtLocalCoordinates(e,t,i);if(!v)return null;let y=Number.MAX_VALUE,A=y,I,T,R;for(let x=0;x<v.length;x++)I=v[x],T=E[I],R=_[I],h=(e-R.x)*T.x+(t-R.y)*T.y+(i-R.z)*T.z,(!r||r&&a&&h>=0||r&&!a&&h<=0)&&(h=T.x*R.x+T.y*R.y+T.z*R.z,d=-(T.x*e+T.y*t+T.z*i-h)/(T.x*T.x+T.y*T.y+T.z*T.z),f=e+T.x*d,p=t+T.y*d,m=i+T.z*d,l=f-e,c=p-t,u=m-i,A=l*l+c*c+u*u,A<y&&(y=A,o=I,n&&(n.x=f,n.y=p,n.z=m)));return o}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=new Array,e.facetNormals=new Array,e.facetPartitioning=new Array,e.facetParameters=null,e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,t,i=!1){return this}createNormals(e){const t=this.getVerticesData(C.PositionKind),i=this.getIndices();let n;return this.isVerticesDataPresent(C.NormalKind)?n=this.getVerticesData(C.NormalKind):n=[],fe.ComputeNormals(t,i,n,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(C.NormalKind,n,e),this}alignWithNormal(e,t){t||(t=Aa.Y);const i=w.Vector3[0],n=w.Vector3[1];return g.CrossToRef(t,e,n),g.CrossToRef(e,n,i),this.rotationQuaternion?ee.RotationQuaternionFromAxisToRef(i,e,n,this.rotationQuaternion):g.RotationFromAxisToRef(i,e,n,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw De("EdgesRenderer")}enableEdgesRendering(e,t,i){throw De("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(e=>e.emitter===this)}}wn.OCCLUSION_TYPE_NONE=0;wn.OCCLUSION_TYPE_OPTIMISTIC=1;wn.OCCLUSION_TYPE_STRICT=2;wn.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0;wn.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1;wn.CULLINGSTRATEGY_STANDARD=0;wn.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;wn.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;wn.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;Rt("BABYLON.AbstractMesh",wn);class Io extends z{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().addMultiMaterial(this),this.subMaterials=new Array,this._storeEffectOnSubMeshes=!0}_hookArray(e){const t=e.push;e.push=(...n)=>{const r=t.apply(e,n);return this._markAllSubMeshesAsTexturesDirty(),r};const i=e.splice;e.splice=(n,r)=>{const a=i.apply(e,[n,r]);return this._markAllSubMeshesAsTexturesDirty(),a}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){var t;if(super.hasTexture(e))return!0;for(let i=0;i<this.subMaterials.length;i++)if(!((t=this.subMaterials[i])===null||t===void 0)&&t.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,i){for(let n=0;n<this.subMaterials.length;n++){const r=this.subMaterials[n];if(r){if(r._storeEffectOnSubMeshes){if(!r.isReadyForSubMesh(e,t,i))return!1;continue}if(!r.isReady(e))return!1}}return!0}clone(e,t){const i=new Io(e,this.getScene());for(let n=0;n<this.subMaterials.length;n++){let r=null;const a=this.subMaterials[n];t&&a?r=a.clone(e+"-"+a.name):r=this.subMaterials[n],i.subMaterials.push(r)}return i}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,Ye&&(e.tags=Ye.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){const i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,i){const n=this.getScene();if(!n)return;if(i)for(let a=0;a<this.subMaterials.length;a++){const o=this.subMaterials[a];o&&o.dispose(e,t)}const r=n.multiMaterials.indexOf(this);r>=0&&n.multiMaterials.splice(r,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){const i=new Io(e.name,t);return i.id=e.id,i._loadedUniqueId=e.uniqueId,Ye&&Ye.AddTagsTo(i,e.tags),e.materialsUniqueIds?i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach(n=>i.subMaterials.push(t.getLastMaterialById(n))),i}}Rt("BABYLON.MultiMaterial",Io);class ub{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}}class hb{constructor(){this.visibleInstances={},this.batchCache=new q_,this.batchCacheReplacementModeInFrozenMode=new q_,this.instancesBufferSize=32*16*4}}class q_{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array}}class db{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=32*16,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class fb{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}}class he extends wn{static _GetDefaultSideOrientation(e){return e||he.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(C.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(C.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new O),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new O),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new O),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new O),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new O),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){var e;return((e=this._thinInstanceDataStorage.instancesCount)!==null&&e!==void 0?e:0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}constructor(e,t=null,i=null,n=null,r,a=!0){if(super(e,t),this._internalMeshDataInfo=new fb,this.delayLoadState=0,this.instances=new Array,this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new hb,this._thinInstanceDataStorage=new db,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=he.DEFAULTSIDE,this.overrideMaterialSideOrientation=null,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._onBeforeDraw=(o,l,c)=>{o&&c&&(this._uniformBuffer?this.transferToEffect(l):c.bindOnlyWorldMatrix(l))},n){if(n._geometry&&n._geometry.applyToMesh(this),On.DeepCopy(n,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo","physicsBody","physicsImpostor"],["_poseMatrix"]),this._internalMeshDataInfo._source=n,t.useClonedMeshMap&&(n._internalMeshDataInfo.meshMap||(n._internalMeshDataInfo.meshMap={}),n._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=n._originalBuilderSideOrientation,this._creationDataStorage=n._creationDataStorage,n._ranges){const o=n._ranges;for(const l in o)Object.prototype.hasOwnProperty.call(o,l)&&o[l]&&this.createAnimationRange(l,o[l].from,o[l].to)}if(n.metadata&&n.metadata.clone?this.metadata=n.metadata.clone():this.metadata=n.metadata,this._internalMetadata=n._internalMetadata,Ye&&Ye.HasTags(n)&&Ye.AddTagsTo(this,Ye.GetTags(n,!0)),this.setEnabled(n.isEnabled(!1)),this.parent=n.parent,this.setPivotMatrix(n.getPivotMatrix()),this.id=e+"."+n.id,this.material=n.material,!r){const o=n.getDescendants(!0);for(let l=0;l<o.length;l++){const c=o[l];c.clone&&c.clone(e+"."+c.name,this)}}if(n.morphTargetManager&&(this.morphTargetManager=n.morphTargetManager),t.getPhysicsEngine){const o=t.getPhysicsEngine();if(a&&o)if(o.getPluginVersion()===1){const l=o.getImpostorForPhysicsObject(n);l&&(this.physicsImpostor=l.clone(this))}else o.getPluginVersion()===2&&n.physicsBody&&n.physicsBody.clone(this)}for(let o=0;o<t.particleSystems.length;o++){const l=t.particleSystems[o];l.emitter===n&&l.clone(l.name,this)}this.skeleton=n.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}i!==null&&(this.parent=i),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=o=>{o.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new O(this._internalMeshDataInfo._onMeshReadyObserverAdded),n&&n.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,i){const n=this.getTotalVertices()===0||t&&t.doNotInstantiate&&(t.doNotInstantiate===!0||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));n.parent=e||this.parent,n.position=this.position.clone(),n.scaling=this.scaling.clone(),this.rotationQuaternion?n.rotationQuaternion=this.rotationQuaternion.clone():n.rotation=this.rotation.clone(),i&&i(this,n);for(const r of this.getChildTransformNodes(!0))r.getClassName()==="InstancedMesh"&&n.getClassName()==="Mesh"&&r.sourceMesh===this?r.instantiateHierarchy(n,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:n},i):r.instantiateHierarchy(n,t,i);return n}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){const i=this.getIndices(),n=this.getVerticesData(C.PositionKind);n&&i&&(t+=", flat shading: "+(n.length/3===i.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0)}addLODLevel(e,t){if(t&&t._masterMesh)return U.Warn("You cannot use a mesh as LOD level twice"),this;const i=new ub(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){const n=t._LODLevels[i];if(n.distanceOrScreenCoverage===e)return n.mesh}return null}removeLODLevel(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){const i=this._internalMeshDataInfo;if(!i._LODLevels||i._LODLevels.length===0)return this;const n=t||this.getBoundingInfo().boundingSphere,r=e.mode===Ee.ORTHOGRAPHIC_CAMERA?e.minZ:n.centerWorld.subtract(e.globalPosition).length();let a=r,o=1;if(i._useLODScreenCoverage){const l=e.screenArea;let c=n.radiusWorld*e.minZ/r;c=c*c*Math.PI,a=c/l,o=-1}if(o*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>o*a)return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,this),this;for(let l=0;l<i._LODLevels.length;l++){const c=i._LODLevels[l];if(o*c.distanceOrScreenCoverage<o*a){if(c.mesh){if(c.mesh.delayLoadState===4)return c.mesh._checkDelayState(),this;if(c.mesh.delayLoadState===2)return this;c.mesh._preActivate(),c.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,c.mesh),c.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i,n){var r,a;if(!this._geometry)return null;let o=n||(a=(r=this._userInstancedBuffersStorage)===null||r===void 0?void 0:r.vertexBuffers[e])===null||a===void 0?void 0:a.getFloatData(this.instances.length+1,i||t&&this._geometry.meshes.length!==1);return o||(o=this._geometry.getVerticesData(e,t,i)),o}getVertexBuffer(e,t){var i,n;return this._geometry?(n=t||(i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[e])!==null&&n!==void 0?n:this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){var i;return this._geometry?!t&&((i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[e])!==void 0||this._geometry.isVerticesDataPresent(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}isVertexBufferUpdatable(e,t){var i;if(!this._geometry)return this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1;if(!t){const n=(i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[e];if(n)return n.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){const i=new Array;return this._delayInfo&&this._delayInfo.forEach(function(n){i.push(n)}),i}const t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(const i in this._userInstancedBuffersStorage.vertexBuffers)t.indexOf(i)===-1&&t.push(i);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return this._masterMesh!==null&&this._masterMesh!==void 0}isReady(e=!1,t=!1){var i,n,r,a,o,l,c;if(this.delayLoadState===2||!super.isReady(e))return!1;if(!this.subMeshes||this.subMeshes.length===0||!e)return!0;const u=this.getEngine(),h=this.getScene(),d=t||u.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const f=this.material||h.defaultMaterial;if(f){if(f._storeEffectOnSubMeshes)for(const m of this.subMeshes){const _=m.getMaterial();if(_){if(_._storeEffectOnSubMeshes){if(!_.isReadyForSubMesh(this,m,d))return!1}else if(!_.isReady(this,d))return!1}}else if(!f.isReady(this,d))return!1}const p=u.currentRenderPassId;for(const m of this.lightSources){const _=m.getShadowGenerators();if(!_)continue;const E=_.values();for(let v=E.next();v.done!==!0;v=E.next()){const y=v.value;if(y&&(!(!((i=y.getShadowMap())===null||i===void 0)&&i.renderList)||!((n=y.getShadowMap())===null||n===void 0)&&n.renderList&&((a=(r=y.getShadowMap())===null||r===void 0?void 0:r.renderList)===null||a===void 0?void 0:a.indexOf(this))!==-1)){const I=(o=y.getShadowMap().renderPassIds)!==null&&o!==void 0?o:[u.currentRenderPassId];for(let T=0;T<I.length;++T){u.currentRenderPassId=I[T];for(const R of this.subMeshes)if(!y.isReady(R,d,(c=(l=R.getMaterial())===null||l===void 0?void 0:l.needAlphaBlendingForMesh(this))!==null&&c!==void 0?c:!1))return u.currentRenderPassId=p,!1}u.currentRenderPassId=p}}}for(const m of this._internalMeshDataInfo._LODLevels)if(m.mesh&&!m.mesh.isReady(d))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){const e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t?this:(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null,this)}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(this._instanceDataStorage.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,t),i),this}_createGlobalSubMesh(e){const t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const i=this.getIndices();if(!i)return null;const n=i.length;let r=!1;if(e)r=!0;else for(const a of this.subMeshes){if(a.indexStart+a.indexCount>n){r=!0;break}if(a.verticesStart+a.verticesCount>t){r=!0;break}}if(!r)return this.subMeshes[0]}return this.releaseSubMeshes(),new Jn(0,0,t,0,this.getTotalIndices(),this)}subdivide(e){if(e<1)return;const t=this.getTotalIndices();let i=t/e|0,n=0;for(;i%3!==0;)i++;this.releaseSubMeshes();for(let r=0;r<e&&!(n>=t);r++)Jn.CreateFromIndices(0,n,r===e-1?t-n:i,this,void 0,!1),n+=i;this.refreshBoundingInfo(),this.synchronizeInstances()}setVerticesData(e,t,i=!1,n){if(this._geometry)this._geometry.setVerticesData(e,t,i,n);else{const r=new fe;r.set(t,e);const a=this.getScene();new Ki(Ki.RandomId(),a,r,i,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){const i=this.getVertexBuffer(e);!i||i.isUpdatable()===t||this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=Ki.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,n){return this._geometry?(n?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){const i=this.getVerticesData(C.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(C.PositionKind,i,!1,!1),t){const n=this.getIndices(),r=this.getVerticesData(C.NormalKind);if(!r)return this;fe.ComputeNormals(i,n,r),this.updateVerticesData(C.NormalKind,r,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;const e=this._geometry,t=this._geometry.copy(Ki.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndices(e,t=null,i=!1){if(this._geometry)this._geometry.setIndices(e,t,i);else{const n=new fe;n.indices=e;const r=this.getScene();new Ki(Ki.RandomId(),r,n,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i,n=!0){if(!this._geometry)return this;const r=this.getScene().getEngine();this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(t);let a;if(this._unIndexed)a=null;else switch(this._getRenderingFillMode(i)){case z.PointFillMode:a=null;break;case z.WireFrameFillMode:a=e._getLinesIndexBuffer(this.getIndices(),r);break;default:case z.TriangleFillMode:a=this._geometry.getIndexBuffer();break}return!n||!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,a):this._geometry._bind(t,a,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const r=this.getScene().getEngine();return this._unIndexed||t==z.PointFillMode?r.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==z.WireFrameFillMode?r.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):r.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}const i=this.getScene(),n=i._isInIntermediateRendering(),r=n?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,a=this._instanceDataStorage.batchCache;if(a.mustReturn=!1,a.renderSelf[e]=t||!r&&this.isEnabled()&&this.isVisible,a.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){const o=this._instanceDataStorage.visibleInstances,l=i.getRenderId(),c=n?o.intermediateDefaultRenderId:o.defaultRenderId;a.visibleInstances[e]=o[l],!a.visibleInstances[e]&&c&&(a.visibleInstances[e]=o[c])}return a.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&a.visibleInstances[e]!==null&&a.visibleInstances[e]!==void 0,this._instanceDataStorage.previousBatch=a,a}_renderWithInstances(e,t,i,n,r){var a;const o=i.visibleInstances[e._id],l=o?o.length:0,c=this._instanceDataStorage,u=c.instancesBufferSize;let h=c.instancesBuffer,d=c.instancesPreviousBuffer;const p=(l+1)*16*4;for(;c.instancesBufferSize<p;)c.instancesBufferSize*=2;(!c.instancesData||u!=c.instancesBufferSize)&&(c.instancesData=new Float32Array(c.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!c.instancesPreviousData||u!=c.instancesBufferSize)&&(c.instancesPreviousData=new Float32Array(c.instancesBufferSize/4));let m=0,_=0;const E=i.renderSelf[e._id],v=!h||u!==c.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!c.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!c.isFrozen||v)){const y=this.getWorldMatrix();if(E&&(this._scene.needsPreviousWorldMatrices&&(c.masterMeshPreviousWorldMatrix?(c.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,m),c.masterMeshPreviousWorldMatrix.copyFrom(y)):(c.masterMeshPreviousWorldMatrix=y.clone(),c.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,m))),y.copyToArray(c.instancesData,m),m+=16,_++),o){if(he.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&(!((a=e.getMaterial())===null||a===void 0)&&a.needAlphaBlendingForMesh(e.getRenderingMesh()))){const A=this._scene.activeCamera.globalPosition;for(let I=0;I<o.length;I++){const T=o[I];T._distanceToCamera=g.Distance(T.getBoundingInfo().boundingSphere.centerWorld,A)}o.sort((I,T)=>I._distanceToCamera>T._distanceToCamera?-1:I._distanceToCamera<T._distanceToCamera?1:0)}for(let A=0;A<o.length;A++){const I=o[A],T=I.getWorldMatrix();T.copyToArray(c.instancesData,m),this._scene.needsPreviousWorldMatrices&&(I._previousWorldMatrix?(I._previousWorldMatrix.copyToArray(c.instancesPreviousData,m),I._previousWorldMatrix.copyFrom(T)):(I._previousWorldMatrix=T.clone(),I._previousWorldMatrix.copyToArray(c.instancesPreviousData,m))),m+=16,_++}}}else _=(E?1:0)+l;return v?(h&&h.dispose(),d&&d.dispose(),h=new zr(r,c.instancesData,!0,16,!1,!0),c.instancesBuffer=h,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=h.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=h.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=h.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=h.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(d=new zr(r,c.instancesPreviousData,!0,16,!1,!0),c.instancesPreviousBuffer=d,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=d.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=d.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=d.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=d.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(h.updateDirectly(c.instancesData,0,_),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&d.updateDirectly(c.instancesPreviousData,0,_)),this._processInstancedBuffers(o,E),this.getScene()._activeIndices.addCount(e.indexCount*_,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,n,t),this._draw(e,t,_),this._scene.needsPreviousWorldMatrices&&!v&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&d.updateDirectly(c.instancesData,0,_),r.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,n){var r,a;const o=(a=(r=this._thinInstanceDataStorage)===null||r===void 0?void 0:r.instancesCount)!==null&&a!==void 0?a:0;this.getScene()._activeIndices.addCount(e.indexCount*o,!1),n._currentDrawContext&&(n._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,o),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,o):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),n.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,n,r,a,o,l){const c=this.getScene(),u=c.getEngine();if(n=this._getRenderingFillMode(n),a&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,n,i,u),this;if(a)this._renderWithInstances(t,n,r,i,u);else{u._currentDrawContext&&(u._currentDrawContext.useInstancing=!1);let h=0;r.renderSelf[t._id]&&(o&&o(!1,e.getWorldMatrix(),l),h++,this._draw(t,n,this._instanceDataStorage.overridenInstanceCount));const d=r.visibleInstances[t._id];if(d){const f=d.length;h+=f;for(let p=0;p<f;p++){const _=d[p].getWorldMatrix();o&&o(!0,_,l),this._draw(t,n)}}c._activeIndices.addCount(t.indexCount*h,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(const t in this._userInstancedBuffersStorage.vertexBuffers){const i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}render(e,t,i){var n,r,a;const o=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const l=this._getInstancesRenderList(e._id,!!i);if(l.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const c=o.getEngine();let u=0,h=null;this.ignoreCameraMaxZ&&o.activeCamera&&!o._isInIntermediateRendering()&&(u=o.activeCamera.maxZ,h=o.activeCamera,o.activeCamera.maxZ=0,o.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const d=e.getRenderingMesh(),f=l.hardwareInstancedRendering[e._id]||d.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,p=this._instanceDataStorage,m=e.getMaterial();if(!m)return h&&(h.maxZ=u,o.updateTransformMatrix(!0)),this;if(!p.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==m){if(m._storeEffectOnSubMeshes){if(!m.isReadyForSubMesh(this,e,f))return h&&(h.maxZ=u,o.updateTransformMatrix(!0)),this}else if(!m.isReady(this,f))return h&&(h.maxZ=u,o.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=m}else if(m._storeEffectOnSubMeshes&&!(!((n=e.effect)===null||n===void 0)&&n._wasPreviouslyReady)||!m._storeEffectOnSubMeshes&&!(!((r=m.getEffect())===null||r===void 0)&&r._wasPreviouslyReady))return h&&(h.maxZ=u,o.updateTransformMatrix(!0)),this;t&&c.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);let _;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?_=e._drawWrapper:_=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const E=(a=_==null?void 0:_.effect)!==null&&a!==void 0?a:null;for(const x of o._beforeRenderingMeshStage)x.action(this,e,l,E);if(!_||!E)return h&&(h.maxZ=u,o.updateTransformMatrix(!0)),this;const v=i||this;let y;if(!p.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this.overrideMaterialSideOrientation!==null)){const x=v._getWorldMatrixDeterminant();y=this.overrideMaterialSideOrientation,y==null&&(y=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),x<0&&(y=y===z.ClockWiseSideOrientation?z.CounterClockWiseSideOrientation:z.ClockWiseSideOrientation),p.sideOrientation=y}else y=p.sideOrientation;const A=this._internalMeshDataInfo._effectiveMaterial._preBind(_,y);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&c.setDepthWrite(!0);const I=this._internalMeshDataInfo._effectiveMaterial,T=I.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),f||this._bind(e,E,T,!1);const R=v.getWorldMatrix();I._storeEffectOnSubMeshes?I.bindForSubMesh(R,this,e):I.bind(R,this),!I.backFaceCulling&&I.separateCullingPass&&(c.setState(!0,I.zOffset,!1,!A,I.cullBackFaces,I.stencil,I.zOffsetUnits),this._processRendering(this,e,E,T,l,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),c.setState(!0,I.zOffset,!1,A,I.cullBackFaces,I.stencil,I.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,E,T,l,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const x of o._afterRenderingMeshStage)x.action(this,e,l,E);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),h&&(h.maxZ=u,o.updateTransformMatrix(!0)),o.performancePriority===hs.Aggressive&&!p.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(C.MatricesWeightsKind)&&(this.isVerticesDataPresent(C.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){const e=this.getVerticesData(C.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){const n=e[i]+e[i+1]+e[i+2]+e[i+3];if(n===0)e[i]=1;else{const r=1/n;e[i]*=r,e[i+1]*=r,e[i+2]*=r,e[i+3]*=r}}this.setVerticesData(C.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(C.MatricesWeightsExtraKind),t=this.getVerticesData(C.MatricesWeightsKind),i=t.length;for(let n=0;n<i;n+=4){let r=t[n]+t[n+1]+t[n+2]+t[n+3];if(r+=e[n]+e[n+1]+e[n+2]+e[n+3],r===0)t[n]=1;else{const a=1/r;t[n]*=a,t[n+1]*=a,t[n+2]*=a,t[n+3]*=a,e[n]*=a,e[n+1]*=a,e[n+2]*=a,e[n+3]*=a}}this.setVerticesData(C.MatricesWeightsKind,t),this.setVerticesData(C.MatricesWeightsKind,e)}validateSkinning(){const e=this.getVerticesData(C.MatricesWeightsExtraKind),t=this.getVerticesData(C.MatricesWeightsKind);if(t===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};const i=t.length;let n=0,r=0,a=0,o=0;const l=e===null?4:8,c=new Array;for(let _=0;_<=l;_++)c[_]=0;const u=.001;for(let _=0;_<i;_+=4){let E=t[_],v=E,y=v===0?0:1;for(let A=1;A<l;A++){const I=A<4?t[_+A]:e[_+A-4];I>E&&n++,I!==0&&y++,v+=I,E=I}if(c[y]++,y>a&&(a=y),v===0)r++;else{const A=1/v;let I=0;for(let T=0;T<l;T++)T<4?I+=Math.abs(t[_+T]-t[_+T]*A):I+=Math.abs(e[_+T-4]-e[_+T-4]*A);I>u&&o++}}const h=this.skeleton.bones.length,d=this.getVerticesData(C.MatricesIndicesKind),f=this.getVerticesData(C.MatricesIndicesExtraKind);let p=0;for(let _=0;_<i;_+=4)for(let E=0;E<l;E++){const v=E<4?d[_+E]:f[_+E-4];(v>=h||v<0)&&p++}const m="Number of Weights = "+i/4+`
Maximum influences = `+a+`
Missing Weights = `+r+`
Not Sorted = `+n+`
Not Normalized = `+o+`
WeightCounts = [`+c+`]
Number of bones = `+h+`
Bad Bone Indices = `+p;return{skinned:!0,valid:r===0&&o===0&&p===0,report:m}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const t=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return q.LoadFile(this.delayLoadingFile,i=>{i instanceof ArrayBuffer?this._delayLoadingFunction(i,this):this._delayLoadingFunction(JSON.parse(i),this),this.instances.forEach(n=>{n.refreshBoundingInfo(),n._syncSubMeshes()}),this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,t),this}isInFrustum(e){return this.delayLoadState===2||!super.isInFrustum(e)?!1:(this._checkDelayState(),!0)}setMaterialById(e){const t=this.getScene().materials;let i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;const n=this.getScene().multiMaterials;for(i=n.length-1;i>-1;i--)if(n[i].id===e)return this.material=n[i],this;return this}getAnimatables(){const e=new Array;return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(C.PositionKind))return this;const t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(C.PositionKind);const n=g.Zero();let r;for(r=0;r<i.length;r+=3)g.TransformCoordinatesFromFloatsToRef(i[r],i[r+1],i[r+2],e,n).toArray(i,r);if(this.setVerticesData(C.PositionKind,i,this.getVertexBuffer(C.PositionKind).isUpdatable()),this.isVerticesDataPresent(C.NormalKind)){for(i=this.getVerticesData(C.NormalKind),r=0;r<i.length;r+=3)g.TransformNormalFromFloatsToRef(i[r],i[r+1],i[r+2],e,n).normalize().toArray(i,r);this.setVerticesData(C.NormalKind,i,this.getVertexBuffer(C.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return this._geometry?this._geometry._generatePointsArray():!1}clone(e="",t=null,i,n=!0){return new he(e,this.getScene(),t,this,i,n)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);const i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(const n in i.meshMap){const r=i.meshMap[n];r&&(r._internalMeshDataInfo._source=null,i.meshMap[n]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{const n=this.getScene().meshes;for(const r of n){const a=r;a._internalMeshDataInfo&&a._internalMeshDataInfo._source&&a._internalMeshDataInfo._source===this&&(a._internalMeshDataInfo._source=null)}}i._source=null,this._instanceDataStorage.visibleInstances={},this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,n,r,a,o=!1){const l=this.getScene(),c=u=>{const h=u.width,d=u.height,p=this.getEngine().createCanvas(h,d).getContext("2d");p.drawImage(u,0,0);const m=p.getImageData(0,0,h,d).data;this.applyDisplacementMapFromBuffer(m,h,d,t,i,r,a,o),n&&n(this)};return q.LoadImage(e,c,()=>{},l.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,n,r,a,o,l=!1){if(!this.isVerticesDataPresent(C.PositionKind)||!this.isVerticesDataPresent(C.NormalKind)||!this.isVerticesDataPresent(C.UVKind))return U.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const c=this.getVerticesData(C.PositionKind,!0,!0),u=this.getVerticesData(C.NormalKind),h=this.getVerticesData(C.UVKind);let d=g.Zero();const f=g.Zero(),p=j.Zero();a=a||j.Zero(),o=o||new j(1,1);for(let m=0;m<c.length;m+=3){g.FromArrayToRef(c,m,d),g.FromArrayToRef(u,m,f),j.FromArrayToRef(h,m/3*2,p);const _=Math.abs(p.x*o.x+a.x%1)*(t-1)%t|0,E=Math.abs(p.y*o.y+a.y%1)*(i-1)%i|0,v=(_+E*t)*4,y=e[v]/255,A=e[v+1]/255,I=e[v+2]/255,T=y*.3+A*.59+I*.11;f.normalize(),f.scaleInPlace(n+(r-n)*T),d=d.add(f),d.toArray(c,m)}return fe.ComputeNormals(c,this.getIndices(),u),l?(this.setVerticesData(C.PositionKind,c),this.setVerticesData(C.NormalKind,u),this.setVerticesData(C.UVKind,h)):(this.updateVerticesData(C.PositionKind,c),this.updateVerticesData(C.NormalKind,u)),this}_getFlattenedNormals(e,t){const i=new Float32Array(e.length*3);let n=0;const r=this.overrideMaterialSideOrientation===(this._scene.useRightHandedSystem?1:0);for(let a=0;a<e.length;a+=3){const o=g.FromArray(t,e[a]*3),l=g.FromArray(t,e[a+1]*3),c=g.FromArray(t,e[a+2]*3),u=o.subtract(l),h=c.subtract(l),d=g.Normalize(g.Cross(u,h));r&&d.scaleInPlace(-1);for(let f=0;f<3;f++)i[n++]=d.x,i[n++]=d.y,i[n++]=d.z}return i}_convertToUnIndexedMesh(e=!1){const t=this.getVerticesDataKinds(),i=this.getIndices(),n={},r=(o,l)=>{const c=new Float32Array(i.length*l);let u=0;for(let h=0;h<i.length;h++)for(let d=0;d<l;d++)c[u++]=o[i[h]*l+d];return c},a=this.geometry?this.subMeshes.slice(0):[];for(const o of t)n[o]=this.getVerticesData(o);for(const o of t){const l=this.getVertexBuffer(o),c=l.getStrideSize();if(e&&o===C.NormalKind){const u=this._getFlattenedNormals(i,n[C.PositionKind]);this.setVerticesData(C.NormalKind,u,l.isUpdatable(),c)}else this.setVerticesData(o,r(n[o],c),l.isUpdatable(),c)}if(this.morphTargetManager){for(let o=0;o<this.morphTargetManager.numTargets;o++){const l=this.morphTargetManager.getTarget(o),c=l.getPositions();l.setPositions(r(c,3));const u=l.getNormals();u&&l.setNormals(e?this._getFlattenedNormals(i,c):r(u,3));const h=l.getTangents();h&&l.setTangents(r(h,3));const d=l.getUVs();d&&l.setUVs(r(d,2))}this.morphTargetManager.synchronize()}for(let o=0;o<i.length;o++)i[o]=o;this.setIndices(i),this._unIndexed=!0,this.releaseSubMeshes();for(const o of a)Jn.AddToMesh(o.materialIndex,o.indexStart,o.indexCount,o.indexStart,o.indexCount,this);return this.synchronizeInstances(),this}convertToFlatShadedMesh(){return this._convertToUnIndexedMesh(!0)}convertToUnIndexedMesh(){return this._convertToUnIndexedMesh()}flipFaces(e=!1){const t=fe.ExtractFromMesh(this);let i;if(e&&this.isVerticesDataPresent(C.NormalKind)&&t.normals)for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;if(t.indices){let n;for(i=0;i<t.indices.length;i+=3)n=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=n}return t.applyToMesh(this,this.isVertexBufferUpdatable(C.PositionKind)),this}increaseVertices(e=1){const t=fe.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,n=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,r=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,a=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(!i||!n)U.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{t.indices=i,t.positions=n,r&&(t.uvs=r),a&&(t.normals=a);const o=e+1,l=new Array;for(let I=0;I<o+1;I++)l[I]=new Array;let c,u;const h=new g(0,0,0),d=new g(0,0,0),f=new j(0,0),p=new Array,m=new Array,_=new Array;let E,v=n.length,y;r&&(y=r.length);let A;a&&(A=a.length);for(let I=0;I<i.length;I+=3){m[0]=i[I],m[1]=i[I+1],m[2]=i[I+2];for(let T=0;T<3;T++)if(c=m[T],u=m[(T+1)%3],_[c]===void 0&&_[u]===void 0?(_[c]=new Array,_[u]=new Array):(_[c]===void 0&&(_[c]=new Array),_[u]===void 0&&(_[u]=new Array)),_[c][u]===void 0&&_[u][c]===void 0){_[c][u]=[],h.x=(n[3*u]-n[3*c])/o,h.y=(n[3*u+1]-n[3*c+1])/o,h.z=(n[3*u+2]-n[3*c+2])/o,a&&(d.x=(a[3*u]-a[3*c])/o,d.y=(a[3*u+1]-a[3*c+1])/o,d.z=(a[3*u+2]-a[3*c+2])/o),r&&(f.x=(r[2*u]-r[2*c])/o,f.y=(r[2*u+1]-r[2*c+1])/o),_[c][u].push(c);for(let R=1;R<o;R++)_[c][u].push(n.length/3),n[v++]=n[3*c]+R*h.x,n[v++]=n[3*c+1]+R*h.y,n[v++]=n[3*c+2]+R*h.z,a&&(a[A++]=a[3*c]+R*d.x,a[A++]=a[3*c+1]+R*d.y,a[A++]=a[3*c+2]+R*d.z),r&&(r[y++]=r[2*c]+R*f.x,r[y++]=r[2*c+1]+R*f.y);_[c][u].push(u),_[u][c]=new Array,E=_[c][u].length;for(let R=0;R<E;R++)_[u][c][R]=_[c][u][E-1-R]}l[0][0]=i[I],l[1][0]=_[i[I]][i[I+1]][1],l[1][1]=_[i[I]][i[I+2]][1];for(let T=2;T<o;T++){l[T][0]=_[i[I]][i[I+1]][T],l[T][T]=_[i[I]][i[I+2]][T],h.x=(n[3*l[T][T]]-n[3*l[T][0]])/T,h.y=(n[3*l[T][T]+1]-n[3*l[T][0]+1])/T,h.z=(n[3*l[T][T]+2]-n[3*l[T][0]+2])/T,a&&(d.x=(a[3*l[T][T]]-a[3*l[T][0]])/T,d.y=(a[3*l[T][T]+1]-a[3*l[T][0]+1])/T,d.z=(a[3*l[T][T]+2]-a[3*l[T][0]+2])/T),r&&(f.x=(r[2*l[T][T]]-r[2*l[T][0]])/T,f.y=(r[2*l[T][T]+1]-r[2*l[T][0]+1])/T);for(let R=1;R<T;R++)l[T][R]=n.length/3,n[v++]=n[3*l[T][0]]+R*h.x,n[v++]=n[3*l[T][0]+1]+R*h.y,n[v++]=n[3*l[T][0]+2]+R*h.z,a&&(a[A++]=a[3*l[T][0]]+R*d.x,a[A++]=a[3*l[T][0]+1]+R*d.y,a[A++]=a[3*l[T][0]+2]+R*d.z),r&&(r[y++]=r[2*l[T][0]]+R*f.x,r[y++]=r[2*l[T][0]+1]+R*f.y)}l[o]=_[i[I+1]][i[I+2]],p.push(l[0][0],l[1][0],l[1][1]);for(let T=1;T<o;T++){let R;for(R=0;R<T;R++)p.push(l[T][R],l[T+1][R],l[T+1][R+1]),p.push(l[T][R],l[T+1][R+1],l[T][R+1]);p.push(l[T][R],l[T+1][R],l[T+1][R+1])}}t.indices=p,t.applyToMesh(this,this.isVertexBufferUpdatable(C.PositionKind))}}forceSharedVertices(){const e=fe.ExtractFromMesh(this),t=e.uvs,i=e.indices,n=e.positions,r=e.colors,a=e.matricesIndices,o=e.matricesWeights,l=e.matricesIndicesExtra,c=e.matricesWeightsExtra;if(i===void 0||n===void 0||i===null||n===null)U.Warn("VertexData contains empty entries");else{const u=new Array,h=new Array,d=new Array,f=new Array,p=new Array,m=new Array,_=new Array,E=new Array;let v=new Array,y=0;const A={};let I,T;for(let x=0;x<i.length;x+=3){T=[i[x],i[x+1],i[x+2]],v=new Array;for(let F=0;F<3;F++){v[F]="";for(let L=0;L<3;L++)Math.abs(n[3*T[F]+L])<1e-8&&(n[3*T[F]+L]=0),v[F]+=n[3*T[F]+L]+"|"}if(!(v[0]==v[1]||v[0]==v[2]||v[1]==v[2]))for(let F=0;F<3;F++){if(I=A[v[F]],I===void 0){A[v[F]]=y,I=y++;for(let L=0;L<3;L++)u.push(n[3*T[F]+L]);if(r!=null)for(let L=0;L<4;L++)f.push(r[4*T[F]+L]);if(t!=null)for(let L=0;L<2;L++)d.push(t[2*T[F]+L]);if(a!=null)for(let L=0;L<4;L++)p.push(a[4*T[F]+L]);if(o!=null)for(let L=0;L<4;L++)m.push(o[4*T[F]+L]);if(l!=null)for(let L=0;L<4;L++)_.push(l[4*T[F]+L]);if(c!=null)for(let L=0;L<4;L++)E.push(c[4*T[F]+L])}h.push(I)}}const R=new Array;fe.ComputeNormals(u,h,R),e.positions=u,e.indices=h,e.normals=R,t!=null&&(e.uvs=d),r!=null&&(e.colors=f),a!=null&&(e.matricesIndices=p),o!=null&&(e.matricesWeights=m),l!=null&&(e.matricesIndicesExtra=_),o!=null&&(e.matricesWeightsExtra=E),e.applyToMesh(this,this.isVertexBufferUpdatable(C.PositionKind))}}static _instancedMeshFactory(e,t){throw De("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw De("PhysicsImpostor")}createInstance(e){return he._instancedMeshFactory(e,this)}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){const t=this.getIndices(),i=this.getVerticesData(C.PositionKind);if(!i||!t)return this;const n=new Array;for(let a=0;a<i.length;a=a+3)n.push(g.FromArray(i,a));const r=new Array;return Tu.SyncAsyncForLoop(n.length,40,a=>{const o=n.length-1-a,l=n[o];for(let c=0;c<o;++c){const u=n[c];if(l.equals(u)){r[o]=c;break}}},()=>{for(let o=0;o<t.length;++o)t[o]=r[t[o]]||t[o];const a=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=a,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),Ye&&Ye.HasTags(this)&&(e.tags=Ye.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let i=0;i<this.subMeshes.length;i++){const n=this.subMeshes[i];e.subMeshes.push({materialIndex:n.materialIndex,verticesStart:n.verticesStart,verticesCount:n.verticesCount,indexStart:n.indexStart,indexCount:n.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(ye.NAME_PHYSICSENGINE)){const i=this.getPhysicsImpostor();i&&(e.physicsMass=i.getParam("mass"),e.physicsFriction=i.getParam("friction"),e.physicsRestitution=i.getParam("mass"),e.physicsImpostor=i.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let i=0;i<this.instances.length;i++){const n=this.instances[i];if(n.doNotSerialize)continue;const r={name:n.name,id:n.id,isEnabled:n.isEnabled(!1),isVisible:n.isVisible,isPickable:n.isPickable,checkCollisions:n.checkCollisions,position:n.position.asArray(),scaling:n.scaling.asArray()};if(n.parent&&n.parent._serializeAsParent(r),n.rotationQuaternion?r.rotationQuaternion=n.rotationQuaternion.asArray():n.rotation&&(r.rotation=n.rotation.asArray()),this.getScene()._getComponent(ye.NAME_PHYSICSENGINE)){const a=n.getPhysicsImpostor();a&&(r.physicsMass=a.getParam("mass"),r.physicsFriction=a.getParam("friction"),r.physicsRestitution=a.getParam("mass"),r.physicsImpostor=a.type)}n.metadata&&(r.metadata=n.metadata),n.actionManager&&(r.actions=n.actionManager.serialize(n.name)),e.instances.push(r),Pe.AppendSerializedAnimations(n,r),r.ranges=n.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const i={data:{},sizes:{},strides:{}};for(const n in this._userThinInstanceBuffersStorage.data)i.data[n]=Array.from(this._userThinInstanceBuffersStorage.data[n]),i.sizes[n]=this._userThinInstanceBuffersStorage.sizes[n],i.strides[n]=this._userThinInstanceBuffersStorage.strides[n];e.thinInstances.userThinInstance=i}return Pe.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices()){U.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){const i=e.getActiveTarget(t),n=i.getPositions();if(!n){U.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(C.PositionKind+t,n,!1,3);const r=i.getNormals();r&&this.geometry.setVerticesData(C.NormalKind+t,r,!1,3);const a=i.getTangents();a&&this.geometry.setVerticesData(C.TangentKind+t,a,!1,3);const o=i.getUVs();o&&this.geometry.setVerticesData(C.UVKind+"_"+t,o,!1,2)}}else{let t=0;for(;this.geometry.isVerticesDataPresent(C.PositionKind+t);)this.geometry.removeVerticesData(C.PositionKind+t),this.geometry.isVerticesDataPresent(C.NormalKind+t)&&this.geometry.removeVerticesData(C.NormalKind+t),this.geometry.isVerticesDataPresent(C.TangentKind+t)&&this.geometry.removeVerticesData(C.TangentKind+t),this.geometry.isVerticesDataPresent(C.UVKind+t)&&this.geometry.removeVerticesData(C.UVKind+"_"+t),t++}}static Parse(e,t,i){let n;if(e.type&&e.type==="LinesMesh"?n=he._LinesMeshParser(e,t):e.type&&e.type==="GroundMesh"?n=he._GroundMeshParser(e,t):e.type&&e.type==="GoldbergMesh"?n=he._GoldbergMeshParser(e,t):e.type&&e.type==="GreasedLineMesh"?n=he._GreasedLineMeshParser(e,t):e.type&&e.type==="TrailMesh"?n=he._TrailMeshParser(e,t):n=new he(e.name,t),n.id=e.id,n._waitingParsedUniqueId=e.uniqueId,Ye&&Ye.AddTagsTo(n,e.tags),n.position=g.FromArray(e.position),e.metadata!==void 0&&(n.metadata=e.metadata),e.rotationQuaternion?n.rotationQuaternion=ee.FromArray(e.rotationQuaternion):e.rotation&&(n.rotation=g.FromArray(e.rotation)),n.scaling=g.FromArray(e.scaling),e.localMatrix?n.setPreTransformMatrix(D.FromArray(e.localMatrix)):e.pivotMatrix&&n.setPivotMatrix(D.FromArray(e.pivotMatrix)),n.setEnabled(e.isEnabled),n.isVisible=e.isVisible,n.infiniteDistance=e.infiniteDistance,n.showBoundingBox=e.showBoundingBox,n.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,e.applyFog!==void 0&&(n.applyFog=e.applyFog),e.pickable!==void 0&&(n.isPickable=e.pickable),e.alphaIndex!==void 0&&(n.alphaIndex=e.alphaIndex),n.receiveShadows=e.receiveShadows,e.billboardMode!==void 0&&(n.billboardMode=e.billboardMode),e.visibility!==void 0&&(n.visibility=e.visibility),n.checkCollisions=e.checkCollisions,n.overrideMaterialSideOrientation=e.overrideMaterialSideOrientation,e.isBlocker!==void 0&&(n.isBlocker=e.isBlocker),n._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(n._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),e.parentId!==void 0&&(n._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(n._waitingParentInstanceIndex=e.parentInstanceIndex),e.actions!==void 0&&(n._waitingData.actions=e.actions),e.overlayAlpha!==void 0&&(n.overlayAlpha=e.overlayAlpha),e.overlayColor!==void 0&&(n.overlayColor=G.FromArray(e.overlayColor)),e.renderOverlay!==void 0&&(n.renderOverlay=e.renderOverlay),n.isUnIndexed=!!e.isUnIndexed,n.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(n.delayLoadState=4,n.delayLoadingFile=i+e.delayLoadingFile,n.buildBoundingInfo(g.FromArray(e.boundingBoxMinimum),g.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(n._binaryInfo=e._binaryInfo),n._delayInfo=[],e.hasUVs&&n._delayInfo.push(C.UVKind),e.hasUVs2&&n._delayInfo.push(C.UV2Kind),e.hasUVs3&&n._delayInfo.push(C.UV3Kind),e.hasUVs4&&n._delayInfo.push(C.UV4Kind),e.hasUVs5&&n._delayInfo.push(C.UV5Kind),e.hasUVs6&&n._delayInfo.push(C.UV6Kind),e.hasColors&&n._delayInfo.push(C.ColorKind),e.hasMatricesIndices&&n._delayInfo.push(C.MatricesIndicesKind),e.hasMatricesWeights&&n._delayInfo.push(C.MatricesWeightsKind),n._delayLoadingFunction=Ki._ImportGeometry,ri.ForceFullSceneLoadingForIncremental&&n._checkDelayState()):Ki._ImportGeometry(e,n),e.materialUniqueId?n._waitingMaterialId=e.materialUniqueId:e.materialId&&(n._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(n.morphTargetManager=t.getMorphTargetManagerById(e.morphTargetManagerId)),e.skeletonId!==void 0&&e.skeletonId!==null&&(n.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(n.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let r=0;r<e.animations.length;r++){const a=e.animations[r],o=hn("BABYLON.Animation");o&&n.animations.push(o.Parse(a))}oi.ParseAnimationRanges(n,e,t)}if(e.autoAnimate&&t.beginAnimation(n,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?n.layerMask=Math.abs(parseInt(e.layerMask)):n.layerMask=268435455,e.physicsImpostor&&he._PhysicsImpostorParser(t,n,e),e.lodMeshIds&&(n._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let r=0;r<e.instances.length;r++){const a=e.instances[r],o=n.createInstance(a.name);if(a.id&&(o.id=a.id),Ye&&(a.tags?Ye.AddTagsTo(o,a.tags):Ye.AddTagsTo(o,e.tags)),o.position=g.FromArray(a.position),a.metadata!==void 0&&(o.metadata=a.metadata),a.parentId!==void 0&&(o._waitingParentId=a.parentId),a.parentInstanceIndex!==void 0&&(o._waitingParentInstanceIndex=a.parentInstanceIndex),a.isEnabled!==void 0&&a.isEnabled!==null&&o.setEnabled(a.isEnabled),a.isVisible!==void 0&&a.isVisible!==null&&(o.isVisible=a.isVisible),a.isPickable!==void 0&&a.isPickable!==null&&(o.isPickable=a.isPickable),a.rotationQuaternion?o.rotationQuaternion=ee.FromArray(a.rotationQuaternion):a.rotation&&(o.rotation=g.FromArray(a.rotation)),o.scaling=g.FromArray(a.scaling),a.checkCollisions!=null&&a.checkCollisions!=null&&(o.checkCollisions=a.checkCollisions),a.pickable!=null&&a.pickable!=null&&(o.isPickable=a.pickable),a.showBoundingBox!=null&&a.showBoundingBox!=null&&(o.showBoundingBox=a.showBoundingBox),a.showSubMeshesBoundingBox!=null&&a.showSubMeshesBoundingBox!=null&&(o.showSubMeshesBoundingBox=a.showSubMeshesBoundingBox),a.alphaIndex!=null&&a.showSubMeshesBoundingBox!=null&&(o.alphaIndex=a.alphaIndex),a.physicsImpostor&&he._PhysicsImpostorParser(t,o,a),a.actions!==void 0&&(o._waitingData.actions=a.actions),a.animations){for(let l=0;l<a.animations.length;l++){const c=a.animations[l],u=hn("BABYLON.Animation");u&&o.animations.push(u.Parse(c))}oi.ParseAnimationRanges(o,a,t),a.autoAnimate&&t.beginAnimation(o,a.autoAnimateFrom,a.autoAnimateTo,a.autoAnimateLoop,a.autoAnimateSpeed||1)}}if(e.thinInstances){const r=e.thinInstances;if(n.thinInstanceEnablePicking=!!r.enablePicking,r.matrixData?(n.thinInstanceSetBuffer("matrix",new Float32Array(r.matrixData),16,!1),n._thinInstanceDataStorage.matrixBufferSize=r.matrixBufferSize,n._thinInstanceDataStorage.instancesCount=r.instancesCount):n._thinInstanceDataStorage.matrixBufferSize=r.matrixBufferSize,e.thinInstances.userThinInstance){const a=e.thinInstances.userThinInstance;for(const o in a.data)n.thinInstanceSetBuffer(o,new Float32Array(a.data[o]),a.strides[o],!1),n._userThinInstanceBuffersStorage.sizes[o]=a.sizes[o]}}return n}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const t=this.getVerticesData(C.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(C.PositionKind)||this.setVerticesData(C.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const t=this.getVerticesData(C.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(C.NormalKind)||this.setVerticesData(C.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(C.PositionKind))return this;if(!this.isVerticesDataPresent(C.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(C.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(C.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const E=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=E}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let n=this.getVerticesData(C.PositionKind);if(!n)return this;n instanceof Float32Array||(n=new Float32Array(n));let r=this.getVerticesData(C.NormalKind);if(t){if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r))}const a=this.getVerticesData(C.MatricesIndicesKind),o=this.getVerticesData(C.MatricesWeightsKind);if(!o||!a)return this;const l=this.numBoneInfluencers>4,c=l?this.getVerticesData(C.MatricesIndicesExtraKind):null,u=l?this.getVerticesData(C.MatricesWeightsExtraKind):null,h=e.getTransformMatrices(this),d=g.Zero(),f=new D,p=new D;let m=0,_;for(let E=0;E<n.length;E+=3,m+=4){let v;for(_=0;_<4;_++)v=o[m+_],v>0&&(D.FromFloat32ArrayToRefScaled(h,Math.floor(a[m+_]*16),v,p),f.addToSelf(p));if(l)for(_=0;_<4;_++)v=u[m+_],v>0&&(D.FromFloat32ArrayToRefScaled(h,Math.floor(c[m+_]*16),v,p),f.addToSelf(p));g.TransformCoordinatesFromFloatsToRef(i._sourcePositions[E],i._sourcePositions[E+1],i._sourcePositions[E+2],f,d),d.toArray(n,E),t&&(g.TransformNormalFromFloatsToRef(i._sourceNormals[E],i._sourceNormals[E+1],i._sourceNormals[E+2],f,d),d.toArray(r,E)),f.reset()}return this.updateVerticesData(C.PositionKind,n),t&&this.updateVerticesData(C.NormalKind,r),this}static MinMax(e){let t=null,i=null;return e.forEach(function(n){const a=n.getBoundingInfo().boundingBox;!t||!i?(t=a.minimumWorld,i=a.maximumWorld):(t.minimizeInPlace(a.minimumWorld),i.maximizeInPlace(a.maximumWorld))}),!t||!i?{min:g.Zero(),max:g.Zero()}:{min:t,max:i}}static Center(e){const t=e instanceof Array?he.MinMax(e):e;return g.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,n,r,a){return im(he._MergeMeshesCoroutine(e,t,i,n,r,a,!1))}static MergeMeshesAsync(e,t=!0,i,n,r,a){return NE(he._MergeMeshesCoroutine(e,t,i,n,r,a,!0),rb())}static*_MergeMeshesCoroutine(e,t=!0,i,n,r,a,o){if(e=e.filter(Boolean),e.length===0)return null;let l;if(!i){let R=0;for(l=0;l<e.length;l++)if(R+=e[l].getTotalVertices(),R>=65536)return U.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}a&&(r=!1);const c=new Array,u=new Array,h=new Array,d=e[0].overrideMaterialSideOrientation;for(l=0;l<e.length;l++){const R=e[l];if(R.isAnInstance)return U.Warn("Cannot merge instance meshes."),null;if(d!==R.overrideMaterialSideOrientation)return U.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),null;if(r&&h.push(R.getTotalIndices()),a)if(R.material){const x=R.material;if(x instanceof Io){for(let F=0;F<x.subMaterials.length;F++)c.indexOf(x.subMaterials[F])<0&&c.push(x.subMaterials[F]);for(let F=0;F<R.subMeshes.length;F++)u.push(c.indexOf(x.subMaterials[R.subMeshes[F].materialIndex])),h.push(R.subMeshes[F].indexCount)}else{c.indexOf(x)<0&&c.push(x);for(let F=0;F<R.subMeshes.length;F++)u.push(c.indexOf(x)),h.push(R.subMeshes[F].indexCount)}}else for(let x=0;x<R.subMeshes.length;x++)u.push(0),h.push(R.subMeshes[x].indexCount)}const f=e[0],p=R=>{const x=R.computeWorldMatrix(!0);return{vertexData:fe.ExtractFromMesh(R,!1,!1),transform:x}},{vertexData:m,transform:_}=p(f);o&&(yield);const E=new Array(e.length-1);for(let R=1;R<e.length;R++)E[R-1]=p(e[R]),o&&(yield);const v=m._mergeCoroutine(_,E,i,o,!t);let y=v.next();for(;!y.done;)o&&(yield),y=v.next();const A=y.value;n||(n=new he(f.name+"_merged",f.getScene()));const I=A._applyToCoroutine(n,void 0,o);let T=I.next();for(;!T.done;)o&&(yield),T=I.next();if(n.checkCollisions=f.checkCollisions,n.overrideMaterialSideOrientation=f.overrideMaterialSideOrientation,t)for(l=0;l<e.length;l++)e[l].dispose();if(r||a){n.releaseSubMeshes(),l=0;let R=0;for(;l<h.length;)Jn.CreateFromIndices(0,R,h[l],n,void 0,!1),R+=h[l],l++;for(const x of n.subMeshes)x.refreshBoundingInfo();n.computeWorldMatrix(!0)}if(a){const R=new Io(f.name+"_merged",f.getScene());R.subMaterials=c;for(let x=0;x<n.subMeshes.length;x++)n.subMeshes[x].materialIndex=u[x];n.material=R}else n.material=f.material;return n}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){const t=e._indexInSourceMeshInstanceArray;if(t!=-1){if(t!==this.instances.length-1){const i=this.instances[this.instances.length-1];this.instances[t]=i,i._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this.overrideMaterialSideOrientation===z.CounterClockWiseSideOrientation}_getRenderingFillMode(e){var t;const i=this.getScene();return i.forcePointsCloud?z.PointFillMode:i.forceWireframe?z.WireFrameFillMode:(t=this.overrideRenderingFillMode)!==null&&t!==void 0?t:e}setMaterialByID(e){return this.setMaterialById(e)}static CreateRibbon(e,t,i,n,r,a,o,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateDisc(e,t,i,n,r,a){throw new Error("Import MeshBuilder to populate this function")}static CreateBox(e,t,i,n,r){throw new Error("Import MeshBuilder to populate this function")}static CreateSphere(e,t,i,n,r,a){throw new Error("Import MeshBuilder to populate this function")}static CreateHemisphere(e,t,i,n){throw new Error("Import MeshBuilder to populate this function")}static CreateCylinder(e,t,i,n,r,a,o,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateTorus(e,t,i,n,r,a,o){throw new Error("Import MeshBuilder to populate this function")}static CreateTorusKnot(e,t,i,n,r,a,o,l,c,u){throw new Error("Import MeshBuilder to populate this function")}static CreateLines(e,t,i,n,r){throw new Error("Import MeshBuilder to populate this function")}static CreateDashedLines(e,t,i,n,r,a,o,l){throw new Error("Import MeshBuilder to populate this function")}static CreatePolygon(e,t,i,n,r,a,o){throw new Error("Import MeshBuilder to populate this function")}static ExtrudePolygon(e,t,i,n,r,a,o,l){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShape(e,t,i,n,r,a,o,l,c,u){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShapeCustom(e,t,i,n,r,a,o,l,c,u,h,d){throw new Error("Import MeshBuilder to populate this function")}static CreateLathe(e,t,i,n,r,a,o){throw new Error("Import MeshBuilder to populate this function")}static CreatePlane(e,t,i,n,r){throw new Error("Import MeshBuilder to populate this function")}static CreateGround(e,t,i,n,r,a){throw new Error("Import MeshBuilder to populate this function")}static CreateTiledGround(e,t,i,n,r,a,o,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateGroundFromHeightMap(e,t,i,n,r,a,o,l,c,u,h){throw new Error("Import MeshBuilder to populate this function")}static CreateTube(e,t,i,n,r,a,o,l,c,u){throw new Error("Import MeshBuilder to populate this function")}static CreatePolyhedron(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateIcoSphere(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateDecal(e,t,i,n,r,a){throw new Error("Import MeshBuilder to populate this function")}static CreateCapsule(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static ExtendToGoldberg(e){throw new Error("Import MeshBuilder to populate this function")}}he.FRONTSIDE=fe.FRONTSIDE;he.BACKSIDE=fe.BACKSIDE;he.DOUBLESIDE=fe.DOUBLESIDE;he.DEFAULTSIDE=fe.DEFAULTSIDE;he.NO_CAP=0;he.CAP_START=1;he.CAP_END=2;he.CAP_ALL=3;he.NO_FLIP=0;he.FLIP_TILE=1;he.ROTATE_TILE=2;he.FLIP_ROW=3;he.ROTATE_ROW=4;he.FLIP_N_ROTATE_TILE=5;he.FLIP_N_ROTATE_ROW=6;he.CENTER=0;he.LEFT=1;he.RIGHT=2;he.TOP=3;he.BOTTOM=4;he.INSTANCEDMESH_SORT_TRANSPARENT=!1;he._GroundMeshParser=(s,e)=>{throw De("GroundMesh")};he._GoldbergMeshParser=(s,e)=>{throw De("GoldbergMesh")};he._LinesMeshParser=(s,e)=>{throw De("LinesMesh")};he._GreasedLineMeshParser=(s,e)=>{throw De("GreasedLineMesh")};he._TrailMeshParser=(s,e)=>{throw De("TrailMesh")};Rt("BABYLON.Mesh",he);class ua{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(t===0||e===0)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,i=null){this.name=e,this.animations=new Array,this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new O,this._onDataLayoutChanged=new O,this._animationPropertiesOverride=null,this._scene=i||Fe.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}clone(){const e=Pe.Clone(()=>new ua(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),Pe.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const i=new ua(e.name,e.influence);if(i.setPositions(e.positions),e.id!=null&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.animations){for(let n=0;n<e.animations.length;n++){const r=e.animations[n],a=hn("BABYLON.Animation");a&&i.animations.push(a.Parse(r))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);const n=new ua(t,i,e.getScene());return n.setPositions(e.getVerticesData(C.PositionKind)),e.isVerticesDataPresent(C.NormalKind)&&n.setNormals(e.getVerticesData(C.NormalKind)),e.isVerticesDataPresent(C.TangentKind)&&n.setTangents(e.getVerticesData(C.TangentKind)),e.isVerticesDataPresent(C.UVKind)&&n.setUVs(e.getVerticesData(C.UVKind)),n}}S([b()],ua.prototype,"id",void 0);class nm extends H{get depth(){return this._depth}constructor(e,t,i,n,r,a,o=!0,l=!1,c=H.TRILINEAR_SAMPLINGMODE,u=0,h){super(null,a,!o,l),this.format=r,this._texture=a.getEngine().createRawTexture2DArray(e,t,i,n,r,o,l,c,null,u,h),this._depth=n,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,n,r,a=!0,o=!1,l=3,c=0){return new nm(e,t,i,n,5,r,a,o,l,c)}}class Ir{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new Mi(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._useTextureToStoreTargets=!0,e||(e=Fe.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const t=this._scene.getEngine().getCaps();this._canUseTextureForTargets=t.canUseGLVertexID&&t.textureFloat&&t.maxVertexTextureImageUnits>0&&t.texture2DArrayMaxLayerCount>1}}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets=e}get isUsingTextureForTargets(){var e;return Ir.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!(!((e=this._scene)===null||e===void 0)&&e.getEngine().getCaps().disableMorphTargetTexture)}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add(t=>{this._syncActiveTargets(t)})),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add(()=>{this._syncActiveTargets(!0)})),this._syncActiveTargets(!0)}removeTarget(e){const t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._syncActiveTargets(!0)),this._scene&&this._scene.stopAnimation(e)}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture)}clone(){const e=new Ir(this._scene);for(const t of this._targets)e.addTarget(t.clone());return e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const t of this._targets)e.targets.push(t.serialize());return e}_syncActiveTargets(e){if(this.areUpdatesFrozen)return;let t=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,this._scene&&this._targets.length>this._scene.getEngine().getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1),(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let i=-1;for(const n of this._targets){if(i++,n.influence===0&&this.optimizeInfluencers)continue;if(this._activeTargets.length>=Ir.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(n),this._morphTargetTextureIndices[t]=i,this._tempInfluences[t++]=n.influence,this._supportsNormals=this._supportsNormals&&n.hasNormals,this._supportsTangents=this._supportsTangents&&n.hasTangents,this._supportsUVs=this._supportsUVs&&n.hasUVs;const r=n.getPositions();if(r){const a=r.length/3;if(this._vertexCount===0)this._vertexCount=a;else if(this._vertexCount!==a){U.Error("Incompatible target. Targets must all have the same vertices count.");return}}}this._morphTargetTextureIndices.length!==t&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,t)),(!this._influences||this._influences.length!==t)&&(this._influences=new Float32Array(t));for(let n=0;n<t;n++)this._influences[n]=this._tempInfluences[n];e&&this.synchronize()}synchronize(){if(!(!this._scene||this.areUpdatesFrozen)){if(this.isUsingTextureForTargets&&this._vertexCount){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride,this._textureHeight=1;const e=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>e&&(this._textureHeight=Math.ceil(this._textureWidth/e),this._textureWidth=e);let t=!0;if(this._targetStoreTexture){const i=this._targetStoreTexture.getSize();i.width===this._textureWidth&&i.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(t=!1)}if(t){this._targetStoreTexture&&this._targetStoreTexture.dispose();const i=this._targets.length,n=new Float32Array(i*this._textureWidth*this._textureHeight*4);let r=0;for(let a=0;a<i;a++){const o=this._targets[a],l=o.getPositions(),c=o.getNormals(),u=o.getUVs(),h=o.getTangents();if(!l){a===0&&U.Error("Invalid morph target. Target must have positions.");return}r=a*this._textureWidth*this._textureHeight*4;for(let d=0;d<this._vertexCount;d++)n[r]=l[d*3],n[r+1]=l[d*3+1],n[r+2]=l[d*3+2],r+=4,this._supportsNormals&&c&&(n[r]=c[d*3],n[r+1]=c[d*3+1],n[r+2]=c[d*3+2],r+=4),this._supportsUVs&&u&&(n[r]=u[d*2],n[r+1]=u[d*2+1],r+=4),this._supportsTangents&&h&&(n[r]=h[d*3],n[r+1]=h[d*3+1],n[r+2]=h[d*3+2],r+=4)}this._targetStoreTexture=nm.CreateRGBATexture(n,this._textureWidth,this._textureHeight,i,this._scene,!1,!1,1,1)}}for(const e of this._scene.meshes)e.morphTargetManager===this&&e._syncGeometryWithMorphTargetManager()}}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}for(const e of this._targets)this._scene.stopAnimation(e)}}static Parse(e,t){const i=new Ir(t);i._uniqueId=e.id;for(const n of e.targets)i.addTarget(ua.Parse(n,t));return i}}Ir.EnableTextureStorage=!0;Ir.MaxActiveMorphTargetsInVertexAttributeMode=8;var Er;(function(s){s[s.Clean=0]="Clean",s[s.Stop=1]="Stop",s[s.Sync=2]="Sync",s[s.NoSync=3]="NoSync"})(Er||(Er={}));class Ze{static get ForceFullSceneLoadingForIncremental(){return ri.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){ri.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return ri.ShowLoadingScreen}static set ShowLoadingScreen(e){ri.ShowLoadingScreen=e}static get loggingLevel(){return ri.loggingLevel}static set loggingLevel(e){ri.loggingLevel=e}static get CleanBoneMatrixWeights(){return ri.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){ri.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return Ze._RegisteredPlugins[".babylon"]}static _GetPluginForExtension(e){const t=Ze._RegisteredPlugins[e];return t||(U.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),Ze.GetDefaultPlugin())}static _GetPluginForDirectLoad(e){for(const t in Ze._RegisteredPlugins){const i=Ze._RegisteredPlugins[t].plugin;if(i.canDirectLoad&&i.canDirectLoad(e))return Ze._RegisteredPlugins[t]}return Ze.GetDefaultPlugin()}static _GetPluginForFilename(e){const t=e.indexOf("?");t!==-1&&(e=e.substring(0,t));const i=e.lastIndexOf("."),n=e.substring(i,e.length).toLowerCase();return Ze._GetPluginForExtension(n)}static _GetDirectLoad(e){return e.substr(0,5)==="data:"?e.substr(5):null}static _FormatErrorMessage(e,t,i){let r="Unable to load from "+(e.rawData?"binary data":e.url);return t?r+=`: ${t}`:i&&(r+=`: ${i}`),r}static _LoadData(e,t,i,n,r,a,o,l){const c=Ze._GetDirectLoad(e.url);if(e.rawData&&!o)throw"When using ArrayBufferView to load data the file extension must be provided.";const u=o?Ze._GetPluginForExtension(o):c?Ze._GetPluginForDirectLoad(e.url):Ze._GetPluginForFilename(e.url);if(e.rawData&&!u.isBinary)throw"Loading from ArrayBufferView can not be used with plugins that don't support binary loading.";let h;if(u.plugin.createPlugin!==void 0?h=u.plugin.createPlugin():h=u.plugin,!h)throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(Ze.OnPluginActivatedObservable.notifyObservers(h),c&&(h.canDirectLoad&&h.canDirectLoad(e.url)||!ju(e.url))){if(h.directLoad){const A=h.directLoad(t,c);A.then?A.then(I=>{i(h,I)}).catch(I=>{r("Error in directLoad of _loadData: "+I,I)}):i(h,A)}else i(h,c);return h}const d=u.isBinary,f=(A,I)=>{if(t.isDisposed){r("Scene has been disposed");return}i(h,A,I)};let p=null,m=!1;const _=h.onDisposeObservable;_&&_.add(()=>{m=!0,p&&(p.abort(),p=null),a()});const E=()=>{if(m)return;const A=(I,T)=>{r(I==null?void 0:I.statusText,T)};if(!h.loadFile&&e.rawData)throw"Plugin does not support loading ArrayBufferView.";p=h.loadFile?h.loadFile(t,e.rawData||e.file||e.url,e.rootUrl,f,n,d,A,l):t._loadFile(e.file||e.url,f,n,!0,d,A)},v=t.getEngine();let y=v.enableOfflineSupport;if(y){let A=!1;for(const I of t.disableOfflineSupportExceptionRules)if(I.test(e.url)){A=!0;break}y=!A}return y&&k.OfflineProviderFactory?t.offlineProvider=k.OfflineProviderFactory(e.url,E,v.disableManifestCheck):E(),h}static _GetFileInfo(e,t){let i,n,r=null,a=null;if(!t)i=e,n=q.GetFilename(e),e=q.GetFolderPath(e);else if(t.name){const o=t;i=`file:${o.name}`,n=o.name,r=o}else if(ArrayBuffer.isView(t))i="",n="arrayBuffer",a=t;else if(typeof t=="string"&&t.startsWith("data:"))i=t,n="";else{const o=t;if(o.substr(0,1)==="/")return q.Error("Wrong sceneFilename parameter"),null;i=e+o,n=o}return{url:i,rootUrl:e,name:n,file:r,rawData:a}}static GetPluginForExtension(e){return Ze._GetPluginForExtension(e).plugin}static IsPluginForExtensionAvailable(e){return!!Ze._RegisteredPlugins[e]}static RegisterPlugin(e){if(typeof e.extensions=="string"){const t=e.extensions;Ze._RegisteredPlugins[t.toLowerCase()]={plugin:e,isBinary:!1}}else{const t=e.extensions;Object.keys(t).forEach(i=>{Ze._RegisteredPlugins[i.toLowerCase()]={plugin:e,isBinary:t[i].isBinary}})}}static ImportMesh(e,t,i="",n=Fe.LastCreatedScene,r=null,a=null,o=null,l=null,c=""){if(!n)return U.Error("No scene available to import mesh to"),null;const u=Ze._GetFileInfo(t,i);if(!u)return null;const h={};n.addPendingData(h);const d=()=>{n.removePendingData(h)},f=(_,E)=>{const v=Ze._FormatErrorMessage(u,_,E);o?o(n,v,new Os(v,Fr.SceneLoaderError,E)):U.Error(v),d()},p=a?_=>{try{a(_)}catch(E){f("Error in onProgress callback: "+E,E)}}:void 0,m=(_,E,v,y,A,I,T)=>{if(n.importedMeshesFiles.push(u.url),r)try{r(_,E,v,y,A,I,T)}catch(R){f("Error in onSuccess callback: "+R,R)}n.removePendingData(h)};return Ze._LoadData(u,n,(_,E,v)=>{if(_.rewriteRootURL&&(u.rootUrl=_.rewriteRootURL(u.rootUrl,v)),_.importMesh){const y=_,A=new Array,I=new Array,T=new Array;if(!y.importMesh(e,n,E,u.rootUrl,A,I,T,f))return;n.loadingPluginName=_.name,m(A,I,T,[],[],[],[])}else _.importMeshAsync(e,n,E,u.rootUrl,p,u.name).then(A=>{n.loadingPluginName=_.name,m(A.meshes,A.particleSystems,A.skeletons,A.animationGroups,A.transformNodes,A.geometries,A.lights)}).catch(A=>{f(A.message,A)})},p,f,d,l,c)}static ImportMeshAsync(e,t,i="",n=Fe.LastCreatedScene,r=null,a=null,o=""){return new Promise((l,c)=>{Ze.ImportMesh(e,t,i,n,(u,h,d,f,p,m,_)=>{l({meshes:u,particleSystems:h,skeletons:d,animationGroups:f,transformNodes:p,geometries:m,lights:_})},r,(u,h,d)=>{c(d||new Error(h))},a,o)})}static Load(e,t="",i=Fe.LastCreatedEngine,n=null,r=null,a=null,o=null,l=""){return i?Ze.Append(e,t,new Le(i),n,r,a,o,l):(q.Error("No engine available"),null)}static LoadAsync(e,t="",i=Fe.LastCreatedEngine,n=null,r=null,a=""){return new Promise((o,l)=>{Ze.Load(e,t,i,c=>{o(c)},n,(c,u,h)=>{l(h||new Error(u))},r,a)})}static Append(e,t="",i=Fe.LastCreatedScene,n=null,r=null,a=null,o=null,l=""){if(!i)return U.Error("No scene available to append to"),null;const c=Ze._GetFileInfo(e,t);if(!c)return null;const u={};i.addPendingData(u);const h=()=>{i.removePendingData(u)};Ze.ShowLoadingScreen&&!this._ShowingLoadingScreen&&(this._ShowingLoadingScreen=!0,i.getEngine().displayLoadingUI(),i.executeWhenReady(()=>{i.getEngine().hideLoadingUI(),this._ShowingLoadingScreen=!1}));const d=(m,_)=>{const E=Ze._FormatErrorMessage(c,m,_);a?a(i,E,new Os(E,Fr.SceneLoaderError,_)):U.Error(E),h()},f=r?m=>{try{r(m)}catch(_){d("Error in onProgress callback",_)}}:void 0,p=()=>{if(n)try{n(i)}catch(m){d("Error in onSuccess callback",m)}i.removePendingData(u)};return Ze._LoadData(c,i,(m,_)=>{if(m.load){if(!m.load(i,_,c.rootUrl,d))return;i.loadingPluginName=m.name,p()}else m.loadAsync(i,_,c.rootUrl,f,c.name).then(()=>{i.loadingPluginName=m.name,p()}).catch(v=>{d(v.message,v)})},f,d,h,o,l)}static AppendAsync(e,t="",i=Fe.LastCreatedScene,n=null,r=null,a=""){return new Promise((o,l)=>{Ze.Append(e,t,i,c=>{o(c)},n,(c,u,h)=>{l(h||new Error(u))},r,a)})}static LoadAssetContainer(e,t="",i=Fe.LastCreatedScene,n=null,r=null,a=null,o=null,l=""){if(!i)return U.Error("No scene available to load asset container to"),null;const c=Ze._GetFileInfo(e,t);if(!c)return null;const u={};i.addPendingData(u);const h=()=>{i.removePendingData(u)},d=(m,_)=>{const E=Ze._FormatErrorMessage(c,m,_);a?a(i,E,new Os(E,Fr.SceneLoaderError,_)):U.Error(E),h()},f=r?m=>{try{r(m)}catch(_){d("Error in onProgress callback",_)}}:void 0,p=m=>{if(n)try{n(m)}catch(_){d("Error in onSuccess callback",_)}i.removePendingData(u)};return Ze._LoadData(c,i,(m,_)=>{if(m.loadAssetContainer){const v=m.loadAssetContainer(i,_,c.rootUrl,d);if(!v)return;v.populateRootNodes(),i.loadingPluginName=m.name,p(v)}else m.loadAssetContainerAsync?m.loadAssetContainerAsync(i,_,c.rootUrl,f,c.name).then(v=>{v.populateRootNodes(),i.loadingPluginName=m.name,p(v)}).catch(v=>{d(v.message,v)}):d("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},f,d,h,o,l)}static LoadAssetContainerAsync(e,t="",i=Fe.LastCreatedScene,n=null,r=null){return new Promise((a,o)=>{Ze.LoadAssetContainer(e,t,i,l=>{a(l)},n,(l,c,u)=>{o(u||new Error(c))},r)})}static ImportAnimations(e,t="",i=Fe.LastCreatedScene,n=!0,r=Er.Clean,a=null,o=null,l=null,c=null,u=null){if(!i){U.Error("No scene available to load animations to");return}if(n){for(const p of i.animatables)p.reset();i.stopAllAnimations(),i.animationGroups.slice().forEach(p=>{p.dispose()}),i.getNodes().forEach(p=>{p.animations&&(p.animations=[])})}else switch(r){case Er.Clean:i.animationGroups.slice().forEach(f=>{f.dispose()});break;case Er.Stop:i.animationGroups.forEach(f=>{f.stop()});break;case Er.Sync:i.animationGroups.forEach(f=>{f.reset(),f.restart()});break;case Er.NoSync:break;default:U.Error("Unknown animation group loading mode value '"+r+"'");return}const h=i.animatables.length,d=f=>{f.mergeAnimationsTo(i,i.animatables.slice(h),a),f.dispose(),i.onAnimationFileImportedObservable.notifyObservers(i),o&&o(i)};this.LoadAssetContainer(e,t,i,d,l,c,u)}static ImportAnimationsAsync(e,t="",i=Fe.LastCreatedScene,n=!0,r=Er.Clean,a=null,o=null,l=null,c=null,u=null){return new Promise((h,d)=>{Ze.ImportAnimations(e,t,i,n,r,a,f=>{h(f)},l,(f,p,m)=>{d(m||new Error(p))},u)})}}Ze.NO_LOGGING=0;Ze.MINIMAL_LOGGING=1;Ze.SUMMARY_LOGGING=2;Ze.DETAILED_LOGGING=3;Ze.OnPluginActivatedObservable=new O;Ze._RegisteredPlugins={};Ze._ShowingLoadingScreen=!1;he._instancedMeshFactory=(s,e)=>{const t=new BE(s,e);if(e.instancedBuffers){t.instancedBuffers={};for(const i in e.instancedBuffers)t.instancedBuffers[i]=e.instancedBuffers[i]}return t};class BE extends wn{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(const i of t.getAnimationRanges())i!=null&&this.createAnimationRange(i.name,i.from,i.to);this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){var t;((t=this._sourceMesh)===null||t===void 0?void 0:t.receiveShadows)!==e&&q.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){var t;((t=this._sourceMesh)===null||t===void 0?void 0:t.material)!==e&&q.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){var t;((t=this._sourceMesh)===null||t===void 0?void 0:t.visibility)!==e&&q.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){var t;((t=this._sourceMesh)===null||t===void 0?void 0:t.skeleton)!==e&&q.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||U.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,i){return this._sourceMesh.getVerticesData(e,t,i)}setVerticesData(e,t,i,n){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,n),this.sourceMesh}updateVerticesData(e,t,i,n){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,n),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(e,t),i),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||U.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==Me.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new D);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,w.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(w.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const t=this.sourceMesh.getLODLevels();if(!t||t.length===0)this._currentLOD=this.sourceMesh;else{const i=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,i.boundingSphere)}return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,i,n){const r=(n||this._sourceMesh).createInstance(e);if(On.DeepCopy(this,r,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),t&&(r.parent=t),!i)for(let a=0;a<this.getScene().meshes.length;a++){const o=this.getScene().meshes[a];o.parent===this&&o.clone(o.name,r)}return r.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(r),r}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,i){const n=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);n&&i&&i(this,n);for(const r of this.getChildTransformNodes(!0))r.instantiateHierarchy(n,t,i);return n}}he.prototype.registerInstancedBuffer=function(s,e){var t,i;if((i=(t=this._userInstancedBuffersStorage)===null||t===void 0?void 0:t.vertexBuffers[s])===null||i===void 0||i.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const n of this.instances)n.instancedBuffers={};this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0})}this.instancedBuffers[s]=null,this._userInstancedBuffersStorage.strides[s]=e,this._userInstancedBuffersStorage.sizes[s]=e*32,this._userInstancedBuffersStorage.data[s]=new Float32Array(this._userInstancedBuffersStorage.sizes[s]),this._userInstancedBuffersStorage.vertexBuffers[s]=new C(this.getEngine(),this._userInstancedBuffersStorage.data[s],s,!0,!1,e,!0);for(const n of this.instances)n.instancedBuffers[s]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()};he.prototype._processInstancedBuffers=function(s,e){const t=s?s.length:0;for(const i in this.instancedBuffers){let n=this._userInstancedBuffersStorage.sizes[i];const r=this._userInstancedBuffersStorage.strides[i],a=(t+1)*r;for(;n<a;)n*=2;this._userInstancedBuffersStorage.data[i].length!=n&&(this._userInstancedBuffersStorage.data[i]=new Float32Array(n),this._userInstancedBuffersStorage.sizes[i]=n,this._userInstancedBuffersStorage.vertexBuffers[i]&&(this._userInstancedBuffersStorage.vertexBuffers[i].dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null));const o=this._userInstancedBuffersStorage.data[i];let l=0;if(e){const c=this.instancedBuffers[i];c.toArray?c.toArray(o,l):c.copyToArray?c.copyToArray(o,l):o[l]=c,l+=r}for(let c=0;c<t;c++){const h=s[c].instancedBuffers[i];h.toArray?h.toArray(o,l):h.copyToArray?h.copyToArray(o,l):o[l]=h,l+=r}this._userInstancedBuffersStorage.vertexBuffers[i]?this._userInstancedBuffersStorage.vertexBuffers[i].updateDirectly(o,0):(this._userInstancedBuffersStorage.vertexBuffers[i]=new C(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,r,!0),this._invalidateInstanceVertexArrayObject())}};he.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(const s in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[s]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};he.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(const s in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[s]&&this._userInstancedBuffersStorage.vertexBuffers[s].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};class Be extends oi{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}constructor(e,t){super(e,t),this.diffuse=new G(1,1,1),this.specular=new G(1,1,1),this.falloffType=Be.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=Be.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new le(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=new Array,this.excludedMeshes=new Array,this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,n,r=!0){var a;const o=e.toString();let l=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+o),this._renderId!==t.getRenderId()||this._lastUseSpecular!==n||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=n;const c=this.getScaledIntensity();this.transferToEffect(i,o),this.diffuse.scaleToRef(c,jn.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",jn.Color3[0],this.range,o),n&&(this.specular.scaleToRef(c,jn.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",jn.Color3[1],this.radius,o)),l=!0}if(this.transferTexturesToEffect(i,o),t.shadowsEnabled&&this.shadowEnabled&&r){const c=(a=this.getShadowGenerator(t.activeCamera))!==null&&a!==void 0?a:this.getShadowGenerator();c&&(c.bindShadowLight(o,i),l=!0)}l?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){var t;return this._shadowGenerators===null?null:(t=this._shadowGenerators.get(e))!==null&&t!==void 0?t:null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return g.Zero()}canAffectMesh(e){return e?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(e)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1||this.includeOnlyWithLayerMask!==0&&!(this.includeOnlyWithLayerMask&e.layerMask)||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&e.layerMask):!0}dispose(e,t=!1){if(this._shadowGenerators){const i=this._shadowGenerators.values();for(let n=i.next();n.done!==!0;n=i.next())n.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){const i=this._parentContainer.lights.indexOf(this);i>-1&&this._parentContainer.lights.splice(i,1),this._parentContainer=null}for(const i of this.getScene().meshes)i._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const i=Be.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;const n=Pe.Clone(i,this);return e&&(n.name=e),t&&(n.parent=t),n.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(n),n}serialize(){const e=Pe.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach(t=>{e.excludedMeshesIds.push(t.id)})),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(t=>{e.includedOnlyMeshesIds.push(t.id)})),Pe.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){const n=oi.Construct("Light_Type_"+e,t,i);return n||null}static Parse(e,t){const i=Be.GetConstructorFromName(e.type,e.name,t);if(!i)return null;const n=Pe.Parse(i,e,t);if(e.excludedMeshesIds&&(n._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(n._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId!==void 0&&(n._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(n._waitingParentInstanceIndex=e.parentInstanceIndex),e.falloffType!==void 0&&(n.falloffType=e.falloffType),e.lightmapMode!==void 0&&(n.lightmapMode=e.lightmapMode),e.animations){for(let r=0;r<e.animations.length;r++){const a=e.animations[r],o=hn("BABYLON.Animation");o&&n.animations.push(o.Parse(a))}oi.ParseAnimationRanges(n,e,t)}return e.autoAnimate&&t.beginAnimation(n,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&n.setEnabled(e.isEnabled),n}_hookArrayForExcluded(e){const t=e.push;e.push=(...n)=>{const r=t.apply(e,n);for(const a of n)a._resyncLightSource(this);return r};const i=e.splice;e.splice=(n,r)=>{const a=i.apply(e,[n,r]);for(const o of a)o._resyncLightSource(this);return a};for(const n of e)n._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...n)=>{const r=t.apply(e,n);return this._resyncMeshes(),r};const i=e.splice;e.splice=(n,r)=>{const a=i.apply(e,[n,r]);return this._resyncMeshes(),a},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)e.lightSources.indexOf(this)!==-1&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const t=this.getTypeID();let i=this.intensityMode;switch(i===Be.INTENSITYMODE_AUTOMATIC&&(t===Be.LIGHTTYPEID_DIRECTIONALLIGHT?i=Be.INTENSITYMODE_ILLUMINANCE:i=Be.INTENSITYMODE_LUMINOUSINTENSITY),t){case Be.LIGHTTYPEID_POINTLIGHT:case Be.LIGHTTYPEID_SPOTLIGHT:switch(i){case Be.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case Be.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case Be.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;break}break;case Be.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case Be.INTENSITYMODE_ILLUMINANCE:e=1;break;case Be.INTENSITYMODE_LUMINANCE:{let n=this.radius;n=Math.max(n,.001),e=2*Math.PI*(1-Math.cos(n));break}}break;case Be.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;break}return e}_reorderLightsInScene(){const e=this.getScene();this._renderPriority!=0&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}}Be.FALLOFF_DEFAULT=ft.FALLOFF_DEFAULT;Be.FALLOFF_PHYSICAL=ft.FALLOFF_PHYSICAL;Be.FALLOFF_GLTF=ft.FALLOFF_GLTF;Be.FALLOFF_STANDARD=ft.FALLOFF_STANDARD;Be.LIGHTMAP_DEFAULT=ft.LIGHTMAP_DEFAULT;Be.LIGHTMAP_SPECULAR=ft.LIGHTMAP_SPECULAR;Be.LIGHTMAP_SHADOWSONLY=ft.LIGHTMAP_SHADOWSONLY;Be.INTENSITYMODE_AUTOMATIC=ft.INTENSITYMODE_AUTOMATIC;Be.INTENSITYMODE_LUMINOUSPOWER=ft.INTENSITYMODE_LUMINOUSPOWER;Be.INTENSITYMODE_LUMINOUSINTENSITY=ft.INTENSITYMODE_LUMINOUSINTENSITY;Be.INTENSITYMODE_ILLUMINANCE=ft.INTENSITYMODE_ILLUMINANCE;Be.INTENSITYMODE_LUMINANCE=ft.INTENSITYMODE_LUMINANCE;Be.LIGHTTYPEID_POINTLIGHT=ft.LIGHTTYPEID_POINTLIGHT;Be.LIGHTTYPEID_DIRECTIONALLIGHT=ft.LIGHTTYPEID_DIRECTIONALLIGHT;Be.LIGHTTYPEID_SPOTLIGHT=ft.LIGHTTYPEID_SPOTLIGHT;Be.LIGHTTYPEID_HEMISPHERICLIGHT=ft.LIGHTTYPEID_HEMISPHERICLIGHT;S([Gi()],Be.prototype,"diffuse",void 0);S([Gi()],Be.prototype,"specular",void 0);S([b()],Be.prototype,"falloffType",void 0);S([b()],Be.prototype,"intensity",void 0);S([b()],Be.prototype,"range",null);S([b()],Be.prototype,"intensityMode",null);S([b()],Be.prototype,"radius",null);S([b()],Be.prototype,"_renderPriority",void 0);S([K("_reorderLightsInScene")],Be.prototype,"renderPriority",void 0);S([b("shadowEnabled")],Be.prototype,"_shadowEnabled",void 0);S([b("excludeWithLayerMask")],Be.prototype,"_excludeWithLayerMask",void 0);S([b("includeOnlyWithLayerMask")],Be.prototype,"_includeOnlyWithLayerMask",void 0);S([b("lightmapMode")],Be.prototype,"_lightmapMode",void 0);class pb extends Oo{}class mb{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach(e=>{e.dispose()}),this.rootNodes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0}}class _b extends Oo{constructor(e){super(),this._wasAddedToScene=!1,e=e||Fe.LastCreatedScene,e&&(this.scene=e,this.sounds=[],this.effectLayers=[],this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.reflectionProbes=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(const t of this.geometries)t._rebuild();for(const t of this.meshes)t._rebuild();for(const t of this.particleSystems)t.rebuild();for(const t of this.textures)t._rebuild()}))}_topologicalSort(e){const t=new Map;for(const o of e)t.set(o.uniqueId,o);const i={dependsOn:new Map,dependedBy:new Map};for(const o of e){const l=o.uniqueId;i.dependsOn.set(l,new Set),i.dependedBy.set(l,new Set)}for(const o of e){const l=o.uniqueId,c=i.dependsOn.get(l);if(o instanceof BE){const h=o.sourceMesh;t.has(h.uniqueId)&&(c.add(h.uniqueId),i.dependedBy.get(h.uniqueId).add(l))}const u=i.dependedBy.get(l);for(const h of o.getDescendants()){const d=h.uniqueId;t.has(d)&&(u.add(d),i.dependsOn.get(d).add(l))}}const n=[],r=[];for(const o of e){const l=o.uniqueId;i.dependsOn.get(l).size===0&&(r.push(o),t.delete(l))}const a=r;for(;a.length>0;){const o=a.shift();n.push(o);const l=i.dependedBy.get(o.uniqueId);for(const c of Array.from(l.values())){const u=i.dependsOn.get(c);u.delete(o.uniqueId),u.size===0&&t.get(c)&&(a.push(t.get(c)),t.delete(c))}}return t.size>0&&(console.error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(o=>console.error(o.name))),n}_addNodeAndDescendantsToList(e,t,i,n){if(!(!i||n&&!n(i)||t.has(i.uniqueId))){e.push(i),t.add(i.uniqueId);for(const r of i.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,r,n)}}_isNodeInContainer(e){return e instanceof he&&this.meshes.indexOf(e)!==-1||e instanceof Me&&this.transformNodes.indexOf(e)!==-1||e instanceof Be&&this.lights.indexOf(e)!==-1||e instanceof Ee&&this.cameras.indexOf(e)!==-1}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return U.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return U.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return U.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return U.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||q.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const n={},r={},a=new mb,o=[],l=[],c=Object.assign({doNotInstantiate:!0},i),u=(m,_)=>{if(n[m.uniqueId]=_.uniqueId,r[_.uniqueId]=_,e&&(_.name=e(m.name)),_ instanceof he){const E=_;if(E.morphTargetManager){const v=m.morphTargetManager;E.morphTargetManager=v.clone();for(let y=0;y<v.numTargets;y++){const A=v.getTarget(y),I=E.morphTargetManager.getTarget(y);n[A.uniqueId]=I.uniqueId,r[I.uniqueId]=I}}}},h=[],d=new Set;for(const m of this.transformNodes)m.parent===null&&this._addNodeAndDescendantsToList(h,d,m,c.predicate);for(const m of this.meshes)m.parent===null&&this._addNodeAndDescendantsToList(h,d,m,c.predicate);const f=this._topologicalSort(h),p=(m,_)=>{if(u(m,_),m.parent){const E=n[m.parent.uniqueId],v=r[E];v?_.parent=v:_.parent=m.parent}if(_.position&&m.position&&_.position.copyFrom(m.position),_.rotationQuaternion&&m.rotationQuaternion&&_.rotationQuaternion.copyFrom(m.rotationQuaternion),_.rotation&&m.rotation&&_.rotation.copyFrom(m.rotation),_.scaling&&m.scaling&&_.scaling.copyFrom(m.scaling),_.material){const E=_;if(E.material)if(t){const v=m.material;if(l.indexOf(v)===-1){let y=v.clone(e?e(v.name):"Clone of "+v.name);if(l.push(v),n[v.uniqueId]=y.uniqueId,r[y.uniqueId]=y,v.getClassName()==="MultiMaterial"){const A=v;for(const I of A.subMaterials)I&&(y=I.clone(e?e(I.name):"Clone of "+I.name),l.push(I),n[I.uniqueId]=y.uniqueId,r[y.uniqueId]=y);A.subMaterials=A.subMaterials.map(I=>I&&r[n[I.uniqueId]])}}E.getClassName()!=="InstancedMesh"&&(E.material=r[n[v.uniqueId]])}else E.material.getClassName()==="MultiMaterial"?this.scene.multiMaterials.indexOf(E.material)===-1&&this.scene.addMultiMaterial(E.material):this.scene.materials.indexOf(E.material)===-1&&this.scene.addMaterial(E.material)}_.parent===null&&a.rootNodes.push(_)};return f.forEach(m=>{if(m.getClassName()==="InstancedMesh"){const _=m,E=_.sourceMesh,v=n[E.uniqueId],A=(typeof v=="number"?r[v]:E).createInstance(_.name);p(_,A)}else{let _=!0;m.getClassName()==="TransformNode"||m.getClassName()==="Node"||m.skeleton||!m.getTotalVertices||m.getTotalVertices()===0?_=!1:c.doNotInstantiate&&(typeof c.doNotInstantiate=="function"?_=!c.doNotInstantiate(m):_=!c.doNotInstantiate);const E=_?m.createInstance(`instance of ${m.name}`):m.clone(`Clone of ${m.name}`,null,!0);if(!E)throw new Error(`Could not clone or instantiate node on Asset Container ${m.name}`);p(m,E)}}),this.skeletons.forEach(m=>{if(c.predicate&&!c.predicate(m))return;const _=m.clone(e?e(m.name):"Clone of "+m.name);for(const E of this.meshes)if(E.skeleton===m&&!E.isAnInstance){const v=r[n[E.uniqueId]];if(!v||v.isAnInstance||(v.skeleton=_,o.indexOf(_)!==-1))continue;o.push(_);for(const y of _.bones)y._linkedTransformNode&&(y._linkedTransformNode=r[n[y._linkedTransformNode.uniqueId]])}a.skeletons.push(_)}),this.animationGroups.forEach(m=>{if(c.predicate&&!c.predicate(m))return;const _=m.clone(e?e(m.name):"Clone of "+m.name,E=>r[n[E.uniqueId]]||E);a.animationGroups.push(_)}),a}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||q.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){const t=[];this.cameras.forEach(i=>{e&&!e(i)||(this.scene.addCamera(i),t.push(i))}),this.lights.forEach(i=>{e&&!e(i)||(this.scene.addLight(i),t.push(i))}),this.meshes.forEach(i=>{e&&!e(i)||(this.scene.addMesh(i),t.push(i))}),this.skeletons.forEach(i=>{e&&!e(i)||this.scene.addSkeleton(i)}),this.animations.forEach(i=>{e&&!e(i)||this.scene.addAnimation(i)}),this.animationGroups.forEach(i=>{e&&!e(i)||this.scene.addAnimationGroup(i)}),this.multiMaterials.forEach(i=>{e&&!e(i)||this.scene.addMultiMaterial(i)}),this.materials.forEach(i=>{e&&!e(i)||this.scene.addMaterial(i)}),this.morphTargetManagers.forEach(i=>{e&&!e(i)||this.scene.addMorphTargetManager(i)}),this.geometries.forEach(i=>{e&&!e(i)||this.scene.addGeometry(i)}),this.transformNodes.forEach(i=>{e&&!e(i)||(this.scene.addTransformNode(i),t.push(i))}),this.actionManagers.forEach(i=>{e&&!e(i)||this.scene.addActionManager(i)}),this.textures.forEach(i=>{e&&!e(i)||this.scene.addTexture(i)}),this.reflectionProbes.forEach(i=>{e&&!e(i)||this.scene.addReflectionProbe(i)});for(const i of t)i.parent&&this.scene.getNodes().indexOf(i.parent)===-1&&(i.setParent?i.setParent(null):i.parent=null)}removeAllFromScene(){this._isValidHierarchy()||q.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.removeCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.removeLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.removeMesh(t)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.removeSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.removeAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.removeAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.removeMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.removeMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.removeMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.removeGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.removeTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.removeActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.removeTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.removeReflectionProbe(t)})}dispose(){this.cameras.slice(0).forEach(e=>{e.dispose()}),this.cameras.length=0,this.lights.slice(0).forEach(e=>{e.dispose()}),this.lights.length=0,this.meshes.slice(0).forEach(e=>{e.dispose()}),this.meshes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach(e=>{e.dispose()}),this.multiMaterials.length=0,this.materials.slice(0).forEach(e=>{e.dispose()}),this.materials.length=0,this.geometries.slice(0).forEach(e=>{e.dispose()}),this.geometries.length=0,this.transformNodes.slice(0).forEach(e=>{e.dispose()}),this.transformNodes.length=0,this.actionManagers.slice(0).forEach(e=>{e.dispose()}),this.actionManagers.length=0,this.textures.slice(0).forEach(e=>{e.dispose()}),this.textures.length=0,this.reflectionProbes.slice(0).forEach(e=>{e.dispose()}),this.reflectionProbes.length=0,this.morphTargetManagers.slice(0).forEach(e=>{e.dispose()}),this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(!(!e||!t))for(const n of e){let r=!0;if(i){for(const a of i)if(n===a){r=!1;break}}r&&(t.push(n),n._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,e===void 0&&(e=new pb);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||(t==="_environmentTexture"?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new he("assetContainerRootMesh",this.scene);return this.meshes.forEach(t=>{t.parent||e.addChild(t)}),this.meshes.unshift(e),e}mergeAnimationsTo(e=Fe.LastCreatedScene,t,i=null){if(!e)return U.Error("No scene available to merge animations to"),[];const n=i||(o=>{let l=null;const c=o.animations.length?o.animations[0].targetProperty:"",u=o.name.split(".").join("").split("_primitive")[0];switch(c){case"position":case"rotationQuaternion":l=e.getTransformNodeByName(o.name)||e.getTransformNodeByName(u);break;case"influence":l=e.getMorphTargetByName(o.name)||e.getMorphTargetByName(u);break;default:l=e.getNodeByName(o.name)||e.getNodeByName(u)}return l});this.getNodes().forEach(o=>{const l=n(o);if(l!==null){for(const c of o.animations){const u=l.animations.filter(h=>h.targetProperty===c.targetProperty);for(const h of u){const d=l.animations.indexOf(h,0);d>-1&&l.animations.splice(d,1)}}l.animations=l.animations.concat(o.animations)}});const a=new Array;return this.animationGroups.slice().forEach(o=>{a.push(o.clone(o.name,n)),o.animatables.forEach(l=>{l.stop()})}),t.forEach(o=>{const l=n(o.target);l&&(e.beginAnimation(l,o.fromFrame,o.toFrame,o.loopAnimation,o.speedRatio,o.onAnimationEnd?o.onAnimationEnd:void 0,void 0,!0,void 0,o.onAnimationLoop?o.onAnimationLoop:void 0),e.stopAnimation(o.target))}),a}populateRootNodes(){this.rootNodes.length=0,this.meshes.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}),this.transformNodes.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}),this.lights.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}),this.cameras.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)})}}class Dc{constructor(e){this.byteOffset=0,this.buffer=e}loadAsync(e){return this.buffer.readAsync(this.byteOffset,e).then(t=>{this._dataView=new DataView(t.buffer,t.byteOffset,t.byteLength),this._dataByteOffset=0})}readUint32(){const e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return pT(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}}function rf(s,e,t,i){const n={externalResourceFunction:r=>i(r).then(a=>new Uint8Array(a))};return t&&(n.uri=e==="file:"?t:e+t),s instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(s),n):GLTFValidator.validateString(s,n)}function gb(){const s=[];onmessage=e=>{const t=e.data;switch(t.id){case"init":{importScripts(t.url);break}case"validate":{rf(t.data,t.rootUrl,t.fileName,i=>new Promise((n,r)=>{const a=s.length;s.push({resolve:n,reject:r}),postMessage({id:"getExternalResource",index:a,uri:i})})).then(i=>{postMessage({id:"validate.resolve",value:i})},i=>{postMessage({id:"validate.reject",reason:i})});break}case"getExternalResource.resolve":{s[t.index].resolve(t.value);break}case"getExternalResource.reject":{s[t.index].reject(t.reason);break}}}}class kE{static ValidateAsync(e,t,i,n){const r=ArrayBuffer.isView(e)?e.slice().buffer:e;return typeof Worker=="function"?new Promise((a,o)=>{const l=`${rf}(${gb})()`,c=URL.createObjectURL(new Blob([l],{type:"application/javascript"})),u=new Worker(c),h=f=>{u.removeEventListener("error",h),u.removeEventListener("message",d),o(f)},d=f=>{const p=f.data;switch(p.id){case"getExternalResource":{n(p.uri).then(m=>{u.postMessage({id:"getExternalResource.resolve",index:p.index,value:m},[m])},m=>{u.postMessage({id:"getExternalResource.reject",index:p.index,reason:m})});break}case"validate.resolve":{u.removeEventListener("error",h),u.removeEventListener("message",d),a(p.value),u.terminate();break}case"validate.reject":u.removeEventListener("error",h),u.removeEventListener("message",d),o(p.reason),u.terminate()}};u.addEventListener("error",h),u.addEventListener("message",d),u.postMessage({id:"init",url:this.Configuration.url}),u.postMessage({id:"validate",data:r,rootUrl:t,fileName:i})}):(this._LoadScriptPromise||(this._LoadScriptPromise=q.LoadScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>rf(r,t,i,n)))}}kE.Configuration={url:"https://preview.babylonjs.com/gltf_validator.js"};function j_(s,e,t){try{return Promise.resolve(new Uint8Array(s,e,t))}catch(i){return Promise.reject(i)}}function Eb(s,e,t){try{if(s.byteOffset+t>s.byteLength)throw new Error("Array length out of bounds.");return Promise.resolve(new Uint8Array(s.buffer,s.byteOffset+e,t))}catch(i){return Promise.reject(i)}}var Bl;(function(s){s[s.AUTO=0]="AUTO",s[s.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(Bl||(Bl={}));var oo;(function(s){s[s.NONE=0]="NONE",s[s.FIRST=1]="FIRST",s[s.ALL=2]="ALL"})(oo||(oo={}));var An;(function(s){s[s.LOADING=0]="LOADING",s[s.READY=1]="READY",s[s.COMPLETE=2]="COMPLETE"})(An||(An={}));class ci{constructor(){this.onParsedObservable=new O,this.coordinateSystemMode=Bl.AUTO,this.animationStartMode=oo.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable=new O,this.onSkinLoadedObservable=new O,this.onTextureLoadedObservable=new O,this.onMaterialLoadedObservable=new O,this.onCameraLoadedObservable=new O,this.onCompleteObservable=new O,this.onErrorObservable=new O,this.onDisposeObservable=new O,this.onExtensionLoadedObservable=new O,this.validate=!1,this.onValidatedObservable=new O,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new O,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(e)}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e)}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e)}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e)}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e)}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,i,n,r,a,o,l){if(ArrayBuffer.isView(t))return this._loadBinary(e,t,i,n,o,l),null;this._progressCallback=r;const c=t.name||q.GetFilename(t);if(a){if(this.useRangeRequests){this.validate&&U.Warn("glTF validation is not supported when range requests are enabled");const u={abort:()=>{},onCompleteObservable:new O},h={readAsync:(d,f)=>new Promise((p,m)=>{this._loadFile(e,t,_=>{p(new Uint8Array(_))},!0,_=>{m(_)},_=>{_.setRequestHeader("Range",`bytes=${d}-${d+f-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new Dc(h)).then(d=>{u.onCompleteObservable.notifyObservers(u),n(d)},o?d=>o(void 0,d):void 0),u}return this._loadFile(e,t,u=>{this._validate(e,new Uint8Array(u),i,c),this._unpackBinaryAsync(new Dc({readAsync:(h,d)=>j_(u,h,d),byteLength:u.byteLength})).then(h=>{n(h)},o?h=>o(void 0,h):void 0)},!0,o)}return this._loadFile(e,t,u=>{this._validate(e,new Uint8Array(u),i,c),n({json:this._parseJson(u)})},a,o)}_loadBinary(e,t,i,n,r,a){this._validate(e,t,i,a),this._unpackBinaryAsync(new Dc({readAsync:(o,l)=>Eb(t,o,l),byteLength:t.byteLength})).then(o=>{n(o)},r?o=>r(void 0,o):void 0)}importMeshAsync(e,t,i,n,r,a){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(i),this.onParsedObservable.clear(),this._log(`Loading ${a||""}`),this._loader=this._getLoader(i),this._loader.importMeshAsync(e,t,null,i,n,r,a)))}loadAsync(e,t,i,n,r){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,i,n,r)))}loadAssetContainerAsync(e,t,i,n,r){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(t);const a=new _b(e),o=[];this.onMaterialLoadedObservable.add(h=>{o.push(h)});const l=[];this.onTextureLoadedObservable.add(h=>{l.push(h)});const c=[];this.onCameraLoadedObservable.add(h=>{c.push(h)});const u=[];return this.onMeshLoadedObservable.add(h=>{h.morphTargetManager&&u.push(h.morphTargetManager)}),this._loader.importMeshAsync(null,e,a,t,i,n,r).then(h=>(Array.prototype.push.apply(a.geometries,h.geometries),Array.prototype.push.apply(a.meshes,h.meshes),Array.prototype.push.apply(a.particleSystems,h.particleSystems),Array.prototype.push.apply(a.skeletons,h.skeletons),Array.prototype.push.apply(a.animationGroups,h.animationGroups),Array.prototype.push.apply(a.materials,o),Array.prototype.push.apply(a.textures,l),Array.prototype.push.apply(a.lights,h.lights),Array.prototype.push.apply(a.transformNodes,h.transformNodes),Array.prototype.push.apply(a.cameras,c),Array.prototype.push.apply(a.morphTargetManagers,u),a))})}canDirectLoad(e){return e.indexOf("asset")!==-1&&e.indexOf("version")!==-1||e.startsWith("data:base64,"+ci._MagicBase64Encoded)||e.startsWith("data:;base64,"+ci._MagicBase64Encoded)||e.startsWith("data:application/octet-stream;base64,"+ci._MagicBase64Encoded)||e.startsWith("data:model/gltf-binary;base64,"+ci._MagicBase64Encoded)}directLoad(e,t){if(t.startsWith("base64,"+ci._MagicBase64Encoded)||t.startsWith(";base64,"+ci._MagicBase64Encoded)||t.startsWith("application/octet-stream;base64,"+ci._MagicBase64Encoded)||t.startsWith("model/gltf-binary;base64,"+ci._MagicBase64Encoded)){const i=ql(t);return this._validate(e,new Uint8Array(i)),this._unpackBinaryAsync(new Dc({readAsync:(n,r)=>j_(i,n,r),byteLength:i.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(){return new ci}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((e,t)=>{this.onCompleteObservable.addOnce(()=>{e()}),this.onErrorObservable.addOnce(i=>{t(i)})})}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(An[this._state]))}_loadFile(e,t,i,n,r,a){const o=e._loadFile(t,i,l=>{this._onProgress(l,o)},!0,n,r,a);return o.onCompleteObservable.add(l=>{this._requests.splice(this._requests.indexOf(l),1)}),this._requests.push(o),o}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let i=!0,n=0,r=0;for(const a of this._requests){if(a._lengthComputable===void 0||a._loaded===void 0||a._total===void 0)return;i=i&&a._lengthComputable,n+=a._loaded,r+=a._total}this._progressCallback({lengthComputable:i,loaded:n,total:i?r:0})}_validate(e,t,i="",n=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),kE.ValidateAsync(t,i,n,r=>this.preprocessUrlAsync(i+r).then(a=>e._loadFileAsync(a,void 0,!0,!0))).then(r=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(r),this.onValidatedObservable.clear()},r=>{this._endPerformanceCounter("Validate JSON"),q.Warn(`Failed to validate: ${r.message}`),this.onValidatedObservable.clear()}))}_getLoader(e){const t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);const i=ci._parseVersion(t.version);if(!i)throw new Error("Invalid version: "+t.version);if(t.minVersion!==void 0){const a=ci._parseVersion(t.minVersion);if(!a)throw new Error("Invalid minimum version: "+t.minVersion);if(ci._compareVersion(a,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const r={1:ci._CreateGLTF1Loader,2:ci._CreateGLTF2Loader}[i.major];if(!r)throw new Error("Unsupported version: "+t.version);return r(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(()=>{const t={Magic:1179937895},i=e.readUint32();if(i!==t.Magic)throw new Os("Unexpected magic: "+i,Fr.GLTFLoaderUnexpectedMagicError);const n=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${n}`);const r=e.readUint32();!this.useRangeRequests&&r!==e.buffer.byteLength&&U.Warn(`Length in header does not match actual data length: ${r} != ${e.buffer.byteLength}`);let a;switch(n){case 1:{a=this._unpackBinaryV1Async(e,r);break}case 2:{a=this._unpackBinaryV2Async(e,r);break}default:throw new Error("Unsupported version: "+n)}return this._endPerformanceCounter("Unpack Binary"),a})}_unpackBinaryV1Async(e,t){const i={JSON:0},n=e.readUint32(),r=e.readUint32();if(r!==i.JSON)throw new Error(`Unexpected content format: ${r}`);const a=t-e.byteOffset,o={json:this._parseJson(e.readString(n)),bin:null};if(a!==0){const l=e.byteOffset;o.bin={readAsync:(c,u)=>e.buffer.readAsync(l+c,u),byteLength:a}}return Promise.resolve(o)}_unpackBinaryV2Async(e,t){const i={JSON:1313821514,BIN:5130562},n=e.readUint32();if(e.readUint32()!==i.JSON)throw new Error("First chunk format is not JSON");return e.byteOffset+n===t?e.loadAsync(n).then(()=>({json:this._parseJson(e.readString(n)),bin:null})):e.loadAsync(n+8).then(()=>{const a={json:this._parseJson(e.readString(n)),bin:null},o=()=>{const l=e.readUint32();switch(e.readUint32()){case i.JSON:throw new Error("Unexpected JSON chunk");case i.BIN:{const u=e.byteOffset;a.bin={readAsync:(h,d)=>e.buffer.readAsync(u+h,d),byteLength:l},e.skipBytes(l);break}default:{e.skipBytes(l);break}}return e.byteOffset!==t?e.loadAsync(8).then(o):Promise.resolve(a)};return o()})}static _parseVersion(e){if(e==="1.0"||e==="1.0.1")return{major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const t=ci._logSpaces.substr(0,this._logIndentLevel*2);U.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){q.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){q.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}ci.IncrementalLoading=!0;ci.HomogeneousCoordinates=!1;ci._MagicBase64Encoded="Z2xURg";ci._logSpaces="                                ";Ze&&Ze.RegisterPlugin(new ci);function $_(s,e,t,i){return g.FromArray(e,t).scaleInPlace(i)}function vb(s,e,t,i){return ee.FromArray(e,t).scaleInPlace(i)}function yb(s,e,t,i){const n=new Array(s._numMorphTargets);for(let r=0;r<n.length;r++)n[r]=e[t++]*i;return n}class ec{constructor(e,t,i,n){this.type=e,this.name=t,this.getValue=i,this.getStride=n}_buildAnimation(e,t,i){const n=new B(e,this.name,t,this.type);return n.setKeys(i),n}}class Zh extends ec{buildAnimations(e,t,i,n,r){r(e._babylonTransformNode,this._buildAnimation(t,i,n))}}class Ab extends ec{buildAnimations(e,t,i,n,r){if(e._numMorphTargets)for(let a=0;a<e._numMorphTargets;a++){const o=new B(`${t}_${a}`,this.name,i,this.type);if(o.setKeys(n.map(l=>({frame:l.frame,inTangent:l.inTangent?l.inTangent[a]:void 0,value:l.value[a],outTangent:l.outTangent?l.outTangent[a]:void 0,interpolation:l.interpolation}))),e._primitiveBabylonMeshes){for(const l of e._primitiveBabylonMeshes)if(l.morphTargetManager){const c=l.morphTargetManager.getTarget(a),u=o.clone();c.animations.push(u),r(c,u)}}}}}const $o={translation:[new Zh(B.ANIMATIONTYPE_VECTOR3,"position",$_,()=>3)],rotation:[new Zh(B.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",vb,()=>4)],scale:[new Zh(B.ANIMATIONTYPE_VECTOR3,"scaling",$_,()=>3)],weights:[new Ab(B.ANIMATIONTYPE_FLOAT,"influence",yb,s=>s._numMorphTargets)]};function UE(...s){const e=t=>t&&typeof t=="object";return s.reduce((t,i)=>(Object.keys(i).forEach(n=>{const r=t[n],a=i[n];Array.isArray(r)&&Array.isArray(a)?t[n]=r.concat(...a):e(r)&&e(a)?t[n]=UE(r,a):t[n]=a}),t),{})}class xe{static Get(e,t,i){if(!t||i==null||!t[i])throw new Error(`${e}: Failed to find index (${i})`);return t[i]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}class ce{static RegisterExtension(e,t){ce.UnregisterExtension(e)&&U.Warn(`Extension with the name '${e}' already exists`),ce._RegisteredExtensions[e]={factory:t}}static UnregisterExtension(e){return ce._RegisteredExtensions[e]?(delete ce._RegisteredExtensions[e],!0):!1}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(e=>e.dispose&&e.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(e,t,i,n,r,a,o=""){return Promise.resolve().then(()=>{this._babylonScene=t,this._assetContainer=i,this._loadData(n);let l=null;if(e){const c={};if(this._gltf.nodes)for(const h of this._gltf.nodes)h.name&&(c[h.name]=h.index);l=(e instanceof Array?e:[e]).map(h=>{const d=c[h];if(d===void 0)throw new Error(`Failed to find node '${h}'`);return d})}return this._loadAsync(r,o,l,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries()}))})}loadAsync(e,t,i,n,r=""){return Promise.resolve().then(()=>(this._babylonScene=e,this._loadData(t),this._loadAsync(i,r,null,()=>{})))}_loadAsync(e,t,i,n){return Promise.resolve().then(()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._loadExtensions(),this._checkExtensions();const r=`${An[An.LOADING]} => ${An[An.READY]}`,a=`${An[An.LOADING]} => ${An[An.COMPLETE]}`;this._parent._startPerformanceCounter(r),this._parent._startPerformanceCounter(a),this._parent._setState(An.LOADING),this._extensionsOnLoading();const o=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(i)o.push(this.loadSceneAsync("/nodes",{nodes:i,index:-1}));else if(this._gltf.scene!=null||this._gltf.scenes&&this._gltf.scenes[0]){const u=xe.Get("/scene",this._gltf.scenes,this._gltf.scene||0);o.push(this.loadSceneAsync(`/scenes/${u.index}`,u))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let u=0;u<this._gltf.materials.length;++u){const h=this._gltf.materials[u],d="/materials/"+u,f=z.TriangleFillMode;o.push(this._loadMaterialAsync(d,h,null,f,()=>{}))}return this._babylonScene.blockMaterialDirtyMechanism=l,this._parent.compileMaterials&&o.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&o.push(this._compileShadowGeneratorsAsync()),Promise.all(o).then(()=>(this._rootBabylonMesh&&this._rootBabylonMesh.setEnabled(!0),this._extensionsOnReady(),this._parent._setState(An.READY),this._startAnimations(),n())).then(u=>(this._parent._endPerformanceCounter(r),q.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(a),this._parent._setState(An.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},h=>{this._parent.onErrorObservable.notifyObservers(h),this._parent.onErrorObservable.clear(),this.dispose()})}),u))}).catch(r=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(r),this._parent.onErrorObservable.clear(),this.dispose()),r})}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const i=t[0];(i.byteLength<e.bin.byteLength-3||i.byteLength>e.bin.byteLength)&&U.Warn(`Binary buffer length (${i.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else U.Warn("Unexpected BIN chunk")}}_setupData(){if(xe.Assign(this._gltf.accessors),xe.Assign(this._gltf.animations),xe.Assign(this._gltf.buffers),xe.Assign(this._gltf.bufferViews),xe.Assign(this._gltf.cameras),xe.Assign(this._gltf.images),xe.Assign(this._gltf.materials),xe.Assign(this._gltf.meshes),xe.Assign(this._gltf.nodes),xe.Assign(this._gltf.samplers),xe.Assign(this._gltf.scenes),xe.Assign(this._gltf.skins),xe.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const i of this._gltf.nodes)if(i.children)for(const n of i.children)e[n]=i.index;const t=this._createRootNode();for(const i of this._gltf.nodes){const n=e[i.index];i.parent=n===void 0?t:this._gltf.nodes[n]}}}_loadExtensions(){for(const e in ce._RegisteredExtensions){const t=ce._RegisteredExtensions[e].factory(this);t.name!==e&&U.Warn(`The name of the glTF loader extension instance does not match the registered name: ${t.name} !== ${e}`),this._extensions.push(t),this._parent.onExtensionLoadedObservable.notifyObservers(t)}this._extensions.sort((e,t)=>(e.order||Number.MAX_VALUE)-(t.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear()}_checkExtensions(){if(this._gltf.extensionsRequired){for(const e of this._gltf.extensionsRequired)if(!this._extensions.some(i=>i.name===e&&i.enabled))throw new Error(`Require extension ${e} is not available`)}}_createRootNode(){this._babylonScene._blockEntityCollection=!!this._assetContainer,this._rootBabylonMesh=new he("__root__",this._babylonScene),this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const e={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case Bl.AUTO:{this._babylonScene.useRightHandedSystem||(e.rotation=[0,1,0,0],e.scale=[1,1,-1],ce._LoadTransform(e,this._rootBabylonMesh));break}case Bl.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),e}loadSceneAsync(e,t){const i=this._extensionsLoadSceneAsync(e,t);if(i)return i;const n=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const r of t.nodes){const a=xe.Get(`${e}/nodes/${r}`,this._gltf.nodes,r);n.push(this.loadNodeAsync(`/nodes/${a.index}`,a,o=>{o.parent=this._rootBabylonMesh}))}for(const r of this._postSceneLoadActions)r();return n.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(n).then(()=>{})}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const i of e._primitiveBabylonMeshes)t(i)}_getGeometries(){const e=new Array,t=this._gltf.nodes;if(t)for(const i of t)this._forEachPrimitive(i,n=>{const r=n.geometry;r&&e.indexOf(r)===-1&&e.push(r)});return e}_getMeshes(){const e=new Array;this._rootBabylonMesh&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const i of t)this._forEachPrimitive(i,n=>{e.push(n)});return e}_getTransformNodes(){const e=new Array,t=this._gltf.nodes;if(t)for(const i of t)i._babylonTransformNode&&i._babylonTransformNode.getClassName()==="TransformNode"&&e.push(i._babylonTransformNode),i._babylonTransformNodeForSkin&&e.push(i._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=new Array,t=this._gltf.skins;if(t)for(const i of t)i._data&&e.push(i._data.babylonSkeleton);return e}_getAnimationGroups(){const e=new Array,t=this._gltf.animations;if(t)for(const i of t)i._babylonAnimationGroup&&e.push(i._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case oo.NONE:break;case oo.FIRST:{const e=this._getAnimationGroups();e.length!==0&&e[0].start(!0);break}case oo.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(!0);break}default:{U.Error(`Invalid animation start mode (${this._parent.animationStartMode})`);return}}}loadNodeAsync(e,t,i=()=>{}){const n=this._extensionsLoadNodeAsync(e,t,i);if(n)return n;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const r=new Array;this.logOpen(`${e} ${t.name||""}`);const a=o=>{if(ce.AddPointerMetadata(o,e),ce._LoadTransform(t,o),t.camera!=null){const l=xe.Get(`${e}/camera`,this._gltf.cameras,t.camera);r.push(this.loadCameraAsync(`/cameras/${l.index}`,l,c=>{c.parent=o}))}if(t.children)for(const l of t.children){const c=xe.Get(`${e}/children/${l}`,this._gltf.nodes,l);r.push(this.loadNodeAsync(`/nodes/${c.index}`,c,u=>{u.parent=o}))}i(o)};if(t.mesh==null||t.skin!=null){const o=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const l=new Me(o,this._babylonScene);l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t.mesh==null?t._babylonTransformNode=l:t._babylonTransformNodeForSkin=l,a(l)}if(t.mesh!=null)if(t.skin==null){const o=xe.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync(`/meshes/${o.index}`,t,o,a))}else{const o=xe.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync(`/meshes/${o.index}`,t,o,l=>{const c=t._babylonTransformNodeForSkin;l.metadata=UE(c.metadata,l.metadata||{});const u=xe.Get(`${e}/skin`,this._gltf.skins,t.skin);r.push(this._loadSkinAsync(`/skins/${u.index}`,t,u,h=>{this._forEachPrimitive(t,d=>{d.skeleton=h}),this._postSceneLoadActions.push(()=>{if(u.skeleton!=null){const d=xe.Get(`/skins/${u.index}/skeleton`,this._gltf.nodes,u.skeleton).parent;t.index===d.index?l.parent=c.parent:l.parent=d._babylonTransformNode}else l.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:c,skinnedNode:l})})}))}))}return this.logClose(),Promise.all(r).then(()=>(this._forEachPrimitive(t,o=>{o.geometry&&o.geometry.useBoundingInfoFromGeometry?o._updateBoundingInfo():o.refreshBoundingInfo(!0)}),t._babylonTransformNode))}_loadMeshAsync(e,t,i,n){const r=i.primitives;if(!r||!r.length)throw new Error(`${e}: Primitives are missing`);r[0].index==null&&xe.Assign(r);const a=new Array;this.logOpen(`${e} ${i.name||""}`);const o=t.name||`node${t.index}`;if(r.length===1){const l=i.primitives[0];a.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,o,t,i,l,c=>{t._babylonTransformNode=c,t._primitiveBabylonMeshes=[c]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new Me(o,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(const l of r)a.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,`${o}_primitive${l.index}`,t,i,l,c=>{c.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(c)}))}return n(t._babylonTransformNode),this.logClose(),Promise.all(a).then(()=>t._babylonTransformNode)}_loadMeshPrimitiveAsync(e,t,i,n,r,a){const o=this._extensionsLoadMeshPrimitiveAsync(e,t,i,n,r,a);if(o)return o;this.logOpen(`${e}`);const l=this._disableInstancedMesh===0&&this._parent.createInstances&&i.skin==null&&!n.primitives[0].targets;let c,u;if(l&&r._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,c=r._instanceData.babylonSourceMesh.createInstance(t),c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,u=r._instanceData.promise;else{const h=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const d=new he(t,this._babylonScene);d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,d.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?z.CounterClockWiseSideOrientation:z.ClockWiseSideOrientation,this._createMorphTargets(e,i,n,r,d),h.push(this._loadVertexDataAsync(e,r,d).then(p=>this._loadMorphTargetsAsync(e,r,d,p).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,p.applyToMesh(d),p._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})));const f=ce._GetDrawMode(e,r.mode);if(r.material==null){let p=this._defaultBabylonMaterialData[f];p||(p=this._createDefaultMaterial("__GLTFLoader._default",f),this._parent.onMaterialLoadedObservable.notifyObservers(p),this._defaultBabylonMaterialData[f]=p),d.material=p}else if(!this.parent.skipMaterials){const p=xe.Get(`${e}/material`,this._gltf.materials,r.material);h.push(this._loadMaterialAsync(`/materials/${p.index}`,p,d,f,m=>{d.material=m}))}u=Promise.all(h),l&&(r._instanceData={babylonSourceMesh:d,promise:u}),c=d}return ce.AddPointerMetadata(c,e),this._parent.onMeshLoadedObservable.notifyObservers(c),a(c),this.logClose(),u.then(()=>c)}_loadVertexDataAsync(e,t,i){const n=this._extensionsLoadVertexDataAsync(e,t,i);if(n)return n;const r=t.attributes;if(!r)throw new Error(`${e}: Attributes are missing`);const a=new Array,o=new Ki(i.name,this._babylonScene);if(t.indices==null)i.isUnIndexed=!0;else{const c=xe.Get(`${e}/indices`,this._gltf.accessors,t.indices);a.push(this._loadIndicesAccessorAsync(`/accessors/${c.index}`,c).then(u=>{o.setIndices(u)}))}const l=(c,u,h)=>{if(r[c]==null)return;i._delayInfo=i._delayInfo||[],i._delayInfo.indexOf(u)===-1&&i._delayInfo.push(u);const d=xe.Get(`${e}/attributes/${c}`,this._gltf.accessors,r[c]);a.push(this._loadVertexAccessorAsync(`/accessors/${d.index}`,d,u).then(f=>{if(f.getKind()===C.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!i.skeleton&&d.min&&d.max){const p=w.Vector3[0].copyFromFloats(...d.min),m=w.Vector3[1].copyFromFloats(...d.max);if(d.normalized&&d.componentType!==5126){let _=1;switch(d.componentType){case 5120:_=127;break;case 5121:_=255;break;case 5122:_=32767;break;case 5123:_=65535;break}const E=1/_;p.scaleInPlace(E),m.scaleInPlace(E)}o._boundingInfo=new Pn(p,m),o.useBoundingInfoFromGeometry=!0}o.setVerticesBuffer(f,d.count)})),u==C.MatricesIndicesExtraKind&&(i.numBoneInfluencers=8),h&&h(d)};return l("POSITION",C.PositionKind),l("NORMAL",C.NormalKind),l("TANGENT",C.TangentKind),l("TEXCOORD_0",C.UVKind),l("TEXCOORD_1",C.UV2Kind),l("TEXCOORD_2",C.UV3Kind),l("TEXCOORD_3",C.UV4Kind),l("TEXCOORD_4",C.UV5Kind),l("TEXCOORD_5",C.UV6Kind),l("JOINTS_0",C.MatricesIndicesKind),l("WEIGHTS_0",C.MatricesWeightsKind),l("JOINTS_1",C.MatricesIndicesExtraKind),l("WEIGHTS_1",C.MatricesWeightsExtraKind),l("COLOR_0",C.ColorKind,c=>{c.type==="VEC4"&&(i.hasVertexAlpha=!0)}),Promise.all(a).then(()=>o)}_createMorphTargets(e,t,i,n,r){if(!n.targets)return;if(t._numMorphTargets==null)t._numMorphTargets=n.targets.length;else if(n.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const a=i.extras?i.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,r.morphTargetManager=new Ir(this._babylonScene),r.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r.morphTargetManager.areUpdatesFrozen=!0;for(let o=0;o<n.targets.length;o++){const l=t.weights?t.weights[o]:i.weights?i.weights[o]:0,c=a?a[o]:`morphTarget${o}`;r.morphTargetManager.addTarget(new ua(c,l,r.getScene()))}}_loadMorphTargetsAsync(e,t,i,n){if(!t.targets)return Promise.resolve();const r=new Array,a=i.morphTargetManager;for(let o=0;o<a.numTargets;o++){const l=a.getTarget(o);r.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${o}`,n,t.targets[o],l))}return Promise.all(r).then(()=>{a.areUpdatesFrozen=!1})}_loadMorphTargetVertexDataAsync(e,t,i,n){const r=new Array,a=(o,l,c)=>{if(i[o]==null)return;const u=t.getVertexBuffer(l);if(!u)return;const h=xe.Get(`${e}/${o}`,this._gltf.accessors,i[o]);r.push(this._loadFloatAccessorAsync(`/accessors/${h.index}`,h).then(d=>{c(u,d)}))};return a("POSITION",C.PositionKind,(o,l)=>{const c=new Float32Array(l.length);o.forEach(l.length,(u,h)=>{c[h]=l[h]+u}),n.setPositions(c)}),a("NORMAL",C.NormalKind,(o,l)=>{const c=new Float32Array(l.length);o.forEach(c.length,(u,h)=>{c[h]=l[h]+u}),n.setNormals(c)}),a("TANGENT",C.TangentKind,(o,l)=>{const c=new Float32Array(l.length/3*4);let u=0;o.forEach(l.length/3*4,(h,d)=>{(d+1)%4!==0&&(c[u]=l[u]+h,u++)}),n.setTangents(c)}),Promise.all(r).then(()=>{})}static _LoadTransform(e,t){if(e.skin!=null)return;let i=g.Zero(),n=ee.Identity(),r=g.One();e.matrix?D.FromArray(e.matrix).decompose(r,n,i):(e.translation&&(i=g.FromArray(e.translation)),e.rotation&&(n=ee.FromArray(e.rotation)),e.scale&&(r=g.FromArray(e.scale))),t.position=i,t.rotationQuaternion=n,t.scaling=r}_loadSkinAsync(e,t,i,n){const r=this._extensionsLoadSkinAsync(e,t,i);if(r)return r;if(i._data)return n(i._data.babylonSkeleton),i._data.promise;const a=`skeleton${i.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const o=new Cu(i.name||a,a,this._babylonScene);o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,i,o);const l=this._loadSkinInverseBindMatricesDataAsync(e,i).then(c=>{this._updateBoneMatrices(o,c)});return i._data={babylonSkeleton:o,promise:l},n(o),l}_loadBones(e,t,i){if(t.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){const r=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(r)if(t.skeleton===void 0)t.skeleton=r.index;else{const a=(l,c)=>{for(;c.parent;c=c.parent)if(c.parent===l)return!0;return!1},o=xe.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);o!==r&&!a(o,r)&&(U.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=r.index)}else U.Warn(`${e}: Failed to find common root`)}const n={};for(const r of t.joints){const a=xe.Get(`${e}/joints/${r}`,this._gltf.nodes,r);this._loadBone(a,t,i,n)}}_findSkeletonRootNode(e,t){if(t.length===0)return null;const i={};for(const r of t){const a=new Array;let o=xe.Get(`${e}/${r}`,this._gltf.nodes,r);for(;o.index!==-1;)a.unshift(o),o=o.parent;i[r]=a}let n=null;for(let r=0;;++r){let a=i[t[0]];if(r>=a.length)return n;const o=a[r];for(let l=1;l<t.length;++l)if(a=i[t[l]],r>=a.length||o!==a[r])return n;n=o}}_loadBone(e,t,i,n){let r=n[e.index];if(r)return r;let a=null;e.index!==t.skeleton&&(e.parent&&e.parent.index!==-1?a=this._loadBone(e.parent,t,i,n):t.skeleton!==void 0&&U.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const o=t.joints.indexOf(e.index);return r=new Tt(e.name||`joint${e.index}`,i,a,this._getNodeMatrix(e),null,null,o),n[e.index]=r,this._postSceneLoadActions.push(()=>{r.linkTransformNode(e._babylonTransformNode)}),r}_loadSkinInverseBindMatricesDataAsync(e,t){if(t.inverseBindMatrices==null)return Promise.resolve(null);const i=xe.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${i.index}`,i)}_updateBoneMatrices(e,t){for(const i of e.bones){const n=D.Identity(),r=i._index;t&&r!==-1&&(D.FromArrayToRef(t,r*16,n),n.invertToRef(n));const a=i.getParent();a&&n.multiplyToRef(a.getAbsoluteInverseBindMatrix(),n),i.updateMatrix(n,!1,!1),i._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(e){return e.matrix?D.FromArray(e.matrix):D.Compose(e.scale?g.FromArray(e.scale):g.One(),e.rotation?ee.FromArray(e.rotation):ee.Identity(),e.translation?g.FromArray(e.translation):g.Zero())}loadCameraAsync(e,t,i=()=>{}){const n=this._extensionsLoadCameraAsync(e,t,i);if(n)return n;const r=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new $l(t.name||`camera${t.index}`,g.Zero(),this._babylonScene,!1);switch(a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.ignoreParentScaling=!0,t._babylonCamera=a,a.rotation=new g(0,Math.PI,0),t.type){case"perspective":{const o=t.perspective;if(!o)throw new Error(`${e}: Camera perspective properties are missing`);a.fov=o.yfov,a.minZ=o.znear,a.maxZ=o.zfar||0;break}case"orthographic":{if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);a.mode=Ee.ORTHOGRAPHIC_CAMERA,a.orthoLeft=-t.orthographic.xmag,a.orthoRight=t.orthographic.xmag,a.orthoBottom=-t.orthographic.ymag,a.orthoTop=t.orthographic.ymag,a.minZ=t.orthographic.znear,a.maxZ=t.orthographic.zfar;break}default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return ce.AddPointerMetadata(a,e),this._parent.onCameraLoadedObservable.notifyObservers(a),i(a),this.logClose(),Promise.all(r).then(()=>a)}_loadAnimationsAsync(){const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let i=0;i<e.length;i++){const n=e[i];t.push(this.loadAnimationAsync(`/animations/${n.index}`,n).then(r=>{r.targetedAnimations.length===0&&r.dispose()}))}return Promise.all(t).then(()=>{})}loadAnimationAsync(e,t){const i=this._extensionsLoadAnimationAsync(e,t);if(i)return i;this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new ao(t.name||`animation${t.index}`,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=n;const r=new Array;xe.Assign(t.channels),xe.Assign(t.samplers);for(const a of t.channels)r.push(this._loadAnimationChannelAsync(`${e}/channels/${a.index}`,e,t,a,(o,l)=>{o.animations=o.animations||[],o.animations.push(l),n.addTargetedAnimation(l,o)}));return Promise.all(r).then(()=>(n.normalize(0),n))}_loadAnimationChannelAsync(e,t,i,n,r){const a=this._extensionsLoadAnimationChannelAsync(e,t,i,n,r);if(a)return a;if(n.target.node==null)return Promise.resolve();const o=xe.Get(`${e}/target/node`,this._gltf.nodes,n.target.node);if(n.target.path==="weights"&&!o._numMorphTargets||n.target.path!=="weights"&&!o._babylonTransformNode)return Promise.resolve();let l;switch(n.target.path){case"translation":{l=$o.translation;break}case"rotation":{l=$o.rotation;break}case"scale":{l=$o.scale;break}case"weights":{l=$o.weights;break}default:throw new Error(`${e}/target/path: Invalid value (${n.target.path})`)}const c={target:o,properties:l};return this._loadAnimationChannelFromTargetInfoAsync(e,t,i,n,c,r)}_loadAnimationChannelFromTargetInfoAsync(e,t,i,n,r,a){const o=this.parent.targetFps,l=1/o,c=xe.Get(`${e}/sampler`,i.samplers,n.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${n.sampler}`,c).then(u=>{let h=0;for(const d of r.properties){const f=d.getStride(r.target),p=u.input,m=u.output,_=new Array(p.length);let E=0;switch(u.interpolation){case"STEP":{for(let v=0;v<p.length;v++){const y=d.getValue(r.target,m,E,1);E+=f,_[v]={frame:p[v]*o,value:y,interpolation:Su.STEP}}break}case"CUBICSPLINE":{for(let v=0;v<p.length;v++){const y=d.getValue(r.target,m,E,l);E+=f;const A=d.getValue(r.target,m,E,1);E+=f;const I=d.getValue(r.target,m,E,l);E+=f,_[v]={frame:p[v]*o,inTangent:y,value:A,outTangent:I}}break}case"LINEAR":{for(let v=0;v<p.length;v++){const y=d.getValue(r.target,m,E,1);E+=f,_[v]={frame:p[v]*o,value:y}}break}}if(E>0){const v=`${i.name||`animation${i.index}`}_channel${n.index}_${h}`;d.buildAnimations(r.target,v,o,_,(y,A)=>{++h,a(y,A)})}}})}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const i=t.interpolation||"LINEAR";switch(i){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const n=xe.Get(`${e}/input`,this._gltf.accessors,t.input),r=xe.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${n.index}`,n),this._loadFloatAccessorAsync(`/accessors/${r.index}`,r)]).then(([a,o])=>({input:a,interpolation:i,output:o})),t._data}loadBufferAsync(e,t,i,n){const r=this._extensionsLoadBufferAsync(e,t,i,n);if(r)return r;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then(a=>{try{return new Uint8Array(a.buffer,a.byteOffset+i,n)}catch(o){throw new Error(`${e}: ${o.message}`)}})}loadBufferViewAsync(e,t){const i=this._extensionsLoadBufferViewAsync(e,t);if(i)return i;if(t._data)return t._data;const n=xe.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${n.index}`,n,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,i){if(t._data)return t._data;const n=ce._GetNumComponents(e,t.type),r=n*C.GetTypeByteLength(t.componentType),a=n*t.count;if(t.bufferView==null)t._data=Promise.resolve(new i(a));else{const o=xe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${o.index}`,o).then(l=>{if(t.componentType===5126&&!t.normalized&&(!o.byteStride||o.byteStride===r))return ce._GetTypedArray(e,t.componentType,l,t.byteOffset,a);{const c=new i(a);return C.ForEach(l,t.byteOffset||0,o.byteStride||r,n,t.componentType,c.length,t.normalized||!1,(u,h)=>{c[h]=u}),c}})}if(t.sparse){const o=t.sparse;t._data=t._data.then(l=>{const c=l,u=xe.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,o.indices.bufferView),h=xe.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,o.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${u.index}`,u),this.loadBufferViewAsync(`/bufferViews/${h.index}`,h)]).then(([d,f])=>{const p=ce._GetTypedArray(`${e}/sparse/indices`,o.indices.componentType,d,o.indices.byteOffset,o.count),m=n*o.count;let _;if(t.componentType===5126&&!t.normalized)_=ce._GetTypedArray(`${e}/sparse/values`,t.componentType,f,o.values.byteOffset,m);else{const v=ce._GetTypedArray(`${e}/sparse/values`,t.componentType,f,o.values.byteOffset,m);_=new i(m),C.ForEach(v,0,r,n,t.componentType,_.length,t.normalized||!1,(y,A)=>{_[A]=y})}let E=0;for(let v=0;v<p.length;v++){let y=p[v]*n;for(let A=0;A<n;A++)c[y++]=_[E++]}return c})})}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if(t.type!=="SCALAR")throw new Error(`${e}/type: Invalid value ${t.type}`);if(t.componentType!==5121&&t.componentType!==5123&&t.componentType!==5125)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const i=ce._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,i)}else{const i=xe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${i.index}`,i).then(n=>ce._GetTypedArray(e,t.componentType,n,t.byteOffset,t.count))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then(i=>new zr(t,i,!1)),e._babylonBuffer}_loadVertexAccessorAsync(e,t,i){var n;if(!((n=t._babylonVertexBuffer)===null||n===void 0)&&n[i])return t._babylonVertexBuffer[i];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const r=this._babylonScene.getEngine();if(t.sparse)t._babylonVertexBuffer[i]=this._loadFloatAccessorAsync(e,t).then(a=>new C(r,a,i,!1));else if(i===C.MatricesIndicesKind||i===C.MatricesIndicesExtraKind)t._babylonVertexBuffer[i]=this._loadFloatAccessorAsync(e,t).then(a=>new C(r,a,i,!1));else{const a=xe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[i]=this._loadVertexBufferViewAsync(a).then(o=>{const l=ce._GetNumComponents(e,t.type);return new C(r,o,i,!1,!1,a.byteStride,!1,t.byteOffset,l,t.componentType,t.normalized,!0,1,!0)})}return t._babylonVertexBuffer[i]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,i){if(!(i instanceof oe))throw new Error(`${e}: Material type not supported`);const n=new Array;return t&&(t.baseColorFactor?(i.albedoColor=G.FromArray(t.baseColorFactor),i.alpha=t.baseColorFactor[3]):i.albedoColor=G.White(),i.metallic=t.metallicFactor==null?1:t.metallicFactor,i.roughness=t.roughnessFactor==null?1:t.roughnessFactor,t.baseColorTexture&&n.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,r=>{r.name=`${i.name} (Base Color)`,i.albedoTexture=r})),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,r=>{r.name=`${i.name} (Metallic Roughness)`,i.metallicTexture=r})),i.useMetallnessFromMetallicTextureBlue=!0,i.useRoughnessFromMetallicTextureGreen=!0,i.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(n).then(()=>{})}_loadMaterialAsync(e,t,i,n,r=()=>{}){const a=this._extensionsLoadMaterialAsync(e,t,i,n,r);if(a)return a;t._data=t._data||{};let o=t._data[n];if(!o){this.logOpen(`${e} ${t.name||""}`);const l=this.createMaterial(e,t,n);o={babylonMaterial:l,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,l)},t._data[n]=o,ce.AddPointerMetadata(l,e),this._parent.onMaterialLoadedObservable.notifyObservers(l),this.logClose()}return i&&(o.babylonMeshes.push(i),i.onDisposeObservable.addOnce(()=>{const l=o.babylonMeshes.indexOf(i);l!==-1&&o.babylonMeshes.splice(l,1)})),r(o.babylonMaterial),o.promise.then(()=>o.babylonMaterial)}_createDefaultMaterial(e,t){this._babylonScene._blockEntityCollection=!!this._assetContainer;const i=new oe(e,this._babylonScene);return i._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i.fillMode=t,i.enableSpecularAntiAliasing=!0,i.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,i.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,i.transparencyMode=oe.PBRMATERIAL_OPAQUE,i.metallic=1,i.roughness=1,i}createMaterial(e,t,i){const n=this._extensionsCreateMaterial(e,t,i);if(n)return n;const r=t.name||`material${t.index}`;return this._createDefaultMaterial(r,i)}loadMaterialPropertiesAsync(e,t,i){const n=this._extensionsLoadMaterialPropertiesAsync(e,t,i);if(n)return n;const r=new Array;return r.push(this.loadMaterialBasePropertiesAsync(e,t,i)),t.pbrMetallicRoughness&&r.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,i)),this.loadMaterialAlphaProperties(e,t,i),Promise.all(r).then(()=>{})}loadMaterialBasePropertiesAsync(e,t,i){if(!(i instanceof oe))throw new Error(`${e}: Material type not supported`);const n=new Array;return i.emissiveColor=t.emissiveFactor?G.FromArray(t.emissiveFactor):new G(0,0,0),t.doubleSided&&(i.backFaceCulling=!1,i.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,r=>{r.name=`${i.name} (Normal)`,i.bumpTexture=r})),i.invertNormalMapX=!this._babylonScene.useRightHandedSystem,i.invertNormalMapY=this._babylonScene.useRightHandedSystem,t.normalTexture.scale!=null&&i.bumpTexture&&(i.bumpTexture.level=t.normalTexture.scale),i.forceIrradianceInFragment=!0),t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,r=>{r.name=`${i.name} (Occlusion)`,i.ambientTexture=r})),i.useAmbientInGrayScale=!0,t.occlusionTexture.strength!=null&&(i.ambientTextureStrength=t.occlusionTexture.strength)),t.emissiveTexture&&n.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,r=>{r.name=`${i.name} (Emissive)`,i.emissiveTexture=r})),Promise.all(n).then(()=>{})}loadMaterialAlphaProperties(e,t,i){if(!(i instanceof oe))throw new Error(`${e}: Material type not supported`);switch(t.alphaMode||"OPAQUE"){case"OPAQUE":{i.transparencyMode=oe.PBRMATERIAL_OPAQUE;break}case"MASK":{i.transparencyMode=oe.PBRMATERIAL_ALPHATEST,i.alphaCutOff=t.alphaCutoff==null?.5:t.alphaCutoff,i.albedoTexture&&(i.albedoTexture.hasAlpha=!0);break}case"BLEND":{i.transparencyMode=oe.PBRMATERIAL_ALPHABLEND,i.albedoTexture&&(i.albedoTexture.hasAlpha=!0,i.useAlphaFromAlbedoTexture=!0);break}default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,i=()=>{}){const n=this._extensionsLoadTextureInfoAsync(e,t,i);if(n)return n;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const r=xe.Get(`${e}/index`,this._gltf.textures,t.index);r._textureInfo=t;const a=this._loadTextureAsync(`/textures/${t.index}`,r,o=>{o.coordinatesIndex=t.texCoord||0,ce.AddPointerMetadata(o,e),this._parent.onTextureLoadedObservable.notifyObservers(o),i(o)});return this.logClose(),a}_loadTextureAsync(e,t,i=()=>{}){const n=this._extensionsLoadTextureAsync(e,t,i);if(n)return n;this.logOpen(`${e} ${t.name||""}`);const r=t.sampler==null?ce.DefaultSampler:xe.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),a=xe.Get(`${e}/source`,this._gltf.images,t.source),o=this._createTextureAsync(e,r,a,i,void 0,!t._textureInfo.nonColorData);return this.logClose(),o}_createTextureAsync(e,t,i,n=()=>{},r,a){const o=this._loadSampler(`/samplers/${t.index}`,t),l=new Array,c=new jo;this._babylonScene._blockEntityCollection=!!this._assetContainer;const u={noMipmap:o.noMipMaps,invertY:!1,samplingMode:o.samplingMode,onLoad:()=>{this._disposed||c.resolve()},onError:(d,f)=>{this._disposed||c.reject(new Error(`${e}: ${f&&f.message?f.message:d||"Failed to load texture"}`))},mimeType:i.mimeType,loaderOptions:r,useSRGBBuffer:!!a&&this._parent.useSRGBBuffers},h=new H(null,this._babylonScene,u);return h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.push(c.promise),l.push(this.loadImageAsync(`/images/${i.index}`,i).then(d=>{const f=i.uri||`${this._fileName}#image${i.index}`,p=`data:${this._uniqueRootUrl}${f}`;h.updateURL(p,d)})),h.wrapU=o.wrapU,h.wrapV=o.wrapV,n(h),Promise.all(l).then(()=>h)}_loadSampler(e,t){return t._data||(t._data={noMipMaps:t.minFilter===9728||t.minFilter===9729,samplingMode:ce._GetTextureSamplingMode(e,t),wrapU:ce._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:ce._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{const i=xe.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${i.index}`,i)}this.logClose()}return t._data}loadUriAsync(e,t,i){const n=this._extensionsLoadUriAsync(e,t,i);if(n)return n;if(!ce._ValidateUri(i))throw new Error(`${e}: '${i}' is invalid`);if(ju(i)){const r=new Uint8Array(ql(i));return this.log(`${e}: Decoded ${i.substr(0,64)}... (${r.length} bytes)`),Promise.resolve(r)}return this.log(`${e}: Loading ${i}`),this._parent.preprocessUrlAsync(this._rootUrl+i).then(r=>new Promise((a,o)=>{this._parent._loadFile(this._babylonScene,r,l=>{this._disposed||(this.log(`${e}: Loaded ${i} (${l.byteLength} bytes)`),a(new Uint8Array(l)))},!0,l=>{o(new wl(`${e}: Failed to load '${i}'${l?": "+l.status+" "+l.statusText:""}`,l))})}))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};const i=e._internalMetadata=e._internalMetadata||{},n=i.gltf=i.gltf||{};(n.pointers=n.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=t==null?10497:t,t){case 33071:return H.CLAMP_ADDRESSMODE;case 33648:return H.MIRROR_ADDRESSMODE;case 10497:return H.WRAP_ADDRESSMODE;default:return U.Warn(`${e}: Invalid value (${t})`),H.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const i=t.magFilter==null?9729:t.magFilter,n=t.minFilter==null?9987:t.minFilter;if(i===9729)switch(n){case 9728:return H.LINEAR_NEAREST;case 9729:return H.LINEAR_LINEAR;case 9984:return H.LINEAR_NEAREST_MIPNEAREST;case 9985:return H.LINEAR_LINEAR_MIPNEAREST;case 9986:return H.LINEAR_NEAREST_MIPLINEAR;case 9987:return H.LINEAR_LINEAR_MIPLINEAR;default:return U.Warn(`${e}/minFilter: Invalid value (${n})`),H.LINEAR_LINEAR_MIPLINEAR}else switch(i!==9728&&U.Warn(`${e}/magFilter: Invalid value (${i})`),n){case 9728:return H.NEAREST_NEAREST;case 9729:return H.NEAREST_LINEAR;case 9984:return H.NEAREST_NEAREST_MIPNEAREST;case 9985:return H.NEAREST_LINEAR_MIPNEAREST;case 9986:return H.NEAREST_NEAREST_MIPLINEAR;case 9987:return H.NEAREST_LINEAR_MIPLINEAR;default:return U.Warn(`${e}/minFilter: Invalid value (${n})`),H.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`${e}: Invalid component type ${t}`)}}static _GetTypedArray(e,t,i,n,r){const a=i.buffer;n=i.byteOffset+(n||0);const o=ce._GetTypedArrayConstructor(`${e}/componentType`,t),l=C.GetTypeByteLength(t);return n%l!==0?(U.Warn(`${e}: Copying buffer as byte offset (${n}) is not a multiple of component type byte length (${l})`),new o(a.slice(n,n+r*l),0)):new o(a,n,r)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return q.IsBase64(e)||e.indexOf("..")===-1}static _GetDrawMode(e,t){switch(t==null&&(t=4),t){case 0:return z.PointListDrawMode;case 1:return z.LineListDrawMode;case 2:return z.LineLoopDrawMode;case 3:return z.LineStripDrawMode;case 4:return z.TriangleFillMode;case 5:return z.TriangleStripDrawMode;case 6:return z.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials){for(const t of this._gltf.materials)if(t._data)for(const i in t._data){const n=t._data[i];for(const r of n.babylonMeshes){r.computeWorldMatrix(!0);const a=n.babylonMaterial;e.push(a.forceCompilationAsync(r)),e.push(a.forceCompilationAsync(r,{useInstances:!0})),this._parent.useClipPlane&&(e.push(a.forceCompilationAsync(r,{clipPlane:!0})),e.push(a.forceCompilationAsync(r,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const i of t){const n=i.getShadowGenerator();n&&e.push(n.forceCompilationAsync())}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,i){for(const n of this._extensions)if(n.enabled){const r=`${n.name}.${t}`,a=e;a._activeLoaderExtensionFunctions=a._activeLoaderExtensionFunctions||{};const o=a._activeLoaderExtensionFunctions;if(!o[r]){o[r]=!0;try{const l=i(n);if(l)return l}finally{delete o[r]}}}return null}_extensionsOnLoading(){this._forEachExtensions(e=>e.onLoading&&e.onLoading())}_extensionsOnReady(){this._forEachExtensions(e=>e.onReady&&e.onReady())}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",i=>i.loadSceneAsync&&i.loadSceneAsync(e,t))}_extensionsLoadNodeAsync(e,t,i){return this._applyExtensions(t,"loadNode",n=>n.loadNodeAsync&&n.loadNodeAsync(e,t,i))}_extensionsLoadCameraAsync(e,t,i){return this._applyExtensions(t,"loadCamera",n=>n.loadCameraAsync&&n.loadCameraAsync(e,t,i))}_extensionsLoadVertexDataAsync(e,t,i){return this._applyExtensions(t,"loadVertexData",n=>n._loadVertexDataAsync&&n._loadVertexDataAsync(e,t,i))}_extensionsLoadMeshPrimitiveAsync(e,t,i,n,r,a){return this._applyExtensions(r,"loadMeshPrimitive",o=>o._loadMeshPrimitiveAsync&&o._loadMeshPrimitiveAsync(e,t,i,n,r,a))}_extensionsLoadMaterialAsync(e,t,i,n,r){return this._applyExtensions(t,"loadMaterial",a=>a._loadMaterialAsync&&a._loadMaterialAsync(e,t,i,n,r))}_extensionsCreateMaterial(e,t,i){return this._applyExtensions(t,"createMaterial",n=>n.createMaterial&&n.createMaterial(e,t,i))}_extensionsLoadMaterialPropertiesAsync(e,t,i){return this._applyExtensions(t,"loadMaterialProperties",n=>n.loadMaterialPropertiesAsync&&n.loadMaterialPropertiesAsync(e,t,i))}_extensionsLoadTextureInfoAsync(e,t,i){return this._applyExtensions(t,"loadTextureInfo",n=>n.loadTextureInfoAsync&&n.loadTextureInfoAsync(e,t,i))}_extensionsLoadTextureAsync(e,t,i){return this._applyExtensions(t,"loadTexture",n=>n._loadTextureAsync&&n._loadTextureAsync(e,t,i))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",i=>i.loadAnimationAsync&&i.loadAnimationAsync(e,t))}_extensionsLoadAnimationChannelAsync(e,t,i,n,r){return this._applyExtensions(i,"loadAnimationChannel",a=>a._loadAnimationChannelAsync&&a._loadAnimationChannelAsync(e,t,i,n,r))}_extensionsLoadSkinAsync(e,t,i){return this._applyExtensions(i,"loadSkin",n=>n._loadSkinAsync&&n._loadSkinAsync(e,t,i))}_extensionsLoadUriAsync(e,t,i){return this._applyExtensions(t,"loadUri",n=>n._loadUriAsync&&n._loadUriAsync(e,t,i))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",i=>i.loadBufferViewAsync&&i.loadBufferViewAsync(e,t))}_extensionsLoadBufferAsync(e,t,i,n){return this._applyExtensions(t,"loadBuffer",r=>r.loadBufferAsync&&r.loadBufferAsync(e,t,i,n))}static LoadExtensionAsync(e,t,i,n){if(!t.extensions)return null;const a=t.extensions[i];return a?n(`${e}/extensions/${i}`,a):null}static LoadExtraAsync(e,t,i,n){if(!t.extras)return null;const a=t.extras[i];return a?n(`${e}/extras/${i}`,a):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(e)!==-1}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}ce._RegisteredExtensions={};ce.DefaultSampler={index:-1};ci._CreateGLTF2Loader=s=>new ce(s);const Tb="rgbdEncodePixelShader",Sb=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);}`;Q.ShadersStore[Tb]=Sb;const Cb="image/png";function J_(s,e,t,i,n,r,a,o,l,c,u){return new Promise((h,d)=>{if(t){const f=e.createTexture(null,!0,!0,null,1,null,p=>{d(p)},s);i.getEffect().executeWhenCompiled(()=>{i.externalTextureSamplerBinding=!0,i.onApply=p=>{p._bindTexture("textureSampler",f),p.setFloat2("scale",1,e._features.needsInvertingBitmap&&s instanceof ImageBitmap?-1:1)},e.scenes.length&&(e.scenes[0].postProcessManager.directRender([i],c,!0,r,a),e.restoreDefaultFramebuffer(),f.dispose(),URL.revokeObjectURL(n),h())})}else{if(e._uploadImageToTexture(u,s,r,a),o){const f=l[a];f&&e._uploadImageToTexture(f._texture,s,r,0)}h()}})}function eg(s,e,t=Cb){if(!q.IsExponentOfTwo(s.width))throw new Error("Texture size must be a power of two");const i=W.ILog2(s.width)+1,n=s.getEngine();let r=!1,a=!1,o=null,l=null,c=null;const u=n.getCaps();if(s.format=5,s.type=0,s.generateMipMaps=!0,s._cachedAnisotropicFilteringLevel=null,n.updateTextureSamplingMode(3,s),u.textureLOD?n._features.supportRenderAndCopyToLodForFloatTextures?u.textureHalfFloatRender&&u.textureHalfFloatLinearFiltering?(r=!0,s.type=2):u.textureFloatRender&&u.textureFloatLinearFiltering&&(r=!0,s.type=1):r=!1:(r=!1,a=!0,c={}),r)o=new Dt("rgbdDecode","rgbdDecode",null,null,1,null,3,n,!1,void 0,s.type,void 0,null,!1),s._isRGBD=!1,s.invertY=!1,l=n.createRenderTargetCubeTexture(s.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:s.type,format:5});else if(s._isRGBD=!0,s.invertY=!0,a){const f=s._lodGenerationScale,p=s._lodGenerationOffset;for(let m=0;m<3;m++){const E=1-m/2,v=p,y=(i-1)*f+p,A=v+(y-v)*E,I=Math.round(Math.min(Math.max(A,0),y)),T=new dn(n,Pt.Temp);T.isCube=!0,T.invertY=!0,T.generateMipMaps=!1,n.updateTextureSamplingMode(2,T);const R=new _t(null);switch(R._isCube=!0,R._texture=T,c[I]=R,m){case 0:s._lodTextureLow=R;break;case 1:s._lodTextureMid=R;break;case 2:s._lodTextureHigh=R;break}}}const h=[];for(let d=0;d<e.length;d++)for(let f=0;f<6;f++){const p=e[d][f],m=new Blob([p],{type:t}),_=URL.createObjectURL(m);let E;if(typeof Image=="undefined"||n._features.forceBitmapOverHTMLImageElement)E=n.createImageBitmap(m,{premultiplyAlpha:"none"}).then(v=>J_(v,n,r,o,_,f,d,a,c,l,s));else{const v=new Image;v.src=_,E=new Promise((y,A)=>{v.onload=()=>{J_(v,n,r,o,_,f,d,a,c,l,s).then(()=>y()).catch(I=>{A(I)})},v.onerror=I=>{A(I)}})}h.push(E)}if(e.length<i){let d;const f=Math.pow(2,i-1-e.length),p=f*f*4;switch(s.type){case 0:{d=new Uint8Array(p);break}case 2:{d=new Uint16Array(p);break}case 1:{d=new Float32Array(p);break}}for(let m=e.length;m<i;m++)for(let _=0;_<6;_++)n._uploadArrayBufferViewToTexture(s,d,_,m)}return Promise.all(h).then(()=>{l&&(n._releaseTexture(s),l._swapAndDie(s)),o&&o.dispose(),a&&(s._lodTextureHigh&&s._lodTextureHigh._texture&&(s._lodTextureHigh._texture.isReady=!0),s._lodTextureMid&&s._lodTextureMid._texture&&(s._lodTextureMid._texture.isReady=!0),s._lodTextureLow&&s._lodTextureLow._texture&&(s._lodTextureLow._texture.isReady=!0))})}function Ib(s,e,t,i,n){const r=s.getEngine().createRawCubeTexture(null,s.width,s.format,s.type,s.generateMipMaps,s.invertY,s.samplingMode,s._compression),a=eg(r,e).then(()=>s);return s.onRebuildCallback=o=>({proxy:a,isReady:!0,isAsync:!0}),s._source=Pt.CubeRawRGBD,s._bufferViewArrayArray=e,s._lodGenerationScale=i,s._lodGenerationOffset=n,s._sphericalPolynomial=t,eg(s,e).then(()=>(s.isReady=!0,s))}_e.prototype._createDepthStencilCubeTexture=function(s,e,t){const i=new dn(this,Pt.DepthStencil);if(i.isCube=!0,this.webGLVersion===1)return U.Error("Depth cube texture is not supported by WebGL 1."),i;const n=Object.assign({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},e),r=this._gl;this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,i,!0),this._setupDepthStencilTexture(i,s,n.generateStencil,n.bilinearFiltering,n.comparisonFunction),t._depthStencilTexture=i,t._depthStencilTextureWithStencil=n.generateStencil;for(let a=0;a<6;a++)n.generateStencil?r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,r.DEPTH24_STENCIL8,s,s,0,r.DEPTH_STENCIL,r.UNSIGNED_INT_24_8,null):r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,r.DEPTH_COMPONENT24,s,s,0,r.DEPTH_COMPONENT,r.UNSIGNED_INT,null);return this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(i),i};_e.prototype._partialLoadFile=function(s,e,t,i,n=null){const r=o=>{t[e]=o,t._internalCount++,t._internalCount===6&&i(t)},a=(o,l)=>{n&&o&&n(o.status+" "+o.statusText,l)};this._loadFile(s,r,void 0,void 0,!0,a)};_e.prototype._cascadeLoadFiles=function(s,e,t,i=null){const n=[];n._internalCount=0;for(let r=0;r<6;r++)this._partialLoadFile(t[r],r,n,e,i)};_e.prototype._cascadeLoadImgs=function(s,e,t,i,n=null,r){const a=[];a._internalCount=0;for(let o=0;o<6;o++)this._partialLoadImg(i[o],o,a,s,e,t,n,r)};_e.prototype._partialLoadImg=function(s,e,t,i,n,r,a=null,o){const l=$p();Zl(s,h=>{t[e]=h,t._internalCount++,i&&i.removePendingData(l),t._internalCount===6&&r&&r(n,t)},(h,d)=>{i&&i.removePendingData(l),a&&a(h,d)},i?i.offlineProvider:null,o),i&&i.addPendingData(l)};_e.prototype._setCubeMapTextureParams=function(s,e,t){const i=this._gl;i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,e?i.LINEAR_MIPMAP_LINEAR:i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),s.samplingMode=e?3:2,e&&this.getCaps().textureMaxLevel&&t!==void 0&&t>0&&(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_LEVEL,t),s._maxLodLevel=t),this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)};_e.prototype.createCubeTextureBase=function(s,e,t,i,n=null,r=null,a,o=null,l=!1,c=0,u=0,h=null,d=null,f=null,p=!1){const m=h||new dn(this,Pt.Cube);m.isCube=!0,m.url=s,m.generateMipMaps=!i,m._lodGenerationScale=c,m._lodGenerationOffset=u,m._useSRGBBuffer=!!p&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||!!i),m!==h&&(m.label=s.substring(0,60)),this._doNotHandleContextLost||(m._extension=o,m._files=t);const _=s;this._transformTextureUrl&&!h&&(s=this._transformTextureUrl(s));const E=s.split("?")[0],v=E.lastIndexOf("."),y=o||(v>-1?E.substring(v).toLowerCase():"");let A=null;for(const T of _e._TextureLoaders)if(T.canLoad(y)){A=T;break}const I=(T,R)=>{s===_?r&&T&&r(T.status+" "+T.statusText,R):(U.Warn(`Failed to load ${s}, falling back to the ${_}`),this.createCubeTextureBase(_,e,t,!!i,n,r,a,o,l,c,u,m,d,f,p))};if(A){const T=R=>{d&&d(m,R),A.loadCubeData(R,m,l,n,r)};t&&t.length===6?A.supportCascades?this._cascadeLoadFiles(e,R=>T(R.map(x=>new Uint8Array(x))),t,r):r?r("Textures type does not support cascades."):U.Warn("Texture loader does not support cascades."):this._loadFile(s,R=>T(new Uint8Array(R)),void 0,void 0,!0,I)}else{if(!t)throw new Error("Cannot load cubemap because files were not defined");this._cascadeLoadImgs(e,m,(T,R)=>{f&&f(T,R)},t,r)}return this._internalTexturesCache.push(m),m};_e.prototype.createCubeTexture=function(s,e,t,i,n=null,r=null,a,o=null,l=!1,c=0,u=0,h=null,d,f=!1){const p=this._gl;return this.createCubeTextureBase(s,e,t,!!i,n,r,a,o,l,c,u,h,m=>this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,m,!0),(m,_)=>{const E=this.needPOTTextures?_e.GetExponentOfTwo(_[0].width,this._caps.maxCubemapTextureSize):_[0].width,v=E,y=[p.TEXTURE_CUBE_MAP_POSITIVE_X,p.TEXTURE_CUBE_MAP_POSITIVE_Y,p.TEXTURE_CUBE_MAP_POSITIVE_Z,p.TEXTURE_CUBE_MAP_NEGATIVE_X,p.TEXTURE_CUBE_MAP_NEGATIVE_Y,p.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,m,!0),this._unpackFlipY(!1);const A=a?this._getInternalFormat(a,m._useSRGBBuffer):m._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:p.RGBA;let I=a?this._getInternalFormat(a):p.RGBA;m._useSRGBBuffer&&this.webGLVersion===1&&(I=A);for(let T=0;T<y.length;T++)if(_[T].width!==E||_[T].height!==v){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext){U.Warn("Cannot create canvas to resize texture.");return}this._workingCanvas.width=E,this._workingCanvas.height=v,this._workingContext.drawImage(_[T],0,0,_[T].width,_[T].height,0,0,E,v),p.texImage2D(y[T],0,A,I,p.UNSIGNED_BYTE,this._workingCanvas)}else p.texImage2D(y[T],0,A,I,p.UNSIGNED_BYTE,_[T]);i||p.generateMipmap(p.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(m,!i),m.width=E,m.height=v,m.isReady=!0,a&&(m.format=a),m.onLoadedObservable.notifyObservers(m),m.onLoadedObservable.clear(),n&&n()},!!f)};class Li extends _t{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(D.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let n="";return e.forEach(r=>n+=r),new Li(n,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,n=!0){const r=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const a=new Li(e,t,null,!1,null,null,null,void 0,!0,i,n);return t.useDelayedTextureLoading=r,a}constructor(e,t,i=null,n=!1,r=null,a=null,o=null,l=5,c=!1,u=null,h=!1,d=.8,f=0,p,m){var _;super(t),this._lodScale=.8,this._lodOffset=0,this.onLoadObservable=new O,this.boundingBoxPosition=g.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new D,this.name=e,this.url=e,this._noMipmap=n,this.hasAlpha=!1,this._format=l,this.isCube=!0,this._textureMatrix=D.Identity(),this._createPolynomials=h,this.coordinatesMode=H.CUBIC_MODE,this._extensions=i,this._files=r,this._forcedExtension=u,this._loaderOptions=p,this._useSRGBBuffer=m,this._lodScale=d,this._lodOffset=f,!(!e&&!r)&&this.updateURL(e,u,a,c,o,i,(_=this.getScene())===null||_===void 0?void 0:_.useDelayedTextureLoading,r)}getClassName(){return"CubeTexture"}updateURL(e,t,i=null,n=!1,r=null,a=null,o=!1,l=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);const c=e.lastIndexOf("."),u=t||(c>-1?e.substring(c).toLowerCase():""),h=u.indexOf(".dds")===0,d=u.indexOf(".env")===0,f=u.indexOf(".basis")===0;if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=n,n&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(!f&&!d&&!h&&!a&&(a=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,a){for(let p=0;p<a.length;p++)this._files.push(e+a[p]);this._extensions=a}o?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=r):this._loadTexture(i,r)}delayLoad(e){this.delayLoadState===4&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t,i;if(e.updateFlag===this._textureMatrix.updateFlag||(e.isIdentity()!==this._textureMatrix.isIdentity()&&((t=this.getScene())===null||t===void 0||t.markAllMaterialsAsDirty(1,o=>o.getActiveTextures().indexOf(this)!==-1)),this._textureMatrix=e,!(!((i=this.getScene())===null||i===void 0)&&i.useRightHandedSystem)))return;const n=w.Vector3[0],r=w.Quaternion[0],a=w.Vector3[1];this._textureMatrix.decompose(n,r,a),r.z*=-1,r.w*=-1,D.ComposeToRef(n,r,a,this._textureMatrixRefraction)}getRefractionTextureMatrix(){var e;return!((e=this.getScene())===null||e===void 0)&&e.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){var i;const n=this.getScene(),r=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const a=()=>{var l;this.onLoadObservable.notifyObservers(this),r&&(r.dispose(),(l=this.getScene())===null||l===void 0||l.markAllMaterialsAsDirty(1)),e&&e()},o=(l,c)=>{this._loadingError=!0,this._errorObject={message:l,exception:c},t&&t(l,c),H.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?q.SetImmediate(()=>a()):this._texture.onLoadedObservable.add(()=>a()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,n,this._lodScale,this._lodOffset,e,o,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,n,this._files,this._noMipmap,e,o,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer),(i=this._texture)===null||i===void 0||i.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,i){const n=Pe.Parse(()=>{var r;let a=!1;return e.prefiltered&&(a=e.prefiltered),new Li(i+((r=e.url)!==null&&r!==void 0?r:e.name),t,e.extensions,!1,e.files||null,null,null,void 0,a,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(n.boundingBoxPosition=g.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(n.boundingBoxSize=g.FromArray(e.boundingBoxSize)),e.animations)for(let r=0;r<e.animations.length;r++){const a=e.animations[r],o=hn("BABYLON.Animation");o&&n.animations.push(o.Parse(a))}return n}clone(){let e=0;const t=Pe.Clone(()=>{const i=new Li(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=i.uniqueId,i},this);return t.uniqueId=e,t}}S([b()],Li.prototype,"url",void 0);S([gn()],Li.prototype,"boundingBoxPosition",void 0);S([gn()],Li.prototype,"boundingBoxSize",null);S([b("rotationY")],Li.prototype,"rotationY",null);S([b("files")],Li.prototype,"_files",void 0);S([b("forcedExtension")],Li.prototype,"_forcedExtension",void 0);S([b("extensions")],Li.prototype,"_extensions",void 0);S([vE("textureMatrix")],Li.prototype,"_textureMatrix",void 0);S([vE("textureMatrixRefraction")],Li.prototype,"_textureMatrixRefraction",void 0);H._CubeTextureParser=Li.Parse;Rt("BABYLON.CubeTexture",Li);class sm extends Li{constructor(e,t,i,n=5,r=0,a=!1,o=!1,l=3,c=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,i,n,r,a,o,l,c)}update(e,t,i,n,r=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,i,n,r)}updateRGBDAsync(e,t=null,i=.8,n=0){return Ib(this._texture,e,t,i,n).then(()=>{})}clone(){return Pe.Clone(()=>{const e=this.getScene(),t=this._texture,i=new sm(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return t.source===Pt.CubeRawRGBD&&i.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),i},this)}}const af="EXT_lights_image_based";class Rb{constructor(e){this.name=af,this._loader=e,this.enabled=this._loader.isExtensionUsed(af)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return ce.LoadExtensionAsync(e,t,this.name,(i,n)=>{const r=new Array;r.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${i}`);const a=xe.Get(`${i}/light`,this._lights,n.light);return r.push(this._loadLightAsync(`/extensions/${this.name}/lights/${n.light}`,a).then(o=>{this._loader.babylonScene.environmentTexture=o})),this._loader.logClose(),Promise.all(r).then(()=>{})})}_loadLightAsync(e,t){if(!t._loaded){const i=new Array;this._loader.logOpen(`${e}`);const n=new Array(t.specularImages.length);for(let r=0;r<t.specularImages.length;r++){const a=t.specularImages[r];n[r]=new Array(a.length);for(let o=0;o<a.length;o++){const l=`${e}/specularImages/${r}/${o}`;this._loader.logOpen(`${l}`);const c=a[o],u=xe.Get(l,this._loader.gltf.images,c);i.push(this._loader.loadImageAsync(`/images/${c}`,u).then(h=>{n[r][o]=h})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(i).then(()=>{const r=new sm(this._loader.babylonScene,null,t.specularImageSize);if(r.name=t.name||"environment",t._babylonTexture=r,t.intensity!=null&&(r.level=t.intensity),t.rotation){let c=ee.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(c=ee.Inverse(c)),D.FromQuaternionToRef(c,r.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const a=Co.FromArray(t.irradianceCoefficients);a.scaleInPlace(t.intensity),a.convertIrradianceToLambertianRadiance();const o=Nl.FromHarmonics(a),l=(n.length-1)/W.Log2(t.specularImageSize);return r.updateRGBDAsync(n,o,l)})}return t._loaded.then(()=>t._babylonTexture)}}ce.RegisterExtension(af,s=>new Rb(s));he.prototype.thinInstanceAdd=function(s,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return U.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(s)?s.length:1);const t=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(s))for(let i=0;i<s.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,s[i],i===s.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,s,e);return t};he.prototype.thinInstanceAddSelf=function(s=!0){return this.thinInstanceAdd(D.IdentityReadOnly,s)};he.prototype.thinInstanceRegisterAttribute=function(s,e){s===C.ColorKind&&(s=C.ColorInstanceKind),this.removeVerticesData(s),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[s]=e,this._userThinInstanceBuffersStorage.sizes[s]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[s]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[s]),this._userThinInstanceBuffersStorage.vertexBuffers[s]=new C(this.getEngine(),this._userThinInstanceBuffersStorage.data[s],s,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[s])};he.prototype.thinInstanceSetMatrixAt=function(s,e,t=!0){if(!this._thinInstanceDataStorage.matrixData||s>=this._thinInstanceDataStorage.instancesCount)return!1;const i=this._thinInstanceDataStorage.matrixData;return e.copyToArray(i,s*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[s]=e),t&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0};he.prototype.thinInstanceSetAttributeAt=function(s,e,t,i=!0){return s===C.ColorKind&&(s=C.ColorInstanceKind),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[s]||e>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(s,0),this._userThinInstanceBuffersStorage.data[s].set(t,e*this._userThinInstanceBuffersStorage.strides[s]),i&&this.thinInstanceBufferUpdated(s),!0)};Object.defineProperty(he.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(s){var e,t;const i=(e=this._thinInstanceDataStorage.matrixData)!==null&&e!==void 0?e:(t=this.source)===null||t===void 0?void 0:t._thinInstanceDataStorage.matrixData,n=i?i.length/16:0;s<=n&&(this._thinInstanceDataStorage.instancesCount=s)},enumerable:!0,configurable:!0});he.prototype._thinInstanceCreateMatrixBuffer=function(s,e,t=!1){s===C.ColorKind&&(s=C.ColorInstanceKind);const i=new zr(this.getEngine(),e,!t,16,!1,!0);for(let n=0;n<4;n++)this.setVerticesBuffer(i.createVertexBuffer(s+n,n*4,4));return i};he.prototype.thinInstanceSetBuffer=function(s,e,t=0,i=!1){var n,r,a;t=t||16,s==="matrix"?((n=this._thinInstanceDataStorage.matrixBuffer)===null||n===void 0||n.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*t,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,e!==null?(this._thinInstanceDataStorage.instancesCount=e.length/t,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,i),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):s==="previousMatrix"?((r=this._thinInstanceDataStorage.previousMatrixBuffer)===null||r===void 0||r.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,e!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,i))):(s===C.ColorKind&&(s=C.ColorInstanceKind),e===null?!((a=this._userThinInstanceBuffersStorage)===null||a===void 0)&&a.data[s]&&(this.removeVerticesData(s),delete this._userThinInstanceBuffersStorage.data[s],delete this._userThinInstanceBuffersStorage.strides[s],delete this._userThinInstanceBuffersStorage.sizes[s],delete this._userThinInstanceBuffersStorage.vertexBuffers[s]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[s]=e,this._userThinInstanceBuffersStorage.strides[s]=t,this._userThinInstanceBuffersStorage.sizes[s]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[s]=new C(this.getEngine(),e,s,!i,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[s])))};he.prototype.thinInstanceBufferUpdated=function(s){var e,t,i;s==="matrix"?(e=this._thinInstanceDataStorage.matrixBuffer)===null||e===void 0||e.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount):s==="previousMatrix"?(t=this._thinInstanceDataStorage.previousMatrixBuffer)===null||t===void 0||t.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount):(s===C.ColorKind&&(s=C.ColorInstanceKind),!((i=this._userThinInstanceBuffersStorage)===null||i===void 0)&&i.vertexBuffers[s]&&this._userThinInstanceBuffersStorage.vertexBuffers[s].updateDirectly(this._userThinInstanceBuffersStorage.data[s],0))};he.prototype.thinInstancePartialBufferUpdate=function(s,e,t){var i;s==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,t):(s===C.ColorKind&&(s=C.ColorInstanceKind),!((i=this._userThinInstanceBuffersStorage)===null||i===void 0)&&i.vertexBuffers[s]&&this._userThinInstanceBuffersStorage.vertexBuffers[s].updateDirectly(e,t))};he.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];const s=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=new Array;for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=D.FromArray(s,e*16)}return this._thinInstanceDataStorage.worldMatrices};he.prototype.thinInstanceRefreshBoundingInfo=function(s=!1,e=!1,t=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const i=this._thinInstanceDataStorage.boundingVectors;if(s||!this.rawBoundingInfo){i.length=0,this.refreshBoundingInfo(e,t);const a=this.getBoundingInfo();this.rawBoundingInfo=new Pn(a.minimum,a.maximum)}const n=this.getBoundingInfo(),r=this._thinInstanceDataStorage.matrixData;if(i.length===0)for(let a=0;a<n.boundingBox.vectors.length;++a)i.push(n.boundingBox.vectors[a].clone());w.Vector3[0].setAll(Number.POSITIVE_INFINITY),w.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let a=0;a<this._thinInstanceDataStorage.instancesCount;++a){D.FromArrayToRef(r,a*16,w.Matrix[0]);for(let o=0;o<i.length;++o)g.TransformCoordinatesToRef(i[o],w.Matrix[0],w.Vector3[2]),w.Vector3[0].minimizeInPlace(w.Vector3[2]),w.Vector3[1].maximizeInPlace(w.Vector3[2])}n.reConstruct(w.Vector3[0],w.Vector3[1]),this._updateBoundingInfo()};he.prototype._thinInstanceUpdateBufferSize=function(s,e=1){var t,i,n;s===C.ColorKind&&(s=C.ColorInstanceKind);const r=s==="matrix";if(!r&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[s]))return;const a=r?16:this._userThinInstanceBuffersStorage.strides[s],o=r?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[s];let l=r?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[s];const c=(this._thinInstanceDataStorage.instancesCount+e)*a;let u=o;for(;u<c;)u*=2;if(!l||o!=u){if(!l)l=new Float32Array(u);else{const h=new Float32Array(u);h.set(l,0),l=h}r?((t=this._thinInstanceDataStorage.matrixBuffer)===null||t===void 0||t.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",l,!1),this._thinInstanceDataStorage.matrixData=l,this._thinInstanceDataStorage.matrixBufferSize=u,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&((i=this._thinInstanceDataStorage.previousMatrixBuffer)===null||i===void 0||i.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",l,!1))):((n=this._userThinInstanceBuffersStorage.vertexBuffers[s])===null||n===void 0||n.dispose(),this._userThinInstanceBuffersStorage.data[s]=l,this._userThinInstanceBuffersStorage.sizes[s]=u,this._userThinInstanceBuffersStorage.vertexBuffers[s]=new C(this.getEngine(),l,s,!0,!1,a,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[s]))}};he.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})};he.prototype._disposeThinInstanceSpecificData=function(){var s;!((s=this._thinInstanceDataStorage)===null||s===void 0)&&s.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)};const of="EXT_mesh_gpu_instancing";class bb{constructor(e){this.name=of,this._loader=e,this.enabled=this._loader.isExtensionUsed(of)}dispose(){this._loader=null}loadNodeAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{this._loader._disableInstancedMesh++;const a=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,i);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return a;const o=new Array;let l=0;const c=u=>{if(r.attributes[u]==null){o.push(Promise.resolve(null));return}const h=xe.Get(`${n}/attributes/${u}`,this._loader.gltf.accessors,r.attributes[u]);if(o.push(this._loader._loadFloatAccessorAsync(`/accessors/${h.bufferView}`,h)),l===0)l=h.count;else if(l!==h.count)throw new Error(`${n}/attributes: Instance buffer accessors do not have the same count.`)};return c("TRANSLATION"),c("ROTATION"),c("SCALE"),a.then(u=>Promise.all(o).then(([h,d,f])=>{const p=new Float32Array(l*16);w.Vector3[0].copyFromFloats(0,0,0),w.Quaternion[0].copyFromFloats(0,0,0,1),w.Vector3[1].copyFromFloats(1,1,1);for(let m=0;m<l;++m)h&&g.FromArrayToRef(h,m*3,w.Vector3[0]),d&&ee.FromArrayToRef(d,m*4,w.Quaternion[0]),f&&g.FromArrayToRef(f,m*3,w.Vector3[1]),D.ComposeToRef(w.Vector3[1],w.Quaternion[0],w.Vector3[0],w.Matrix[0]),w.Matrix[0].copyToArray(p,m*16);for(const m of t._primitiveBabylonMeshes)m.thinInstanceSetBuffer("matrix",p,16,!0);return u}))})}}ce.RegisterExtension(of,s=>new bb(s));class Ys{static get Default(){return Ys._Default||(Ys._Default=new Ys),Ys._Default}constructor(){const e=Ys.Configuration.decoder;this._decoderModulePromise=q.LoadScriptAsync(q.GetAbsoluteUrl(e.url)).then(()=>MeshoptDecoder.ready)}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(e,t,i,n,r){return this._decoderModulePromise.then(()=>{const a=new Uint8Array(t*i);return MeshoptDecoder.decodeGltfBuffer(a,t,i,e,n,r),a})}}Ys.Configuration={decoder:{url:"https://preview.babylonjs.com/meshopt_decoder.js"}};Ys._Default=null;const lf="EXT_meshopt_compression";class xb{constructor(e){this.name=lf,this.enabled=e.isExtensionUsed(lf),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return ce.LoadExtensionAsync(e,t,this.name,(i,n)=>{const r=t;if(r._meshOptData)return r._meshOptData;const a=xe.Get(`${e}/buffer`,this._loader.gltf.buffers,n.buffer);return r._meshOptData=this._loader.loadBufferAsync(`/buffers/${a.index}`,a,n.byteOffset||0,n.byteLength).then(o=>Ys.Default.decodeGltfBufferAsync(o,n.count,n.byteStride,n.mode,n.filter)),r._meshOptData})}}ce.RegisterExtension(lf,s=>new xb(s));const cf="EXT_texture_webp";class Mb{constructor(e){this.name=cf,this._loader=e,this.enabled=e.isExtensionUsed(cf)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{const a=t.sampler==null?ce.DefaultSampler:xe.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),o=xe.Get(`${n}/source`,this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,a,o,l=>{i(l)},void 0,!t._textureInfo.nonColorData)})}}ce.RegisterExtension(cf,s=>new Mb(s));class Pb{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map(t=>({workerPromise:Promise.resolve(t),idle:!0}))}dispose(){for(const e of this._workerInfos)e.workerPromise.then(t=>{t.terminate()});this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(const t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then(i=>{t(i,()=>{const n=this._pendingActions.shift();n?this._execute(e,n):e.idle=!0})})}}class nh extends Pb{constructor(e,t,i=nh.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=t,this._options=i}push(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){const t={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(t),this._execute(t,e)}else this._pendingActions.push(e)}_execute(e,t){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,(i,n)=>{t(i,()=>{n(),e.idle&&(e.timeoutId=setTimeout(()=>{e.workerPromise.then(a=>{a.terminate()});const r=this._workerInfos.indexOf(e);r!==-1&&this._workerInfos.splice(r,1)},this._options.idleTimeElapsedBeforeRelease))})})}}nh.DefaultOptions={idleTimeElapsedBeforeRelease:1e3};function Db(s){return new Promise(e=>{DracoDecoderModule({wasmBinary:s}).then(t=>{e({module:t})})})}function uf(s,e,t,i,n,r){const a=new s.DecoderBuffer;a.Init(e,e.byteLength);const o=new s.Decoder;let l,c;try{const u=o.GetEncodedGeometryType(a);switch(u){case s.TRIANGULAR_MESH:l=new s.Mesh,c=o.DecodeBufferToMesh(a,l);break;case s.POINT_CLOUD:l=new s.PointCloud,c=o.DecodeBufferToPointCloud(a,l);break;default:throw new Error(`Invalid geometry type ${u}`)}if(!c.ok()||!l.ptr)throw new Error(c.error_msg());if(u===s.TRIANGULAR_MESH){const f=l.num_faces()*3,p=f*4,m=s._malloc(p);try{o.GetTrianglesUInt32Array(l,p,m);const _=new Uint32Array(f);_.set(new Uint32Array(s.HEAPF32.buffer,m,f)),i(_)}finally{s._free(m)}}const h=(d,f,p=1)=>{const m=f.num_components(),_=l.num_points(),E=_*m,v=E*Float32Array.BYTES_PER_ELEMENT,y=s._malloc(v);try{o.GetAttributeDataArrayForAllPoints(l,f,s.DT_FLOAT32,v,y);const A=new Float32Array(s.HEAPF32.buffer,y,E);if(d==="color"&&m===3){const I=new Float32Array(_*4);for(let T=0,R=0;T<I.length;T+=4,R+=m)I[T+0]=A[R+0],I[T+1]=A[R+1],I[T+2]=A[R+2],I[T+3]=1;n(d,I)}else{const I=new Float32Array(E);if(I.set(new Float32Array(s.HEAPF32.buffer,y,E)),p!==1)for(let T=0;T<I.length;T++)I[T]=I[T]/p;n(d,I)}}finally{s._free(y)}};if(t)for(const d in t){const f=t[d],p=o.GetAttributeByUniqueId(l,f),m=r&&r[d]||1;h(d,p,m)}else{const d={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"};for(const f in d){const p=o.GetAttributeId(l,s[d[f]]);if(p!==-1){const m=o.GetAttribute(l,p);h(f,m)}}}}finally{l&&s.destroy(l),s.destroy(o),s.destroy(a)}}function Ob(){let s;onmessage=e=>{const t=e.data;switch(t.id){case"init":{const i=t.decoder;i.url&&(importScripts(i.url),s=DracoDecoderModule({wasmBinary:i.wasmBinary})),postMessage("done");break}case"decodeMesh":{if(!s)throw new Error("Draco decoder module is not available");s.then(i=>{uf(i,t.dataView,t.attributes,n=>{postMessage({id:"indices",value:n},[n.buffer])},(n,r)=>{postMessage({id:n,value:r},[r.buffer])}),postMessage("done")});break}}}}class on{static get DecoderAvailable(){const e=on.Configuration.decoder;return!!(e.wasmUrl&&e.wasmBinaryUrl&&typeof WebAssembly=="object"||e.fallbackUrl)}static GetDefaultNumWorkers(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}static get Default(){return on._Default||(on._Default=new on),on._Default}constructor(e=on.DefaultNumWorkers){const t=on.Configuration.decoder,i=t.wasmUrl&&t.wasmBinaryUrl&&typeof WebAssembly=="object"?{url:q.GetAbsoluteUrl(t.wasmUrl),wasmBinaryPromise:q.LoadFileAsync(q.GetAbsoluteUrl(t.wasmBinaryUrl))}:{url:q.GetAbsoluteUrl(t.fallbackUrl),wasmBinaryPromise:Promise.resolve(void 0)};e&&typeof Worker=="function"&&typeof URL=="function"?this._workerPoolPromise=i.wasmBinaryPromise.then(n=>{const r=`${uf}(${Ob})()`,a=URL.createObjectURL(new Blob([r],{type:"application/javascript"}));return new nh(e,()=>new Promise((o,l)=>{const c=new Worker(a),u=d=>{c.removeEventListener("error",u),c.removeEventListener("message",h),l(d)},h=d=>{d.data==="done"&&(c.removeEventListener("error",u),c.removeEventListener("message",h),o(c))};c.addEventListener("error",u),c.addEventListener("message",h),c.postMessage({id:"init",decoder:{url:i.url,wasmBinary:n}})}))}):this._decoderModulePromise=i.wasmBinaryPromise.then(n=>{if(!i.url)throw new Error("Draco decoder module is not available");return q.LoadScriptAsync(i.url).then(()=>Db(n))})}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._decoderModulePromise}whenReadyAsync(){return this._workerPoolPromise?this._workerPoolPromise.then(()=>{}):this._decoderModulePromise?this._decoderModulePromise.then(()=>{}):Promise.resolve()}decodeMeshAsync(e,t,i){const n=e instanceof ArrayBuffer?new Uint8Array(e):e;if(this._workerPoolPromise)return this._workerPoolPromise.then(r=>new Promise((a,o)=>{r.push((l,c)=>{const u=new fe,h=p=>{l.removeEventListener("error",h),l.removeEventListener("message",d),o(p),c()},d=p=>{if(p.data==="done")l.removeEventListener("error",h),l.removeEventListener("message",d),a(u),c();else if(p.data.id==="indices")u.indices=p.data.value;else{const m=i&&i[p.data.id]?i[p.data.id]:1;if(m!==1)for(let _=0;_<p.data.value.length;_++)p.data.value[_]=p.data.value[_]/m;u.set(p.data.value,p.data.id)}};l.addEventListener("error",h),l.addEventListener("message",d);const f=new Uint8Array(n.byteLength);f.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength)),l.postMessage({id:"decodeMesh",dataView:f,attributes:t},[f.buffer])})}));if(this._decoderModulePromise)return this._decoderModulePromise.then(r=>{const a=new fe;return uf(r.module,n,t,o=>{a.indices=o},(o,l)=>{a.set(l,o)},i),a});throw new Error("Draco decoder module is not available")}}on.Configuration={decoder:{wasmUrl:"https://preview.babylonjs.com/draco_wasm_wrapper_gltf.js",wasmBinaryUrl:"https://preview.babylonjs.com/draco_decoder_gltf.wasm",fallbackUrl:"https://preview.babylonjs.com/draco_decoder_gltf.js"}};on.DefaultNumWorkers=on.GetDefaultNumWorkers();on._Default=null;const hf="KHR_draco_mesh_compression";class wb{constructor(e){this.name=hf,this._loader=e,this.enabled=on.DecoderAvailable&&this._loader.isExtensionUsed(hf)}dispose(){delete this.dracoCompression,this._loader=null}_loadVertexDataAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{if(t.mode!=null){if(t.mode!==5&&t.mode!==4)throw new Error(`${e}: Unsupported mode ${t.mode}`);if(t.mode===5)throw new Error(`${e}: Mode ${t.mode} is not currently supported`)}const a={},o={},l=(u,h)=>{const d=r.attributes[u];if(d===void 0||t.attributes[u]===void 0)return;a[h]=d;const f=xe.Get(`${e}/attributes/${u}`,this._loader.gltf.accessors,t.attributes[u]);if(f.normalized&&f.componentType!==5126){let p=1;switch(f.componentType){case 5120:p=127;break;case 5121:p=255;break;case 5122:p=32767;break;case 5123:p=65535;break}o[h]=p}i._delayInfo=i._delayInfo||[],i._delayInfo.indexOf(h)===-1&&i._delayInfo.push(h)};l("POSITION",C.PositionKind),l("NORMAL",C.NormalKind),l("TANGENT",C.TangentKind),l("TEXCOORD_0",C.UVKind),l("TEXCOORD_1",C.UV2Kind),l("TEXCOORD_2",C.UV3Kind),l("TEXCOORD_3",C.UV4Kind),l("TEXCOORD_4",C.UV5Kind),l("TEXCOORD_5",C.UV6Kind),l("JOINTS_0",C.MatricesIndicesKind),l("WEIGHTS_0",C.MatricesWeightsKind),l("COLOR_0",C.ColorKind);const c=xe.Get(n,this._loader.gltf.bufferViews,r.bufferView);return c._dracoBabylonGeometry||(c._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${c.index}`,c).then(u=>(this.dracoCompression||on.Default).decodeMeshAsync(u,a,o).then(d=>{const f=new Ki(i.name,this._loader.babylonScene);return d.applyToGeometry(f),f}).catch(d=>{throw new Error(`${e}: ${d.message}`)}))),c._dracoBabylonGeometry})}}ce.RegisterExtension(hf,s=>new wb(s));class Ca extends Be{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=g.Zero()),g.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=g.Zero()),g.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=g.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const e=g.Cross(this.direction,Aa.Y),t=g.Cross(e,this.direction);return g.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=g.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=D.Identity()),D.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ}getDepthMaxZ(e){return this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)}}S([gn()],Ca.prototype,"position",null);S([gn()],Ca.prototype,"direction",null);S([b()],Ca.prototype,"shadowMinZ",null);S([b()],Ca.prototype,"shadowMaxZ",null);oi.AddNodeConstructor("Light_Type_1",(s,e)=>()=>new Ns(s,g.Zero(),e));class Ns extends Ca{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return Be.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){const t=this.getScene().activeCamera;t&&D.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==void 0?this.shadowMinZ:t.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){const n=this.getScene().activeCamera;if(!n)return;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const u=g.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE;let h=Number.MAX_VALUE,d=Number.MIN_VALUE;for(let f=0;f<i.length;f++){const p=i[f];if(!p)continue;const _=p.getBoundingInfo().boundingBox;for(let E=0;E<_.vectorsWorld.length;E++)g.TransformCoordinatesToRef(_.vectorsWorld[E],t,u),u.x<this._orthoLeft&&(this._orthoLeft=u.x),u.y<this._orthoBottom&&(this._orthoBottom=u.y),u.x>this._orthoRight&&(this._orthoRight=u.x),u.y>this._orthoTop&&(this._orthoTop=u.y),this.autoCalcShadowZBounds&&(u.z<h&&(h=u.z),u.z>d&&(d=u.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=h,this._shadowMaxZ=d)}const r=this._orthoRight-this._orthoLeft,a=this._orthoTop-this._orthoBottom,o=this.shadowMinZ!==void 0?this.shadowMinZ:n.minZ,l=this.shadowMaxZ!==void 0?this.shadowMaxZ:n.maxZ,c=this.getScene().getEngine().useReverseDepthBuffer;D.OrthoOffCenterLHToRef(this._orthoLeft-r*this.shadowOrthoScale,this._orthoRight+r*this.shadowOrthoScale,this._orthoBottom-a*this.shadowOrthoScale,this._orthoTop+a*this.shadowOrthoScale,c?l:o,c?o:l,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}}S([b()],Ns.prototype,"shadowFrustumSize",null);S([b()],Ns.prototype,"shadowOrthoScale",null);S([b()],Ns.prototype,"autoUpdateExtends",void 0);S([b()],Ns.prototype,"autoCalcShadowZBounds",void 0);S([b("orthoLeft")],Ns.prototype,"_orthoLeft",void 0);S([b("orthoRight")],Ns.prototype,"_orthoRight",void 0);S([b("orthoTop")],Ns.prototype,"_orthoTop",void 0);S([b("orthoBottom")],Ns.prototype,"_orthoBottom",void 0);oi.AddNodeConstructor("Light_Type_0",(s,e)=>()=>new rm(s,g.Zero(),e));class rm extends Ca{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){const i=this._shadowGenerators.values();for(let n=i.next();n.done!==!0;n=i.next())n.value.recreateShadowMap()}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return Be.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new g(1,0,0);case 1:return new g(-1,0,0);case 2:return new g(0,-1,0);case 3:return new g(0,1,0);case 4:return new g(0,0,1);case 5:return new g(0,0,-1)}return g.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){const n=this.getScene().activeCamera;if(!n)return;const r=this.shadowMinZ!==void 0?this.shadowMinZ:n.minZ,a=this.shadowMaxZ!==void 0?this.shadowMaxZ:n.maxZ,o=this.getScene().getEngine().useReverseDepthBuffer;D.PerspectiveFovLHToRef(this.shadowAngle,1,o?a:r,o?r:a,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,o)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}}S([b()],rm.prototype,"shadowAngle",null);oi.AddNodeConstructor("Light_Type_2",(s,e)=>()=>new Un(s,g.Zero(),g.Zero(),0,0,e));class Un extends Ca{get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(e*.5),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(Un._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(()=>{this._markMeshesAsLightDirty()}):Un._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()})))}static _IsProceduralTexture(e){return e.onGeneratedObservable!==void 0}static _IsTexture(e){return e.onLoadObservable!==void 0}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,t,i,n,r,a){super(e,a),this._innerAngle=0,this._projectionTextureMatrix=D.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=g.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=g.Zero(),this._projectionTextureViewLightMatrix=D.Zero(),this._projectionTextureProjectionLightMatrix=D.Zero(),this._projectionTextureScalingMatrix=D.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=i,this.angle=n,this.exponent=r}getClassName(){return"SpotLight"}getTypeID(){return Be.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,i){const n=this.getScene().activeCamera;if(!n)return;this._shadowAngleScale=this._shadowAngleScale||1;const r=this._shadowAngleScale*this._angle,a=this.shadowMinZ!==void 0?this.shadowMinZ:n.minZ,o=this.shadowMaxZ!==void 0?this.shadowMaxZ:n.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;D.PerspectiveFovLHToRef(r,1,l?o:a,l?a:o,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,l)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.getAbsolutePosition().addToRef(this.direction,this._projectionTextureViewTargetVector),D.LookAtLHToRef(this.getAbsolutePosition(),this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;const e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),n=-i*t,r=1/Math.tan(this._angle/2),a=1;D.FromValuesToRef(r/a,0,0,0,0,r,0,0,0,0,i,1,0,0,n,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof H){const e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;D.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(this._innerAngle*.5)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightSampler"+t,this.projectionTexture)),this}transferToEffect(e,t){let i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),i=g.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),i=g.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let i;return this.computeTransformedInformation()?i=g.Normalize(this.transformedDirection):i=g.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose()}getDepthMinZ(e){const t=this._scene.getEngine(),i=this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){const t=this._scene.getEngine(),i=this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:i}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!!(this.projectionTexture&&this.projectionTexture.isReady())}}S([b()],Un.prototype,"angle",null);S([b()],Un.prototype,"innerAngle",null);S([b()],Un.prototype,"shadowAngleScale",null);S([b()],Un.prototype,"exponent",void 0);S([b()],Un.prototype,"projectionTextureLightNear",null);S([b()],Un.prototype,"projectionTextureLightFar",null);S([b()],Un.prototype,"projectionTextureUpDirection",null);S([ht("projectedLightTexture")],Un.prototype,"_projectionTexture",void 0);const df="KHR_lights_punctual";class Fb{constructor(e){this.name=df,this._loader=e,this.enabled=this._loader.isExtensionUsed(df)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,xe.Assign(this._lights)}}loadNodeAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>this._loader.loadNodeAsync(e,t,a=>{let o;const l=xe.Get(n,this._lights,r.light),c=l.name||a.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l.type){case"directional":{const u=new Ns(c,g.Backward(),this._loader.babylonScene);u.position.setAll(0),o=u;break}case"point":{o=new rm(c,g.Zero(),this._loader.babylonScene);break}case"spot":{const u=new Un(c,g.Zero(),g.Backward(),0,1,this._loader.babylonScene);u.angle=(l.spot&&l.spot.outerConeAngle||Math.PI/4)*2,u.innerAngle=(l.spot&&l.spot.innerConeAngle||0)*2,o=u;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${n}: Invalid light type (${l.type})`)}o._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=o,o.falloffType=Be.FALLOFF_GLTF,o.diffuse=l.color?G.FromArray(l.color):G.White(),o.intensity=l.intensity==null?1:l.intensity,o.range=l.range==null?Number.MAX_VALUE:l.range,o.parent=a,this._loader._babylonLights.push(o),ce.AddPointerMetadata(o,n),i(a)}))}}ce.RegisterExtension(df,s=>new Fb(s));const ff="KHR_materials_pbrSpecularGlossiness";class Lb{constructor(e){this.name=ff,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(ff)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{const a=new Array;return a.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),a.push(this._loadSpecularGlossinessPropertiesAsync(n,t,r,i)),this._loader.loadMaterialAlphaProperties(e,t,i),Promise.all(a).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,t,i,n){if(!(n instanceof oe))throw new Error(`${e}: Material type not supported`);const r=new Array;return n.metallic=null,n.roughness=null,i.diffuseFactor?(n.albedoColor=G.FromArray(i.diffuseFactor),n.alpha=i.diffuseFactor[3]):n.albedoColor=G.White(),n.reflectivityColor=i.specularFactor?G.FromArray(i.specularFactor):G.White(),n.microSurface=i.glossinessFactor==null?1:i.glossinessFactor,i.diffuseTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,i.diffuseTexture,a=>{a.name=`${n.name} (Diffuse)`,n.albedoTexture=a})),i.specularGlossinessTexture&&(r.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,i.specularGlossinessTexture,a=>{a.name=`${n.name} (Specular Glossiness)`,n.reflectivityTexture=a,n.reflectivityTexture.hasAlpha=!0})),n.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(r).then(()=>{})}}ce.RegisterExtension(ff,s=>new Lb(s));const pf="KHR_materials_unlit";class Nb{constructor(e){this.name=pf,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(pf)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,()=>this._loadUnlitPropertiesAsync(e,t,i))}_loadUnlitPropertiesAsync(e,t,i){if(!(i instanceof oe))throw new Error(`${e}: Material type not supported`);const n=new Array;i.unlit=!0;const r=t.pbrMetallicRoughness;return r&&(r.baseColorFactor?(i.albedoColor=G.FromArray(r.baseColorFactor),i.alpha=r.baseColorFactor[3]):i.albedoColor=G.White(),r.baseColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,r.baseColorTexture,a=>{a.name=`${i.name} (Base Color)`,i.albedoTexture=a}))),t.doubleSided&&(i.backFaceCulling=!1,i.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,i),Promise.all(n).then(()=>{})}}ce.RegisterExtension(pf,s=>new Nb(s));const mf="KHR_materials_clearcoat";class Bb{constructor(e){this.name=mf,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(mf)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadClearCoatPropertiesAsync(n,r,i)),Promise.all(a).then(()=>{})})}_loadClearCoatPropertiesAsync(e,t,i){if(!(i instanceof oe))throw new Error(`${e}: Material type not supported`);const n=new Array;return i.clearCoat.isEnabled=!0,i.clearCoat.useRoughnessFromMainTexture=!1,i.clearCoat.remapF0OnInterfaceChange=!1,t.clearcoatFactor!=null?i.clearCoat.intensity=t.clearcoatFactor:i.clearCoat.intensity=0,t.clearcoatTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,r=>{r.name=`${i.name} (ClearCoat Intensity)`,i.clearCoat.texture=r})),t.clearcoatRoughnessFactor!=null?i.clearCoat.roughness=t.clearcoatRoughnessFactor:i.clearCoat.roughness=0,t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,r=>{r.name=`${i.name} (ClearCoat Roughness)`,i.clearCoat.textureRoughness=r}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,r=>{r.name=`${i.name} (ClearCoat Normal)`,i.clearCoat.bumpTexture=r})),i.invertNormalMapX=!i.getScene().useRightHandedSystem,i.invertNormalMapY=i.getScene().useRightHandedSystem,t.clearcoatNormalTexture.scale!=null&&(i.clearCoat.bumpTexture.level=t.clearcoatNormalTexture.scale)),Promise.all(n).then(()=>{})}}ce.RegisterExtension(mf,s=>new Bb(s));const _f="KHR_materials_iridescence";class kb{constructor(e){this.name=_f,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(_f)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadIridescencePropertiesAsync(n,r,i)),Promise.all(a).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,i){var n,r,a,o,l;if(!(i instanceof oe))throw new Error(`${e}: Material type not supported`);const c=new Array;return i.iridescence.isEnabled=!0,i.iridescence.intensity=(n=t.iridescenceFactor)!==null&&n!==void 0?n:0,i.iridescence.indexOfRefraction=(a=(r=t.iridescenceIor)!==null&&r!==void 0?r:t.iridescenceIOR)!==null&&a!==void 0?a:1.3,i.iridescence.minimumThickness=(o=t.iridescenceThicknessMinimum)!==null&&o!==void 0?o:100,i.iridescence.maximumThickness=(l=t.iridescenceThicknessMaximum)!==null&&l!==void 0?l:400,t.iridescenceTexture&&c.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,u=>{u.name=`${i.name} (Iridescence Intensity)`,i.iridescence.texture=u})),t.iridescenceThicknessTexture&&c.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,u=>{u.name=`${i.name} (Iridescence Thickness)`,i.iridescence.thicknessTexture=u})),Promise.all(c).then(()=>{})}}ce.RegisterExtension(_f,s=>new kb(s));const gf="KHR_materials_anisotropy";class Ub{constructor(e){this.name=gf,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(gf)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadIridescencePropertiesAsync(n,r,i)),Promise.all(a).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,i){var n,r;if(!(i instanceof oe))throw new Error(`${e}: Material type not supported`);const a=new Array;return i.anisotropy.isEnabled=!0,i.anisotropy.intensity=(n=t.anisotropyStrength)!==null&&n!==void 0?n:0,i.anisotropy.angle=(r=t.anisotropyRotation)!==null&&r!==void 0?r:0,t.anisotropyTexture&&a.push(this._loader.loadTextureInfoAsync(`${e}/anisotropyTexture`,t.anisotropyTexture,o=>{o.name=`${i.name} (Anisotropy Intensity)`,i.anisotropy.texture=o})),Promise.all(a).then(()=>{})}}ce.RegisterExtension(gf,s=>new Ub(s));const Ef="KHR_materials_emissive_strength";class Vb{constructor(e){this.name=Ef,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ef)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>this._loader.loadMaterialPropertiesAsync(e,t,i).then(()=>{this._loadEmissiveProperties(n,r,i)}))}_loadEmissiveProperties(e,t,i){if(!(i instanceof oe))throw new Error(`${e}: Material type not supported`);t.emissiveStrength!==void 0&&i.emissiveColor.scaleToRef(t.emissiveStrength,i.emissiveColor)}}ce.RegisterExtension(Ef,s=>new Vb(s));const vf="KHR_materials_sheen";class Gb{constructor(e){this.name=vf,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(vf)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadSheenPropertiesAsync(n,r,i)),Promise.all(a).then(()=>{})})}_loadSheenPropertiesAsync(e,t,i){if(!(i instanceof oe))throw new Error(`${e}: Material type not supported`);const n=new Array;return i.sheen.isEnabled=!0,i.sheen.intensity=1,t.sheenColorFactor!=null?i.sheen.color=G.FromArray(t.sheenColorFactor):i.sheen.color=G.Black(),t.sheenColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,r=>{r.name=`${i.name} (Sheen Color)`,i.sheen.texture=r})),t.sheenRoughnessFactor!==void 0?i.sheen.roughness=t.sheenRoughnessFactor:i.sheen.roughness=0,t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,r=>{r.name=`${i.name} (Sheen Roughness)`,i.sheen.textureRoughness=r}))),i.sheen.albedoScaling=!0,i.sheen.useRoughnessFromMainTexture=!1,Promise.all(n).then(()=>{})}}ce.RegisterExtension(vf,s=>new Gb(s));const yf="KHR_materials_specular";class zb{constructor(e){this.name=yf,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(yf)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadSpecularPropertiesAsync(n,r,i)),Promise.all(a).then(()=>{})})}_loadSpecularPropertiesAsync(e,t,i){if(!(i instanceof oe))throw new Error(`${e}: Material type not supported`);const n=new Array;return t.specularFactor!==void 0&&(i.metallicF0Factor=t.specularFactor),t.specularColorFactor!==void 0&&(i.metallicReflectanceColor=G.FromArray(t.specularColorFactor)),t.specularTexture&&(t.specularTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,r=>{r.name=`${i.name} (Specular F0 Strength)`,i.metallicReflectanceTexture=r,i.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),t.specularColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,r=>{r.name=`${i.name} (Specular F0 Color)`,i.reflectanceTexture=r})),Promise.all(n).then(()=>{})}}ce.RegisterExtension(yf,s=>new zb(s));const Af="KHR_materials_ior";class sh{constructor(e){this.name=Af,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(Af)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{const a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadIorPropertiesAsync(n,r,i)),Promise.all(a).then(()=>{})})}_loadIorPropertiesAsync(e,t,i){if(!(i instanceof oe))throw new Error(`${e}: Material type not supported`);return t.ior!==void 0?i.indexOfRefraction=t.ior:i.indexOfRefraction=sh._DEFAULT_IOR,Promise.resolve()}}sh._DEFAULT_IOR=1.5;ce.RegisterExtension(Af,s=>new sh(s));const nn="KHR_materials_variants";class vr{constructor(e){this.name=nn,this._loader=e,this.enabled=this._loader.isExtensionUsed(nn)}dispose(){this._loader=null}static GetAvailableVariants(e){const t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return vr.GetAvailableVariants(e)}static SelectVariant(e,t){const i=this._GetExtensionMetadata(e);if(!i)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${nn} extension`);const n=r=>{const a=i.variants[r];if(a)for(const o of a)o.mesh.material=o.material};if(t instanceof Array)for(const r of t)n(r);else n(t);i.lastSelected=t}selectVariant(e,t){return vr.SelectVariant(e,t)}static Reset(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot reset on a glTF mesh that does not have the ${nn} extension`);for(const i of t.original)i.mesh.material=i.material;t.lastSelected=null}reset(e){return vr.Reset(e)}static GetLastSelectedVariant(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${nn} extension`);return t.lastSelected}getLastSelectedVariant(e){return vr.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){var t,i;return((i=(t=e==null?void 0:e._internalMetadata)===null||t===void 0?void 0:t.gltf)===null||i===void 0?void 0:i[nn])||null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._variants=t.variants}}_loadMeshPrimitiveAsync(e,t,i,n,r,a){return ce.LoadExtensionAsync(e,r,this.name,(o,l)=>{const c=new Array;return c.push(this._loader._loadMeshPrimitiveAsync(e,t,i,n,r,u=>{if(a(u),u instanceof he){const h=ce._GetDrawMode(e,r.mode),d=this._loader.rootBabylonMesh,f=d?d._internalMetadata=d._internalMetadata||{}:{},p=f.gltf=f.gltf||{},m=p[nn]=p[nn]||{lastSelected:null,original:[],variants:{}};m.original.push({mesh:u,material:u.material});for(let _=0;_<l.mappings.length;++_){const E=l.mappings[_],v=xe.Get(`${o}/mappings/${_}/material`,this._loader.gltf.materials,E.material);c.push(this._loader._loadMaterialAsync(`#/materials/${E.material}`,v,u,h,y=>{for(let A=0;A<E.variants.length;++A){const I=E.variants[A],T=xe.Get(`/extensions/${nn}/variants/${I}`,this._variants,I);m.variants[T.name]=m.variants[T.name]||[],m.variants[T.name].push({mesh:u,material:y}),u.onClonedObservable.add(R=>{const x=R;let F=null,L=x;do{if(L=L.parent,!L)return;F=vr._GetExtensionMetadata(L)}while(F===null);if(d&&F===vr._GetExtensionMetadata(d)){L._internalMetadata={};for(const V in d._internalMetadata)L._internalMetadata[V]=d._internalMetadata[V];L._internalMetadata.gltf=[];for(const V in d._internalMetadata.gltf)L._internalMetadata.gltf[V]=d._internalMetadata.gltf[V];L._internalMetadata.gltf[nn]={lastSelected:null,original:[],variants:{}};for(const V of F.original)L._internalMetadata.gltf[nn].original.push({mesh:V.mesh,material:V.material});for(const V in F.variants)if(Object.prototype.hasOwnProperty.call(F.variants,V)){L._internalMetadata.gltf[nn].variants[V]=[];for(const Z of F.variants[V])L._internalMetadata.gltf[nn].variants[V].push({mesh:Z.mesh,material:Z.material})}F=L._internalMetadata.gltf[nn]}for(const V of F.original)V.mesh===u&&(V.mesh=x);for(const V of F.variants[T.name])V.mesh===u&&(V.mesh=x)})}}))}}})),Promise.all(c).then(([u])=>u)})}}ce.RegisterExtension(nn,s=>new vr(s));class N{}N.ALPHA_DISABLE=0;N.ALPHA_ADD=1;N.ALPHA_COMBINE=2;N.ALPHA_SUBTRACT=3;N.ALPHA_MULTIPLY=4;N.ALPHA_MAXIMIZED=5;N.ALPHA_ONEONE=6;N.ALPHA_PREMULTIPLIED=7;N.ALPHA_PREMULTIPLIED_PORTERDUFF=8;N.ALPHA_INTERPOLATE=9;N.ALPHA_SCREENMODE=10;N.ALPHA_ONEONE_ONEONE=11;N.ALPHA_ALPHATOCOLOR=12;N.ALPHA_REVERSEONEMINUS=13;N.ALPHA_SRC_DSTONEMINUSSRCALPHA=14;N.ALPHA_ONEONE_ONEZERO=15;N.ALPHA_EXCLUSION=16;N.ALPHA_LAYER_ACCUMULATE=17;N.ALPHA_EQUATION_ADD=0;N.ALPHA_EQUATION_SUBSTRACT=1;N.ALPHA_EQUATION_REVERSE_SUBTRACT=2;N.ALPHA_EQUATION_MAX=3;N.ALPHA_EQUATION_MIN=4;N.ALPHA_EQUATION_DARKEN=5;N.DELAYLOADSTATE_NONE=0;N.DELAYLOADSTATE_LOADED=1;N.DELAYLOADSTATE_LOADING=2;N.DELAYLOADSTATE_NOTLOADED=4;N.NEVER=512;N.ALWAYS=519;N.LESS=513;N.EQUAL=514;N.LEQUAL=515;N.GREATER=516;N.GEQUAL=518;N.NOTEQUAL=517;N.KEEP=7680;N.ZERO=0;N.REPLACE=7681;N.INCR=7682;N.DECR=7683;N.INVERT=5386;N.INCR_WRAP=34055;N.DECR_WRAP=34056;N.TEXTURE_CLAMP_ADDRESSMODE=0;N.TEXTURE_WRAP_ADDRESSMODE=1;N.TEXTURE_MIRROR_ADDRESSMODE=2;N.TEXTURE_CREATIONFLAG_STORAGE=1;N.TEXTUREFORMAT_ALPHA=0;N.TEXTUREFORMAT_LUMINANCE=1;N.TEXTUREFORMAT_LUMINANCE_ALPHA=2;N.TEXTUREFORMAT_RGB=4;N.TEXTUREFORMAT_RGBA=5;N.TEXTUREFORMAT_RED=6;N.TEXTUREFORMAT_R=6;N.TEXTUREFORMAT_RG=7;N.TEXTUREFORMAT_RED_INTEGER=8;N.TEXTUREFORMAT_R_INTEGER=8;N.TEXTUREFORMAT_RG_INTEGER=9;N.TEXTUREFORMAT_RGB_INTEGER=10;N.TEXTUREFORMAT_RGBA_INTEGER=11;N.TEXTUREFORMAT_BGRA=12;N.TEXTUREFORMAT_DEPTH24_STENCIL8=13;N.TEXTUREFORMAT_DEPTH32_FLOAT=14;N.TEXTUREFORMAT_DEPTH16=15;N.TEXTUREFORMAT_DEPTH24=16;N.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17;N.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18;N.TEXTUREFORMAT_STENCIL8=19;N.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492;N.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493;N.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495;N.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494;N.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779;N.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919;N.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778;N.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918;N.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777;N.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776;N.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917;N.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916;N.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808;N.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840;N.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196;N.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492;N.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493;N.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494;N.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495;N.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496;N.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497;N.TEXTURETYPE_UNSIGNED_BYTE=0;N.TEXTURETYPE_UNSIGNED_INT=0;N.TEXTURETYPE_FLOAT=1;N.TEXTURETYPE_HALF_FLOAT=2;N.TEXTURETYPE_BYTE=3;N.TEXTURETYPE_SHORT=4;N.TEXTURETYPE_UNSIGNED_SHORT=5;N.TEXTURETYPE_INT=6;N.TEXTURETYPE_UNSIGNED_INTEGER=7;N.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;N.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;N.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;N.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;N.TEXTURETYPE_UNSIGNED_INT_24_8=12;N.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;N.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;N.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;N.TEXTURETYPE_UNDEFINED=16;N.TEXTURE_2D=3553;N.TEXTURE_2D_ARRAY=35866;N.TEXTURE_CUBE_MAP=34067;N.TEXTURE_CUBE_MAP_ARRAY=3735928559;N.TEXTURE_3D=32879;N.TEXTURE_NEAREST_SAMPLINGMODE=1;N.TEXTURE_NEAREST_NEAREST=1;N.TEXTURE_BILINEAR_SAMPLINGMODE=2;N.TEXTURE_LINEAR_LINEAR=2;N.TEXTURE_TRILINEAR_SAMPLINGMODE=3;N.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;N.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;N.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;N.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;N.TEXTURE_NEAREST_LINEAR=7;N.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;N.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;N.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;N.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;N.TEXTURE_LINEAR_NEAREST=12;N.TEXTURE_EXPLICIT_MODE=0;N.TEXTURE_SPHERICAL_MODE=1;N.TEXTURE_PLANAR_MODE=2;N.TEXTURE_CUBIC_MODE=3;N.TEXTURE_PROJECTION_MODE=4;N.TEXTURE_SKYBOX_MODE=5;N.TEXTURE_INVCUBIC_MODE=6;N.TEXTURE_EQUIRECTANGULAR_MODE=7;N.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;N.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;N.TEXTURE_FILTERING_QUALITY_OFFLINE=4096;N.TEXTURE_FILTERING_QUALITY_HIGH=64;N.TEXTURE_FILTERING_QUALITY_MEDIUM=16;N.TEXTURE_FILTERING_QUALITY_LOW=8;N.SCALEMODE_FLOOR=1;N.SCALEMODE_NEAREST=2;N.SCALEMODE_CEILING=3;N.MATERIAL_TextureDirtyFlag=1;N.MATERIAL_LightDirtyFlag=2;N.MATERIAL_FresnelDirtyFlag=4;N.MATERIAL_AttributesDirtyFlag=8;N.MATERIAL_MiscDirtyFlag=16;N.MATERIAL_PrePassDirtyFlag=32;N.MATERIAL_AllDirtyFlag=63;N.MATERIAL_TriangleFillMode=0;N.MATERIAL_WireFrameFillMode=1;N.MATERIAL_PointFillMode=2;N.MATERIAL_PointListDrawMode=3;N.MATERIAL_LineListDrawMode=4;N.MATERIAL_LineLoopDrawMode=5;N.MATERIAL_LineStripDrawMode=6;N.MATERIAL_TriangleStripDrawMode=7;N.MATERIAL_TriangleFanDrawMode=8;N.MATERIAL_ClockWiseSideOrientation=0;N.MATERIAL_CounterClockWiseSideOrientation=1;N.ACTION_NothingTrigger=0;N.ACTION_OnPickTrigger=1;N.ACTION_OnLeftPickTrigger=2;N.ACTION_OnRightPickTrigger=3;N.ACTION_OnCenterPickTrigger=4;N.ACTION_OnPickDownTrigger=5;N.ACTION_OnDoublePickTrigger=6;N.ACTION_OnPickUpTrigger=7;N.ACTION_OnPickOutTrigger=16;N.ACTION_OnLongPressTrigger=8;N.ACTION_OnPointerOverTrigger=9;N.ACTION_OnPointerOutTrigger=10;N.ACTION_OnEveryFrameTrigger=11;N.ACTION_OnIntersectionEnterTrigger=12;N.ACTION_OnIntersectionExitTrigger=13;N.ACTION_OnKeyDownTrigger=14;N.ACTION_OnKeyUpTrigger=15;N.PARTICLES_BILLBOARDMODE_Y=2;N.PARTICLES_BILLBOARDMODE_ALL=7;N.PARTICLES_BILLBOARDMODE_STRETCHED=8;N.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9;N.MESHES_CULLINGSTRATEGY_STANDARD=0;N.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;N.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;N.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;N.SCENELOADER_NO_LOGGING=0;N.SCENELOADER_MINIMAL_LOGGING=1;N.SCENELOADER_SUMMARY_LOGGING=2;N.SCENELOADER_DETAILED_LOGGING=3;N.PREPASS_IRRADIANCE_TEXTURE_TYPE=0;N.PREPASS_POSITION_TEXTURE_TYPE=1;N.PREPASS_VELOCITY_TEXTURE_TYPE=2;N.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3;N.PREPASS_COLOR_TEXTURE_TYPE=4;N.PREPASS_DEPTH_TEXTURE_TYPE=5;N.PREPASS_NORMAL_TEXTURE_TYPE=6;N.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7;N.BUFFER_CREATIONFLAG_READ=1;N.BUFFER_CREATIONFLAG_WRITE=2;N.BUFFER_CREATIONFLAG_READWRITE=3;N.BUFFER_CREATIONFLAG_UNIFORM=4;N.BUFFER_CREATIONFLAG_VERTEX=8;N.BUFFER_CREATIONFLAG_INDEX=16;N.BUFFER_CREATIONFLAG_STORAGE=32;N.RENDERPASS_MAIN=0;N.INPUT_ALT_KEY=18;N.INPUT_CTRL_KEY=17;N.INPUT_META_KEY1=91;N.INPUT_META_KEY2=92;N.INPUT_META_KEY3=93;N.INPUT_SHIFT_KEY=16;N.SNAPSHOTRENDERING_STANDARD=0;N.SNAPSHOTRENDERING_FAST=1;N.PERSPECTIVE_CAMERA=0;N.ORTHOGRAPHIC_CAMERA=1;N.FOVMODE_VERTICAL_FIXED=0;N.FOVMODE_HORIZONTAL_FIXED=1;N.RIG_MODE_NONE=0;N.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;N.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;N.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;N.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;N.RIG_MODE_STEREOSCOPIC_INTERLACED=14;N.RIG_MODE_VR=20;N.RIG_MODE_WEBVR=21;N.RIG_MODE_CUSTOM=22;N.MAX_SUPPORTED_UV_SETS=6;N.GL_ALPHA_EQUATION_ADD=32774;N.GL_ALPHA_EQUATION_MIN=32775;N.GL_ALPHA_EQUATION_MAX=32776;N.GL_ALPHA_EQUATION_SUBTRACT=32778;N.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779;N.GL_ALPHA_FUNCTION_SRC=768;N.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769;N.GL_ALPHA_FUNCTION_SRC_ALPHA=770;N.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771;N.GL_ALPHA_FUNCTION_DST_ALPHA=772;N.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773;N.GL_ALPHA_FUNCTION_DST_COLOR=774;N.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775;N.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776;N.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769;N.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770;N.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771;N.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772;N.SnippetUrl="https://snippet.babylonjs.com";class am{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:N.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options=Qt(Qt({},am._GetDefaultOptions()),e),this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new O,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(r=>this._options[r]!==e[r]).length)return;const i=Qt(Qt({},this._options),e),n=this._options;this._options=i,i.renderSize!==n.renderSize||i.renderTargetTextureType!==n.renderTargetTextureType||i.generateMipmaps!==n.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=i.samples,this._opaqueRenderTarget.lodGenerationScale=i.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=i.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return e?!!(e instanceof oe&&e.subSurface.isRefractionEnabled):!1}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),q.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.indexOf(e)===-1&&this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.indexOf(e)===-1&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);t!==-1&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),t!==-1&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const t=this._transparentMeshesCache.indexOf(e),i=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof oe&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),i!==-1?(this._opaqueMeshesCache.splice(i,1),this._transparentMeshesCache.push(e)):t===-1&&this._transparentMeshesCache.push(e)):t!==-1?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):i===-1&&this._opaqueMeshesCache.push(e)}_setupRenderTargets(){var e,t;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new er("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=(t=(e=this._options.clearColor)===null||e===void 0?void 0:e.clone())!==null&&t!==void 0?t:this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples;let i,n;this._opaqueRenderTarget.onBeforeBindObservable.add(r=>{n=this._scene.environmentIntensity,this._scene.environmentIntensity=1,i=this._scene.imageProcessingConfiguration.applyByPostProcess,this._options.clearColor?r.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(r.clearColor,this._scene.getEngine().useExactSrgbConversions),this._scene.imageProcessingConfiguration._applyByPostProcess=!0}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=n,this._scene.imageProcessingConfiguration._applyByPostProcess=i}),this._transparentMeshesCache.forEach(r=>{this._shouldRenderAsTransmission(r.material)&&(r.material.refractionTexture=this._opaqueRenderTarget)})}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const Tf="KHR_materials_transmission";class Hb{constructor(e){this.name=Tf,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(Tf),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{const a=new Array;return a.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadTransparentPropertiesAsync(n,t,i,r)),Promise.all(a).then(()=>{})})}_loadTransparentPropertiesAsync(e,t,i,n){if(!(i instanceof oe))throw new Error(`${e}: Material type not supported`);const r=i;if(r.subSurface.isRefractionEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.useAlbedoToTintRefraction=!0,n.transmissionFactor!==void 0){r.subSurface.refractionIntensity=n.transmissionFactor;const a=r.getScene();r.subSurface.refractionIntensity&&!a._transmissionHelper&&new am({},r.getScene())}else return r.subSurface.refractionIntensity=0,r.subSurface.isRefractionEnabled=!1,Promise.resolve();return r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=0,n.transmissionTexture?(n.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,n.transmissionTexture,void 0).then(a=>{r.subSurface.refractionIntensityTexture=a,r.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}ce.RegisterExtension(Tf,s=>new Hb(s));const Sf="KHR_materials_translucency";class Wb{constructor(e){this.name=Sf,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(Sf),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{const a=new Array;return a.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadTranslucentPropertiesAsync(n,t,i,r)),Promise.all(a).then(()=>{})})}_loadTranslucentPropertiesAsync(e,t,i,n){if(!(i instanceof oe))throw new Error(`${e}: Material type not supported`);const r=i;if(r.subSurface.isTranslucencyEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=0,r.subSurface.useAlbedoToTintTranslucency=!0,n.translucencyFactor!==void 0)r.subSurface.translucencyIntensity=n.translucencyFactor;else return r.subSurface.translucencyIntensity=0,r.subSurface.isTranslucencyEnabled=!1,Promise.resolve();return n.translucencyTexture?(n.translucencyTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/translucencyTexture`,n.translucencyTexture).then(a=>{r.subSurface.translucencyIntensityTexture=a})):Promise.resolve()}}ce.RegisterExtension(Sf,s=>new Wb(s));const Cf="KHR_materials_volume";class Xb{constructor(e){this.name=Cf,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(Cf),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{const a=new Array;return a.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadVolumePropertiesAsync(n,t,i,r)),Promise.all(a).then(()=>{})})}_loadVolumePropertiesAsync(e,t,i,n){if(!(i instanceof oe))throw new Error(`${e}: Material type not supported`);if(!i.subSurface.isRefractionEnabled&&!i.subSurface.isTranslucencyEnabled||!n.thicknessFactor)return Promise.resolve();i.subSurface.volumeIndexOfRefraction=i.indexOfRefraction;const r=n.attenuationDistance!==void 0?n.attenuationDistance:Number.MAX_VALUE;return i.subSurface.tintColorAtDistance=r,n.attenuationColor!==void 0&&n.attenuationColor.length==3&&i.subSurface.tintColor.copyFromFloats(n.attenuationColor[0],n.attenuationColor[1],n.attenuationColor[2]),i.subSurface.minimumThickness=0,i.subSurface.maximumThickness=n.thicknessFactor,i.subSurface.useThicknessAsDepth=!0,n.thicknessTexture?(n.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,n.thicknessTexture).then(a=>{i.subSurface.thicknessTexture=a,i.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}ce.RegisterExtension(Cf,s=>new Xb(s));const If="KHR_mesh_quantization";class Yb{constructor(e){this.name=If,this.enabled=e.isExtensionUsed(If)}dispose(){}}ce.RegisterExtension(If,s=>new Yb(s));const Rf="KHR_texture_basisu";class Kb{constructor(e){this.name=Rf,this._loader=e,this.enabled=e.isExtensionUsed(Rf)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{const a=t.sampler==null?ce.DefaultSampler:xe.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),o=xe.Get(`${n}/source`,this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,a,o,l=>{i(l)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)})}}ce.RegisterExtension(Rf,s=>new Kb(s));const bf="KHR_texture_transform";class Qb{constructor(e){this.name=bf,this._loader=e,this.enabled=this._loader.isExtensionUsed(bf)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>this._loader.loadTextureInfoAsync(e,t,a=>{if(!(a instanceof H))throw new Error(`${n}: Texture type not supported`);r.offset&&(a.uOffset=r.offset[0],a.vOffset=r.offset[1]),a.uRotationCenter=0,a.vRotationCenter=0,r.rotation&&(a.wAng=-r.rotation),r.scale&&(a.uScale=r.scale[0],a.vScale=r.scale[1]),r.texCoord!=null&&(a.coordinatesIndex=r.texCoord),i(a)}))}}ce.RegisterExtension(bf,s=>new Qb(s));const xf="KHR_xmp_json_ld";class Zb{constructor(e){this.name=xf,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(xf)}dispose(){this._loader=null}onLoading(){var e,t,i;if(this._loader.rootBabylonMesh===null)return;const n=(e=this._loader.gltf.extensions)===null||e===void 0?void 0:e.KHR_xmp_json_ld,r=(i=(t=this._loader.gltf.asset)===null||t===void 0?void 0:t.extensions)===null||i===void 0?void 0:i.KHR_xmp_json_ld;if(n&&r){const a=+r.packet;n.packets&&a<n.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=n.packets[a])}}}ce.RegisterExtension(xf,s=>new Zb(s));function Na(s,e,t,i){return G.FromArray(e,t).scale(i)}function qb(s,e,t,i){return e[t+3]*i}function Gt(s,e,t,i){return e[t]*i}function Mf(s,e,t,i){return-e[t]*i}function xu(s,e,t,i){return e[t+1]*i}function tg(s,e,t,i){return e[t]*i*2}function qh(s){return{scale:[new Ft(B.ANIMATIONTYPE_FLOAT,`${s}.uScale`,Gt,()=>2),new Ft(B.ANIMATIONTYPE_FLOAT,`${s}.vScale`,xu,()=>2)],offset:[new Ft(B.ANIMATIONTYPE_FLOAT,`${s}.uOffset`,Gt,()=>2),new Ft(B.ANIMATIONTYPE_FLOAT,`${s}.vOffset`,xu,()=>2)],rotation:[new Ft(B.ANIMATIONTYPE_FLOAT,`${s}.wAng`,Mf,()=>1)]}}class zs extends ec{buildAnimations(e,t,i,n,r){r(e._babylonCamera,this._buildAnimation(t,i,n))}}class Ft extends ec{buildAnimations(e,t,i,n,r){for(const a in e._data)r(e._data[a].babylonMaterial,this._buildAnimation(t,i,n))}}class Yo extends ec{buildAnimations(e,t,i,n,r){r(e._babylonLight,this._buildAnimation(t,i,n))}}const jb={__array__:Qt({__target__:!0},$o)},$b={__array__:{__target__:!0,orthographic:{xmag:[new zs(B.ANIMATIONTYPE_FLOAT,"orthoLeft",Mf,()=>1),new zs(B.ANIMATIONTYPE_FLOAT,"orthoRight",xu,()=>1)],ymag:[new zs(B.ANIMATIONTYPE_FLOAT,"orthoBottom",Mf,()=>1),new zs(B.ANIMATIONTYPE_FLOAT,"orthoTop",xu,()=>1)],zfar:[new zs(B.ANIMATIONTYPE_FLOAT,"maxZ",Gt,()=>1)],znear:[new zs(B.ANIMATIONTYPE_FLOAT,"minZ",Gt,()=>1)]},perspective:{yfov:[new zs(B.ANIMATIONTYPE_FLOAT,"fov",Gt,()=>1)],zfar:[new zs(B.ANIMATIONTYPE_FLOAT,"maxZ",Gt,()=>1)],znear:[new zs(B.ANIMATIONTYPE_FLOAT,"minZ",Gt,()=>1)]}}},Jb={__array__:{__target__:!0,pbrMetallicRoughness:{baseColorFactor:[new Ft(B.ANIMATIONTYPE_COLOR3,"albedoColor",Na,()=>4),new Ft(B.ANIMATIONTYPE_FLOAT,"alpha",qb,()=>4)],metallicFactor:[new Ft(B.ANIMATIONTYPE_FLOAT,"metallic",Gt,()=>1)],roughnessFactor:[new Ft(B.ANIMATIONTYPE_FLOAT,"roughness",Gt,()=>1)],baseColorTexture:{extensions:{KHR_texture_transform:qh("albedoTexture")}}},emissiveFactor:[new Ft(B.ANIMATIONTYPE_COLOR3,"emissiveColor",Na,()=>3)],normalTexture:{scale:[new Ft(B.ANIMATIONTYPE_FLOAT,"bumpTexture.level",Gt,()=>1)]},occlusionTexture:{strength:[new Ft(B.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",Gt,()=>1)],extensions:{KHR_texture_transform:qh("ambientTexture")}},emissiveTexture:{extensions:{KHR_texture_transform:qh("emissiveTexture")}},extensions:{KHR_materials_ior:{ior:[new Ft(B.ANIMATIONTYPE_FLOAT,"indexOfRefraction",Gt,()=>1)]},KHR_materials_clearcoat:{clearcoatFactor:[new Ft(B.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",Gt,()=>1)],clearcoatRoughnessFactor:[new Ft(B.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",Gt,()=>1)]},KHR_materials_sheen:{sheenColorFactor:[new Ft(B.ANIMATIONTYPE_COLOR3,"sheen.color",Na,()=>3)],sheenRoughnessFactor:[new Ft(B.ANIMATIONTYPE_FLOAT,"sheen.roughness",Gt,()=>1)]},KHR_materials_specular:{specularFactor:[new Ft(B.ANIMATIONTYPE_FLOAT,"metallicF0Factor",Gt,()=>1)],specularColorFactor:[new Ft(B.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",Na,()=>3)]},KHR_materials_emissive_strength:{emissiveStrength:[new Ft(B.ANIMATIONTYPE_FLOAT,"emissiveIntensity",Gt,()=>1)]},KHR_materials_transmission:{transmissionFactor:[new Ft(B.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",Gt,()=>1)]},KHR_materials_volume:{attenuationColor:[new Ft(B.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",Na,()=>3)],attenuationDistance:[new Ft(B.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",Gt,()=>1)],thicknessFactor:[new Ft(B.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",Gt,()=>1)]},KHR_materials_iridescence:{iridescenceFactor:[new Ft(B.ANIMATIONTYPE_FLOAT,"iridescence.intensity",Gt,()=>1)],iridescenceIor:[new Ft(B.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",Gt,()=>1)],iridescenceThicknessMinimum:[new Ft(B.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",Gt,()=>1)],iridescenceThicknessMaximum:[new Ft(B.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",Gt,()=>1)]},KHR_materials_anisotropy:{anisotropyStrength:[new Ft(B.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",Gt,()=>1)],anisotropyRotation:[new Ft(B.ANIMATIONTYPE_FLOAT,"anisotropy.angle",Gt,()=>1)]}}}},ex={KHR_lights_punctual:{lights:{__array__:{__target__:!0,color:[new Yo(B.ANIMATIONTYPE_COLOR3,"diffuse",Na,()=>3)],intensity:[new Yo(B.ANIMATIONTYPE_FLOAT,"intensity",Gt,()=>1)],range:[new Yo(B.ANIMATIONTYPE_FLOAT,"range",Gt,()=>1)],spot:{innerConeAngle:[new Yo(B.ANIMATIONTYPE_FLOAT,"innerAngle",tg,()=>1)],outerConeAngle:[new Yo(B.ANIMATIONTYPE_FLOAT,"angle",tg,()=>1)]}}}}},tx={nodes:jb,materials:Jb,cameras:$b,extensions:ex},Pf="KHR_animation_pointer";class ix{constructor(e){this.name=Pf,this._loader=e}get enabled(){return this._loader.isExtensionUsed(Pf)}dispose(){this._loader=null}_loadAnimationChannelAsync(e,t,i,n,r){var a;const o=(a=n.target.extensions)===null||a===void 0?void 0:a.KHR_animation_pointer;if(!o)return null;n.target.path!=="pointer"&&U.Warn(`${e}/target/path: Value (${n.target.path}) must be (pointer) when using the ${this.name} extension`),n.target.node!=null&&U.Warn(`${e}/target/node: Value (${n.target.node}) must not be present when using the ${this.name} extension`);const l=`${e}/extensions/${this.name}`,c=o.pointer;if(!c)throw new Error(`${l}: Pointer is missing`);const u=this._parseAnimationPointer(`${l}/pointer`,c);return u?this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,i,n,u,r):(U.Warn(`${l}/pointer: Invalid pointer (${c}) skipped`),null)}_parseAnimationPointer(e,t){if(!t.startsWith("/"))return U.Warn(`${e}: Value (${t}) must start with a slash`),null;const i=t.split("/");i.shift();let n=tx,r=this._loader.gltf,a;for(const o of i){if(n.__array__)n=n.__array__;else if(n=n[o],!n)return null;r=r&&r[o],n.__target__&&(a=r)}return!a||!Array.isArray(n)?null:{target:a,properties:n}}}ce.RegisterExtension(Pf,s=>new ix(s));class om{constructor(e,t,i){this.frame=e,this.action=t,this.onlyOnce=i,this.isDone=!1}_clone(){return new om(this.frame,this.action,this.onlyOnce)}}class es{get loop(){return this._loop}set loop(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}))}get currentTime(){var e;if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if(!((e=k.audioEngine)===null||e===void 0)&&e.audioContext&&(this.isPlaying||this.isPaused)){const t=this.isPaused?0:k.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+t}return 0}get spatialSound(){return this._spatialSound}set spatialSound(e){if(e==this._spatialSound)return;const t=this.isPlaying;this.pause(),e?(this._spatialSound=e,this._updateSpatialParameters()):this._disableSpatialSound(),t&&this.play()}constructor(e,t,i,n=null,r){var a,o,l,c,u;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new O,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=g.Zero(),this._localDirection=new g(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,i=i||Fe.LastCreatedScene,!!i)if(this._scene=i,es._SceneComponentInitialization(i),this._readyToPlayCallback=n,this._customAttenuationFunction=(h,d,f,p,m)=>d<f?h*(1-d/f):0,r&&(this.autoplay=r.autoplay||!1,this._loop=r.loop||!1,r.volume!==void 0&&(this._volume=r.volume),this._spatialSound=(a=r.spatialSound)!==null&&a!==void 0?a:!1,this.maxDistance=(o=r.maxDistance)!==null&&o!==void 0?o:100,this.useCustomAttenuation=(l=r.useCustomAttenuation)!==null&&l!==void 0?l:!1,this.rolloffFactor=r.rolloffFactor||1,this.refDistance=r.refDistance||1,this.distanceModel=r.distanceModel||"linear",this._playbackRate=r.playbackRate||1,this._streaming=(c=r.streaming)!==null&&c!==void 0?c:!1,this._length=r.length,this._offset=r.offset),!((u=k.audioEngine)===null||u===void 0)&&u.canUseWebAudio&&k.audioEngine.audioContext){this._soundGain=k.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let h=!0;if(t)try{typeof t=="string"?this._urlType="String":t instanceof ArrayBuffer?this._urlType="ArrayBuffer":t instanceof HTMLMediaElement?this._urlType="MediaElement":t instanceof MediaStream?this._urlType="MediaStream":t instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(t)&&(this._urlType="Array");let d=[],f=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=k.audioEngine.audioContext.createMediaElementSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=k.audioEngine.audioContext.createMediaStreamSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":t.byteLength>0&&(f=!0,this._soundLoaded(t));break;case"AudioBuffer":this._audioBufferLoaded(t);break;case"String":d.push(t);case"Array":d.length===0&&(d=t);for(let p=0;p<d.length;p++){const m=d[p];if(f=r&&r.skipCodecCheck||m.indexOf(".mp3",m.length-4)!==-1&&k.audioEngine.isMP3supported||m.indexOf(".ogg",m.length-4)!==-1&&k.audioEngine.isOGGsupported||m.indexOf(".wav",m.length-4)!==-1||m.indexOf(".m4a",m.length-4)!==-1||m.indexOf(".mp4",m.length-4)!==-1||m.indexOf("blob:")!==-1,f){this._streaming?(this._htmlAudioElement=new Audio(m),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,q.SetCorsBehavior(m,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(m,_=>{this._soundLoaded(_)},void 0,!0,!0,_=>{_&&U.Error("XHR "+_.status+" error on: "+m+"."),U.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:h=!1;break}h?f||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):U.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch(d){U.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),k.audioEngine&&!k.audioEngine.WarnedWebAudioUnsupported&&(U.Error("Web Audio is not supported by your browser."),k.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}dispose(){var e;!((e=k.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._streamingSource&&this._streamingSource.disconnect(),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._clearTimeoutsAndObservers())}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(e){var t;!((t=k.audioEngine)===null||t===void 0)&&t.audioContext&&(this._audioBuffer=e,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(e){var t;!((t=k.audioEngine)===null||t===void 0)&&t.audioContext&&k.audioEngine.audioContext.decodeAudioData(e,i=>{this._audioBufferLoaded(i)},i=>{U.Error("Error while decoding audio data for: "+this.name+" / Error: "+i)})}setAudioBuffer(e){var t;!((t=k.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)}updateOptions(e){var t,i,n,r,a,o,l,c,u,h,d;e&&(this.loop=(t=e.loop)!==null&&t!==void 0?t:this.loop,this.maxDistance=(i=e.maxDistance)!==null&&i!==void 0?i:this.maxDistance,this.useCustomAttenuation=(n=e.useCustomAttenuation)!==null&&n!==void 0?n:this.useCustomAttenuation,this.rolloffFactor=(r=e.rolloffFactor)!==null&&r!==void 0?r:this.rolloffFactor,this.refDistance=(a=e.refDistance)!==null&&a!==void 0?a:this.refDistance,this.distanceModel=(o=e.distanceModel)!==null&&o!==void 0?o:this.distanceModel,this._playbackRate=(l=e.playbackRate)!==null&&l!==void 0?l:this._playbackRate,this._length=(c=e.length)!==null&&c!==void 0?c:void 0,this.spatialSound=(u=e.spatialSound)!==null&&u!==void 0?u:this._spatialSound,this._setOffset((h=e.offset)!==null&&h!==void 0?h:void 0),this.setVolume((d=e.volume)!==null&&d!==void 0?d:this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))}_createSpatialParameters(){var e,t;!((e=k.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&k.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=(t=this._soundPanner)!==null&&t!==void 0?t:k.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_disableSpatialSound(){var e;this._spatialSound&&(this._inputAudioNode=this._soundGain,(e=this._soundPanner)===null||e===void 0||e.disconnect(),this._soundPanner=null,this._spatialSound=!1)}_updateSpatialParameters(){this._spatialSound&&(this._soundPanner?this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel):this._createSpatialParameters())}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){var e;!((e=k.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(e){var t;!((t=k.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)}setDirectionalCone(e,t,i){if(t<e){U.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=i,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){var t;if(e!=this._coneInnerAngle){if(this._coneOuterAngle<e){U.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,!((t=k.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){var t;if(e!=this._coneOuterAngle){if(e<this._coneInnerAngle){U.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e,!((t=k.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(e){var t;e.equals(this._position)||(this._position.copyFrom(e),!((t=k.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(e){var t;this._localDirection=e,!((t=k.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;const e=this._connectedTransformNode.getWorldMatrix(),t=g.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.orientationX.value=t.x,this._soundPanner.orientationY.value=t.y,this._soundPanner.orientationZ.value=t.z}updateDistanceFromListener(){var e;if(!((e=k.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){const t=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(e){this._customAttenuationFunction=e}play(e,t,i){var n,r,a,o;if(this._isReadyToPlay&&this._scene.audioEnabled&&(!((n=k.audioEngine)===null||n===void 0)&&n.audioContext))try{this._clearTimeoutsAndObservers();let l=e?((r=k.audioEngine)===null||r===void 0?void 0:r.audioContext.currentTime)+e:(a=k.audioEngine)===null||a===void 0?void 0:a.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(this._streamingSource||(this._streamingSource=k.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement){const c=()=>{var u,h;if(!((u=k.audioEngine)===null||u===void 0)&&u.unlocked){const d=this._htmlAudioElement.play();d!==void 0&&d.catch(()=>{var f,p;(f=k.audioEngine)===null||f===void 0||f.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=(p=k.audioEngine)===null||p===void 0?void 0:p.onAudioUnlockedObservable.addOnce(()=>{c()}))})}else(this.loop||this.autoplay)&&(this._audioUnlockedObserver=(h=k.audioEngine)===null||h===void 0?void 0:h.onAudioUnlockedObservable.addOnce(()=>{c()}))};c()}}else{const c=()=>{var u,h,d,f;if(!((u=k.audioEngine)===null||u===void 0)&&u.audioContext){if(i=i||this._length,t!==void 0&&this._setOffset(t),this._soundSource){const p=this._soundSource;p.onended=()=>{p.disconnect()}}if(this._soundSource=(h=k.audioEngine)===null||h===void 0?void 0:h.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,t!==void 0&&(this._soundSource.loopStart=t),i!==void 0&&(this._soundSource.loopEnd=(t|0)+i),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},l=e?((d=k.audioEngine)===null||d===void 0?void 0:d.audioContext.currentTime)+e:k.audioEngine.audioContext.currentTime;const p=((this.isPaused?this.currentTime:0)+((f=this._offset)!==null&&f!==void 0?f:0))%this._soundSource.buffer.duration;this._soundSource.start(l,p,this.loop?void 0:i)}}};((o=k.audioEngine)===null||o===void 0?void 0:o.audioContext.state)==="suspended"?this._tryToPlayTimeout=setTimeout(()=>{var u;((u=k.audioEngine)===null||u===void 0?void 0:u.audioContext.state)==="suspended"?(k.audioEngine.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=k.audioEngine.onAudioUnlockedObservable.addOnce(()=>{c()}))):c()},500):c()}this._startTime=l,this.isPlaying=!0,this.isPaused=!1}catch(l){U.Error("Error while trying to play audio: "+this.name+", "+l.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(e){var t;if(this.isPlaying)if(this._clearTimeoutsAndObservers(),this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource.disconnect(),this.isPlaying=!1;else if(!((t=k.audioEngine)===null||t===void 0)&&t.audioContext&&this._soundSource){const i=e?k.audioEngine.audioContext.currentTime+e:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(i)}else this.isPlaying=!1;else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){var e;this.isPlaying&&(this._clearTimeoutsAndObservers(),this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource.disconnect(),this.isPlaying=!1,this.isPaused=!0):!((e=k.audioEngine)===null||e===void 0)&&e.audioContext&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=k.audioEngine.audioContext.currentTime-this._startTime))}setVolume(e,t){var i;!((i=k.audioEngine)===null||i===void 0)&&i.canUseWebAudio&&this._soundGain&&(t&&k.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(k.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,k.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,k.audioEngine.audioContext.currentTime+t)):this._soundGain.gain.value=e),this._volume=e}setPlaybackRate(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=t=>this._onRegisterAfterWorldMatrixUpdate(t),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(e){var t;if(!e.getBoundingInfo)this.setPosition(e.absolutePosition);else{const n=e.getBoundingInfo();this.setPosition(n.boundingSphere.centerWorld)}!((t=k.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{const e=()=>{this._isReadyToPlay?(i._audioBuffer=this.getAudioBuffer(),i._isReadyToPlay=!0,i.autoplay&&i.play(0,this._offset,this._length)):setTimeout(e,300)},t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},i=new es(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,t);return this.useCustomAttenuation&&i.setAttenuationFunction(this._customAttenuationFunction),i.setPosition(this._position),i.setPlaybackRate(this._playbackRate),e(),i}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){const e={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e}static Parse(e,t,i,n){const r=e.name;let a;e.url?a=i+e.url:a=i+r;const o={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate};let l;if(!n)l=new es(r,a,t,()=>{t.removePendingData(l)},o),t.addPendingData(l);else{const c=()=>{n._isReadyToPlay?(l._audioBuffer=n.getAudioBuffer(),l._isReadyToPlay=!0,l.autoplay&&l.play(0,l._offset,l._length)):setTimeout(c,300)};l=new es(r,new ArrayBuffer(0),t,null,o),c()}if(e.position){const c=g.FromArray(e.position);l.setPosition(c)}if(e.isDirectional&&(l.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){const c=g.FromArray(e.localDirectionToMesh);l.setLocalDirectionToMesh(c)}if(e.connectedMeshId){const c=t.getMeshById(e.connectedMeshId);c&&l.attachToMesh(c)}return e.metadata&&(l.metadata=e.metadata),l}_setOffset(e){this._offset!==e&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=e)}_clearTimeoutsAndObservers(){var e;this._tryToPlayTimeout&&(clearTimeout(this._tryToPlayTimeout),this._tryToPlayTimeout=null),this._audioUnlockedObserver&&((e=k.audioEngine)===null||e===void 0||e.onAudioUnlockedObservable.remove(this._audioUnlockedObserver),this._audioUnlockedObserver=null)}}es._SceneComponentInitialization=s=>{throw De("AudioSceneComponent")};class nx{constructor(e,t,i){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==i.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=i;let n=0;for(const a of i)n+=a;const r=n>0?1/n:0;for(let a=0;a<this._weights.length;a++)this._weights[a]*=r;this._sounds=t;for(const a of this._sounds)a.onEndedObservable.add(()=>{this._onended()})}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e){U.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e;for(const t of this._sounds)t.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle){U.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e;for(const t of this._sounds)t.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(const t of this._sounds)t.setVolume(e)}_onended(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause()}stop(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();const i=Math.random();let n=0;for(let r=0;r<this._weights.length;r++)if(n+=this._weights[r],i<=n){this._currentIndex=r;break}}const t=this._sounds[this._currentIndex];t.isReady()?t.play(0,this.isPaused?void 0:e):t.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}}const Df="MSFT_audio_emitter";class sx{constructor(e){this.name=Df,this._loader=e,this.enabled=this._loader.isExtensionUsed(Df)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,xe.Assign(this._clips),xe.Assign(this._emitters)}}loadSceneAsync(e,t){return ce.LoadExtensionAsync(e,t,this.name,(i,n)=>{const r=new Array;r.push(this._loader.loadSceneAsync(e,t));for(const a of n.emitters){const o=xe.Get(`${i}/emitters`,this._emitters,a);if(o.refDistance!=null||o.maxDistance!=null||o.rolloffFactor!=null||o.distanceModel!=null||o.innerAngle!=null||o.outerAngle!=null)throw new Error(`${i}: Direction or Distance properties are not allowed on emitters attached to a scene`);r.push(this._loadEmitterAsync(`${i}/emitters/${o.index}`,o))}return Promise.all(r).then(()=>{})})}loadNodeAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{const a=new Array;return this._loader.loadNodeAsync(n,t,o=>{for(const l of r.emitters){const c=xe.Get(`${n}/emitters`,this._emitters,l);a.push(this._loadEmitterAsync(`${n}/emitters/${c.index}`,c).then(()=>{for(const u of c._babylonSounds)u.attachToMesh(o),(c.innerAngle!=null||c.outerAngle!=null)&&(u.setLocalDirectionToMesh(g.Forward()),u.setDirectionalCone(2*q.ToDegrees(c.innerAngle==null?Math.PI:c.innerAngle),2*q.ToDegrees(c.outerAngle==null?Math.PI:c.outerAngle),0))}))}i(o)}).then(o=>Promise.all(a).then(()=>o))})}loadAnimationAsync(e,t){return ce.LoadExtensionAsync(e,t,this.name,(i,n)=>this._loader.loadAnimationAsync(e,t).then(r=>{const a=new Array;xe.Assign(n.events);for(const o of n.events)a.push(this._loadAnimationEventAsync(`${i}/events/${o.index}`,e,t,o,r));return Promise.all(a).then(()=>r)}))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let i;if(t.uri)i=this._loader.loadUriAsync(e,t,t.uri);else{const n=xe.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);i=this._loader.loadBufferViewAsync(`/bufferViews/${n.index}`,n)}return t._objectURL=i.then(n=>URL.createObjectURL(new Blob([n],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const i=new Array,n=t.name||`emitter${t.index}`,r={loop:!1,autoplay:!1,volume:t.volume==null?1:t.volume};for(let o=0;o<t.clips.length;o++){const l=`/extensions/${this.name}/clips`,c=xe.Get(l,this._clips,t.clips[o].clip);i.push(this._loadClipAsync(`${l}/${t.clips[o].clip}`,c).then(u=>{const h=t._babylonSounds[o]=new es(n,u,this._loader.babylonScene,null,r);h.refDistance=t.refDistance||1,h.maxDistance=t.maxDistance||256,h.rolloffFactor=t.rolloffFactor||1,h.distanceModel=t.distanceModel||"exponential"}))}const a=Promise.all(i).then(()=>{const o=t.clips.map(c=>c.weight||1),l=new nx(t.loop||!1,t._babylonSounds,o);t.innerAngle&&(l.directionalConeInnerAngle=2*q.ToDegrees(t.innerAngle)),t.outerAngle&&(l.directionalConeOuterAngle=2*q.ToDegrees(t.outerAngle)),t.volume&&(l.volume=t.volume),t._babylonData.sound=l});t._babylonData={loaded:a}}return t._babylonData.loaded}_getEventAction(e,t,i,n,r){switch(i){case"play":return a=>{const o=(r||0)+(a-n);t.play(o)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${i}`)}}_loadAnimationEventAsync(e,t,i,n,r){if(r.targetedAnimations.length==0)return Promise.resolve();const a=r.targetedAnimations[0],o=n.emitter,l=xe.Get(`/extensions/${this.name}/emitters`,this._emitters,o);return this._loadEmitterAsync(e,l).then(()=>{const c=l._babylonData.sound;if(c){const u=new om(n.time,this._getEventAction(e,c,n.action,n.time,n.startOffset));a.animation.addEvent(u),r.onAnimationGroupEndObservable.add(()=>{c.stop()}),r.onAnimationGroupPauseObservable.add(()=>{c.pause()})}})}}ce.RegisterExtension(Df,s=>new sx(s));const Of="MSFT_lod";class rx{constructor(e){this.name=Of,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new O,this.onMaterialLODsLoadedObservable=new O,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed(Of)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const t=Promise.all(this._nodePromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){const t=Promise.all(this._materialPromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){const i=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),i}loadNodeAsync(e,t,i){return ce.LoadExtensionAsync(e,t,this.name,(n,r)=>{let a;const o=this._getLODs(n,t,this._loader.gltf.nodes,r.ids);this._loader.logOpen(`${n}`);for(let l=0;l<o.length;l++){const c=o[l];l!==0&&(this._nodeIndexLOD=l,this._nodeSignalLODs[l]=this._nodeSignalLODs[l]||new jo);const u=d=>{i(d),d.setEnabled(!1)},h=this._loader.loadNodeAsync(`/nodes/${c.index}`,c,u).then(d=>{if(l!==0){const f=o[l-1];f._babylonTransformNode&&(this._disposeTransformNode(f._babylonTransformNode),delete f._babylonTransformNode)}return d.setEnabled(!0),d});this._nodePromiseLODs[l]=this._nodePromiseLODs[l]||[],l===0?a=h:(this._nodeIndexLOD=null,this._nodePromiseLODs[l].push(h))}return this._loader.logClose(),a})}_loadMaterialAsync(e,t,i,n,r){return this._nodeIndexLOD?null:ce.LoadExtensionAsync(e,t,this.name,(a,o)=>{let l;const c=this._getLODs(a,t,this._loader.gltf.materials,o.ids);this._loader.logOpen(`${a}`);for(let u=0;u<c.length;u++){const h=c[u];u!==0&&(this._materialIndexLOD=u);const d=this._loader._loadMaterialAsync(`/materials/${h.index}`,h,i,n,f=>{u===0&&r(f)}).then(f=>{if(u!==0){r(f);const p=c[u-1]._data;p[n]&&(this._disposeMaterials([p[n].babylonMaterial]),delete p[n])}return f});this._materialPromiseLODs[u]=this._materialPromiseLODs[u]||[],u===0?l=d:(this._materialIndexLOD=null,this._materialPromiseLODs[u].push(d))}return this._loader.logClose(),l})}_loadUriAsync(e,t,i){if(this._nodeIndexLOD!==null){this._loader.log("deferred");const n=this._nodeIndexLOD-1;return this._nodeSignalLODs[n]=this._nodeSignalLODs[n]||new jo,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(()=>this._loader.loadUriAsync(e,t,i))}else if(this._materialIndexLOD!==null){this._loader.log("deferred");const n=this._materialIndexLOD-1;return this._materialSignalLODs[n]=this._materialSignalLODs[n]||new jo,this._materialSignalLODs[n].promise.then(()=>this._loader.loadUriAsync(e,t,i))}return null}loadBufferAsync(e,t,i,n){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const r=(a,o)=>{const l=i,c=l+n-1;let u=a[o];return u?(u.start=Math.min(u.start,l),u.end=Math.max(u.end,c)):(u={start:l,end:c,loaded:new jo},a[o]=u),u.loaded.promise.then(h=>new Uint8Array(h.buffer,h.byteOffset+i-u.start,n))};return this._loader.log("deferred"),this._nodeIndexLOD!==null?r(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?r(this._materialBufferLODs,this._materialIndexLOD):r(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){const i=e[t];i&&(this._loader.log(`Loading buffer range [${i.start}-${i.end}]`),this._loader.bin.readAsync(i.start,i.end-i.start+1).then(n=>{i.loaded.resolve(n)},n=>{i.loaded.reject(n)}))}_getLODs(e,t,i,n){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const r=new Array;for(let a=n.length-1;a>=0;a--)if(r.push(xe.Get(`${e}/ids/${n[a]}`,i,n[a])),r.length===this.maxLODsToLoad)return r;return r.push(t),r}_disposeTransformNode(e){const t=new Array,i=e.material;i&&t.push(i);for(const r of e.getChildMeshes())r.material&&t.push(r.material);e.dispose();const n=t.filter(r=>this._loader.babylonScene.meshes.every(a=>a.material!=r));this._disposeMaterials(n)}_disposeMaterials(e){const t={};for(const i of e){for(const n of i.getActiveTextures())t[n.uniqueId]=n;i.dispose()}for(const i in t)for(const n of this._loader.babylonScene.materials)n.hasTexture(t[i])&&delete t[i];for(const i in t)t[i].dispose()}}ce.RegisterExtension(Of,s=>new rx(s));const wf="MSFT_minecraftMesh";class ax{constructor(e){this.name=wf,this._loader=e,this.enabled=this._loader.isExtensionUsed(wf)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ce.LoadExtraAsync(e,t,this.name,(n,r)=>{if(r){if(!(i instanceof oe))throw new Error(`${n}: Material type not supported`);const a=this._loader.loadMaterialPropertiesAsync(e,t,i);return i.needAlphaBlending()&&(i.forceDepthWrite=!0,i.separateCullingPass=!0),i.backFaceCulling=i.forceDepthWrite,i.twoSidedLighting=!0,a}return null})}}ce.RegisterExtension(wf,s=>new ax(s));const Ff="MSFT_sRGBFactors";class ox{constructor(e){this.name=Ff,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ff)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ce.LoadExtraAsync(e,t,this.name,(n,r)=>{if(r){if(!(i instanceof oe))throw new Error(`${n}: Material type not supported`);const a=this._loader.loadMaterialPropertiesAsync(e,t,i),o=i.getScene().getEngine().useExactSrgbConversions;return i.albedoTexture||i.albedoColor.toLinearSpaceToRef(i.albedoColor,o),i.reflectivityTexture||i.reflectivityColor.toLinearSpaceToRef(i.reflectivityColor,o),a}return null})}}ce.RegisterExtension(Ff,s=>new ox(s));const VE="ExtrasAsMetadata";class lx{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){const i=e.metadata=e.metadata||{},n=i.gltf=i.gltf||{};n.extras=t.extras}}constructor(e){this.name=VE,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,i){return this._loader.loadNodeAsync(e,t,n=>{this._assignExtras(n,t),i(n)})}loadCameraAsync(e,t,i){return this._loader.loadCameraAsync(e,t,n=>{this._assignExtras(n,t),i(n)})}createMaterial(e,t,i){const n=this._loader.createMaterial(e,t,i);return this._assignExtras(n,t),n}}ce.RegisterExtension(VE,s=>new lx(s));const cx={iCoin:{key:"iCoin",weight:0,sellPrice:0},iLog:{key:"iLog",weight:1,sellPrice:1},iWater:{key:"iWater",weight:1,sellPrice:0},iCorn:{key:"iCorn",weight:1,sellPrice:1},iWheat:{key:"iWheat",weight:1,sellPrice:1},iApple:{key:"iApple",weight:1,sellPrice:1},iPlank:{key:"iPlank",weight:1,sellPrice:1},video:{key:"video",weight:1,sellPrice:0},iFlour:{key:"iFlour",weight:1,sellPrice:1},iBread:{key:"iBread",weight:1,sellPrice:1},iAleBarrel:{key:"iAleBarrel",weight:1,sellPrice:1},iBook:{key:"iBook",weight:1,sellPrice:0},iOre:{key:"iOre",weight:1,sellPrice:0},iWool:{key:"iWool",weight:1,sellPrice:1},iIron:{key:"iIron",weight:1,sellPrice:1},iStrength:{key:"iStrength",weight:0,sellPrice:0},iHp:{key:"iHp",weight:0,sellPrice:0},iCrystal:{key:"iCrystal",weight:1,sellPrice:1},iGem:{key:"iGem",weight:1,sellPrice:1}},ux={pHome:{key:"pHome",speed:null,inputCapacity:0,outputCapacity:0,unlockItem:"iLog",unlockAmount:3,durability:100},pMarket:{key:"pMarket",speed:null,inputCapacity:4,outputCapacity:null,unlockItem:"iCoin",unlockAmount:10,durability:100},pSawmill:{key:"pSawmill",speed:350,inputCapacity:4,outputCapacity:4,unlockItem:"iCoin",unlockAmount:10,durability:100},pWell:{key:"pWell",speed:660,inputCapacity:null,outputCapacity:1,unlockItem:"iLog",unlockAmount:8,durability:100},pMill:{key:"pMill",speed:300,inputCapacity:4,outputCapacity:4,unlockItem:"iCoin",unlockAmount:50,durability:100},pWheatGarden:{key:"pWheatGarden",speed:400,inputCapacity:4,outputCapacity:4,unlockItem:"iCoin",unlockAmount:10,durability:100},pAppleGarden:{key:"pAppleGarden",speed:400,inputCapacity:4,outputCapacity:4,unlockItem:"iCoin",unlockAmount:140,durability:100},pPub:{key:"pPub",speed:50,inputCapacity:4,outputCapacity:40,unlockItem:"iCoin",unlockAmount:400,durability:100},pBaker:{key:"pBaker",speed:250,inputCapacity:4,outputCapacity:4,unlockItem:"iCoin",unlockAmount:130,durability:100},pWinery:{key:"pWinery",speed:200,inputCapacity:4,outputCapacity:4,unlockItem:"iCoin",unlockAmount:200,durability:100},pWall:{key:"pWall",speed:0,inputCapacity:0,outputCapacity:0,unlockItem:"iLog",unlockAmount:55,durability:100},pHunter:{key:"pHunter",speed:50,inputCapacity:4,outputCapacity:40,unlockItem:"iCoin",unlockAmount:200,durability:100},pLogNpc:{key:"pLogNpc",speed:null,inputCapacity:3,outputCapacity:null,unlockItem:"iCoin",unlockAmount:25,durability:10},pWaterNpc:{key:"pWaterNpc",speed:null,inputCapacity:3,outputCapacity:null,unlockItem:"iCoin",unlockAmount:60,durability:10},pMillerNpc:{key:"pMillerNpc",speed:null,inputCapacity:3,outputCapacity:null,unlockItem:"iCoin",unlockAmount:250,durability:10},pAppleNpc:{key:"pAppleNpc",speed:null,inputCapacity:3,outputCapacity:null,unlockItem:"iCoin",unlockAmount:800,durability:10},pDock:{key:"pDock",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:"iPlank",unlockAmount:12,durability:100},pFisherman:{key:"pFisherman",speed:50,inputCapacity:4,outputCapacity:9999999,unlockItem:"iCoin",unlockAmount:100,durability:100},pShip:{key:"pShip",speed:50,inputCapacity:10,outputCapacity:200,unlockItem:"iCoin",unlockAmount:2e3,durability:100},pLaboratory:{key:"pLaboratory",speed:50,inputCapacity:100,outputCapacity:10,unlockItem:"iCoin",unlockAmount:4100,durability:null},pDock2:{key:"pDock2",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:"iPlank",unlockAmount:80,durability:null},pBalloon:{key:"pBalloon",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:"iBook",unlockAmount:50,durability:null},pPlayer:{key:"pPlayer",speed:null,inputCapacity:0,outputCapacity:null,unlockItem:null,unlockAmount:null,durability:null},pGlobalEffector:{key:"pGlobalEffector",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:null,unlockAmount:null,durability:null},pManagerNpc:{key:"pManagerNpc",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:null,unlockAmount:null,durability:null},pThiefNpc:{key:"pThiefNpc",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:null,unlockAmount:null,durability:null},pHairdresser:{key:"pHairdresser",speed:0,inputCapacity:0,outputCapacity:0,unlockItem:"iCoin",unlockAmount:150,durability:100},pTailor:{key:"pTailor",speed:0,inputCapacity:0,outputCapacity:0,unlockItem:"iCoin",unlockAmount:1e3,durability:100},pHut1:{key:"pHut1",speed:50,inputCapacity:null,outputCapacity:5,unlockItem:"iLog",unlockAmount:24,durability:100},pHut2:{key:"pHut2",speed:50,inputCapacity:null,outputCapacity:10,unlockItem:"iLog",unlockAmount:70,durability:100},pSawmillWorkerNpc:{key:"pSawmillWorkerNpc",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:null,unlockAmount:null,durability:3},pMillWorkerNpc:{key:"pMillWorkerNpc",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:null,unlockAmount:null,durability:3},pBakerWorkerNpc:{key:"pBakerWorkerNpc",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:null,unlockAmount:null,durability:3},pWineryWorkerNpc:{key:"pWineryWorkerNpc",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:null,unlockAmount:null,durability:3},pScientistNpc:{key:"pScientistNpc",speed:null,inputCapacity:3,outputCapacity:null,unlockItem:null,unlockAmount:null,durability:null},pMine:{key:"pMine",speed:450,inputCapacity:null,outputCapacity:1,unlockItem:"iCoin",unlockAmount:3500,durability:100},pForge:{key:"pForge",speed:250,inputCapacity:4,outputCapacity:4,unlockItem:"iCoin",unlockAmount:2700,durability:100},pCornField:{key:"pCornField",speed:400,inputCapacity:4,outputCapacity:4,unlockItem:"iCoin",unlockAmount:3500,durability:100},pFarm:{key:"pFarm",speed:250,inputCapacity:4,outputCapacity:4,unlockItem:"iCoin",unlockAmount:4e3,durability:100},pArena:{key:"pArena",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:"iCoin",unlockAmount:35,durability:null},pMinerNpc:{key:"pMinerNpc",speed:null,inputCapacity:2,outputCapacity:null,unlockItem:"iCoin",unlockAmount:3e3,durability:10},pBlacksmithNpc:{key:"pBlacksmithNpc",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:null,unlockAmount:null,durability:3},pFarmerNpc:{key:"pFarmerNpc",speed:null,inputCapacity:3,outputCapacity:null,unlockItem:"iCoin",unlockAmount:4e3,durability:5},pTrainerStrengthNpc:{key:"pTrainerStrengthNpc",speed:3e3,inputCapacity:10,outputCapacity:999,unlockItem:null,unlockAmount:null,durability:null},pTrainerHpNpc:{key:"pTrainerHpNpc",speed:3e3,inputCapacity:10,outputCapacity:999,unlockItem:null,unlockAmount:null,durability:null},pHomeMap:{key:"pHomeMap",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:null,unlockAmount:null,durability:null},pClimb:{key:"pClimb",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:"iPlank",unlockAmount:60,durability:null},pSnowFireplace:{key:"pSnowFireplace",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:"iLog",unlockAmount:80,durability:null},pSnowHut:{key:"pSnowHut",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:"iCoin",unlockAmount:3e3,durability:null},pSnowCave:{key:"pSnowCave",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:"iCoin",unlockAmount:3500,durability:null},pCaveLight:{key:"pCaveLight",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:"iAleBarrel",unlockAmount:70,durability:null},pCaveBridge1:{key:"pCaveBridge1",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:"iIron",unlockAmount:70,durability:null},pCaveBridge2:{key:"pCaveBridge2",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:"iIron",unlockAmount:100,durability:null},pCaveCrystal:{key:"pCaveCrystal",speed:500,inputCapacity:50,outputCapacity:1,unlockItem:"iCoin",unlockAmount:4e3,durability:null},pJewelerNpc:{key:"pJewelerNpc",speed:1e3,inputCapacity:5,outputCapacity:1,unlockItem:"iCoin",unlockAmount:3800,durability:null},pPubMap:{key:"pPubMap",speed:null,inputCapacity:null,outputCapacity:null,unlockItem:null,unlockAmount:null,durability:null}},hx={defaultClickProduceDuration:{key:"defaultClickProduceDuration",value:1e3,description:"some number"},defaultProduceDuration:{key:"defaultProduceDuration",value:1e3,description:"some string"},initialInventoryCapacity:{key:"initialInventoryCapacity",value:100,description:"in gramms"}},dx={iLog8_iCoin8:{key:"iLog8_iCoin8",item:"iLog",count:8,awardType:"iCoin",awardCount:8},iPlank12_iCoin12:{key:"iPlank12_iCoin12",item:"iPlank",count:12,awardType:"iCoin",awardCount:12},iWheat15_iCoin15:{key:"iWheat15_iCoin15",item:"iWheat",count:15,awardType:"iCoin",awardCount:15},iPlank14_iCoin14:{key:"iPlank14_iCoin14",item:"iPlank",count:14,awardType:"iCoin",awardCount:14},iFlour20_iCoin20:{key:"iFlour20_iCoin20",item:"iFlour",count:20,awardType:"iCoin",awardCount:20},iLog25_iCoin25:{key:"iLog25_iCoin25",item:"iLog",count:25,awardType:"iCoin",awardCount:25},iBread20_iCoin20:{key:"iBread20_iCoin20",item:"iBread",count:20,awardType:"iCoin",awardCount:20},iPlank25_iCoin25:{key:"iPlank25_iCoin25",item:"iPlank",count:25,awardType:"iCoin",awardCount:25},iApple35_iCoin35:{key:"iApple35_iCoin35",item:"iApple",count:35,awardType:"iCoin",awardCount:35},iBread30_iCoin30:{key:"iBread30_iCoin30",item:"iBread",count:30,awardType:"iCoin",awardCount:30},iAleBarrel25_iCoin25:{key:"iAleBarrel25_iCoin25",item:"iAleBarrel",count:25,awardType:"iCoin",awardCount:25},iPlank50_iCoin50:{key:"iPlank50_iCoin50",item:"iPlank",count:50,awardType:"iCoin",awardCount:50},iFlour100_iCoin100:{key:"iFlour100_iCoin100",item:"iFlour",count:100,awardType:"iCoin",awardCount:100},iApple150_iCoin150:{key:"iApple150_iCoin150",item:"iApple",count:150,awardType:"iCoin",awardCount:150},iLog120_iCoin120:{key:"iLog120_iCoin120",item:"iLog",count:120,awardType:"iCoin",awardCount:120}},fx={attBaseMovementSpeed:{key:"attBaseMovementSpeed"},attMovementSpeed:{key:"attMovementSpeed"},attTotalMovementSpeed:{key:"attTotalMovementSpeed"},attInventoryBaseCapacity:{key:"attInventoryBaseCapacity"},attInventoryCapacity:{key:"attInventoryCapacity"},attInventoryTotalCapacity:{key:"attInventoryTotalCapacity"},attBasePickingSpeed:{key:"attBasePickingSpeed"},attPickingSpeed:{key:"attPickingSpeed"},attTotalPickingSpeed:{key:"attTotalPickingSpeed"},attBasePickingDistance:{key:"attBasePickingDistance"},attPickingDistance:{key:"attPickingDistance"},attTotalPickingDistance:{key:"attTotalPickingDistance"},attBasePickCoinsMultiplier:{key:"attBasePickCoinsMultiplier"},attPickCoinsMultiplier:{key:"attPickCoinsMultiplier"},attTotalPickCoinsMultiplier:{key:"attTotalPickCoinsMultiplier"},attBaseOutputCapacity:{key:"attBaseOutputCapacity"},attOutputCapacity:{key:"attOutputCapacity"},attTotalOutputCapacity:{key:"attTotalOutputCapacity"},attBaseSupplySpeed:{key:"attBaseSupplySpeed"},attSupplySpeed:{key:"attSupplySpeed"},attTotalSupplySpeed:{key:"attTotalSupplySpeed"},attBaseProducingSpeed:{key:"attBaseProducingSpeed"},attProducingSpeed:{key:"attProducingSpeed"},attTotalProducingSpeed:{key:"attTotalProducingSpeed"},attBaseMaxDurability:{key:"attBaseMaxDurability"},attMaxDurability:{key:"attMaxDurability"},attTotalMaxDurability:{key:"attTotalMaxDurability"},attBaseChoppingSpeed:{key:"attBaseChoppingSpeed"},attChoppingSpeed:{key:"attChoppingSpeed"},attTotalChoppingSpeed:{key:"attTotalChoppingSpeed"},attStr:{key:"attStr"},attVit:{key:"attVit"},attBaseStr:{key:"attBaseStr"},attTotalStr:{key:"attTotalStr"},attBaseVit:{key:"attBaseVit"},attTotalVit:{key:"attTotalVit"},attMaxHp:{key:"attMaxHp"},attMinDmg:{key:"attMinDmg"},attMaxDmg:{key:"attMaxDmg"},attAttackSpeed:{key:"attAttackSpeed"},attCritChance:{key:"attCritChance"},attExcellentChance:{key:"attExcellentChance"}},px={eSawmillProducingSpeed1:{key:"eSawmillProducingSpeed1",attr:"attProducingSpeed",op:"mul",val:.2,duration:null,target:"pSawmill",level:1,price:5,name:"SawmillProducingSpeed","":null},eSawmillProducingSpeed2:{key:"eSawmillProducingSpeed2",attr:"attProducingSpeed",op:"mul",val:.3,duration:null,target:"pSawmill",level:2,price:10,name:"SawmillProducingSpeed","":null},eSawmillProducingSpeed3:{key:"eSawmillProducingSpeed3",attr:"attProducingSpeed",op:"mul",val:.3,duration:null,target:"pSawmill",level:3,price:20,name:"SawmillProducingSpeed","":null},eSawmillInventoryCapacity1:{key:"eSawmillInventoryCapacity1",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pSawmill",level:1,price:5,name:"SawmillInventoryCapacity","":null},eSawmillInventoryCapacity2:{key:"eSawmillInventoryCapacity2",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pSawmill",level:2,price:10,name:"SawmillInventoryCapacity","":null},eSawmillInventoryCapacity3:{key:"eSawmillInventoryCapacity3",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pSawmill",level:3,price:20,name:"SawmillInventoryCapacity","":null},eSawmillOutputCapacity1:{key:"eSawmillOutputCapacity1",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pSawmill",level:1,price:0,name:"SawmillOutputCapacity","":null},eSawmillOutputCapacity2:{key:"eSawmillOutputCapacity2",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pSawmill",level:2,price:0,name:"SawmillOutputCapacity","":null},eSawmillOutputCapacity3:{key:"eSawmillOutputCapacity3",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pSawmill",level:3,price:0,name:"SawmillOutputCapacity","":null},ePlayerInventoryCapacity1:{key:"ePlayerInventoryCapacity1",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pPlayer",level:1,price:0,name:"PlayerInventoryCapacity","":null},ePlayerInventoryCapacity2:{key:"ePlayerInventoryCapacity2",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pPlayer",level:2,price:250,name:"PlayerInventoryCapacity","":null},ePlayerInventoryCapacity3:{key:"ePlayerInventoryCapacity3",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pPlayer",level:3,price:500,name:"PlayerInventoryCapacity","":null},eWheatGardenProducingSpeed1:{key:"eWheatGardenProducingSpeed1",attr:"attProducingSpeed",op:"mul",val:.3,duration:null,target:"pWheatGarden",level:1,price:8,name:"WheatGardenProducingSpeed","":null},eWheatGardenProducingSpeed2:{key:"eWheatGardenProducingSpeed2",attr:"attProducingSpeed",op:"mul",val:.3,duration:null,target:"pWheatGarden",level:2,price:15,name:"WheatGardenProducingSpeed","":null},eWheatGardenProducingSpeed3:{key:"eWheatGardenProducingSpeed3",attr:"attProducingSpeed",op:"mul",val:.3,duration:null,target:"pWheatGarden",level:3,price:20,name:"WheatGardenProducingSpeed","":null},eWheatGardenInventoryCapacity1:{key:"eWheatGardenInventoryCapacity1",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pWheatGarden",level:1,price:8,name:"WheatGardenInventoryCapacity","":null},eWheatGardenInventoryCapacity2:{key:"eWheatGardenInventoryCapacity2",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pWheatGarden",level:2,price:15,name:"WheatGardenInventoryCapacity","":null},eWheatGardenInventoryCapacity3:{key:"eWheatGardenInventoryCapacity3",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pWheatGarden",level:3,price:20,name:"WheatGardenInventoryCapacity","":null},eWheatGardenOutputCapacity1:{key:"eWheatGardenOutputCapacity1",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pWheatGarden",level:1,price:0,name:"WheatGardenOutputCapacity","":null},eWheatGardenOutputCapacity2:{key:"eWheatGardenOutputCapacity2",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pWheatGarden",level:2,price:0,name:"WheatGardenOutputCapacity","":null},eWheatGardenOutputCapacity3:{key:"eWheatGardenOutputCapacity3",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pWheatGarden",level:3,price:0,name:"WheatGardenOutputCapacity","":null},eMillProducingSpeed1:{key:"eMillProducingSpeed1",attr:"attProducingSpeed",op:"mul",val:.5,duration:null,target:"pMill",level:1,price:25,name:"MillProducingSpeed","":null},eMillProducingSpeed2:{key:"eMillProducingSpeed2",attr:"attProducingSpeed",op:"mul",val:.5,duration:null,target:"pMill",level:2,price:40,name:"MillProducingSpeed","":null},eMillProducingSpeed3:{key:"eMillProducingSpeed3",attr:"attProducingSpeed",op:"mul",val:.5,duration:null,target:"pMill",level:3,price:60,name:"MillProducingSpeed","":null},eMillInventoryCapacity1:{key:"eMillInventoryCapacity1",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pMill",level:1,price:25,name:"MillInventoryCapacity","":null},eMillInventoryCapacity2:{key:"eMillInventoryCapacity2",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pMill",level:2,price:40,name:"MillInventoryCapacity","":null},eMillInventoryCapacity3:{key:"eMillInventoryCapacity3",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pMill",level:3,price:60,name:"MillInventoryCapacity","":null},eMillOutputCapacity1:{key:"eMillOutputCapacity1",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pMill",level:1,price:0,name:"MillOutputCapacity","":null},eMillOutputCapacity2:{key:"eMillOutputCapacity2",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pMill",level:2,price:0,name:"MillOutputCapacity","":null},eMillOutputCapacity3:{key:"eMillOutputCapacity3",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pMill",level:3,price:0,name:"MillOutputCapacity","":null},eLogNpcMovementSpeed1:{key:"eLogNpcMovementSpeed1",attr:"attMovementSpeed",op:"mul",val:.5,duration:null,target:"pLogNpc",level:1,price:10,name:"LogNpcMovementSpeed","":null},eLogNpcMovementSpeed2:{key:"eLogNpcMovementSpeed2",attr:"attMovementSpeed",op:"mul",val:.5,duration:null,target:"pLogNpc",level:2,price:14,name:"LogNpcMovementSpeed","":null},eLogNpcMovementSpeed3:{key:"eLogNpcMovementSpeed3",attr:"attMovementSpeed",op:"mul",val:.5,duration:null,target:"pLogNpc",level:3,price:20,name:"LogNpcMovementSpeed","":null},eWaterNpcInventoryCapacity1:{key:"eWaterNpcInventoryCapacity1",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pWaterNpc",level:1,price:20,name:"WaterNpcInventoryCapacity","":null},eWaterNpcInventoryCapacity2:{key:"eWaterNpcInventoryCapacity2",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pWaterNpc",level:2,price:40,name:"WaterNpcInventoryCapacity","":null},eWaterNpcInventoryCapacity3:{key:"eWaterNpcInventoryCapacity3",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pWaterNpc",level:3,price:80,name:"WaterNpcInventoryCapacity","":null},eWaterNpcMovementSpeed1:{key:"eWaterNpcMovementSpeed1",attr:"attMovementSpeed",op:"mul",val:.5,duration:null,target:"pWaterNpc",level:1,price:20,name:"WaterNpcMovementSpeed","":null},eWaterNpcMovementSpeed2:{key:"eWaterNpcMovementSpeed2",attr:"attMovementSpeed",op:"mul",val:.5,duration:null,target:"pWaterNpc",level:2,price:40,name:"WaterNpcMovementSpeed","":null},eWaterNpcMovementSpeed3:{key:"eWaterNpcMovementSpeed3",attr:"attMovementSpeed",op:"mul",val:.5,duration:null,target:"pWaterNpc",level:3,price:60,name:"WaterNpcMovementSpeed","":null},eWellProducingSpeed1:{key:"eWellProducingSpeed1",attr:"attProducingSpeed",op:"mul",val:.5,duration:null,target:"pWell",level:1,price:5,name:"WellProducingSpeed","":null},eWellProducingSpeed2:{key:"eWellProducingSpeed2",attr:"attProducingSpeed",op:"mul",val:.5,duration:null,target:"pWell",level:2,price:10,name:"WellProducingSpeed","":null},eWellProducingSpeed3:{key:"eWellProducingSpeed3",attr:"attProducingSpeed",op:"mul",val:.5,duration:null,target:"pWell",level:3,price:15,name:"WellProducingSpeed","":null},eBakerProducingSpeed1:{key:"eBakerProducingSpeed1",attr:"attProducingSpeed",op:"mul",val:.5,duration:null,target:"pBaker",level:1,price:80,name:"BakerProducingSpeed","":null},eBakerProducingSpeed2:{key:"eBakerProducingSpeed2",attr:"attProducingSpeed",op:"mul",val:.5,duration:null,target:"pBaker",level:2,price:120,name:"BakerProducingSpeed","":null},eBakerProducingSpeed3:{key:"eBakerProducingSpeed3",attr:"attProducingSpeed",op:"mul",val:.5,duration:null,target:"pBaker",level:3,price:150,name:"BakerProducingSpeed","":null},eBakerInventoryCapacity1:{key:"eBakerInventoryCapacity1",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pBaker",level:1,price:80,name:"BakerInventoryCapacity","":null},eBakerInventoryCapacity2:{key:"eBakerInventoryCapacity2",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pBaker",level:2,price:120,name:"BakerInventoryCapacity","":null},eBakerInventoryCapacity3:{key:"eBakerInventoryCapacity3",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pBaker",level:3,price:150,name:"BakerInventoryCapacity","":null},eBakerOutputCapacity1:{key:"eBakerOutputCapacity1",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pBaker",level:1,price:0,name:"BakerOutputCapacity","":null},eBakerOutputCapacity2:{key:"eBakerOutputCapacity2",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pBaker",level:2,price:0,name:"BakerOutputCapacity","":null},eBakerOutputCapacity3:{key:"eBakerOutputCapacity3",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pBaker",level:3,price:0,name:"BakerOutputCapacity","":null},eWineryProducingSpeed1:{key:"eWineryProducingSpeed1",attr:"attProducingSpeed",op:"mul",val:.5,duration:null,target:"pWinery",level:1,price:90,name:"WineryProducingSpeed","":null},eWineryProducingSpeed2:{key:"eWineryProducingSpeed2",attr:"attProducingSpeed",op:"mul",val:.5,duration:null,target:"pWinery",level:2,price:140,name:"WineryProducingSpeed","":null},eWineryProducingSpeed3:{key:"eWineryProducingSpeed3",attr:"attProducingSpeed",op:"mul",val:.5,duration:null,target:"pWinery",level:3,price:170,name:"WineryProducingSpeed","":null},eWineryInventoryCapacity1:{key:"eWineryInventoryCapacity1",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pWinery",level:1,price:90,name:"WineryInventoryCapacity","":null},eWineryInventoryCapacity2:{key:"eWineryInventoryCapacity2",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pWinery",level:2,price:140,name:"WineryInventoryCapacity","":null},eWineryInventoryCapacity3:{key:"eWineryInventoryCapacity3",attr:"attInventoryCapacity",op:"add",val:2,duration:null,target:"pWinery",level:3,price:170,name:"WineryInventoryCapacity","":null},eWineryOutputCapacity1:{key:"eWineryOutputCapacity1",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pWinery",level:1,price:0,name:"WineryOutputCapacity","":null},eWineryOutputCapacity2:{key:"eWineryOutputCapacity2",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pWinery",level:2,price:0,name:"WineryOutputCapacity","":null},eWineryOutputCapacity3:{key:"eWineryOutputCapacity3",attr:"attOutputCapacity",op:"add",val:2,duration:null,target:"pWinery",level:3,price:0,name:"WineryOutputCapacity","":null},eAppleGardenProducingSpeed1:{key:"eAppleGardenProducingSpeed1",attr:"attProducingSpeed",op:"mul",val:.5,duration:null,target:"pAppleGarden",level:1,price:40,name:"AppleGardenProducingSpeed","":null},eAppleGardenProducingSpeed2:{key:"eAppleGardenProducingSpeed2",attr:"attProducingSpeed",op:"mul",val:.5,duration:null,target:"pAppleGarden",level:2,price:70,name:"AppleGardenProducingSpeed","":null},eAppleGardenProducingSpeed3:{key:"eAppleGardenProducingSpeed3",attr:"attProducingSpeed",op:"mul",val:.5,duration:null,target:"pAppleGarden",level:3,price:110,name:"AppleGardenProducingSpeed","":null},eAppleGardenInventoryCapacity1:{key:"eAppleGardenInventoryCapacity1",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pAppleGarden",level:1,price:45,name:"AppleGardenInventoryCapacity","":null},eAppleGardenInventoryCapacity2:{key:"eAppleGardenInventoryCapacity2",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pAppleGarden",level:2,price:80,name:"AppleGardenInventoryCapacity","":null},eAppleGardenInventoryCapacity3:{key:"eAppleGardenInventoryCapacity3",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pAppleGarden",level:3,price:120,name:"AppleGardenInventoryCapacity","":null},eAppleGardenOutputCapacity1:{key:"eAppleGardenOutputCapacity1",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pAppleGarden",level:1,price:0,name:"AppleGardenOutputCapacity","":null},eAppleGardenOutputCapacity2:{key:"eAppleGardenOutputCapacity2",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pAppleGarden",level:2,price:0,name:"AppleGardenOutputCapacity","":null},eAppleGardenOutputCapacity3:{key:"eAppleGardenOutputCapacity3",attr:"attOutputCapacity",op:"add",val:1,duration:null,target:"pAppleGarden",level:3,price:0,name:"AppleGardenOutputCapacity","":null},eMillerNpcInventoryCapacity1:{key:"eMillerNpcInventoryCapacity1",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pMillerNpc",level:1,price:70,name:"MillerNpcInventoryCapacity","":null},eMillerNpcInventoryCapacity2:{key:"eMillerNpcInventoryCapacity2",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pMillerNpc",level:2,price:100,name:"MillerNpcInventoryCapacity","":null},eMillerNpcInventoryCapacity3:{key:"eMillerNpcInventoryCapacity3",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pMillerNpc",level:3,price:170,name:"MillerNpcInventoryCapacity","":null},eMillerNpcMovementSpeed1:{key:"eMillerNpcMovementSpeed1",attr:"attMovementSpeed",op:"mul",val:.5,duration:null,target:"pMillerNpc",level:1,price:70,name:"MillerNpcMovementSpeed","":null},eMillerNpcMovementSpeed2:{key:"eMillerNpcMovementSpeed2",attr:"attMovementSpeed",op:"mul",val:.5,duration:null,target:"pMillerNpc",level:2,price:100,name:"MillerNpcMovementSpeed","":null},eMillerNpcMovementSpeed3:{key:"eMillerNpcMovementSpeed3",attr:"attMovementSpeed",op:"mul",val:.5,duration:null,target:"pMillerNpc",level:3,price:170,name:"MillerNpcMovementSpeed","":null},eAppleNpcInventoryCapacity1:{key:"eAppleNpcInventoryCapacity1",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pAppleNpc",level:1,price:70,name:"AppleNpcInventoryCapacity","":null},eAppleNpcInventoryCapacity2:{key:"eAppleNpcInventoryCapacity2",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pAppleNpc",level:2,price:120,name:"AppleNpcInventoryCapacity","":null},eAppleNpcInventoryCapacity3:{key:"eAppleNpcInventoryCapacity3",attr:"attInventoryCapacity",op:"add",val:1,duration:null,target:"pAppleNpc",level:3,price:170,name:"AppleNpcInventoryCapacity","":null},eAppleNpcMovementSpeed1:{key:"eAppleNpcMovementSpeed1",attr:"attMovementSpeed",op:"mul",val:.5,duration:null,target:"pAppleNpc",level:1,price:70,name:"AppleNpcMovementSpeed","":null},eAppleNpcMovementSpeed2:{key:"eAppleNpcMovementSpeed2",attr:"attMovementSpeed",op:"mul",val:.5,duration:null,target:"pAppleNpc",level:2,price:120,name:"AppleNpcMovementSpeed","":null},eAppleNpcMovementSpeed3:{key:"eAppleNpcMovementSpeed3",attr:"attMovementSpeed",op:"mul",val:.5,duration:null,target:"pAppleNpc",level:3,price:170,name:"AppleNpcMovementSpeed","":null}},GE=["eSawmillProducingSpeed1","eSawmillProducingSpeed2","eSawmillProducingSpeed3","eSawmillInventoryCapacity1","eSawmillInventoryCapacity2","eSawmillInventoryCapacity3","eSawmillOutputCapacity1","eSawmillOutputCapacity2","eSawmillOutputCapacity3","ePlayerInventoryCapacity1","ePlayerInventoryCapacity2","ePlayerInventoryCapacity3","eWheatGardenProducingSpeed1","eWheatGardenProducingSpeed2","eWheatGardenProducingSpeed3","eWheatGardenInventoryCapacity1","eWheatGardenInventoryCapacity2","eWheatGardenInventoryCapacity3","eWheatGardenOutputCapacity1","eWheatGardenOutputCapacity2","eWheatGardenOutputCapacity3","eMillProducingSpeed1","eMillProducingSpeed2","eMillProducingSpeed3","eMillInventoryCapacity1","eMillInventoryCapacity2","eMillInventoryCapacity3","eMillOutputCapacity1","eMillOutputCapacity2","eMillOutputCapacity3","eLogNpcMovementSpeed1","eLogNpcMovementSpeed2","eLogNpcMovementSpeed3","eWaterNpcInventoryCapacity1","eWaterNpcInventoryCapacity2","eWaterNpcInventoryCapacity3","eWaterNpcMovementSpeed1","eWaterNpcMovementSpeed2","eWaterNpcMovementSpeed3","eWellProducingSpeed1","eWellProducingSpeed2","eWellProducingSpeed3","eBakerProducingSpeed1","eBakerProducingSpeed2","eBakerProducingSpeed3","eBakerInventoryCapacity1","eBakerInventoryCapacity2","eBakerInventoryCapacity3","eBakerOutputCapacity1","eBakerOutputCapacity2","eBakerOutputCapacity3","eWineryProducingSpeed1","eWineryProducingSpeed2","eWineryProducingSpeed3","eWineryInventoryCapacity1","eWineryInventoryCapacity2","eWineryInventoryCapacity3","eWineryOutputCapacity1","eWineryOutputCapacity2","eWineryOutputCapacity3","eAppleGardenProducingSpeed1","eAppleGardenProducingSpeed2","eAppleGardenProducingSpeed3","eAppleGardenInventoryCapacity1","eAppleGardenInventoryCapacity2","eAppleGardenInventoryCapacity3","eAppleGardenOutputCapacity1","eAppleGardenOutputCapacity2","eAppleGardenOutputCapacity3","eMillerNpcInventoryCapacity1","eMillerNpcInventoryCapacity2","eMillerNpcInventoryCapacity3","eMillerNpcMovementSpeed1","eMillerNpcMovementSpeed2","eMillerNpcMovementSpeed3","eAppleNpcInventoryCapacity1","eAppleNpcInventoryCapacity2","eAppleNpcInventoryCapacity3","eAppleNpcMovementSpeed1","eAppleNpcMovementSpeed2","eAppleNpcMovementSpeed3"],tc={Settings:hx,Orders:dx,Items:cx,Producers:ux,Attributes:fx,Effects:px},mx=""+new URL("SM_Icon_Clapper_01-b237bd75.png",import.meta.url).href,_x=""+new URL("tree-557061b4.png",import.meta.url).href,gx=""+new URL("SM_Icon_Coin_03-81412333.png",import.meta.url).href,Ex=""+new URL("SM_Icon_Potion_02-6c33dd6a.png",import.meta.url).href,vx=""+new URL("moneyx2-37ccffe2.png",import.meta.url).href,yx=""+new URL("SM_Prop_Log-e6232167.png",import.meta.url).href,Ax=""+new URL("SM_Prop_Plank-51a7d2a0.png",import.meta.url).href,Tx=""+new URL("SM_Prop_Apple_01-025d3030.png",import.meta.url).href,Sx=""+new URL("SM_Prop_Tool_Bucket_01-c73b1594.png",import.meta.url).href,Cx=""+new URL("SM_Prop_Barrel_01-55390a39.png",import.meta.url).href,Ix=""+new URL("SM_Icon_Crafting_Grain_01-d1838b10.png",import.meta.url).href,Rx=""+new URL("SM_Prop_GrainBag_Open_01-31382ac6.png",import.meta.url).href,bx=""+new URL("SM_Item_Bread_03-f11ca0bc.png",import.meta.url).href,xx=""+new URL("phone-79b05ec2.png",import.meta.url).href,Mx=""+new URL("hand-775bee67.png",import.meta.url).href,Px=""+new URL("back-37542e49.png",import.meta.url).href,Dx=""+new URL("manager-5f0022a5.png",import.meta.url).href,Ox=""+new URL("SM_Icon_Crafting_Book_01-898347fa.png",import.meta.url).href,wx=""+new URL("icon_magma-ore-LP-f1b8c628.png",import.meta.url).href,Fx=""+new URL("icon_bars-silver_LP-548e6050.png",import.meta.url).href,Lx=""+new URL("icon_corn_LP-755e40f0.png",import.meta.url).href,Nx=""+new URL("icon_wool_LP-5795bd94.png",import.meta.url).href,Bx=""+new URL("icon_heart_LP-b5620213.png",import.meta.url).href,kx=""+new URL("icon_axe_LP-a7ba488f.png",import.meta.url).href,Ux=""+new URL("SM_Icon_Sword_02-c8a4bf44.png",import.meta.url).href,Vx=""+new URL("iCrystal-c487dd82.png",import.meta.url).href,Gx=""+new URL("iGem-95e72284.png",import.meta.url).href,zx={iCoin:gx,iWater:Sx,iLog:yx,iPlank:Ax,iApple:Tx,iAleBarrel:Cx,iWheat:Ix,iFlour:Rx,iBread:bx,iBook:Ox,iOre:wx,iIron:Fx,iCorn:Lx,iWool:Nx,iCrystal:Vx,iGem:Gx,iHp:Bx,iStrength:kx,effectSpeed:Ex,effectCoinsMult:vx,video:mx,hand:Mx,phone:xx,back:Px,effectManager:Dx,tree:_x,battle:Ux};function ot(s){return zx[s]||""}function Lf(s){return tc.Items[s]}ve.createContext(!1);function Hx(s,e=0){const t=ve.useRef(),i=ve.useRef(s),n=ve.useCallback(()=>{t.current&&clearTimeout(t.current),t.current=setTimeout(()=>{i.current()},e)},[e]),r=ve.useCallback(()=>{t.current&&clearTimeout(t.current)},[]);return ve.useEffect(()=>{i.current=s},[s]),ve.useEffect(()=>(n(),r),[e]),[r,n]}function Yt(){const[s,e]=ve.useState(()=>0),t=ve.useMemo(()=>()=>e(i=>++i),[]);return{renderId:s,refresh:t}}const zE=s=>{const e=ve.useRef(s);e.current=s,ve.useLayoutEffect(()=>{const t=i=>{i.code==="Escape"&&e.current&&e.current()};return window.addEventListener("keydown",t),()=>{window.removeEventListener("keydown",t)}},[e])},Wx=()=>{const s=ve.useRef(!0);return ve.useEffect(()=>(s.current=!1,()=>{s.current=!0}),[]),s};function Nf(s){const e="anim-shaker-1";return ve.useCallback((i=200)=>{const n=s.current;n&&(n.classList.contains(e)||(n.classList.add(e),setTimeout(()=>{n.classList.remove(e)},i)))},[s])}const HE=M.createContext(null);function Xx({children:s,world:e}){return M.createElement(HE.Provider,{value:e},s)}function bt(){const s=ve.useContext(HE);if(s==null)throw new Error("there is no world in the context");return s}function te(s,e){const t=bt(),i=ve.useRef();i.current=e,ve.useEffect(()=>{const r=t.bus[s].add((...a)=>{i.current&&i.current(...a)});return()=>{r.remove()}},[s,i,t])}let Yx=(s=21)=>crypto.getRandomValues(new Uint8Array(s)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");class Bf{constructor(e,t={}){this.id=-1,this._isInitialized=!1,e=e||Fe.LastCreatedScene,e&&(this._scene=e,this.soundCollection=new Array,this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){var e;!((e=k.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&k.audioEngine.audioContext&&(this._outputAudioNode=k.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(k.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(k.audioEngine&&k.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){var t;this._isInitialized||this._initializeSoundTrackAudioGraph(),!((t=k.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),e.soundTrackId&&(e.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){const t=this.soundCollection.indexOf(e);t!==-1&&this.soundCollection.splice(t,1)}setVolume(e){var t;!((t=k.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){var e;if(!((e=k.audioEngine)===null||e===void 0)&&e.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){var e;if(!((e=k.audioEngine)===null||e===void 0)&&e.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToEqualPower()}connectToAnalyser(e){var t;this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,!((t=k.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,k.audioEngine.masterGain))}}k.AudioEngineFactory=(s,e,t)=>new Kx(s,e,t);class Kx{get audioContext(){return this._audioContextInitialized||this._initializeAudioContext(),this._audioContext}constructor(e=null,t=null,i=null){if(this._audioContext=null,this._audioContextInitialized=!1,this._muteButton=null,this._audioDestination=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!1,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new O,this.onAudioLockedObservable=new O,this._tryToRun=!1,this._onResize=()=>{this._moveButtonToTopLeft()},!vi())return;typeof window.AudioContext!="undefined"&&(this.canUseWebAudio=!0);const n=document.createElement("audio");this._hostElement=e,this._audioContext=t,this._audioDestination=i;try{n&&n.canPlayType&&(n.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||n.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch(r){}try{n&&n.canPlayType&&n.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch(r){}}lock(){this._triggerSuspendedState()}unlock(){var e,t;if(((e=this._audioContext)===null||e===void 0?void 0:e.state)==="running"){this._hideMuteButton();return}this._tryToRun?(t=this._audioContext)===null||t===void 0||t.suspend().then(()=>{this._tryToRun=!1,this._triggerRunningState()}):this._triggerRunningState()}_resumeAudioContext(){var e;return!((e=this._audioContext)===null||e===void 0)&&e.resume?this._audioContext.resume():Promise.resolve()}_initializeAudioContext(){try{this.canUseWebAudio&&(this._audioContext||(this._audioContext=new AudioContext),this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this._audioDestination||(this._audioDestination=this._audioContext.destination),this.masterGain.connect(this._audioDestination),this._audioContextInitialized=!0,this._audioContext.state==="running"&&this._triggerRunningState())}catch(e){this.canUseWebAudio=!1,U.Error("Web Audio: "+e.message)}}_triggerRunningState(){this._tryToRun||(this._tryToRun=!0,this._resumeAudioContext().then(()=>{this._tryToRun=!1,this._muteButton&&this._hideMuteButton(),this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)}).catch(()=>{this._tryToRun=!1,this.unlocked=!1}))}_triggerSuspendedState(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this._displayMuteButton()}_displayMuteButton(){if(this.useCustomUnlockedButton||this._muteButton)return;this._muteButton=document.createElement("BUTTON"),this._muteButton.className="babylonUnmuteIcon",this._muteButton.id="babylonUnmuteIconBtn",this._muteButton.title="Unmute";const t=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png")+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",i=document.createElement("style");i.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(i),document.body.appendChild(this._muteButton),this._moveButtonToTopLeft(),this._muteButton.addEventListener("touchend",()=>{this._triggerRunningState()},!0),this._muteButton.addEventListener("click",()=>{this.unlock()},!0),window.addEventListener("resize",this._onResize)}_moveButtonToTopLeft(){this._hostElement&&this._muteButton&&(this._muteButton.style.top=this._hostElement.offsetTop+20+"px",this._muteButton.style.left=this._hostElement.offsetLeft+20+"px")}_hideMuteButton(){this._muteButton&&(document.body.removeChild(this._muteButton),this._muteButton=null)}dispose(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this._hideMuteButton(),window.removeEventListener("resize",this._onResize),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1}setGlobalVolume(e){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=e)}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))}}Oo.AddParser(ye.NAME_AUDIO,(s,e,t,i)=>{var n;let r=[],a;if(t.sounds=t.sounds||[],s.sounds!==void 0&&s.sounds!==null)for(let o=0,l=s.sounds.length;o<l;o++){const c=s.sounds[o];!((n=k.audioEngine)===null||n===void 0)&&n.canUseWebAudio?(c.url||(c.url=c.name),r[c.url]?t.sounds.push(es.Parse(c,e,i,r[c.url])):(a=es.Parse(c,e,i),r[c.url]=a,t.sounds.push(a))):t.sounds.push(new es(c.name,null,e))}r=[]});Object.defineProperty(Le.prototype,"mainSoundTrack",{get:function(){let s=this._getComponent(ye.NAME_AUDIO);return s||(s=new pn(this),this._addComponent(s)),this._mainSoundTrack||(this._mainSoundTrack=new Bf(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0});Le.prototype.getSoundByName=function(s){let e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++)if(this.mainSoundTrack.soundCollection[e].name===s)return this.mainSoundTrack.soundCollection[e];if(this.soundTracks){for(let t=0;t<this.soundTracks.length;t++)for(e=0;e<this.soundTracks[t].soundCollection.length;e++)if(this.soundTracks[t].soundCollection[e].name===s)return this.soundTracks[t].soundCollection[e]}return null};Object.defineProperty(Le.prototype,"audioEnabled",{get:function(){let s=this._getComponent(ye.NAME_AUDIO);return s||(s=new pn(this),this._addComponent(s)),s.audioEnabled},set:function(s){let e=this._getComponent(ye.NAME_AUDIO);e||(e=new pn(this),this._addComponent(e)),s?e.enableAudio():e.disableAudio()},enumerable:!0,configurable:!0});Object.defineProperty(Le.prototype,"headphone",{get:function(){let s=this._getComponent(ye.NAME_AUDIO);return s||(s=new pn(this),this._addComponent(s)),s.headphone},set:function(s){let e=this._getComponent(ye.NAME_AUDIO);e||(e=new pn(this),this._addComponent(e)),s?e.switchAudioModeForHeadphones():e.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0});Object.defineProperty(Le.prototype,"audioListenerPositionProvider",{get:function(){let s=this._getComponent(ye.NAME_AUDIO);return s||(s=new pn(this),this._addComponent(s)),s.audioListenerPositionProvider},set:function(s){let e=this._getComponent(ye.NAME_AUDIO);if(e||(e=new pn(this),this._addComponent(e)),s&&typeof s!="function")throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");e.audioListenerPositionProvider=s},enumerable:!0,configurable:!0});Object.defineProperty(Le.prototype,"audioListenerRotationProvider",{get:function(){let s=this._getComponent(ye.NAME_AUDIO);return s||(s=new pn(this),this._addComponent(s)),s.audioListenerRotationProvider},set:function(s){let e=this._getComponent(ye.NAME_AUDIO);if(e||(e=new pn(this),this._addComponent(e)),s&&typeof s!="function")throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");e.audioListenerRotationProvider=s},enumerable:!0,configurable:!0});Object.defineProperty(Le.prototype,"audioPositioningRefreshRate",{get:function(){let s=this._getComponent(ye.NAME_AUDIO);return s||(s=new pn(this),this._addComponent(s)),s.audioPositioningRefreshRate},set:function(s){let e=this._getComponent(ye.NAME_AUDIO);e||(e=new pn(this),this._addComponent(e)),e.audioPositioningRefreshRate=s},enumerable:!0,configurable:!0});class pn{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){this.name=ye.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new g,this._cachedCameraPosition=new g,this._lastCheck=0,this._invertMatrixTemp=new D,this._cameraDirectionTemp=new g,e=e||Fe.LastCreatedScene,e&&(this.scene=e,e.soundTracks=new Array,e.sounds=new Array)}register(){this.scene._afterRenderStage.registerStep(ye.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){const i=this.scene.soundTracks[t];for(let n=0;n<i.soundCollection.length;n++)e.sounds.push(i.soundCollection[n].serialize())}}addFromContainer(e){e.sounds&&e.sounds.forEach(t=>{t.play(),t.autoplay=!0,this.scene.mainSoundTrack.addSound(t)})}removeFromContainer(e,t=!1){e.sounds&&e.sounds.forEach(i=>{i.stop(),i.autoplay=!1,this.scene.mainSoundTrack.removeSound(i),t&&i.dispose()})}dispose(){const e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){const e=this.scene;this._audioEnabled=!1,k.audioEngine&&k.audioEngine.audioContext&&k.audioEngine.audioContext.suspend();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].pause()}enableAudio(){const e=this.scene;this._audioEnabled=!0,k.audioEngine&&k.audioEngine.audioContext&&k.audioEngine.audioContext.resume();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].isPaused&&e.soundTracks[t].soundCollection[i].play()}switchAudioModeForHeadphones(){const e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){const e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){const e=Mn.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;const t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||t._mainSoundTrack.soundCollection.length===0&&t.soundTracks.length===1)return;const i=k.audioEngine;if(i&&i.audioContext){let n=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(n=t.activeCameras[0]),this.audioListenerPositionProvider){const a=this.audioListenerPositionProvider();i.audioContext.listener.setPosition(a.x||0,a.y||0,a.z||0)}else n?this._cachedCameraPosition.equals(n.globalPosition)||(this._cachedCameraPosition.copyFrom(n.globalPosition),i.audioContext.listener.setPosition(n.globalPosition.x,n.globalPosition.y,n.globalPosition.z)):i.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){const a=this.audioListenerRotationProvider();i.audioContext.listener.setOrientation(a.x||0,a.y||0,a.z||0,0,1,0)}else n?(n.rigCameras&&n.rigCameras.length>0&&(n=n.rigCameras[0]),n.getViewMatrix().invertToRef(this._invertMatrixTemp),g.TransformNormalToRef(pn._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),!isNaN(this._cameraDirectionTemp.x)&&!isNaN(this._cameraDirectionTemp.y)&&!isNaN(this._cameraDirectionTemp.z)&&(this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0)))):i.audioContext.listener.setOrientation(0,0,0,0,1,0);let r;for(r=0;r<t.mainSoundTrack.soundCollection.length;r++){const a=t.mainSoundTrack.soundCollection[r];a.useCustomAttenuation&&a.updateDistanceFromListener()}if(t.soundTracks)for(r=0;r<t.soundTracks.length;r++)for(let a=0;a<t.soundTracks[r].soundCollection.length;a++){const o=t.soundTracks[r].soundCollection[a];o.useCustomAttenuation&&o.updateDistanceFromListener()}}}}pn._CameraDirection=new g(0,0,-1);es._SceneComponentInitialization=s=>{let e=s._getComponent(ye.NAME_AUDIO);e||(e=new pn(s),s._addComponent(e))};function Qx(s){const e=new Array,t=new Array,i=new Array,n=s.add(()=>{const a=e.length;for(let o=0;o<a;o++)bu(e.shift(),t.shift(),i.shift())});return{scheduler:(a,o,l)=>{e.push(a),t.push(o),i.push(l)},dispose:()=>{s.remove(n)}}}O.prototype.runCoroutineAsync=function(s){if(!this._coroutineScheduler){const e=Qx(this);this._coroutineScheduler=e.scheduler,this._coroutineSchedulerDispose=e.dispose}return NE(s,this._coroutineScheduler)};O.prototype.cancelAllCoroutines=function(){this._coroutineSchedulerDispose&&this._coroutineSchedulerDispose(),this._coroutineScheduler=void 0,this._coroutineSchedulerDispose=void 0};class it{constructor(e,t,i=Number.MAX_VALUE){this.origin=e,this.direction=t,this.length=i}clone(){return new it(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){const n=it._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),r=it._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i);let a=0,o=Number.MAX_VALUE,l,c,u,h;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<n.x||this.origin.x>r.x)return!1}else if(l=1/this.direction.x,c=(n.x-this.origin.x)*l,u=(r.x-this.origin.x)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),a=Math.max(c,a),o=Math.min(u,o),a>o)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<n.y||this.origin.y>r.y)return!1}else if(l=1/this.direction.y,c=(n.y-this.origin.y)*l,u=(r.y-this.origin.y)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),a=Math.max(c,a),o=Math.min(u,o),a>o)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<n.z||this.origin.z>r.z)return!1}else if(l=1/this.direction.z,c=(n.z-this.origin.z)*l,u=(r.z-this.origin.z)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),a=Math.max(c,a),o=Math.min(u,o),a>o)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){const i=e.center.x-this.origin.x,n=e.center.y-this.origin.y,r=e.center.z-this.origin.z,a=i*i+n*n+r*r,o=e.radius+t,l=o*o;if(a<=l)return!0;const c=i*this.direction.x+n*this.direction.y+r*this.direction.z;return c<0?!1:a-c*c<=l}intersectsTriangle(e,t,i){const n=it._TmpVector3[0],r=it._TmpVector3[1],a=it._TmpVector3[2],o=it._TmpVector3[3],l=it._TmpVector3[4];t.subtractToRef(e,n),i.subtractToRef(e,r),g.CrossToRef(this.direction,r,a);const c=g.Dot(n,a);if(c===0)return null;const u=1/c;this.origin.subtractToRef(e,o);const h=g.Dot(o,a)*u;if(h<0||h>1)return null;g.CrossToRef(o,n,l);const d=g.Dot(this.direction,l)*u;if(d<0||h+d>1)return null;const f=g.Dot(r,l)*u;return f>this.length?null:new nf(1-h-d,h,f)}intersectsPlane(e){let t;const i=g.Dot(e.normal,this.direction);if(Math.abs(i)<999999997475243e-21)return null;{const n=g.Dot(e.normal,this.origin);return t=(-e.d-n)/i,t<0?t<-999999997475243e-21?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{const i=(this.origin.y-t)/this.direction.y;return i>0?null:new g(this.origin.x+this.direction.x*-i,t,this.origin.z+this.direction.z*-i)}case"x":{const i=(this.origin.x-t)/this.direction.x;return i>0?null:new g(t,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{const i=(this.origin.z-t)/this.direction.z;return i>0?null:new g(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,t)}default:return null}}intersectsMesh(e,t,i,n=!1,r,a=!1){const o=w.Matrix[0];return e.getWorldMatrix().invertToRef(o),this._tmpRay?it.TransformToRef(this,o,this._tmpRay):this._tmpRay=it.Transform(this,o),e.intersects(this._tmpRay,t,i,n,r,a)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let n=0;n<e.length;n++){const r=this.intersectsMesh(e[n],t);r.hit&&i.push(r)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){const n=this.origin,r=w.Vector3[0],a=w.Vector3[1],o=w.Vector3[2],l=w.Vector3[3];t.subtractToRef(e,r),this.direction.scaleToRef(it._Rayl,o),n.addToRef(o,a),e.subtractToRef(n,l);const c=g.Dot(r,r),u=g.Dot(r,o),h=g.Dot(o,o),d=g.Dot(r,l),f=g.Dot(o,l),p=c*h-u*u;let m,_=p,E,v=p;p<it._Smallnum?(m=0,_=1,E=f,v=h):(m=u*f-h*d,E=c*f-u*d,m<0?(m=0,E=f,v=h):m>_&&(m=_,E=f+u,v=h)),E<0?(E=0,-d<0?m=0:-d>c?m=_:(m=-d,_=c)):E>v&&(E=v,-d+u<0?m=0:-d+u>c?m=_:(m=-d+u,_=c));const y=Math.abs(m)<it._Smallnum?0:m/_,A=Math.abs(E)<it._Smallnum?0:E/v,I=w.Vector3[4];o.scaleToRef(A,I);const T=w.Vector3[5];r.scaleToRef(y,T),T.addInPlace(l);const R=w.Vector3[6];return T.subtractToRef(I,R),A>0&&A<=this.length&&R.lengthSquared()<i*i?T.length():-1}update(e,t,i,n,r,a,o,l=!1){if(l){it._RayDistant||(it._RayDistant=it.Zero()),it._RayDistant.unprojectRayToRef(e,t,i,n,D.IdentityReadOnly,a,o);const c=w.Matrix[0];r.invertToRef(c),it.TransformToRef(it._RayDistant,c,this)}else this.unprojectRayToRef(e,t,i,n,r,a,o);return this}static Zero(){return new it(g.Zero(),g.Zero())}static CreateNew(e,t,i,n,r,a,o){return it.Zero().update(e,t,i,n,r,a,o)}static CreateNewFromTo(e,t,i=D.IdentityReadOnly){const n=t.subtract(e),r=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);return n.normalize(),it.Transform(new it(e,n,r),i)}static Transform(e,t){const i=new it(new g(0,0,0),new g(0,0,0));return it.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){g.TransformCoordinatesToRef(e.origin,t,i.origin),g.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length;const n=i.direction,r=n.length();if(!(r===0||r===1)){const a=1/r;n.x*=a,n.y*=a,n.z*=a,i.length*=r}}unprojectRayToRef(e,t,i,n,r,a,o){const l=w.Matrix[0];r.multiplyToRef(a,l),l.multiplyToRef(o,l),l.invert();const c=Fe.LastCreatedEngine,u=w.Vector3[0];u.x=e/i*2-1,u.y=-(t/n*2-1),u.z=c!=null&&c.useReverseDepthBuffer?1:c!=null&&c.isNDCHalfZRange?0:-1;const h=w.Vector3[1].copyFromFloats(u.x,u.y,1-1e-8),d=w.Vector3[2],f=w.Vector3[3];g._UnprojectFromInvertedMatrixToRef(u,l,d),g._UnprojectFromInvertedMatrixToRef(h,l,f),this.origin.copyFrom(d),f.subtractToRef(d,this.direction),this.direction.normalize()}}it._TmpVector3=mi.BuildArray(6,g.Zero);it._RayDistant=it.Zero();it._Smallnum=1e-8;it._Rayl=1e9;Le.prototype.createPickingRay=function(s,e,t,i,n=!1){const r=it.Zero();return this.createPickingRayToRef(s,e,t,r,i,n),r};Le.prototype.createPickingRayToRef=function(s,e,t,i,n,r=!1,a=!1){const o=this.getEngine();if(!n){if(!this.activeCamera)return this;n=this.activeCamera}const c=n.viewport.toGlobal(o.getRenderWidth(),o.getRenderHeight());return s=s/o.getHardwareScalingLevel()-c.x,e=e/o.getHardwareScalingLevel()-(o.getRenderHeight()-c.y-c.height),i.update(s,e,c.width,c.height,t||D.IdentityReadOnly,r?D.IdentityReadOnly:n.getViewMatrix(),n.getProjectionMatrix(),a),this};Le.prototype.createPickingRayInCameraSpace=function(s,e,t){const i=it.Zero();return this.createPickingRayInCameraSpaceToRef(s,e,i,t),i};Le.prototype.createPickingRayInCameraSpaceToRef=function(s,e,t,i){if(!ar)return this;const n=this.getEngine();if(!i){if(!this.activeCamera)throw new Error("Active camera not set");i=this.activeCamera}const a=i.viewport.toGlobal(n.getRenderWidth(),n.getRenderHeight()),o=D.Identity();return s=s/n.getHardwareScalingLevel()-a.x,e=e/n.getHardwareScalingLevel()-(n.getRenderHeight()-a.y-a.height),t.update(s,e,a.width,a.height,o,o,i.getProjectionMatrix()),this};Le.prototype._internalPickForMesh=function(s,e,t,i,n,r,a,o){const l=e(i,t.enableDistantPicking),c=t.intersects(l,n,a,r,i,o);return!c||!c.hit||!n&&s!=null&&c.distance>=s.distance?null:c};Le.prototype._internalPick=function(s,e,t,i,n){let r=null;const a=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),o=this.cameraToUseForPointers||this.activeCamera;for(let l=0;l<this.meshes.length;l++){const c=this.meshes[l];if(e){if(!e(c))continue}else if(!c.isEnabled()||!c.isVisible||!c.isPickable)continue;const u=a&&c.isWorldMatrixCameraDependent(),h=c.computeWorldMatrix(u,o);if(c.hasThinInstances&&c.thinInstanceEnablePicking){const d=this._internalPickForMesh(r,s,c,h,!0,!0,n);if(d){if(i)return d;const f=w.Matrix[1],p=c.thinInstanceGetWorldMatrices();for(let m=0;m<p.length;m++){p[m].multiplyToRef(h,f);const E=this._internalPickForMesh(r,s,c,f,t,i,n,!0);if(E&&(r=E,r.thinInstanceIndex=m,t))return r}}}else{const d=this._internalPickForMesh(r,s,c,h,t,i,n);if(d&&(r=d,t))return r}}return r||new ar};Le.prototype._internalMultiPick=function(s,e,t){if(!ar)return null;const i=new Array,n=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),r=this.cameraToUseForPointers||this.activeCamera;for(let a=0;a<this.meshes.length;a++){const o=this.meshes[a];if(e){if(!e(o))continue}else if(!o.isEnabled()||!o.isVisible||!o.isPickable)continue;const l=n&&o.isWorldMatrixCameraDependent(),c=o.computeWorldMatrix(l,r);if(o.hasThinInstances&&o.thinInstanceEnablePicking){if(this._internalPickForMesh(null,s,o,c,!0,!0,t)){const h=w.Matrix[1],d=o.thinInstanceGetWorldMatrices();for(let f=0;f<d.length;f++){d[f].multiplyToRef(c,h);const m=this._internalPickForMesh(null,s,o,h,!1,!1,t,!0);m&&(m.thinInstanceIndex=f,i.push(m))}}}else{const u=this._internalPickForMesh(null,s,o,c,!1,!1,t);u&&i.push(u)}}return i};Le.prototype.pickWithBoundingInfo=function(s,e,t,i,n){if(!ar)return null;const r=this._internalPick(a=>(this._tempPickingRay||(this._tempPickingRay=it.Zero()),this.createPickingRayToRef(s,e,a,this._tempPickingRay,n||null),this._tempPickingRay),t,i,!0);return r&&(r.ray=this.createPickingRay(s,e,D.Identity(),n||null)),r};Object.defineProperty(Le.prototype,"_pickingAvailable",{get:()=>!0,enumerable:!1,configurable:!1});Le.prototype.pick=function(s,e,t,i,n,r,a=!1){const o=this._internalPick((l,c)=>(this._tempPickingRay||(this._tempPickingRay=it.Zero()),this.createPickingRayToRef(s,e,l,this._tempPickingRay,n||null,!1,c),this._tempPickingRay),t,i,!1,r);return o&&(o.ray=this.createPickingRay(s,e,D.Identity(),n||null)),o};Le.prototype.pickWithRay=function(s,e,t,i){const n=this._internalPick(r=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=D.Identity()),r.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=it.Zero()),it.TransformToRef(s,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t,!1,i);return n&&(n.ray=s),n};Le.prototype.multiPick=function(s,e,t,i,n){return this._internalMultiPick(r=>this.createPickingRay(s,e,r,i||null),t,n)};Le.prototype.multiPickWithRay=function(s,e,t){return this._internalMultiPick(i=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=D.Identity()),i.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=it.Zero()),it.TransformToRef(s,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t)};Ee.prototype.getForwardRay=function(s=100,e,t){return this.getForwardRayToRef(new it(g.Zero(),g.Zero(),s),s,e,t)};Ee.prototype.getForwardRayToRef=function(s,e=100,t,i){return t||(t=this.getWorldMatrix()),s.length=e,i?s.origin.copyFrom(i):s.origin.copyFrom(this.position),w.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),g.TransformNormalToRef(w.Vector3[2],t,w.Vector3[3]),g.NormalizeToRef(w.Vector3[3],s.direction),s};he._GroundMeshParser=(s,e)=>ic.Parse(s,e);class ic extends he{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);const i=this;i.createOrUpdateSubmeshesOctree&&i.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){const i=this.getWorldMatrix(),n=w.Matrix[5];i.invertToRef(n);const r=w.Vector3[8];if(g.TransformCoordinatesFromFloatsToRef(e,0,t,n,r),e=r.x,t=r.z,e<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const a=this._getFacetAt(e,t),o=-(a.x*e+a.z*t+a.w)/a.y;return g.TransformCoordinatesFromFloatsToRef(0,o,0,i,r),r.y}getNormalAtCoordinates(e,t){const i=new g(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){const n=this.getWorldMatrix(),r=w.Matrix[5];n.invertToRef(r);const a=w.Vector3[8];if(g.TransformCoordinatesFromFloatsToRef(e,0,t,r,a),e=a.x,t=a.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const o=this._getFacetAt(e,t);return g.TransformNormalFromFloatsToRef(o.x,o.y,o.z,n,i),this}updateCoordinateHeights(){return(!this._heightQuads||this._heightQuads.length==0)&&this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){const i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),n=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),r=this._heightQuads[n*this._subdivisionsX+i];let a;return t<r.slope.x*e+r.slope.y?a=r.facet1:a=r.facet2,a}_initHeightQuads(){const e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=new Array;for(let i=0;i<t;i++)for(let n=0;n<e;n++){const r={slope:j.Zero(),facet1:new dt(0,0,0,0),facet2:new dt(0,0,0,0)};this._heightQuads[i*e+n]=r}return this}_computeHeightQuads(){const e=this.getVerticesData(C.PositionKind);if(!e)return this;const t=w.Vector3[3],i=w.Vector3[2],n=w.Vector3[1],r=w.Vector3[0],a=w.Vector3[4],o=w.Vector3[5],l=w.Vector3[6],c=w.Vector3[7],u=w.Vector3[8];let h=0,d=0,f=0,p=0,m=0,_=0,E=0;const v=this._subdivisionsX,y=this._subdivisionsY;for(let A=0;A<y;A++)for(let I=0;I<v;I++){h=I*3,d=A*(v+1)*3,f=(A+1)*(v+1)*3,t.x=e[d+h],t.y=e[d+h+1],t.z=e[d+h+2],i.x=e[d+h+3],i.y=e[d+h+4],i.z=e[d+h+5],n.x=e[f+h],n.y=e[f+h+1],n.z=e[f+h+2],r.x=e[f+h+3],r.y=e[f+h+4],r.z=e[f+h+5],p=(r.z-t.z)/(r.x-t.x),m=t.z-p*t.x,i.subtractToRef(t,a),n.subtractToRef(t,o),r.subtractToRef(t,l),g.CrossToRef(l,o,c),g.CrossToRef(a,l,u),c.normalize(),u.normalize(),_=-(c.x*t.x+c.y*t.y+c.z*t.z),E=-(u.x*i.x+u.y*i.y+u.z*i.z);const T=this._heightQuads[A*v+I];T.slope.copyFromFloats(p,m),T.facet1.copyFromFloats(c.x,c.y,c.z,_),T.facet2.copyFromFloats(u.x,u.y,u.z,E)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){const i=new ic(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}}function WE(s){const e=[],t=[],i=[],n=[];let r,a;const o=s.width||1,l=s.height||1,c=(s.subdivisionsX||s.subdivisions||1)|0,u=(s.subdivisionsY||s.subdivisions||1)|0;for(r=0;r<=u;r++)for(a=0;a<=c;a++){const d=new g(a*o/c-o/2,0,(u-r)*l/u-l/2),f=new g(0,1,0);t.push(d.x,d.y,d.z),i.push(f.x,f.y,f.z),n.push(a/c,Pi.UseOpenGLOrientationForUV?r/u:1-r/u)}for(r=0;r<u;r++)for(a=0;a<c;a++)e.push(a+1+(r+1)*(c+1)),e.push(a+1+r*(c+1)),e.push(a+r*(c+1)),e.push(a+(r+1)*(c+1)),e.push(a+1+(r+1)*(c+1)),e.push(a+r*(c+1));const h=new fe;return h.indices=e,h.positions=t,h.normals=i,h.uvs=n,h}function XE(s){const e=s.xmin!==void 0&&s.xmin!==null?s.xmin:-1,t=s.zmin!==void 0&&s.zmin!==null?s.zmin:-1,i=s.xmax!==void 0&&s.xmax!==null?s.xmax:1,n=s.zmax!==void 0&&s.zmax!==null?s.zmax:1,r=s.subdivisions||{w:1,h:1},a=s.precision||{w:1,h:1},o=new Array,l=new Array,c=new Array,u=new Array;let h,d,f,p;r.h=r.h<1?1:r.h,r.w=r.w<1?1:r.w,a.w=a.w<1?1:a.w,a.h=a.h<1?1:a.h;const m={w:(i-e)/r.w,h:(n-t)/r.h};function _(v,y,A,I){const T=l.length/3,R=a.w+1;for(h=0;h<a.h;h++)for(d=0;d<a.w;d++){const L=[T+d+h*R,T+(d+1)+h*R,T+(d+1)+(h+1)*R,T+d+(h+1)*R];o.push(L[1]),o.push(L[2]),o.push(L[3]),o.push(L[0]),o.push(L[1]),o.push(L[3])}const x=g.Zero(),F=new g(0,1,0);for(h=0;h<=a.h;h++)for(x.z=h*(I-y)/a.h+y,d=0;d<=a.w;d++)x.x=d*(A-v)/a.w+v,x.y=0,l.push(x.x,x.y,x.z),c.push(F.x,F.y,F.z),u.push(d/a.w,h/a.h)}for(f=0;f<r.h;f++)for(p=0;p<r.w;p++)_(e+p*m.w,t+f*m.h,e+(p+1)*m.w,t+(f+1)*m.h);const E=new fe;return E.indices=o,E.positions=l,E.normals=c,E.uvs=u,E}function YE(s){const e=[],t=[],i=[],n=[];let r,a;const o=s.colorFilter||new G(.3,.59,.11),l=s.alphaFilter||0;let c=!1;if(s.minHeight>s.maxHeight){c=!0;const h=s.maxHeight;s.maxHeight=s.minHeight,s.minHeight=h}for(r=0;r<=s.subdivisions;r++)for(a=0;a<=s.subdivisions;a++){const h=new g(a*s.width/s.subdivisions-s.width/2,0,(s.subdivisions-r)*s.height/s.subdivisions-s.height/2),d=(h.x+s.width/2)/s.width*(s.bufferWidth-1)|0,f=(1-(h.z+s.height/2)/s.height)*(s.bufferHeight-1)|0,p=(d+f*s.bufferWidth)*4;let m=s.buffer[p]/255,_=s.buffer[p+1]/255,E=s.buffer[p+2]/255;const v=s.buffer[p+3]/255;c&&(m=1-m,_=1-_,E=1-E);const y=m*o.r+_*o.g+E*o.b;v>=l?h.y=s.minHeight+(s.maxHeight-s.minHeight)*y:h.y=s.minHeight-lt,t.push(h.x,h.y,h.z),i.push(0,0,0),n.push(a/s.subdivisions,1-r/s.subdivisions)}for(r=0;r<s.subdivisions;r++)for(a=0;a<s.subdivisions;a++){const h=a+1+(r+1)*(s.subdivisions+1),d=a+1+r*(s.subdivisions+1),f=a+r*(s.subdivisions+1),p=a+(r+1)*(s.subdivisions+1),m=t[h*3+1]>=s.minHeight,_=t[d*3+1]>=s.minHeight,E=t[f*3+1]>=s.minHeight;m&&_&&E&&(e.push(h),e.push(d),e.push(f)),t[p*3+1]>=s.minHeight&&m&&E&&(e.push(p),e.push(h),e.push(f))}fe.ComputeNormals(t,e,i);const u=new fe;return u.indices=e,u.positions=t,u.normals=i,u.uvs=n,u}function Zx(s,e={},t){const i=new ic(s,t);return i._setReady(!1),i._subdivisionsX=e.subdivisionsX||e.subdivisions||1,i._subdivisionsY=e.subdivisionsY||e.subdivisions||1,i._width=e.width||1,i._height=e.height||1,i._maxX=i._width/2,i._maxZ=i._height/2,i._minX=-i._maxX,i._minZ=-i._maxZ,WE(e).applyToMesh(i,e.updatable),i._setReady(!0),i}function qx(s,e,t=null){const i=new he(s,t);return XE(e).applyToMesh(i,e.updatable),i}function jx(s,e,t={},i=null){const n=t.width||10,r=t.height||10,a=t.subdivisions||1,o=t.minHeight||0,l=t.maxHeight||1,c=t.colorFilter||new G(.3,.59,.11),u=t.alphaFilter||0,h=t.updatable,d=t.onReady;i=i||Fe.LastCreatedScene;const f=new ic(s,i);f._subdivisionsX=a,f._subdivisionsY=a,f._width=n,f._height=r,f._maxX=f._width/2,f._maxZ=f._height/2,f._minX=-f._maxX,f._minZ=-f._maxZ,f._setReady(!1);const p=m=>{const _=m.width,E=m.height;if(i.isDisposed)return;const v=i==null?void 0:i.getEngine().resizeImageBitmap(m,_,E);YE({width:n,height:r,subdivisions:a,minHeight:o,maxHeight:l,colorFilter:c,buffer:v,bufferWidth:_,bufferHeight:E,alphaFilter:u}).applyToMesh(f,h),d&&d(f),f._setReady(!0)};return q.LoadImage(e,p,()=>{},i.offlineProvider),f}fe.CreateGround=WE;fe.CreateTiledGround=XE;fe.CreateGroundFromHeightMap=YE;he.CreateGround=(s,e,t,i,n,r)=>Zx(s,{width:e,height:t,subdivisions:i,updatable:r},n);he.CreateTiledGround=(s,e,t,i,n,r,a,o,l)=>qx(s,{xmin:e,zmin:t,xmax:i,zmax:n,subdivisions:r,precision:a,updatable:l},o);he.CreateGroundFromHeightMap=(s,e,t,i,n,r,a,o,l,c,u)=>jx(s,e,{width:t,height:i,subdivisions:n,minHeight:r,maxHeight:a,updatable:l,onReady:c,alphaFilter:u},o);function KE(s){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],n=[];let r=[];const a=s.width||s.size||1,o=s.height||s.size||1,l=s.depth||s.size||1,c=s.wrap||!1;let u=s.topBaseAt===void 0?1:s.topBaseAt,h=s.bottomBaseAt===void 0?0:s.bottomBaseAt;u=(u+4)%4,h=(h+4)%4;const d=[2,0,3,1],f=[2,0,1,3];let p=d[u],m=f[h],_=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(c){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],_=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let R=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],x=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const F=[17,18,19,16],L=[22,23,20,21];for(;p>0;)R.unshift(R.pop()),F.unshift(F.pop()),p--;for(;m>0;)x.unshift(x.pop()),L.unshift(L.pop()),m--;R=R.flat(),x=x.flat(),_=_.concat(R).concat(x),t.push(F[0],F[2],F[3],F[0],F[1],F[2]),t.push(L[0],L[2],L[3],L[0],L[1],L[2])}const E=[a/2,o/2,l/2];r=_.reduce((R,x,F)=>R.concat(x*E[F%3]),[]);const v=s.sideOrientation===0?0:s.sideOrientation||fe.DEFAULTSIDE,y=s.faceUV||new Array(6),A=s.faceColors,I=[];for(let R=0;R<6;R++)y[R]===void 0&&(y[R]=new dt(0,0,1,1)),A&&A[R]===void 0&&(A[R]=new pe(1,1,1,1));for(let R=0;R<6;R++)if(n.push(y[R].z,Pi.UseOpenGLOrientationForUV?1-y[R].w:y[R].w),n.push(y[R].x,Pi.UseOpenGLOrientationForUV?1-y[R].w:y[R].w),n.push(y[R].x,Pi.UseOpenGLOrientationForUV?1-y[R].y:y[R].y),n.push(y[R].z,Pi.UseOpenGLOrientationForUV?1-y[R].y:y[R].y),A)for(let x=0;x<4;x++)I.push(A[R].r,A[R].g,A[R].b,A[R].a);fe._ComputeSides(v,r,t,i,n,s.frontUVs,s.backUVs);const T=new fe;if(T.indices=t,T.positions=r,T.normals=i,T.uvs=n,A){const R=v===fe.DOUBLESIDE?I.concat(I):I;T.colors=R}return T}function ha(s,e={},t=null){const i=new he(s,t);return e.sideOrientation=he._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,KE(e).applyToMesh(i,e.updatable),i}fe.CreateBox=KE;he.CreateBox=(s,e,t=null,i,n)=>ha(s,{size:e,sideOrientation:n,updatable:i},t);function QE(s){const e=[],t=[],i=[],n=[],r=s.diameter||1,a=s.thickness||.5,o=(s.tessellation||16)|0,l=s.sideOrientation===0?0:s.sideOrientation||fe.DEFAULTSIDE,c=o+1;for(let h=0;h<=o;h++){const d=h/o,f=h*Math.PI*2/o-Math.PI/2,p=D.Translation(r/2,0,0).multiply(D.RotationY(f));for(let m=0;m<=o;m++){const _=1-m/o,E=m*Math.PI*2/o+Math.PI,v=Math.cos(E),y=Math.sin(E);let A=new g(v,y,0),I=A.scale(a/2);const T=new j(d,_);I=g.TransformCoordinates(I,p),A=g.TransformNormal(A,p),t.push(I.x,I.y,I.z),i.push(A.x,A.y,A.z),n.push(T.x,Pi.UseOpenGLOrientationForUV?1-T.y:T.y);const R=(h+1)%c,x=(m+1)%c;e.push(h*c+m),e.push(h*c+x),e.push(R*c+m),e.push(h*c+x),e.push(R*c+x),e.push(R*c+m)}}fe._ComputeSides(l,t,e,i,n,s.frontUVs,s.backUVs);const u=new fe;return u.indices=e,u.positions=t,u.normals=i,u.uvs=n,u}function ZE(s,e={},t){const i=new he(s,t);return e.sideOrientation=he._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,QE(e).applyToMesh(i,e.updatable),i}fe.CreateTorus=QE;he.CreateTorus=(s,e,t,i,n,r,a)=>ZE(s,{diameter:e,thickness:t,tessellation:i,sideOrientation:a,updatable:r},n);function qE(s){const e=[],t=[],i=[],n=[],r=s.width||s.size||1,a=s.height||s.size||1,o=s.sideOrientation===0?0:s.sideOrientation||fe.DEFAULTSIDE,l=r/2,c=a/2;t.push(-l,-c,0),i.push(0,0,-1),n.push(0,Pi.UseOpenGLOrientationForUV?1:0),t.push(l,-c,0),i.push(0,0,-1),n.push(1,Pi.UseOpenGLOrientationForUV?1:0),t.push(l,c,0),i.push(0,0,-1),n.push(1,Pi.UseOpenGLOrientationForUV?0:1),t.push(-l,c,0),i.push(0,0,-1),n.push(0,Pi.UseOpenGLOrientationForUV?0:1),e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),fe._ComputeSides(o,t,e,i,n,s.frontUVs,s.backUVs);const u=new fe;return u.indices=e,u.positions=t,u.normals=i,u.uvs=n,u}function lm(s,e={},t=null){const i=new he(s,t);return e.sideOrientation=he._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,qE(e).applyToMesh(i,e.updatable),e.sourcePlane&&(i.translate(e.sourcePlane.normal,-e.sourcePlane.d),i.setDirection(e.sourcePlane.normal.scale(-1))),i}fe.CreatePlane=qE;he.CreatePlane=(s,e,t,i,n)=>lm(s,{size:e,width:e,height:e,sideOrientation:n,updatable:i},t);oi.AddNodeConstructor("Light_Type_3",(s,e)=>()=>new rh(s,g.Zero(),e));class rh extends Be{constructor(e,t,i){super(e,i),this.groundColor=new G(0,0,0),this.direction=t||g.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=g.Normalize(e.subtract(g.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){const i=g.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){const i=g.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=D.Identity()),this._worldMatrix}getTypeID(){return Be.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}}S([Gi()],rh.prototype,"groundColor",void 0);S([gn()],rh.prototype,"direction",void 0);class $x{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===Ce.POINTERDOWN){this._isPointerDown=!0;return}i.type===Ce.POINTERUP&&(this._isPointerDown=!1)}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{if(this._reachTargetAlpha())return;const i=Mn.Now;let n=0;this._lastFrameTime!=null&&(n=i-this._lastFrameTime),this._lastFrameTime=i,this._applyUserInteraction();const r=i-this._lastInteractionTime-this._idleRotationWaitTime,a=Math.max(Math.min(r/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*a,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(n/1e3))})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null}resetLastInteractionTime(e){this._lastInteractionTime=e!=null?e:Mn.Now}_reachTargetAlpha(){return this._attachedCamera&&this.targetAlpha?Math.abs(this._attachedCamera.alpha-this.targetAlpha)<lt:!1}_userIsZooming(){return this._attachedCamera?this._attachedCamera.inertialRadiusOffset!==0:!1}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&this._attachedCamera.inertialRadiusOffset!==0&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=Mn.Now)}_userIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}class ps{constructor(){this._easingMode=ps.EASINGMODE_EASEIN}setEasingMode(e){const t=Math.min(Math.max(e,0),2);this._easingMode=t}getEasingMode(){return this._easingMode}easeInCore(e){throw new Error("You must implement this method")}ease(e){switch(this._easingMode){case ps.EASINGMODE_EASEIN:return this.easeInCore(e);case ps.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?(1-this.easeInCore((1-e)*2))*.5+.5:this.easeInCore(e*2)*.5}}ps.EASINGMODE_EASEIN=0;ps.EASINGMODE_EASEOUT=1;ps.EASINGMODE_EASEINOUT=2;class Jx extends ps{constructor(e=1){super(),this.amplitude=e}easeInCore(e){const t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)}}class eM extends ps{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}}class da{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;const t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add(i=>{if(!i)return;i.computeWorldMatrix(!0);const n=i.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=n*.05,this.upperRadiusTransitionRange=n*.05}):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))})}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return this._attachedCamera?this._attachedCamera.radius===e&&!this._radiusIsAnimating:!1}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(da.EasingFunction.setEasingMode(da.EasingMode),this._radiusBounceTransition=B.CreateAnimation("radius",B.ANIMATIONTYPE_FLOAT,60,da.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;const t=B.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,()=>this._clearAnimationLocks());t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}}da.EasingFunction=new Jx(.3);da.EasingMode=ps.EASINGMODE_EASEOUT;class rn{constructor(){this.onTargetFramingAnimationEndObservable=new O,this._mode=rn.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();rn.EasingFunction.setEasingMode(rn.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===Ce.POINTERDOWN){this._isPointerDown=!0;return}i.type===Ce.POINTERUP&&(this._isPointerDown=!1)}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(i=>{i&&this.zoomOnMesh(i,void 0,()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()})}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);const n=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(n.minimumWorld,n.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);const n=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(n.min,n.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){const n=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new g(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let a=0;a<e.length;a++){const o=e[a].getHierarchyBoundingVectors(!0);g.CheckExtends(o.min,n,r),g.CheckExtends(o.max,n,r)}this.zoomOnBoundingInfo(n,r,t,i)}zoomOnBoundingInfo(e,t,i=!1,n=null){let r;if(!this._attachedCamera)return!1;const a=e.y,o=t.y,l=a+(o-a)*this._positionScale,c=t.subtract(e).scale(.5);if(i)r=new g(0,l,0);else{const d=e.add(c);r=new g(d.x,l,d.z)}this._vectorTransition||(this._vectorTransition=B.CreateAnimation("target",B.ANIMATIONTYPE_VECTOR3,60,rn.EasingFunction)),this._betaIsAnimating=!0;let u=B.TransitionTo("target",r,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);u&&this._animatables.push(u);let h=0;if(this._mode===rn.FitFrustumSidesMode){const d=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=c.length()+this._attachedCamera.minZ),h=d}else this._mode===rn.IgnoreBoundsSizeMode&&(h=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&this._attachedCamera.lowerRadiusLimit===null&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){const d=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/d,this._attachedCamera.wheelPrecision=100/h}return this._radiusTransition||(this._radiusTransition=B.CreateAnimation("radius",B.ANIMATIONTYPE_FLOAT,60,rn.EasingFunction)),u=B.TransitionTo("radius",h,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,()=>{this.stopAllAnimations(),n&&n(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()}),u&&this._animatables.push(u),!0}_calculateLowerRadiusFromModelBoundingSphere(e,t){const n=t.subtract(e).length(),r=this._getFrustumSlope(),o=n*.5*this._radiusScale,l=o*Math.sqrt(1+1/(r.x*r.x)),c=o*Math.sqrt(1+1/(r.y*r.y));let u=Math.max(l,c);const h=this._attachedCamera;return h?(h.lowerRadiusLimit&&this._mode===rn.IgnoreBoundsSizeMode&&(u=u<h.lowerRadiusLimit?h.lowerRadiusLimit:u),h.upperRadiusLimit&&(u=u>h.upperRadiusLimit?h.upperRadiusLimit:u),u):0}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;const e=Mn.Now-this._lastInteractionTime,t=Math.PI*.5-this._defaultElevation,i=Math.PI*.5;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=B.CreateAnimation("beta",B.ANIMATIONTYPE_FLOAT,60,rn.EasingFunction));const n=B.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,()=>{this._clearAnimationLocks(),this.stopAllAnimations()});n&&this._animatables.push(n)}}_getFrustumSlope(){const e=this._attachedCamera;if(!e)return j.Zero();const i=e.getScene().getEngine().getAspectRatio(e),n=Math.tan(e.fov/2),r=n*i;return new j(r,n)}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=Mn.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}rn.EasingFunction=new eM;rn.EasingMode=ps.EASINGMODE_EASEINOUT;rn.IgnoreBoundsSizeMode=0;rn.FitFrustumSidesMode=1;class jE{constructor(){this._currentActiveButton=-1,this.buttons=[0,1,2]}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();let n=0,r=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=o=>{var l,c;const u=o.event,h=u.pointerType==="touch";if(t.isInVRExclusivePointerMode||o.type!==Ce.POINTERMOVE&&this.buttons.indexOf(u.button)===-1)return;const d=u.target;if(this._altKey=u.altKey,this._ctrlKey=u.ctrlKey,this._metaKey=u.metaKey,this._shiftKey=u.shiftKey,this._buttonsPressed=u.buttons,t.isPointerLock){const f=u.movementX,p=u.movementY;this.onTouch(null,f,p),this._pointA=null,this._pointB=null}else{if(o.type!==Ce.POINTERDOWN&&h&&((l=this._pointA)===null||l===void 0?void 0:l.pointerId)!==u.pointerId&&((c=this._pointB)===null||c===void 0?void 0:c.pointerId)!==u.pointerId)return;if(o.type===Ce.POINTERDOWN&&(this._currentActiveButton===-1||h)){try{d==null||d.setPointerCapture(u.pointerId)}catch(f){}if(this._pointA===null)this._pointA={x:u.clientX,y:u.clientY,pointerId:u.pointerId,type:u.pointerType};else if(this._pointB===null)this._pointB={x:u.clientX,y:u.clientY,pointerId:u.pointerId,type:u.pointerType};else return;this._currentActiveButton===-1&&!h&&(this._currentActiveButton=u.button),this.onButtonDown(u),e||(u.preventDefault(),i&&i.focus())}else if(o.type===Ce.POINTERDOUBLETAP)this.onDoubleTap(u.pointerType);else if(o.type===Ce.POINTERUP&&(this._currentActiveButton===u.button||h)){try{d==null||d.releasePointerCapture(u.pointerId)}catch(f){}h||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==u.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==u.pointerId?this._pointB=null:this._pointA=this._pointB=null,(n!==0||r)&&(this.onMultiTouch(this._pointA,this._pointB,n,0,r,null),n=0,r=null),this._currentActiveButton=-1,this.onButtonUp(u),e||u.preventDefault()}else if(o.type===Ce.POINTERMOVE){if(e||u.preventDefault(),this._pointA&&this._pointB===null){const f=u.clientX-this._pointA.x,p=u.clientY-this._pointA.y;this.onTouch(this._pointA,f,p),this._pointA.x=u.clientX,this._pointA.y=u.clientY}else if(this._pointA&&this._pointB){const f=this._pointA.pointerId===u.pointerId?this._pointA:this._pointB;f.x=u.clientX,f.y=u.clientY;const p=this._pointA.x-this._pointB.x,m=this._pointA.y-this._pointB.y,_=p*p+m*m,E={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:u.pointerId,type:o.type};this.onMultiTouch(this._pointA,this._pointB,n,_,r,E),r=E,n=_}}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ce.POINTERDOWN|Ce.POINTERUP|Ce.POINTERMOVE|Ce.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,n=0,r=null,this.onLostFocus()},this._contextMenuBind=this.onContextMenu.bind(this),i&&i.addEventListener("contextmenu",this._contextMenuBind,!1);const a=this.camera.getScene().getEngine().getHostWindow();a&&q.RegisterTopRootEvents(a,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){const e=this.camera.getScene().getEngine().getHostWindow();e&&q.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){const e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentActiveButton=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,n,r,a){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}}S([b()],jE.prototype,"buttons",void 0);class En extends jE{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(this.panningSensibility!==0&&e&&t){const i=t.x-e.x,n=t.y-e.y;this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=n/this.panningSensibility}}_computePinchZoom(e,t){const i=this.camera.radius||En.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=(t-e)*.001*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){this.panningSensibility!==0&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,n,r,a){i===0&&r===null||n===0&&a===null||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,n),this._computeMultiTouchPanning(r,a)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(n)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,n),this._isPinching=!0):this._computeMultiTouchPanning(r,a)):this.multiTouchPanning?this._computeMultiTouchPanning(r,a):this.pinchZoom&&this._computePinchZoom(i,n))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}}En.MinimumRadiusForPinch=.001;S([b()],En.prototype,"buttons",void 0);S([b()],En.prototype,"angularSensibilityX",void 0);S([b()],En.prototype,"angularSensibilityY",void 0);S([b()],En.prototype,"pinchPrecision",void 0);S([b()],En.prototype,"pinchDeltaPercentage",void 0);S([b()],En.prototype,"useNaturalPinchZoom",void 0);S([b()],En.prototype,"pinchZoom",void 0);S([b()],En.prototype,"panningSensibility",void 0);S([b()],En.prototype,"multiTouchPanning",void 0);S([b()],En.prototype,"multiTouchPanAndZoom",void 0);rr.ArcRotateCameraPointersInput=En;class vs{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===Ao.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1){const n=this._keys.indexOf(i.keyCode);n>=0&&this._keys.splice(n,1),i.preventDefault&&(e||i.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];this.keysLeft.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:this.keysUp.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:this.keysRight.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:this.keysDown.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:this.keysReset.indexOf(i)!==-1&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}}S([b()],vs.prototype,"keysUp",void 0);S([b()],vs.prototype,"keysDown",void 0);S([b()],vs.prototype,"keysLeft",void 0);S([b()],vs.prototype,"keysRight",void 0);S([b()],vs.prototype,"keysReset",void 0);S([b()],vs.prototype,"panningSensibility",void 0);S([b()],vs.prototype,"zoomingSensibility",void 0);S([b()],vs.prototype,"useAltToZoom",void 0);S([b()],vs.prototype,"angularSpeed",void 0);rr.ArcRotateCameraKeyboardMoveInput=vs;const tM=40;class nc{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._inertialPanning=g.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0;const n=e*.01*this.wheelDeltaPercentage*t;return e>0?i=n/(1+this.wheelDeltaPercentage):i=n*(1+this.wheelDeltaPercentage),i}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Ce.POINTERWHEEL)return;const i=t.event;let n=0;const r=i.deltaMode===Do.DOM_DELTA_LINE?tM:1,a=-(i.deltaY*r);if(this.customComputeDeltaFromMouseWheel)n=this.customComputeDeltaFromMouseWheel(a,this,i);else if(this.wheelDeltaPercentage){if(n=this._computeDeltaFromMouseWheelLegacyEvent(a,this.camera.radius),n>0){let o=this.camera.radius,l=this.camera.inertialRadiusOffset+n;for(let c=0;c<20&&Math.abs(l)>.001;c++)o-=l,l*=this.camera.inertia;o=W.Clamp(o,0,Number.MAX_VALUE),n=this._computeDeltaFromMouseWheelLegacyEvent(a,o)}}else n=a/(this.wheelPrecision*40);n&&(this.zoomToMouseLocation?(this._hitPlane||this._updateHitPlane(),this._zoomToMouse(n)):this.camera.inertialRadiusOffset+=n),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Ce.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;const e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){const e=this.camera,t=e.target.subtract(e.position);this._hitPlane=Zn.FromPositionAndNormal(e.target,t)}_getPosition(){var e;const t=this.camera,i=t.getScene(),n=i.createPickingRay(i.pointerX,i.pointerY,D.Identity(),t,!1);n.origin.x-=t.targetScreenOffset.x,n.origin.y-=t.targetScreenOffset.y;let r=0;return this._hitPlane&&(r=(e=n.intersectsPlane(this._hitPlane))!==null&&e!==void 0?e:0),n.origin.addInPlace(n.direction.scaleInPlace(r))}_zoomToMouse(e){var t,i;const n=this.camera,r=1-n.inertia;if(n.lowerRadiusLimit){const u=(t=n.lowerRadiusLimit)!==null&&t!==void 0?t:0;n.radius-(n.inertialRadiusOffset+e)/r<u&&(e=(n.radius-u)*r-n.inertialRadiusOffset)}if(n.upperRadiusLimit){const u=(i=n.upperRadiusLimit)!==null&&i!==void 0?i:0;n.radius-(n.inertialRadiusOffset+e)/r>u&&(e=(n.radius-u)*r-n.inertialRadiusOffset)}const o=e/r/n.radius,l=this._getPosition(),c=w.Vector3[6];l.subtractToRef(n.target,c),c.scaleInPlace(o),c.scaleInPlace(r),this._inertialPanning.addInPlace(c),n.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<lt&&(e.x=0),Math.abs(e.y)<lt&&(e.y=0),Math.abs(e.z)<lt&&(e.z=0)}}S([b()],nc.prototype,"wheelPrecision",void 0);S([b()],nc.prototype,"zoomToMouseLocation",void 0);S([b()],nc.prototype,"wheelDeltaPercentage",void 0);rr.ArcRotateCameraMouseWheelInput=nc;class iM extends yE{constructor(e){super(e)}addMouseWheel(){return this.add(new nc),this}addPointers(){return this.add(new En),this}addKeyboard(){return this.add(new vs),this}}oi.AddNodeConstructor("ArcRotateCamera",(s,e)=>()=>new Lt(s,0,0,1,g.Zero(),e));class Lt extends di{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new D,this._upToYMatrix=new D,this._upVector=g.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){D.RotationAlignToRef(g.UpReadOnly,this._upVector,this._yToUpMatrix),D.RotationAlignToRef(this._upVector,g.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){const e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){const t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){const e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){const t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){const e=this.inputs.attached.pointers;return e?e.useNaturalPinchZoom:!1}set useNaturalPinchZoom(e){const t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){const e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){const t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){const e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){const e=this.inputs.attached.mousewheel;return e?e.zoomToMouseLocation:!1}set zoomToMouseLocation(e){const t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){const e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return this._bouncingBehavior!=null}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new da,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return this._framingBehavior!=null}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new rn,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return this._autoRotationBehavior!=null}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new $x,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,i,n,r,a,o=!0){super(e,g.Zero(),a,o),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=g.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=j.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this._viewMatrix=new D,this.panningAxis=new g(1,1,0),this._transformedDirection=new g,this.mapPanning=!1,this.onMeshTargetChangedObservable=new O,this.checkCollisions=!1,this.collisionRadius=new g(.5,.5,.5),this._previousPosition=g.Zero(),this._collisionVelocity=g.Zero(),this._newPosition=g.Zero(),this._computationVector=g.Zero(),this._onCollisionPositionChange=(l,c,u=null)=>{u?(this.setPosition(c),this.onCollide&&this.onCollide(u)):this._previousPosition.copyFrom(this._position);const h=Math.cos(this.alpha),d=Math.sin(this.alpha),f=Math.cos(this.beta);let p=Math.sin(this.beta);p===0&&(p=1e-4);const m=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*h*p,this.radius*f,this.radius*d*p),m.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let _=this.upVector;this.allowUpsideDown&&this.beta<0&&(_=_.clone(),_=_.negate()),this._computeViewMatrix(this._position,m,_),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=g.Zero(),r&&this.setTarget(r),this.alpha=t,this.beta=i,this.radius=n,this.getViewMatrix(),this.inputs=new iM(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=j.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){const t=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?t.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(t)}const e=this._getLockedTargetPosition();return e||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0):!1}_isSynchronizedViewMatrix(){return super._isSynchronizedViewMatrix()?this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset):!1}attachControl(e,t,i=!0,n=2){const r=arguments;t=q.BackCompatCameraNoPreventDefault(r),this._useCtrlForPanning=i,this._panningMouseButton=n,typeof r[0]=="boolean"&&(r.length>1&&(this._useCtrlForPanning=r[1]),r.length>2&&(this._panningMouseButton=r[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0){const e=this.invertRotation?-1:1;let t=this.inertialAlphaOffset;this.beta<=0&&(t*=-1),this.getScene().useRightHandedSystem&&(t*=-1),this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(t*=-1),this.alpha+=t*e,this.beta+=this.inertialBetaOffset*e,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<lt&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<lt&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*lt&&(this.inertialRadiusOffset=0)}if(this.inertialPanningX!==0||this.inertialPanningY!==0){const e=new g(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);this._viewMatrix.invertToRef(this._cameraTransformMatrix),e.multiplyInPlace(this.panningAxis),g.TransformNormalToRef(e,this._cameraTransformMatrix,this._transformedDirection),(this.mapPanning||!this.panningAxis.y)&&(this._transformedDirection.y=0),this._targetHost||(this.panningDistanceLimit?(this._transformedDirection.addInPlace(this._target),g.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection)):this._target.addInPlace(this._transformedDirection)),this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*lt&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*lt&&(this.inertialPanningY=0)}this._checkLimits(),super._checkInputs()}}_checkLimits(){this.lowerBetaLimit===null||this.lowerBetaLimit===void 0?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit===null||this.upperBetaLimit===void 0?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerAlphaLimit!==null&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit!==null&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&g.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),this.radius===0&&(this.radius=1e-4);const e=this.alpha;this._computationVector.x===0&&this._computationVector.z===0?this.alpha=Math.PI/2:this.alpha=Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2))),this._computationVector.z<0&&(this.alpha=2*Math.PI-this.alpha);const t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=t*2*Math.PI,this.beta=Math.acos(this._computationVector.y/this.radius),this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,n=!1){var r;if(n=(r=this.overrideCloneAlphaBetaRadius)!==null&&r!==void 0?r:n,e.getBoundingInfo)t?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{const a=e,o=this._getTargetPosition();if(o&&!i&&o.equals(a))return;this._targetHost=null,this._target=a,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}n||this.rebuildAnglesAndRadius()}_getViewMatrix(){const e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta);let n=Math.sin(this.beta);n===0&&(n=1e-4),this.radius===0&&(this.radius=1e-4);const r=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*n,this.radius*i,this.radius*t*n),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&g.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),r.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){const a=this.getScene().collisionCoordinator;this._collider||(this._collider=a.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,a.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let a=this.upVector;this.allowUpsideDown&&n<0&&(a=a.negate()),this._computeViewMatrix(this._position,r,a),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=r,this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;const i=he.MinMax(e),n=g.Distance(i.min,i.max);this.radius=n*this.zoomOnFactor,this.focusOn({min:i.min,max:i.max,distance:n},t)}focusOn(e,t=!1){let i,n;if(e.min===void 0){const r=e||this.getScene().meshes;i=he.MinMax(r),n=g.Distance(i.min,i.max)}else{const r=e;i=r,n=r.distance}this._target=he.Center(i),t||(this.maxZ=n*2)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case Ee.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ee.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ee.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ee.RIG_MODE_STEREOSCOPIC_INTERLACED:case Ee.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(t===0?1:-1);break;case Ee.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(t===0?-1:1);break}const n=new Lt(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return n._cameraRigParams={},n.isRigCamera=!0,n.rigParent=this,n.upVector=this.upVector,n.mode=this.mode,n.orthoLeft=this.orthoLeft,n.orthoRight=this.orthoRight,n.orthoBottom=this.orthoBottom,n.orthoTop=this.orthoTop,n}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case Ee.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ee.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ee.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ee.RIG_MODE_STEREOSCOPIC_INTERLACED:case Ee.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case Ee.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;break}super._updateRigCameras()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}}S([b()],Lt.prototype,"alpha",void 0);S([b()],Lt.prototype,"beta",void 0);S([b()],Lt.prototype,"radius",void 0);S([b()],Lt.prototype,"overrideCloneAlphaBetaRadius",void 0);S([gn("target")],Lt.prototype,"_target",void 0);S([gE("targetHost")],Lt.prototype,"_targetHost",void 0);S([b()],Lt.prototype,"inertialAlphaOffset",void 0);S([b()],Lt.prototype,"inertialBetaOffset",void 0);S([b()],Lt.prototype,"inertialRadiusOffset",void 0);S([b()],Lt.prototype,"lowerAlphaLimit",void 0);S([b()],Lt.prototype,"upperAlphaLimit",void 0);S([b()],Lt.prototype,"lowerBetaLimit",void 0);S([b()],Lt.prototype,"upperBetaLimit",void 0);S([b()],Lt.prototype,"lowerRadiusLimit",void 0);S([b()],Lt.prototype,"upperRadiusLimit",void 0);S([b()],Lt.prototype,"inertialPanningX",void 0);S([b()],Lt.prototype,"inertialPanningY",void 0);S([b()],Lt.prototype,"pinchToPanMaxDistance",void 0);S([b()],Lt.prototype,"panningDistanceLimit",void 0);S([gn()],Lt.prototype,"panningOriginTarget",void 0);S([b()],Lt.prototype,"panningInertia",void 0);S([b()],Lt.prototype,"zoomToMouseLocation",null);S([b()],Lt.prototype,"zoomOnFactor",void 0);S([_E()],Lt.prototype,"targetScreenOffset",void 0);S([b()],Lt.prototype,"allowUpsideDown",void 0);S([b()],Lt.prototype,"useInputToRestoreState",void 0);class zt{constructor(e,t){this.triggerOptions=e,this.onBeforeExecuteObservable=new O,e.parameter?(this.trigger=e.trigger,this._triggerParameter=e.parameter):e.trigger?this.trigger=e.trigger:this.trigger=e,this._nextActiveAction=this,this._condition=t}_prepare(){}getTriggerParameter(){return this._triggerParameter}setTriggerParameter(e){this._triggerParameter=e}_evaluateConditionForCurrentFrame(){const e=this._condition;if(!e)return!0;const t=this._actionManager.getScene().getRenderId();return e._evaluationId!==t&&(e._evaluationId=t,e._currentResult=e.isValid()),e._currentResult}_executeCurrent(e){this._evaluateConditionForCurrentFrame()&&(this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(e),this.skipToNextActiveAction())}execute(e){}skipToNextActiveAction(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this}then(e){return this._child=e,e._actionManager=this._actionManager,e._prepare(),e}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(e){}_serialize(e,t){const i={type:1,children:[],name:e.name,properties:e.properties||[]};if(this._child&&this._child.serialize(i),this._condition){const n=this._condition.serialize();return n.children.push(i),t&&t.children.push(n),n}return t&&t.children.push(i),i}}zt._SerializeValueAsString=s=>typeof s=="number"?s.toString():typeof s=="boolean"?s?"true":"false":s instanceof j?s.x+", "+s.y:s instanceof g?s.x+", "+s.y+", "+s.z:s instanceof G?s.r+", "+s.g+", "+s.b:s instanceof pe?s.r+", "+s.g+", "+s.b+", "+s.a:s;zt._GetTargetProperty=s=>({name:"target",targetType:s._isMesh?"MeshProperties":s._isLight?"LightProperties":s._isCamera?"CameraProperties":s._isMaterial?"MaterialProperties":"SceneProperties",value:s._isScene?"Scene":s.name});Rt("BABYLON.Action",zt);class kl{constructor(e){this._actionManager=e}isValid(){return!0}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(){}_serialize(e){return{type:2,children:[],name:e.name,properties:e.properties}}}class ui extends kl{static get IsEqual(){return ui._IsEqual}static get IsDifferent(){return ui._IsDifferent}static get IsGreater(){return ui._IsGreater}static get IsLesser(){return ui._IsLesser}constructor(e,t,i,n,r=ui.IsEqual){super(e),this.propertyPath=i,this.value=n,this.operator=r,this._target=t,this._effectiveTarget=this._getEffectiveTarget(t,this.propertyPath),this._property=this._getProperty(this.propertyPath)}isValid(){switch(this.operator){case ui.IsGreater:return this._effectiveTarget[this._property]>this.value;case ui.IsLesser:return this._effectiveTarget[this._property]<this.value;case ui.IsEqual:case ui.IsDifferent:{let e;return this.value.equals?e=this.value.equals(this._effectiveTarget[this._property]):e=this.value===this._effectiveTarget[this._property],this.operator===ui.IsEqual?e:!e}}return!1}serialize(){return this._serialize({name:"ValueCondition",properties:[zt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:zt._SerializeValueAsString(this.value)},{name:"operator",value:ui.GetOperatorName(this.operator)}]})}static GetOperatorName(e){switch(e){case ui._IsEqual:return"IsEqual";case ui._IsDifferent:return"IsDifferent";case ui._IsGreater:return"IsGreater";case ui._IsLesser:return"IsLesser";default:return""}}}ui._IsEqual=0;ui._IsDifferent=1;ui._IsGreater=2;ui._IsLesser=3;class nM extends kl{constructor(e,t){super(e),this.predicate=t}isValid(){return this.predicate()}}class sM extends kl{constructor(e,t,i){super(e),this.value=i,this._target=t}isValid(){return this._target.state===this.value}serialize(){return this._serialize({name:"StateCondition",properties:[zt._GetTargetProperty(this._target),{name:"value",value:this.value}]})}}Rt("BABYLON.ValueCondition",ui);Rt("BABYLON.PredicateCondition",nM);Rt("BABYLON.StateCondition",sM);class rM extends zt{constructor(e,t,i,n){super(e,n),this.propertyPath=i,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]}serialize(e){return super._serialize({name:"SwitchBooleanAction",properties:[zt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},e)}}class aM extends zt{constructor(e,t,i,n){super(e,n),this.value=i,this._target=t}execute(){this._target.state=this.value}serialize(e){return super._serialize({name:"SetStateAction",properties:[zt._GetTargetProperty(this._target),{name:"value",value:this.value}]},e)}}class oM extends zt{constructor(e,t,i,n,r){super(e,r),this.propertyPath=i,this.value=n,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"SetValueAction",properties:[zt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:zt._SerializeValueAsString(this.value)}]},e)}}class lM extends zt{constructor(e,t,i,n,r){super(e,r),this.propertyPath=i,this.value=n,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),typeof this._effectiveTarget[this._property]!="number"&&U.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"IncrementValueAction",properties:[zt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:zt._SerializeValueAsString(this.value)}]},e)}}class cM extends zt{constructor(e,t,i,n,r,a){super(e,a),this.from=i,this.to=n,this.loop=r,this._target=t}_prepare(){}execute(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)}serialize(e){return super._serialize({name:"PlayAnimationAction",properties:[zt._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:zt._SerializeValueAsString(this.loop)||!1}]},e)}}class uM extends zt{constructor(e,t,i){super(e,i),this._target=t}_prepare(){}execute(){this._actionManager.getScene().stopAnimation(this._target)}serialize(e){return super._serialize({name:"StopAnimationAction",properties:[zt._GetTargetProperty(this._target)]},e)}}class $E extends zt{constructor(e=0,t){super(e,t)}execute(){}serialize(e){return super._serialize({name:"DoNothingAction",properties:[]},e)}}class hM extends zt{constructor(e,t,i,n=!0){super(e,i),this.children=t,this.enableChildrenConditions=n}_prepare(){for(let e=0;e<this.children.length;e++)this.children[e]._actionManager=this._actionManager,this.children[e]._prepare()}execute(e){for(const t of this.children)(!this.enableChildrenConditions||t._evaluateConditionForCurrentFrame())&&t.execute(e)}serialize(e){const t=super._serialize({name:"CombineAction",properties:[],combine:[]},e);for(let i=0;i<this.children.length;i++)t.combine.push(this.children[i].serialize(null));return t}}class dM extends zt{constructor(e,t,i){super(e,i),this.func=t}execute(e){this.func(e)}}class JE extends zt{constructor(e,t,i,n){super(e,n),this._target=t,this._parent=i}_prepare(){}execute(){if(this._target.parent===this._parent)return;const e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=g.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}serialize(e){return super._serialize({name:"SetParentAction",properties:[zt._GetTargetProperty(this._target),zt._GetTargetProperty(this._parent)]},e)}}Rt("BABYLON.SetParentAction",JE);Rt("BABYLON.ExecuteCodeAction",dM);Rt("BABYLON.DoNothingAction",$E);Rt("BABYLON.StopAnimationAction",uM);Rt("BABYLON.PlayAnimationAction",cM);Rt("BABYLON.IncrementValueAction",lM);Rt("BABYLON.SetValueAction",oM);Rt("BABYLON.SetStateAction",aM);Rt("BABYLON.SetParentAction",JE);Rt("BABYLON.SwitchBooleanAction",rM);Rt("BABYLON.CombineAction",hM);class at extends Sn{constructor(e){super(),e=e||Fe.LastCreatedScene,e&&(this._scene=e,e.actionManagers.push(this))}dispose(){const e=this._scene.actionManagers.indexOf(this);for(let i=0;i<this.actions.length;i++){const n=this.actions[i];at.Triggers[n.trigger]--,at.Triggers[n.trigger]===0&&delete at.Triggers[n.trigger]}this.actions.length=0,e>-1&&this._scene.actionManagers.splice(e,1);const t=this._scene.meshes.find(i=>i.actionManager===this);t&&(t.actionManager=null)}getScene(){return this._scene}hasSpecificTriggers(e){for(let t=0;t<this.actions.length;t++){const i=this.actions[t];if(e.indexOf(i.trigger)>-1)return!0}return!1}hasSpecificTriggers2(e,t){for(let i=0;i<this.actions.length;i++){const n=this.actions[i];if(e==n.trigger||t==n.trigger)return!0}return!1}hasSpecificTrigger(e,t){for(let i=0;i<this.actions.length;i++){const n=this.actions[i];if(n.trigger===e)if(t){if(t(n.getTriggerParameter()))return!0}else return!0}return!1}get hasPointerTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=at.OnPickTrigger&&t.trigger<=at.OnPointerOutTrigger)return!0}return!1}get hasPickTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=at.OnPickTrigger&&t.trigger<=at.OnPickUpTrigger)return!0}return!1}registerAction(e){return e.trigger===at.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(U.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(e),this.getScene()._registeredActions++,at.Triggers[e.trigger]?at.Triggers[e.trigger]++:at.Triggers[e.trigger]=1,e._actionManager=this,e._prepare(),e)}unregisterAction(e){const t=this.actions.indexOf(e);return t!==-1?(this.actions.splice(t,1),at.Triggers[e.trigger]-=1,at.Triggers[e.trigger]===0&&delete at.Triggers[e.trigger],e._actionManager=null,this.getScene()._registeredActions--,!0):!1}processTrigger(e,t){for(let i=0;i<this.actions.length;i++){const n=this.actions[i];if(n.trigger===e){if(t&&(e===at.OnKeyUpTrigger||e===at.OnKeyDownTrigger)){const r=n.getTriggerParameter();if(typeof r=="function"){if(!r(t))continue}else if(r&&r!==t.sourceEvent.keyCode){if(!r.toLowerCase)continue;const a=r.toLowerCase();if(a!==t.sourceEvent.key){const o=t.sourceEvent.charCode?t.sourceEvent.charCode:t.sourceEvent.keyCode;if(String.fromCharCode(o).toLowerCase()!==a)continue}}}n._executeCurrent(t)}}}_getEffectiveTarget(e,t){const i=t.split(".");for(let n=0;n<i.length-1;n++)e=e[i[n]];return e}_getProperty(e){const t=e.split(".");return t[t.length-1]}serialize(e){const t={children:new Array,name:e,type:3,properties:new Array};for(let i=0;i<this.actions.length;i++){const n={type:0,children:new Array,name:at.GetTriggerName(this.actions[i].trigger),properties:new Array},r=this.actions[i].triggerOptions;if(r&&typeof r!="number")if(r.parameter instanceof Node)n.properties.push(zt._GetTargetProperty(r.parameter));else if(typeof r.parameter=="object"){const a={};On.DeepCopy(r.parameter,a,["mesh"]),r.parameter&&r.parameter.mesh&&(a._meshId=r.parameter.mesh.id),n.properties.push({name:"parameter",targetType:null,value:a})}else n.properties.push({name:"parameter",targetType:null,value:r.parameter});this.actions[i].serialize(n),t.children.push(n)}return t}static Parse(e,t,i){const n=new at(i);t===null?i.actionManager=n:t.actionManager=n;const r=(l,c)=>{const u=hn("BABYLON."+l);return u&&new u(...c)},a=(l,c,u,h)=>{if(h===null){const m=parseFloat(c);return c==="true"||c==="false"?c==="true":isNaN(m)?c:m}const d=h.split("."),f=c.split(",");for(let m=0;m<d.length;m++)u=u[d[m]];if(typeof u=="boolean")return f[0]==="true";if(typeof u=="string")return f[0];const p=new Array;for(let m=0;m<f.length;m++)p.push(parseFloat(f[m]));return u instanceof g?g.FromArray(p):u instanceof dt?dt.FromArray(p):u instanceof G?G.FromArray(p):u instanceof pe?pe.FromArray(p):parseFloat(f[0])},o=(l,c,u,h,d=null)=>{if(l.detached)return;const f=new Array;let p=null,m=null;const _=l.combine&&l.combine.length>0;if(l.type===2?f.push(n):f.push(c),_){const v=new Array;for(let y=0;y<l.combine.length;y++)o(l.combine[y],at.NothingTrigger,u,h,v);f.push(v)}else for(let v=0;v<l.properties.length;v++){let y=l.properties[v].value;const A=l.properties[v].name,I=l.properties[v].targetType;A==="target"?I==="SceneProperties"?y=p=i:I==="MaterialProperties"?y=p=i.getMaterialByName(y):y=p=i.getNodeByName(y):A==="parent"?y=i.getNodeByName(y):A==="sound"?i.getSoundByName&&(y=i.getSoundByName(y)):A!=="propertyPath"?l.type===2&&A==="operator"?y=ui[y]:y=a(A,y,p,A==="value"?m:null):m=y,f.push(y)}if(d===null?f.push(u):f.push(null),l.name==="InterpolateValueAction"){const v=f[f.length-2];f[f.length-1]=v,f[f.length-2]=u}let E=r(l.name,f);if(E instanceof kl&&u!==null){const v=new $E(c,u);h?h.then(v):n.registerAction(v),h=v}d===null?E instanceof kl?(u=E,E=h):(u=null,h?h.then(E):n.registerAction(E)):d.push(E);for(let v=0;v<l.children.length;v++)o(l.children[v],c,u,E,null)};for(let l=0;l<e.children.length;l++){let c;const u=e.children[l];if(u.properties.length>0){const h=u.properties[0].value,d=u.properties[0].targetType===null?h:i.getMeshByName(h);d._meshId&&(d.mesh=i.getMeshById(d._meshId)),c={trigger:at[u.name],parameter:d}}else c=at[u.name];for(let h=0;h<u.children.length;h++)u.detached||o(u.children[h],c,null,null)}}static GetTriggerName(e){switch(e){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnDoublePickTrigger";case 7:return"OnPickUpTrigger";case 8:return"OnLongPressTrigger";case 9:return"OnPointerOverTrigger";case 10:return"OnPointerOutTrigger";case 11:return"OnEveryFrameTrigger";case 12:return"OnIntersectionEnterTrigger";case 13:return"OnIntersectionExitTrigger";case 14:return"OnKeyDownTrigger";case 15:return"OnKeyUpTrigger";case 16:return"OnPickOutTrigger";default:return""}}}at.NothingTrigger=0;at.OnPickTrigger=1;at.OnLeftPickTrigger=2;at.OnRightPickTrigger=3;at.OnCenterPickTrigger=4;at.OnPickDownTrigger=5;at.OnDoublePickTrigger=6;at.OnPickUpTrigger=7;at.OnPickOutTrigger=16;at.OnLongPressTrigger=8;at.OnPointerOverTrigger=9;at.OnPointerOutTrigger=10;at.OnEveryFrameTrigger=11;at.OnIntersectionEnterTrigger=12;at.OnIntersectionExitTrigger=13;at.OnKeyDownTrigger=14;at.OnKeyUpTrigger=15;class fM{constructor(e,t,i){this.gradient=e,this.color1=t,this.color2=i}getColorToRef(e){if(!this.color2){e.copyFrom(this.color1);return}pe.LerpToRef(this.color1,this.color2,Math.random(),e)}}class pM{constructor(e,t){this.gradient=e,this.color=t}}class mM{constructor(e,t,i){this.gradient=e,this.factor1=t,this.factor2=i}getFactor(){return this.factor2===void 0||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()}}class Xn{static GetCurrentGradient(e,t,i){if(t[0].gradient>e){i(t[0],t[0],1);return}for(let r=0;r<t.length-1;r++){const a=t[r],o=t[r+1];if(e>=a.gradient&&e<=o.gradient){const l=(e-a.gradient)/(o.gradient-a.gradient);i(a,o,l);return}}const n=t.length-1;i(t[n],t[n],1)}}class lo{constructor(){this.direction1=new g(0,1,0),this.direction2=new g(0,1,0),this.minEmitBox=new g(-.5,-.5,-.5),this.maxEmitBox=new g(.5,.5,.5)}startDirectionFunction(e,t,i,n){const r=W.RandomRange(this.direction1.x,this.direction2.x),a=W.RandomRange(this.direction1.y,this.direction2.y),o=W.RandomRange(this.direction1.z,this.direction2.z);if(n){t.x=r,t.y=a,t.z=o;return}g.TransformNormalFromFloatsToRef(r,a,o,e,t)}startPositionFunction(e,t,i,n){const r=W.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),a=W.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),o=W.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(n){t.x=r,t.y=a,t.z=o;return}g.TransformCoordinatesFromFloatsToRef(r,a,o,e,t)}clone(){const e=new lo;return On.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e}parse(e){g.FromArrayToRef(e.direction1,0,this.direction1),g.FromArrayToRef(e.direction2,0,this.direction2),g.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),g.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)}}class ah{get radius(){return this._radius}set radius(e){this._radius=e,this._buildHeight()}get angle(){return this._angle}set angle(e){this._angle=e,this._buildHeight()}_buildHeight(){this._angle!==0?this._height=this._radius/Math.tan(this._angle/2):this._height=1}constructor(e=1,t=Math.PI,i=0){this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}startDirectionFunction(e,t,i,n){n?w.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(e.getTranslation(),w.Vector3[0]).normalize();const r=W.RandomRange(0,this.directionRandomizer),a=W.RandomRange(0,this.directionRandomizer),o=W.RandomRange(0,this.directionRandomizer);t.x=w.Vector3[0].x+r,t.y=w.Vector3[0].y+a,t.z=w.Vector3[0].z+o,t.normalize()}startPositionFunction(e,t,i,n){const r=W.RandomRange(0,Math.PI*2);let a;this.emitFromSpawnPointOnly?a=1e-4:(a=W.RandomRange(0,this.heightRange),a=1-a*a);let o=this._radius-W.RandomRange(0,this._radius*this.radiusRange);o=o*a;const l=o*Math.sin(r),c=o*Math.cos(r),u=a*this._height;if(n){t.x=l,t.y=u,t.z=c;return}g.TransformCoordinatesFromFloatsToRef(l,u,c,e,t)}clone(){const e=new ah(this._radius,this._angle,this.directionRandomizer);return On.DeepCopy(this,e),e}applyToShader(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)}getEffectDefines(){let e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+=`
#define CONEEMITTERSPAWNPOINT`),e}getClassName(){return"ConeParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e}parse(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=e.radiusRange!==void 0?e.radiusRange:1,this.heightRange=e.radiusRange!==void 0?e.heightRange:1,this.emitFromSpawnPointOnly=e.emitFromSpawnPointOnly!==void 0?e.emitFromSpawnPointOnly:!1}}class sc{constructor(e=1,t=1,i=1,n=0){this.radius=e,this.height=t,this.radiusRange=i,this.directionRandomizer=n,this._tempVector=g.Zero()}startDirectionFunction(e,t,i,n,r){i.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),g.TransformNormalToRef(this._tempVector,r,this._tempVector);const a=W.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2);let o=Math.atan2(this._tempVector.x,this._tempVector.z);if(o+=W.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=a,this._tempVector.x=Math.sin(o),this._tempVector.z=Math.cos(o),this._tempVector.normalize(),n){t.copyFrom(this._tempVector);return}g.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)}startPositionFunction(e,t,i,n){const r=W.RandomRange(-this.height/2,this.height/2),a=W.RandomRange(0,2*Math.PI),o=W.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),l=Math.sqrt(o)*this.radius,c=l*Math.cos(a),u=l*Math.sin(a);if(n){t.copyFromFloats(c,r,u);return}g.TransformCoordinatesFromFloatsToRef(c,r,u,e,t)}clone(){const e=new sc(this.radius,this.directionRandomizer);return On.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class oh extends sc{constructor(e=1,t=1,i=1,n=new g(0,1,0),r=new g(0,1,0)){super(e,t,i),this.direction1=n,this.direction2=r}startDirectionFunction(e,t){const i=W.RandomRange(this.direction1.x,this.direction2.x),n=W.RandomRange(this.direction1.y,this.direction2.y),r=W.RandomRange(this.direction1.z,this.direction2.z);g.TransformNormalFromFloatsToRef(i,n,r,e,t)}clone(){const e=new oh(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return On.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define CYLINDEREMITTER
#define DIRECTEDCYLINDEREMITTER`}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class lh{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,n){const r=i.position.subtract(e.getTranslation()).normalize(),a=W.RandomRange(0,this.directionRandomizer),o=W.RandomRange(0,this.directionRandomizer),l=W.RandomRange(0,this.directionRandomizer);if(r.x+=a,r.y+=o,r.z+=l,r.normalize(),n){t.copyFrom(r);return}g.TransformNormalFromFloatsToRef(r.x,r.y,r.z,e,t)}startPositionFunction(e,t,i,n){const r=this.radius-W.RandomRange(0,this.radius*this.radiusRange),a=W.RandomRange(0,1),o=W.RandomRange(0,2*Math.PI),l=Math.acos(2*a-1),c=r*Math.cos(o)*Math.sin(l),u=r*Math.cos(l),h=r*Math.sin(o)*Math.sin(l);if(n){t.copyFromFloats(c,Math.abs(u),h);return}g.TransformCoordinatesFromFloatsToRef(c,Math.abs(u),h,e,t)}clone(){const e=new lh(this.radius,this.directionRandomizer);return On.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class ch{constructor(){this.direction1=new g(0,1,0),this.direction2=new g(0,1,0)}startDirectionFunction(e,t,i,n){const r=W.RandomRange(this.direction1.x,this.direction2.x),a=W.RandomRange(this.direction1.y,this.direction2.y),o=W.RandomRange(this.direction1.z,this.direction2.z);if(n){t.copyFromFloats(r,a,o);return}g.TransformNormalFromFloatsToRef(r,a,o,e,t)}startPositionFunction(e,t,i,n){if(n){t.copyFromFloats(0,0,0);return}g.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)}clone(){const e=new ch;return On.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){g.FromArrayToRef(e.direction1,0,this.direction1),g.FromArrayToRef(e.direction2,0,this.direction2)}}class rc{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,n){const r=i.position.subtract(e.getTranslation()).normalize(),a=W.RandomRange(0,this.directionRandomizer),o=W.RandomRange(0,this.directionRandomizer),l=W.RandomRange(0,this.directionRandomizer);if(r.x+=a,r.y+=o,r.z+=l,r.normalize(),n){t.copyFrom(r);return}g.TransformNormalFromFloatsToRef(r.x,r.y,r.z,e,t)}startPositionFunction(e,t,i,n){const r=this.radius-W.RandomRange(0,this.radius*this.radiusRange),a=W.RandomRange(0,1),o=W.RandomRange(0,2*Math.PI),l=Math.acos(2*a-1),c=r*Math.cos(o)*Math.sin(l),u=r*Math.cos(l),h=r*Math.sin(o)*Math.sin(l);if(n){t.copyFromFloats(c,u,h);return}g.TransformCoordinatesFromFloatsToRef(c,u,h,e,t)}clone(){const e=new rc(this.radius,this.directionRandomizer);return On.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class uh extends rc{constructor(e=1,t=new g(0,1,0),i=new g(0,1,0)){super(e),this.direction1=t,this.direction2=i}startDirectionFunction(e,t){const i=W.RandomRange(this.direction1.x,this.direction2.x),n=W.RandomRange(this.direction1.y,this.direction2.y),r=W.RandomRange(this.direction1.z,this.direction2.z);g.TransformNormalFromFloatsToRef(i,n,r,e,t)}clone(){const e=new uh(this.radius,this.direction1,this.direction2);return On.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define SPHEREEMITTER
#define DIRECTEDSPHEREEMITTER`}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class cm{get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh=e,e?(this._indices=e.getIndices(),this._positions=e.getVerticesData(C.PositionKind),this._normals=e.getVerticesData(C.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))}constructor(e=null){this._indices=null,this._positions=null,this._normals=null,this._storedNormal=g.Zero(),this._mesh=null,this.direction1=new g(0,1,0),this.direction2=new g(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=e}startDirectionFunction(e,t,i,n){if(this.useMeshNormalsForDirection&&this._normals){g.TransformNormalToRef(this._storedNormal,e,t);return}const r=W.RandomRange(this.direction1.x,this.direction2.x),a=W.RandomRange(this.direction1.y,this.direction2.y),o=W.RandomRange(this.direction1.z,this.direction2.z);if(n){t.copyFromFloats(r,a,o);return}g.TransformNormalFromFloatsToRef(r,a,o,e,t)}startPositionFunction(e,t,i,n){if(!this._indices||!this._positions)return;const r=3*Math.random()*(this._indices.length/3)|0,a=Math.random(),o=Math.random()*(1-a),l=1-a-o,c=this._indices[r],u=this._indices[r+1],h=this._indices[r+2],d=w.Vector3[0],f=w.Vector3[1],p=w.Vector3[2],m=w.Vector3[3];g.FromArrayToRef(this._positions,c*3,d),g.FromArrayToRef(this._positions,u*3,f),g.FromArrayToRef(this._positions,h*3,p),m.x=a*d.x+o*f.x+l*p.x,m.y=a*d.y+o*f.y+l*p.y,m.z=a*d.z+o*f.z+l*p.z,n?t.copyFromFloats(m.x,m.y,m.z):g.TransformCoordinatesFromFloatsToRef(m.x,m.y,m.z,e,t),this.useMeshNormalsForDirection&&this._normals&&(g.FromArrayToRef(this._normals,c*3,d),g.FromArrayToRef(this._normals,u*3,f),g.FromArrayToRef(this._normals,h*3,p),this._storedNormal.x=a*d.x+o*f.x+l*p.x,this._storedNormal.y=a*d.y+o*f.y+l*p.y,this._storedNormal.z=a*d.z+o*f.z+l*p.z)}clone(){const e=new cm(this.mesh);return On.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return""}getClassName(){return"MeshParticleEmitter"}serialize(){var e;const t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t.meshId=(e=this.mesh)===null||e===void 0?void 0:e.id,t.useMeshNormalsForDirection=this.useMeshNormalsForDirection,t}parse(e,t){g.FromArrayToRef(e.direction1,0,this.direction1),g.FromArrayToRef(e.direction2,0,this.direction2),e.meshId&&t&&(this.mesh=t.getLastMeshById(e.meshId)),this.useMeshNormalsForDirection=e.useMeshNormalsForDirection}}class Qr{get noiseTexture(){return this._noiseTexture}set noiseTexture(e){this._noiseTexture!==e&&(this._noiseTexture=e,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(e){this._isAnimationSheetEnabled!=e&&(this._isAnimationSheetEnabled=e,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:g.Zero()}set direction1(e){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=e)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:g.Zero()}set direction2(e){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=e)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:g.Zero()}set minEmitBox(e){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=e)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:g.Zero()}set maxEmitBox(e){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=e)}get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(e){this._isBillboardBased!==e&&(this._isBillboardBased=e,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(!e&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=e)}_reset(){}_removeGradientAndTexture(e,t,i){if(!t)return this;let n=0;for(const r of t){if(r.gradient===e){t.splice(n,1);break}n++}return i&&i.dispose(),this}constructor(e){this.animations=[],this.renderingGroupId=0,this.emitter=g.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new g(10,10,10),this.onAnimationEnd=null,this.blendMode=Qr.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new j(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new g(0,0,0),this._useLogarithmicDepth=!1,this.gravity=g.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new pe(1,1,1,1),this.color2=new pe(1,1,1,1),this.colorDead=new pe(0,0,0,1),this.textureMask=new pe(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new $T,this.id=e,this.name=e}createPointEmitter(e,t){const i=new ch;return i.direction1=e,i.direction2=t,this.particleEmitterType=i,i}createHemisphericEmitter(e=1,t=1){const i=new lh(e,t);return this.particleEmitterType=i,i}createSphereEmitter(e=1,t=1){const i=new rc(e,t);return this.particleEmitterType=i,i}createDirectedSphereEmitter(e=1,t=new g(0,1,0),i=new g(0,1,0)){const n=new uh(e,t,i);return this.particleEmitterType=n,n}createCylinderEmitter(e=1,t=1,i=1,n=0){const r=new sc(e,t,i,n);return this.particleEmitterType=r,r}createDirectedCylinderEmitter(e=1,t=1,i=1,n=new g(0,1,0),r=new g(0,1,0)){const a=new oh(e,t,i,n,r);return this.particleEmitterType=a,a}createConeEmitter(e=1,t=Math.PI/4){const i=new ah(e,t);return this.particleEmitterType=i,i}createBoxEmitter(e,t,i,n){const r=new lo;return this.particleEmitterType=r,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=n,r}}Qr.BLENDMODE_ONEONE=0;Qr.BLENDMODE_STANDARD=1;Qr.BLENDMODE_ADD=2;Qr.BLENDMODE_MULTIPLY=3;Qr.BLENDMODE_MULTIPLYADD=4;class Ul{constructor(e){this.particleSystem=e,this.position=g.Zero(),this.direction=g.Zero(),this.color=new pe(0,0,0,0),this.colorStep=new pe(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new j(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new pe(0,0,0,0),this._currentColor2=new pe(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=Ul._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}_updateCellInfoFromSystem(){this.cellIndex=this.particleSystem.startSpriteCellID}updateCellIndex(){let e=this.age,t=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(this._randomCellOffset===void 0&&(this._randomCellOffset=Math.random()*this.lifeTime),t===0?(t=1,e=this._randomCellOffset):e+=this._randomCellOffset);const i=this._initialEndSpriteCellID-this._initialStartSpriteCellID;let n;this._initialSpriteCellLoop?n=W.Clamp(e*t%this.lifeTime/this.lifeTime):n=W.Clamp(e*t/this.lifeTime),this.cellIndex=this._initialStartSpriteCellID+n*i|0}_inheritParticleInfoToSubEmitter(e){if(e.particleSystem.emitter.position){const t=e.particleSystem.emitter;if(t.position.copyFrom(this.position),e.inheritDirection){const i=w.Vector3[0];this.direction.normalizeToRef(i),t.setDirection(i,0,Math.PI/2)}}else e.particleSystem.emitter.copyFrom(this.position);this.direction.scaleToRef(e.inheritedVelocityAmount/2,w.Vector3[0]),e.particleSystem._inheritedVelocityOffset.copyFrom(w.Vector3[0])}_inheritParticleInfoToSubEmitters(){this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach(e=>{this._inheritParticleInfoToSubEmitter(e)})}_reset(){this.age=0,this.id=Ul._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0}copyTo(e){e.position.copyFrom(this.position),this._initialDirection?e._initialDirection?e._initialDirection.copyFrom(this._initialDirection):e._initialDirection=this._initialDirection.clone():e._initialDirection=null,e.direction.copyFrom(this.direction),this._localPosition&&(e._localPosition?e._localPosition.copyFrom(this._localPosition):e._localPosition=this._localPosition.clone()),e.color.copyFrom(this.color),e.colorStep.copyFrom(this.colorStep),e.lifeTime=this.lifeTime,e.age=this.age,e._randomCellOffset=this._randomCellOffset,e.size=this.size,e.scale.copyFrom(this.scale),e.angle=this.angle,e.angularSpeed=this.angularSpeed,e.particleSystem=this.particleSystem,e.cellIndex=this.cellIndex,e.id=this.id,e._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(e._currentColorGradient=this._currentColorGradient,e._currentColor1.copyFrom(this._currentColor1),e._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(e._currentSizeGradient=this._currentSizeGradient,e._currentSize1=this._currentSize1,e._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(e._currentAngularSpeedGradient=this._currentAngularSpeedGradient,e._currentAngularSpeed1=this._currentAngularSpeed1,e._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(e._currentVelocityGradient=this._currentVelocityGradient,e._currentVelocity1=this._currentVelocity1,e._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(e._currentLimitVelocityGradient=this._currentLimitVelocityGradient,e._currentLimitVelocity1=this._currentLimitVelocity1,e._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(e._currentDragGradient=this._currentDragGradient,e._currentDrag1=this._currentDrag1,e._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(e._initialStartSpriteCellID=this._initialStartSpriteCellID,e._initialEndSpriteCellID=this._initialEndSpriteCellID,e._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(e.remapData&&this.remapData?e.remapData.copyFrom(this.remapData):e.remapData=new dt(0,0,0,0)),this._randomNoiseCoordinates1&&(e._randomNoiseCoordinates1?(e._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),e._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(e._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),e._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))}}Ul._Count=0;var Vl;(function(s){s[s.ATTACHED=0]="ATTACHED",s[s.END=1]="END"})(Vl||(Vl={}));class Nr{constructor(e){if(this.particleSystem=e,this.type=Vl.END,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!e.emitter||!e.emitter.dispose){const t=hn("BABYLON.AbstractMesh");e.emitter=new t("SubemitterSystemEmitter",e.getScene()),e._disposeEmitterOnDispose=!0}}clone(){let e=this.particleSystem.emitter;if(!e)e=new g;else if(e instanceof g)e=e.clone();else if(e.getClassName().indexOf("Mesh")!==-1){const i=hn("BABYLON.Mesh");e=new i("",e.getScene()),e.isVisible=!1}const t=new Nr(this.particleSystem.clone(this.particleSystem.name,e));return t.particleSystem.name+="Clone",t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem._disposeEmitterOnDispose=!0,t.particleSystem.disposeOnStop=!0,t}serialize(e=!1){const t={};return t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem=this.particleSystem.serialize(e),t}static _ParseParticleSystem(e,t,i,n=!1){throw De("ParseParticle")}static Parse(e,t,i){const n=e.particleSystem,r=new Nr(Nr._ParseParticleSystem(n,t,i,!0));return r.type=e.type,r.inheritDirection=e.inheritDirection,r.inheritedVelocityAmount=e.inheritedVelocityAmount,r.particleSystem._isSubEmitter=!0,r}dispose(){this.particleSystem.dispose()}}const _M="particlesPixelShader",gM=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
varying vec2 vUV;varying vec4 vColor;uniform vec4 textureMask;uniform sampler2D diffuseSampler;
#include<clipPlaneFragmentDeclaration>
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#ifdef RAMPGRADIENT
varying vec4 remapRanges;uniform sampler2D rampSampler;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec4 textureColor=texture2D(diffuseSampler,vUV);vec4 baseColor=(textureColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;
#ifdef RAMPGRADIENT
float alpha=baseColor.a;float remappedColorIndex=clamp((alpha-remapRanges.x)/remapRanges.y,0.0,1.0);vec4 rampColor=texture2D(rampSampler,vec2(1.0-remappedColorIndex,0.));baseColor.rgb*=rampColor.rgb;float finalAlpha=baseColor.a;baseColor.a=clamp((alpha*rampColor.a-remapRanges.z)/remapRanges.w,0.0,1.0);
#endif
#ifdef BLENDMULTIPLYMODE
float sourceAlpha=vColor.a*textureColor.a;baseColor.rgb=baseColor.rgb*sourceAlpha+vec3(1.0)*(1.0-sourceAlpha);
#endif
#include<logDepthFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
baseColor.rgb=toLinearSpace(baseColor.rgb);
#else
#ifdef IMAGEPROCESSING
baseColor.rgb=toLinearSpace(baseColor.rgb);baseColor=applyImageProcessing(baseColor);
#endif
#endif
gl_FragColor=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;Q.ShadersStore[_M]=gM;const EM="particlesVertexShader",vM=`attribute vec3 position;attribute vec4 color;attribute float angle;attribute vec2 size;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
#ifndef BILLBOARD
attribute vec3 direction;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
#ifdef RAMPGRADIENT
attribute vec4 remapData;
#endif
attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;
#ifdef ANIMATESHEET
uniform vec3 particlesInfos; 
#endif
varying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
#endif
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration>
#include<logDepthDeclaration>
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;return position+alignedCorner;}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
#ifdef BILLBOARDSTRETCHED_LOCAL
vec3 row1=direction;
#else
vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);
#endif
mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;return position+alignedCorner;}
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec2 cornerPos;cornerPos=(vec2(offset.x-0.5,offset.y -0.5)-translationPivot)*size;
#ifdef BILLBOARD
vec3 rotatedCorner;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=position-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner);vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=position-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner);vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 viewPos=(view*vec4(position,1.0)).xyz+rotatedCorner;vPositionW=(invView*vec4(viewPos,1)).xyz;
#endif
#ifdef RAMPGRADIENT
remapRanges=remapData;
#endif
gl_Position=projection*vec4(viewPos,1.0);
#else
vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(direction);vPositionW=rotate(yaxis,rotatedCorner);gl_Position=projection*view*vec4(vPositionW,1.0);
#endif
vColor=color;
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex*particlesInfos.z);float columnOffset=cellIndex-rowOffset/particlesInfos.z;vec2 uvScale=particlesInfos.xy;vec2 uvOffset=vec2(offset.x ,1.0-offset.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=offset;
#endif
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;Q.ShadersStore[EM]=vM;class He extends Qr{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get useRampGradients(){return this._useRampGradients}set useRampGradients(e){this._useRampGradients!==e&&(this._useRampGradients=e,this._resetEffect())}get particles(){return this._particles}getActiveCount(){return this._particles.length}getClassName(){return"ParticleSystem"}isStopping(){return this._stopped&&this.isAlive()}getCustomEffect(e=0){var t,i;return(i=(t=this._customWrappers[e])===null||t===void 0?void 0:t.effect)!==null&&i!==void 0?i:this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){var t;return(t=this._customWrappers[e])!==null&&t!==void 0?t:this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new Lr(this._engine),this._customWrappers[t].effect=e,this._customWrappers[t].drawContext&&(this._customWrappers[t].drawContext.useInstancing=this._useInstancing)}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new O),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"particles"}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}constructor(e,t,i,n=null,r=!1,a=.01){super(e),this._emitterInverseWorldMatrix=D.Identity(),this._inheritedVelocityOffset=new g,this.onDisposeObservable=new O,this.onStoppedObservable=new O,this._particles=new Array,this._stockParticles=new Array,this._newPartsExcess=0,this._vertexBuffers={},this._scaledColorStep=new pe(0,0,0,0),this._colorDiff=new pe(0,0,0,0),this._scaledDirection=g.Zero(),this._scaledGravity=g.Zero(),this._currentRenderId=-1,this._useInstancing=!1,this._started=!1,this._stopped=!1,this._actualFrame=0,this._currentEmitRate1=0,this._currentEmitRate2=0,this._currentStartSize1=0,this._currentStartSize2=0,this.updateInAnimate=!0,this._rawTextureWidth=256,this._useRampGradients=!1,this._disposeEmitterOnDispose=!1,this.isLocal=!1,this.isGPU=!1,this._onBeforeDrawParticlesObservable=null,this.recycleParticle=l=>{const c=this._particles.pop();c!==l&&c.copyTo(l),this._stockParticles.push(c)},this._createParticle=()=>{let l;if(this._stockParticles.length!==0?(l=this._stockParticles.pop(),l._reset()):l=new Ul(this),this._subEmitters&&this._subEmitters.length>0){const c=this._subEmitters[Math.floor(Math.random()*this._subEmitters.length)];l._attachedSubEmitters=[],c.forEach(u=>{if(u.type===Vl.ATTACHED){const h=u.clone();l._attachedSubEmitters.push(h),h.particleSystem.start()}})}return l},this._emitFromParticle=l=>{if(!this._subEmitters||this._subEmitters.length===0)return;const c=Math.floor(Math.random()*this._subEmitters.length);this._subEmitters[c].forEach(u=>{if(u.type===Vl.END){const h=u.clone();l._inheritParticleInfoToSubEmitter(h),h.particleSystem._rootParticleSystem=this,this.activeSubSystems.push(h.particleSystem),h.particleSystem.start()}})},this._capacity=t,this._epsilon=a,this._isAnimationSheetEnabled=r,!i||i.getClassName()==="Scene"?(this._scene=i||Fe.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)):(this._engine=i,this.defaultProjectionMatrix=D.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._attachImageProcessingConfiguration(null),this._customWrappers={0:new Lr(this._engine)},this._customWrappers[0].effect=n,this._drawWrappers=[],this._useInstancing=this._engine.getCaps().instancedArrays,this._createIndexBuffer(),this._createVertexBuffers(),this.particleEmitterType=new lo;let o=null;this.updateFunction=l=>{var c;let u=null;this.noiseTexture&&(u=this.noiseTexture.getSize(),(c=this.noiseTexture.getContent())===null||c===void 0||c.then(d=>{o=d}));const h=l===this._particles;for(let d=0;d<l.length;d++){const f=l[d];let p=this._scaledUpdateSpeed;const m=f.age;if(f.age+=p,f.age>f.lifeTime){const v=f.age-m;p=(f.lifeTime-m)*p/v,f.age=f.lifeTime}const _=f.age/f.lifeTime;this._colorGradients&&this._colorGradients.length>0?Xn.GetCurrentGradient(_,this._colorGradients,(v,y,A)=>{v!==f._currentColorGradient&&(f._currentColor1.copyFrom(f._currentColor2),y.getColorToRef(f._currentColor2),f._currentColorGradient=v),pe.LerpToRef(f._currentColor1,f._currentColor2,A,f.color)}):(f.colorStep.scaleToRef(p,this._scaledColorStep),f.color.addInPlace(this._scaledColorStep),f.color.a<0&&(f.color.a=0)),this._angularSpeedGradients&&this._angularSpeedGradients.length>0&&Xn.GetCurrentGradient(_,this._angularSpeedGradients,(v,y,A)=>{v!==f._currentAngularSpeedGradient&&(f._currentAngularSpeed1=f._currentAngularSpeed2,f._currentAngularSpeed2=y.getFactor(),f._currentAngularSpeedGradient=v),f.angularSpeed=W.Lerp(f._currentAngularSpeed1,f._currentAngularSpeed2,A)}),f.angle+=f.angularSpeed*p;let E=p;if(this._velocityGradients&&this._velocityGradients.length>0&&Xn.GetCurrentGradient(_,this._velocityGradients,(v,y,A)=>{v!==f._currentVelocityGradient&&(f._currentVelocity1=f._currentVelocity2,f._currentVelocity2=y.getFactor(),f._currentVelocityGradient=v),E*=W.Lerp(f._currentVelocity1,f._currentVelocity2,A)}),f.direction.scaleToRef(E,this._scaledDirection),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&Xn.GetCurrentGradient(_,this._limitVelocityGradients,(v,y,A)=>{v!==f._currentLimitVelocityGradient&&(f._currentLimitVelocity1=f._currentLimitVelocity2,f._currentLimitVelocity2=y.getFactor(),f._currentLimitVelocityGradient=v);const I=W.Lerp(f._currentLimitVelocity1,f._currentLimitVelocity2,A);f.direction.length()>I&&f.direction.scaleInPlace(this.limitVelocityDamping)}),this._dragGradients&&this._dragGradients.length>0&&Xn.GetCurrentGradient(_,this._dragGradients,(v,y,A)=>{v!==f._currentDragGradient&&(f._currentDrag1=f._currentDrag2,f._currentDrag2=y.getFactor(),f._currentDragGradient=v);const I=W.Lerp(f._currentDrag1,f._currentDrag2,A);this._scaledDirection.scaleInPlace(1-I)}),this.isLocal&&f._localPosition?(f._localPosition.addInPlace(this._scaledDirection),g.TransformCoordinatesToRef(f._localPosition,this._emitterWorldMatrix,f.position)):f.position.addInPlace(this._scaledDirection),o&&u&&f._randomNoiseCoordinates1){const v=this._fetchR(f._randomNoiseCoordinates1.x,f._randomNoiseCoordinates1.y,u.width,u.height,o),y=this._fetchR(f._randomNoiseCoordinates1.z,f._randomNoiseCoordinates2.x,u.width,u.height,o),A=this._fetchR(f._randomNoiseCoordinates2.y,f._randomNoiseCoordinates2.z,u.width,u.height,o),I=w.Vector3[0],T=w.Vector3[1];I.copyFromFloats((2*v-1)*this.noiseStrength.x,(2*y-1)*this.noiseStrength.y,(2*A-1)*this.noiseStrength.z),I.scaleToRef(p,T),f.direction.addInPlace(T)}if(this.gravity.scaleToRef(p,this._scaledGravity),f.direction.addInPlace(this._scaledGravity),this._sizeGradients&&this._sizeGradients.length>0&&Xn.GetCurrentGradient(_,this._sizeGradients,(v,y,A)=>{v!==f._currentSizeGradient&&(f._currentSize1=f._currentSize2,f._currentSize2=y.getFactor(),f._currentSizeGradient=v),f.size=W.Lerp(f._currentSize1,f._currentSize2,A)}),this._useRampGradients&&(this._colorRemapGradients&&this._colorRemapGradients.length>0&&Xn.GetCurrentGradient(_,this._colorRemapGradients,(v,y,A)=>{const I=W.Lerp(v.factor1,y.factor1,A),T=W.Lerp(v.factor2,y.factor2,A);f.remapData.x=I,f.remapData.y=T-I}),this._alphaRemapGradients&&this._alphaRemapGradients.length>0&&Xn.GetCurrentGradient(_,this._alphaRemapGradients,(v,y,A)=>{const I=W.Lerp(v.factor1,y.factor1,A),T=W.Lerp(v.factor2,y.factor2,A);f.remapData.z=I,f.remapData.w=T-I})),this._isAnimationSheetEnabled&&f.updateCellIndex(),f._inheritParticleInfoToSubEmitters(),f.age>=f.lifeTime){this._emitFromParticle(f),f._attachedSubEmitters&&(f._attachedSubEmitters.forEach(v=>{v.particleSystem.disposeOnStop=!0,v.particleSystem.stop()}),f._attachedSubEmitters=null),this.recycleParticle(f),h&&d--;continue}}}}_addFactorGradient(e,t,i,n){const r=new mM(t,i,n);e.push(r),e.sort((a,o)=>a.gradient<o.gradient?-1:a.gradient>o.gradient?1:0)}_removeFactorGradient(e,t){if(!e)return;let i=0;for(const n of e){if(n.gradient===t){e.splice(i,1);break}i++}}addLifeTimeGradient(e,t,i){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,e,t,i),this}removeLifeTimeGradient(e){return this._removeFactorGradient(this._lifeTimeGradients,e),this}addSizeGradient(e,t,i){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t,i),this}removeSizeGradient(e){return this._removeFactorGradient(this._sizeGradients,e),this}addColorRemapGradient(e,t,i){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,e,t,i),this}removeColorRemapGradient(e){return this._removeFactorGradient(this._colorRemapGradients,e),this}addAlphaRemapGradient(e,t,i){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,e,t,i),this}removeAlphaRemapGradient(e){return this._removeFactorGradient(this._alphaRemapGradients,e),this}addAngularSpeedGradient(e,t,i){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t,i),this}removeAngularSpeedGradient(e){return this._removeFactorGradient(this._angularSpeedGradients,e),this}addVelocityGradient(e,t,i){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t,i),this}removeVelocityGradient(e){return this._removeFactorGradient(this._velocityGradients,e),this}addLimitVelocityGradient(e,t,i){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t,i),this}removeLimitVelocityGradient(e){return this._removeFactorGradient(this._limitVelocityGradients,e),this}addDragGradient(e,t,i){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t,i),this}removeDragGradient(e){return this._removeFactorGradient(this._dragGradients,e),this}addEmitRateGradient(e,t,i){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,e,t,i),this}removeEmitRateGradient(e){return this._removeFactorGradient(this._emitRateGradients,e),this}addStartSizeGradient(e,t,i){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,e,t,i),this}removeStartSizeGradient(e){return this._removeFactorGradient(this._startSizeGradients,e),this}_createRampGradientTexture(){if(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)return;const e=new Uint8Array(this._rawTextureWidth*4),t=jn.Color3[0];for(let i=0;i<this._rawTextureWidth;i++){const n=i/this._rawTextureWidth;Xn.GetCurrentGradient(n,this._rampGradients,(r,a,o)=>{G.LerpToRef(r.color,a.color,o,t),e[i*4]=t.r*255,e[i*4+1]=t.g*255,e[i*4+2]=t.b*255,e[i*4+3]=255})}this._rampGradientsTexture=an.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}getRampGradients(){return this._rampGradients}forceRefreshGradients(){this._syncRampGradientTexture()}_syncRampGradientTexture(){this._rampGradients&&(this._rampGradients.sort((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())}addRampGradient(e,t){this._rampGradients||(this._rampGradients=[]);const i=new pM(e,t);return this._rampGradients.push(i),this._syncRampGradientTexture(),this}removeRampGradient(e){return this._removeGradientAndTexture(e,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this}addColorGradient(e,t,i){this._colorGradients||(this._colorGradients=[]);const n=new fM(e,t,i);return this._colorGradients.push(n),this._colorGradients.sort((r,a)=>r.gradient<a.gradient?-1:r.gradient>a.gradient?1:0),this}removeColorGradient(e){if(!this._colorGradients)return this;let t=0;for(const i of this._colorGradients){if(i.gradient===e){this._colorGradients.splice(t,1);break}t++}return this}resetDrawCache(){for(const e of this._drawWrappers)if(e)for(const t of e)t==null||t.dispose();this._drawWrappers=[]}_fetchR(e,t,i,n,r){e=Math.abs(e)*.5+.5,t=Math.abs(t)*.5+.5;const a=e*i%i|0,o=t*n%n|0,l=(a+o*i)*4;return r[l]/255}_reset(){this._resetEffect()}_resetEffect(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()}_createVertexBuffers(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),(!this._isBillboardBased||this.billboardMode===He.BILLBOARDMODE_STRETCHED||this.billboardMode===He.BILLBOARDMODE_STRETCHED_LOCAL)&&(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);const e=this._engine,t=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*t),this._vertexBuffer=new zr(e,this._vertexData,!0,t);let i=0;const n=this._vertexBuffer.createVertexBuffer(C.PositionKind,i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[C.PositionKind]=n,i+=3;const r=this._vertexBuffer.createVertexBuffer(C.ColorKind,i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[C.ColorKind]=r,i+=4;const a=this._vertexBuffer.createVertexBuffer("angle",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=a,i+=1;const o=this._vertexBuffer.createVertexBuffer("size",i,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=o,i+=2,this._isAnimationSheetEnabled){const c=this._vertexBuffer.createVertexBuffer("cellIndex",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=c,i+=1}if(!this._isBillboardBased||this.billboardMode===He.BILLBOARDMODE_STRETCHED||this.billboardMode===He.BILLBOARDMODE_STRETCHED_LOCAL){const c=this._vertexBuffer.createVertexBuffer("direction",i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=c,i+=3}if(this._useRampGradients){const c=this._vertexBuffer.createVertexBuffer("remapData",i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=c,i+=4}let l;if(this._useInstancing){const c=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new zr(e,c,!1,2),l=this._spriteBuffer.createVertexBuffer("offset",0,2)}else l=this._vertexBuffer.createVertexBuffer("offset",i,2,this._vertexBufferSize,this._useInstancing),i+=2;this._vertexBuffers.offset=l,this.resetDrawCache()}_createIndexBuffer(){if(this._useInstancing){this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3]));return}const e=[],t=[];let i=0;for(let n=0;n<this._capacity;n++)e.push(i),e.push(i+1),e.push(i+2),e.push(i),e.push(i+2),e.push(i+3),t.push(i,i+1,i+1,i+2,i+2,i+3,i+3,i,i,i+3),i+=4;this._indexBuffer=this._engine.createIndexBuffer(e),this._linesIndexBuffer=this._engine.createIndexBuffer(t)}getCapacity(){return this._capacity}isAlive(){return this._alive}isStarted(){return this._started}_prepareSubEmitterInternalArray(){this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach(e=>{e instanceof He?this._subEmitters.push([new Nr(e)]):e instanceof Nr?this._subEmitters.push([e]):e instanceof Array&&this._subEmitters.push(e)})}start(e=this.startDelay){var t;if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(()=>{this.start(0)},e);return}if(this._prepareSubEmitterInternalArray(),this._started=!0,this._stopped=!1,this._actualFrame=0,this._subEmitters&&this._subEmitters.length!=0&&(this.activeSubSystems=new Array),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){((t=this.emitter)===null||t===void 0?void 0:t.getClassName().indexOf("Mesh"))!==-1&&this.emitter.computeWorldMatrix(!0);const i=this.noiseTexture;if(i&&i.onGeneratedObservable)i.onGeneratedObservable.addOnce(()=>{setTimeout(()=>{for(let n=0;n<this.preWarmCycles;n++)this.animate(!0),i.render()})});else for(let n=0;n<this.preWarmCycles;n++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}stop(e=!0){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,e&&this._stopSubEmitters())}reset(){this._stockParticles.length=0,this._particles.length=0}_appendParticleVertex(e,t,i,n){let r=e*this._vertexBufferSize;if(this._vertexData[r++]=t.position.x+this.worldOffset.x,this._vertexData[r++]=t.position.y+this.worldOffset.y,this._vertexData[r++]=t.position.z+this.worldOffset.z,this._vertexData[r++]=t.color.r,this._vertexData[r++]=t.color.g,this._vertexData[r++]=t.color.b,this._vertexData[r++]=t.color.a,this._vertexData[r++]=t.angle,this._vertexData[r++]=t.scale.x*t.size,this._vertexData[r++]=t.scale.y*t.size,this._isAnimationSheetEnabled&&(this._vertexData[r++]=t.cellIndex),this._isBillboardBased)(this.billboardMode===He.BILLBOARDMODE_STRETCHED||this.billboardMode===He.BILLBOARDMODE_STRETCHED_LOCAL)&&(this._vertexData[r++]=t.direction.x,this._vertexData[r++]=t.direction.y,this._vertexData[r++]=t.direction.z);else if(t._initialDirection){let a=t._initialDirection;this.isLocal&&(g.TransformNormalToRef(a,this._emitterWorldMatrix,w.Vector3[0]),a=w.Vector3[0]),a.x===0&&a.z===0&&(a.x=.001),this._vertexData[r++]=a.x,this._vertexData[r++]=a.y,this._vertexData[r++]=a.z}else{let a=t.direction;this.isLocal&&(g.TransformNormalToRef(a,this._emitterWorldMatrix,w.Vector3[0]),a=w.Vector3[0]),a.x===0&&a.z===0&&(a.x=.001),this._vertexData[r++]=a.x,this._vertexData[r++]=a.y,this._vertexData[r++]=a.z}this._useRampGradients&&t.remapData&&(this._vertexData[r++]=t.remapData.x,this._vertexData[r++]=t.remapData.y,this._vertexData[r++]=t.remapData.z,this._vertexData[r++]=t.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(i===0?i=this._epsilon:i===1&&(i=1-this._epsilon),n===0?n=this._epsilon:n===1&&(n=1-this._epsilon)),this._vertexData[r++]=i,this._vertexData[r++]=n)}_stopSubEmitters(){this.activeSubSystems&&(this.activeSubSystems.forEach(e=>{e.stop(!0)}),this.activeSubSystems=new Array)}_removeFromRoot(){if(!this._rootParticleSystem)return;const e=this._rootParticleSystem.activeSubSystems.indexOf(this);e!==-1&&this._rootParticleSystem.activeSubSystems.splice(e,1),this._rootParticleSystem=null}_update(e){if(this._alive=this._particles.length>0,this.emitter.position){const i=this.emitter;this._emitterWorldMatrix=i.getWorldMatrix()}else{const i=this.emitter;this._emitterWorldMatrix=D.Translation(i.x,i.y,i.z)}this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles);let t;for(let i=0;i<e&&this._particles.length!==this._capacity;i++){if(t=this._createParticle(),this._particles.push(t),this.targetStopDuration&&this._lifeTimeGradients&&this._lifeTimeGradients.length>0){const r=W.Clamp(this._actualFrame/this.targetStopDuration);Xn.GetCurrentGradient(r,this._lifeTimeGradients,(a,o)=>{const l=a,c=o,u=l.getFactor(),h=c.getFactor(),d=(r-l.gradient)/(c.gradient-l.gradient);t.lifeTime=W.Lerp(u,h,d)})}else t.lifeTime=W.RandomRange(this.minLifeTime,this.maxLifeTime);const n=W.RandomRange(this.minEmitPower,this.maxEmitPower);if(this.startPositionFunction?this.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal):this.particleEmitterType.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal),this.isLocal&&(t._localPosition?t._localPosition.copyFrom(t.position):t._localPosition=t.position.clone(),g.TransformCoordinatesToRef(t._localPosition,this._emitterWorldMatrix,t.position)),this.startDirectionFunction?this.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal):this.particleEmitterType.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal,this._emitterInverseWorldMatrix),n===0?t._initialDirection?t._initialDirection.copyFrom(t.direction):t._initialDirection=t.direction.clone():t._initialDirection=null,t.direction.scaleInPlace(n),!this._sizeGradients||this._sizeGradients.length===0?t.size=W.RandomRange(this.minSize,this.maxSize):(t._currentSizeGradient=this._sizeGradients[0],t._currentSize1=t._currentSizeGradient.getFactor(),t.size=t._currentSize1,this._sizeGradients.length>1?t._currentSize2=this._sizeGradients[1].getFactor():t._currentSize2=t._currentSize1),t.scale.copyFromFloats(W.RandomRange(this.minScaleX,this.maxScaleX),W.RandomRange(this.minScaleY,this.maxScaleY)),this._startSizeGradients&&this._startSizeGradients[0]&&this.targetStopDuration){const r=this._actualFrame/this.targetStopDuration;Xn.GetCurrentGradient(r,this._startSizeGradients,(a,o,l)=>{a!==this._currentStartSizeGradient&&(this._currentStartSize1=this._currentStartSize2,this._currentStartSize2=o.getFactor(),this._currentStartSizeGradient=a);const c=W.Lerp(this._currentStartSize1,this._currentStartSize2,l);t.scale.scaleInPlace(c)})}if(!this._angularSpeedGradients||this._angularSpeedGradients.length===0?t.angularSpeed=W.RandomRange(this.minAngularSpeed,this.maxAngularSpeed):(t._currentAngularSpeedGradient=this._angularSpeedGradients[0],t.angularSpeed=t._currentAngularSpeedGradient.getFactor(),t._currentAngularSpeed1=t.angularSpeed,this._angularSpeedGradients.length>1?t._currentAngularSpeed2=this._angularSpeedGradients[1].getFactor():t._currentAngularSpeed2=t._currentAngularSpeed1),t.angle=W.RandomRange(this.minInitialRotation,this.maxInitialRotation),this._velocityGradients&&this._velocityGradients.length>0&&(t._currentVelocityGradient=this._velocityGradients[0],t._currentVelocity1=t._currentVelocityGradient.getFactor(),this._velocityGradients.length>1?t._currentVelocity2=this._velocityGradients[1].getFactor():t._currentVelocity2=t._currentVelocity1),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&(t._currentLimitVelocityGradient=this._limitVelocityGradients[0],t._currentLimitVelocity1=t._currentLimitVelocityGradient.getFactor(),this._limitVelocityGradients.length>1?t._currentLimitVelocity2=this._limitVelocityGradients[1].getFactor():t._currentLimitVelocity2=t._currentLimitVelocity1),this._dragGradients&&this._dragGradients.length>0&&(t._currentDragGradient=this._dragGradients[0],t._currentDrag1=t._currentDragGradient.getFactor(),this._dragGradients.length>1?t._currentDrag2=this._dragGradients[1].getFactor():t._currentDrag2=t._currentDrag1),!this._colorGradients||this._colorGradients.length===0){const r=W.RandomRange(0,1);pe.LerpToRef(this.color1,this.color2,r,t.color),this.colorDead.subtractToRef(t.color,this._colorDiff),this._colorDiff.scaleToRef(1/t.lifeTime,t.colorStep)}else t._currentColorGradient=this._colorGradients[0],t._currentColorGradient.getColorToRef(t.color),t._currentColor1.copyFrom(t.color),this._colorGradients.length>1?this._colorGradients[1].getColorToRef(t._currentColor2):t._currentColor2.copyFrom(t.color);this._isAnimationSheetEnabled&&(t._initialStartSpriteCellID=this.startSpriteCellID,t._initialEndSpriteCellID=this.endSpriteCellID,t._initialSpriteCellLoop=this.spriteCellLoop),t.direction.addInPlace(this._inheritedVelocityOffset),this._useRampGradients&&(t.remapData=new dt(0,1,0,1)),this.noiseTexture&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(t._randomNoiseCoordinates1=new g(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2=new g(Math.random(),Math.random(),Math.random()))),t._inheritParticleInfoToSubEmitters()}}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1){const n=[C.PositionKind,C.ColorKind,"angle","offset","size"];return e&&n.push("cellIndex"),t||n.push("direction"),i&&n.push("remapData"),n}static _GetEffectCreationOptions(e=!1,t=!1){const i=["invView","view","projection","textureMask","translationPivot","eyePosition"];return em(i),e&&i.push("particlesInfos"),t&&i.push("logarithmicDepthConstant"),i}fillDefines(e,t){if(this._scene&&rS(this,this._scene,e),this._isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),t===He.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&e.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case He.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case He.BILLBOARDMODE_STRETCHED:case He.BILLBOARDMODE_STRETCHED_LOCAL:e.push("#define BILLBOARDSTRETCHED"),this.billboardMode===He.BILLBOARDMODE_STRETCHED_LOCAL&&e.push("#define BILLBOARDSTRETCHED_LOCAL");break;case He.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL");break}this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...He._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==He.BILLBOARDMODE_STRETCHED&&this.billboardMode!==He.BILLBOARDMODE_STRETCHED_LOCAL,this._useRampGradients)),e.push(...He._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth)),i.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(je.PrepareUniforms(e,this._imageProcessingConfigurationDefines),je.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}_getWrapper(e){const t=this._getCustomDrawWrapper(e);if(t!=null&&t.effect)return t;const i=[];this.fillDefines(i,e);const n=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0;let r=this._drawWrappers[n];r||(r=this._drawWrappers[n]=[]);let a=r[e];a||(a=new Lr(this._engine),a.drawContext&&(a.drawContext.useInstancing=this._useInstancing),r[e]=a);const o=i.join(`
`);if(a.defines!==o){const l=[],c=[],u=[];this.fillUniformsAttributesAndSamplerNames(c,l,u),a.setEffect(this._engine.createEffect("particles",l,c,u,o),o)}return a}animate(e=!1){var t;if(!this._started)return;if(!e&&this._scene){if(!this.isReady()||this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}this._scaledUpdateSpeed=this.updateSpeed*(e?this.preWarmStepOffset:((t=this._scene)===null||t===void 0?void 0:t.getAnimationRatio())||1);let i;if(this.manualEmitCount>-1)i=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{let n=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){const r=this._actualFrame/this.targetStopDuration;Xn.GetCurrentGradient(r,this._emitRateGradients,(a,o,l)=>{a!==this._currentEmitRateGradient&&(this._currentEmitRate1=this._currentEmitRate2,this._currentEmitRate2=o.getFactor(),this._currentEmitRateGradient=a),n=W.Lerp(this._currentEmitRate1,this._currentEmitRate2,l)})}i=n*this._scaledUpdateSpeed>>0,this._newPartsExcess+=n*this._scaledUpdateSpeed-i}if(this._newPartsExcess>1&&(i+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?i=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(i),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!e){let n=0;for(let r=0;r<this._particles.length;r++){const a=this._particles[r];this._appendParticleVertices(n,a),n+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}this.manualEmitCount===0&&this.disposeOnStop&&this.stop()}_appendParticleVertices(e,t){this._appendParticleVertex(e++,t,0,0),this._useInstancing||(this._appendParticleVertex(e++,t,1,0),this._appendParticleVertex(e++,t,1,1),this._appendParticleVertex(e++,t,0,1))}rebuild(){var e,t;this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),(e=this._spriteBuffer)===null||e===void 0||e._rebuild(),(t=this._vertexBuffer)===null||t===void 0||t._rebuild();for(const i in this._vertexBuffers)this._vertexBuffers[i]._rebuild();this.resetDrawCache()}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==He.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(He.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(He.BLENDMODE_ADD).effect.isReady())return!1;return!0}_render(e){var t,i,n,r,a,o,l,c;const u=this._getWrapper(e),h=u.effect,d=this._engine;d.enableEffect(u);const f=(t=this.defaultViewMatrix)!==null&&t!==void 0?t:this._scene.getViewMatrix();if(h.setTexture("diffuseSampler",this.particleTexture),h.setMatrix("view",f),h.setMatrix("projection",(i=this.defaultProjectionMatrix)!==null&&i!==void 0?i:this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){const m=this.particleTexture.getBaseSize();h.setFloat3("particlesInfos",this.spriteCellWidth/m.width,this.spriteCellHeight/m.height,this.spriteCellWidth/m.width)}if(h.setVector2("translationPivot",this.translationPivot),h.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){const m=this._scene.activeCamera;h.setVector3("eyePosition",m.globalPosition)}this._rampGradientsTexture&&((!this._rampGradients||!this._rampGradients.length)&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),h.setTexture("rampSampler",this._rampGradientsTexture));const p=h.defines;switch(this._scene&&tm(h,this,this._scene),p.indexOf("#define BILLBOARDMODE_ALL")>=0&&(f.invertToRef(w.Matrix[0]),h.setMatrix("invView",w.Matrix[0])),this._vertexArrayObject!==void 0?!((n=this._scene)===null||n===void 0)&&n.forceWireframe?d.bindBuffers(this._vertexBuffers,this._linesIndexBufferUseInstancing,h):(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,null,h)),this._engine.bindVertexArrayObject(this._vertexArrayObject,!((r=this._scene)===null||r===void 0)&&r.forceWireframe?this._linesIndexBufferUseInstancing:this._indexBuffer)):this._indexBuffer?d.bindBuffers(this._vertexBuffers,!((o=this._scene)===null||o===void 0)&&o.forceWireframe?this._linesIndexBuffer:this._indexBuffer,h):d.bindBuffers(this._vertexBuffers,!((a=this._scene)===null||a===void 0)&&a.forceWireframe?this._linesIndexBufferUseInstancing:null,h),this.useLogarithmicDepth&&this._scene&&se.BindLogDepth(p,h,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(h),e){case He.BLENDMODE_ADD:d.setAlphaMode(1);break;case He.BLENDMODE_ONEONE:d.setAlphaMode(6);break;case He.BLENDMODE_STANDARD:d.setAlphaMode(2);break;case He.BLENDMODE_MULTIPLY:d.setAlphaMode(4);break}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(h),this._useInstancing?!((l=this._scene)===null||l===void 0)&&l.forceWireframe?d.drawElementsType(6,0,10,this._particles.length):d.drawArraysType(7,0,4,this._particles.length):!((c=this._scene)===null||c===void 0)&&c.forceWireframe?d.drawElementsType(1,0,this._particles.length*10):d.drawElementsType(0,0,this._particles.length*6),this._particles.length}render(){if(!this.isReady()||!this._particles.length)return 0;const e=this._engine;e.setState&&(e.setState(!1),this.forceDepthWrite&&e.setDepthWrite(!0));let t=0;return this.blendMode===He.BLENDMODE_MULTIPLYADD?t=this._render(He.BLENDMODE_MULTIPLY)+this._render(He.BLENDMODE_ADD):t=this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),t}dispose(e=!0){if(this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._linesIndexBuffer&&(this._engine._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null),this._linesIndexBufferUseInstancing&&(this._engine._releaseBuffer(this._linesIndexBufferUseInstancing),this._linesIndexBufferUseInstancing=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),this._subEmitters&&this._subEmitters.length){for(let t=0;t<this._subEmitters.length;t++)for(const i of this._subEmitters[t])i.dispose();this._subEmitters=[],this.subEmitters=[]}if(this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){const t=this._scene.particleSystems.indexOf(this);t>-1&&this._scene.particleSystems.splice(t,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()}clone(e,t,i=!1){const n=Object.assign({},this._customWrappers);let r=null;const a=this._engine;if(a.createEffectForParticles&&this.customShader!=null){r=this.customShader;const c=r.shaderOptions.defines.length>0?r.shaderOptions.defines.join(`
`):"",u=a.createEffectForParticles(r.shaderPath.fragmentElement,r.shaderOptions.uniforms,r.shaderOptions.samplers,c);n[0]?n[0].effect=u:this.setCustomEffect(u,0)}const o=this.serialize(i),l=He.Parse(o,this._scene||this._engine,this._rootUrl);return l.name=e,l.customShader=r,l._customWrappers=n,t===void 0&&(t=this.emitter),this.noiseTexture&&(l.noiseTexture=this.noiseTexture.clone()),l.emitter=t,this.preventAutoStart||l.start(),l}serialize(e=!1){const t={};if(He._Serialize(t,this,e),t.textureMask=this.textureMask.asArray(),t.customShader=this.customShader,t.preventAutoStart=this.preventAutoStart,this.subEmitters){t.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(const i of this._subEmitters){const n=[];for(const r of i)n.push(r.serialize(e));t.subEmitters.push(n)}}return t}static _Serialize(e,t,i){if(e.name=t.name,e.id=t.id,e.capacity=t.getCapacity(),e.disposeOnStop=t.disposeOnStop,e.manualEmitCount=t.manualEmitCount,t.emitter.position){const _=t.emitter;e.emitterId=_.id}else{const _=t.emitter;e.emitter=_.asArray()}t.particleEmitterType&&(e.particleEmitterType=t.particleEmitterType.serialize()),t.particleTexture&&(i?e.texture=t.particleTexture.serialize():(e.textureName=t.particleTexture.name,e.invertY=!!t.particleTexture._invertY)),e.isLocal=t.isLocal,Pe.AppendSerializedAnimations(t,e),e.beginAnimationOnStart=t.beginAnimationOnStart,e.beginAnimationFrom=t.beginAnimationFrom,e.beginAnimationTo=t.beginAnimationTo,e.beginAnimationLoop=t.beginAnimationLoop,e.startDelay=t.startDelay,e.renderingGroupId=t.renderingGroupId,e.isBillboardBased=t.isBillboardBased,e.billboardMode=t.billboardMode,e.minAngularSpeed=t.minAngularSpeed,e.maxAngularSpeed=t.maxAngularSpeed,e.minSize=t.minSize,e.maxSize=t.maxSize,e.minScaleX=t.minScaleX,e.maxScaleX=t.maxScaleX,e.minScaleY=t.minScaleY,e.maxScaleY=t.maxScaleY,e.minEmitPower=t.minEmitPower,e.maxEmitPower=t.maxEmitPower,e.minLifeTime=t.minLifeTime,e.maxLifeTime=t.maxLifeTime,e.emitRate=t.emitRate,e.gravity=t.gravity.asArray(),e.noiseStrength=t.noiseStrength.asArray(),e.color1=t.color1.asArray(),e.color2=t.color2.asArray(),e.colorDead=t.colorDead.asArray(),e.updateSpeed=t.updateSpeed,e.targetStopDuration=t.targetStopDuration,e.blendMode=t.blendMode,e.preWarmCycles=t.preWarmCycles,e.preWarmStepOffset=t.preWarmStepOffset,e.minInitialRotation=t.minInitialRotation,e.maxInitialRotation=t.maxInitialRotation,e.startSpriteCellID=t.startSpriteCellID,e.spriteCellLoop=t.spriteCellLoop,e.endSpriteCellID=t.endSpriteCellID,e.spriteCellChangeSpeed=t.spriteCellChangeSpeed,e.spriteCellWidth=t.spriteCellWidth,e.spriteCellHeight=t.spriteCellHeight,e.spriteRandomStartCell=t.spriteRandomStartCell,e.isAnimationSheetEnabled=t.isAnimationSheetEnabled,e.useLogarithmicDepth=t.useLogarithmicDepth;const n=t.getColorGradients();if(n){e.colorGradients=[];for(const _ of n){const E={gradient:_.gradient,color1:_.color1.asArray()};_.color2?E.color2=_.color2.asArray():E.color2=_.color1.asArray(),e.colorGradients.push(E)}}const r=t.getRampGradients();if(r){e.rampGradients=[];for(const _ of r){const E={gradient:_.gradient,color:_.color.asArray()};e.rampGradients.push(E)}e.useRampGradients=t.useRampGradients}const a=t.getColorRemapGradients();if(a){e.colorRemapGradients=[];for(const _ of a){const E={gradient:_.gradient,factor1:_.factor1};_.factor2!==void 0?E.factor2=_.factor2:E.factor2=_.factor1,e.colorRemapGradients.push(E)}}const o=t.getAlphaRemapGradients();if(o){e.alphaRemapGradients=[];for(const _ of o){const E={gradient:_.gradient,factor1:_.factor1};_.factor2!==void 0?E.factor2=_.factor2:E.factor2=_.factor1,e.alphaRemapGradients.push(E)}}const l=t.getSizeGradients();if(l){e.sizeGradients=[];for(const _ of l){const E={gradient:_.gradient,factor1:_.factor1};_.factor2!==void 0?E.factor2=_.factor2:E.factor2=_.factor1,e.sizeGradients.push(E)}}const c=t.getAngularSpeedGradients();if(c){e.angularSpeedGradients=[];for(const _ of c){const E={gradient:_.gradient,factor1:_.factor1};_.factor2!==void 0?E.factor2=_.factor2:E.factor2=_.factor1,e.angularSpeedGradients.push(E)}}const u=t.getVelocityGradients();if(u){e.velocityGradients=[];for(const _ of u){const E={gradient:_.gradient,factor1:_.factor1};_.factor2!==void 0?E.factor2=_.factor2:E.factor2=_.factor1,e.velocityGradients.push(E)}}const h=t.getDragGradients();if(h){e.dragGradients=[];for(const _ of h){const E={gradient:_.gradient,factor1:_.factor1};_.factor2!==void 0?E.factor2=_.factor2:E.factor2=_.factor1,e.dragGradients.push(E)}}const d=t.getEmitRateGradients();if(d){e.emitRateGradients=[];for(const _ of d){const E={gradient:_.gradient,factor1:_.factor1};_.factor2!==void 0?E.factor2=_.factor2:E.factor2=_.factor1,e.emitRateGradients.push(E)}}const f=t.getStartSizeGradients();if(f){e.startSizeGradients=[];for(const _ of f){const E={gradient:_.gradient,factor1:_.factor1};_.factor2!==void 0?E.factor2=_.factor2:E.factor2=_.factor1,e.startSizeGradients.push(E)}}const p=t.getLifeTimeGradients();if(p){e.lifeTimeGradients=[];for(const _ of p){const E={gradient:_.gradient,factor1:_.factor1};_.factor2!==void 0?E.factor2=_.factor2:E.factor2=_.factor1,e.lifeTimeGradients.push(E)}}const m=t.getLimitVelocityGradients();if(m){e.limitVelocityGradients=[];for(const _ of m){const E={gradient:_.gradient,factor1:_.factor1};_.factor2!==void 0?E.factor2=_.factor2:E.factor2=_.factor1,e.limitVelocityGradients.push(E)}e.limitVelocityDamping=t.limitVelocityDamping}t.noiseTexture&&(e.noiseTexture=t.noiseTexture.serialize())}static _Parse(e,t,i,n){var r,a,o;let l;i instanceof _e?l=null:l=i;const c=hn("BABYLON.Texture");if(c&&l&&(e.texture?t.particleTexture=c.Parse(e.texture,l,n):e.textureName&&(t.particleTexture=new c(n+e.textureName,l,!1,e.invertY!==void 0?e.invertY:!0),t.particleTexture.name=e.textureName)),!e.emitterId&&e.emitterId!==0&&e.emitter===void 0?t.emitter=g.Zero():e.emitterId&&l?t.emitter=l.getLastMeshById(e.emitterId):t.emitter=g.FromArray(e.emitter),t.isLocal=!!e.isLocal,e.renderingGroupId!==void 0&&(t.renderingGroupId=e.renderingGroupId),e.isBillboardBased!==void 0&&(t.isBillboardBased=e.isBillboardBased),e.billboardMode!==void 0&&(t.billboardMode=e.billboardMode),e.useLogarithmicDepth!==void 0&&(t.useLogarithmicDepth=e.useLogarithmicDepth),e.animations){for(let h=0;h<e.animations.length;h++){const d=e.animations[h],f=hn("BABYLON.Animation");f&&t.animations.push(f.Parse(d))}t.beginAnimationOnStart=e.beginAnimationOnStart,t.beginAnimationFrom=e.beginAnimationFrom,t.beginAnimationTo=e.beginAnimationTo,t.beginAnimationLoop=e.beginAnimationLoop}if(e.autoAnimate&&l&&l.beginAnimation(t,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),t.startDelay=e.startDelay|0,t.minAngularSpeed=e.minAngularSpeed,t.maxAngularSpeed=e.maxAngularSpeed,t.minSize=e.minSize,t.maxSize=e.maxSize,e.minScaleX&&(t.minScaleX=e.minScaleX,t.maxScaleX=e.maxScaleX,t.minScaleY=e.minScaleY,t.maxScaleY=e.maxScaleY),e.preWarmCycles!==void 0&&(t.preWarmCycles=e.preWarmCycles,t.preWarmStepOffset=e.preWarmStepOffset),e.minInitialRotation!==void 0&&(t.minInitialRotation=e.minInitialRotation,t.maxInitialRotation=e.maxInitialRotation),t.minLifeTime=e.minLifeTime,t.maxLifeTime=e.maxLifeTime,t.minEmitPower=e.minEmitPower,t.maxEmitPower=e.maxEmitPower,t.emitRate=e.emitRate,t.gravity=g.FromArray(e.gravity),e.noiseStrength&&(t.noiseStrength=g.FromArray(e.noiseStrength)),t.color1=pe.FromArray(e.color1),t.color2=pe.FromArray(e.color2),t.colorDead=pe.FromArray(e.colorDead),t.updateSpeed=e.updateSpeed,t.targetStopDuration=e.targetStopDuration,t.blendMode=e.blendMode,e.colorGradients)for(const h of e.colorGradients)t.addColorGradient(h.gradient,pe.FromArray(h.color1),h.color2?pe.FromArray(h.color2):void 0);if(e.rampGradients){for(const h of e.rampGradients)t.addRampGradient(h.gradient,G.FromArray(h.color));t.useRampGradients=e.useRampGradients}if(e.colorRemapGradients)for(const h of e.colorRemapGradients)t.addColorRemapGradient(h.gradient,h.factor1!==void 0?h.factor1:h.factor,h.factor2);if(e.alphaRemapGradients)for(const h of e.alphaRemapGradients)t.addAlphaRemapGradient(h.gradient,h.factor1!==void 0?h.factor1:h.factor,h.factor2);if(e.sizeGradients)for(const h of e.sizeGradients)t.addSizeGradient(h.gradient,h.factor1!==void 0?h.factor1:h.factor,h.factor2);if(e.angularSpeedGradients)for(const h of e.angularSpeedGradients)t.addAngularSpeedGradient(h.gradient,h.factor1!==void 0?h.factor1:h.factor,h.factor2);if(e.velocityGradients)for(const h of e.velocityGradients)t.addVelocityGradient(h.gradient,h.factor1!==void 0?h.factor1:h.factor,h.factor2);if(e.dragGradients)for(const h of e.dragGradients)t.addDragGradient(h.gradient,h.factor1!==void 0?h.factor1:h.factor,h.factor2);if(e.emitRateGradients)for(const h of e.emitRateGradients)t.addEmitRateGradient(h.gradient,h.factor1!==void 0?h.factor1:h.factor,h.factor2);if(e.startSizeGradients)for(const h of e.startSizeGradients)t.addStartSizeGradient(h.gradient,h.factor1!==void 0?h.factor1:h.factor,h.factor2);if(e.lifeTimeGradients)for(const h of e.lifeTimeGradients)t.addLifeTimeGradient(h.gradient,h.factor1!==void 0?h.factor1:h.factor,h.factor2);if(e.limitVelocityGradients){for(const h of e.limitVelocityGradients)t.addLimitVelocityGradient(h.gradient,h.factor1!==void 0?h.factor1:h.factor,h.factor2);t.limitVelocityDamping=e.limitVelocityDamping}if(e.noiseTexture&&l){const h=hn("BABYLON.ProceduralTexture");t.noiseTexture=h.Parse(e.noiseTexture,l,n)}let u;if(e.particleEmitterType){switch(e.particleEmitterType.type){case"SphereParticleEmitter":u=new rc;break;case"SphereDirectedParticleEmitter":u=new uh;break;case"ConeEmitter":case"ConeParticleEmitter":u=new ah;break;case"CylinderParticleEmitter":u=new sc;break;case"CylinderDirectedParticleEmitter":u=new oh;break;case"HemisphericParticleEmitter":u=new lh;break;case"PointParticleEmitter":u=new ch;break;case"MeshParticleEmitter":u=new cm;break;case"BoxEmitter":case"BoxParticleEmitter":default:u=new lo;break}u.parse(e.particleEmitterType,l)}else u=new lo,u.parse(e,l);t.particleEmitterType=u,t.startSpriteCellID=e.startSpriteCellID,t.endSpriteCellID=e.endSpriteCellID,t.spriteCellLoop=(r=e.spriteCellLoop)!==null&&r!==void 0?r:!0,t.spriteCellWidth=e.spriteCellWidth,t.spriteCellHeight=e.spriteCellHeight,t.spriteCellChangeSpeed=e.spriteCellChangeSpeed,t.spriteRandomStartCell=e.spriteRandomStartCell,t.disposeOnStop=(a=e.disposeOnStop)!==null&&a!==void 0?a:!1,t.manualEmitCount=(o=e.manualEmitCount)!==null&&o!==void 0?o:-1}static Parse(e,t,i,n=!1,r){const a=e.name;let o=null,l=null,c,u;if(t instanceof _e?c=t:(u=t,c=u.getEngine()),e.customShader&&c.createEffectForParticles){l=e.customShader;const d=l.shaderOptions.defines.length>0?l.shaderOptions.defines.join(`
`):"";o=c.createEffectForParticles(l.shaderPath.fragmentElement,l.shaderOptions.uniforms,l.shaderOptions.samplers,d)}const h=new He(a,r||e.capacity,t,o,e.isAnimationSheetEnabled);if(h.customShader=l,h._rootUrl=i,e.id&&(h.id=e.id),e.subEmitters){h.subEmitters=[];for(const d of e.subEmitters){const f=[];for(const p of d)f.push(Nr.Parse(p,t,i));h.subEmitters.push(f)}}return He._Parse(e,h,t,i),e.textureMask&&(h.textureMask=pe.FromArray(e.textureMask)),e.preventAutoStart&&(h.preventAutoStart=e.preventAutoStart),!n&&!h.preventAutoStart&&h.start(),h}}He.BILLBOARDMODE_Y=2;He.BILLBOARDMODE_ALL=7;He.BILLBOARDMODE_STRETCHED=8;He.BILLBOARDMODE_STRETCHED_LOCAL=9;Nr._ParseParticleSystem=He.Parse;const yM=Object.freeze(new ee(0,0,0,0)),AM=Object.freeze(g.Zero()),TM=Object.freeze(j.Zero()),SM=Object.freeze(qn.Zero()),CM=Object.freeze(G.Black());class IM{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,n){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._previousAbsoluteFrame=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=n,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===B.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=D.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){const a={frame:0,value:this._minValue};this._keys.splice(0,0,a)}if(this._target instanceof Array){let a=0;for(const o of this._target)this._preparePath(o,a),this._getOriginalValues(a),a++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const r=t.getEvents();r&&r.length>0&&r.forEach(a=>{this._events.push(a._clone())}),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){const i=this._animation.targetPropertyPath;if(i.length>1){let n=e[i[0]];for(let r=1;r<i.length-1;r++)n=n[i[r]];this._targetPath=i[i.length-1],this._activeTargets[t]=n}else this._targetPath=i[0],this._activeTargets[t]=e}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let t=0;for(const i of this._target)this._originalValue[t]!==void 0&&this._setValue(i,this._activeTargets[t],this._originalValue[t],-1,t),t++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let t=0;t<this._events.length;t++)this._events[t].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray){for(let i=0;i<this._target.length;i++){const n=this._target[i];this._setValue(n,this._activeTargets[i],e,t,i)}return}this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const i=this._activeTargets[e];i.getRestPose&&this._targetPath==="_matrix"?t=i.getRestPose():t=i[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_setValue(e,t,i,n,r){if(this._currentActiveTarget=t,this._weight=n,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const o=t[this._targetPath];o.clone?this._originalBlendValue=o.clone():this._originalBlendValue=o}this._originalBlendValue.m?B.AllowMatrixDecomposeForInterpolation?this._currentValue?D.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=D.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?D.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=D.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=B._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);const a=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=a}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:i!=null&&i.clone?this._currentValue=i.clone():this._currentValue=i;n!==-1?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[r]):t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e){const t=this._animation.getKeys();e<t[0].frame?e=t[0].frame:e>t[t.length-1].frame&&(e=t[t.length-1].frame);const i=this._events;if(i.length)for(let r=0;r<i.length;r++)i[r].onlyOnce||(i[r].isDone=i[r].frame<e);this._currentFrame=e;const n=this._animation._interpolate(e,this._animationState);this.setValue(n,-1)}_prepareForSpeedRatioChange(e){const t=this._previousElapsedTime*(this._animation.framePerSecond*e)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-t}animate(e,t,i,n,r,a=-1){const o=this._animation,l=o.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let c=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);const u=i-t;let h,d=e*(o.framePerSecond*r)/1e3+this._absoluteFrameOffset,f=0;if(n&&this._animationState.loopMode===B.ANIMATIONLOOPMODE_YOYO){const E=(d-t)/u;d=Math.abs(Math.sin(E*Math.PI))*u+t}if(this._previousElapsedTime=e,this._previousAbsoluteFrame=d,!n&&i>=t&&d>=u)c=!1,f=o._getKeyValue(this._maxValue);else if(!n&&t>=i&&d<=u)c=!1,f=o._getKeyValue(this._minValue);else if(this._animationState.loopMode!==B.ANIMATIONLOOPMODE_CYCLE){const E=i.toString()+t.toString();if(!this._offsetsCache[E]){this._animationState.repeatCount=0,this._animationState.loopMode=B.ANIMATIONLOOPMODE_CYCLE;const v=o._interpolate(t,this._animationState),y=o._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),o.dataType){case B.ANIMATIONTYPE_FLOAT:this._offsetsCache[E]=y-v;break;case B.ANIMATIONTYPE_QUATERNION:this._offsetsCache[E]=y.subtract(v);break;case B.ANIMATIONTYPE_VECTOR3:this._offsetsCache[E]=y.subtract(v);break;case B.ANIMATIONTYPE_VECTOR2:this._offsetsCache[E]=y.subtract(v);break;case B.ANIMATIONTYPE_SIZE:this._offsetsCache[E]=y.subtract(v);break;case B.ANIMATIONTYPE_COLOR3:this._offsetsCache[E]=y.subtract(v);break}this._highLimitsCache[E]=y}f=this._highLimitsCache[E],h=this._offsetsCache[E]}if(h===void 0)switch(o.dataType){case B.ANIMATIONTYPE_FLOAT:h=0;break;case B.ANIMATIONTYPE_QUATERNION:h=yM;break;case B.ANIMATIONTYPE_VECTOR3:h=AM;break;case B.ANIMATIONTYPE_VECTOR2:h=TM;break;case B.ANIMATIONTYPE_SIZE:h=SM;break;case B.ANIMATIONTYPE_COLOR3:h=CM}let p;if(this._host&&this._host.syncRoot){const E=this._host.syncRoot,v=(E.masterFrame-E.fromFrame)/(E.toFrame-E.fromFrame);p=t+u*v}else d>0&&t>i||d<0&&t<i?p=c&&u!==0?i+d%u:t:p=c&&u!==0?t+d%u:i;const m=this._events;if(r>0&&this.currentFrame>p||r<0&&this.currentFrame<p){this._onLoop();for(let E=0;E<m.length;E++)m[E].onlyOnce||(m[E].isDone=!1);this._animationState.key=r>0?0:o.getKeys().length-1}this._currentFrame=p,this._animationState.repeatCount=u===0?0:d/u>>0,this._animationState.highLimitValue=f,this._animationState.offsetValue=h;const _=o._interpolate(p,this._animationState);if(this.setValue(_,a),m.length){for(let E=0;E<m.length;E++)if(u>0&&p>=m[E].frame&&m[E].frame>=t||u<0&&p<=m[E].frame&&m[E].frame<=t){const v=m[E];v.isDone||(v.onlyOnce&&(m.splice(E,1),E--),v.isDone=!0,v.action(p))}}return c||(this._stopped=!0),c}}class ev{get syncRoot(){return this._syncRoot}get masterFrame(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){if(e===-1){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,this._goToFrame!==null&&this.goToFrame(this._goToFrame)}constructor(e,t,i=0,n=100,r=!1,a=1,o,l,c,u=!1,h=0){this.target=t,this.fromFrame=i,this.toFrame=n,this.loopAnimation=r,this.onAnimationEnd=o,this.onAnimationLoop=c,this.isAdditive=u,this.playOrder=h,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new O,this.onAnimationLoopObservable=new O,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=a,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const t=this._scene._activeAnimatables.indexOf(this);t>-1&&(this._scene._activeAnimatables.splice(t,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const n=t[i],r=new IM(e,n,this._scene,this);r._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(r)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e){var t;const i=this._runtimeAnimations;if(i[0]){const n=i[0].animation.framePerSecond;this._frameToSyncFromJump=(t=this._frameToSyncFromJump)!==null&&t!==void 0?t:i[0].currentFrame;const r=this.speedRatio===0?0:(e-this._frameToSyncFromJump)/n*1e3/this.speedRatio;this._manualJumpDelay=-r}for(let n=0;n<i.length;n++)i[n].goToFrame(e);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1){if(e||t){const n=this._scene._activeAnimatables.indexOf(this);if(n>-1){const r=this._runtimeAnimations;for(let a=r.length-1;a>=0;a--){const o=r[a];e&&o.animation.name!=e||t&&!t(o.target)||(o.dispose(),r.splice(a,1))}r.length==0&&(i||this._scene._activeAnimatables.splice(n,1),this._raiseOnAnimationEnd())}}else{const n=this._scene._activeAnimatables.indexOf(this);if(n>-1){i||this._scene._activeAnimatables.splice(n,1);const r=this._runtimeAnimations;for(let a=0;a<r.length;a++)r[a].dispose();this._runtimeAnimations.length=0,this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=e),!0;if(this._localDelayOffset===null?(this._localDelayOffset=e,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),this._manualJumpDelay!==null&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,this._weight===0)return!0;let t=!1;const i=this._runtimeAnimations;let n;for(n=0;n<i.length;n++){const a=i[n].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||a}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(n=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(n,1),n=0;n<i.length;n++)i[n].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}Le.prototype._animate=function(){if(!this.animationsEnabled)return;const s=Mn.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=s}this.deltaTime=this.useConstantAnimationDeltaTime?16:(s-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=s;const e=this._activeAnimatables;if(e.length===0)return;this._animationTime+=this.deltaTime;const t=this._animationTime;for(let i=0;i<e.length;i++){const n=e[i];!n._animate(t)&&n.disposeOnEnd&&i--}this._processLateAnimationBindings()};Le.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort((s,e)=>s.playOrder-e.playOrder)};Le.prototype.beginWeightedAnimation=function(s,e,t,i=1,n,r=1,a,o,l,c,u=!1){const h=this.beginAnimation(s,e,t,n,r,a,o,!1,l,c,u);return h.weight=i,h};Le.prototype.beginAnimation=function(s,e,t,i,n=1,r,a,o=!0,l,c,u=!1){e>t&&n>0&&(n*=-1),o&&this.stopAnimation(s,void 0,l),a||(a=new ev(this,s,e,t,i,n,r,void 0,c,u));const h=l?l(s):!0;if(s.animations&&h&&a.appendAnimations(s,s.animations),s.getAnimatables){const d=s.getAnimatables();for(let f=0;f<d.length;f++)this.beginAnimation(d[f],e,t,i,n,r,a,o,l,c)}return a.reset(),a};Le.prototype.beginHierarchyAnimation=function(s,e,t,i,n,r=1,a,o,l=!0,c,u,h=!1){const d=s.getDescendants(e),f=[];f.push(this.beginAnimation(s,t,i,n,r,a,o,l,c,void 0,h));for(const p of d)f.push(this.beginAnimation(p,t,i,n,r,a,o,l,c,void 0,h));return f};Le.prototype.beginDirectAnimation=function(s,e,t,i,n,r,a,o,l=!1){if(r===void 0&&(r=1),t>i&&r>0)r*=-1;else if(i>t&&r<0){const u=i;i=t,t=u}return new ev(this,s,t,i,n,r,a,e,o,l)};Le.prototype.beginDirectHierarchyAnimation=function(s,e,t,i,n,r,a,o,l,c=!1){const u=s.getDescendants(e),h=[];h.push(this.beginDirectAnimation(s,t,i,n,r,a,o,l,c));for(const d of u)h.push(this.beginDirectAnimation(d,t,i,n,r,a,o,l,c));return h};Le.prototype.getAnimatableByTarget=function(s){for(let e=0;e<this._activeAnimatables.length;e++)if(this._activeAnimatables[e].target===s)return this._activeAnimatables[e];return null};Le.prototype.getAllAnimatablesByTarget=function(s){const e=[];for(let t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].target===s&&e.push(this._activeAnimatables[t]);return e};Le.prototype.stopAnimation=function(s,e,t){const i=this.getAllAnimatablesByTarget(s);for(const n of i)n.stop(e,t)};Le.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let s=0;s<this._activeAnimatables.length;s++)this._activeAnimatables[s].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(const s of this.animationGroups)s.stop()};Le.prototype._registerTargetForLateAnimationBinding=function(s,e){const t=s.target;this._registeredForLateAnimationBindings.pushNoDuplicate(t),t._lateAnimationHolders||(t._lateAnimationHolders={}),t._lateAnimationHolders[s.targetPath]||(t._lateAnimationHolders[s.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:e}),s.isAdditive?(t._lateAnimationHolders[s.targetPath].additiveAnimations.push(s),t._lateAnimationHolders[s.targetPath].totalAdditiveWeight+=s.weight):(t._lateAnimationHolders[s.targetPath].animations.push(s),t._lateAnimationHolders[s.targetPath].totalWeight+=s.weight)};Le.prototype._processLateAnimationBindingsForMatrices=function(s){if(s.totalWeight===0&&s.totalAdditiveWeight===0)return s.originalValue;let e=1;const t=w.Vector3[0],i=w.Vector3[1],n=w.Quaternion[0];let r=0;const a=s.animations[0],o=s.originalValue;let l=1,c=!1;if(s.totalWeight<1)l=1-s.totalWeight,o.decompose(i,n,t);else{if(r=1,e=s.totalWeight,l=a.weight/e,l==1)if(s.totalAdditiveWeight)c=!0;else return a.currentValue;a.currentValue.decompose(i,n,t)}if(!c){i.scaleInPlace(l),t.scaleInPlace(l),n.scaleInPlace(l);for(let h=r;h<s.animations.length;h++){const d=s.animations[h];if(d.weight===0)continue;l=d.weight/e;const f=w.Vector3[2],p=w.Vector3[3],m=w.Quaternion[1];d.currentValue.decompose(p,m,f),p.scaleAndAddToRef(l,i),m.scaleAndAddToRef(ee.Dot(n,m)>0?l:-l,n),f.scaleAndAddToRef(l,t)}n.normalize()}for(let h=0;h<s.additiveAnimations.length;h++){const d=s.additiveAnimations[h];if(d.weight===0)continue;const f=w.Vector3[2],p=w.Vector3[3],m=w.Quaternion[1];d.currentValue.decompose(p,m,f),p.multiplyToRef(i,p),g.LerpToRef(i,p,d.weight,i),n.multiplyToRef(m,m),ee.SlerpToRef(n,m,d.weight,n),f.scaleAndAddToRef(d.weight,t)}const u=a?a._animationState.workValue:w.Matrix[0].clone();return D.ComposeToRef(i,n,t,u),u};Le.prototype._processLateAnimationBindingsForQuaternions=function(s,e){if(s.totalWeight===0&&s.totalAdditiveWeight===0)return e;const t=s.animations[0],i=s.originalValue;let n=e;if(s.totalWeight===0&&s.totalAdditiveWeight>0)n.copyFrom(i);else if(s.animations.length===1){if(ee.SlerpToRef(i,t.currentValue,Math.min(1,s.totalWeight),n),s.totalAdditiveWeight===0)return n}else if(s.animations.length>1){let r=1,a,o;if(s.totalWeight<1){const c=1-s.totalWeight;a=[],o=[],a.push(i),o.push(c)}else{if(s.animations.length===2&&(ee.SlerpToRef(s.animations[0].currentValue,s.animations[1].currentValue,s.animations[1].weight/s.totalWeight,e),s.totalAdditiveWeight===0))return e;a=[],o=[],r=s.totalWeight}for(let c=0;c<s.animations.length;c++){const u=s.animations[c];a.push(u.currentValue),o.push(u.weight/r)}let l=0;for(let c=0;c<a.length;){if(!c){ee.SlerpToRef(a[c],a[c+1],o[c+1]/(o[c]+o[c+1]),e),n=e,l=o[c]+o[c+1],c+=2;continue}l+=o[c],ee.SlerpToRef(n,a[c],o[c]/l,n),c++}}for(let r=0;r<s.additiveAnimations.length;r++){const a=s.additiveAnimations[r];a.weight!==0&&(n.multiplyToRef(a.currentValue,w.Quaternion[0]),ee.SlerpToRef(n,w.Quaternion[0],a.weight,n))}return n};Le.prototype._processLateAnimationBindings=function(){if(this._registeredForLateAnimationBindings.length){for(let s=0;s<this._registeredForLateAnimationBindings.length;s++){const e=this._registeredForLateAnimationBindings.data[s];for(const t in e._lateAnimationHolders){const i=e._lateAnimationHolders[t],n=i.animations[0],r=i.originalValue;if(r==null)continue;const a=B.AllowMatrixDecomposeForInterpolation&&r.m;let o=e[t];if(a)o=this._processLateAnimationBindingsForMatrices(i);else if(r.w!==void 0)o=this._processLateAnimationBindingsForQuaternions(i,o||ee.Identity());else{let c=0,u=1;if(i.totalWeight<1)n&&r.scale?o=r.scale(1-i.totalWeight):n?o=r*(1-i.totalWeight):r.clone?o=r.clone():o=r;else if(n){u=i.totalWeight;const h=n.weight/u;h!==1?n.currentValue.scale?o=n.currentValue.scale(h):o=n.currentValue*h:o=n.currentValue,c=1}for(let h=c;h<i.animations.length;h++){const d=i.animations[h],f=d.weight/u;if(f)d.currentValue.scaleAndAddToRef?d.currentValue.scaleAndAddToRef(f,o):o+=d.currentValue*f;else continue}for(let h=0;h<i.additiveAnimations.length;h++){const d=i.additiveAnimations[h],f=d.weight;if(f)d.currentValue.scaleAndAddToRef?d.currentValue.scaleAndAddToRef(f,o):o+=d.currentValue*f;else continue}}e[t]=o}e._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}};Tt.prototype.copyAnimationRange=function(s,e,t,i=!1,n=null){this.animations.length===0&&(this.animations.push(new B(this.name,"_matrix",s.animations[0].framePerSecond,B.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const r=s.animations[0].getRange(e);if(!r)return!1;const a=r.from,o=r.to,l=s.animations[0].getKeys(),c=s.length,u=s.getParent(),h=this.getParent(),d=i&&u&&c&&this.length&&c!==this.length,f=d&&h&&u?h.length/u.length:1,p=i&&!h&&n&&(n.x!==1||n.y!==1||n.z!==1),m=this.animations[0].getKeys();let _,E,v;for(let y=0,A=l.length;y<A;y++)_=l[y],_.frame>=a&&_.frame<=o&&(i?(v=_.value.clone(),d?(E=v.getTranslation(),v.setTranslation(E.scaleInPlace(f))):p&&n?(E=v.getTranslation(),v.setTranslation(E.multiplyInPlace(n))):v=_.value):v=_.value,m.push({frame:_.frame+t,value:v}));return this.animations[0].createRange(e,a+t,o+t),!0};class Ia{constructor(e){this._texture=null,this._isEnabled=!0,this.isEnabled=!0,this.time=0,e=e||Fe.LastCreatedScene,e&&(this._scene=e,this.animationParameters=new dt(0,0,0,30))}_markSubMeshesAsAttributesDirty(){for(const e of this._scene.meshes)e.bakedVertexAnimationManager===this&&e._markSubMeshesAsAttributesDirty()}bind(e,t=!1){if(!this._texture||!this._isEnabled)return;const i=this._texture.getSize();e.setFloat2("bakedVertexAnimationTextureSizeInverted",1/i.width,1/i.height),e.setFloat("bakedVertexAnimationTime",this.time),t||e.setVector4("bakedVertexAnimationSettings",this.animationParameters),e.setTexture("bakedVertexAnimationTexture",this._texture)}clone(){const e=new Ia(this._scene);return this.copyTo(e),e}setAnimationParameters(e,t,i=0,n=30){this.animationParameters=new dt(e,t,i,n)}dispose(e){var t;e&&((t=this._texture)===null||t===void 0||t.dispose())}getClassName(){return"BakedVertexAnimationManager"}copyTo(e){Pe.Clone(()=>e,this)}serialize(){return Pe.Serialize(this)}parse(e,t,i){Pe.Parse(()=>this,e,t,i)}}S([ht(),K("_markSubMeshesAsAttributesDirty")],Ia.prototype,"texture",void 0);S([b(),K("_markSubMeshesAsAttributesDirty")],Ia.prototype,"isEnabled",void 0);S([b()],Ia.prototype,"animationParameters",void 0);S([b()],Ia.prototype,"time",void 0);class RM{constructor(e,t){this._scene=e,this._mesh=t}bakeVertexData(e){return Ie(this,null,function*(){if(!this._mesh.skeleton)throw new Error("No skeleton in this mesh.");const t=this._mesh.skeleton.bones.length,i=e.reduce((o,l)=>o+l.to-l.from+1,0);if(isNaN(i))throw new Error("Invalid animation ranges.");let n=0;const r=(t+1)*4*4*i,a=new Float32Array(r);this._scene.stopAnimation(this._mesh),this._mesh.skeleton.returnToRest();for(const o of e)for(let l=o.from;l<=o.to;l++)yield this._executeAnimationFrame(a,l,n++);return a})}_executeAnimationFrame(e,t,i){return Ie(this,null,function*(){return new Promise((n,r)=>{this._scene.beginAnimation(this._mesh.skeleton,t,t,!1,1,()=>{const a=this._mesh.skeleton.getTransformMatrices(this._mesh);e.set(a,i*a.length),n()})})})}textureFromBakedVertexData(e){if(!this._mesh.skeleton)throw new Error("No skeleton in this mesh.");const t=this._mesh.skeleton.bones.length,i=an.CreateRGBATexture(e,(t+1)*4,e.length/((t+1)*4*4),this._scene,!1,!1,H.NEAREST_NEAREST,1);return i.name="VAT"+this._mesh.skeleton.name,i}serializeBakedVertexDataToObject(e){if(!this._mesh.skeleton)throw new Error("No skeleton in this mesh.");const t=this._mesh.skeleton.bones.length,i=(t+1)*4,n=e.length/((t+1)*4*4);return{vertexData:Qp(e),width:i,height:n}}loadBakedVertexDataFromObject(e){return new Float32Array(uE(e.vertexData))}serializeBakedVertexDataToJSON(e){return JSON.stringify(this.serializeBakedVertexDataToObject(e))}loadBakedVertexDataFromJSON(e){return this.loadBakedVertexDataFromObject(JSON.parse(e))}}class Zr{static ConvertPanoramaToCubemap(e,t,i,n,r=!1){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*i*3)throw"ConvertPanoramaToCubemap: input size is wrong";const a=this.CreateCubemapTexture(n,this.FACE_FRONT,e,t,i,r),o=this.CreateCubemapTexture(n,this.FACE_BACK,e,t,i,r),l=this.CreateCubemapTexture(n,this.FACE_LEFT,e,t,i,r),c=this.CreateCubemapTexture(n,this.FACE_RIGHT,e,t,i,r),u=this.CreateCubemapTexture(n,this.FACE_UP,e,t,i,r),h=this.CreateCubemapTexture(n,this.FACE_DOWN,e,t,i,r);return{front:a,back:o,left:l,right:c,up:u,down:h,size:n,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,t,i,n,r,a=!1){const o=new ArrayBuffer(e*e*4*3),l=new Float32Array(o),c=a?Math.max(1,Math.round(n/4/e)):1,u=1/c,h=u*u,d=t[1].subtract(t[0]).scale(u/e),f=t[3].subtract(t[2]).scale(u/e),p=1/e;let m=0;for(let _=0;_<e;_++)for(let E=0;E<c;E++){let v=t[0],y=t[2];for(let A=0;A<e;A++)for(let I=0;I<c;I++){const T=y.subtract(v).scale(m).add(v);T.normalize();const R=this.CalcProjectionSpherical(T,i,n,r);l[_*e*3+A*3+0]+=R.r*h,l[_*e*3+A*3+1]+=R.g*h,l[_*e*3+A*3+2]+=R.b*h,v=v.add(d),y=y.add(f)}m+=p*u}return l}static CalcProjectionSpherical(e,t,i,n){let r=Math.atan2(e.z,e.x);const a=Math.acos(e.y);for(;r<-Math.PI;)r+=2*Math.PI;for(;r>Math.PI;)r-=2*Math.PI;let o=r/Math.PI;const l=a/Math.PI;o=o*.5+.5;let c=Math.round(o*i);c<0?c=0:c>=i&&(c=i-1);let u=Math.round(l*n);u<0?u=0:u>=n&&(u=n-1);const h=n-u-1,d=t[h*i*3+c*3+0],f=t[h*i*3+c*3+1],p=t[h*i*3+c*3+2];return{r:d,g:f,b:p}}}Zr.FACE_LEFT=[new g(-1,-1,-1),new g(1,-1,-1),new g(-1,1,-1),new g(1,1,-1)];Zr.FACE_RIGHT=[new g(1,-1,1),new g(-1,-1,1),new g(1,1,1),new g(-1,1,1)];Zr.FACE_FRONT=[new g(1,-1,-1),new g(1,-1,1),new g(1,1,-1),new g(1,1,1)];Zr.FACE_BACK=[new g(-1,-1,1),new g(-1,-1,-1),new g(-1,1,1),new g(-1,1,-1)];Zr.FACE_DOWN=[new g(1,1,-1),new g(1,1,1),new g(-1,1,-1),new g(-1,1,1)];Zr.FACE_UP=[new g(-1,-1,-1),new g(-1,-1,1),new g(1,-1,-1),new g(1,-1,1)];class bM{static _Ldexp(e,t){return t>1023?e*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?e*Math.pow(2,-1074)*Math.pow(2,t+1074):e*Math.pow(2,t)}static _Rgbe2float(e,t,i,n,r,a){r>0?(r=this._Ldexp(1,r-(128+8)),e[a+0]=t*r,e[a+1]=i*r,e[a+2]=n*r):(e[a+0]=0,e[a+1]=0,e[a+2]=0)}static _ReadStringLine(e,t){let i="",n="";for(let r=t;r<e.length-t&&(n=String.fromCharCode(e[r]),n!=`
`);r++)i+=n;return i}static RGBE_ReadHeader(e){let t=0,i=0,n=this._ReadStringLine(e,0);if(n[0]!="#"||n[1]!="?")throw"Bad HDR Format.";let r=!1,a=!1,o=0;do o+=n.length+1,n=this._ReadStringLine(e,o),n=="FORMAT=32-bit_rle_rgbe"?a=!0:n.length==0&&(r=!0);while(!r);if(!a)throw"HDR Bad header format, unsupported FORMAT";o+=n.length+1,n=this._ReadStringLine(e,o);const c=/^-Y (.*) \+X (.*)$/g.exec(n);if(!c||c.length<3)throw"HDR Bad header format, no size";if(i=parseInt(c[2]),t=parseInt(c[1]),i<8||i>32767)throw"HDR Bad header format, unsupported size";return o+=n.length+1,{height:t,width:i,dataPosition:o}}static GetCubeMapTextureData(e,t,i=!1){const n=new Uint8Array(e),r=this.RGBE_ReadHeader(n),a=this.RGBE_ReadPixels(n,r);return Zr.ConvertPanoramaToCubemap(a,r.width,r.height,t,i)}static RGBE_ReadPixels(e,t){return this._RGBEReadPixelsRLE(e,t)}static _RGBEReadPixelsRLE(e,t){let i=t.height;const n=t.width;let r,a,o,l,c,u=t.dataPosition,h=0,d=0,f=0;const p=new ArrayBuffer(n*4),m=new Uint8Array(p),_=new ArrayBuffer(t.width*t.height*4*3),E=new Float32Array(_);for(;i>0;){if(r=e[u++],a=e[u++],o=e[u++],l=e[u++],r!=2||a!=2||o&128||t.width<8||t.width>32767)return this._RGBEReadPixelsNOTRLE(e,t);if((o<<8|l)!=n)throw"HDR Bad header format, wrong scan line width";for(h=0,f=0;f<4;f++)for(d=(f+1)*n;h<d;)if(r=e[u++],a=e[u++],r>128){if(c=r-128,c==0||c>d-h)throw"HDR Bad Format, bad scanline data (run)";for(;c-- >0;)m[h++]=a}else{if(c=r,c==0||c>d-h)throw"HDR Bad Format, bad scanline data (non-run)";if(m[h++]=a,--c>0)for(let v=0;v<c;v++)m[h++]=e[u++]}for(f=0;f<n;f++)r=m[f],a=m[f+n],o=m[f+2*n],l=m[f+3*n],this._Rgbe2float(E,r,a,o,l,(t.height-i)*n*3+f*3);i--}return E}static _RGBEReadPixelsNOTRLE(e,t){let i=t.height;const n=t.width;let r,a,o,l,c,u=t.dataPosition;const h=new ArrayBuffer(t.width*t.height*4*3),d=new Float32Array(h);for(;i>0;){for(c=0;c<t.width;c++)r=e[u++],a=e[u++],o=e[u++],l=e[u++],this._Rgbe2float(d,r,a,o,l,(t.height-i)*n*3+c*3);i--}return d}}const xM="hdrFilteringVertexShader",MM=`attribute vec2 position;varying vec3 direction;uniform vec3 up;uniform vec3 right;uniform vec3 front;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
mat3 view=mat3(up,right,front);direction=view*vec3(position,1.0);gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;Q.ShadersStore[xM]=MM;const PM="hdrFilteringPixelShader",DM=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform float alphaG;uniform samplerCube inputTexture;uniform vec2 vFilteringInfo;uniform float hdrScale;varying vec3 direction;void main() {vec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);gl_FragColor=vec4(color*hdrScale,1.0);}`;Q.ShadersStore[PM]=DM;class OM{constructor(e,t={}){this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);const i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),this._engine.updateTextureSamplingMode(3,i.texture,!0),i}_prefilterInternal(e){const t=e.getSize().width,i=W.ILog2(t)+1,n=this._effectWrapper.effect,r=this._createRenderTarget(t);this._effectRenderer.saveStates(),this._effectRenderer.setViewport();const a=e.getInternalTexture();a&&this._engine.updateTextureSamplingMode(3,a,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);const o=[[new g(0,0,-1),new g(0,-1,0),new g(1,0,0)],[new g(0,0,1),new g(0,-1,0),new g(-1,0,0)],[new g(1,0,0),new g(0,0,1),new g(0,1,0)],[new g(1,0,0),new g(0,0,-1),new g(0,-1,0)],[new g(1,0,0),new g(0,-1,0),new g(0,0,1)],[new g(-1,0,0),new g(0,-1,0),new g(0,0,-1)]];n.setFloat("hdrScale",this.hdrScale),n.setFloat2("vFilteringInfo",e.getSize().width,i),n.setTexture("inputTexture",e);for(let u=0;u<6;u++){n.setVector3("up",o[u][0]),n.setVector3("right",o[u][1]),n.setVector3("front",o[u][2]);for(let h=0;h<i;h++){this._engine.bindFramebuffer(r,u,void 0,void 0,!0,h),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let d=Math.pow(2,(h-this._lodGenerationOffset)/this._lodGenerationScale)/t;h===0&&(d=0),n.setFloat("alphaG",d),this._effectRenderer.draw()}}this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(e._texture);const l=r.texture.type,c=r.texture.format;return r._swapAndDie(e._texture),e._texture.type=l,e._texture.format=c,e.gammaSpace=!1,e.lodGenerationOffset=this._lodGenerationOffset,e.lodGenerationScale=this._lodGenerationScale,e._prefiltered=!0,e}_createEffect(e,t){const i=[];return e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u"),new ME({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:i,onCompiled:t})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}prefilter(e,t=null){return this._engine._features.allowTexturePrefiltering?new Promise(i=>{this._effectRenderer=new xE(this._engine),this._effectWrapper=this._createEffect(e),this._effectWrapper.effect.executeWhenCompiled(()=>{this._prefilterInternal(e),this._effectRenderer.dispose(),this._effectWrapper.dispose(),i(),t&&t()})}):(U.Warn("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."),Promise.reject("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."))}}class fa extends _t{set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(D.RotationY(this._rotationY))}get rotationY(){return this._rotationY}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}constructor(e,t,i,n=!1,r=!0,a=!1,o=!1,l=null,c=null,u=!1){var h;super(t),this._generateHarmonics=!0,this._onError=null,this._isBlocking=!0,this._rotationY=0,this.boundingBoxPosition=g.Zero(),this.onLoadObservable=new O,e&&(this._coordinatesMode=H.CUBIC_MODE,this.name=e,this.url=e,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=D.Identity(),this._prefilterOnLoad=o,this._onLoad=()=>{this.onLoadObservable.notifyObservers(this),l&&l()},this._onError=c,this.gammaSpace=a,this._noMipmap=n,this._size=i,this._supersample=u,this._generateHarmonics=r,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?this._texture.isReady?q.SetImmediate(()=>this._onLoad()):this._texture.onLoadedObservable.add(this._onLoad):!((h=this.getScene())===null||h===void 0)&&h.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture())}getClassName(){return"HDRCubeTexture"}_loadTexture(){const e=this._getEngine(),t=e.getCaps();let i=0;t.textureFloat&&t.textureFloatLinearFiltering?i=1:t.textureHalfFloat&&t.textureHalfFloatLinearFiltering&&(i=2);const n=r=>{this.lodGenerationOffset=0,this.lodGenerationScale=.8;const a=bM.GetCubeMapTextureData(r,this._size,this._supersample);if(this._generateHarmonics){const u=Jl.ConvertCubeMapToSphericalPolynomial(a);this.sphericalPolynomial=u}const o=[];let l=null,c=null;for(let u=0;u<6;u++){i===2?c=new Uint16Array(this._size*this._size*3):i===0&&(l=new Uint8Array(this._size*this._size*3));const h=a[fa._FacesMapping[u]];if(this.gammaSpace||c||l){for(let d=0;d<this._size*this._size;d++)if(this.gammaSpace&&(h[d*3+0]=Math.pow(h[d*3+0],Xc),h[d*3+1]=Math.pow(h[d*3+1],Xc),h[d*3+2]=Math.pow(h[d*3+2],Xc)),c&&(c[d*3+0]=Kh(h[d*3+0]),c[d*3+1]=Kh(h[d*3+1]),c[d*3+2]=Kh(h[d*3+2])),l){let f=Math.max(h[d*3+0]*255,0),p=Math.max(h[d*3+1]*255,0),m=Math.max(h[d*3+2]*255,0);const _=Math.max(Math.max(f,p),m);if(_>255){const E=255/_;f*=E,p*=E,m*=E}l[d*3+0]=f,l[d*3+1]=p,l[d*3+2]=m}}c?o.push(c):l?o.push(l):o.push(h)}return o};if(e._features.allowTexturePrefiltering&&this._prefilterOnLoad){const r=this._onLoad,a=new OM(e);this._onLoad=()=>{a.prefilter(this,r)}}this._texture=e.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,i,this._noMipmap,n,null,this._onLoad,this._onError)}clone(){const e=new fa(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace);return e.level=this.level,e.wrapU=this.wrapU,e.wrapV=this.wrapV,e.coordinatesIndex=this.coordinatesIndex,e.coordinatesMode=this.coordinatesMode,e}delayLoad(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture())}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t;this._textureMatrix=e,e.updateFlag!==this._textureMatrix.updateFlag&&e.isIdentity()!==this._textureMatrix.isIdentity()&&((t=this.getScene())===null||t===void 0||t.markAllMaterialsAsDirty(1,i=>i.getActiveTextures().indexOf(this)!==-1))}dispose(){this.onLoadObservable.clear(),super.dispose()}static Parse(e,t,i){let n=null;return e.name&&!e.isRenderTarget&&(n=new fa(i+e.name,t,e.size,e.noMipmap,e.generateHarmonics,e.useInGammaSpace),n.name=e.name,n.hasAlpha=e.hasAlpha,n.level=e.level,n.coordinatesMode=e.coordinatesMode,n.isBlocking=e.isBlocking),n&&(e.boundingBoxPosition&&(n.boundingBoxPosition=g.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(n.boundingBoxSize=g.FromArray(e.boundingBoxSize)),e.rotationY&&(n.rotationY=e.rotationY)),n}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.hasAlpha=this.hasAlpha,e.isCube=!0,e.level=this.level,e.size=this._size,e.coordinatesMode=this.coordinatesMode,e.useInGammaSpace=this.gammaSpace,e.generateHarmonics=this._generateHarmonics,e.customType="BABYLON.HDRCubeTexture",e.noMipmap=this._noMipmap,e.isBlocking=this._isBlocking,e.rotationY=this._rotationY,e}}fa._FacesMapping=["right","left","up","down","front","back"];Rt("BABYLON.HDRCubeTexture",fa);class Gl extends _t{constructor(e,t,i,n=!1,r=!0,a=null,o=null,l=!1){if(super(t),this._onLoad=null,this._onError=null,!e)throw new Error("Image url is not set");this._coordinatesMode=H.CUBIC_MODE,this.name=e,this.url=e,this._size=i,this._supersample=l,this._noMipmap=n,this.gammaSpace=r,this._onLoad=a,this._onError=o,this.hasAlpha=!1,this.isCube=!0,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?a&&(this._texture.isReady?q.SetImmediate(()=>a()):this._texture.onLoadedObservable.add(a)):t.useDelayedTextureLoading?this.delayLoadState=4:this._loadImage(this._loadTexture.bind(this),this._onError)}_loadImage(e,t){const i=document.createElement("canvas");Zl(this.url,n=>{this._width=n.width,this._height=n.height,i.width=this._width,i.height=this._height;const r=i.getContext("2d");r.drawImage(n,0,0);const a=r.getImageData(0,0,n.width,n.height);this._buffer=a.data.buffer,i.remove(),e()},(n,r)=>{t&&t(`${this.getClassName()} could not be loaded`,r)},null)}_loadTexture(){const e=this.getScene(),t=()=>{const i=this._getFloat32ArrayFromArrayBuffer(this._buffer),n=Zr.ConvertPanoramaToCubemap(i,this._width,this._height,this._size,this._supersample),r=[];for(let a=0;a<6;a++){const o=n[Gl._FacesMapping[a]];r.push(o)}return r};e&&(this._texture=e.getEngine().createRawCubeTextureFromUrl(this.url,e,this._size,4,e.getEngine().getCaps().textureFloat?1:7,this._noMipmap,t,null,this._onLoad,this._onError))}_getFloat32ArrayFromArrayBuffer(e){const t=new DataView(e),i=new Float32Array(e.byteLength*3/4);let n=0;for(let r=0;r<e.byteLength;r++)(r+1)%4!==0&&(i[n++]=t.getUint8(r)/255);return i}getClassName(){return"EquiRectangularCubeTexture"}clone(){const e=this.getScene();if(!e)return this;const t=new Gl(this.url,e,this._size,this._noMipmap,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t}}Gl._FacesMapping=["right","left","up","down","front","back"];var Ks;(function(s){s[s.INIT=0]="INIT",s[s.RUNNING=1]="RUNNING",s[s.DONE=2]="DONE",s[s.ERROR=3]="ERROR"})(Ks||(Ks={}));class cr{constructor(e){this.name=e,this._isCompleted=!1,this._taskState=Ks.INIT}get isCompleted(){return this._isCompleted}get taskState(){return this._taskState}get errorObject(){return this._errorObject}_setErrorObject(e,t){this._errorObject||(this._errorObject={message:e,exception:t})}run(e,t,i){this._taskState=Ks.RUNNING,this.runTask(e,()=>{this._onDoneCallback(t,i)},(n,r)=>{this._onErrorCallback(i,n,r)})}runTask(e,t,i){throw new Error("runTask is not implemented")}reset(){this._taskState=Ks.INIT}_onErrorCallback(e,t,i){this._taskState=Ks.ERROR,this._errorObject={message:t,exception:i},this.onError&&this.onError(this,t,i),e()}_onDoneCallback(e,t){try{this._taskState=Ks.DONE,this._isCompleted=!0,this.onSuccess&&this.onSuccess(this),e()}catch(i){this._onErrorCallback(t,"Task is done, error executing success callback(s)",i)}}}class wM{constructor(e,t,i){this.remainingCount=e,this.totalCount=t,this.task=i}}class FM extends cr{constructor(e,t,i,n,r){super(e),this.name=e,this.meshesNames=t,this.rootUrl=i,this.sceneFilename=n,this.extension=r}runTask(e,t,i){Ze.LoadAssetContainer(this.rootUrl,this.sceneFilename,e,n=>{this.loadedContainer=n,this.loadedMeshes=n.meshes,this.loadedTransformNodes=n.transformNodes,this.loadedParticleSystems=n.particleSystems,this.loadedSkeletons=n.skeletons,this.loadedAnimationGroups=n.animationGroups,t()},null,(n,r,a)=>{i(r,a)},this.extension)}}class LM extends cr{constructor(e,t,i,n,r){super(e),this.name=e,this.meshesNames=t,this.rootUrl=i,this.sceneFilename=n,this.extension=r}runTask(e,t,i){Ze.ImportMesh(this.meshesNames,this.rootUrl,this.sceneFilename,e,(n,r,a,o,l)=>{this.loadedMeshes=n,this.loadedTransformNodes=l,this.loadedParticleSystems=r,this.loadedSkeletons=a,this.loadedAnimationGroups=o,t()},null,(n,r,a)=>{i(r,a)},this.extension)}}class NM extends cr{constructor(e,t){super(e),this.name=e,this.url=t}runTask(e,t,i){e._loadFile(this.url,n=>{this.text=n,t()},void 0,!1,!1,(n,r)=>{n&&i(n.status+" "+n.statusText,r)})}}class BM extends cr{constructor(e,t){super(e),this.name=e,this.url=t}runTask(e,t,i){e._loadFile(this.url,n=>{this.data=n,t()},void 0,!0,!0,(n,r)=>{n&&i(n.status+" "+n.statusText,r)})}}class kM extends cr{constructor(e,t){super(e),this.name=e,this.url=t}runTask(e,t,i){const n=new Image;q.SetCorsBehavior(this.url,n),n.onload=()=>{this.image=n,t()},n.onerror=r=>{i("Error loading image",r)},n.src=this.url}}class UM extends cr{constructor(e,t,i,n=!0,r=H.TRILINEAR_SAMPLINGMODE){super(e),this.name=e,this.url=t,this.noMipmap=i,this.invertY=n,this.samplingMode=r}runTask(e,t,i){const n=()=>{t()},r=(a,o)=>{i(a,o)};this.texture=new H(this.url,e,this.noMipmap,this.invertY,this.samplingMode,n,r)}}class VM extends cr{constructor(e,t,i,n,r,a){super(e),this.name=e,this.url=t,this.extensions=i,this.noMipmap=n,this.files=r,this.prefiltered=a}runTask(e,t,i){const n=()=>{t()},r=(a,o)=>{i(a,o)};this.texture=new Li(this.url,e,this.extensions,this.noMipmap,this.files,n,r,void 0,this.prefiltered)}}class GM extends cr{constructor(e,t,i,n=!1,r=!0,a=!1,o=!1){super(e),this.name=e,this.url=t,this.size=i,this.noMipmap=n,this.generateHarmonics=r,this.gammaSpace=a,this.reserved=o}runTask(e,t,i){const n=()=>{t()},r=(a,o)=>{i(a,o)};this.texture=new fa(this.url,e,this.size,this.noMipmap,this.generateHarmonics,this.gammaSpace,this.reserved,n,r)}}class zM extends cr{constructor(e,t,i,n=!1,r=!0){super(e),this.name=e,this.url=t,this.size=i,this.noMipmap=n,this.gammaSpace=r}runTask(e,t,i){const n=()=>{t()},r=(a,o)=>{i(a,o)};this.texture=new Gl(this.url,e,this.size,this.noMipmap,this.gammaSpace,n,r)}}class HM{constructor(e){this._isLoading=!1,this._tasks=new Array,this._waitingTasksCount=0,this._totalTasksCount=0,this.onTaskSuccessObservable=new O,this.onTaskErrorObservable=new O,this.onTasksDoneObservable=new O,this.onProgressObservable=new O,this.useDefaultLoadingScreen=!0,this.autoHideLoadingUI=!0,this._scene=e||Fe.LastCreatedScene}addContainerTask(e,t,i,n,r){const a=new FM(e,t,i,n,r);return this._tasks.push(a),a}addMeshTask(e,t,i,n,r){const a=new LM(e,t,i,n,r);return this._tasks.push(a),a}addTextFileTask(e,t){const i=new NM(e,t);return this._tasks.push(i),i}addBinaryFileTask(e,t){const i=new BM(e,t);return this._tasks.push(i),i}addImageTask(e,t){const i=new kM(e,t);return this._tasks.push(i),i}addTextureTask(e,t,i,n,r=H.TRILINEAR_SAMPLINGMODE){const a=new UM(e,t,i,n,r);return this._tasks.push(a),a}addCubeTextureTask(e,t,i,n,r,a){const o=new VM(e,t,i,n,r,a);return this._tasks.push(o),o}addHDRCubeTextureTask(e,t,i,n=!1,r=!0,a=!1,o=!1){const l=new GM(e,t,i,n,r,a,o);return this._tasks.push(l),l}addEquiRectangularCubeTextureAssetTask(e,t,i,n=!1,r=!0){const a=new zM(e,t,i,n,r);return this._tasks.push(a),a}removeTask(e){const t=this._tasks.indexOf(e);t>-1&&this._tasks.splice(t,1)}_decreaseWaitingTasksCount(e){this._waitingTasksCount--;try{this.onProgress&&this.onProgress(this._waitingTasksCount,this._totalTasksCount,e),this.onProgressObservable.notifyObservers(new wM(this._waitingTasksCount,this._totalTasksCount,e))}catch(t){U.Error("Error running progress callbacks."),console.log(t)}if(this._waitingTasksCount===0){try{const t=this._tasks.slice();this.onFinish&&this.onFinish(t);for(const i of t)if(i.taskState===Ks.DONE){const n=this._tasks.indexOf(i);n>-1&&this._tasks.splice(n,1)}this.onTasksDoneObservable.notifyObservers(this._tasks)}catch(t){U.Error("Error running tasks-done callbacks."),console.log(t)}this._isLoading=!1,this.autoHideLoadingUI&&this._scene.getEngine().hideLoadingUI()}}_runTask(e){const t=()=>{try{this.onTaskSuccess&&this.onTaskSuccess(e),this.onTaskSuccessObservable.notifyObservers(e),this._decreaseWaitingTasksCount(e)}catch(n){i("Error executing task success callbacks",n)}},i=(n,r)=>{e._setErrorObject(n,r),this.onTaskError?this.onTaskError(e):e.onError||U.Error(this._formatTaskErrorMessage(e)),this.onTaskErrorObservable.notifyObservers(e),this._decreaseWaitingTasksCount(e)};e.run(this._scene,t,i)}_formatTaskErrorMessage(e){let t="Unable to complete task "+e.name;return e.errorObject.message&&(t+=`: ${e.errorObject.message}`),e.errorObject.exception&&(t+=`: ${e.errorObject.exception}`),t}reset(){return this._isLoading=!1,this._tasks=new Array,this}load(){if(this._isLoading)return this;if(this._isLoading=!0,this._waitingTasksCount=this._tasks.length,this._totalTasksCount=this._tasks.length,this._waitingTasksCount===0)return this._isLoading=!1,this.onFinish&&this.onFinish(this._tasks),this.onTasksDoneObservable.notifyObservers(this._tasks),this;this.useDefaultLoadingScreen&&this._scene.getEngine().displayLoadingUI();for(let e=0;e<this._tasks.length;e++){const t=this._tasks[e];t.taskState===Ks.INIT&&this._runTask(t)}return this}loadAsync(){return new Promise((e,t)=>{if(this._isLoading){e();return}this.onTasksDoneObservable.addOnce(i=>{i&&i.length?t(i):e()}),this.load()})}}const WM="defaultFragmentDeclaration",XM=`uniform vec4 vEyePosition;uniform vec4 vDiffuseColor;
#ifdef SPECULARTERM
uniform vec4 vSpecularColor;
#endif
uniform vec3 vEmissiveColor;uniform vec3 vAmbientColor;uniform float visibility;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY 
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef ALPHATEST
uniform float alphaCutOff;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFRACTION
uniform vec4 vRefractionInfos;
#ifndef REFRACTIONMAP_3D
uniform mat4 refractionMatrix;
#endif
#ifdef REFRACTIONFRESNEL
uniform vec4 refractionLeftColor;uniform vec4 refractionRightColor;
#endif
#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; 
#endif
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
#endif
#ifdef DIFFUSEFRESNEL
uniform vec4 diffuseLeftColor;uniform vec4 diffuseRightColor;
#endif
#ifdef OPACITYFRESNEL
uniform vec4 opacityParts;
#endif
#ifdef EMISSIVEFRESNEL
uniform vec4 emissiveLeftColor;uniform vec4 emissiveRightColor;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)
uniform mat4 reflectionMatrix;
#endif
#ifndef REFLECTIONMAP_SKYBOX
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; 
#endif
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 reflectionLeftColor;uniform vec4 reflectionRightColor;
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#define ADDITIONAL_FRAGMENT_DECLARATION
`;Q.IncludesShadersStore[WM]=XM;const YM="defaultUboDeclaration",KM=`layout(std140,column_major) uniform;uniform Material
{vec4 diffuseLeftColor;vec4 diffuseRightColor;vec4 opacityParts;vec4 reflectionLeftColor;vec4 reflectionRightColor;vec4 refractionLeftColor;vec4 refractionRightColor;vec4 emissiveLeftColor;vec4 emissiveRightColor;vec2 vDiffuseInfos;vec2 vAmbientInfos;vec2 vOpacityInfos;vec2 vReflectionInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec2 vSpecularInfos;vec3 vBumpInfos;mat4 diffuseMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 reflectionMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 specularMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;float pointSize;float alphaCutOff;mat4 refractionMatrix;vec4 vRefractionInfos;vec3 vRefractionPosition;vec3 vRefractionSize;vec4 vSpecularColor;vec3 vEmissiveColor;vec4 vDiffuseColor;vec3 vAmbientColor;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;Q.IncludesShadersStore[YM]=KM;const QM="lightsFragmentFunctions",ZM=`struct lightingInfo
{vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef NDOTL
float ndl;
#endif
};lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 lightVectorW;float attenuation=1.0;if (lightData.w==0.)
{vec3 direction=lightData.xyz-vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}
else
{lightVectorW=normalize(-lightData.xyz);}
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
lightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)
{cosAngle=max(0.,pow(cosAngle,lightData.w));attenuation*=cosAngle;float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
lightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {lightingInfo result;float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightData.xyz);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;
#endif
return result;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return textureColor;}`;Q.IncludesShadersStore[QM]=ZM;const qM="fresnelFunction",jM=`#ifdef FRESNEL
float computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)
{float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}
#endif
`;Q.IncludesShadersStore[qM]=jM;const $M="defaultPixelShader",JM=`#include<__decl__defaultFragment>
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#define RECIPROCAL_PI2 0.15915494
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
uniform samplerCube refractionCubeSampler;
#else
uniform sampler2D refraction2DSampler;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
uniform samplerCube reflectionCubeSampler;
#else
uniform sampler2D reflection2DSampler;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);vec4 baseColor=vec4(1.,1.,1.,1.);vec3 diffuseColor=vDiffuseColor.rgb;float alpha=vDiffuseColor.a;
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#ifdef DIFFUSE
baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<alphaCutOff)
discard;
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor.rgb*=vDiffuseInfos.y;
#endif
#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
baseColor.rgb*=vColor.rgb;
#endif
#ifdef DETAIL
baseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);
#endif
#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
vec3 baseAmbientColor=vec3(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
#ifdef SPECULARTERM
float glossiness=vSpecularColor.a;vec3 specularColor=vSpecularColor.rgb;
#ifdef SPECULAR
vec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#else
float glossiness=0.;
#endif
vec3 diffuseBase=vec3(0.,0.,0.);lightingInfo info;
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
float shadow=1.;
#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
#include<lightFragment>[0..maxSimultaneousLights]
vec4 refractionColor=vec4(0.,0.,0.,1.);
#ifdef REFRACTION
vec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec4 refractionLookup=textureCube(refractionCubeSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=texture2D(refraction2DSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor.rgb=fromRGBD(refractionColor);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor.rgb=toGammaSpace(refractionColor.rgb);
#endif
refractionColor.rgb*=vRefractionInfos.x;
#endif
vec4 reflectionColor=vec4(0.,0.,0.,1.);
#ifdef REFLECTION
vec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
float bias=vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);
#else
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);
#endif
#else
vec2 coords=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;reflectionColor=texture2D(reflection2DSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor.rgb=toGammaSpace(reflectionColor.rgb);
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#ifdef REFLECTIONFRESNEL
float reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
float refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;
#else
alpha*=opacityMap.a*vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#ifdef OPACITYFRESNEL
float opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<alphaCutOff)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
vec3 emissiveColor=vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
float emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
float diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
vec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#else
vec3 finalSpecular=vec3(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#ifdef EMISSIVEASILLUMINATION
vec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
vec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color.rgb*=lightmapColor.rgb;
#else
color.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color.rgb=max(color.rgb,0.);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color.rgb=toLinearSpace(color.rgb);
#else
#ifdef IMAGEPROCESSING
color.rgb=toLinearSpace(color.rgb);color=applyImageProcessing(color);
#endif
#endif
color.a*=visibility;
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;gl_FragData[0]=color; 
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULARTERM)
#if defined(SPECULAR)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; 
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;
#endif
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0)*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=color;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=color.rgb*color.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-color.a);} else {backColor+=color;}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;Q.ShadersStore[$M]=JM;const eP="defaultVertexDeclaration",tP=`uniform mat4 viewProjection;uniform mat4 view;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;uniform mat4 specularMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef REFLECTION
uniform mat4 reflectionMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;Q.IncludesShadersStore[eP]=tP;const iP="pointCloudVertex",nP=`#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
`;Q.IncludesShadersStore[iP]=nP;const sP="defaultVertexShader",rP=`#include<__decl__defaultVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
vPositionW=vec3(worldPos);
#include<prePassVertex>
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<pointCloudVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;Q.ShadersStore[sP]=rP;const jh={effect:null,subMesh:null};class aP extends Fs{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.DECAL_AFTER_DETAIL=!1,this.rebuild()}setReflectionMode(e){const t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const i of t)this[i]=i===e}}class J extends wE{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}constructor(e,t){super(e,t),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new G(0,0,0),this.diffuseColor=new G(1,1,1),this.specularColor=new G(1,1,1),this.emissiveColor=new G(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._applyDecalMapAfterDetailMap=!1,this._renderTargets=new Mi(16),this._worldViewProjectionMatrix=D.Zero(),this._globalAmbientColor=new G(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new Kr(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new Ru,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),J.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),J.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return J.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||J.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this._markAllSubMeshesAsMiscDirty()}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled}needAlphaTesting(){return this._forceAlphaTest?!0:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===z.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==z.MATERIAL_OPAQUE}_hasAlphaChannel(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(yi.GetDefineNames,this._eventInfo),t.materialDefines=new aP(this._eventInfo.defineNames));const n=this.getScene(),r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const a=n.getEngine();r._needNormals=se.PrepareDefinesForLights(n,e,r,!0,this._maxSimultaneousLights,this._disableLighting),se.PrepareDefinesForMultiview(n,r);const o=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(se.PrepareDefinesForPrePass(n,r,this.canRenderToMRT&&!o),se.PrepareDefinesForOIT(n,r,o),r._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,r._needUVs=!1;for(let c=1;c<=6;++c)r["MAINUV"+c]=!1;if(n.texturesEnabled){if(r.DIFFUSEDIRECTUV=0,r.BUMPDIRECTUV=0,r.AMBIENTDIRECTUV=0,r.OPACITYDIRECTUV=0,r.EMISSIVEDIRECTUV=0,r.SPECULARDIRECTUV=0,r.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&J.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._diffuseTexture,r,"DIFFUSE");else return!1;else r.DIFFUSE=!1;if(this._ambientTexture&&J.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._ambientTexture,r,"AMBIENT");else return!1;else r.AMBIENT=!1;if(this._opacityTexture&&J.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._opacityTexture,r,"OPACITY"),r.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else r.OPACITY=!1;if(this._reflectionTexture&&J.ReflectionTextureEnabled)if(this._reflectionTexture.isReadyOrNotBlocking()){switch(r._needNormals=!0,r.REFLECTION=!0,r.ROUGHNESS=this._roughness>0,r.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,r.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===H.INVCUBIC_MODE,r.REFLECTIONMAP_3D=this._reflectionTexture.isCube,r.REFLECTIONMAP_OPPOSITEZ=r.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,r.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case H.EXPLICIT_MODE:r.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case H.PLANAR_MODE:r.setReflectionMode("REFLECTIONMAP_PLANAR");break;case H.PROJECTION_MODE:r.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case H.SKYBOX_MODE:r.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case H.SPHERICAL_MODE:r.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case H.EQUIRECTANGULAR_MODE:r.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case H.FIXED_EQUIRECTANGULAR_MODE:r.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case H.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:r.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case H.CUBIC_MODE:case H.INVCUBIC_MODE:default:r.setReflectionMode("REFLECTIONMAP_CUBIC");break}r.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else return!1;else r.REFLECTION=!1,r.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&J.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._emissiveTexture,r,"EMISSIVE");else return!1;else r.EMISSIVE=!1;if(this._lightmapTexture&&J.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._lightmapTexture,r,"LIGHTMAP"),r.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,r.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else r.LIGHTMAP=!1;if(this._specularTexture&&J.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._specularTexture,r,"SPECULAR"),r.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else r.SPECULAR=!1;if(n.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&J.BumpTextureEnabled){if(this._bumpTexture.isReady())se.PrepareDefinesForMergedUV(this._bumpTexture,r,"BUMP"),r.PARALLAX=this._useParallax,r.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;r.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else r.BUMP=!1,r.PARALLAX=!1,r.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&J.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())r._needUVs=!0,r.REFRACTION=!0,r.REFRACTIONMAP_3D=this._refractionTexture.isCube,r.RGBDREFRACTION=this._refractionTexture.isRGBD,r.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else r.REFRACTION=!1;r.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else r.DIFFUSE=!1,r.AMBIENT=!1,r.OPACITY=!1,r.REFLECTION=!1,r.EMISSIVE=!1,r.LIGHTMAP=!1,r.BUMP=!1,r.REFRACTION=!1;r.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),r.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,r.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,r.SPECULAROVERALPHA=this._useSpecularOverAlpha,r.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,r.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,r.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(r._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(r),r.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,r.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}r._areFresnelDirty&&(J.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(r.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,r.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,r.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,r.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,r.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,r.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,r._needNormals=!0,r.FRESNEL=!0):r.FRESNEL=!1),se.PrepareDefinesForMisc(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,r,this._applyDecalMapAfterDetailMap),se.PrepareDefinesForFrameBoundValues(n,a,this,r,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=r,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),se.PrepareDefinesForAttributes(e,r,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let l=!1;if(r.isDirty){const c=r._areLightsDisposed;r.markAsProcessed();const u=new FE;r.REFLECTION&&u.addFallback(0,"REFLECTION"),r.SPECULAR&&u.addFallback(0,"SPECULAR"),r.BUMP&&u.addFallback(0,"BUMP"),r.PARALLAX&&u.addFallback(1,"PARALLAX"),r.PARALLAXOCCLUSION&&u.addFallback(0,"PARALLAXOCCLUSION"),r.SPECULAROVERALPHA&&u.addFallback(0,"SPECULAROVERALPHA"),r.FOG&&u.addFallback(1,"FOG"),r.POINTSIZE&&u.addFallback(0,"POINTSIZE"),r.LOGARITHMICDEPTH&&u.addFallback(0,"LOGARITHMICDEPTH"),se.HandleFallbacksForShadows(r,u,this._maxSimultaneousLights),r.SPECULARTERM&&u.addFallback(0,"SPECULARTERM"),r.DIFFUSEFRESNEL&&u.addFallback(1,"DIFFUSEFRESNEL"),r.OPACITYFRESNEL&&u.addFallback(2,"OPACITYFRESNEL"),r.REFLECTIONFRESNEL&&u.addFallback(3,"REFLECTIONFRESNEL"),r.EMISSIVEFRESNEL&&u.addFallback(4,"EMISSIVEFRESNEL"),r.FRESNEL&&u.addFallback(4,"FRESNEL"),r.MULTIVIEW&&u.addFallback(0,"MULTIVIEW");const h=[C.PositionKind];r.NORMAL&&h.push(C.NormalKind),r.TANGENT&&h.push(C.TangentKind);for(let I=1;I<=6;++I)r["UV"+I]&&h.push(`uv${I===1?"":I}`);r.VERTEXCOLOR&&h.push(C.ColorKind),se.PrepareAttributesForBones(h,e,r,u),se.PrepareAttributesForInstances(h,r),se.PrepareAttributesForMorphTargets(h,e,r),se.PrepareAttributesForBakedVertexAnimation(h,e,r);let d="default";const f=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],p=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],m=["Material","Scene","Mesh"],_={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:r.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=u,this._eventInfo.fallbackRank=0,this._eventInfo.defines=r,this._eventInfo.uniforms=f,this._eventInfo.attributes=h,this._eventInfo.samplers=p,this._eventInfo.uniformBuffersNames=m,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=_,this._callbackPluginEventGeneric(yi.PrepareEffect,this._eventInfo),Ru.AddUniforms(f),je&&(je.PrepareUniforms(f,r),je.PrepareSamplers(p,r)),se.PrepareUniformsAndSamplersList({uniformsNames:f,uniformBuffersNames:m,samplers:p,defines:r,maxSimultaneousLights:this._maxSimultaneousLights}),em(f);const E={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,f,m,p,r,h,E));const v=r.toString(),y=t.effect;let A=n.getEngine().createEffect(d,{attributes:h,uniformsNames:f,uniformBuffersNames:m,samplers:p,defines:v,fallbacks:u,onCompiled:this.onCompiled,onError:this.onError,indexParameters:_,processFinalCode:E.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:r.PREPASS},a);if(this._eventInfo.customCode=void 0,A)if(this._onEffectCreatedObservable&&(jh.effect=A,jh.subMesh=t,this._onEffectCreatedObservable.notifyObservers(jh)),this.allowShaderHotSwapping&&y&&!A.isReady()){if(A=y,r.markAsUnprocessed(),l=this.isFrozen,c)return r._areLightsDisposed=!0,!1}else n.resetCachedMaterial(),t.setEffect(A,r,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(r._renderId=n.getRenderId(),t.effect._wasPreviouslyReady=!l,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var n;const r=this.getScene(),a=i.materialDefines;if(!a)return;const o=i.effect;if(!o)return;this._activeEffect=o,t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(o,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),a.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const l=o._forceRebindOnNextCall||this._mustRebind(r,o,t.visibility);se.BindBonesParameters(t,o);const c=this._uniformBuffer;if(l){if(this.bindViewProjection(o),!c.useUbo||!this.isFrozen||!c.isSync||o._forceRebindOnNextCall){if(J.FresnelEnabled&&a.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(c.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),c.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&c.updateColor4("opacityParts",new G(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(c.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),c.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(c.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),c.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(c.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),c.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),r.texturesEnabled){if(this._diffuseTexture&&J.DiffuseTextureEnabled&&(c.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),se.BindTextureMatrix(this._diffuseTexture,c,"diffuse")),this._ambientTexture&&J.AmbientTextureEnabled&&(c.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),se.BindTextureMatrix(this._ambientTexture,c,"ambient")),this._opacityTexture&&J.OpacityTextureEnabled&&(c.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),se.BindTextureMatrix(this._opacityTexture,c,"opacity")),this._hasAlphaChannel()&&c.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&J.ReflectionTextureEnabled&&(c.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),c.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){const u=this._reflectionTexture;c.updateVector3("vReflectionPosition",u.boundingBoxPosition),c.updateVector3("vReflectionSize",u.boundingBoxSize)}if(this._emissiveTexture&&J.EmissiveTextureEnabled&&(c.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),se.BindTextureMatrix(this._emissiveTexture,c,"emissive")),this._lightmapTexture&&J.LightmapTextureEnabled&&(c.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),se.BindTextureMatrix(this._lightmapTexture,c,"lightmap")),this._specularTexture&&J.SpecularTextureEnabled&&(c.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),se.BindTextureMatrix(this._specularTexture,c,"specular")),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&J.BumpTextureEnabled&&(c.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),se.BindTextureMatrix(this._bumpTexture,c,"bump"),r._mirroredCameraPosition?c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&J.RefractionTextureEnabled){let u=1;if(this._refractionTexture.isCube||(c.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(u=this._refractionTexture.depth)),c.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,u,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const h=this._refractionTexture;c.updateVector3("vRefractionPosition",h.boundingBoxPosition),c.updateVector3("vRefractionSize",h.boundingBoxSize)}}}this.pointsCloud&&c.updateFloat("pointSize",this.pointSize),a.SPECULARTERM&&c.updateColor4("vSpecularColor",this.specularColor,this.specularPower),c.updateColor3("vEmissiveColor",J.EmissiveTextureEnabled?this.emissiveColor:G.BlackReadOnly),c.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),r.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),c.updateColor3("vAmbientColor",this._globalAmbientColor)}r.texturesEnabled&&(this._diffuseTexture&&J.DiffuseTextureEnabled&&o.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&J.AmbientTextureEnabled&&o.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&J.OpacityTextureEnabled&&o.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&J.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?o.setTexture("reflectionCubeSampler",this._reflectionTexture):o.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&J.EmissiveTextureEnabled&&o.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&J.LightmapTextureEnabled&&o.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&J.SpecularTextureEnabled&&o.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&J.BumpTextureEnabled&&o.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&J.RefractionTextureEnabled&&(this._refractionTexture.isCube?o.setTexture("refractionCubeSampler",this._refractionTexture):o.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(o),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),tm(o,this,r),this.bindEyePosition(o)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&se.BindLights(r,t,o,a,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==Le.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||a.PREPASS)&&this.bindView(o),se.BindFogParameters(r,t,o),a.NUM_MORPH_INFLUENCERS&&se.BindMorphTargetParameters(t,o),a.BAKED_VERTEX_ANIMATION_TEXTURE&&((n=t.bakedVertexAnimationManager)===null||n===void 0||n.bind(o,a.INSTANCES)),this.useLogarithmicDepth&&se.BindLogDepth(a,o,r),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),c.update()}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e)}dispose(e,t){var i,n,r,a,o,l,c,u,h;t&&((i=this._diffuseTexture)===null||i===void 0||i.dispose(),(n=this._ambientTexture)===null||n===void 0||n.dispose(),(r=this._opacityTexture)===null||r===void 0||r.dispose(),(a=this._reflectionTexture)===null||a===void 0||a.dispose(),(o=this._emissiveTexture)===null||o===void 0||o.dispose(),(l=this._specularTexture)===null||l===void 0||l.dispose(),(c=this._bumpTexture)===null||c===void 0||c.dispose(),(u=this._lightmapTexture)===null||u===void 0||u.dispose(),(h=this._refractionTexture)===null||h===void 0||h.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e,t=!0,i=""){const n=Pe.Clone(()=>new J(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return n.name=e,n.id=e,this.stencil.copyTo(n.stencil),this._clonePlugins(n,i),n}static Parse(e,t,i){const n=Pe.Parse(()=>new J(e.name,t),e,t,i);return e.stencil&&n.stencil.parse(e.stencil,t,i),z._parsePlugins(e,n,t,i),n}static get DiffuseTextureEnabled(){return Y.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){Y.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return Y.DetailTextureEnabled}static set DetailTextureEnabled(e){Y.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return Y.AmbientTextureEnabled}static set AmbientTextureEnabled(e){Y.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return Y.OpacityTextureEnabled}static set OpacityTextureEnabled(e){Y.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return Y.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){Y.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return Y.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){Y.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return Y.SpecularTextureEnabled}static set SpecularTextureEnabled(e){Y.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return Y.BumpTextureEnabled}static set BumpTextureEnabled(e){Y.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return Y.LightmapTextureEnabled}static set LightmapTextureEnabled(e){Y.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return Y.RefractionTextureEnabled}static set RefractionTextureEnabled(e){Y.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return Y.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){Y.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return Y.FresnelEnabled}static set FresnelEnabled(e){Y.FresnelEnabled=e}}S([ht("diffuseTexture")],J.prototype,"_diffuseTexture",void 0);S([K("_markAllSubMeshesAsTexturesAndMiscDirty")],J.prototype,"diffuseTexture",void 0);S([ht("ambientTexture")],J.prototype,"_ambientTexture",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"ambientTexture",void 0);S([ht("opacityTexture")],J.prototype,"_opacityTexture",void 0);S([K("_markAllSubMeshesAsTexturesAndMiscDirty")],J.prototype,"opacityTexture",void 0);S([ht("reflectionTexture")],J.prototype,"_reflectionTexture",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"reflectionTexture",void 0);S([ht("emissiveTexture")],J.prototype,"_emissiveTexture",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"emissiveTexture",void 0);S([ht("specularTexture")],J.prototype,"_specularTexture",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"specularTexture",void 0);S([ht("bumpTexture")],J.prototype,"_bumpTexture",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"bumpTexture",void 0);S([ht("lightmapTexture")],J.prototype,"_lightmapTexture",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"lightmapTexture",void 0);S([ht("refractionTexture")],J.prototype,"_refractionTexture",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"refractionTexture",void 0);S([Gi("ambient")],J.prototype,"ambientColor",void 0);S([Gi("diffuse")],J.prototype,"diffuseColor",void 0);S([Gi("specular")],J.prototype,"specularColor",void 0);S([Gi("emissive")],J.prototype,"emissiveColor",void 0);S([b()],J.prototype,"specularPower",void 0);S([b("useAlphaFromDiffuseTexture")],J.prototype,"_useAlphaFromDiffuseTexture",void 0);S([K("_markAllSubMeshesAsTexturesAndMiscDirty")],J.prototype,"useAlphaFromDiffuseTexture",void 0);S([b("useEmissiveAsIllumination")],J.prototype,"_useEmissiveAsIllumination",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useEmissiveAsIllumination",void 0);S([b("linkEmissiveWithDiffuse")],J.prototype,"_linkEmissiveWithDiffuse",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"linkEmissiveWithDiffuse",void 0);S([b("useSpecularOverAlpha")],J.prototype,"_useSpecularOverAlpha",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useSpecularOverAlpha",void 0);S([b("useReflectionOverAlpha")],J.prototype,"_useReflectionOverAlpha",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useReflectionOverAlpha",void 0);S([b("disableLighting")],J.prototype,"_disableLighting",void 0);S([K("_markAllSubMeshesAsLightsDirty")],J.prototype,"disableLighting",void 0);S([b("useObjectSpaceNormalMap")],J.prototype,"_useObjectSpaceNormalMap",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useObjectSpaceNormalMap",void 0);S([b("useParallax")],J.prototype,"_useParallax",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useParallax",void 0);S([b("useParallaxOcclusion")],J.prototype,"_useParallaxOcclusion",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useParallaxOcclusion",void 0);S([b()],J.prototype,"parallaxScaleBias",void 0);S([b("roughness")],J.prototype,"_roughness",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"roughness",void 0);S([b()],J.prototype,"indexOfRefraction",void 0);S([b()],J.prototype,"invertRefractionY",void 0);S([b()],J.prototype,"alphaCutOff",void 0);S([b("useLightmapAsShadowmap")],J.prototype,"_useLightmapAsShadowmap",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useLightmapAsShadowmap",void 0);S([jl("diffuseFresnelParameters")],J.prototype,"_diffuseFresnelParameters",void 0);S([K("_markAllSubMeshesAsFresnelDirty")],J.prototype,"diffuseFresnelParameters",void 0);S([jl("opacityFresnelParameters")],J.prototype,"_opacityFresnelParameters",void 0);S([K("_markAllSubMeshesAsFresnelAndMiscDirty")],J.prototype,"opacityFresnelParameters",void 0);S([jl("reflectionFresnelParameters")],J.prototype,"_reflectionFresnelParameters",void 0);S([K("_markAllSubMeshesAsFresnelDirty")],J.prototype,"reflectionFresnelParameters",void 0);S([jl("refractionFresnelParameters")],J.prototype,"_refractionFresnelParameters",void 0);S([K("_markAllSubMeshesAsFresnelDirty")],J.prototype,"refractionFresnelParameters",void 0);S([jl("emissiveFresnelParameters")],J.prototype,"_emissiveFresnelParameters",void 0);S([K("_markAllSubMeshesAsFresnelDirty")],J.prototype,"emissiveFresnelParameters",void 0);S([b("useReflectionFresnelFromSpecular")],J.prototype,"_useReflectionFresnelFromSpecular",void 0);S([K("_markAllSubMeshesAsFresnelDirty")],J.prototype,"useReflectionFresnelFromSpecular",void 0);S([b("useGlossinessFromSpecularMapAlpha")],J.prototype,"_useGlossinessFromSpecularMapAlpha",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useGlossinessFromSpecularMapAlpha",void 0);S([b("maxSimultaneousLights")],J.prototype,"_maxSimultaneousLights",void 0);S([K("_markAllSubMeshesAsLightsDirty")],J.prototype,"maxSimultaneousLights",void 0);S([b("invertNormalMapX")],J.prototype,"_invertNormalMapX",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"invertNormalMapX",void 0);S([b("invertNormalMapY")],J.prototype,"_invertNormalMapY",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"invertNormalMapY",void 0);S([b("twoSidedLighting")],J.prototype,"_twoSidedLighting",void 0);S([K("_markAllSubMeshesAsTexturesDirty")],J.prototype,"twoSidedLighting",void 0);S([b("applyDecalMapAfterDetailMap")],J.prototype,"_applyDecalMapAfterDetailMap",void 0);S([K("_markAllSubMeshesAsMiscDirty")],J.prototype,"applyDecalMapAfterDetailMap",void 0);S([b()],J.prototype,"useLogarithmicDepth",null);Rt("BABYLON.StandardMaterial",J);Le.DefaultMaterialFactory=s=>new J("default material",s);class oP{constructor(){}}class Ro extends J{AttachAfterBind(e,t){if(this._newUniformInstances)for(const i in this._newUniformInstances){const n=i.toString().split("-");n[0]=="vec2"?t.setVector2(n[1],this._newUniformInstances[i]):n[0]=="vec3"?t.setVector3(n[1],this._newUniformInstances[i]):n[0]=="vec4"?t.setVector4(n[1],this._newUniformInstances[i]):n[0]=="mat4"?t.setMatrix(n[1],this._newUniformInstances[i]):n[0]=="float"&&t.setFloat(n[1],this._newUniformInstances[i])}if(this._newSamplerInstances)for(const i in this._newSamplerInstances){const n=i.toString().split("-");n[0]=="sampler2D"&&this._newSamplerInstances[i].isReady&&this._newSamplerInstances[i].isReady()&&t.setTexture(n[1],this._newSamplerInstances[i])}}ReviewUniform(e,t){if(e=="uniform"&&this._newUniforms)for(let i=0;i<this._newUniforms.length;i++)this._customUniform[i].indexOf("sampler")==-1&&t.push(this._newUniforms[i].replace(/\[\d*\]/g,""));if(e=="sampler"&&this._newUniforms)for(let i=0;i<this._newUniforms.length;i++)this._customUniform[i].indexOf("sampler")!=-1&&t.push(this._newUniforms[i].replace(/\[\d*\]/g,""));return t}Builder(e,t,i,n,r,a){if(a&&this._customAttributes&&this._customAttributes.length>0&&a.push(...this._customAttributes),this.ReviewUniform("uniform",t),this.ReviewUniform("sampler",n),this._isCreatedShader)return this._createdShaderName;this._isCreatedShader=!1,Ro.ShaderIndexer++;const o="custom_"+Ro.ShaderIndexer,l=this._afterBind.bind(this);return this._afterBind=(c,u)=>{if(u){this.AttachAfterBind(c,u);try{l(c,u)}catch(h){}}},bi.ShadersStore[o+"VertexShader"]=this.VertexShader.replace("#define CUSTOM_VERTEX_BEGIN",this.CustomParts.Vertex_Begin?this.CustomParts.Vertex_Begin:"").replace("#define CUSTOM_VERTEX_DEFINITIONS",(this._customUniform?this._customUniform.join(`
`):"")+(this.CustomParts.Vertex_Definitions?this.CustomParts.Vertex_Definitions:"")).replace("#define CUSTOM_VERTEX_MAIN_BEGIN",this.CustomParts.Vertex_MainBegin?this.CustomParts.Vertex_MainBegin:"").replace("#define CUSTOM_VERTEX_UPDATE_POSITION",this.CustomParts.Vertex_Before_PositionUpdated?this.CustomParts.Vertex_Before_PositionUpdated:"").replace("#define CUSTOM_VERTEX_UPDATE_NORMAL",this.CustomParts.Vertex_Before_NormalUpdated?this.CustomParts.Vertex_Before_NormalUpdated:"").replace("#define CUSTOM_VERTEX_MAIN_END",this.CustomParts.Vertex_MainEnd?this.CustomParts.Vertex_MainEnd:""),this.CustomParts.Vertex_After_WorldPosComputed&&(bi.ShadersStore[o+"VertexShader"]=bi.ShadersStore[o+"VertexShader"].replace("#define CUSTOM_VERTEX_UPDATE_WORLDPOS",this.CustomParts.Vertex_After_WorldPosComputed)),bi.ShadersStore[o+"PixelShader"]=this.FragmentShader.replace("#define CUSTOM_FRAGMENT_BEGIN",this.CustomParts.Fragment_Begin?this.CustomParts.Fragment_Begin:"").replace("#define CUSTOM_FRAGMENT_MAIN_BEGIN",this.CustomParts.Fragment_MainBegin?this.CustomParts.Fragment_MainBegin:"").replace("#define CUSTOM_FRAGMENT_DEFINITIONS",(this._customUniform?this._customUniform.join(`
`):"")+(this.CustomParts.Fragment_Definitions?this.CustomParts.Fragment_Definitions:"")).replace("#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE",this.CustomParts.Fragment_Custom_Diffuse?this.CustomParts.Fragment_Custom_Diffuse:"").replace("#define CUSTOM_FRAGMENT_UPDATE_ALPHA",this.CustomParts.Fragment_Custom_Alpha?this.CustomParts.Fragment_Custom_Alpha:"").replace("#define CUSTOM_FRAGMENT_BEFORE_LIGHTS",this.CustomParts.Fragment_Before_Lights?this.CustomParts.Fragment_Before_Lights:"").replace("#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR",this.CustomParts.Fragment_Before_FragColor?this.CustomParts.Fragment_Before_FragColor:"").replace("#define CUSTOM_FRAGMENT_MAIN_END",this.CustomParts.Fragment_MainEnd?this.CustomParts.Fragment_MainEnd:""),this.CustomParts.Fragment_Before_Fog&&(bi.ShadersStore[o+"PixelShader"]=bi.ShadersStore[o+"PixelShader"].replace("#define CUSTOM_FRAGMENT_BEFORE_FOG",this.CustomParts.Fragment_Before_Fog)),this._isCreatedShader=!0,this._createdShaderName=o,o}constructor(e,t){super(e,t),this.CustomParts=new oP,this.customShaderNameResolve=this.Builder,this.FragmentShader=bi.ShadersStore.defaultPixelShader,this.VertexShader=bi.ShadersStore.defaultVertexShader}AddUniform(e,t,i){return this._customUniform||(this._customUniform=new Array,this._newUniforms=new Array,this._newSamplerInstances={},this._newUniformInstances={}),i&&(t.indexOf("sampler")!=-1?this._newSamplerInstances[t+"-"+e]=i:this._newUniformInstances[t+"-"+e]=i),this._customUniform.push("uniform "+t+" "+e+";"),this._newUniforms.push(e),this}AddAttribute(e){return this._customAttributes||(this._customAttributes=[]),this._customAttributes.push(e),this}Fragment_Begin(e){return this.CustomParts.Fragment_Begin=e,this}Fragment_Definitions(e){return this.CustomParts.Fragment_Definitions=e,this}Fragment_MainBegin(e){return this.CustomParts.Fragment_MainBegin=e,this}Fragment_MainEnd(e){return this.CustomParts.Fragment_MainEnd=e,this}Fragment_Custom_Diffuse(e){return this.CustomParts.Fragment_Custom_Diffuse=e.replace("result","diffuseColor"),this}Fragment_Custom_Alpha(e){return this.CustomParts.Fragment_Custom_Alpha=e.replace("result","alpha"),this}Fragment_Before_Lights(e){return this.CustomParts.Fragment_Before_Lights=e,this}Fragment_Before_Fog(e){return this.CustomParts.Fragment_Before_Fog=e,this}Fragment_Before_FragColor(e){return this.CustomParts.Fragment_Before_FragColor=e.replace("result","color"),this}Vertex_Begin(e){return this.CustomParts.Vertex_Begin=e,this}Vertex_Definitions(e){return this.CustomParts.Vertex_Definitions=e,this}Vertex_MainBegin(e){return this.CustomParts.Vertex_MainBegin=e,this}Vertex_Before_PositionUpdated(e){return this.CustomParts.Vertex_Before_PositionUpdated=e.replace("result","positionUpdated"),this}Vertex_Before_NormalUpdated(e){return this.CustomParts.Vertex_Before_NormalUpdated=e.replace("result","normalUpdated"),this}Vertex_After_WorldPosComputed(e){return this.CustomParts.Vertex_After_WorldPosComputed=e,this}Vertex_MainEnd(e){return this.CustomParts.Vertex_MainEnd=e,this}}Ro.ShaderIndexer=1;Rt("BABYLON.CustomMaterial",Ro);const Fu=class Fu{static nextRandomBool(e=.5){return e<=this.EPSILON?!1:Math.random()<=e}static nextInt(e=0,t=Number.MAX_SAFE_INTEGER){return e+Math.floor(Math.random()*(t-e))}static nextFloor(e=0,t=Number.MAX_VALUE){return e+Math.random()*(t-e)}static nextSign(e=.5){return this.nextRandomBool(e)?1:-1}static nextPointInRect(e){return{x:e.x+this.nextFloor(0,e.width),z:e.z+this.nextFloor(0,e.height)}}static nextV3InRect(e){const t=this.nextPointInRect(e);return new g(t.x,0,t.z)}static id(){return Yx(10)}static randomElement(e){return e.length===0?null:e[Fu.nextInt(0,e.length)]}static v3InCircle(e=1){const t=Math.random()*Math.PI*2,i=Math.cos(t)*e,n=Math.sin(t)*e;return new g(i,0,n)}};X(Fu,"EPSILON",1e-8);let $=Fu;function lP(s){return Ie(this,null,function*(){const e=()=>{s.debugLayer.isVisible()?s.debugLayer.hide():s.debugLayer.show({overlay:!0})};window.addEventListener("keydown",t=>Ie(this,null,function*(){if(t.shiftKey&&t.ctrlKey&&t.altKey&&t.keyCode===73){if(!document.querySelector("script[inspector]")){console.log("Start loading inspector...");const n=document.createElement("script");n.setAttribute("inspector","true"),n.src="https://cdn.babylonjs.com/inspector/babylon.inspector.bundle.js",n.onload=()=>{console.log("Inspector loaded!"),e()},n.onerror=()=>{console.log("Inspector failed to load")},document.body.appendChild(n);return}e()}}))})}function cP(){const s=document.createElement("canvas");return s.style.width="400",s.style.height="300",s.width=400,s.height=300,s}function uP(s){const e=s||cP(),t=!0,i=new k(e,!1,{audioEngine:!0,stencil:!0,powerPreference:"low-power",doNotHandleContextLost:!1,limitDeviceRatio:1},t);return k.audioEngine&&(k.audioEngine.useCustomUnlockedButton=!0),{engine:i,canvas:e}}function Hr(s,e,t,i,n){const r=[{frame:0,value:e[t]},{frame:60,value:i}];let a;if(typeof i=="number")a=B.ANIMATIONTYPE_FLOAT;else if(i instanceof G)a=B.ANIMATIONTYPE_COLOR3;else if(i instanceof g)a=B.ANIMATIONTYPE_VECTOR3;else if(i instanceof D)a=B.ANIMATIONTYPE_MATRIX;else if(i instanceof ee)a=B.ANIMATIONTYPE_QUATERNION;else throw new Error("no type");const o=new B("InterpolateValueAction",t,60,a,B.ANIMATIONLOOPMODE_CONSTANT);return o.setKeys(r),s.beginDirectAnimation(e,[o],0,60,!1,1/n)}const hP=""+new URL("main_theme-321900dc.mp3",import.meta.url).href,dP=""+new URL("pickItem-c3ee932a.wav",import.meta.url).href,ig=""+new URL("dropItem-e4704a65.wav",import.meta.url).href,fP=""+new URL("FOOTSTEP_Trainers_Gravel_Compact_Run_RR3_mono-3eb6330a.wav",import.meta.url).href,pP=""+new URL("iButtonClick-be4c0ab0.wav",import.meta.url).href,mP=""+new URL("THUNDER_Clap_Rumble_01_stereo-40b267b7.wav",import.meta.url).href,_P=""+new URL("aRain-88370214.wav",import.meta.url).href,gP=""+new URL("pickCoin-d278093d.wav",import.meta.url).href,EP=""+new URL("PUZZLE_Success_Harp_Three_Note_Bright_Wet_stereo-735e3c88.wav",import.meta.url).href,vP=""+new URL("note-aad81d13.wav",import.meta.url).href,yP=""+new URL("wakeup-7a6c7dfc.wav",import.meta.url).href,AP=""+new URL("cuttingWood-8255312b.wav",import.meta.url).href,TP=""+new URL("die1-6dcb5608.wav",import.meta.url).href,SP=""+new URL("die2-c39b8fb5.wav",import.meta.url).href,CP=""+new URL("die3-3e75042a.wav",import.meta.url).href,IP=""+new URL("attack1-5e34a5c0.wav",import.meta.url).href,RP=""+new URL("attack2-3af247a8.wav",import.meta.url).href;var ut=(s=>(s.mainTheme="mainTheme",s.pickItem="pickItem",s.dropItem="dropItem",s.supplyItem="supplyItem",s.walking="walking",s.click="click",s.heaven="heaven",s.rain="rain",s.pickCoin="pickCoin",s.success="success",s.note="note",s.wakeup="wakeup",s.cuttingWood="cuttingWood",s.die1="die1",s.die2="die2",s.die3="die3",s.attack1="attack1",s.attack2="attack2",s))(ut||{});const bP={mainTheme:hP,pickItem:dP,walking:fP,dropItem:ig,supplyItem:ig,click:pP,heaven:mP,rain:_P,pickCoin:gP,success:EP,note:vP,wakeup:yP,cuttingWood:AP,die1:TP,die2:SP,die3:CP,attack1:IP,attack2:RP},tv=1e3,iv=1001;let kf=!1;function xP(s,e){return Ie(this,null,function*(){const t=new Bf(e,{volume:0});t.id=tv,s.add({soundVolume:.5,soundTrack:t});const i=new Bf(e,{volume:0});i.id=iv,s.add({soundVolume:.6,soundTrack:i});const n=(o,l="effect")=>{const c=new es("Music",bP[o],e,()=>{},{});return(l==="music"?t:i).addSound(c),s.add({soundKey:o,sound:c}),c},r=n("mainTheme","music");r.loop=!0,r.autoplay=!0;const a=()=>{n("pickItem");const o=n("walking");o.loop=!0,o.setPlaybackRate(1.15),o.setVolume(.5),n("dropItem").setVolume(1.5),n("click"),n("supplyItem"),n("heaven").setVolume(.5);const c=n("rain");c.loop=!0,c.setVolume(.5),n("pickCoin"),n("success").setVolume(.2),n("note").setVolume(.6),n("wakeup").setPlaybackRate(1.2),n("cuttingWood"),n("attack1"),n("attack2"),n("die1"),n("die2"),n("die3"),s.bus.onSettingsChanged.notifyObservers(s.settingsEntity)};k.audioEngine&&k.audioEngine.onAudioUnlockedObservable&&k.audioEngine.onAudioUnlockedObservable.addOnce(()=>{a(),console.log("sounds inited"),kf=!0}),e.onPointerObservable.add(o=>{if(!kf&&o.type===Ce.POINTERUP)try{k.audioEngine&&k.audioEngine.unlock()}catch(l){console.error(l)}})})}function MP(s,e){if(!kf)return;const t=s.sounds.find(i=>i.soundKey===e);t&&t.sound.play(0,0)}function PP(s,e){const t=s.sounds.find(i=>i.soundKey===e);t&&t.sound.pause()}const Ii=window.gameanalytics,Oe=Ii.GameAnalytics,nv=["Body","Belt","Coat","Hair","Pant","Mustache","Eyes","Brown","Jacket","Mouth","Bristle","Weapon"],ng=new pe(0,0,0,0);class DP{constructor(e,t){X(this,"color",ng.clone());X(this,"isVisible",!1);this.colorData=e,this.pixelIndex=t}setColor(e){this.color=e}setVisible(e){this.isVisible=e,this.updateColors(e?this.color:ng)}updateColors(e){const t=e,i=this.colorData,n=this.pixelIndex;i[n*4]=Math.floor(t.r*255),i[n*4+1]=Math.floor(t.g*255),i[n*4+2]=Math.floor(t.b*255),i[n*4+3]=Math.floor(t.a*255)}}const sv=32;function OP(s,e){const t=new Uint8Array(sv*e*4);for(let o=0;o<t.length;o++)t[0]=0;const i=s.reduce((o,l)=>o+l.getTotalVertices(),0);let n=0,r=0;return{parts:s.reduce((o,l)=>{const c=nv.find(u=>l.name.startsWith(u));if(c==null)throw new Error("unknown mesh part type:"+l.name);return o[c]==null&&(o[c]=[]),o[c].push({vStart:n,vCount:l.getTotalVertices(),type:c,columnIndex:r}),r++,n+=l.getTotalVertices(),o},{}),vCount:i,meshes:s,pixelsData:t}}class wP{constructor(e,t){X(this,"parts");this.parts=nv.reduce((i,n)=>(i[n]=[],i),{}),Object.entries(e.parts).forEach(([i,n])=>{n.forEach(r=>{this.parts[i].push(new DP(e.pixelsData,sv*t+r.columnIndex))})})}}class Ae{constructor(e,t,i,n){X(this,"meshParts");this.mesh=t,this.meshIndex=i,this.commitData=n,this.meshParts=new wP(e,i)}setPartVisible(e,t,i){this.meshParts.parts[e].forEach((n,r)=>n.setVisible(t===r&&i))}setPartColor(e,t){this.meshParts.parts[e].forEach(i=>i.setColor(t.clone()))}activatePart(e,t,i){let n=!1;const r=this.meshParts.parts[e];return r.forEach((a,o)=>{o===t&&(n=!a.color.equals(i.toColor4()),n=n||a.isVisible===!1),a.setColor(i.toColor4())}),r.forEach((a,o)=>a.setVisible(t===o)),n}}X(Ae,"skinColor",new G(.2,.2,.2)),X(Ae,"skinColor2",new G(.25,.25,.25)),X(Ae,"skinColorBrown",G.FromHexString("#ffbc8d")),X(Ae,"skinColorDanger",new G(.4,.1,.1)),X(Ae,"eyesColorDark",new G(.1,.1,.1)),X(Ae,"hairColor",G.FromInts(255,188,5)),X(Ae,"eyesColor",G.FromHexString("#fafafa")),X(Ae,"bristleColorLight",G.White().scaleInPlace(.9)),X(Ae,"bristleColorDark",G.White().scaleInPlace(.3)),X(Ae,"colorLeather700",G.FromHexString("#a67e52")),X(Ae,"colorBrown300",G.FromInts(255,194,168)),X(Ae,"colorBrown500",G.FromInts(255,159,117)),X(Ae,"colorBrown600",G.FromInts(238,194,144)),X(Ae,"colorBrown700",G.FromInts(206,128,95)),X(Ae,"colorBrown800",G.FromInts(142,85,46));function Te(s){return Ie(this,null,function*(){return new Promise(e=>setTimeout(e,s))})}function FP(s,e){return s.x>=e.x&&s.x<=e.x+e.width&&s.z>=e.z&&s.z<=e.z+e.height}function LP(s,e,t,i=1e3){let n=null,r=!1;const a=o=>{if(r)return;n||(n=o);const l=Math.min((o-n)/i,1),c=!!s(Math.floor(l*(t-e)+e));l<1&&!c&&window.requestAnimationFrame(a)};return window.requestAnimationFrame(a),{dispose:()=>{r=!0}}}function rv(s,e,t,i,n,r){const a=[{frame:0,value:e[t]},{frame:30,value:i},{frame:60,value:n}],o=B.ANIMATIONTYPE_VECTOR3,l=new B("InterpolateValueAction",t,60,o,B.ANIMATIONLOOPMODE_CONSTANT);return l.setKeys(a),s.beginDirectAnimation(e,[l],0,60,!1,1/r)}function NP(s){for(let e=s.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[s[e],s[t]]=[s[t],s[e]]}return s}function BP(s){return Qt({},s)}function Bi(s,e,t){return ur(s,t,e.id+"_visual","interactiveArea",e.transform.position.clone(),{rotY:0,scaling:g.One()})}function kP(s,e,t,i,n,r=.5){return s.add({id:e,zone:n,transform:{position:t.clone(),rotation:{y:0}},interactiveArea:{radius:r,target:i}})}function ur(s,e,t,i,n,r={},a={}){return s.add(Qt({id:t,zone:e,transform:{rotation:{y:r.rotY||0},position:n,scaling:r.scaling},model:{key:i}},a))}const UP=g.One().scaleInPlace(1.5),VP=g.One();function Ra(s,e,t,i=1){return s.add({id:t+"_"+$.id(),item:{key:t,count:i},ownedBy:e})}function GP(s,e,t,i=1){s.ownedItemsQuery.entities.filter(r=>r.ownedBy===e&&r.item.key===t&&r.item.count>0).forEach(r=>{for(;i>0&&r.item.count>0;)r.item.count--,i--;r.item.count<1&&s.remove(r)})}function co(s,e){if(e<0)return!1;const t=s.playerItems.find(i=>i.item.key==="iCoin");return t==null?Ra(s,s.playerEntity.id,"iCoin",e):t.item.count+=e,s.bus.onInventoryUpdated.notifyObservers(),!0}function zP(s,e){if(e<=0)return!1;const t=s.playerItems.find(n=>n.item.key==="iCoin");if(t==null)throw new Error("no coins!");const i=t.item.count;return i<e?!1:(t.item.count-=e,s.bus.onInventoryUpdated.notifyObservers(),i===e&&s.bus.onRunOutOfCoins.notifyObservers({cause:"cmd"}),!0)}function av(s,e,t,i,n,r,a){const o=ac(s,e,"iCoin",t,i,n,r,a);return o.transform.position.y=.2,s.addComponent(o,"animateRotation",{duration:Math.PI}),o}function ac(s,e,t,i,n,r,a,o=!1){const l=ur(s,e,t+$.id(),t,new g(n,0,r),{rotY:$.nextFloor(0,Math.PI),scaling:g.One()},{item:{key:t,count:i},enabled:!0,pickable:a&&!o?!0:void 0});return o&&(l.transform.scaling&&l.transform.scaling.setAll(0),Hr(s.sceneEntity.scene,l.transform,"scaling",t==="iCoin"?UP:VP,.3).onAnimationEndObservable.addOnce(()=>{a&&s.addComponent(l,"pickable",!0)})),l}function pa(s,e,t,i=$.id()){const n=s.add({id:i,ownedBy:e.id,effect:t});return t.duration!=null&&s.addComponent(n,"willRemoveDelay",t.duration),s.bus.onAttributesChanged.notifyObservers({entity:e,attr:t.attr}),n}function um(s,e,t){if(e.purchased!=null||(s.addComponent(e,"purchased",!0),s.bus.onPurchased.notifyObservers({entity:e}),Oe.addDesignEvent("UI:Purchased:"+(e.id||""),1),t==null))return;const i=s.sceneEntity;i!=null&&i.scene.playBuyEffect(t.clone(),1e3)}function It(s,e){e.enabled==null&&(s.addComponent(e,"enabled",!0),s.bus.onEnabled.notifyObservers({entity:e}))}function HP(s,e){return ur(s,e,"arrow"+$.id(),"arrow",g.Zero(),{rotY:-1,scaling:g.One().scaleInPlace(3)},{arrow:!0,enabled:!0,animateRotation:{duration:Math.PI/2}})}function At(s,e,t=0){const i=s.with("cameraCinematic"),n=s.with("camera","cameraFollowPlayer","cameraSettings").entities[0],r=i.entities[0],a=s.playerEntity.transform.position.clone().addInPlaceFromFloats(0,2,0);r.cameraCinematic.posPath=new So([a,e,e,a]),r.cameraCinematic.rotPath=new So([new g(n.cameraSettings.alpha,n.cameraSettings.beta,n.cameraSettings.radius),new g(n.cameraSettings.alpha,n.cameraSettings.beta,n.cameraSettings.radius*.6),new g(n.cameraSettings.alpha,n.cameraSettings.beta,n.cameraSettings.radius*.6),new g(n.cameraSettings.alpha,n.cameraSettings.beta,n.cameraSettings.radius)]),r.cameraCinematic.durations=[.6,1,.6],It(s,r)}function WP(s,e,t,i){const n=e.itemProducer,r=s.sceneEntity.scene,a=$.nextFloor(n.outputArea.x,n.outputArea.x+n.outputArea.width),o=$.nextFloor(n.outputArea.z,n.outputArea.z+n.outputArea.height),l=a,c=o,u=n.outputItemType,h=f=>{s.addComponent(f,"ownedBy",e.id),s.bus.onProducerItemsUpdated.notifyObservers({id:e.id})};if(u==="iCoin"){const f=Math.ceil(t),p=av(s,e.zone,f,l,c,!0,!0);h(p);return}const d=ac(s,e.zone,u,t,l,c,!i,!i);if(i){const f=d.transform.position.clone();d.transform.position.copyFrom(e.transform.position),d.transform.position.y+=.5;const p=g.Lerp(d.transform.position,f,.5);p.addInPlaceFromFloats(0,2,0),rv(r,d.transform,"position",p,f,.3).onAnimationEndObservable.addOnce(()=>{s.addComponent(d,"pickable",!0)})}h(d)}function Rs(s,e,t){e.npcTasksList.push({type:"waiting",delay:t}),s.bus.onNpcTasksUpdated.notifyObservers({npcEntity:e})}function Cn(s,e,t,i){e.npcTasksList.push({type:"moveTo",pos:t.clone(),follow:i}),s.bus.onNpcTasksUpdated.notifyObservers({npcEntity:e})}function sg(s,e){const t=s.npcTasksList[0];t&&t.type==="moveTo"&&(t.pos.copyFrom(e),s.target&&s.target.transform.position.copyFrom(e),t.calculatedPath&&(t.calculatedPath=void 0,t.nextPoint=void 0))}function Uf(s,e,t,i,n,r,a=1){e.npcTasksList.push({item:n,type:"transferItem",count:a,fromOwnerId:t,toOwnerId:i,checkTargetFreeSpace:r}),s.bus.onNpcTasksUpdated.notifyObservers({npcEntity:e})}function ov(s,e){e.npcTasksList.push({type:"startSleeping"}),s.bus.onNpcTasksUpdated.notifyObservers({npcEntity:e})}function lv(s,e){e.npcTasksList.push({type:"stopSleeping"}),s.bus.onNpcTasksUpdated.notifyObservers({npcEntity:e})}function $h(s,e){e.npcTasksList.push({type:"clearOwnedItems"}),s.bus.onNpcTasksUpdated.notifyObservers({npcEntity:e})}function XP(s,e,t){e.npcTasksList.push({type:"chop",tree:t}),s.bus.onNpcTasksUpdated.notifyObservers({npcEntity:e})}function _s(s,e,t){t==="npcMoveToTargetBehaviour"&&e.target!=null&&(s.remove(e.target),s.removeComponent(e,"target")),s.removeComponent(e,t),s.addComponent(e,"npcEmptyBehaviour",!0)}function Br(s,e,t,i,n){const r=s.add({npcEmoji:{emoji:t,anim:n},ownedBy:e.id,willRemoveDelay:i,onRemove:[()=>{s.bus.onNpcEmojiDisappeared.notifyObservers(e)}]});return s.bus.onNpcEmojiAppeared.notifyObservers(e),r}function vt(s,e){MP(s,e)}function YP(s,e){PP(s,e)}function KP(s,e,t){e.ordersProgress!=null?e.ordersProgress=t:s.addComponent(e,"ordersProgress",t),s.bus.onOrdersProgressUpdated.notifyObservers({entity:e})}function cv(s,e,t){e.durability<=0||(e.durability-=t,s.bus.onDurabilityChanged.notifyObservers({entity:e}))}function QP(s,e,t){e.chopping==null&&(e.appearance&&e.appearance.parts.push(["Weapon",0,Ae.bristleColorDark]),s.addComponent(e,"chopping",{delay:0,target:t}),s.bus.onStartChopping.notifyObservers({entity:e}))}function rg(s,e){e.chopping!=null&&(s.removeComponent(e,"chopping"),e.appearance&&(e.appearance.parts=e.appearance.parts.filter(t=>t[0]!=="Weapon"),e.appearance.removed.push("Weapon")))}function uv(s){const e=s.playerEntity,t=e.playerInServiceBuilding;t&&(s.removeComponent(e,"paused"),s.removeComponent(e,"playerInServiceBuilding"),s.bus.onPlayerExitService.notifyObservers({service:t}));const i=s.activeCamerasQuery.entities[0];i&&s.remove(i);const n=s.camerasQuery.with("cameraFollowPlayer").entities[0];n&&s.addComponent(n,"enabled",!0)}function Vf(s,e){s.sceneEntity.paused==null&&(s.addComponent(s.sceneEntity,"paused",!0),s.bus.onPauseChanged.notifyObservers({paused:!0,reason:e}))}function Jo(s,e){s.sceneEntity.paused!=null&&(s.removeComponent(s.sceneEntity,"paused"),s.bus.onPauseChanged.notifyObservers({paused:!1,reason:e}))}function ZP(s,e,t,i,n,r){let a=15,o=1.8;if(Oe.isRemoteConfigsReady()){const d=Number(Oe.getRemoteConfigsValueAsString("bonus.lifetime",a.toString()));d&&Number.isInteger(d)&&d>0&&(a=d);const f=Number(Oe.getRemoteConfigsValueAsString("bonus.activation",(o*1e3).toString()));f&&Number.isInteger(f)&&f>0&&(o=f/1e3)}const l=g.One().scaleInPlace(.9);let c=t;(t==="iCoin"||t==="iHp"||t==="iStrength")&&(l.setAll(1.5),c="treasureChest");const u=s.add({id:$.id(),zone:e,transform:{position:r.clone().addInPlaceFromFloats(0,.3,0),rotation:{y:0},scaling:g.Zero()},enabled:!0,animateRotation:{duration:Math.PI/2},model:{key:c},bonusResource:{relatedToEntityId:n,itemType:t,itemCount:i,lifetime:a,activationDuration:o},screenPosition:j.Zero(),screenPositionOffset:new g(0,2.5,0)});Hr(s.sceneEntity.scene,u.transform,"scaling",l,.3);const h=s.add({id:u.id+"area",zone:e,enabled:!0,transform:{position:r.clone().addInPlaceFromFloats(0,.1,0),rotation:{y:0},scaling:g.One().scaleInPlace(.8)},interactiveArea:{radius:.8,target:u},model:{key:"interactiveArea"}});return s.addComponent(u,"onRemove",[()=>{s.addComponent(h,"removing",!0)}]),s.bus.onBonusResourceSpawned.notifyObservers({entity:u}),u}function hv(s=1){return Ie(this,null,function*(){for(;s--;)dv(),yield Te(200)})}function dv(s){const e=document.createElement("div");e.className="anim-picking-item",e.style.backgroundImage=`url("${ot("iCoin")}")`,s!=null&&(e.style.left=s.left,e.style.top=s.top),document.body.appendChild(e),Te(30).finally(()=>Ie(this,null,function*(){e.style.left="5%",e.style.top="5%",e.style.opacity="0",yield Te(1e3),e.remove()}))}function qP(s){s.villageEntity.villageMode="war",s.bus.onVillageModeChanged.notifyObservers(s.villageMode)}function ag(s){s.villageEntity.villageMode="peacetime",s.bus.onVillageModeChanged.notifyObservers(s.villageMode)}function jP(s,e){e.currentHp=e.maxHp||1,s.bus.onHpUpdated.notifyObservers(e)}function $P(s,e){return s.add({timer:{duration:e,delay:e,progress:0}})}function og(s,e,t,i){const n=s.add({id:$.id(),ownedBy:e,visualDamage:{dmg:t,type:i}});s.bus.onVisualDamageSpawned.notifyObservers(n)}function Gf(s,e,t){t<1||(s.playerEntity.attributesLevel[e]+=t,s.playerEntity.recalculateAttributes=!0,s.bus.onPlayerAttrLevelUpgraded.notifyObservers(e))}function JP(s){const e=document.createElement("div");e.className="anim-picking-item";const t=s==="attStr"?"iStrength":"iHp";e.style.backgroundImage=`url("${ot(t)}")`,document.body.appendChild(e),Te(30).finally(()=>Ie(this,null,function*(){e.style.left="50%",e.style.top="30%",e.style.opacity="0",yield Te(1e3),e.remove()}))}function uo(s,e,t){return s.add({zone:e,attentionPoint:t})}function eD(){return{onSceneReady:new O,onProducerItemsUpdated:new O,onProducerOutputProduced:new O,onInventoryUpdated:new O,onItemDropped:new O,onItemPicked:new O,onShowMaxAppeared:new O,onEntityScreenPositionUpdated:new O,onInteractiveAreaEntered:new O,onInteractiveAreaLeft:new O,onMoveableAreaEntered:new O,onMoveableAreaLeft:new O,onEffectsUpdated:new O,onAttributesChanged:new O,onTaskUpdated:new O,onPauseChanged:new O,onPurchased:new O,onEnabled:new O,onTimerFired:new O,onTimerProgressUpdated:new O,onPlayerMovementStarted:new O,onPlayerMovementFinished:new O,onAdOffered:new O,onAdExpired:new O,onRewardedVideoRequested:new O,onRewardedVideoStarted:new O,onRewardedVideoFinished:new O,onRewardedVideoFailed:new O,onInterstitialAdRequested:new O,onInterstitialAdOpened:new O,onInterstitialAdClosed:new O,onInterstitialAdFailed:new O,onCinematicStarted:new O,onCinematicFinished:new O,onNpcTasksUpdated:new O,onLifetimeUpdated:new O,onBuildingFinished:new O,onUsageGained:new O,onUsageFree:new O,onActionButtonPressed:new O,onActionButtonUnPressed:new O,onNpcGoalChanged:new O,onNpcEmojiAppeared:new O,onNpcEmojiDisappeared:new O,onOrdersProgressUpdated:new O,onSettingsChanged:new O,onDurabilityChanged:new O,onGameEventStarted:new O,onGameEventFinished:new O,onButtonClicked:new O,onRunOutOfCoins:new O,onVarChanged:new O,onGroundPointClicked:new O,onStartChopping:new O,onTreeChopped:new O,onTreeRespawned:new O,onArrivedToService:new O,onPlayerAtService:new O,onPlayerExitService:new O,onVisibilityChanged:new O,onEntityDestroyed:new O,onNotEnoughCoins:new O,onBonusResourceSpawned:new O,onBonusResourceRemoved:new O,onNpcStartSleep:new O,onNpcStopSleep:new O,onNpcWakeUp:new O,onInitBeforeSave:new O,onEntityUnlocked:new O,onBigSaveRequested:new O,onAchievementsUpdated:new O,onPrestigeActivated:new O,onDropTutorialRequested:new O,onDropTutorialFinished:new O,onPatchUpdated:new O,onHpUpdated:new O,onVillageModeChanged:new O,onVisualDamageSpawned:new O,onVisualDamageDestroyed:new O,onPositionUpdated:new O,onPlayerAttrLevelUpgraded:new O,onWaveWin:new O,onWaveLose:new O,onBuildingAnimationClear:new O,onBuildingAnimationProgress:new O,onZoneLoaded:new O,onZoneUnLoaded:new O}}const Dn={onPreloadingFinished:new O,onWorldCreated:new O,onGameLoaded:new O,onAfterPrestige:new O},tD=new class{constructor(){X(this,"type","poki");X(this,"_sdk");X(this,"onRewardedVideoRequested",new O);X(this,"onRewardedVideoStarted",new O);X(this,"onRewardedVideoFinished",new O);X(this,"onRewardedVideoFailed",new O);X(this,"onInterstitialAdRequested",new O);X(this,"onInterstitialAdOpened",new O);X(this,"onInterstitialAdClosed",new O);X(this,"onInterstitialAdFailed",new O);X(this,"_initialized",!1);this._sdk=window.PokiSDK}isAvailable(){return!!this._sdk}isInitialized(){return this._initialized}init(){return this._sdk.init().then(()=>{console.log("Poki SDK successfully initialized"),this._initialized=!0}).catch(()=>{console.log("Poki sdk failed to initialize")})}requestRewardedVideo(e){if(!this._sdk||!this.isInitialized())return;const t=e.id;this._sdk.rewardedBreak(()=>{this.onRewardedVideoStarted.notifyObservers({id:t})}).then(i=>{i?this.onRewardedVideoFinished.notifyObservers({id:t}):this.onRewardedVideoFailed.notifyObservers({id:t})}),this.onRewardedVideoRequested.notifyObservers({id:t})}requestInterstitialAd(e){if(!this._sdk||!this.isInitialized())return;const t=e.id;this._sdk.commercialBreak(()=>{this.onInterstitialAdOpened.notifyObservers({id:t})}).then(()=>{this.onInterstitialAdClosed.notifyObservers({id:t})}),this.onInterstitialAdRequested.notifyObservers({id:t})}sdkGameLoadingStart(){}sdkGameLoadingStop(){this._sdk&&this._sdk.gameLoadingFinished()}gameplayStart(){this._sdk&&this._sdk.gameplayStart()}gameplayStop(){this._sdk&&this._sdk.gameplayStop()}happytime(){}},Ei=new class{constructor(...e){X(this,"_sdk");this._sdk=e.find(t=>t.isAvailable())}get type(){return this._sdk?this._sdk.type:"custom"}isInitialized(){return!!this._sdk&&this._sdk.isInitialized()}get onRewardedVideoRequested(){return this._sdk.onRewardedVideoRequested}get onRewardedVideoStarted(){return this._sdk.onRewardedVideoStarted}get onRewardedVideoFinished(){return this._sdk.onRewardedVideoFinished}get onRewardedVideoFailed(){return this._sdk.onRewardedVideoFailed}get onInterstitialAdRequested(){return this._sdk.onInterstitialAdRequested}get onInterstitialAdOpened(){return this._sdk.onInterstitialAdOpened}get onInterstitialAdClosed(){return this._sdk.onInterstitialAdClosed}get onInterstitialAdFailed(){return this._sdk.onInterstitialAdFailed}isAvailable(){return this._sdk?!!this._sdk.isAvailable():!1}init(){return Ie(this,null,function*(){return this._sdk&&this._sdk.init()})}requestRewardedVideo(e){this._sdk&&this._sdk.requestRewardedVideo(e)}requestInterstitialAd(e){this._sdk&&this._sdk.requestInterstitialAd(e)}sdkGameLoadingStart(){this._sdk&&this._sdk.sdkGameLoadingStart()}sdkGameLoadingStop(){this._sdk&&this._sdk.sdkGameLoadingStop()}gameplayStart(){this._sdk&&this._sdk.gameplayStart()}gameplayStop(){this._sdk&&this._sdk.gameplayStop()}happytime(){this._sdk&&this._sdk.happytime()}}(tD);class Vn{static isRewardedVideoAvailable(){return Ei.isAvailable()&&Ei.isInitialized()}static init(){if(this._inited)return;this._inited=!0;let e=null;Dn.onGameLoaded.add(t=>{e=t.bus}),Ei.isAvailable()?(Ei.onRewardedVideoRequested.add(t=>{this.isPlaying=!0,e&&e.onRewardedVideoRequested.notifyObservers(t)}),Ei.onRewardedVideoStarted.add(t=>{e&&e.onRewardedVideoStarted.notifyObservers(t)}),Ei.onRewardedVideoFinished.add(t=>{this.isPlaying=!1,e&&e.onRewardedVideoFinished.notifyObservers(t)}),Ei.onRewardedVideoFailed.add(t=>{this.isPlaying=!1,e&&e.onRewardedVideoFailed.notifyObservers(t)}),Ei.onInterstitialAdRequested.add(t=>{e&&e.onInterstitialAdRequested.notifyObservers(t)}),Ei.onInterstitialAdOpened.add(t=>{e&&e.onInterstitialAdOpened.notifyObservers(t)}),Ei.onInterstitialAdClosed.add(t=>{e&&e.onInterstitialAdClosed.notifyObservers(t)}),Ei.onInterstitialAdFailed.add(t=>{e&&e.onInterstitialAdFailed.notifyObservers(t)})):console.warn("AdsService not allowed because there is no any SDK")}static playRewardedVideo(e){return Ie(this,null,function*(){if(this.isRewardedVideoAvailable())for(Ei.requestRewardedVideo({id:e}),yield Te(100);this.isPlaying;)yield Te(500)})}static showInterstetial(e){return Ie(this,null,function*(){this.isRewardedVideoAvailable()&&Ei.requestInterstitialAd({id:e})})}}X(Vn,"isPlaying",!1),X(Vn,"_inited",!1);Vn.init();function Mu(s){return tc.Effects[s]}function zf(s){return Mu(s).level}const iD=(s,e)=>zf(s.id)-zf(e.id),fv=({itemKey:s})=>{const e=ot(s);return M.createElement("img",{className:"inventory-item-icon",src:e,width:"64",height:"64"})};function nD(s,e){const t=s.playerItems.reduce((a,o)=>{if(o.item.key!=="iCoin")for(let l=0;l<o.item.count;l++)a.push(o.item.key);return a},[]);t.sort();const i=e.attributes.attInventoryTotalCapacity||0,n=t.slice(0,i);for(let a=n.length;a<i;a++)n.push(null);const r=s.coinsCount;return{maxCapacity:i,displayItems:n,coins:r}}const sD=1.5,rD=M.memo(({coins:s})=>{const e=ve.useRef(s),t=ve.useRef(null);return ve.useEffect(()=>{const i=Math.abs(e.current-s),n=Math.sign(s-e.current);let r=1;if(i>20?r=700:i>2&&(r=400),i<1){if(t.current==null)return;t.current.textContent=s+"";return}e.current=e.current+n;const a=LP(o=>{if(e.current=o,t.current==null)return!1;t.current.textContent=o+""},e.current,s,r);return()=>{a.dispose()}},[s]),M.createElement("div",{className:"inventory-coins"},M.createElement("img",{src:ot("iCoin"),alt:"coins"}),M.createElement("span",{ref:t}))}),aD=M.memo(()=>{const s=bt(),{refresh:e}=Yt(),t=s.playerEntity,[i,n]=ve.useState(!1);te("onInventoryUpdated",e),te("onAttributesChanged",e),te("onTaskUpdated",e),te("onTreeChopped",e),te("onPlayerAtService",e),te("onPlayerExitService",e);const{displayItems:r,coins:a,maxCapacity:o}=nD(s,t),l=v=>{const y=s.playerItems.find(L=>L.item.key===v&&L.item.count>0);if(y==null)return;const A=t.zone;if(!A)return;if(y.item.count--,s.villageMode==="war"){if(v==="iAleBarrel")s.playerEntity.attackSpeed=Math.max(.3,s.playerEntity.attackSpeed*.75),vt(s,ut.pickItem);else{const L={iWater:.03,iWheat:.05,iApple:.1,iBread:.2,iCorn:.25},V=s.playerEntity.maxHp||1;let Z=s.playerEntity.currentHp||1;const ne=L[v]||0;ne&&(Z=Math.min(V,Z+V*ne),s.playerEntity.currentHp=Z,s.bus.onHpUpdated.notifyObservers(s.playerEntity),vt(s,ut.pickItem))}s.bus.onInventoryUpdated.notifyObservers();return}s.bus.onItemDropped.notifyObservers({itemKey:v}),s.bus.onInventoryUpdated.notifyObservers(),vt(s,ut.dropItem);const I=t.transform.position,T=$.v3InCircle($.nextFloor(.9,1.2));T.addInPlace(I);const R=T.x,x=T.z,F=ac(s,A,v,1,R,x,!0,!0);s.addComponent(F,"willRemoveDelay",sD),Oe.addDesignEvent(`UI:Inventory:DropItem_${v}`,1)},c=s.playerEffects.filter(v=>v.effect.attr==="attInventoryCapacity"),h=t.attributes.attInventoryBaseCapacity+c.reduce((v,y)=>v+y.effect.value,0)-o,d=c.some(v=>v.enabled==null)&&c.some(v=>v.enabled!=null),f=Vn.isRewardedVideoAvailable()&&d,p=()=>Ie(void 0,null,function*(){if(!f)return;const v=c.find(A=>A.enabled==null);if(v==null)return;Oe.addDesignEvent("UI:BuySlotButton:Clicked",1);const y=s.bus.onRewardedVideoFinished.addOnce(A=>{A.id==="adsInventorySlot"&&(It(s,v),t.recalculateAttributes=!0)});try{yield Vn.playRewardedVideo("adsInventorySlot")}catch(A){console.error(A)}finally{s.bus.onRewardedVideoFinished.remove(y)}}),m=()=>{n(!0),Te(1500).then(()=>{t.attributes.attInventoryTotalCapacity++,t.recalculateAttributes=!0,n(!1)})};te("onSettingsChanged",e),te("onPurchased",v=>{if(v.entity.effect==null||v.entity.id==null)return;const y=v.entity?Mu(v.entity.id):null;y&&y.target==="pPlayer"&&y.attr==="attInventoryCapacity"&&m()});const _=s.statsEntity.gameStatistics.chopped>0&&t.playerInServiceBuilding==null,E=h>0?new Array(h).fill(null):null;return M.createElement(M.Fragment,null,M.createElement(rD,{coins:a}),_&&M.createElement("div",{className:"inventory"},M.createElement("div",{className:"inventory-items"},M.createElement("div",{className:"inventory-items__list"},r.map((v,y)=>M.createElement(oD,{itemKey:v,key:(v||"")+y,isDroppable:!1,onItemClicked:l})),d&&E&&E.map((v,y)=>{let A="";return y===0&&i&&(A+="play-unlock-anim"),M.createElement(lD,{key:y,onClicked:p,className:A})})))))}),oD=({itemKey:s,onItemClicked:e,isDroppable:t})=>M.createElement("div",{className:"inventory-items__item"+(t&&s!=null?" droppable":""),tabIndex:0,onClick:()=>{s!=null&&e(s)}},s!=null&&M.createElement(fv,{itemKey:s})),lD=({onClicked:s,className:e})=>{let t="inventory-items__item free-slot locked-slot";return e&&(t+=" "+e),M.createElement("div",{className:t,onClick:()=>s()},M.createElement("span",{className:"lock-icon"}),M.createElement(fv,{itemKey:"video"}))};var $s=(s=>(s[s.Enemy=0]="Enemy",s[s.Normal=1]="Normal",s[s.Critical=2]="Critical",s[s.Excellent=3]="Excellent",s))($s||{});const zl="globalMovementEffect",lg="globalProducingSpeedEffect",Pu="globalCoinsMultEffect",ws="globalManagerEffect",cD=""+new URL("icon_ring-bronze_LP-8c45fe81.png",import.meta.url).href,uD=""+new URL("icon_ring-silver_LP-ed1d1cb4.png",import.meta.url).href,hD=""+new URL("icon_ring-gold_LP-482a07fa.png",import.meta.url).href,ho=[{id:"prestige1",icon:cD,effects:[{attr:"attProducingSpeed",op:"mul",value:.1},{attr:"attMovementSpeed",op:"mul",value:.15},{attr:"attChoppingSpeed",op:"mul",value:.15}],reqGems:2},{id:"prestige2",icon:uD,effects:[{attr:"attProducingSpeed",op:"mul",value:.1}],reqGems:4},{id:"prestige3",icon:hD,effects:[{attr:"attProducingSpeed",op:"mul",value:.5,ownedBy:"pWell"}],reqGems:6}],dD=[zl,Pu,ws];function fD(s){const e=Math.max(Math.ceil(s),0),t=e%60,n=Math.floor(e/60).toString(),r=t.toString().padStart(2,"0");return n+":"+r}const pD=M.memo(()=>{const s=bt(),{refresh:e}=Yt();ve.useEffect(()=>{const r=setInterval(()=>e(),1e3);return()=>clearInterval(r)},[s,e]);const t=s.effectsQuery.entities.filter(r=>!r.prestigeEffect&&(dD.includes(r.id)||r.ownedBy===s.globalEffector.id&&!r.willRemoveDelay)),i=s.varsEntity.persistentVars.prestige,n=ve.useMemo(()=>ho.filter((r,a)=>a<i),[ho,i]);return M.createElement("div",{className:"player-effects"},n.map(r=>M.createElement("div",{key:r.id,className:"player-effect prestige"},M.createElement("img",{src:r.icon}))),t.map(r=>{const a=r.id===zl?"effectSpeed":r.id===Pu?"effectCoinsMult":r.id===ws?"effectManager":null;if(!a)return null;const o=ot(a),l=r.willRemoveDelay||0;return M.createElement("div",{key:r.id,className:"player-effect"},M.createElement("img",{src:o}),M.createElement("div",{className:"effect-duration"},fD(l)))}).filter(Boolean))});const mD={pPlayer:"Player",pWaterNpc:"Water carrier",pLogNpc:"Lumberjack",pAppleNpc:"Apples loader",pMillerNpc:"Miller",pPub:"Pub",pWinery:"Winery",pAppleGarden:"Apple Garden",pBaker:"Baker",pMill:"Mill",pWheatGarden:"Wheat Field",pWell:"Well",pSawmill:"Sawmill",pShip:"Ship",pWall:"Hunter","actions.close":"Close","actions.exit":"Exit",iCoin:"Coin","achievements-popup.title":"Achievements","upgrades-popup.title":"Upgrades","upgrades-popup.no-coins":"Not enough coins","prestige-popup.title":"Village ${lvl}","prestige-popup.notice":"You'll lose your progress in the next village. But you'll receive bonuses:","prestige-popup.next":"Next Village","prestige1.title":"Ring of Speed","prestige2.title":"Ring of Production","prestige3.title":"Ring of Water","prestige.desc":"${name} +${val}%",free:"FREE",max:"max.","tutorials.dragToMove.mobile":"Drag to move","tutorials.dragToMove.desktop":"Use arrows to move","tutorials.takeLogs":"Collect the wood","tutorials.goToSawmill":"Bring me the wood","tutorials.openUpgrades":"Upgrade your stack","tutorials.collectCoins":"Collect coins","tutorials.dropItem":"Drop the item to free up space","tutorials.wakeUp":"Wake up the worker","pause.sound":"Sound","pause.music":"Music","pause.lang":"Language","pause.title":"Settings",lvl:"lvl ${lvl}","offers.doubleIncome.title":"Double Income","offers.doubleIncome.duration":"2 mins","offers.speedBoost.title":"Speed Boost","offers.speedBoost.duration":"2 mins","part.Body":"Torse","part.Eyes":"Eyes","part.Pant":"Pants","part.Jacket":"T-Shirt","part.Hair":"Hair","part.Mustache":"Mustache",attInventoryCapacity:"Stack",attProducingSpeed:"Speed",attMovementSpeed:"Speed","attProducingSpeed.long":"Production speed","attMovementSpeed.long":"Movement speed","attChoppingSpeed.long":"Chopping speed","lang.ru":"Русский","lang.en":"English","lang.es":"Español","lang.fr":"Français","lang.it":"Italiano","lang.zh":"中文","lang.ja":"日本語","lang.ko":"한국어","lang.pt":"Português","lang.tr":"Türkçe","lang.hi":"हिन्दी","lang.vi":"Tiếng Việt"},_D={pPlayer:"Jugador",pWaterNpc:"Aguador",pLogNpc:"Leñador",pAppleNpc:"Asistente",pMillerNpc:"Molinero",pPub:"Pub",pWinery:"Bodega",pAppleGarden:"Manzanas",pBaker:"Panadero",pMill:"Molino",pWheatGarden:"Trigo",pWell:"Pozo",pSawmill:"Aserradero",pShip:"Barco",pWall:"Cazador","actions.close":"Cerca","actions.exit":"Salir",iCoin:"Moneda","achievements-popup.title":"Logros","upgrades-popup.title":"Mejoras","upgrades-popup.no-coins":"No hay suficientes monedas","prestige-popup.title":"Pueblo ${lvl}","prestige-popup.notice":"You'll lose your progress in the next village. But you'll receive bonuses:","prestige-popup.next":"Nuevo pueblo","prestige1.title":"Ring of Speed","prestige2.title":"Ring of Production","prestige3.title":"Ring of Water","prestige.desc":"${name} +${val}%",free:"GRATIS",max:"máximo","tutorials.dragToMove.mobile":"Arrastra para moverte","tutorials.dragToMove.desktop":"Usa las flechas para moverte","tutorials.takeLogs":"Recoger la madera","tutorials.goToSawmill":"Tráeme la madera","tutorials.openUpgrades":"Mejorar la capacidad","tutorials.collectCoins":"Recoger monedas","tutorials.dropItem":"Suelta el objeto para liberar espacio","tutorials.wakeUp":"Despierta al trabajador","pause.sound":"Sonido","pause.music":"Música","pause.lang":"Lengua","pause.title":"Configuración",lvl:"nivel ${lvl}","offers.doubleIncome.title":"Doble Ingreso","offers.doubleIncome.duration":"2 minutos","offers.speedBoost.title":"Aumento de Velocidad","offers.speedBoost.duration":"2 minutos","part.Body":"Torso","part.Eyes":"Ojos","part.Pant":"Pantalones","part.Jacket":"Chaqueta","part.Hair":"Pelo","part.Mustache":"Bigote",attInventoryCapacity:"Capacidad",attProducingSpeed:"Velocidad",attMovementSpeed:"Velocidad","attProducingSpeed.long":"Production speed","attMovementSpeed.long":"Movement speed","attChoppingSpeed.long":"Chopping speed","lang.ru":"Русский","lang.en":"English","lang.es":"Español","lang.fr":"Français","lang.it":"Italiano","lang.zh":"中文","lang.ja":"日本語","lang.ko":"한국어","lang.pt":"Português","lang.tr":"Türkçe","lang.hi":"हिन्दी","lang.vi":"Tiếng Việt"},gD={pPlayer:"Joueur",pWaterNpc:"Aquifère",pLogNpc:"Bûcheron",pAppleNpc:"Assistant",pMillerNpc:"Meunier",pPub:"Pub",pWinery:"Vignoble",pAppleGarden:"Pommes",pBaker:"Boulanger",pMill:"Moulin",pWheatGarden:"Blé",pWell:"Puits",pSawmill:"Scierie",pShip:"Navire",pWall:"Chasseur","actions.close":"Fermer","actions.exit":"Sortir",iCoin:"Pièce","achievements-popup.title":"Réalisations","upgrades-popup.title":"Améliorations","upgrades-popup.no-coins":"Pas assez de pièces","prestige-popup.title":"Village ${lvl}","prestige-popup.notice":"You'll lose your progress in the next village. But you'll receive bonuses:","prestige-popup.next":"Next Village","prestige1.title":"Ring of Speed","prestige2.title":"Ring of Production","prestige3.title":"Ring of Water","prestige.desc":"${name} +${val}%",free:"GRATUIT",max:"max","tutorials.dragToMove.mobile":"Faites glisser pour vous déplacer","tutorials.dragToMove.desktop":"Utilisez les flèches pour vous déplacer","tutorials.takeLogs":"Collecter le bois","tutorials.goToSawmill":"Apporter le bois","tutorials.openUpgrades":"Améliorer les capacités","tutorials.collectCoins":"Collecter les pièces","tutorials.dropItem":"Jeter la chose pour faire de la place","tutorials.wakeUp":"Réveiller le travailleur","pause.sound":"Son","pause.music":"Musique","pause.lang":"Langue","pause.title":"Paramètres",lvl:"niveau ${lvl}","offers.doubleIncome.title":"Double Revenu","offers.doubleIncome.duration":"2 minutes","offers.speedBoost.title":"Vitesse Accrue","offers.speedBoost.duration":"2 minutes","part.Body":"Torse","part.Eyes":"Yeux","part.Pant":"Pantalon","part.Jacket":"Maillot","part.Hair":"Cheveux","part.Mustache":"Barbe",attInventoryCapacity:"Capacité",attProducingSpeed:"Vitesse",attMovementSpeed:"Vitesse","attProducingSpeed.long":"Production speed","attMovementSpeed.long":"Movement speed","attPickCoinsMultiplier.long":"Income","attChoppingSpeed.long":"Chopping speed","lang.ru":"Русский","lang.en":"English","lang.es":"Español","lang.fr":"Français","lang.it":"Italiano","lang.zh":"中文","lang.ja":"日本語","lang.ko":"한국어","lang.pt":"Português","lang.tr":"Türkçe","lang.hi":"हिन्दी","lang.vi":"Tiếng Việt"},ED={pPlayer:"खिलाड़ी",pWaterNpc:"पौधों को पानी",pLogNpc:"लकड़हारा",pAppleNpc:"सहायक",pMillerNpc:"चक्कीवाला",pPub:"पब",pWinery:"वाइनरी",pAppleGarden:"सेब का बगीचा",pBaker:"बेकर",pMill:"चक्की",pWheatGarden:"गेहूं के खेत",pWell:"पानी",pSawmill:"आरा मशीन",pShip:"जहाज",pWall:"शिकारी","actions.close":"ढकना","actions.exit":"ढकना",iCoin:"सिक्का","achievements-popup.title":"उपलब्धियों","upgrades-popup.title":"सुधार","upgrades-popup.no-coins":"पर्याप्त सिक्के नहीं है","prestige-popup.title":"Village ${lvl}","prestige-popup.notice":"You'll lose your progress in the next village. But you'll receive bonuses:","prestige-popup.next":"Next Village","prestige1.title":"Ring of Speed","prestige2.title":"Ring of Production","prestige3.title":"Ring of Water","prestige.desc":"${name} +${val}%",free:"मुक्त",max:"अधिकतम","tutorials.dragToMove.mobile":"ले जाने के लिए ड्रैग करें","tutorials.dragToMove.desktop":"स्थानांतरित करने के लिए तीरों का उपयोग करें","tutorials.takeLogs":"लकड़ी इकट्ठा करो","tutorials.goToSawmill":"जलाऊ लकड़ी लाओ","tutorials.openUpgrades":"सुधार करना","tutorials.collectCoins":"सिक्के एकत्र करें","tutorials.dropItem":"जगह बनाने के लिए चीजें गिराए","tutorials.wakeUp":"कार्यकर्ता को जगाओ","pause.sound":"आवाज़","pause.music":"संगीत","pause.lang":"भाषा","pause.title":"सेटिंग",lvl:"लेवल ${lvl}","offers.doubleIncome.title":"दोगुनी आय","offers.doubleIncome.duration":"2 मिनट","offers.speedBoost.title":"गति वृद्धि","offers.speedBoost.duration":"2 मिनट","part.Body":"धड़","part.Eyes":"आँखें","part.Pant":"पैजामा","part.Jacket":"टी शर्ट","part.Hair":"बाल","part.Mustache":"मूंछ",attInventoryCapacity:"आयतन",attProducingSpeed:"स्पीड",attMovementSpeed:"स्पीड","attProducingSpeed.long":"Production speed","attMovementSpeed.long":"Movement speed","attChoppingSpeed.long":"Chopping speed","lang.ru":"Русский","lang.en":"English","lang.es":"Español","lang.fr":"Français","lang.it":"Italiano","lang.zh":"中文","lang.ja":"日本語","lang.ko":"한국어","lang.pt":"Português","lang.tr":"Türkçe","lang.hi":"हिन्दी","lang.vi":"Tiếng Việt"},vD={pPlayer:"Giocatore",pWaterNpc:"Portatore d'acqua",pLogNpc:"Taglialegna",pAppleNpc:"Assistente",pMillerNpc:"Mugnaio",pPub:"Pub",pWinery:"Cantina",pAppleGarden:"Mele",pBaker:"Fornaio",pMill:"Mulino",pWheatGarden:"Grano",pWell:"Pozzo",pSawmill:"Segheria",pShip:"Nave",pWall:"Cacciatore","actions.close":"Chiudi","actions.exit":"Esci",iCoin:"Moneta","achievements-popup.title":"Risultati","upgrades-popup.title":"Potenziamenti","upgrades-popup.no-coins":"Non abbastanza monete","prestige-popup.title":"Village ${lvl}","prestige-popup.notice":"You'll lose your progress in the next village. But you'll receive bonuses:","prestige-popup.next":"Next Village","prestige1.title":"Ring of Speed","prestige2.title":"Ring of Production","prestige3.title":"Ring of Water","prestige.desc":"${name} +${val}%",free:"GRATIS",max:"massimo","tutorials.dragToMove.mobile":"Trascinare per spostarsi","tutorials.dragToMove.desktop":"Usare i tasti per spostarsi","tutorials.takeLogs":"Raccogliere il legno","tutorials.goToSawmill":"Portate la legna","tutorials.openUpgrades":"Migliorare la capacità","tutorials.collectCoins":"Raccogliere le monete","tutorials.dropItem":"Gettare via l'oggetto per fare spazio","tutorials.wakeUp":"Svegliare il lavoratore","pause.sound":"Suono","pause.music":"Musica","pause.lang":"Lingua","pause.title":"Impostazioni",lvl:"livello ${lvl}","offers.doubleIncome.title":"Doppio reddito","offers.doubleIncome.duration":"2 minuti","offers.speedBoost.title":"Bonus di velocità","offers.speedBoost.duration":"2 minuti","part.Body":"Torace","part.Eyes":"Occhi","part.Pant":"Pantaloni","part.Jacket":"Maglietta","part.Hair":"Capelli","part.Mustache":"Barba",attInventoryCapacity:"Capacità",attProducingSpeed:"Velocità",attMovementSpeed:"Velocità","attProducingSpeed.long":"Production speed","attMovementSpeed.long":"Movement speed","attChoppingSpeed.long":"Chopping speed","lang.ru":"Русский","lang.en":"English","lang.es":"Español","lang.fr":"Français","lang.it":"Italiano","lang.zh":"中文","lang.ja":"日本語","lang.ko":"한국어","lang.pt":"Português","lang.tr":"Türkçe","lang.hi":"हिन्दी","lang.vi":"Tiếng Việt"},yD={pPlayer:"選手",pWaterNpc:"水運び",pLogNpc:"木こり",pAppleNpc:"リンゴ積み",pMillerNpc:"ミラー",pPub:"パブ",pWinery:"ワイナリー",pAppleGarden:"リンゴ園",pBaker:"ベーカー",pMill:"ミル",pWheatGarden:"小麦畑",pWell:"井戸",pSawmill:"製材所",pShip:"船",pWall:"ハンター","actions.close":"閉じる","actions.exit":"出口",iCoin:"コイン","achievements-popup.title":"実績","upgrades-popup.title":"改善","upgrades-popup.no-coins":"コインが足りない","prestige-popup.title":"Village ${lvl}","prestige-popup.notice":"You'll lose your progress in the next village. But you'll receive bonuses:","prestige-popup.next":"Next Village","prestige1.title":"Ring of Speed","prestige2.title":"Ring of Production","prestige3.title":"Ring of Water","prestige.desc":"${name} +${val}%",free:"無料",max:"最大","tutorials.dragToMove.mobile":"ドラッグで移動","tutorials.dragToMove.desktop":"矢印で移動","tutorials.takeLogs":"ログを取る","tutorials.goToSawmill":"丸太を持ってきてくれ。","tutorials.openUpgrades":"能力の向上","tutorials.collectCoins":"コインを集める","tutorials.dropItem":"アイテムをドロップしてスペースを空ける","tutorials.wakeUp":"労働者を目覚めさせる","pause.sound":"サウンド","pause.music":"音楽","pause.lang":"言語","pause.title":"設定",lvl:"水準 ${lvl}","offers.doubleIncome.title":"ダブルインカム","offers.doubleIncome.duration":"2分","offers.speedBoost.title":"加速","offers.speedBoost.duration":"2分","part.Body":"胴体","part.Eyes":"アイズ","part.Pant":"ズボン","part.Jacket":"ジャージ","part.Hair":"ヘアー","part.Mustache":"口ひげ",attInventoryCapacity:"容量",attProducingSpeed:"速度",attMovementSpeed:"速度","attProducingSpeed.long":"Production speed","attMovementSpeed.long":"Movement speed","attChoppingSpeed.long":"Chopping speed","lang.ru":"Русский","lang.en":"English","lang.es":"Español","lang.fr":"Français","lang.it":"Italiano","lang.zh":"中文","lang.ja":"日本語","lang.ko":"한국어","lang.pt":"Português","lang.tr":"Türkçe","lang.hi":"हिन्दी","lang.vi":"Tiếng Việt"},AD={pPlayer:"플레이어",pWaterNpc:"물 운반선",pLogNpc:"나무꾼",pAppleNpc:"사과 로더",pMillerNpc:"밀러",pPub:"술집",pWinery:"와이너리",pAppleGarden:"사과 정원",pBaker:"빵 굽는 사람",pMill:"밀",pWheatGarden:"밀밭",pWell:"우물",pSawmill:"제재소",pShip:"배",pWall:"사냥꾼","actions.close":"닫기","actions.exit":"출구",iCoin:"코인","achievements-popup.title":"업적","upgrades-popup.title":"업그레이드","upgrades-popup.no-coins":"코인이 부족합니다.","prestige-popup.title":"Village ${lvl}","prestige-popup.notice":"You'll lose your progress in the next village. But you'll receive bonuses:","prestige-popup.next":"Next Village","prestige1.title":"Ring of Speed","prestige2.title":"Ring of Production","prestige3.title":"Ring of Water","prestige.desc":"${name} +${val}%",free:"무료",max:"최대","tutorials.dragToMove.mobile":"드래그하여 이동","tutorials.dragToMove.desktop":"화살표를 사용하여 이동","tutorials.takeLogs":"나무 가져가기","tutorials.goToSawmill":"나무 가져오기","tutorials.openUpgrades":"용량 증가","tutorials.collectCoins":"동전 모으기","tutorials.dropItem":"아이템을 떨어뜨려 공간 확보하기","tutorials.wakeUp":"일꾼 깨우기","pause.sound":"소리","pause.music":"음악","pause.lang":"언어","pause.title":"설정",lvl:"레벨 ${lvl}","offers.doubleIncome.title":"이중 수입","offers.doubleIncome.duration":"2분","offers.speedBoost.title":"속도 부스트","offers.speedBoost.duration":"2분","part.Body":"Torse","part.Eyes":"눈","part.Pant":"바지","part.Jacket":"티셔츠","part.Hair":"머리","part.Mustache":"콧수염",attInventoryCapacity:"용량",attProducingSpeed:"속도",attMovementSpeed:"속도","attProducingSpeed.long":"Production speed","attMovementSpeed.long":"Movement speed","attChoppingSpeed.long":"Chopping speed","lang.ru":"Русский","lang.en":"English","lang.es":"Español","lang.fr":"Français","lang.it":"Italiano","lang.zh":"中文","lang.ja":"日本語","lang.ko":"한국어","lang.pt":"Português","lang.tr":"Türkçe","lang.hi":"हिन्दी","lang.vi":"Tiếng Việt"},TD={pPlayer:"Jogador",pWaterNpc:"Portador de água",pLogNpc:"Lenhador",pAppleNpc:"Assistente",pMillerNpc:"Moleiro",pPub:"Bar",pWinery:"Adega",pAppleGarden:"Maçãs",pBaker:"Padeiro",pMill:"Moinho",pWheatGarden:"Campo de trigo",pWell:"Bem",pSawmill:"Serraria",pShip:"Navio",pWall:"Caçador","actions.close":"Fechar","actions.exit":"Saída",iCoin:"Moeda","achievements-popup.title":"Conquistas","upgrades-popup.title":"Atualizações","upgrades-popup.no-coins":"Não há moedas suficientes","prestige-popup.title":"Village ${lvl}","prestige-popup.notice":"You'll lose your progress in the next village. But you'll receive bonuses:","prestige-popup.next":"Next Village","prestige1.title":"Ring of Speed","prestige2.title":"Ring of Production","prestige3.title":"Ring of Water","prestige.desc":"${name} +${val}%",free:"GRÁTIS",max:"máximo","tutorials.dragToMove.mobile":"Arraste para mover","tutorials.dragToMove.desktop":"Use as setas para se mover","tutorials.takeLogs":"Pegue a madeira","tutorials.goToSawmill":"Traga-me madeira","tutorials.openUpgrades":"Aprimore sua pilha","tutorials.collectCoins":"Colete moedas","tutorials.dropItem":"Solte o item para liberar espaço","tutorials.wakeUp":"Acorde o trabalhador","pause.sound":"Som","pause.music":"Música","pause.lang":"Língua","pause.title":"Configurações",lvl:"nível ${lvl}","offers.doubleIncome.title":"Renda dupla","offers.doubleIncome.duration":"2 minutos","offers.speedBoost.title":"Aumento de velocidade","offers.speedBoost.duration":"2 minutos","part.Body":"Torso","part.Eyes":"Olhos","part.Pant":"Calças","part.Jacket":"Camiseta","part.Hair":"Cabelo","part.Mustache":"Bigode",attInventoryCapacity:"Capacidad",attProducingSpeed:"Velocidade",attMovementSpeed:"Velocidade","attProducingSpeed.long":"Production speed","attMovementSpeed.long":"Movement speed","attChoppingSpeed.long":"Chopping speed","lang.ru":"Русский","lang.en":"English","lang.es":"Español","lang.fr":"Français","lang.it":"Italiano","lang.zh":"中文","lang.ja":"日本語","lang.ko":"한국어","lang.pt":"Português","lang.tr":"Türkçe","lang.hi":"हिन्दी","lang.vi":"Tiếng Việt"},SD={pPlayer:"Игрок",pWaterNpc:"Водонос",pLogNpc:"Дровосек",pAppleNpc:"Помощник",pMillerNpc:"Мельник",pPub:"Паб",pWinery:"Винодельня",pAppleGarden:"Яблоневый сад",pBaker:"Пекарь",pMill:"Мельница",pWheatGarden:"Пшеница",pWell:"Колодец",pSawmill:"Лесопилка",pShip:"Корабль",pWall:"Охотник","actions.close":"Закрыть","actions.exit":"Выйти",iCoin:"Монета","achievements-popup.title":"Достижения","upgrades-popup.title":"Улучшения","upgrades-popup.no-coins":"Недостаточно монет","prestige-popup.title":"Деревня ${lvl}","prestige-popup.notice":"Игровой прогресс будет сброшен в новой деревне. Получаемые бонусы:","prestige-popup.next":"Новая деревня","prestige1.title":"Кольцо Скорости","prestige2.title":"Кольцо Производства","prestige3.title":"Кольцо Воды","prestige.desc":"${name} +${val}%",free:"ДАРОМ",max:"макс.","tutorials.dragToMove.mobile":"Удерживай для передвижения","tutorials.dragToMove.desktop":"Нажимай стрелки для передвижения","tutorials.takeLogs":"Собери брёвна","tutorials.goToSawmill":"Принеси мне брёвна","tutorials.openUpgrades":"Увеличь вместительность","tutorials.collectCoins":"Собери монеты","tutorials.dropItem":"Выброси вещь чтобы освободить место","tutorials.wakeUp":"Разбуди рабочего","pause.sound":"Звуки","pause.music":"Музыка","pause.lang":"Язык","pause.title":"Настройки",lvl:"ур. ${lvl}","offers.doubleIncome.title":"Двойной Доход","offers.doubleIncome.duration":"2 мин","offers.speedBoost.title":"Ускоритель","offers.speedBoost.duration":"2 мин","part.Body":"Тело","part.Eyes":"Глаза","part.Pant":"Штаны","part.Jacket":"Рубаха","part.Hair":"Причёска","part.Mustache":"Борода",attInventoryCapacity:"Вместительность",attProducingSpeed:"Скорость",attMovementSpeed:"Скорость","attProducingSpeed.long":"Скорость производства","attMovementSpeed.long":"Скорость перемещения","attChoppingSpeed.long":"Скорость рубки","lang.ru":"Русский","lang.en":"English","lang.es":"Español","lang.fr":"Français","lang.it":"Italiano","lang.zh":"中文","lang.ja":"日本語","lang.ko":"한국어","lang.pt":"Português","lang.tr":"Türkçe","lang.hi":"हिन्दी","lang.vi":"Tiếng Việt"},CD={pPlayer:"Oyuncu",pWaterNpc:"Su taşıyıcı",pLogNpc:"Oduncu",pAppleNpc:"Asistan",pMillerNpc:"Değirmenci",pPub:"çubuk",pWinery:"Şaraphane",pAppleGarden:"Elma bahçesi",pBaker:"Fırıncı",pMill:"Değirmen",pWheatGarden:"Buğday tarlası",pWell:"Peki",pSawmill:"Kereste Fabrikası",pShip:"Gemi",pWall:"Avcı","actions.close":"Kapat","actions.exit":"Çıkış",iCoin:"Madeni Para","achievements-popup.title":"Başarılar","upgrades-popup.title":"Yükseltmeler","upgrades-popup.no-coins":"Yeterli para yok","prestige-popup.title":"Village ${lvl}","prestige-popup.notice":"You'll lose your progress in the next village. But you'll receive bonuses:","prestige-popup.next":"Next Village","prestige1.title":"Ring of Speed","prestige2.title":"Ring of Production","prestige3.title":"Ring of Water","prestige.desc":"${name} +${val}%",free:"ÜCRETSİZ",max:"maks.","tutorials.dragToMove.mobile":"Taşımak için sürükleyin","tutorials.dragToMove.desktop":"Hareket etmek için okları kullanın","tutorials.takeLogs":"Odun toplamak","tutorials.goToSawmill":"Bana bir ağaç getir","tutorials.openUpgrades":"Bir gelişme yapmak","tutorials.collectCoins":"Madeni para topla","tutorials.dropItem":"Yer açmak için öğeyi bırakın","tutorials.wakeUp":"İşçiyi uyandırın","pause.sound":"Ses","pause.music":"Müzik","pause.lang":"Dil","pause.title":"Ayarlar",lvl:"seviye ${lvl}","offers.doubleIncome.title":"Çifte Gelir","offers.doubleIncome.duration":"2 dakika","offers.speedBoost.title":"Hız Artışı","offers.speedBoost.duration":"2 dakika","part.Body":"Torse","part.Eyes":"Gözler","part.Pant":"Pantolon","part.Jacket":"Tişört","part.Hair":"Saç","part.Mustache":"Bıyık",attInventoryCapacity:"hacmi",attProducingSpeed:"Hız",attMovementSpeed:"Hız","attProducingSpeed.long":"Production speed","attMovementSpeed.long":"Movement speed","attChoppingSpeed.long":"Chopping speed","lang.ru":"Русский","lang.en":"English","lang.es":"Español","lang.fr":"Français","lang.it":"Italiano","lang.zh":"中文","lang.ja":"日本語","lang.ko":"한국어","lang.pt":"Português","lang.tr":"Türkçe","lang.hi":"हिन्दी","lang.vi":"Tiếng Việt"},ID={pPlayer:"Người chơi",pWaterNpc:"Người gánh nước",pLogNpc:"Tiều phu",pAppleNpc:"Trợ lý",pMillerNpc:"cối xay",pPub:"quán rượu",pWinery:"Nhà máy rượu",pAppleGarden:"vườn táo",pBaker:"thợ làm bánh",pMill:"cối xay",pWheatGarden:"cánh đồng lúa mì",pWell:"Nước",pSawmill:"xưởng cưa",pShip:"tàu thủy",pWall:"thợ săn","actions.close":"đóng","actions.exit":"đóng",iCoin:"đồng tiền","achievements-popup.title":"Thành tựu","upgrades-popup.title":"sự cải tiến","upgrades-popup.no-coins":"Không đủ xu","prestige-popup.title":"Village ${lvl}","prestige-popup.notice":"You'll lose your progress in the next village. But you'll receive bonuses:","prestige-popup.next":"Next Village","prestige1.title":"Ring of Speed","prestige2.title":"Ring of Production","prestige3.title":"Ring of Water","prestige.desc":"${name} +${val}%",free:"MIỄN PHÍ",max:"Tối đa","tutorials.dragToMove.mobile":"Kéo để di chuyển","tutorials.dragToMove.desktop":"Sử dụng mũi tên để di chuyển","tutorials.takeLogs":"lấy gỗ","tutorials.goToSawmill":"Mang cho tôi gỗ","tutorials.openUpgrades":"Cải thiện","tutorials.collectCoins":"Sưu tầm tiền xu","tutorials.dropItem":"Thả mục để giải phóng dung lượng","tutorials.wakeUp":"Thức dậy công nhân","pause.sound":"Âm thanh","pause.music":"Âm nhạc","pause.lang":"Ngôn ngữ","pause.title":"Cài đặt",lvl:"cấp độ ${lvl}","offers.doubleIncome.title":"Thu nhập gấp đôi","offers.doubleIncome.duration":"2 phút","offers.speedBoost.title":"Tăng tốc","offers.speedBoost.duration":"2 phút","part.Body":"thân hình","part.Eyes":"Mắt","part.Pant":"quần","part.Jacket":"Áo thun","part.Hair":"kiểu tóc","part.Mustache":"ria",attInventoryCapacity:"âm lượng",attProducingSpeed:"tốc độ",attMovementSpeed:"tốc độ","attProducingSpeed.long":"Production speed","attMovementSpeed.long":"Movement speed","attChoppingSpeed.long":"Chopping speed","lang.ru":"Русский","lang.en":"English","lang.es":"Español","lang.fr":"Français","lang.it":"Italiano","lang.zh":"中文","lang.ja":"日本語","lang.ko":"한국어","lang.pt":"Português","lang.tr":"Türkçe","lang.hi":"हिन्दी","lang.vi":"Tiếng Việt"},RD={pPlayer:"球员",pWaterNpc:"运水车",pLogNpc:"伐木工",pAppleNpc:"苹果装载者",pMillerNpc:"米勒",pPub:"酒吧",pWinery:"酿酒厂",pAppleGarden:"苹果园",pBaker:"面包师",pMill:"磨坊",pWheatGarden:"麦田",pWell:"水井",pSawmill:"锯木厂",pShip:"船",pWall:"猎人","actions.close":"关闭","actions.exit":"退出",iCoin:"硬币","achievements-popup.title":"成就","upgrades-popup.title":"升级","upgrades-popup.no-coins":"金币不够","prestige-popup.title":"Village ${lvl}","prestige-popup.notice":"You'll lose your progress in the next village. But you'll receive bonuses:","prestige-popup.next":"Next Village","prestige1.title":"Ring of Speed","prestige2.title":"Ring of Production","prestige3.title":"Ring of Water","prestige.desc":"${name} +${val}%",free:"免费",max:"最大值","tutorials.dragToMove.mobile":"拖动移动","tutorials.dragToMove.desktop":"使用箭头移动","tutorials.takeLogs":"给我收集木头","tutorials.goToSawmill":"给我拿木头来","tutorials.openUpgrades":"升级你的堆栈","tutorials.collectCoins":"收集金币","tutorials.dropItem":"丢弃物品，释放空间","tutorials.wakeUp":"唤醒工人","pause.sound":"声音","pause.music":"音乐","pause.lang":"语言","pause.title":"设置",lvl:"级别 ${lvl}","offers.doubleIncome.title":"双倍收入","offers.doubleIncome.duration":"2 分钟","offers.speedBoost.title":"速度提升","offers.speedBoost.duration":"2 分钟","part.Body":"托尔斯","part.Eyes":"眼睛","part.Pant":"裤子","part.Jacket":"T恤","part.Hair":"头发","part.Mustache":"胡子",attInventoryCapacity:"堆栈",attProducingSpeed:"速度",attMovementSpeed:"速度","attProducingSpeed.long":"Production speed","attMovementSpeed.long":"Movement speed","attChoppingSpeed.long":"Chopping speed","lang.ru":"Русский","lang.en":"English","lang.es":"Español","lang.fr":"Français","lang.it":"Italiano","lang.zh":"中文","lang.ja":"日本語","lang.ko":"한국어","lang.pt":"Português","lang.tr":"Türkçe","lang.hi":"हिन्दी","lang.vi":"Tiếng Việt"},pv={en:mD,es:_D,pt:TD,hi:ED,vi:ID,zh:RD,tr:CD,ja:yD,ko:AD,fr:gD,it:vD,ru:SD},mv=Object.keys(pv),bD=pv,Hf="en";function xD(){const s=navigator.language||navigator.userLanguage;if(s){let e=s;if(s.length>2&&(e=s[0]+s[1]),e&&(e=e.toLowerCase()),mv.includes(e))return e}return Hf}let _v=xD();function gv(s){_v=s}const Ev=()=>_v,Jh={},qe=(s,e=Jh,t=Ev())=>{let i=Jh;typeof e=="string"?t=e:Object.keys(e).length>0&&(i=e);const n=bD[t];if(!n)return s;let r=n[s];if(r===void 0)return t!==Hf?qe(s,e,Hf):s;if(i===Jh)return r;const a=/\$\{(\w+)\}/,o=r.match(new RegExp(a,"gm"));if(!o)return r;for(const l of o){const c=l.match(a)[1];if(i[c]===void 0)throw new Error(`Key ${c} not found in params`);r=r.replace(l,i[c])}return r};const MD=""+new URL("SM_Icon_X_01-87c497f1.png",import.meta.url).href,hh=M.memo(({title:s,popupClassName:e,defaultVisible:t,openButtonName:i,closeButtonName:n,withAds:r,children:a,footer:o,onClose:l})=>{const c=bt(),{refresh:u}=Yt(),[h,d]=ve.useState(!!t);te("onSettingsChanged",u),te("onVarChanged",u),te("onButtonClicked",m=>{m.btn===i&&(d(!0),Vf(c),Oe.addDesignEvent(`UI:${i}Popup:Opened`,1))});const f=()=>{Jo(c),d(!1),c.bus.onButtonClicked.notifyObservers({btn:n}),vt(c,ut.click),Oe.addDesignEvent(`UI:${i}Popup:Closed`,1),r&&Vn.showInterstetial("on"+n+"Ad"),l&&l()};if(zE(()=>{h&&f()}),!h)return null;let p="base-popup";return e&&(p+=" "+e),M.createElement("div",{className:p},M.createElement("div",{className:"popup-bg",onClick:f}),M.createElement("div",{className:"popup-body"},M.createElement("h3",null,s),M.createElement("button",{className:"close-btn",onClick:f},M.createElement("img",{alt:qe("actions.close"),src:MD})),a),o)}),PD=M.memo(()=>M.createElement("svg",{fill:"currentColor",strokeWidth:"0",viewBox:"0 0 640 512",stroke:"currentColor",focusable:"false"},M.createElement("path",{d:"M524.531,69.836a1.5,1.5,0,0,0-.764-.7A485.065,485.065,0,0,0,404.081,32.03a1.816,1.816,0,0,0-1.923.91,337.461,337.461,0,0,0-14.9,30.6,447.848,447.848,0,0,0-134.426,0,309.541,309.541,0,0,0-15.135-30.6,1.89,1.89,0,0,0-1.924-.91A483.689,483.689,0,0,0,116.085,69.137a1.712,1.712,0,0,0-.788.676C39.068,183.651,18.186,294.69,28.43,404.354a2.016,2.016,0,0,0,.765,1.375A487.666,487.666,0,0,0,176.02,479.918a1.9,1.9,0,0,0,2.063-.676A348.2,348.2,0,0,0,208.12,430.4a1.86,1.86,0,0,0-1.019-2.588,321.173,321.173,0,0,1-45.868-21.853,1.885,1.885,0,0,1-.185-3.126c3.082-2.309,6.166-4.711,9.109-7.137a1.819,1.819,0,0,1,1.9-.256c96.229,43.917,200.41,43.917,295.5,0a1.812,1.812,0,0,1,1.924.233c2.944,2.426,6.027,4.851,9.132,7.16a1.884,1.884,0,0,1-.162,3.126,301.407,301.407,0,0,1-45.89,21.83,1.875,1.875,0,0,0-1,2.611,391.055,391.055,0,0,0,30.014,48.815,1.864,1.864,0,0,0,2.063.7A486.048,486.048,0,0,0,610.7,405.729a1.882,1.882,0,0,0,.765-1.352C623.729,277.594,590.933,167.465,524.531,69.836ZM222.491,337.58c-28.972,0-52.844-26.587-52.844-59.239S193.056,219.1,222.491,219.1c29.665,0,53.306,26.82,52.843,59.239C275.334,310.993,251.924,337.58,222.491,337.58Zm195.38,0c-28.971,0-52.843-26.587-52.843-59.239S388.437,219.1,417.871,219.1c29.667,0,53.307,26.82,52.844,59.239C470.715,310.993,447.538,337.58,417.871,337.58Z"}))),DD=M.memo(()=>{const s=bt(),{refresh:e}=Yt();return te("onSettingsChanged",e),M.createElement(hh,{title:qe("pause.title"),popupClassName:"pause-popup",openButtonName:"pause",closeButtonName:"closePause"},M.createElement("label",null,qe("pause.music"),M.createElement("input",{type:"checkbox",defaultChecked:s.settingsEntity.settings.music,onChange:t=>{s.settingsEntity.settings.music=t.currentTarget.checked,vt(s,ut.click),s.bus.onSettingsChanged.notifyObservers(s.settingsEntity)}})),M.createElement("label",null,qe("pause.sound"),M.createElement("input",{type:"checkbox",defaultChecked:s.settingsEntity.settings.sound,onChange:t=>{s.settingsEntity.settings.sound=t.currentTarget.checked,vt(s,ut.click),s.bus.onSettingsChanged.notifyObservers(s.settingsEntity)}})),M.createElement("label",null,qe("pause.lang"),M.createElement("select",{value:Ev(),onChange:t=>{s.settingsEntity.settings.locale=t.currentTarget.value,gv(t.currentTarget.value),s.bus.onSettingsChanged.notifyObservers(s.settingsEntity)}},mv.map(t=>M.createElement("option",{key:t,value:t},qe("lang."+t))))),M.createElement("div",{className:"links"},M.createElement("a",{href:"https://discord.gg/PFJ228tD38",target:"_blank",rel:"noreferrer nofollow"},M.createElement(PD,null))),M.createElement("span",{id:"game-version"},"v:","0.18.2","prod"))});function OD(s,...e){return s.identifiableQuery.with(...e).entities[0]}const wD="translate(-10000px, -10000px)";function hr(s,e,t=0,i=0){const n=bt();ve.useEffect(()=>{let r=!1;const a=n.bus.onEntityScreenPositionUpdated.add(({id:o,screenPosition:l})=>{if(o!==s)return;const c=e.current;if(c==null)return;if(l.lengthSquared()<.1){r||(c.style.transform=wD,r=!0);return}r=!1;const u=Math.floor(l.x+t),h=Math.floor(l.y+i);c.style.transform=`translate(${u}px, ${h}px)`});return()=>{n.bus.onEntityScreenPositionUpdated.remove(a)}},[n,s])}const FD=M.memo(()=>{const s=bt(),{refresh:e}=Yt(),t=OD(s,"ads","willRemoveDelay");te("onAdOffered",e),te("onAdExpired",e),te("onSettingsChanged",e);const i=()=>Ie(void 0,null,function*(){if(t==null||t.willRemoveDelay==null)return;vt(s,ut.click),s.removeComponent(t,"willRemoveDelay"),s.removeComponent(t,"onRemove"),yield Te(200);const r=t.adsCoins!=null,a=t.adsMovement!=null,o=t.adsCoinsMultiplier!=null,l=r?"adsCoinsOffer":a?"adsSpeedOffer":o?"adsCoinsMultiplier":"adsUnknownOffer",c=s.bus.onRewardedVideoFinished.addOnce(u=>{u.id===l&&t.onAdsFinished&&t.onAdsFinished()});try{yield Vn.playRewardedVideo(l)}catch(u){console.error(u)}finally{s.bus.onRewardedVideoFinished.remove(c),s.addComponent(t,"removing",!0),e()}});te("onActionButtonPressed",r=>{r.button==="actionBottom"&&i()});const n=()=>{if(t==null)return null;if(t.adsCoinsMultiplier!=null)return M.createElement("div",{className:"offer small"},M.createElement("div",null,M.createElement("img",{className:"offer-icon coins-mult-icon",src:ot("effectCoinsMult"),alt:"coins"}),M.createElement("span",{className:"double-income-val"},qe("offers.doubleIncome.title"))),M.createElement("span",{className:"duration-val"},qe("offers.doubleIncome.duration")));if(t.adsCoins!=null)return M.createElement("div",{className:"offer"},M.createElement("img",{className:"offer-icon coins-icon",src:ot("iCoin"),alt:"coins"}),M.createElement("span",{className:"coins-amount-val"},"+",t.adsCoins));if(t.adsMovement!=null)return M.createElement("div",{className:"offer small"},M.createElement("div",null,M.createElement("img",{className:"offer-icon effect-icon",src:ot("effectSpeed"),alt:"speed"}),M.createElement("span",{className:"speed-boost-val"},qe("offers.speedBoost.title"))),M.createElement("span",{className:"duration-val"},qe("offers.speedBoost.duration")))};return ve.useEffect(()=>{t!=null&&vt(s,ut.note)},[t]),t==null?null:M.createElement("div",{className:"ads-offer animate-in",onClick:i},M.createElement("div",{className:"stars"},M.createElement("span",{style:{animationDelay:"0.5s"}},"★"),M.createElement("span",{style:{animationDelay:"0.1s"}},"★"),M.createElement("span",{style:{animationDelay:"0.6s"}},"★"),M.createElement("span",{style:{animationDelay:"0.8s"}},"★"),M.createElement("span",{style:{animationDelay:"0.9s"}},"★")),n(),M.createElement("img",{className:"video-icon",src:ot("video"),alt:"reward ad"}))}),LD=""+new URL("icon_settings-f17fb4e0.png",import.meta.url).href,ND=""+new URL("icon_upgrade-dd7496bd.png",import.meta.url).href,dh=""+new URL("SM_Icon_Exclamation_01-f8da893a.png",import.meta.url).href;const BD=({title:s,effectEntity:e})=>{const t=bt(),i=e?Mu(e.id):null,n=e?zf(e.id):qe("max"),r=i!=null?i.price:null,a=()=>{if(!(r!=null&&t.coinsCount>=r)){t.bus.onNotEnoughCoins.notifyObservers({});return}if(!(e==null||i==null)){if(t.bus.onButtonClicked.notifyObservers({btn:"buyUpgrade"}),zP(t,r),Oe.addDesignEvent("UI:BuyUpgrade:"+e.id,1),It(t,e),i.attr==="attInventoryCapacity"){const c=GE.find(u=>{const h=Mu(u);if(h.attr==="attOutputCapacity"&&i.target===h.target&&i.level===h.level)return u});c&&It(t,t.effectsQuery.entities.find(u=>u.id===c))}vt(t,ut.click),t.bus.onPurchased.notifyObservers({entity:e}),t.bus.onInventoryUpdated.notifyObservers()}},o=r==null?!0:t.coinsCount>=r;return M.createElement("div",{className:"effect"},M.createElement("span",null,`${s}${String.fromCharCode(160)}${qe("lvl",{lvl:n.toString()})}`),r!=null&&e&&M.createElement("button",{className:"btn-upgrade"+(o?"":" disabled"),onClick:a},r>0?M.createElement(ve.Fragment,null,M.createElement("img",{src:ot("iCoin"),alt:qe("iCoin")}),r):M.createElement("span",null,qe("free"))))},kD=s=>qe(s),UD=({entityId:s,attrs:e})=>{const i=bt().effectsQuery.entities.filter(a=>a.ownedBy===s&&!a.prestigeEffect),n=e.map(a=>i.filter(o=>o.effect.attr===a));n.forEach(a=>{a.sort(iD)});const r=n.map(a=>a.find(o=>o.enabled==null));return M.createElement("div",{className:"buyable-effects"},r.map((a,o)=>{const l=e[o];if(!(n[o].length>0))return null;const u=kD(l);return M.createElement(BD,{key:l,title:u,effectEntity:a})}))},VD=["attMovementSpeed","attProducingSpeed","attInventoryCapacity"],cg=({entity:s})=>{const e=s.id!=="pPlayer"&&s.purchased==null;return M.createElement("div",{className:"item",key:s.id},M.createElement("span",null,e?"...":qe(s.id)),e&&M.createElement(M.Fragment,null,M.createElement("span",null),M.createElement("span",null)),!e&&M.createElement(UD,{entityId:s.id,attrs:VD}))},GD=M.memo(()=>{const s=bt(),{refresh:e}=Yt(),[t,i]=ve.useState(!1),n=Wx(),[r,a]=Hx(()=>{i(!1)},3e3);ve.useEffect(()=>{r()},[s]),te("onSettingsChanged",e),te("onPurchased",e),te("onInventoryUpdated",e),te("onVarChanged",e),te("onNotEnoughCoins",()=>Ie(void 0,null,function*(){r(),i(!1),e(),yield Te(0),!n.current&&(a(),i(!0))}));const o=s.identifiableQuery.with("npc","hireableNpc").entities,l=s.identifiableQuery.with("itemProducer").entities,c=s.upgradableProducers,u=[...o,...l].filter(h=>c.includes(h.id)).sort((h,d)=>{const f=c.indexOf(h.id),p=c.indexOf(d.id);return f<0?1:p<0?-1:f-p});return M.createElement(hh,{popupClassName:"upgrades-popup",title:qe("upgrades-popup.title"),openButtonName:"upgrades",closeButtonName:"closeUpgrades",withAds:!0,footer:t&&M.createElement("div",{className:"not-enough-coins"},M.createElement("p",null,qe("upgrades-popup.no-coins"))),onClose:()=>{r(),i(!1)}},M.createElement("div",{className:"items scrollable"},M.createElement(cg,{key:"pPlayer",entity:s.playerEntity}),u.map(h=>M.createElement(cg,{key:h.id,entity:h}))))});function zD(s){switch(s){case"pLogNpc":return ot("iLog");case"pWaterNpc":return ot("iWater");case"pMillerNpc":return ot("iWheat");case"pAppleNpc":return ot("iApple");case"pSawmillWorkerNpc":return ot("iPlank");case"pMillWorkerNpc":return ot("iFlour");case"pBakerWorkerNpc":return ot("iBread");case"pWineryWorkerNpc":return ot("iAleBarrel");case"pThiefNpc":return dh;case"pMinerNpc":return ot("iOre");case"pBlacksmithNpc":return ot("iIron");case"pFarmerNpc":return ot("iWool")}return null}const HD=M.memo(()=>{const s=bt(),{refresh:e}=Yt(),t=s.playerEntity,i=s.lvlManager;if(te("onNpcGoalChanged",e),te("onNpcTasksUpdated",e),te("onPlayerAtService",e),te("onPlayerExitService",e),te("onVillageModeChanged",e),te("onZoneLoaded",e),i==null)return null;const n=i.currentZone;if(!n||t.playerInServiceBuilding!=null)return null;const r=s.npcsWithTasksQuery.entities.filter(o=>o.zone===n&&(o.npcSleeping!=null||o.thief&&o.npcTasksList.length>0));return r.length===0||s.villageMode==="war"?null:M.createElement("div",{className:"attentions"},r.map(o=>{const l=zD(o.id),c=()=>{const u=o.transform.position;At(s,u)};return M.createElement("div",{key:o.id,className:"attention",onClick:c},M.createElement("img",{src:l||"",alt:"attention!"}),!o.thief&&M.createElement("img",{src:dh,alt:"!",className:"sign"}))}))});var Wf={exports:{}};(function(s,e){(function(t,i){var n="1.0.35",r="",a="?",o="function",l="undefined",c="object",u="string",h="major",d="model",f="name",p="type",m="vendor",_="version",E="architecture",v="console",y="mobile",A="tablet",I="smarttv",T="wearable",R="embedded",x=350,F="Amazon",L="Apple",V="ASUS",Z="BlackBerry",ne="Browser",ae="Chrome",Ue="Edge",Ve="Firefox",$e="Google",re="Huawei",ge="LG",be="Microsoft",ze="Motorola",Ke="Opera",Ut="Samsung",st="Sharp",Jt="Sony",Wt="Xiaomi",ii="Zebra",$i="Facebook",Ji="Chromium OS",en="Mac OS",vn=function(me,Mt){var tt={};for(var Kt in me)Mt[Kt]&&Mt[Kt].length%2===0?tt[Kt]=Mt[Kt].concat(me[Kt]):tt[Kt]=me[Kt];return tt},Ne=function(me){for(var Mt={},tt=0;tt<me.length;tt++)Mt[me[tt].toUpperCase()]=me[tt];return Mt},Xe=function(me,Mt){return typeof me===u?_i(Mt).indexOf(_i(me))!==-1:!1},_i=function(me){return me.toLowerCase()},yt=function(me){return typeof me===u?me.replace(/[^\d\.]/g,r).split(".")[0]:i},Ge=function(me,Mt){if(typeof me===u)return me=me.replace(/^\s\s*/,r),typeof Mt===l?me:me.substring(0,x)},yn=function(me,Mt){for(var tt=0,Kt,fr,ys,wt,Qe,As;tt<Mt.length&&!Qe;){var ph=Mt[tt],_m=Mt[tt+1];for(Kt=fr=0;Kt<ph.length&&!Qe&&ph[Kt];)if(Qe=ph[Kt++].exec(me),Qe)for(ys=0;ys<_m.length;ys++)As=Qe[++fr],wt=_m[ys],typeof wt===c&&wt.length>0?wt.length===2?typeof wt[1]==o?this[wt[0]]=wt[1].call(this,As):this[wt[0]]=wt[1]:wt.length===3?typeof wt[1]===o&&!(wt[1].exec&&wt[1].test)?this[wt[0]]=As?wt[1].call(this,As,wt[2]):i:this[wt[0]]=As?As.replace(wt[1],wt[2]):i:wt.length===4&&(this[wt[0]]=As?wt[3].call(this,As.replace(wt[1],wt[2])):i):this[wt]=As||i;tt+=2}},Vt=function(me,Mt){for(var tt in Mt)if(typeof Mt[tt]===c&&Mt[tt].length>0){for(var Kt=0;Kt<Mt[tt].length;Kt++)if(Xe(Mt[tt][Kt],me))return tt===a?i:tt}else if(Xe(Mt[tt],me))return tt===a?i:tt;return me},P={"1.0":"/8","1.2":"/1","1.3":"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"},ie={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2","8.1":"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},et={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[_,[f,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[_,[f,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[f,_],[/opios[\/ ]+([\w\.]+)/i],[_,[f,Ke+" Mini"]],[/\bopr\/([\w\.]+)/i],[_,[f,Ke]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(heytap|ovi)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[f,_],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[_,[f,"UC"+ne]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[_,[f,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[_,[f,"WeChat"]],[/konqueror\/([\w\.]+)/i],[_,[f,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[_,[f,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[_,[f,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[f,/(.+)/,"$1 Secure "+ne],_],[/\bfocus\/([\w\.]+)/i],[_,[f,Ve+" Focus"]],[/\bopt\/([\w\.]+)/i],[_,[f,Ke+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[_,[f,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[_,[f,"Dolphin"]],[/coast\/([\w\.]+)/i],[_,[f,Ke+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[_,[f,"MIUI "+ne]],[/fxios\/([-\w\.]+)/i],[_,[f,Ve]],[/\bqihu|(qi?ho?o?|360)browser/i],[[f,"360 "+ne]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[f,/(.+)/,"$1 "+ne],_],[/(comodo_dragon)\/([\w\.]+)/i],[[f,/_/g," "],_],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[f,_],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[f],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[f,$i],_],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[f,_],[/\bgsa\/([\w\.]+) .*safari\//i],[_,[f,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[_,[f,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[_,[f,ae+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[f,ae+" WebView"],_],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[_,[f,"Android "+ne]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[f,_],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[_,[f,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[_,f],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[f,[_,Vt,P]],[/(webkit|khtml)\/([\w\.]+)/i],[f,_],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[f,"Netscape"],_],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[_,[f,Ve+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[f,_],[/(cobalt)\/([\w\.]+)/i],[f,[_,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[E,"amd64"]],[/(ia32(?=;))/i],[[E,_i]],[/((?:i[346]|x)86)[;\)]/i],[[E,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[E,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[E,"armhf"]],[/windows (ce|mobile); ppc;/i],[[E,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[E,/ower/,r,_i]],[/(sun4\w)[;\)]/i],[[E,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[E,_i]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[m,Ut],[p,A]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[d,[m,Ut],[p,y]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[d,[m,L],[p,y]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[m,L],[p,A]],[/(macintosh);/i],[d,[m,L]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[m,st],[p,y]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[d,[m,re],[p,A]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[m,re],[p,y]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[d,/_/g," "],[m,Wt],[p,y]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[d,/_/g," "],[m,Wt],[p,A]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[m,"OPPO"],[p,y]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[m,"Vivo"],[p,y]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[d,[m,"Realme"],[p,y]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[m,ze],[p,y]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[m,ze],[p,A]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[m,ge],[p,A]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[m,ge],[p,y]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[d,[m,"Lenovo"],[p,A]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[d,/_/g," "],[m,"Nokia"],[p,y]],[/(pixel c)\b/i],[d,[m,$e],[p,A]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[m,$e],[p,y]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[m,Jt],[p,y]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[m,Jt],[p,A]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[m,"OnePlus"],[p,y]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo[c-r]{2})( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[m,F],[p,A]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[m,F],[p,y]],[/(playbook);[-\w\),; ]+(rim)/i],[d,m,[p,A]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[m,Z],[p,y]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[m,V],[p,A]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[m,V],[p,y]],[/(nexus 9)/i],[d,[m,"HTC"],[p,A]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[m,[d,/_/g," "],[p,y]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[m,"Acer"],[p,A]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[m,"Meizu"],[p,y]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[m,d,[p,y]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[m,d,[p,A]],[/(surface duo)/i],[d,[m,be],[p,A]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[m,"Fairphone"],[p,y]],[/(u304aa)/i],[d,[m,"AT&T"],[p,y]],[/\bsie-(\w*)/i],[d,[m,"Siemens"],[p,y]],[/\b(rct\w+) b/i],[d,[m,"RCA"],[p,A]],[/\b(venue[\d ]{2,7}) b/i],[d,[m,"Dell"],[p,A]],[/\b(q(?:mv|ta)\w+) b/i],[d,[m,"Verizon"],[p,A]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[m,"Barnes & Noble"],[p,A]],[/\b(tm\d{3}\w+) b/i],[d,[m,"NuVision"],[p,A]],[/\b(k88) b/i],[d,[m,"ZTE"],[p,A]],[/\b(nx\d{3}j) b/i],[d,[m,"ZTE"],[p,y]],[/\b(gen\d{3}) b.+49h/i],[d,[m,"Swiss"],[p,y]],[/\b(zur\d{3}) b/i],[d,[m,"Swiss"],[p,A]],[/\b((zeki)?tb.*\b) b/i],[d,[m,"Zeki"],[p,A]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[m,"Dragon Touch"],d,[p,A]],[/\b(ns-?\w{0,9}) b/i],[d,[m,"Insignia"],[p,A]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[m,"NextBook"],[p,A]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[m,"Voice"],d,[p,y]],[/\b(lvtel\-)?(v1[12]) b/i],[[m,"LvTel"],d,[p,y]],[/\b(ph-1) /i],[d,[m,"Essential"],[p,y]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[m,"Envizen"],[p,A]],[/\b(trio[-\w\. ]+) b/i],[d,[m,"MachSpeed"],[p,A]],[/\btu_(1491) b/i],[d,[m,"Rotor"],[p,A]],[/(shield[\w ]+) b/i],[d,[m,"Nvidia"],[p,A]],[/(sprint) (\w+)/i],[m,d,[p,y]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[m,be],[p,y]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[m,ii],[p,A]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[m,ii],[p,y]],[/smart-tv.+(samsung)/i],[m,[p,I]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[m,Ut],[p,I]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[m,ge],[p,I]],[/(apple) ?tv/i],[m,[d,L+" TV"],[p,I]],[/crkey/i],[[d,ae+"cast"],[m,$e],[p,I]],[/droid.+aft(\w)( bui|\))/i],[d,[m,F],[p,I]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[m,st],[p,I]],[/(bravia[\w ]+)( bui|\))/i],[d,[m,Jt],[p,I]],[/(mitv-\w{5}) bui/i],[d,[m,Wt],[p,I]],[/Hbbtv.*(technisat) (.*);/i],[m,d,[p,I]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[m,Ge],[d,Ge],[p,I]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[p,I]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[m,d,[p,v]],[/droid.+; (shield) bui/i],[d,[m,"Nvidia"],[p,v]],[/(playstation [345portablevi]+)/i],[d,[m,Jt],[p,v]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[m,be],[p,v]],[/((pebble))app/i],[m,d,[p,T]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[m,L],[p,T]],[/droid.+; (glass) \d/i],[d,[m,$e],[p,T]],[/droid.+; (wt63?0{2,3})\)/i],[d,[m,ii],[p,T]],[/(quest( 2| pro)?)/i],[d,[m,$i],[p,T]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[m,[p,R]],[/(aeobc)\b/i],[d,[m,F],[p,R]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[d,[p,y]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[p,A]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[p,A]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[p,y]],[/(android[-\w\. ]{0,9});.+buil/i],[d,[m,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[_,[f,Ue+"HTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[_,[f,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[f,_],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[_,f]],os:[[/microsoft (windows) (vista|xp)/i],[f,_],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[f,[_,Vt,ie]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[f,"Windows"],[_,Vt,ie]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/ios;fbsv\/([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[_,/_/g,"."],[f,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[f,en],[_,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[_,f],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[f,_],[/\(bb(10);/i],[_,[f,Z]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[_,[f,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[_,[f,Ve+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[_,[f,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[_,[f,"watchOS"]],[/crkey\/([\d\.]+)/i],[_,[f,ae+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[f,Ji],_],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[f,_],[/(sunos) ?([\w\.\d]*)/i],[[f,"Solaris"],_],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[f,_]]},zi=function(me,Mt){if(typeof me===c&&(Mt=me,me=i),!(this instanceof zi))return new zi(me,Mt).getResult();var tt=typeof t!==l&&t.navigator?t.navigator:i,Kt=me||(tt&&tt.userAgent?tt.userAgent:r),fr=tt&&tt.userAgentData?tt.userAgentData:i,ys=Mt?vn(et,Mt):et,wt=tt&&tt.userAgent==Kt;return this.getBrowser=function(){var Qe={};return Qe[f]=i,Qe[_]=i,yn.call(Qe,Kt,ys.browser),Qe[h]=yt(Qe[_]),wt&&tt&&tt.brave&&typeof tt.brave.isBrave==o&&(Qe[f]="Brave"),Qe},this.getCPU=function(){var Qe={};return Qe[E]=i,yn.call(Qe,Kt,ys.cpu),Qe},this.getDevice=function(){var Qe={};return Qe[m]=i,Qe[d]=i,Qe[p]=i,yn.call(Qe,Kt,ys.device),wt&&!Qe[p]&&fr&&fr.mobile&&(Qe[p]=y),wt&&Qe[d]=="Macintosh"&&tt&&typeof tt.standalone!==l&&tt.maxTouchPoints&&tt.maxTouchPoints>2&&(Qe[d]="iPad",Qe[p]=A),Qe},this.getEngine=function(){var Qe={};return Qe[f]=i,Qe[_]=i,yn.call(Qe,Kt,ys.engine),Qe},this.getOS=function(){var Qe={};return Qe[f]=i,Qe[_]=i,yn.call(Qe,Kt,ys.os),wt&&!Qe[f]&&fr&&fr.platform!="Unknown"&&(Qe[f]=fr.platform.replace(/chrome os/i,Ji).replace(/macos/i,en)),Qe},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return Kt},this.setUA=function(Qe){return Kt=typeof Qe===u&&Qe.length>x?Ge(Qe,x):Qe,this},this.setUA(Kt),this};zi.VERSION=n,zi.BROWSER=Ne([f,_,h]),zi.CPU=Ne([E]),zi.DEVICE=Ne([d,m,p,v,y,I,A,T,R]),zi.ENGINE=zi.OS=Ne([f,_]),s.exports&&(e=s.exports=zi),e.UAParser=zi;var Hi=typeof t!==l&&(t.jQuery||t.Zepto);if(Hi&&!Hi.ua){var Bs=new zi;Hi.ua=Bs.getResult(),Hi.ua.get=function(){return Bs.getUA()},Hi.ua.set=function(me){Bs.setUA(me);var Mt=Bs.getResult();for(var tt in Mt)Hi.ua[tt]=Mt[tt]}}})(typeof window=="object"?window:Gv)})(Wf,Wf.exports);var WD=Wf.exports;const XD=Kg(WD),YD=XD(),ug=YD.device,KD=ug.type==="mobile"||ug.type==="tablet",QD={isMobile(){return KD}},Da=M.memo(()=>M.createElement("span",{className:"tutorial-pointer"},M.createElement("img",{src:ot("hand"),alt:"pointer"}))),Oa=({text:s,children:e,step:t})=>{const i=s!=null;return M.createElement("div",{className:`tutorial tutorial-${t}`+(i?" with-text":"")},e,s!=null&&M.createElement("span",{className:"text"},s))},ZD=(s,e)=>{const t=QD.isMobile();switch(s){case"dragToMove":return M.createElement(Oa,{text:qe(t?"tutorials.dragToMove.mobile":"tutorials.dragToMove.desktop"),step:s},t?M.createElement("span",{className:"tutorial-phone"},M.createElement("img",{src:ot("phone"),alt:"phone"})):M.createElement("div",{className:"tutorial-arrows"},M.createElement("span",{className:"l"},"←"),M.createElement("span",{className:"u"},"↑"),M.createElement("span",{className:"r"},"→"),M.createElement("span",{className:"d"},"↓")),t&&M.createElement(Da,null));case"takeLogs":const i=e.playerItems.find(a=>a.item.key==="iLog"),n=i?i.item.count:0,r=Math.max(3-n,1);return M.createElement("div",{className:`tutorial tutorial-${s} with-text`},M.createElement("span",{className:"text"},qe("tutorials.takeLogs")),M.createElement("img",{src:ot("iLog"),alt:"log"}),r);case"goToSawmill":return null;case"openUpgrades":return M.createElement(Oa,{text:qe("tutorials.openUpgrades"),step:s},M.createElement(Da,null),M.createElement("span",{className:"tutorial-pointer-special"},M.createElement("img",{src:ot("hand"),alt:"pointer"})));case"buyUpgrade":return M.createElement(Oa,{step:s},M.createElement(Da,null));case"closeUpgrades":return M.createElement(Oa,{step:s},M.createElement(Da,null));case"collectCoins":return M.createElement("div",{className:`tutorial tutorial-${s} with-text`},M.createElement("span",{className:"text"},qe("tutorials.collectCoins")),M.createElement("img",{src:ot("iCoin"),alt:qe("iCoin")}));case"dropItem":return M.createElement(Oa,{text:qe("tutorials.dropItem"),step:s},M.createElement(Da,null));case"wakeUp":return M.createElement(Oa,{text:qe("tutorials.wakeUp"),step:s},M.createElement(Da,null));default:return}},qD=M.memo(()=>{const s=bt(),{refresh:e}=Yt(),t=s.tasks.find(i=>!!i.taskActive);return te("onTaskUpdated",e),te("onSettingsChanged",e),te("onButtonClicked",e),te("onInventoryUpdated",e),ve.useEffect(()=>{const i=Dn.onGameLoaded.add(()=>e());return()=>{i.remove()}},[]),t?M.createElement("div",{className:"tutorials"},ZD(t.task.op,s)):null}),bo=({partKey:s,colorizePossible:e,variantsPossible:t,playerEntity:i,emptyPossible:n})=>{const{refresh:r}=Yt(),a=qe("part."+s),o=i.appearance;let l=o.parts.find(u=>u[0]===s);const c=i.model.visual.customizer.meshParts.parts[s].length;return M.createElement("div",{className:"element"},M.createElement("span",{className:"element-title"},a),t&&M.createElement(ve.Fragment,null,M.createElement("button",{onClick:()=>{if(l)l[1]--,l[1]<0&&(n?(o.parts=o.parts.filter(u=>u[0]!==s),o.removed.push(s),l=void 0,r()):l[1]=c-1);else{if(!n)return;l=[s,c-1,G.Black()],o.parts.push(l),r()}}},"<"),M.createElement("span",null),M.createElement("button",{onClick:()=>{if(l)l[1]++,l[1]>=c&&(n?(o.parts=o.parts.filter(u=>u[0]!==s),o.removed.push(s),l=void 0,r()):l[1]=0);else{if(!n)return;l=[s,0,G.Black()],o.parts.push(l),r()}}},">")),e&&l&&M.createElement("input",{defaultValue:l[2].toHexString(),type:"color",onChange:u=>{if(!l)return;l[2].copyFrom(G.FromHexString(u.currentTarget.value))}}))};const hm=M.memo(({service:s,children:e})=>{const t=bt(),{refresh:i}=Yt(),n=t.playerEntity;te("onPauseChanged",i),te("onPlayerAtService",l=>{l.service===s&&i()}),te("onPlayerExitService",i);const r=()=>{uv(t),vt(t,ut.click),Vn.showInterstetial(`on${s}ClosedAd`)};if(zE(()=>{n.playerInServiceBuilding===s&&r()}),n.playerInServiceBuilding!==s)return null;const a=n.model.visual;return a&&a.customizer?M.createElement("div",{className:"service-overlay"},M.createElement("div",{className:"elements"},e),M.createElement("button",{className:"close-btn",onClick:r},qe("actions.exit"))):null}),jD=M.memo(()=>{const e=bt().playerEntity;return M.createElement(hm,{service:"home"},M.createElement(bo,{playerEntity:e,partKey:"Body",colorizePossible:!0}),M.createElement(bo,{playerEntity:e,partKey:"Eyes",colorizePossible:!0}))}),$D=M.memo(()=>{const e=bt().playerEntity;return M.createElement(hm,{service:"hairdresser"},M.createElement(bo,{playerEntity:e,partKey:"Hair",variantsPossible:!0,colorizePossible:!0}),M.createElement(bo,{playerEntity:e,partKey:"Mustache",variantsPossible:!0,colorizePossible:!0,emptyPossible:!0}))}),JD=M.memo(()=>{const e=bt().playerEntity;return M.createElement(hm,{service:"tailor"},M.createElement(bo,{playerEntity:e,partKey:"Pant",variantsPossible:!0,colorizePossible:!0}),M.createElement(bo,{playerEntity:e,partKey:"Jacket",variantsPossible:!0,colorizePossible:!0}))});const eO=s=>M.createElement("div",{className:"color-cell",style:{backgroundColor:s.color},onClick:()=>s.onClick(s.i),onPointerMove:()=>s.dragged&&s.onClick(s.i)}),tO=M.memo(()=>{const s=bt(),{refresh:e}=Yt(),t=s.flag.map((c,u)=>[u,c]),i=s.playerEntity,[n]=ve.useState(G.White()),[r,a]=ve.useState(!1);if(te("onPauseChanged",e),te("onPlayerAtService",c=>{c.service==="wall"&&e()}),te("onPlayerExitService",e),ve.useEffect(()=>{const c=()=>a(!1);return window.addEventListener("mouseup",c),window.addEventListener("pointerup",c),()=>{window.removeEventListener("mouseup",c),window.removeEventListener("pointerup",c)}},[s]),i.playerInServiceBuilding!=="wall")return null;const o=()=>{uv(s),vt(s,ut.click),Vn.showInterstetial("onWallClosedAd")},l=c=>{t[c]&&(s.flag[c]=n.toHexString(),s.sceneEntity.scene.updateFlag(s.flag),e())};return M.createElement("div",{className:"wall-overlay"},M.createElement("div",{className:"elements"},M.createElement("div",{className:"controls"},M.createElement("input",{value:n.toHexString(),type:"color",onChange:c=>{n.copyFrom(G.FromHexString(c.currentTarget.value)),e()}}),M.createElement("div",{className:"clr clr-white",onClick:()=>{n.copyFrom(G.White()),e()}}),M.createElement("div",{className:"clr clr-black",onClick:()=>{n.copyFrom(G.Black()),e()}})),M.createElement("div",{className:"cells",onPointerDown:()=>{a(!0)},onPointerUp:()=>{a(!1)}},t.map(c=>M.createElement(eO,{key:c[0],dragged:r,i:c[0],color:c[1],onClick:l})))),M.createElement("button",{className:"close-btn",onClick:o},qe("actions.exit")))});const hg=["#e1c58f","#98cc6b","#96c8e9","#ff7a5d","#e574fe","#96e9d4","#fba000","#a0b1b1","#a379f2"],iO=({entity:s})=>{const e=bt(),t=s.purchased==null,i=s.achievement,n=ve.useRef(null),r=Nf(n),a=ve.useRef(null),o=Nf(a),l=i.max,c=Math.min(i.val,l),u=Math.ceil(W.Clamp(c/l,0,1)*100),h=l<=c,d=t&&h,[f,p]=ve.useState(["claim-btn"]);ve.useEffect(()=>{p(y=>{if(d){if(y.includes("disabled"))return y.filter(A=>A!=="disabled")}else if(!y.includes("disabled"))return[...y,"disabled"];return y})},[d]);const m=()=>{if(!d){r(),o();return}um(e,s),co(e,i.award),vt(e,ut.pickCoin),hv(3),e.bus.onAchievementsUpdated.notifyObservers(),e.bus.onBigSaveRequested.notifyObservers()},_=i.lvl-1,E=hg[_%hg.length],v=i.type==="iLog"?"tree":i.type==="iStrength"?"battle":i.type;return M.createElement("div",{className:"item",key:s.id},M.createElement("div",{className:"achievement-icon-container",style:{color:E}},M.createElement("img",{className:"achievement-icon",alt:"",src:ot(v)}),M.createElement("span",{className:"achievement-lvl"},i.lvl)),M.createElement("div",{ref:a,className:"launch-progress"},M.createElement("div",{className:"launch-bar",style:{width:u+"%"}}),M.createElement("span",{className:"progress-values"},c,"/",l)),M.createElement("div",{className:"claim"},t&&M.createElement("button",{ref:n,className:f.join(" "),onClick:m},M.createElement("span",null,"+"),M.createElement("img",{alt:qe("iCoin"),src:ot("iCoin")}),M.createElement("span",null,i.award))))},nO=M.memo(()=>{const s=bt(),{refresh:e}=Yt();te("onSettingsChanged",e),te("onPurchased",e),te("onVarChanged",e),te("onAchievementsUpdated",e);const i=[...ve.useMemo(()=>s.identifiableQuery.with("achievement"),[s]).entities].reverse(),n=[];return i.forEach(r=>{const a=n.length>0?n[n.length-1]:null;if(!a)n.push(r);else if(a.achievement.type===r.achievement.type){if(!a.purchased)return;n[n.length-1]=r}else n.push(r)}),M.createElement(hh,{title:qe("achievements-popup.title"),popupClassName:"achievements-popup",openButtonName:"achievements",closeButtonName:"closeAchievements",withAds:!0},M.createElement("div",{className:"items scrollable"},n.map(r=>M.createElement(iO,{key:r.id,entity:r}))))});const sO=""+new URL("icon_lock-a8615a5b.png",import.meta.url).href,rO=M.memo(({iconUrl:s,title:e,descs:t,lvl:i,used:n,isNew:r})=>M.createElement("div",{className:"item"},M.createElement("img",{className:"icon",alt:"",src:s}),M.createElement("div",{className:"info"},M.createElement("span",{className:"title"},n?e:"???"),n&&t.map((a,o)=>M.createElement("span",{key:o+"",className:"desc"},a)),!n&&M.createElement("span",{className:"desc"},qe("lvl",{lvl:i.toString()})),(!n||r)&&M.createElement("img",{alt:"new",className:"locker"+(r?" new":""),src:sO}))));window.__doPrestige=()=>{__world.bus.onPrestigeActivated.notifyObservers()};const aO=M.memo(()=>{const s=bt(),{refresh:e}=Yt(),t=ve.useRef(null),i=Nf(t),n="pLaboratory";te("onProducerOutputProduced",l=>{l.id===n&&e()});const r=s.varsEntity.persistentVars.prestige+1,a=ho[Math.min(s.varsEntity.persistentVars.prestige,ho.length-1)].reqGems||1,o=()=>{if(s.playerItems.reduce((u,h)=>(h.item.key==="iGem"&&(u+=h.item.count),u),0)<a){i();return}vt(s,ut.click),s.bus.onPrestigeActivated.notifyObservers()};return M.createElement(hh,{openButtonName:"prestige",closeButtonName:"closePrestige",popupClassName:"prestige-popup",title:qe("prestige-popup.title",{lvl:r.toString()})},M.createElement("div",{className:"notice"},qe("prestige-popup.notice")),M.createElement("div",{className:"items scrollable"},ho.map((l,c)=>M.createElement(rO,{key:l.id,iconUrl:l.icon,title:qe(l.id+".title"),descs:l.effects.map(u=>{const h=u.ownedBy,d=qe("prestige.desc",{name:qe(u.attr+".long"),val:(u.value*100).toString()});return h?`${qe(h)} - `+d:d}),used:r>c,lvl:c+1,isNew:r===c+1}))),M.createElement("div",{style:{display:"flex",justifyContent:"center"}},M.createElement("button",{className:"next-village-btn",ref:t,onClick:o},qe("prestige-popup.next"),": ",M.createElement("img",{src:ot("iGem"),alt:"gems"})," ",a)))}),oO=M.memo(()=>{const s=bt(),{refresh:e}=Yt(),t=s.with("cameraCinematic","enabled").entities[0];if(te("onInventoryUpdated",e),te("onEffectsUpdated",e),te("onSceneReady",e),te("onPauseChanged",e),te("onCinematicStarted",e),te("onCinematicFinished",e),te("onPurchased",e),te("onSettingsChanged",e),te("onVarChanged",e),te("onProducerOutputProduced",h=>{h.id==="pSawmill"&&e()}),te("onZoneLoaded",e),t!=null&&!s.sceneEntity.paused)return null;const i=s.lvlManager;if(!i||!i.currentZone)return null;const r=()=>{s.bus.onButtonClicked.notifyObservers({btn:"pause"}),vt(s,ut.click)},a=s.varsEntity?s.varsEntity.persistentVars:void 0,o=()=>{s.bus.onButtonClicked.notifyObservers({btn:"upgrades"}),vt(s,ut.click),a&&(a.viewedUpgrades=a.unlockedUpgrades,s.bus.onVarChanged.notifyObservers({key:"viewedUpgrades"}))},c=!!s.statsEntity.gameStatistics.produced.pSawmill;let u=!1;return a&&(u=a.viewedUpgrades<a.unlockedUpgrades),M.createElement("div",{className:"hud"},M.createElement(aD,null),M.createElement(HD,null),M.createElement(pD,null),M.createElement(FD,null),M.createElement("button",{id:"btn-pause",onClick:r},M.createElement("img",{src:LD,alt:"pause"})),c&&M.createElement("button",{id:"btn-upgrades",onClick:o},M.createElement("img",{src:ND,alt:"upgrades"}),u&&M.createElement("img",{src:dh,alt:"!",className:"sign"})),M.createElement(jD,null),M.createElement($D,null),M.createElement(JD,null),M.createElement(tO,null),M.createElement(nO,null),M.createElement(aO,null),M.createElement(GD,null),M.createElement(qD,null),M.createElement(DD,null))});const lO=M.memo(({producerEntity:s,workerEntity:e})=>{const{refresh:t}=Yt(),i=ve.useRef(null);return te("onProducerItemsUpdated",n=>{n.id===s.id&&t()}),hr(e.id,i,-70,-16),M.createElement("div",{ref:i,className:"sawmill-tutorial npc-needs"},M.createElement("div",{className:"gate-coins-rest"},qe("tutorials.goToSawmill")),M.createElement("img",{src:ot("iLog")}))});function cO(s,e){return s.mapObjectsQuery.with("itemProducer","attributes","purchased","enabled","zone").entities.find(i=>i.id===e)}const uO=M.memo(({entityId:s})=>{const e=bt(),{refresh:t}=Yt(),i=ve.useRef(null),n=ve.useRef(null),r=cO(e,s),a=r&&r.attributes&&r.attributes.attInventoryTotalCapacity||0,o=r?r.itemProducer.inputItemType:void 0,l=e.ownedItemsQuery.entities.filter(p=>p.ownedBy===s&&p.item.key===o).reduce((p,m)=>p+m.item.count,0);if(te("onTaskUpdated",t),te("onInventoryUpdated",t),te("onProducerItemsUpdated",p=>{p.id===s&&t()}),te("onAttributesChanged",p=>{p.entity.id===s&&t()}),te("onPurchased",p=>{p.entity.id===s&&t()}),te("onEnabled",p=>{p.entity.effect!=null&&p.entity.ownedBy===s&&t()}),te("onPlayerMovementStarted",t),te("onPlayerMovementFinished",t),te("onNpcStartSleep",p=>{r!=null&&r.connectedWorker==p&&t()}),te("onNpcStopSleep",p=>{r!=null&&r.connectedWorker==p&&t()}),hr(s,i,-108/2,-52*1.7),ve.useEffect(()=>{if(r==null||r.itemProducer==null)return;const p=e.sceneEntity.scene.onBeforeRenderObservable.add(()=>{const m=r.itemProducer.stepProgress,_=1/a;let E=l/a;if(m!=null&&(E+=_*(1-m)),n.current!=null){const v=100-Math.ceil(100*E);n.current.style.right=v+"%"}});return()=>{e.sceneEntity.scene.onBeforeRenderObservable.remove(p)}},[r,a,l]),r==null||r.connectedWorker!=null&&r.connectedWorker.npcSleeping)return null;const c=r.itemProducer,u=c.inputItemType,h=c.outputItemType,d=!!c.fullPerStep;if(r.sawmill!=null){const p=e.tasks.find(m=>!!m.taskActive);if(p&&p.task.op==="goToSawmill"&&c.willProduceAmount==null){const m=e.visualMapObjectsQuery.with("sawmillWorker").entities[0];if(m){const _=e.itemsEntitiesByOwner.get(r.id);if(!(_&&_.size>0))return M.createElement(lO,{producerEntity:r,workerEntity:m})}}}return d&&c.willProduceAmount!=null?null:M.createElement(M.Fragment,null,M.createElement("div",{ref:i,className:`producer ${s}`},M.createElement("div",{className:"producer-tip"},u!=null&&M.createElement(M.Fragment,null,M.createElement("img",{src:ot(u)}),M.createElement("span",null,"→")),M.createElement("img",{src:ot(h)})),u!=null&&M.createElement("div",{className:"producer-progress"},M.createElement("span",{className:"prgs",ref:n}))))});const hO=({entity:s})=>{const e=ve.useRef(null);hr(s.id,e,-26,-16);const t=s.itemHolder.max-s.itemHolder.val;return t<1?null:M.createElement("div",{ref:e,className:"item-holder"},M.createElement("img",{src:ot(s.itemHolder.type)}),M.createElement("div",null,t))};const dO=({entity:s})=>{const e=bt(),{refresh:t}=Yt(),i=ve.useRef(null);if(te("onProducerItemsUpdated",a=>{a.id===s.id&&t()}),te("onNpcTasksUpdated",a=>{a.npcEntity===s&&t()}),te("onUsageGained",a=>a.owner===s&&t()),te("onUsageFree",a=>a.owner===s&&t()),hr(s.id,i,-12,-20),s.hireableNpc!=null)return null;const r=s.npcTasksList[0];if(r==null||s.removing!=null)return null;if(r.type==="transferItem"){const a=r,o=e.entityByIdentifier.get(a.fromOwnerId);if(o==null||o.usable&&o.usedBy!==s)return null;const l=e.ownedItemsQuery.entities.filter(h=>h.ownedBy===s.id&&h.item.key===a.item).reduce((h,d)=>h+d.item.count,0),c=Math.min(l,a.count),u=a.count-c;return M.createElement("div",{ref:i,className:"npc-needs"},M.createElement("img",{src:ot(a.item)}),M.createElement("div",{className:"gate-coins-rest"},u))}return null};const fO=({entity:s})=>{const e=bt(),{refresh:t}=Yt(),i=ve.useRef(null);hr(s.id,i,-12,-20),te("onNpcEmojiAppeared",c=>c===s&&t()),te("onNpcEmojiDisappeared",c=>c===s&&t());const n=e.emojisQuery.entities.find(c=>c.ownedBy===s.id&&c.removing==null);if(n==null)return null;const r=n.npcEmoji,a=r.anim==="shaker"?" anim-shaker-1":"",o=r.emoji,l=o.length>3;return M.createElement("div",{ref:i,className:"npc-emoji"},M.createElement("span",{className:"emoji"+a},l?M.createElement("img",{src:o,alt:"img"}):o))};const pO=M.memo(({entity:s})=>{const e=bt(),{refresh:t}=Yt();te("onInteractiveAreaEntered",t),te("onInteractiveAreaLeft",t),te("onPlayerMovementStarted",t),te("onPlayerMovementFinished",t);const i=ve.useRef(null),n=ve.useRef(null),r=s.bonusResource;return ve.useEffect(()=>{const a=e.bus.onEntityScreenPositionUpdated.add(({id:o,screenPosition:l})=>{if(o!==s.id)return;const c=i.current;if(c!=null){if(l.lengthSquared()<.1){c.style.cssText="opacity:0;";return}c.style.cssText=`opacity:1; left:${l.x}px; top:${l.y}px`}});return()=>{e.bus.onEntityScreenPositionUpdated.remove(a)}},[s.id,e]),ve.useEffect(()=>{const a=e.sceneEntity.scene.onAfterRenderObservable.add(()=>{if(!n.current||r==null||r.activationDelay==null||s.playerInInteractiveArea==null)return;const o=r.activationDelay,l=Math.min((r.activationDuration-o)/r.activationDuration,1)*100;n.current.style.width=Math.floor(l)+"%"});return()=>{e.sceneEntity.scene.onAfterRenderObservable.remove(a)}},[s,r]),s.removing!=null||s.playerInInteractiveArea==null||r==null?null:M.createElement("div",{ref:i,className:"bonus-resource"},M.createElement("img",{src:ot(r.itemType)}),M.createElement("div",{className:"gate-coins-rest"},r.itemCount),M.createElement("div",{className:"launch-progress"},M.createElement("div",{className:"launch-bar",ref:n}),M.createElement("span",null,M.createElement("img",{className:"ads-icon",alt:qe("ads"),src:ot("video")}))))});const mO="pManagerNpc",_O=M.memo(()=>{const s=bt(),{refresh:e}=Yt(),t=s.identifiableQuery.with("manager").entities[0],i=s.with("managerActivation","enabled").entities[0];te("onInteractiveAreaEntered",e),te("onInteractiveAreaLeft",e),te("onPlayerMovementStarted",e),te("onPlayerMovementFinished",e);const n=ve.useRef(null),r=ve.useRef(null);return ve.useEffect(()=>{const a=s.bus.onEntityScreenPositionUpdated.add(({id:o,screenPosition:l})=>{if(o!==mO)return;const c=n.current;if(c!=null){if(l.lengthSquared()<.1){c.style.cssText="opacity:0;";return}c.style.cssText=`opacity:1; left:${l.x}px; top:${l.y}px`}});return()=>{s.bus.onEntityScreenPositionUpdated.remove(a)}},[s,t.id]),ve.useEffect(()=>{const a=s.sceneEntity.scene,o=a.onAfterRenderObservable.add(()=>{if(!r.current||!i||t.playerInInteractiveArea==null||s.entityByIdentifier.has(ws))return;const l=i.managerActivation.activationDelay||0,c=Math.min((i.managerActivation.activationDuration-l)/i.managerActivation.activationDuration,1)*100;r.current.style.width=Math.floor(c)+"%"});return()=>{a.onAfterRenderObservable.remove(o)}},[t,i,t]),i==null||t.playerInInteractiveArea==null||s.entityByIdentifier.has(ws)?null:M.createElement("div",{ref:n,className:"hire-manager"},M.createElement("img",{src:ot("effectManager")}),M.createElement("div",{className:"gate-coins-rest"},"06:00"),M.createElement("div",{className:"launch-progress"},M.createElement("div",{className:"launch-bar",ref:r}),M.createElement("span",null,M.createElement("img",{className:"ads-icon",alt:qe("ads"),src:ot("video")}))))}),gO="pTrash",EO=M.memo(()=>{const{refresh:s}=Yt(),[e,t]=ve.useState(!1);return te("onProducerItemsUpdated",i=>{i.id===gO&&s()}),te("onDropTutorialRequested",()=>t(!0)),te("onDropTutorialFinished",()=>t(!1)),e?M.createElement("div",{className:"drop-tutorial npc-needs"},M.createElement("div",{className:"gate-coins-rest"},qe("tutorials.dropItem"))):null});const vO=M.memo(({children:s,width:e,height:t,progress:i})=>{const n=Math.ceil(W.Clamp(i,0,1)*100);return M.createElement("div",{className:"progress-bar",style:{width:e}},M.createElement("div",{className:"progress-bar_bar",style:{height:t,width:n+"%"}}),s)}),ed={w1:{key:"w1",award:2,minDmg:19,maxDmg:31,hp:42,count:1,dmgSpeedFactor:1.1,scaleFactor:.8},w2:{key:"w2",award:2,minDmg:22,maxDmg:36,hp:62,count:2,dmgSpeedFactor:1,scaleFactor:.8},w3:{key:"w3",award:2,minDmg:25,maxDmg:41,hp:82,count:1,dmgSpeedFactor:1,scaleFactor:.8},w4:{key:"w4",award:2,minDmg:28,maxDmg:46,hp:102,count:2,dmgSpeedFactor:1,scaleFactor:.9},w5:{key:"w5",award:3,minDmg:32,maxDmg:54,hp:141,count:3,dmgSpeedFactor:.9,scaleFactor:.8},w6:{key:"w6",award:3,minDmg:34,maxDmg:56,hp:142,count:2,dmgSpeedFactor:.9,scaleFactor:.9},w7:{key:"w7",award:3,minDmg:37,maxDmg:61,hp:162,count:2,dmgSpeedFactor:.9,scaleFactor:.8},w8:{key:"w8",award:3,minDmg:40,maxDmg:66,hp:182,count:3,dmgSpeedFactor:.9,scaleFactor:.8},w9:{key:"w9",award:3,minDmg:47,maxDmg:78,hp:223,count:2,dmgSpeedFactor:.9,scaleFactor:.9},w10:{key:"w10",award:6,minDmg:60,maxDmg:100,hp:242,count:1,dmgSpeedFactor:1,scaleFactor:1.2},w11:{key:"w11",award:4,minDmg:63,maxDmg:105,hp:262,count:2,dmgSpeedFactor:.9,scaleFactor:.9},w12:{key:"w12",award:4,minDmg:66,maxDmg:110,hp:282,count:2,dmgSpeedFactor:.9,scaleFactor:.9},w13:{key:"w13",award:4,minDmg:69,maxDmg:115,hp:302,count:3,dmgSpeedFactor:.9,scaleFactor:.9},w14:{key:"w14",award:4,minDmg:72,maxDmg:120,hp:322,count:4,dmgSpeedFactor:.9,scaleFactor:.9},w15:{key:"w15",award:5,minDmg:79,maxDmg:132,hp:360,count:5,dmgSpeedFactor:.9,scaleFactor:.9},w16:{key:"w16",award:5,minDmg:78,maxDmg:130,hp:362,count:2,dmgSpeedFactor:.9,scaleFactor:.95},w17:{key:"w17",award:5,minDmg:81,maxDmg:135,hp:382,count:3,dmgSpeedFactor:.9,scaleFactor:.95},w18:{key:"w18",award:5,minDmg:84,maxDmg:140,hp:402,count:2,dmgSpeedFactor:.9,scaleFactor:.95},w19:{key:"w19",award:5,minDmg:105,maxDmg:174,hp:549,count:3,dmgSpeedFactor:.9,scaleFactor:.95},w20:{key:"w20",award:9,minDmg:106,maxDmg:176,hp:464,count:1,dmgSpeedFactor:.9,scaleFactor:1.2},w21:{key:"w21",award:6,minDmg:109,maxDmg:181,hp:484,count:2,dmgSpeedFactor:.8,scaleFactor:.95},w22:{key:"w22",award:6,minDmg:112,maxDmg:186,hp:504,count:3,dmgSpeedFactor:.8,scaleFactor:.95},w23:{key:"w23",award:6,minDmg:115,maxDmg:191,hp:524,count:2,dmgSpeedFactor:.8,scaleFactor:.95},w24:{key:"w24",award:6,minDmg:118,maxDmg:196,hp:544,count:2,dmgSpeedFactor:.8,scaleFactor:.95},w25:{key:"w25",award:7,minDmg:127,maxDmg:211,hp:593,count:3,dmgSpeedFactor:.8,scaleFactor:1},w26:{key:"w26",award:7,minDmg:124,maxDmg:206,hp:584,count:4,dmgSpeedFactor:.8,scaleFactor:1},w27:{key:"w27",award:7,minDmg:127,maxDmg:211,hp:604,count:5,dmgSpeedFactor:.8,scaleFactor:1},w28:{key:"w28",award:7,minDmg:130,maxDmg:216,hp:624,count:2,dmgSpeedFactor:.8,scaleFactor:1},w29:{key:"w29",award:7,minDmg:159,maxDmg:265,hp:773,count:2,dmgSpeedFactor:.8,scaleFactor:1},w30:{key:"w30",award:12,minDmg:152,maxDmg:253,hp:688,count:1,dmgSpeedFactor:.8,scaleFactor:1.2},w31:{key:"w31",award:8,minDmg:155,maxDmg:258,hp:708,count:3,dmgSpeedFactor:.7,scaleFactor:1},w32:{key:"w32",award:8,minDmg:158,maxDmg:263,hp:728,count:2,dmgSpeedFactor:.7,scaleFactor:1.1},w33:{key:"w33",award:8,minDmg:161,maxDmg:268,hp:748,count:3,dmgSpeedFactor:.7,scaleFactor:1.1},w34:{key:"w34",award:8,minDmg:164,maxDmg:273,hp:768,count:2,dmgSpeedFactor:.7,scaleFactor:1.1},w35:{key:"w35",award:9,minDmg:175,maxDmg:292,hp:828,count:3,dmgSpeedFactor:.7,scaleFactor:1.1},w36:{key:"w36",award:9,minDmg:170,maxDmg:283,hp:808,count:4,dmgSpeedFactor:.7,scaleFactor:1.1},w37:{key:"w37",award:9,minDmg:173,maxDmg:288,hp:828,count:5,dmgSpeedFactor:.7,scaleFactor:1.1},w38:{key:"w38",award:9,minDmg:176,maxDmg:293,hp:848,count:2,dmgSpeedFactor:.7,scaleFactor:1.1},w39:{key:"w39",award:9,minDmg:215,maxDmg:357,hp:955,count:3,dmgSpeedFactor:.7,scaleFactor:1.1},w40:{key:"w40",award:15,minDmg:199,maxDmg:331,hp:912,count:1,dmgSpeedFactor:.7,scaleFactor:1.2},w41:{key:"w41",award:10,minDmg:202,maxDmg:336,hp:932,count:1,dmgSpeedFactor:.65,scaleFactor:1.1},w42:{key:"w42",award:10,minDmg:205,maxDmg:341,hp:952,count:2,dmgSpeedFactor:.65,scaleFactor:1.1},w43:{key:"w43",award:10,minDmg:208,maxDmg:346,hp:972,count:3,dmgSpeedFactor:.65,scaleFactor:1.1},w44:{key:"w44",award:10,minDmg:211,maxDmg:351,hp:992,count:2,dmgSpeedFactor:.65,scaleFactor:1.1},w45:{key:"w45",award:11,minDmg:225,maxDmg:374,hp:1063,count:2,dmgSpeedFactor:.65,scaleFactor:1.1},w46:{key:"w46",award:11,minDmg:217,maxDmg:361,hp:1032,count:3,dmgSpeedFactor:.65,scaleFactor:1.1},w47:{key:"w47",award:11,minDmg:220,maxDmg:366,hp:1052,count:4,dmgSpeedFactor:.65,scaleFactor:1.1},w48:{key:"w48",award:11,minDmg:223,maxDmg:371,hp:1072,count:5,dmgSpeedFactor:.65,scaleFactor:1.1},w49:{key:"w49",award:11,minDmg:249,maxDmg:414,hp:1202,count:2,dmgSpeedFactor:.65,scaleFactor:1.1},w50:{key:"w50",award:18,minDmg:247,maxDmg:412,hp:1138,count:1,dmgSpeedFactor:.65,scaleFactor:1.3},w51:{key:"w51",award:12,minDmg:250,maxDmg:417,hp:1158,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w52:{key:"w52",award:12,minDmg:253,maxDmg:422,hp:1178,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w53:{key:"w53",award:12,minDmg:256,maxDmg:427,hp:1198,count:2,dmgSpeedFactor:.6,scaleFactor:1.1},w54:{key:"w54",award:12,minDmg:259,maxDmg:432,hp:1218,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w55:{key:"w55",award:13,minDmg:275,maxDmg:459,hp:1300,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w56:{key:"w56",award:13,minDmg:265,maxDmg:442,hp:1258,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w57:{key:"w57",award:13,minDmg:268,maxDmg:447,hp:1278,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w58:{key:"w58",award:13,minDmg:271,maxDmg:452,hp:1298,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w59:{key:"w59",award:13,minDmg:274,maxDmg:457,hp:1318,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w60:{key:"w60",award:21,minDmg:296,maxDmg:494,hp:1366,count:1,dmgSpeedFactor:.6,scaleFactor:1.3},w61:{key:"w61",award:14,minDmg:299,maxDmg:499,hp:1386,count:2,dmgSpeedFactor:.6,scaleFactor:1.1},w62:{key:"w62",award:14,minDmg:302,maxDmg:504,hp:1406,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w63:{key:"w63",award:14,minDmg:305,maxDmg:509,hp:1426,count:2,dmgSpeedFactor:.6,scaleFactor:1.1},w64:{key:"w64",award:14,minDmg:308,maxDmg:514,hp:1446,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w65:{key:"w65",award:15,minDmg:327,maxDmg:545,hp:1540,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w66:{key:"w66",award:15,minDmg:314,maxDmg:524,hp:1486,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w67:{key:"w67",award:15,minDmg:317,maxDmg:529,hp:1506,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w68:{key:"w68",award:15,minDmg:320,maxDmg:534,hp:1526,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w69:{key:"w69",award:15,minDmg:323,maxDmg:539,hp:1546,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w70:{key:"w70",award:24,minDmg:347,maxDmg:578,hp:1595,count:1,dmgSpeedFactor:.6,scaleFactor:1.2},w71:{key:"w71",award:16,minDmg:350,maxDmg:583,hp:1615,count:2,dmgSpeedFactor:.6,scaleFactor:1.1},w72:{key:"w72",award:16,minDmg:353,maxDmg:588,hp:1635,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w73:{key:"w73",award:16,minDmg:356,maxDmg:593,hp:1655,count:2,dmgSpeedFactor:.6,scaleFactor:1.1},w74:{key:"w74",award:16,minDmg:359,maxDmg:598,hp:1675,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w75:{key:"w75",award:17,minDmg:380,maxDmg:633,hp:1780,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w76:{key:"w76",award:17,minDmg:365,maxDmg:608,hp:1715,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w77:{key:"w77",award:17,minDmg:368,maxDmg:613,hp:1735,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w78:{key:"w78",award:17,minDmg:371,maxDmg:618,hp:1755,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w79:{key:"w79",award:17,minDmg:374,maxDmg:623,hp:1775,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w80:{key:"w80",award:27,minDmg:398,maxDmg:663,hp:1826,count:1,dmgSpeedFactor:.6,scaleFactor:1.2},w81:{key:"w81",award:18,minDmg:401,maxDmg:668,hp:1846,count:2,dmgSpeedFactor:.6,scaleFactor:1.1},w82:{key:"w82",award:18,minDmg:404,maxDmg:673,hp:1866,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w83:{key:"w83",award:18,minDmg:407,maxDmg:678,hp:1886,count:2,dmgSpeedFactor:.6,scaleFactor:1.1},w84:{key:"w84",award:18,minDmg:410,maxDmg:683,hp:1906,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w85:{key:"w85",award:19,minDmg:434,maxDmg:723,hp:2023,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w86:{key:"w86",award:19,minDmg:416,maxDmg:693,hp:1946,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w87:{key:"w87",award:19,minDmg:419,maxDmg:698,hp:1966,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w88:{key:"w88",award:19,minDmg:422,maxDmg:703,hp:1986,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w89:{key:"w89",award:19,minDmg:425,maxDmg:708,hp:2006,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w90:{key:"w90",award:30,minDmg:451,maxDmg:751,hp:2059,count:1,dmgSpeedFactor:.6,scaleFactor:1.2},w91:{key:"w91",award:20,minDmg:454,maxDmg:756,hp:2079,count:2,dmgSpeedFactor:.6,scaleFactor:1.1},w92:{key:"w92",award:20,minDmg:457,maxDmg:761,hp:2099,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w93:{key:"w93",award:20,minDmg:460,maxDmg:766,hp:2119,count:2,dmgSpeedFactor:.6,scaleFactor:1.1},w94:{key:"w94",award:20,minDmg:463,maxDmg:771,hp:2139,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w95:{key:"w95",award:21,minDmg:489,maxDmg:815,hp:2267,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w96:{key:"w96",award:21,minDmg:469,maxDmg:781,hp:2179,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w97:{key:"w97",award:21,minDmg:472,maxDmg:786,hp:2199,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w98:{key:"w98",award:21,minDmg:475,maxDmg:791,hp:2219,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w99:{key:"w99",award:21,minDmg:478,maxDmg:796,hp:2239,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w100:{key:"w100",award:33,minDmg:555,maxDmg:925,hp:2523,count:3,dmgSpeedFactor:.6,scaleFactor:1.3},w101:{key:"w101",award:22,minDmg:508,maxDmg:846,hp:2313,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w102:{key:"w102",award:22,minDmg:511,maxDmg:851,hp:2333,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w103:{key:"w103",award:22,minDmg:514,maxDmg:856,hp:2353,count:2,dmgSpeedFactor:.6,scaleFactor:1.1},w104:{key:"w104",award:22,minDmg:517,maxDmg:861,hp:2373,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w105:{key:"w105",award:23,minDmg:546,maxDmg:909,hp:2513,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w106:{key:"w106",award:23,minDmg:523,maxDmg:871,hp:2413,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w107:{key:"w107",award:23,minDmg:526,maxDmg:876,hp:2433,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w108:{key:"w108",award:23,minDmg:529,maxDmg:881,hp:2453,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w109:{key:"w109",award:23,minDmg:532,maxDmg:886,hp:2473,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w110:{key:"w110",award:36,minDmg:560,maxDmg:933,hp:2530,count:3,dmgSpeedFactor:.6,scaleFactor:1.2},w111:{key:"w111",award:24,minDmg:563,maxDmg:938,hp:2550,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w112:{key:"w112",award:24,minDmg:566,maxDmg:943,hp:2570,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w113:{key:"w113",award:24,minDmg:569,maxDmg:948,hp:2590,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w114:{key:"w114",award:24,minDmg:572,maxDmg:953,hp:2610,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w115:{key:"w115",award:25,minDmg:604,maxDmg:1006,hp:2762,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w116:{key:"w116",award:25,minDmg:578,maxDmg:963,hp:2650,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w117:{key:"w117",award:25,minDmg:581,maxDmg:968,hp:2670,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w118:{key:"w118",award:25,minDmg:584,maxDmg:973,hp:2690,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w119:{key:"w119",award:25,minDmg:587,maxDmg:978,hp:2710,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w120:{key:"w120",award:39,minDmg:617,maxDmg:1027,hp:2768,count:3,dmgSpeedFactor:.6,scaleFactor:1.2},w121:{key:"w121",award:26,minDmg:620,maxDmg:1032,hp:2788,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w122:{key:"w122",award:26,minDmg:623,maxDmg:1037,hp:2808,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w123:{key:"w123",award:26,minDmg:626,maxDmg:1042,hp:2828,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w124:{key:"w124",award:26,minDmg:629,maxDmg:1047,hp:2848,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w125:{key:"w125",award:27,minDmg:663,maxDmg:1105,hp:3012,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w126:{key:"w126",award:27,minDmg:635,maxDmg:1057,hp:2888,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w127:{key:"w127",award:27,minDmg:638,maxDmg:1062,hp:2908,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w128:{key:"w128",award:27,minDmg:641,maxDmg:1067,hp:2928,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w129:{key:"w129",award:27,minDmg:644,maxDmg:1072,hp:2948,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w130:{key:"w130",award:42,minDmg:675,maxDmg:1124,hp:3008,count:3,dmgSpeedFactor:.6,scaleFactor:1.2},w131:{key:"w131",award:28,minDmg:678,maxDmg:1129,hp:3028,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w132:{key:"w132",award:28,minDmg:681,maxDmg:1134,hp:3048,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w133:{key:"w133",award:28,minDmg:684,maxDmg:1139,hp:3068,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w134:{key:"w134",award:28,minDmg:687,maxDmg:1144,hp:3088,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w135:{key:"w135",award:29,minDmg:724,maxDmg:1207,hp:3264,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w136:{key:"w136",award:29,minDmg:693,maxDmg:1154,hp:3128,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w137:{key:"w137",award:29,minDmg:696,maxDmg:1159,hp:3148,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w138:{key:"w138",award:29,minDmg:699,maxDmg:1164,hp:3168,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w139:{key:"w139",award:29,minDmg:702,maxDmg:1170,hp:3189,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w140:{key:"w140",award:45,minDmg:734,maxDmg:1224,hp:3251,count:3,dmgSpeedFactor:.6,scaleFactor:1.2},w141:{key:"w141",award:30,minDmg:737,maxDmg:1229,hp:3271,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w142:{key:"w142",award:30,minDmg:740,maxDmg:1234,hp:3291,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w143:{key:"w143",award:30,minDmg:743,maxDmg:1239,hp:3311,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w144:{key:"w144",award:30,minDmg:746,maxDmg:1244,hp:3331,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w145:{key:"w145",award:31,minDmg:787,maxDmg:1311,hp:3519,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w146:{key:"w146",award:31,minDmg:752,maxDmg:1254,hp:3371,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w147:{key:"w147",award:31,minDmg:755,maxDmg:1259,hp:3391,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w148:{key:"w148",award:31,minDmg:758,maxDmg:1264,hp:3411,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w149:{key:"w149",award:31,minDmg:761,maxDmg:1269,hp:3431,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w150:{key:"w150",award:48,minDmg:795,maxDmg:1325,hp:3495,count:3,dmgSpeedFactor:.6,scaleFactor:1.2},w151:{key:"w151",award:32,minDmg:798,maxDmg:1330,hp:3516,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w152:{key:"w152",award:32,minDmg:801,maxDmg:1335,hp:3536,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w153:{key:"w153",award:32,minDmg:804,maxDmg:1340,hp:3556,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w154:{key:"w154",award:32,minDmg:807,maxDmg:1345,hp:3576,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w155:{key:"w155",award:33,minDmg:851,maxDmg:1418,hp:3776,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w156:{key:"w156",award:33,minDmg:813,maxDmg:1355,hp:3616,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w157:{key:"w157",award:33,minDmg:816,maxDmg:1360,hp:3636,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w158:{key:"w158",award:33,minDmg:819,maxDmg:1365,hp:3656,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w159:{key:"w159",award:33,minDmg:822,maxDmg:1370,hp:3676,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w160:{key:"w160",award:51,minDmg:858,maxDmg:1430,hp:3743,count:3,dmgSpeedFactor:.6,scaleFactor:1.2},w161:{key:"w161",award:34,minDmg:861,maxDmg:1435,hp:3763,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w162:{key:"w162",award:34,minDmg:864,maxDmg:1440,hp:3783,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w163:{key:"w163",award:34,minDmg:867,maxDmg:1445,hp:3803,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w164:{key:"w164",award:34,minDmg:870,maxDmg:1450,hp:3823,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w165:{key:"w165",award:35,minDmg:917,maxDmg:1528,hp:4036,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w166:{key:"w166",award:35,minDmg:876,maxDmg:1460,hp:3863,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w167:{key:"w167",award:35,minDmg:879,maxDmg:1465,hp:3883,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w168:{key:"w168",award:35,minDmg:882,maxDmg:1470,hp:3903,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w169:{key:"w169",award:35,minDmg:885,maxDmg:1475,hp:3923,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w170:{key:"w170",award:54,minDmg:922,maxDmg:1537,hp:3992,count:3,dmgSpeedFactor:.6,scaleFactor:1.2},w171:{key:"w171",award:36,minDmg:925,maxDmg:1542,hp:4012,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w172:{key:"w172",award:36,minDmg:928,maxDmg:1547,hp:4032,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w173:{key:"w173",award:36,minDmg:931,maxDmg:1552,hp:4052,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w174:{key:"w174",award:36,minDmg:934,maxDmg:1557,hp:4072,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w175:{key:"w175",award:37,minDmg:984,maxDmg:1640,hp:4297,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w176:{key:"w176",award:37,minDmg:940,maxDmg:1567,hp:4113,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w177:{key:"w177",award:37,minDmg:943,maxDmg:1572,hp:4133,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w178:{key:"w178",award:37,minDmg:946,maxDmg:1577,hp:4153,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w179:{key:"w179",award:37,minDmg:949,maxDmg:1582,hp:4173,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w180:{key:"w180",award:57,minDmg:989,maxDmg:1647,hp:4244,count:3,dmgSpeedFactor:.6,scaleFactor:1.2},w181:{key:"w181",award:38,minDmg:992,maxDmg:1652,hp:4264,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w182:{key:"w182",award:38,minDmg:995,maxDmg:1657,hp:4284,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w183:{key:"w183",award:38,minDmg:998,maxDmg:1662,hp:4304,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w184:{key:"w184",award:38,minDmg:1001,maxDmg:1667,hp:4325,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w185:{key:"w185",award:39,minDmg:1054,maxDmg:1756,hp:4563,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w186:{key:"w186",award:39,minDmg:1007,maxDmg:1677,hp:4365,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w187:{key:"w187",award:39,minDmg:1010,maxDmg:1682,hp:4385,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w188:{key:"w188",award:39,minDmg:1013,maxDmg:1687,hp:4405,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w189:{key:"w189",award:39,minDmg:1016,maxDmg:1692,hp:4425,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w190:{key:"w190",award:60,minDmg:1056,maxDmg:1760,hp:4499,count:3,dmgSpeedFactor:.6,scaleFactor:1.3},w191:{key:"w191",award:40,minDmg:1059,maxDmg:1765,hp:4519,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w192:{key:"w192",award:40,minDmg:1062,maxDmg:1770,hp:4539,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w193:{key:"w193",award:40,minDmg:1065,maxDmg:1775,hp:4559,count:3,dmgSpeedFactor:.6,scaleFactor:1.1},w194:{key:"w194",award:40,minDmg:1068,maxDmg:1780,hp:4579,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w195:{key:"w195",award:41,minDmg:1125,maxDmg:1875,hp:4829,count:5,dmgSpeedFactor:.6,scaleFactor:1.1},w196:{key:"w196",award:41,minDmg:1074,maxDmg:1790,hp:4620,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w197:{key:"w197",award:41,minDmg:1077,maxDmg:1795,hp:4640,count:4,dmgSpeedFactor:.6,scaleFactor:1.1},w198:{key:"w198",award:41,minDmg:1080,maxDmg:1800,hp:4660,count:5,dmgSpeedFactor:.6,scaleFactor:1},w199:{key:"w199",award:41,minDmg:1083,maxDmg:1805,hp:4680,count:5,dmgSpeedFactor:.6,scaleFactor:1.2},w200:{key:"w200",award:63,minDmg:1126,maxDmg:1877,hp:4757,count:5,dmgSpeedFactor:.6,scaleFactor:1.5}},Du=["w1","w2","w3","w4","w5","w6","w7","w8","w9","w10","w11","w12","w13","w14","w15","w16","w17","w18","w19","w20","w21","w22","w23","w24","w25","w26","w27","w28","w29","w30","w31","w32","w33","w34","w35","w36","w37","w38","w39","w40","w41","w42","w43","w44","w45","w46","w47","w48","w49","w50","w51","w52","w53","w54","w55","w56","w57","w58","w59","w60","w61","w62","w63","w64","w65","w66","w67","w68","w69","w70","w71","w72","w73","w74","w75","w76","w77","w78","w79","w80","w81","w82","w83","w84","w85","w86","w87","w88","w89","w90","w91","w92","w93","w94","w95","w96","w97","w98","w99","w100","w101","w102","w103","w104","w105","w106","w107","w108","w109","w110","w111","w112","w113","w114","w115","w116","w117","w118","w119","w120","w121","w122","w123","w124","w125","w126","w127","w128","w129","w130","w131","w132","w133","w134","w135","w136","w137","w138","w139","w140","w141","w142","w143","w144","w145","w146","w147","w148","w149","w150","w151","w152","w153","w154","w155","w156","w157","w158","w159","w160","w161","w162","w163","w164","w165","w166","w167","w168","w169","w170","w171","w172","w173","w174","w175","w176","w177","w178","w179","w180","w181","w182","w183","w184","w185","w186","w187","w188","w189","w190","w191","w192","w193","w194","w195","w196","w197","w198","w199","w200"],dg="pArena",yO=M.memo(()=>{const s=bt(),{refresh:e}=Yt(),[t,i]=ve.useState(0),n=s.entityByIdentifier.get(dg);te("onInteractiveAreaEntered",e),te("onInteractiveAreaLeft",e),te("onPlayerMovementStarted",e),te("onPlayerMovementFinished",e),te("onVillageModeChanged",e),te("onPurchased",e);const r=ve.useRef(null);if(hr(dg,r,-30,-50),te("onTimerFired",e),te("onTimerProgressUpdated",u=>{n!=null&&n.playerInInteractiveArea!=null&&i(u.timer.progress)}),ve.useEffect(()=>{i(0)},[n&&n.playerInInteractiveArea==null]),s.villageMode!=="peacetime"||n==null||!n.unlocked)return null;const a=n.playerInInteractiveArea!=null,o=s.varsEntity.persistentVars,l=o.waves+1;return Du[o.waves]?M.createElement("div",{ref:r,className:"arena"},a&&M.createElement(vO,{progress:t},M.createElement("span",{className:"war-lvl"},qe("lvl",{lvl:l+""})))):null});const AO=M.memo(({entity:s})=>{const{refresh:e}=Yt();te("onInteractiveAreaEntered",e),te("onInteractiveAreaLeft",e),te("onPlayerMovementStarted",e),te("onPlayerMovementFinished",e),te("onHpUpdated",r=>{r===s&&n()});const t=ve.useRef(null),i=ve.useRef(null),n=()=>{if(!i.current)return;const r=s.maxHp||1,a=s.currentHp||0,o=Math.ceil(100*a/r);i.current.style.width=Math.floor(o)+"%"};return hr(s.id,t,-12,-3),ve.useEffect(()=>{n()},[s]),M.createElement("div",{ref:t,className:"health-bar"},M.createElement("div",{className:"launch-progress"},M.createElement("div",{className:"launch-bar",ref:i})))});function TO(s){switch(s){case $s.Enemy:return"red";case $s.Normal:return"white";case $s.Critical:return"blue";case $s.Excellent:return"green"}return""}const SO=({dmgValue:s,dmgType:e})=>{const t=TO(e);return M.createElement("div",{className:"damage"+(t?` ${t}`:"")},M.createElement("span",{className:"border"},s),M.createElement("span",{className:"value"},s))},CO=M.memo(({entity:s})=>{const{refresh:e}=Yt(),t=bt(),i=ve.useRef(null),r=[...ve.useMemo(()=>t.identifiableQuery.with("ownedBy","visualDamage"),[t]).where(a=>a.ownedBy===s.id)].reverse();return te("onVisualDamageSpawned",a=>{a.ownedBy===s.id&&e()}),te("onVisualDamageDestroyed",a=>{a.ownedBy===s.id&&e()}),hr(s.id,i,-12,-3),M.createElement("div",{ref:i,className:"visual-damage"},r.map(a=>M.createElement(SO,{key:a.id,dmgValue:a.visualDamage.dmg,dmgType:a.visualDamage.type})))});const fg="pPlayerStats",IO=["pTrainerStrengthNpc","pTrainerHpNpc"],RO="pArena",bO=4,xO=M.memo(()=>{const s=bt(),{refresh:e}=Yt(),[t,i]=ve.useState(!1),n=s.entityByIdentifier.get(fg),r=s.entityByIdentifier.get(RO),a=s.playerEntity,o=IO.map(f=>s.entityByIdentifier.get(f)),l=()=>{const f=!!r&&!!r.purchased&&o.some(p=>p.unlocked&&g.Distance(p.transform.position,s.playerEntity.transform.position)<bO);t!==f&&i(f)};te("onInteractiveAreaEntered",e),te("onInteractiveAreaLeft",e),te("onPlayerMovementStarted",e),te("onPlayerMovementFinished",e),te("onVillageModeChanged",e),te("onPurchased",e),te("onAttributesChanged",f=>{f.entity===a&&e()});const c=ve.useRef(null);if(hr(fg,c,-30,0),te("onPositionUpdated",f=>{f===s.playerEntity&&(e(),l())}),s.villageMode!=="peacetime"||n==null||(l(),!t))return null;const u=a.attributesLevel;let h=0,d=0;return u&&(u.attStr&&(h=u.attStr),u.attVit&&(d=u.attVit)),M.createElement("div",{ref:c,className:"player-stats"},M.createElement("div",{className:"parameters"},M.createElement("div",{className:"parameter"},h,M.createElement("img",{src:ot("iStrength"),alt:"strength"})),M.createElement("div",{className:"parameter"},d,M.createElement("img",{src:ot("iHp"),alt:"health"}))))}),MO=()=>{const s=bt(),{refresh:e}=Yt(),t=s.identifiableQuery.with("itemHolder","screenPosition","enabled").entities,i=s.sceneEntity,n=s.identifiableQuery.with("itemProducer","purchased","enabled").entities,r=s.npcsWithTasksQuery.with("screenPosition","enabled").entities,a=s.visualMapObjectsQuery.with("bonusResource","screenPosition").entities,o=s.identifiableQuery.with("currentHp","maxHp","screenPosition","alive").entities,l=s.identifiableQuery.with("currentHp");if(te("onHpUpdated",e),te("onBonusResourceSpawned",e),te("onBonusResourceRemoved",e),te("onInventoryUpdated",e),te("onPauseChanged",e),te("onPurchased",e),te("onVillageModeChanged",e),te("onEnabled",({entity:d})=>{(d.itemHolder!=null||d.itemProducer!=null||d.npc!=null)&&e()}),te("onZoneLoaded",e),i.paused!=null)return null;const c=s.lvlManager;if(!c)return null;const u=c.currentZone;if(!u)return null;const h=s.villageMode;return M.createElement("div",{className:"world-hud"},n.filter(d=>d.zone===u).map(d=>M.createElement(uO,{key:d.id,entityId:d.id})),t.filter(d=>d.zone===u).map(d=>M.createElement(hO,{key:d.id,entity:d})),a.filter(d=>d.zone===u).map(d=>M.createElement(pO,{key:d.id,entity:d})),r.filter(d=>d.zone===u).map(d=>M.createElement(dO,{key:d.id,entity:d})),r.filter(d=>d.zone===u).map(d=>M.createElement(fO,{key:d.id,entity:d})),h==="war"&&o.map(d=>M.createElement(AO,{key:d.id,entity:d})),l.entities.map(d=>M.createElement(CO,{key:d.id,entity:d})),M.createElement(_O,null),M.createElement(yO,null),M.createElement(xO,null),M.createElement(EO,null))};function PO(s){const e=s.identifiableQuery.with("model","zone");return()=>{const t=s.sceneEntity.scene,i=e.entities,n=s.lvlManager;if(!n)return;const r=n.currentZone;r&&i.forEach(a=>{if(a.removing!=null||a.zone!==r)return;const o=a.model,l=t.getInstanceById(a.id);if(l!=null){o.visual=l;return}t.instantiateModel({id:a.id,modelKey:o.key,variant:o.variant,shadow:o.shadow})})}}function DO(s){const e=s.with("transform","model","zone");return()=>{const t=s.sceneEntity.scene,i=s.lvlManager;if(i==null)return;const n=i.currentZone;let r=!1;for(const a of e){const o=a.model.visual;if(o===void 0||a.zone!==n)continue;const l=a.transform.position,c=a.transform.rotation,u=a.transform.scaling;r=!1,o.model.rotationQuaternion!==null&&(o.model.rotation=o.model.rotationQuaternion.toEulerAngles(),o.model.rotationQuaternion=null);let h=o.model.position;a.enabled===void 0?h.y!==1e5&&(o.model.unfreezeWorldMatrix(),h.y=1e5,r=!0):((h.x!==l.x||h.z!==l.z||h.y!==l.y)&&(o.model.unfreezeWorldMatrix(),h.copyFrom(l),r=!0),o.model.rotation.y!==c.y&&(o.model.unfreezeWorldMatrix(),o.model.rotation.y=c.y,r=!0),u!==void 0&&(h=o.model.scaling,(h.x!==u.x||h.y!==u.y||h.z!==u.z)&&(o.model.unfreezeWorldMatrix(),h.copyFrom(u),r=!0))),r&&(t.forceModelToUpdate(o.model),o.model.freezeWorldMatrix())}}}function OO(s){const e=s.with("keyboardInput","enabled"),t=new Set;return document.addEventListener("keydown",i=>{t.add(i.code)}),document.addEventListener("keyup",i=>{t.delete(i.code)}),s.bus.onVisibilityChanged.add(i=>{i.visible||t.clear()}),window.addEventListener("blur",()=>{t.clear()}),()=>{e.entities.forEach(i=>{i.keyboardInput.pressedKeys=t})}}function wO(s){const e=s.with("keyboardInput","enabled"),t=s.with("mouseInput","enabled"),i=s.activeCamerasQuery,n=g.Zero(),r=g.Zero(),a=g.Zero(),o=g.UpReadOnly,l=ee.Identity(),c=ur(s,"zVillage","playerPointerEntityId","playerPointer",g.Zero(),{rotY:0,scaling:g.One().set(.3,3,.3)},{animateRotation:{duration:Math.PI*2}});let u=!1;return s.bus.onZoneUnLoaded.add(()=>{const h=s.playerEntity;h&&(s.removeComponent(h,"navMoveToPoint"),s.removeComponent(c,"enabled"))}),s.bus.onGroundPointClicked.add(h=>{const d=h.point,f=s.playerEntity;if(!f)return;const p=f.gridMap;if(!p)return;if(i.entities[0].cameraCinematic!=null||f.playerInServiceBuilding!=null){s.removeComponent(f,"navMoveToPoint"),s.removeComponent(c,"enabled");return}try{const _=p.search(f.transform.position,d,{closest:!0});_.length>1?(c.zone=f.zone,c.transform.position.copyFrom(d),c.transform.position.y=0,s.addComponent(c,"enabled",!0),_[0].copyFrom(f.transform.position),_[_.length-1].copyFrom(d),s.removeComponent(f,"navMoveToPoint"),s.addComponent(f,"navMoveToPoint",{target:d,path:_,ind:1,prevDist:-1}),u||(u=!0,Oe.addDesignEvent("UI:Input:PointToClick"))):(s.removeComponent(f,"navMoveToPoint"),s.removeComponent(c,"enabled"))}catch(_){}}),()=>{const h=s.playerEntity,d=e.entities[0],f=t.entities[0],p=i.entities[0];if(n.setAll(0),h.paused!=null){h.movement.velocity=n;return}if(d!==void 0){const _=d.keyboardInput.pressedKeys,E=_.has("KeyW")||_.has("ArrowUp"),v=_.has("KeyS")||_.has("ArrowDown"),y=_.has("KeyA")||_.has("ArrowLeft"),A=_.has("KeyD")||_.has("ArrowRight"),I=E&&!v,T=v&&!E,F=y&&!A?-1:A&&!y?1:0,L=I?1:T?-1:0;n.copyFromFloats(F,0,L)}if(f!==void 0){const _=f.mouseInput.delta;_!==void 0&&n.copyFromFloats(_.x,0,-1*_.y)}let m=!1;if(p!==void 0)if(m=p.cameraCinematic!==void 0,m)n.setAll(0);else{p.camera.getDirectionToRef(o,r);const E=r;E.y=0,E.normalize(),ee.FromEulerAnglesToRef(0,Math.PI/2,0,l),E.applyRotationQuaternionToRef(l,a);const v=E.scaleInPlace(n.z).addInPlace(a.scaleInPlace(n.x));n.copyFrom(v)}if(h.navMoveToPoint&&n.length()>.01&&(s.removeComponent(h,"navMoveToPoint"),s.removeComponent(c,"enabled")),!m&&h.navMoveToPoint&&h.navMoveToPoint.path){if(s.statsEntity.gameStatistics.movementDistance-h.navMoveToPoint.prevDist<.002){s.removeComponent(h,"navMoveToPoint"),s.removeComponent(c,"enabled");return}else h.navMoveToPoint.prevDist=s.statsEntity.gameStatistics.movementDistance;const E=h.navMoveToPoint.path,v=h.navMoveToPoint.ind,A=E[v].subtract(h.transform.position);A.length()<.2?(h.navMoveToPoint.ind++,h.navMoveToPoint.ind>=E.length?(n.copyFrom(A),s.removeComponent(h,"navMoveToPoint"),s.removeComponent(c,"enabled")):(A.normalize(),n.copyFrom(A))):(A.normalize(),n.copyFrom(A))}else n.normalizeToRef(n);h.movement.velocity=n}}const pg=180/Math.PI,FO=Math.PI/180;function LO(s){const e=s.mapObjectsQuery.with("movement","attributes");let t=!1;const i=g.Zero(),n=ee.Identity(),r=g.Zero(),a=g.Zero();return o=>{const l=s.sceneEntity.scene;for(const c of e){const u=c.player!=null,h=c.movement;h.speed=c.attributes.attTotalMovementSpeed||0,h.speed>0&&(h.speed+=s.globalEffector.attributes.attTotalMovementSpeed||0),h.speed<0&&(h.speed=0);const d=c.transform.position,f=h.speed;h.velocity.scaleToRef(f*o,a);const p=h.velocity.lengthSquared()<.01||f<.01;if(c.stayingTime!=null&&(p?c.stayingTime+=o:c.stayingTime=0),c.movingTime!=null&&(p?c.movingTime=0:c.movingTime+=o),u){const _=s.sounds.find(E=>E.soundKey==="walking");p?t&&(s.bus.onPlayerMovementFinished.notifyObservers({}),t=!1,_&&_.sound.pause()):t||(s.bus.onPlayerMovementStarted.notifyObservers({}),t=!0,_&&_.sound.play())}if(p)continue;if(r.copyFrom(d),r.addInPlace(a),u&&c.gridMap){if(c.gridMap.findNode(d)==null)continue;let E=c.gridMap.findNode(r);if(!E||E.isWall()){r.copyFrom(d),r.addInPlaceFromFloats(a.x,0,0);const v=c.gridMap.findNode(r);r.copyFrom(d),r.addInPlaceFromFloats(0,0,a.z);const y=c.gridMap.findNode(r),A=!v||v.isWall(),I=!y||y.isWall();if(A&&I||(!A&&!I?a.z=0:A?a.x=0:a.z=0,r.copyFrom(d),r.addInPlace(a),E=c.gridMap.findNode(r),!E||E.isWall()))continue}}if(d.addInPlace(a),c.player!=null){const _=a.length();_>0&&(s.statsEntity.gameStatistics.movementDistance+=_)}d.y=l.getGroundHeightAtPosition(d),c.transform.position.copyFrom(d),s.bus.onPositionUpdated.notifyObservers(c),i.copyFrom(h.velocity),i.normalize(),i.scaleInPlace(-1),ee.FromLookDirectionLHToRef(i,g.UpReadOnly,n),n.toEulerAnglesToRef(i);const m=i;if(c.player==null){const _=W.MoveTowardsAngle(c.transform.rotation.y*pg,m.y*pg,o*360)*FO;m.y=_}c.transform.rotation.y=m.y}}}const NO=2;function BO(s){const e=s.activeCamerasQuery.with("cameraFollowPlayer");return()=>{const t=s.playerEntity,i=e.entities[0];if(i==null)return;const n=t.transform.position,r=i.cameraSettings;r!=null&&(r.target.copyFrom(n),r.target.y+=NO)}}const kO=2;function UO(s){const e=s.mapObjectsQuery.with("pickable","item"),t=s.mapObjectsQuery.with("canPickIntoInventory","attributes"),i=g.Zero(),n=g.Zero(),r={};let a=0;return o=>{const l=t.entities;for(const _ of l){let E=r[_.id];E===void 0&&(E=0),E-=o,r[_.id]=E,_.showMaxDuration!==void 0&&(_.showMaxDuration-=o)}if(a++,a%2===0)return;const c=s.playerEntity,u=[...s.entitiesByOwner.get(c.id)||[]].filter(_=>_.item!=null),h=u.reduce((_,E)=>_+E.item.count*Lf(E.item.key).weight,0);let p=(c.attributes.attInventoryTotalCapacity||0)-h,m=!1;for(const _ of e){const E=Lf(_.item.key),v=E.weight>0;for(const y of l){const A=y.player!=null&&_.item.key==="iCoin";if(!(r[y.id]<=0)&&!A)continue;const R=y.attributes,x=R.attTotalPickingDistance||0,L=1/((R.attTotalPickingSpeed||0)/1e3),V=R.attTotalPickCoinsMultiplier||1;if(n.copyFrom(y.transform.position),i.copyFrom(_.transform.position),i.y=n.y,g.DistanceSquared(i,n)>x)continue;if(p<=0&&v){y.showMaxDuration!=null&&(y.showMaxDuration<.1&&s.bus.onShowMaxAppeared.notifyObservers(y),y.showMaxDuration=kO);continue}y.showMaxDuration!=null&&(y.showMaxDuration=0);let ae=v?Math.min(_.item.count,p):_.item.count;_.item.count-=ae,v&&(p-=ae*E.weight),_.item.key==="iCoin"&&(ae=Math.ceil(ae*V));const Ue=u.find(re=>re.item.key===_.item.key),Ve=s.statsEntity.gameStatistics.picked,$e=_.item.key;if(Ve[$e]==null?Ve[$e]=ae:Ve[$e]+=ae,Ue)Ue.item.count+=ae;else{const re=Ra(s,c.id,_.item.key,ae);u.push(re)}s.removeComponent(_,"pickable"),s.removeComponent(_,"willRemoveDelay"),s.addComponent(_,"animatePicking",!0),s.addComponent(_,"animatePickingInUI",!0),A||(r[y.id]=L),m||(A?vt(s,ut.pickCoin):vt(s,ut.pickItem)),m=!0;break}}m&&(s.bus.onInventoryUpdated.notifyObservers(),s.bus.onItemPicked.notifyObservers())}}function VO(s){const e=s.with("removing"),t=s.with("willRemoveDelay");return i=>{const n=s.sceneEntity.scene;for(const r of t)r.willRemoveDelay-=i,r.willRemoveDelay<=0&&(s.removeComponent(r,"willRemoveDelay"),s.addComponent(r,"removing",!0));for(const r of e)if(r!=null&&(s.remove(r),s.bus.onEntityDestroyed.notifyObservers({entity:r}),r.onRemove!=null&&r.onRemove.forEach(a=>a(s,r)),r.id!=null)){n.removeInstanceById(r.id);const a=s.entitiesByOwner.get(r.id);if(a!=null)for(const o of a)s.addComponent(o,"removing",!0)}}}function GO(s){const e=s.with("transform","interactiveArea","zone");return()=>{const t=s.playerEntity,i=t.transform.position,n=e.entities;for(const r of n){const a=ks(r.interactiveArea.radius,2),o=r.interactiveArea.target,l=r.transform.position;if(r.zone===t.zone&&g.DistanceSquared(i,l)<=a){if(r.enabled==null)continue;s.addComponent(r,"playerInInteractiveArea",!0),o.playerInInteractiveArea==null&&(s.bus.onInteractiveAreaEntered.notifyObservers({area:r,entity:o}),s.addComponent(o,"playerInInteractiveArea",!0));continue}s.removeComponent(r,"playerInInteractiveArea"),o.playerInInteractiveArea!=null&&(s.bus.onInteractiveAreaLeft.notifyObservers({area:r,entity:o}),s.removeComponent(o,"playerInInteractiveArea"))}}}function zO(s){const e=s.producersQuery.with("enabled","purchased");return t=>{for(const i of e){const n=i.itemProducer;n.nextStepAt-=t;const r=n.nextStepDelay;if(r!=null){const f=Math.max(n.nextStepAt,0);n.stepProgress=(r-f)/r}if(n.nextStepAt>0)continue;const a=i.attributes,o=a.attTotalProducingSpeed;if(o==null)continue;if(n.willProduceAmount!=null){const f=Math.ceil(n.willProduceAmount*n.outputItemAmountRate);WP(s,i,f,n.animated),n.willProduceAmount=void 0,n.nextStepDelay=void 0,n.stepProgress=void 0;const p=s.statsEntity.gameStatistics;if(p.produced!=null){const m=i.id;p.produced[m]==null?p.produced[m]=f:p.produced[m]+=f}s.bus.onProducerOutputProduced.notifyObservers({id:i.id,amount:f});continue}if(i.connectedWorker!=null&&i.connectedWorker.npcSleeping)continue;const l=s.itemsEntitiesByOwner.get(i.id);if(a.attTotalOutputCapacity!=null&&l!==void 0){let f=0;if(l.forEach(m=>{m.item.key===n.outputItemType&&(f+=m.item.count)}),a.attTotalOutputCapacity-f<1)continue}let c=n.minInputItemsPerStep||1,u=n.maxInputItemsPerStep||1;n.fullPerStep&&(c=u=a.attInventoryTotalCapacity||1);let h=0;if(c>0&&u>0&&n.inputItemType!=null){if(l===void 0){n.nextStepAt=1;continue}let f=0;if(l.forEach(m=>{m.item.key===n.inputItemType&&(f+=m.item.count)}),!(f>=c)){n.nextStepAt=1;continue}for(const m of l){if(m.item.key!==n.inputItemType)continue;const _=Math.min(u-h,m.item.count);if(_===m.item.count?s.remove(m):m.item.count-=_,h+=_,h>=u)break}}else h=1;const d=Math.max(.01,1e3/o);n.nextStepAt=d,n.nextStepDelay=d,!(h<1)&&(n.willProduceAmount=h,s.bus.onProducerItemsUpdated.notifyObservers({id:i.id}))}}}const HO=14,WO=ks(HO,2),XO=D.Identity();function YO(s){const e=s.mapObjectsQuery.with("screenPosition","zone"),t=s.activeCamerasQuery,i=g.Zero();let n=g.Zero();const r=j.Zero(),a=j.Zero();return()=>{const o=t.entities[0],l=s.sceneEntity,c=o.camera,u=l.scene,h=s.playerEntity;if(h==null||c==null||u==null)return;const d=s.lvlManager;if(d==null)return;const f=c.getEngine(),p=c.viewport.toGlobal(f.getRenderWidth(),f.getRenderHeight()),m=u.getTransformMatrix(),_=1/(f._hardwareScalingLevel||1);r.x=h.transform.position.x,r.y=h.transform.position.z,e.entities.forEach(E=>{if(d.currentZone!==E.zone)return;const v=E.transform.position;i.copyFrom(v),E.screenPositionOffset!=null&&i.addInPlace(E.screenPositionOffset),n.setAll(0),a.x=i.x,a.y=i.z;const y=j.DistanceSquared(r,a);let A=WO;E.screenPositionDistSqrt!=null&&(A=E.screenPositionDistSqrt),y<A&&g.ProjectToRef(i,XO,m,p,n),E.screenPosition.x=n.x/_,E.screenPosition.y=n.y/_,s.bus.onEntityScreenPositionUpdated.notifyObservers({id:E.id,screenPosition:E.screenPosition})})}}const na={homeBed:{key:"homeBed",producer:"pHomeMap",price:16,item:"iPlank"},homeTable:{key:"homeTable",producer:"pHomeMap",price:32,item:"iPlank"},homeFireplace:{key:"homeFireplace",producer:"pHomeMap",price:250,item:"iCoin"},homeBath:{key:"homeBath",producer:"pHomeMap",price:500,item:"iCoin"},homeWorkbench:{key:"homeWorkbench",producer:"pHomeMap",price:1e3,item:"iCoin"}},td=["homeBed","homeTable","homeFireplace","homeBath","homeWorkbench"];function KO(s){const e=s.with("interactiveArea","playerInInteractiveArea","transform"),n=Math.PI*2/4;return r=>{for(const{transform:a}of e)a.rotation.y+=n*r}}function QO(s){const e="SM_Item_Saw_01",t=s.producersQuery.with("sawmill","unlocked");let i=null;const n=1.9,r=.3,a=new B("Sawmill_saw_x","z",60,B.ANIMATIONTYPE_FLOAT,B.ANIMATIONLOOPMODE_CYCLE);a.setKeys([{frame:0,value:0},{frame:60,value:0}]);const o=new B("Sawmill_saw_y","y",60,B.ANIMATIONTYPE_FLOAT,B.ANIMATIONLOOPMODE_CYCLE);o.setKeys([{frame:0,value:r},{frame:30,value:-r},{frame:60,value:r}]);let l=null,c=!1;const u=d=>{i!=null&&(i.unfreezeWorldMatrix(),d.forceModelToUpdate(i))},h=g.Zero();return d=>{const f=t.entities[0];if(f==null)return;const m=f.attributes.attTotalProducingSpeed||0,_=s.sceneEntity.scene;if(i==null&&(i=_.getMeshByName(e),u(_),i!=null)){h.copyFrom(i.position);const[E,v]=a.getKeys();E.value=i.position.z-n,v.value=i.position.z+n,l=_.beginDirectAnimation(i.position,[o],0,60,!0,5),l.pause(),i.position.y=-100}if(i!=null&&f.itemProducer.willProduceAmount!=null){if(u(_),c)return;c=!0,i.position.z=h.z,l&&(l.reset(),l.restart()),_.beginDirectAnimation(i.position,[a],0,60,!1,m/1e3).onAnimationEndObservable.addOnce(()=>{c=!1,l&&l.pause(),u(_),i.position.y=-100})}}}function ZO(s){const e="pMillBlades",t=s.producersQuery.with("mill","unlocked");let i=null,n=0;return r=>{const a=t.entities[0];if(a==null)return;const o=s.lvlManager;if(o==null||o.currentZone!==a.zone)return;const c=a.attributes.attTotalProducingSpeed||0,u=s.sceneEntity.scene;if(i==null&&(i=u.getMeshByName(e),i!=null&&(i.unfreezeWorldMatrix(),i.rotationQuaternion=null,i.rotation.y=-Math.PI/2,i.freezeWorldMatrix())),i==null)return;const h=.05*c/1e3,d=a.itemProducer.willProduceAmount!=null,f=.02*r;n+=d?f:-f,n=W.Clamp(n,0,h),n>0&&(i.unfreezeWorldMatrix(),i.rotation.y=-Math.PI/2,i.rotation.z-=n,i.freezeWorldMatrix())}}function qO(s){const t="ship",i="pShipNpc",n=s.producersQuery.with("ship","unlocked");let r=null;const a=new B("Ship_pos","position",60,B.ANIMATIONTYPE_VECTOR3,B.ANIMATIONLOOPMODE_CONSTANT),o=new B("Ship_rot","rotation.y",60,B.ANIMATIONTYPE_FLOAT,B.ANIMATIONLOOPMODE_CONSTANT);let l=!1;const c=d=>{r!=null&&(r.unfreezeWorldMatrix(),d.forceModelToUpdate(r))};function u(){const d=s.lvlManager;if(!d||!d.lvlData)return;const f=d.lvlData.zones.zVillage.waypoints.ship.map(({x:v,y,z:A})=>new g(v*-1,y,A)),p=f.length*2-1,m=Math.floor(60/p),_=new Array(p).fill({});_[0]={frame:0,value:0},_[_.length-1]={frame:60,value:0};for(let v=1;v<f.length;v++){const y=ee.FromLookDirectionLH(f[v].subtract(f[v-1]).normalize(),g.Up()).toEulerAngles().y;_[v]={frame:m*v,value:y};const A=_.length-1-v;A>v&&(_[A]={frame:60-m*v,value:y})}const E=new Array(p).fill({});return f.forEach((v,y)=>{E[y]={frame:m*y,value:v.clone()};const A=E.length-1-y;A>y&&(E[A]={frame:60-y*m,value:v.clone()})}),{posKeys:E,rotKeys:_}}const h=d=>{d.rotationQuaternion=null,d.rotation.setAll(0);const f=u();f&&(a.setKeys(f.posKeys),o.setKeys(f.rotKeys))};return d=>{const f=n.entities[0];if(f==null||s.lvlManager==null)return;const p=s.entityByIdentifier.get(i);if(p==null)return;const _=f.attributes.attTotalProducingSpeed||0,E=s.sceneEntity.scene;if(r==null){if(r=E.getMeshByName(t),r==null)return;h(r),c(E)}if(r==null)return;const v=f.itemProducer.willProduceAmount!=null;if(v?s.removeComponent(p,"enabled"):s.addComponent(p,"enabled",!0),v){if(c(E),l)return;l=!0,E.beginDirectAnimation(r,[a,o],0,60,!1,_/1e3).onAnimationEndObservable.addOnce(()=>{l=!1})}}}function jO(s){const e=s.producersQuery.with("fisherman","unlocked");let t;const i=new g(162,0,142),n=i.clone().addInPlaceFromFloats(0,0,-1.5),r=g.Zero();let a=0,o=!1;const l="pFisherman";return s.bus.onProducerOutputProduced.add(c=>{if(c.id!==l||t==null)return;s.ownedItemsQuery.entities.filter(h=>h.ownedBy===l&&h.item.key==="iFlour"&&h.item.count>0).reduce((h,d)=>h+d.item.count,0)<1&&(o=!1,t.transform.position.copyFrom(r),t.transform.rotation.y=a)}),c=>{const u=e.entities[0];if(u==null)return;if(t==null){t=s.entityByIdentifier.get(u.id+"Npc"),t!=null&&(r.copyFrom(t.transform.position),a=t.transform.rotation.y);return}if(t.model.visual==null)return;if(u.itemProducer.willProduceAmount!=null){if(o)return;o=!0,Cn(s,t,i),Cn(s,t,n)}}}function $O(s){const e=s.identifiableQuery.with("wall","unlocked");let t=!1;return s.bus.onBuildingFinished.add(i=>{i.key==="pWall"&&(t=!0)}),i=>{if(!t||e.entities[0]==null)return;const r=s.sceneEntity.scene,a=s.flag;r.flag==null&&r.createFlag(8,a)}}function JO(s){const e=s.producersQuery.with("baker","unlocked");let t=!1,i=0;return n=>{const r=e.entities[0];if(r==null)return;const a=s.lvlManager;if(a==null)return;const l=s.sceneEntity.scene.bakerSmokePS;if(l==null||!l.isReady())return;if(a.currentZone!==r.zone){t&&(t=!1,l.stop()),i=0;return}if(i-=n,i>0)return;r.itemProducer.willProduceAmount!=null?t||(t=!0,l.reset(),l.start(0)):t&&(t=!1,l.stop()),i=.5}}function e2(s){const e="homeFireplace";let t=!1,i=!1;return n=>{if(!i){const c=s.entityByIdentifier.get(e);i=c!=null&&!!c.purchased;return}const r=s.lvlManager;if(r==null||!na[e])return;const o=s.sceneEntity.scene,l=o.fireplaceSmokePS;if(!(l==null||!l.isReady())){if(r.currentZone!=="zHome"){t&&(t=!1,l.stop());return}t||(t=!0,o.activateNewInstance(l),l.start(0))}}}function t2(s){const e="homeBath";let t=!1,i=!1;return n=>{if(!i){const c=s.entityByIdentifier.get(e);i=c!=null&&!!c.purchased;return}const r=s.lvlManager;if(r==null||!na[e])return;const o=s.sceneEntity.scene,l=o.bathSmokePS;if(!(l==null||!l.isReady())){if(r.currentZone!=="zHome"){t&&(t=!1,l.stop());return}t||(t=!0,o.activateNewInstance(l),l.start(0))}}}function i2(s){const e="pScientistNpc",t=s.producersQuery.with("laboratory","unlocked"),i=3,n=.8,r=[new g(146.5,.1,149)];r.push(r[0].clone()),r.push(r[r.length-1].clone().addInPlaceFromFloats(1.3,0,.6)),r.push(r[r.length-1].clone().addInPlaceFromFloats(0,i,0)),r.push(r[r.length-1].clone().addInPlaceFromFloats(0,0,n)),r.push(r[r.length-1].clone().addInPlaceFromFloats(0,0,0)),r.push(r[r.length-1].clone().addInPlaceFromFloats(0,0,0)),r.push(r[r.length-1].clone().addInPlaceFromFloats(0,0,-n)),r.push(r[r.length-1].clone().addInPlaceFromFloats(0,-i,0)),r.push(r[0].clone()),r.push(r[0].clone());const a=new B("Ship_pos","position",60,B.ANIMATIONTYPE_VECTOR3,B.ANIMATIONLOOPMODE_CONSTANT);let o=0;a.setKeys([{frame:0,value:r[o++]},{frame:2,value:r[o++]},{frame:12,value:r[o++]},{frame:18,value:r[o++]},{frame:24,value:r[o++]},{frame:30,value:r[o++]},{frame:36,value:r[o++]},{frame:42,value:r[o++]},{frame:48,value:r[o++]},{frame:54,value:r[o++]},{frame:60,value:r[o++]}]);const l=new B("Ship_rot","rotation.y",60,B.ANIMATIONTYPE_FLOAT,B.ANIMATIONLOOPMODE_CONSTANT),c=ee.FromLookDirectionLH(r[1].subtract(r[2]).normalize(),g.Up()).toEulerAngles();c.x=c.z=0;const u=ee.FromLookDirectionLH(r[2].subtract(r[1]).normalize(),g.Up()).toEulerAngles(),h=-Math.PI*.05;l.setKeys([{frame:0,value:Math.PI*.75},{frame:1,value:c.y},{frame:12,value:c.y},{frame:13,value:h},{frame:24,value:h},{frame:25,value:Math.PI*.5},{frame:36,value:Math.PI*.5},{frame:42,value:h},{frame:48,value:h},{frame:49,value:u.y},{frame:57,value:u.y},{frame:60,value:u.y}]);const d=new B("Npc_anim","velocity.z",60,B.ANIMATIONTYPE_FLOAT,B.ANIMATIONLOOPMODE_CONSTANT),f=1.3;d.setKeys([{frame:0,value:0},{frame:2,value:0},{frame:3,value:f},{frame:11,value:f},{frame:12,value:0},{frame:18,value:0},{frame:19,value:f},{frame:24,value:f},{frame:25,value:0},{frame:36,value:0},{frame:37,value:f},{frame:42,value:f},{frame:43,value:0},{frame:48,value:0},{frame:49,value:f},{frame:53,value:f},{frame:54,value:0},{frame:60,value:0}]);let p=!1,m=null;return _=>{const E=t.entities[0];if(E==null)return;if(m==null){m=s.entityByIdentifier.get(e);return}const y=E.attributes.attTotalProducingSpeed||0,A=s.sceneEntity.scene;if(E.itemProducer.willProduceAmount!=null){if(p)return;p=!0,m.movement.speed=f,m.movement.velocity.set(0,0,f),A.beginDirectAnimation(m.transform,[a,l],0,60,!1,y/1e3).onAnimationEndObservable.addOnce(()=>{p=!1}),A.beginDirectAnimation(m.movement,[d],0,60,!1,y/1e3)}}}function n2(s){const e=s.visualMapObjectsQuery.with("exclamationSign","enabled"),t=.7,i=.3,n=2;let r=0;return a=>{r+=a,e.entities.forEach((o,l)=>{const c=t+(Math.sin(l+r*n)+1)*.5*i;o.transform.position.y=c})}}function s2(s){const e="pSnowFireplace";let t=!1,i=!1;return n=>{if(!i){const u=s.entityByIdentifier.get(e);i=u!=null&&!!u.purchased;return}const r=s.lvlManager;if(r==null)return;const a=s.sceneEntity.scene,o=a.snowFireplaceSmokePS;if(o==null||!o.isReady())return;const l=r.getZone("zSnow");if(!l)return;if(r.currentZone!=="zSnow"){t&&(t=!1,o.stop());return}if(t)return;t=!0;const c=l.pois.poiSnowFireplace;o.emitter=new g(c.point.x,.2,c.point.z),a.activateNewInstance(o),o.start(0)}}function r2(s){const e=s.with("transform","animateRotation","enabled"),t=KO(s),i=QO(s),n=ZO(s),r=qO(s),a=jO(s),o=$O(s),l=JO(s),c=i2(s),u=e2(s),h=t2(s),d=n2(s),f=s2(s),p=function*(){for(;;){const _=s.playerEntity.appearance,E=_!=null?_.parts:void 0,v=E!=null?E[1]:void 0;if(v==null){yield Te(1e3);continue}yield Te($.nextInt(1,4)*1e3),v[1]=1,yield Te(100),v[1]=0}};p();let m=!1;return _=>{const E=s.lvlManager;E!=null&&(m||(s.sceneEntity.scene.onBeforeRenderingGroupObservable.runCoroutineAsync(p()),m=!0),t(_),i(_),n(_),r(_),a(_),o(_),l(_),c(_),d(_),f(_),u(_),h(_),e.entities.forEach(v=>{v.zone===E.currentZone&&(v.transform.rotation.y+=v.animateRotation.duration*_)}))}}const a2=[["attStr","attBaseStr"],["attVit","attBaseVit"]];function o2(s){return 100+s*12}function l2(s){const e=50+10*s;return Math.ceil(e/5)}function c2(s){const e=50+10*s;return Math.ceil(e/3)}function u2(s,e={}){const t=s.reduce((i,n)=>{switch(n.op){case"add":i.adds+=n.value;break;case"mul":i.muls+=n.value;break;case"const":i.consts+=n.value;break;default:throw new Error(`unknown effect op ${n.op}`)}return i},{consts:e.consts||0,adds:e.adds||0,muls:e.muls||1});return t.consts+t.adds*t.muls}const h2=(s,e)=>s.filter(t=>t.effect.attr===e).map(t=>t.effect);function d2(s){const e=s.identifiableQuery.with("attributes","recalculateAttributes"),t=s.effectsQuery.with("enabled"),i=l=>t.entities.filter(c=>c.ownedBy===l),n=s.globalEffector.id;let r=[],a=!1;s.bus.onEnabled.add(l=>{s.globalEffector.id,l.entity.ownedBy===n&&(r.push(l.entity),a=!0)}),s.bus.onEntityDestroyed.add(l=>{l.entity.ownedBy===n&&(r=r.filter(c=>c!==l.entity),a=!0)}),s.bus.onPurchased.add(l=>{l.entity.effect!=null&&(a=!0)});function o(l,c,u,h,d){const f=l.attributes;if(f==null||f[u]==null)return;const p=u2(h2(c,h),{adds:f[u]||0});p!==f[d]&&(f[d]=p,s.bus.onAttributesChanged.notifyObservers({entity:l,attr:d}))}return()=>{for(const l of e){if(!(a||l.recalculateAttributes))continue;const u=i(l.id);if(u.push(...r),o(l,u,"attInventoryBaseCapacity","attInventoryCapacity","attInventoryTotalCapacity"),o(l,u,"attBaseMovementSpeed","attMovementSpeed","attTotalMovementSpeed"),o(l,u,"attBasePickingSpeed","attPickingSpeed","attTotalPickingSpeed"),o(l,u,"attBasePickingDistance","attPickingDistance","attTotalPickingDistance"),o(l,u,"attBasePickCoinsMultiplier","attPickCoinsMultiplier","attTotalPickCoinsMultiplier"),o(l,u,"attBaseOutputCapacity","attOutputCapacity","attTotalOutputCapacity"),o(l,u,"attBaseSupplySpeed","attSupplySpeed","attTotalSupplySpeed"),o(l,u,"attBaseProducingSpeed","attProducingSpeed","attTotalProducingSpeed"),o(l,u,"attBaseMaxDurability","attMaxDurability","attTotalMaxDurability"),o(l,u,"attBaseChoppingSpeed","attChoppingSpeed","attTotalChoppingSpeed"),l.attributesLevel!=null&&l.attributes!=null){const h=l.attributes,d=l.attributesLevel;a2.forEach(f=>{const p=f[0],m=f[1];d[p]!=null&&(h[m]=d[p])}),o(l,u,"attBaseStr","attStr","attTotalStr"),o(l,u,"attBaseVit","attVit","attTotalVit"),h.attTotalVit!=null&&l.maxHp!=null&&(l.maxHp=o2(h.attTotalVit),s.bus.onAttributesChanged.notifyObservers({entity:l,attr:"attMaxHp"})),h.attTotalStr!=null&&(l.minAttackDmg!=null&&(l.minAttackDmg=l2(h.attTotalStr),s.bus.onAttributesChanged.notifyObservers({entity:l,attr:"attMinDmg"})),l.maxAttackDmg!=null&&(l.maxAttackDmg=c2(h.attTotalStr),s.bus.onAttributesChanged.notifyObservers({entity:l,attr:"attMaxDmg"})))}l.recalculateAttributes=!1}a=!1}}let Ln=null,fl=null;const f2=150;function p2(s,e){const t=lm("clickToPointPlain",{size:300});t.position.x=122,t.position.z=122,t.rotationQuaternion=null,t.rotation.x=Math.PI/2,t.isVisible=!1,t.isPickable=!0,e.pointerUpPredicate=n=>t===n,e.addMesh(t);let i=0;e.onPointerObservable.add(n=>{if(n.type===Ce.POINTERDOWN&&(i=Date.now()),n.type===Ce.POINTERUP){const r=Date.now()-i;if(n.pickInfo){const a=n.pickInfo.pickedPoint;if(a&&n.pickInfo.pickedMesh===t&&r<f2){const o=s.with("mouseInput").entities[0];if(o){const l=o.mouseInput.delta;if(l&&Math.abs(l.x)+Math.abs(l.y)>3)return}a.y=0,s.bus.onGroundPointClicked.notifyObservers({point:a})}}}})}function m2(s){s.with("keyboardInput","enabled");const e=s.with("debug");s.mapInfo;let t=null;return s.bus.onGroundPointClicked.add(({point:i})=>{const n=e.entities[0];n!=null&&n.debug.showAstar}),()=>{if(Ln==null||fl==null)return;const i=s.sceneEntity.scene,n=s.debug;if(n!=null&&n.showAstar&&t==null){t=ha("rect",{width:.9,depth:.9,height:.2},i),t.material=Ln;return}}}function _2(s){const e=s.producersQuery.with("enabled","queuable"),t=s.with("debug");let i=null,n=null,r=null;const a=[],o=new Set;return()=>{if(Ln==null||fl==null)return;const l=t.entities[0];if(l==null||!l.debug.showAstar)return;const u=s.sceneEntity.scene;if(i==null){i=ha("queueSpotBox",{width:.2,depth:.2,height:.5},u);const f=Ln.clone("queueMaterial");f.diffuseColor=G.Blue(),f.alpha=.9,i.material=f;return}if(n==null){n=ha("inQueueSpotBox",{width:.15,depth:.15,height:.5},u);const f=Ln.clone("inQueueMaterial");f.diffuseColor=G.Green(),f.alpha=.8,n.material=f;for(let p=0;p<50;p++){const m=n.createInstance(`in_queue_spot_${p}`);m.alwaysSelectAsActiveMesh=!0,m.position.y=100,a.push(m)}return}if(r==null){r=ha("gainBox",{width:1,depth:1,height:.5},u);const f=Ln.clone("gainMaterial");f.diffuseColor=G.Yellow(),f.alpha=.7,r.material=f;return}a.forEach(d=>{d.position.y=100});let h=0;e.entities.forEach(d=>{const f=d.queuable;if(o.has(d)){f.inQueuePositions.forEach(m=>{a[h].position.copyFrom(m),h++});return}o.add(d),f.spots.forEach((m,_)=>{const E=i.clone(`queue_spot_${m.x}-${m.z}`);E.alwaysSelectAsActiveMesh=!0,E.material=E.material.clone(E.material.name),E.material.diffuseColor.scaleInPlace(1-.15*_),E.position.copyFrom(m)});const p=d.itemProducer.outputGainingArea;if(p){const m=r.createInstance(`gain_area_${d.id}`);m.alwaysSelectAsActiveMesh=!0,m.position.y=.1,m.position.x=p.x-p.width/2,m.position.z=p.z-p.height/2,m.scaling.set(p.width,1,p.height),m.scaling.x=Math.max(.2,m.scaling.x),m.scaling.z=Math.max(.2,m.scaling.z)}u.forceModelToUpdate(i),u.forceModelToUpdate(r),f.inQueuePositions.forEach(m=>{a[h].position.copyFrom(m),h++})}),u.forceModelToUpdate(n)}}function g2(s){const e=s.with("showRect","rect"),t=m2(s),i=_2(s);let n=!1;return()=>{t(),i();const r=s.sceneEntity.scene;n||(p2(s,r),n=!0);const a=s.debug;if(a!=null&&a.showAstar){Ln==null&&(Ln=new J("rectMatGreen",r),Ln.alpha=.1,Ln.diffuseColor=G.White(),fl=Ln.clone("rectMatRed"),fl.diffuseColor=G.Red());for(const{enabled:o,rect:l}of e){if(l.mesh){l.mesh.material=o?Ln:fl;continue}const{x:c,z:u,width:h,height:d}=l,f=ha("rect",{width:h,depth:d,height:.1},r);f.position.x=c+h/2,f.position.z=u+d/2,f.position.y=.1,f.material=Ln,l.mesh=f}}}}function E2(s){const e=s.with("animatePickingInUI","item");return t=>{e.entities.forEach(i=>{s.removeComponent(i,"animatePickingInUI"),i.item.key==="iCoin"&&dv()})}}function v2(s){const e=s.with("animatePicking","transform","model"),t=E2(s);return i=>{const r=s.sceneEntity.scene;for(const a of e)s.removeComponent(a,"animatePicking"),a.transform.scaling==null&&(a.transform.scaling=g.One()),Hr(r,a.transform,"scaling",g.Zero(),.3).onAnimationEndObservable.addOnce(()=>{s.addComponent(a,"removing",!0)}),Hr(r,a.transform,"position",a.transform.position.clone().addInPlaceFromFloats(0,.5,0),.3);t(i)}}class y2{constructor(e,t,i,n){X(this,"dragStart");X(this,"touchId");X(this,"active");X(this,"value");X(this,"delta");X(this,"handleDown",e=>{this.active=!0,this.delta={x:0,y:0},this.dragStart={x:e.clientX,y:e.clientY}});X(this,"handleMove",e=>{if(!this.active||!this.dragStart)return;this.delta.x=e.clientX-this.dragStart.x,this.delta.y=e.clientY-this.dragStart.y;const t=this.delta.x,i=this.delta.y,n=Math.atan2(i,t),r=Math.min(this.maxDistance,Math.hypot(t,i)),a=r*Math.cos(n),o=r*Math.sin(n);this.stick&&(this.stick.style.transform=`translate3d(${a}px, ${o}px, 0px)`);const l=r<this.deadzone?0:this.maxDistance/(this.maxDistance-this.deadzone)*(r-this.deadzone),c=l*Math.cos(n),u=l*Math.sin(n),h=parseFloat((c/this.maxDistance).toFixed(4)),d=parseFloat((u/this.maxDistance).toFixed(4));this.value={x:h,y:d}});X(this,"handleUp",e=>{this.active&&(this.stick&&(this.stick.style.transform="",this.stick.style.display="none"),this.value={x:0,y:0},this.touchId=null,this.active=!1,this.delta={x:0,y:0},this.dragStart=null)});this.scene=e,this.maxDistance=t,this.deadzone=i,this.stick=n,this.dragStart=null,this.touchId=null,this.active=!1,this.value={x:0,y:0},this.delta={x:0,y:0},e.onPointerObservable.add(r=>{switch(r.type){case Ce.POINTERDOWN:this.handleDown(r.event);break;case Ce.POINTERMOVE:this.handleMove(r.event);break;case Ce.POINTERUP:this.handleUp(r.event);break}})}}const A2=8,T2=64;function S2(s){const e=s.with("mouseInput","enabled");let t=null;return()=>{const i=s.sceneEntity.scene;if(t==null){t=new y2(i,T2,A2);return}e.entities.forEach(n=>{const r=n.mouseInput;r.startedAt=t.dragStart||void 0,r.delta=t.active?t.value:void 0})}}const mg=.2;function C2(s,e,t,i,n,r){const a=[{frame:0,value:e[t]},{frame:30,value:i},{frame:60,value:n}],o=B.ANIMATIONTYPE_VECTOR3,l=new B("InterpolateValueAction",t,60,o,B.ANIMATIONLOOPMODE_CONSTANT);return l.setKeys(a),s.beginDirectAnimation(e,[l],0,60,!1,1/r)}function I2(s){const e=s.with("itemHolder","playerInInteractiveArea","transform","enabled");let t=0;const i=g.Zero();return n=>{const r=s.playerEntity,a=s.sceneEntity.scene;if(r.movement.velocity.lengthSquared()>.1)return;t-=n;let o=!1;i.copyFrom(r.transform.position);const l=n/.008,c=s.playerItems.filter(d=>d.item.count>0),u=s.coinsCount;for(const d of e){const f=d.itemHolder.type,p=c.filter(T=>T.item.key===f),m=p.reduce((T,R)=>T+R.item.count,0);let _=d.itemHolder.max-d.itemHolder.val;if(_<.001)continue;let E=0;_>500?E=Math.floor(5*l):_>200?E=Math.floor(3*l):_>50?E=Math.floor(2*l):E=Math.min(1,Math.floor(l));const v=Math.min(m,Math.max(E,1));if(m<v||_<v||v<1e-4)continue;_-=v,d.itemHolder.val+=v;let y=v;for(const T of p){for(;T.item.count>0&&y>0;)T.item.count--,y--;if(y<1)break}if(d.itemHolder.onValueChanged!=null&&d.itemHolder.onValueChanged.forEach(T=>T(s,d)),o=!0,_<.001&&d.itemHolder.onMaxed!=null&&d.itemHolder.onMaxed.forEach(T=>T(s,d)),t>0)continue;t=mg+$.nextFloor(.05,.1);const A=s.add({id:"supply"+$.id(),transform:{position:i.clone().addInPlaceFromFloats(0,.5,0),rotation:{y:$.nextFloor(0,2*Math.PI)},scaling:g.One().scaleInPlace(.7)},model:{key:f},enabled:!0}),I=g.Lerp(i,d.transform.position.clone().addInPlaceFromFloats(0,0,0),.5);C2(a,A.transform,"position",I.addInPlaceFromFloats(0,2,0),d.transform.position.clone().addInPlaceFromFloats(0,.5,0),mg).onAnimationEndObservable.addOnce(()=>{s.addComponent(A,"removing",!0)}),vt(s,ut.supplyItem)}if(!o)return;const h=s.coinsCount;u>0&&h<1&&s.bus.onRunOutOfCoins.notifyObservers({cause:"itemHolder"}),s.bus.onInventoryUpdated.notifyObservers()}}function R2(s){const e=s.mapObjectsQuery.with("pickable","effect"),t=g.Zero();return i=>{const n=s.playerEntity;if(n==null)return;const r=n.attributes.attTotalPickingDistance||0,a=n.transform.position;let o=!1;for(const l of e){const c=l.effect;t.copyFrom(l.transform.position),t.y=a.y,!(g.Distance(t,a)>r)&&(s.removeComponent(l,"pickable"),s.addComponent(l,"animatePicking",!0),It(s,pa(s,n,c)),o=!0)}o&&(s.bus.onInventoryUpdated.notifyObservers(),s.bus.onEffectsUpdated.notifyObservers({}))}}const b2=g.One().scaleInPlace(2);function x2(s){const e=s.identifiableQuery.with("effectSpawn","rect"),t=s.identifiableQuery.with("effect","ownedBy");return i=>{const n=s.sceneEntity;if(n==null)return;const r=n.scene;for(const{effectSpawn:a,id:o,rect:l}of e){if(a.nextSpawnDelay-=i*1e3,a.nextSpawnDelay>0)continue;if(t.entities.filter(p=>p.ownedBy===o).length>0){a.nextSpawnDelay=3e3;continue}a.nextSpawnDelay=a.delay;const{x:u,z:h}=$.nextPointInRect(l),d=new g(u,.2,h),f=s.add({id:"effect_item_"+$.id(),transform:{position:d,rotation:{y:$.nextFloor(0,Math.PI*2)},scaling:g.Zero()},effect:a.effect,model:{key:a.effect.attr},ownedBy:o,animateRotation:{duration:Math.PI},enabled:!0});Hr(r,f.transform,"scaling",b2,.2).onAnimationEndObservable.addOnce(()=>s.addComponent(f,"pickable",!0))}}}function M2(s){const t=s.tasksQuery.without("taskDone"),i=t.with("taskActive");return n=>{const r=i.entities[0];if(r==null){const a=t.entities.filter(o=>!o.taskDone).sort((o,l)=>o.task.order-l.task.order)[0];if(!a||a.task.startConditions.some(o=>!o(s)))return;s.addComponent(a,"taskActive",!0),a.task.onStart!=null&&a.task.onStart.forEach(o=>o(s)),s.bus.onTaskUpdated.notifyObservers({entity:a});return}if(r){const a=r.task;a.finishConditions.every(o=>o(s))&&(s.removeComponent(r,"taskActive"),s.addComponent(r,"taskDone",!0),a.onFinish&&a.onFinish.forEach(o=>o(s)),s.bus.onTaskUpdated.notifyObservers({entity:r}),Oe.addDesignEvent("UI:TaskCompleted:"+(a.op||"unk"),1));return}}}function P2(s){const e=s.npcsWithTasksQuery.with("unlocked","attributes","enabled"),t=e.with("npcEmptyBehaviour");return i=>{const n=s.statsEntity;if(n!=null){for(const r of e){r.npcFSM!=null&&r.npcFSM.update(i);const a=r.npcTasksList[0];a!=null&&(a.activeDuration==null?a.activeDuration=i:a.activeDuration+=i)}for(const r of t){const a=r.npcTasksList[0];if(a!=null)if(a.finished)r.npcTasksList.shift(),s.bus.onNpcTasksUpdated.notifyObservers({npcEntity:r});else{switch(a.type){case"moveTo":{const o=s.add({transform:{position:a.follow?a.pos.clone():a.pos,rotation:{y:0}}});s.addComponent(r,"target",o),s.addComponent(r,"npcMoveToTargetBehaviour",!0);break}case"setOrder":{s.addComponent(r,"npcSetOrderBehaviour",!0);break}case"transferItem":{s.addComponent(r,"npcTransferItemsBehaviour",!0);break}case"findItem":{s.addComponent(r,"npcFindItemBehaviour",!0);break}case"checkout":{s.addComponent(r,"npcCheckoutBehaviour",!0);break}case"moveOut":{a.finished=!0,s.addComponent(r,"removing",!0),n.gameStatistics.servedClients++,r.npcTasksList.shift(),s.bus.onNpcTasksUpdated.notifyObservers({npcEntity:r});break}case"waiting":{s.addComponent(r,"npcWaitingBehaviour",!0);break}case"inQueue":{s.addComponent(r,"npcQueueBehaviour",!0);break}case"gainUsage":{s.addComponent(r,"npcGainUsageBehaviour",!0);break}case"startSleeping":{s.addComponent(r,"npcSleeping",!0),a.finished=!0,r.appearance!=null&&r.appearance.parts.find(o=>{if(o[0]==="Eyes")return o[1]=1,!0}),s.bus.onNpcStartSleep.notifyObservers(r);return}case"stopSleeping":{s.removeComponent(r,"npcSleeping"),r.appearance!=null&&r.appearance.parts.find(o=>{if(o[0]==="Eyes")return o[1]=0,!0}),a.finished=!0,s.bus.onNpcStopSleep.notifyObservers(r);return}case"clearOwnedItems":{s.ownedItemsQuery.entities.forEach(o=>{o.removing==null&&o.ownedBy===r.id&&s.addComponent(o,"removing",!0)}),a.finished=!0;return}case"chop":{s.addComponent(r,"npcChoppingBehaviour",!0);break}default:{console.warn("not implemented type of task:"+a.type);break}}s.removeComponent(r,"npcEmptyBehaviour")}}}}}const D2=.1;function O2(s,e,t,i,n,r){const a=[{frame:0,value:e[t]},{frame:30,value:i},{frame:60,value:n}],o=B.ANIMATIONTYPE_VECTOR3,l=new B("InterpolateValueAction",t,60,o,B.ANIMATIONLOOPMODE_CONSTANT);return l.setKeys(a),s.beginDirectAnimation(e,[l],0,60,!1,1/r)}function w2(s){const e=s.producersQuery.with("playerInInteractiveArea","purchased","enabled");let t=0,i=0;return n=>{const r=s.playerEntity;if(r==null)return;const a=s.sceneEntity;if(a==null)return;const o=a.scene;if(i-=n,t-=n,t>0)return;const l=s.statsEntity.gameStatistics,c=[r.id],u=r.transform.position,d=1/((r.attributes.attTotalSupplySpeed||0)/1e3);for(const{itemProducer:f,id:p,attributes:m,transform:_}of e){const E=f.inputItemType;if(E==null)continue;if(f.fullPerStep&&f.willProduceAmount!=null)return;const v=m.attInventoryTotalCapacity||0,y=s.ownedItemsQuery.entities.filter(ne=>ne.ownedBy===p&&ne.item.key===E),A=y.reduce((ne,ae)=>ne+ae.item.count,0);if(v-A<1)continue;const T=s.ownedItemsQuery.entities.filter(ne=>E!==ne.item.key?!1:c.includes(ne.ownedBy)),R=1;let x=0,F=R;for(const ne of T){const ae=Math.min(F,ne.item.count);if(ae===ne.item.count?s.remove(ne):ne.item.count-=ae,x+=ae,F-=ae,x>=R)break}if(x<1)continue;l.supplied[p]==null?l.supplied[p]=x:l.supplied[p]+=x,f.stackableInput&&y.length>0?y[0].item.count+=x:Ra(s,p,E,x),s.bus.onInventoryUpdated.notifyObservers(),s.bus.onProducerItemsUpdated.notifyObservers({id:p}),t=d;const L=p;if((L==="pLaboratory"||L==="pCaveCrystal"||L==="pTrainerStrengthNpc"||L==="pTrainerHpNpc")&&(t=.025),i>0)continue;vt(s,ut.supplyItem),i=D2+$.nextFloor(.05,.1);const V=ur(s,r.zone,"supply"+$.id(),E,u.clone().addInPlaceFromFloats(0,.5,0),{rotY:$.nextFloor(0,2*Math.PI),scaling:g.One()},{enabled:!0}),Z=g.Lerp(u,_.position.clone().addInPlaceFromFloats(0,0,0),.5);O2(o,V.transform,"position",Z.addInPlaceFromFloats(0,2,0),_.position.clone().addInPlaceFromFloats(0,.5,0),.3).onAnimationEndObservable.addOnce(()=>{s.addComponent(V,"removing",!0)})}}}function F2(s){const e=s.identifiableQuery.with("purchased").without("unlocked");return()=>{for(const t of e)s.addComponent(t,"unlocked",!0),t.removeOnUnlock!=null&&t.removeOnUnlock.forEach(i=>{s.addComponent(i,"removing",!0)}),t.onUnlock!=null&&t.onUnlock.forEach(i=>i(s,t)),s.bus.onEntityUnlocked.notifyObservers(t)}}function L2(s){const e=s.activeCamerasQuery;return t=>{for(const i of e){const n=i.camera,r=i.cameraSettings;r.alphaSpeed!=null?n.alpha=W.Lerp(n.alpha,r.alpha,r.alphaSpeed*t):n.alpha=r.alpha,r.betaSpeed!=null?n.beta=W.Lerp(n.beta,r.beta,r.betaSpeed*t):n.beta=r.beta,r.radiusSpeed!=null?n.radius=W.Lerp(n.radius,r.radius,r.radiusSpeed*t):n.radius=r.radius,r.targetSpeed!=null?g.SlerpToRef(n.target,r.target,r.targetSpeed*t,n.target):n.target.copyFrom(r.target)}}}const N2=""+new URL("emoji_hi-0626bdec.png",import.meta.url).href;function B2(s){s.sort(()=>Math.random()-.5)}const Xf=new g(125,0,133),k2=[new g(132,0,128)],_g=[new g(140,0,129.5)],gg=[new g(143,0,134)],U2=[new g(140,0,135)],V2=[new g(136,0,140)],G2=[new g(133,0,140)],z2=[new g(129,0,148)],H2=[new g(126,0,144)],W2=()=>[{type:"moveTo",pos:new g(124,0,130).addInPlaceFromFloats($.nextFloor(0,2),0,$.nextFloor(0,1))}],X2=()=>[{type:"moveTo",pos:Xf.clone().addInPlaceFromFloats($.nextFloor(.1,1),0,-1)},{type:"moveTo",pos:Xf.clone().addInPlaceFromFloats($.nextFloor(-2,2),0,-4)},{type:"moveOut"}];function Ss(s,e,t,i,n,r){const a=[...n.map(o=>({type:"moveTo",pos:o.clone()})),{type:"inQueue",at:t},{type:"gainUsage",at:t}];return r!=null&&a.push({type:"moveTo",pos:r.clone()}),a.push({item:s,type:"transferItem",count:e,fromOwnerId:t.id,toOwnerId:i}),a.push(...[...n].reverse().map(o=>({type:"moveTo",pos:o.clone()}))),a}const Y2=()=>[{type:"moveTo",pos:Xf.clone()},{type:"checkout"},...X2()],K2=2,Q2=2.5;function Z2(s){const e=s.identifiableQuery.with("market","enabled","purchased"),t=s.identifiableQuery.with("hut1","enabled","purchased"),i=s.identifiableQuery.with("hut2","enabled","purchased"),n=s.identifiableQuery.with("npcSpawn","rect","zone"),r=s.identifiableQuery.with("npc","ownedBy"),a=s.queuableProducersQuery.with("sawmill","enabled","purchased"),o=s.queuableProducersQuery.with("wheatGarden"),l=s.queuableProducersQuery.with("appleGarden"),c=s.identifiableQuery.with("well"),u=s.queuableProducersQuery.with("mill"),h=s.queuableProducersQuery.with("baker"),d=s.queuableProducersQuery.with("winery"),f=s.queuableProducersQuery.with("forge"),p=s.identifiableQuery.with("mine"),m=s.queuableProducersQuery.with("cornField"),_=s.emojisQuery;let E=0;return v=>{const y=a.entities[0];if(y==null)return;const A=o.entities[0];if(A==null)return;const I=c.entities[0];if(I==null)return;const T=u.entities[0];if(T==null)return;const R=l.entities[0];if(R==null)return;const x=h.entities[0];if(x==null)return;const F=d.entities[0];if(F==null)return;const L=f.entities[0];if(L==null)return;const V=p.entities[0];if(V==null)return;const Z=m.entities[0];if(Z==null||e.entities[0]==null)return;const ae=t.entities[0],Ue=i.entities[0],Ve=s.statsEntity;if(Ve==null||s.villageMode!=="peacetime")return;const $e=Ve.gameStatistics;if(E-=v,E>0||s.lvlManager==null)return;const ge=I.unlocked!=null&&A.unlocked!=null,be=ge&&T.unlocked!=null,ze=I.unlocked!=null&&R.unlocked!=null,Ke=x.unlocked!=null&&T.unlocked!=null,Ut=F.unlocked!=null,st=L.unlocked!=null&&V.unlocked!=null,Jt=I.unlocked!=null&&Z.unlocked!=null,Wt=r.entities,ii=ae!=null,$i=Ue!=null;function Ji(){return Ut&&$i?7:ze||Ke?6:ge&&ii?5:4}const en=Ji();for(const vn of n){const Ne=vn.zone,Xe=s.npcGlobalGridMap;if(Wt.filter(yt=>yt.ownedBy===vn.id).length<en){const yt=$.id(),Ge=vn.rect,yn=Ge.x+$.nextFloor(0,Ge.width),Vt=Ge.z+$.nextFloor(0,Ge.height);let P=$e.servedClients<1?1:$.nextInt(1,3);ge&&(P=$.nextInt(2,5));const ie=[Ss("iPlank",P,y,yt,k2,$.nextV3InRect(y.itemProducer.outputGainingArea))];ge&&be?$.nextRandomBool(.4)?ie.push(Ss("iWheat",$.nextInt(1,4),A,yt,_g,$.nextV3InRect(A.itemProducer.outputGainingArea||A.itemProducer.outputArea))):ie.push(Ss("iFlour",$.nextInt(1,2),T,yt,gg,$.nextV3InRect(T.itemProducer.outputGainingArea||T.itemProducer.outputArea))):(ge&&ie.push(Ss("iWheat",$.nextInt(2,5),A,yt,_g,$.nextV3InRect(A.itemProducer.outputGainingArea||A.itemProducer.outputArea))),be&&ie.push(Ss("iFlour",$.nextInt(1,3),T,yt,gg,$.nextV3InRect(T.itemProducer.outputGainingArea||T.itemProducer.outputArea)))),ze&&ie.push(Ss("iApple",$.nextInt(2,5),R,yt,U2,$.nextV3InRect(R.itemProducer.outputGainingArea||R.itemProducer.outputArea))),Ke&&ie.push(Ss("iBread",$.nextInt(1,3),x,yt,V2,$.nextV3InRect(x.itemProducer.outputGainingArea||x.itemProducer.outputArea))),Ut&&ie.push(Ss("iAleBarrel",$.nextInt(1,3),F,yt,G2)),st&&ie.push(Ss("iIron",1,L,yt,z2,$.nextV3InRect(L.itemProducer.outputGainingArea||L.itemProducer.outputArea))),Jt&&ie.push(Ss("iCorn",$.nextInt(1,3),Z,yt,H2,$.nextV3InRect(Z.itemProducer.outputGainingArea||Z.itemProducer.outputArea))),B2(ie),ie.length>1&&(ie.length=$.nextInt(1,ie.length+1)),ie.unshift(W2()),ie.push(Y2());const et=s.add({id:yt,npc:!0,customer:!0,npcEmptyBehaviour:!0,npcTasksList:ie.reduce((Hi,Bs)=>(Hi.push(...Bs),Hi),[]),npcWithEmoji:!0,gridMap:Xe,zone:Ne,transform:{rotation:{y:0},position:new g(yn,0,Vt),scaling:g.One().scaleInPlace(.6)},model:{key:"npc_worker"},attributes:{attBaseMovementSpeed:1.5+$.nextFloor(0,.3),attBasePickingDistance:3},recalculateAttributes:!0,movement:{speed:0,velocity:g.Zero()},stayingTime:0,movingTime:0,ownedBy:vn.id,purchased:!0,appearance:{parts:[["Body",0,($.nextRandomBool()?Ae.colorBrown300:Ae.colorBrown700).clone()],["Eyes",0,Ae.eyesColorDark]],removed:["Weapon"]},screenPosition:j.Zero(),screenPositionOffset:new g(0,2.5,0),lifetime:0,onRemove:[()=>{_.entities.forEach(Hi=>{Hi.removing==null&&Hi.ownedBy===yt&&s.addComponent(Hi,"removing",!0)})}]}),zi=$.nextRandomBool();zi&&et.appearance.parts.push(["Mustache",$.nextInt(0,4),Ae.eyesColor.clone()]),$.nextRandomBool(.8)&&et.appearance.parts.push(["Hair",$.nextInt(0,5),(zi?Ae.eyesColor:Ae.hairColor).clone()]),et.appearance.parts.push(["Pant",$.nextInt(0,2),Ae.colorLeather700.clone()]),E=$.nextFloor(K2,Q2),It(s,et),Br(s,et,N2,3)}}}}const q2=.2;function j2(s){const e=s.npcsWithTasksQuery.with("npcMoveToTargetBehaviour","movement","target"),t=g.Zero(),i=r=>{_s(s,r,"npcMoveToTargetBehaviour")},n=g.Zero();return r=>{e.entities.forEach(a=>{const o=a.npcTasksList[0];if(!o||o.type!=="moveTo")return;const l=!!o.follow;t.copyFrom(a.transform.position);const u=a.target.transform.position;if(l&&a.gridMap!=null&&o.calculatedPath!=null&&g.Distance(o.pos,o.calculatedPath[o.calculatedPath.length-1])>q2&&(o.calculatedPath=void 0,u.copyFrom(o.pos)),a.gridMap!=null&&o.calculatedPath==null){const d=a.gridMap;try{const f=d.search(a.transform.position,u,{closest:!0});f.length>1&&(f[0].copyFrom(t),f[f.length-1].copyFrom(u)),o.calculatedPath=f,o.nextPoint=void 0}catch(f){}}o.calculatedPath!=null&&o.calculatedPath.length>1&&(o.nextPoint==null?(o.nextPoint=1,u.copyFrom(o.calculatedPath[o.nextPoint])):(u.subtractToRef(t,n),n.y=0,n.lengthSquared()>.1||(o.nextPoint++,o.calculatedPath.length<=o.nextPoint||u.copyFrom(o.calculatedPath[o.nextPoint])))),u.subtractToRef(t,n),n.y=0,n.lengthSquared()>.1?(n.normalizeToRef(n),a.movement.velocity.copyFrom(n)):(a.movement.velocity.setAll(0),o.finished=!0,i(a))})}}function fh(s,e,t){if(e.usable){if(e.usedBy!=null&&e.usedBy!==t)return!1;e.usedBy==null&&(s.addComponent(e,"usedBy",t),s.bus.onUsageGained.notifyObservers({owner:t,usableEntity:e}))}return!0}function Yf(s,e){if(e.usable&&e.usedBy!=null){const t=e.usedBy;s.removeComponent(e,"usedBy"),s.bus.onUsageFree.notifyObservers({owner:t,usableEntity:e})}return!0}function $2(s,e){return e.npcSleepPosition!=null&&e.durability!=null&&e.durability<=0?!dm(s):!1}function dm(s){const e=s.entityByIdentifier.get(zl);return!!e&&e.enabled}function fm(){return Oe.isRemoteConfigsReady()?Oe.getRemoteConfigsValueAsString("bonus.coins","")==="1":!1}function Eg(s){return Lf(s.item.key).sellPrice}const J2=20,ew=.3,id=.8;function tw(s){const e=s.npcsWithTasksQuery.with("npcCheckoutBehaviour"),t=s.mapObjectsQuery.with("market","rect");let i=0;return n=>{if(i-=n,i>0)return;const r=t.entities[0];if(r==null)return;const a=s.sceneEntity.scene,o=r.rect,l=s.ownedItemsQuery.entities.filter(c=>c.ownedBy===r.id&&c.item.key==="iCoin");for(const c of e){const u=c.npcTasksList[0];if(u.type!=="checkout"||!fh(s,r,c))continue;const h=[...s.entitiesByOwner.get(c.id)||[]].filter(d=>d.item!=null&&d.item.count>0&&Eg(d)>0);if(h.length>0){const d=h[0];let f=Eg(d);for(;f>0;){if(l.length<J2){const m=$.nextPointInRect(o),_=av(s,c.zone,f,m.x,m.z,!0,!0);s.addComponent(_,"ownedBy",r.id)}else{const m=$.randomElement(l);m.item.count+=f}f--}const p=ur(s,c.zone,$.id(),d.item.key,c.transform.position.clone().addInPlaceFromFloats(0,1.3,0),{rotY:$.nextFloor(0,Math.PI),scaling:g.One().scaleInPlace(.5)},{enabled:!0});Hr(a,p.transform,"position",r.transform.position.clone().addInPlaceFromFloats(0,1,.5),.3).onAnimationEndObservable.addOnce(()=>{s.addComponent(p,"removing",!0)}),d.item.count--,i=ew,d.item.count<1&&(s.addComponent(d,"removing",!0),h.length===1&&(Yf(s,r),u.finished=!0,_s(s,c,"npcCheckoutBehaviour"),i=id))}else Yf(s,r),u.finished=!0,_s(s,c,"npcCheckoutBehaviour"),i=id;return}i=id}}function iw(s){const e=s.with("adviser");return t=>{for(const i of e){const n=i.adviser;for(const r of n.suggestions)r.finished||r.conditions.every(a=>a(s))&&(r.onEnter.forEach(a=>a(s)),r.finished=!0)}}}function nw(s){const e=s.with("outputShelf","ownedBy","zone");return t=>{const i=s.lvlManager;if(i==null)return;const n=e.entities;for(const r of n){if(i.currentZone!==r.zone)return;const a=s.entityByIdentifier.get(r.ownedBy);if(a===void 0||a.id===void 0)continue;const o=a.itemProducer;if(o===void 0)continue;const l=s.itemsEntitiesByOwner.get(a.id);if(l===void 0)continue;let c=0;l.forEach(u=>{if(u.item.key===o.outputItemType&&u.transform!==void 0&&u.pickable!==void 0)for(let h=0;h<u.item.count;h++){const d=r.outputShelf.slots[c];if(d===void 0)return;u.transform.position.copyFrom(d.pos),u.transform.rotation.y=d.rot.y,c++}})}}}function sw(s){const e=s.npcsWithTasksQuery.with("npcWaitingBehaviour");return t=>{for(const i of e){const n=i.npcTasksList[0];n.type==="waiting"&&(n.delay-=t,!(n.delay>0)&&(n.finished=!0,_s(s,i,"npcWaitingBehaviour")))}}}function rw(s){const e=s.visualMapObjectsQuery.with("movement"),t=(n,r)=>r?n.play(!0):n.stop();let i=0;return n=>{if(i++,i%2===0)return;const r=e.entities;for(const a of r){const o=a.model.visual;if(o===void 0)continue;const l=o.animations;if(l===void 0)continue;const c=a.movement.speed,u=a.npc!==void 0,h=a.movement.velocity.lengthSquared()>.02,d=s.itemsEntitiesByOwner.get(a.id),f=d!==void 0&&d.size>0,p=c>2.5,m=ks(1.3,c/3),_=!!a.playAttackAnimation;l.forEach(E=>{if(_&&E.name!=="SwordSlash"){t(E,!1);return}if(E.name==="SwordSlash"){if(_){E.speedRatio=2,t(E,!0);return}let v=2e3;a.attributes!=null&&a.attributes.attTotalChoppingSpeed!=null&&(v=a.attributes.attTotalChoppingSpeed),E.speedRatio=v/967,t(E,!h&&!!a.chopping)}else E.name==="Idle"?t(E,!h&&!a.chopping):E.name==="Run"?(E.speedRatio=m,t(E,h&&p&&(!u||!f))):E.name==="Walk"?(E.speedRatio=m,t(E,h&&!p&&(!u||!f))):E.name==="Walk_Carry"&&(E.speedRatio=m,t(E,h&&u&&f))})}}}const vg=.3;function aw(s){const e=s.npcsWithTasksQuery.with("npcTransferItemsBehaviour"),t=s.identifiableQuery.with("usable"),i={},n=(a,o,l)=>o.type!=="transferItem"?!1:o.transfered!=null&&o.transfered>=o.count?(l!=null&&l.usedBy===a&&Yf(s,l),delete i[a.id],o.finished=!0,_s(s,a,"npcTransferItemsBehaviour"),!0):!1;let r=0;return a=>{const o=e.entities;r++;for(const l of o){const c=l.npcTasksList[0];if(c.type!=="transferItem"||(c.timeFromLastTransferedItem!==void 0&&(c.timeFromLastTransferedItem+=a),i[l.id]===void 0&&(i[l.id]=0),i[l.id]-=a,i[l.id]>0)||r%2===0)continue;const u=c.toOwnerId,h=c.fromOwnerId,d=t.entities.find(A=>A.id===h);if(n(l,c,d)||d!==void 0&&!fh(s,d,l))continue;let f;const p=s.itemsEntitiesByOwner.get(h);if(p!==void 0&&p.forEach(A=>{f===void 0&&A.item.key===c.item&&A.item.count>0&&(A.transform==null||A.pickable!=null)&&(f=A)}),f===void 0)continue;const m=s.entityByIdentifier.get(u),_=s.itemsEntitiesByOwner.get(u);let E=0,v;_!==void 0&&_.forEach(A=>{A.item.key===c.item&&(E++,v=A)});const y=1;if(c.checkTargetFreeSpace&&m.attributes!==void 0){const A=m.attributes.attInventoryTotalCapacity;if(A!==void 0&&E+y>A){i[l.id]=vg;continue}}v!==void 0?v.item.count+=y:v=Ra(s,u,c.item,y),c.timeFromLastTransferedItem=0,i[l.id]=vg,c.transfered==null&&(c.transfered=0),c.transfered+=y,f.item.count-=y,s.bus.onProducerItemsUpdated.notifyObservers({id:h}),s.bus.onProducerItemsUpdated.notifyObservers({id:u}),f.item.count<1&&(s.removeComponent(f,"pickable"),f.transform!=null?s.addComponent(f,"animatePicking",!0):s.addComponent(f,"removing",!0)),n(l,c,d)}}}const yg=.8;function ow(s){const e=s.npcsWithTasksQuery.with("npcSetOrderBehaviour"),t=s.identifiableQuery.with("market","purchased","enabled"),i=s.with("interactiveArea","itemHolder");let n=0;return r=>{if(n-=r,n>0)return;const a=t.entities[0];if(a!=null){for(const o of e){const l=o.npcTasksList[0];if(l.type!=="setOrder")continue;const c=a.usedBy===o;if(!fh(s,a,o)||c)continue;const u=i.entities.find(h=>h.interactiveArea.target===a);if(u!=null){It(s,u),u.itemHolder.type=l.item,u.itemHolder.max=l.count,u.itemHolder.val=0,u.itemHolder.onMaxed=[()=>{s.removeComponent(u,"enabled"),Ra(s,a.id,l.item,l.count),l.finished=!0,s.removeComponent(o,"npcSetOrderBehaviour"),s.addComponent(o,"npcEmptyBehaviour",!0)}],s.bus.onInventoryUpdated.notifyObservers(),n=yg;return}}n=yg}}}const lw=1;function cw(s){let e=0,t=null;const i=()=>{t&&clearTimeout(t),t=setTimeout(()=>Ie(this,null,function*(){const n=s.storage;n!=null&&(yield n.persistentStorage.saveBig(s))}),500)};return s.bus.onBigSaveRequested.add(()=>{i()}),n=>{const r=s.storage;r!=null&&(e-=n,!(e>0)&&(e=lw,r.persistentStorage.save(s)))}}function uw(s){const e=s.with("timer").without("removing");return t=>{e.entities.forEach(i=>{const n=i.timer.duration;i.timer.delay-=t,i.timer.delay<0&&(i.timer.delay=0),i.timer.progress=Math.min((n-i.timer.delay)/n,1),s.bus.onTimerProgressUpdated.notifyObservers(i),i.timer.delay<=0&&(s.bus.onTimerFired.notifyObservers(i),s.addComponent(i,"removing",!0))})}}const Oc=.3,Ag=.2;function hw(s){const e=s.with("arrow","transform","enabled"),t=s.with("attentionPoint","zone"),i=o=>HP(s,o),n=o=>{s.removeComponent(o,"enabled"),s.addComponent(o,"removing",!0)};let r=0,a=!0;return o=>{if(s.sceneEntity==null||s.playerEntity==null)return;const u=t.entities;a?(r+=o*Oc/Ag,r=Math.min(Oc,r),a=r<Oc):(r-=o*Oc/Ag,r=Math.max(0,r),a=r<=0),u.forEach(h=>{if(h.onRemove==null){const d=i(h.zone);d.transform.position.copyFrom(h.attentionPoint),s.addComponent(h,"onRemove",[()=>n(d)])}}),e.entities.forEach((h,d)=>{const f=u[d];h.transform.position.copyFrom(f.attentionPoint),h.transform.position.y+=r})}}function dw(s){const e=s.with("cameraCinematic","cameraSettings","enabled"),t=new Set;let i=0;return n=>{for(const r of e){const a=r.cameraCinematic;t.has(r)||(t.add(r),a.onStart.forEach(F=>F()),i=0,s.bus.onCinematicStarted.notifyObservers({}));const o=a.posPath,l=a.rotPath,c=a.durations,u=c.reduce((F,L)=>F+L,0),h=o.getDistances().reduce((F,L,V,Z)=>(V===Z.length-1||F.push(Z[V+1]-L),F),[]),d=l.getDistances().reduce((F,L,V,Z)=>(V===Z.length-1||F.push(Z[V+1]-L),F),[]);i+=n;const f=i/u;let p=0,m=0,_=0,E=0,v=i;for(const F of c){if(v<=F)break;v-=F,_+=F,p+=h[E],m+=d[E],E++}E=Math.min(E,h.length-1);const A=(i-_)/c[E],I=h[E],T=d[E];p+=I*A,m+=T*A;const R=o.getPointAt(p/o.length());r.cameraSettings.target.copyFrom(R);const x=l.getPointAt(m/l.length());r.cameraSettings.alpha=x.x,r.cameraSettings.beta=x.y,r.cameraSettings.radius=x.z,f>=1&&(s.removeComponent(r,"enabled"),a.onFinish.forEach(F=>F()),t.delete(r),s.bus.onCinematicFinished.notifyObservers({}))}}}const wa=25,fw=40,Fa=2*60,pw=.7,mw=1,_w=1;function gw(s){const e=s.with("ads"),t=s.producersQuery.with("mill","purchased"),i=s.producersQuery.with("pub","purchased"),n=s.producersQuery.with("sawmill","purchased"),r=s.with("market","unlocked"),a=s.with("baker","purchased"),o=s.identifiableQuery.with("interactiveArea","itemHolder","enabled"),l=["x2","speed"];function c(){const _=r.entities[0],E=t.entities[0],v=i.entities[0],y=a.entities[0];if(_==null)return 0;const I=o.entities.filter(Z=>!!Z.enabled&&!!Z.interactiveArea.target&&!Z.interactiveArea.target.purchased&&Z.itemHolder.type==="iCoin").map(Z=>Z.itemHolder.max-Z.itemHolder.val);I.sort((Z,ne)=>ne-Z);let T=I[0];if(!T||T<1)return 0;const R=E!=null,x=v!=null,F=y!=null;T=Math.ceil(T*1.1);const L=x?150:F?90:R?70:25,V=x?15:F?10:R?7:5;return T>L?L:T<V?V:T}const u=()=>{s.add({id:$.id(),ads:!0,adsMovement:!0,willRemoveDelay:wa,onRemove:[()=>s.bus.onAdExpired.notifyObservers({})],onAdsFinished:()=>{const _=s.entityByIdentifier.get(zl);_!=null?_.willRemoveDelay=Fa:It(s,pa(s,s.globalEffector,{attr:"attMovementSpeed",op:"add",value:pw,duration:Fa},zl));const E=s.entityByIdentifier.get(lg);E!=null?E.willRemoveDelay=Fa:It(s,pa(s,s.globalEffector,{attr:"attProducingSpeed",op:"mul",value:mw,duration:Fa},lg))}})},h=_=>{s.add({id:$.id(),ads:!0,adsCoins:_,willRemoveDelay:wa,onRemove:[()=>s.bus.onAdExpired.notifyObservers({})],onAdsFinished:()=>Ie(this,null,function*(){Oe.addResourceEvent(Ii.EGAResourceFlowType.Source,"coins",_,"adsOffer","adsCoinsBonus"),yield Te(300),co(s,_);for(let E=0;E<5;E++)s.add({item:{key:"iCoin",count:1},animatePickingInUI:!0}),yield Te(200)})})},d=()=>{s.add({id:$.id(),ads:!0,adsCoinsMultiplier:!0,willRemoveDelay:wa,onRemove:[()=>s.bus.onAdExpired.notifyObservers({})],onAdsFinished:()=>{const _=s.entityByIdentifier.get(Pu);_!=null?_.willRemoveDelay=Fa:It(s,pa(s,s.globalEffector,{attr:"attPickCoinsMultiplier",op:"mul",value:_w,duration:Fa},Pu))}})};s.bus.onRewardedVideoRequested.add(_=>{Oe.addAdEvent(Ii.EGAAdAction.Clicked,Ii.EGAAdType.RewardedVideo,"custom",_.id),Vf(s)}),s.bus.onRewardedVideoStarted.add(_=>{Oe.addAdEvent(Ii.EGAAdAction.Show,Ii.EGAAdType.RewardedVideo,"custom",_.id)}),s.bus.onRewardedVideoFinished.add(_=>{Oe.addAdEvent(Ii.EGAAdAction.RewardReceived,Ii.EGAAdType.RewardedVideo,"custom",_.id),Jo(s)}),s.bus.onRewardedVideoFailed.add(_=>{Oe.addAdEvent(Ii.EGAAdAction.FailedShow,Ii.EGAAdType.RewardedVideo,"custom",_.id),Jo(s)}),s.bus.onInterstitialAdOpened.add(_=>{Oe.addAdEvent(Ii.EGAAdAction.Show,Ii.EGAAdType.Interstitial,"custom",_.id),Vf(s,"interstitial")}),s.bus.onInterstitialAdClosed.add(_=>{Oe.addAdEvent(Ii.EGAAdAction.Clicked,Ii.EGAAdType.Interstitial,"custom",_.id),Jo(s,"interstitial")}),s.bus.onInterstitialAdFailed.add(_=>{Oe.addAdEvent(Ii.EGAAdAction.FailedShow,Ii.EGAAdType.Interstitial,"custom",_.id),Jo(s,"interstitial")});let f=5,p=2,m=!1;return s.bus.onRunOutOfCoins.add(_=>{fm()||(m=!0),Oe.addDesignEvent("UI:Coins:RunOut"+_.cause,1)}),_=>{if(!Vn.isRewardedVideoAvailable()||s.villageMode!=="peacetime")return;const E=r.entities[0],v=n.entities[0];if(E==null||!s.statsEntity.gameStatistics.picked.iCoin)return;const y=v!=null;if(f-=_,y&&(p-=_),e.entities.length>0){m=!1,p=3;return}if(f>0){if(m&&p<0){m=!1,h(c()),p=10,f=wa+10,s.bus.onAdOffered.notifyObservers({}),Oe.addDesignEvent("UI:AdOffered:coins",1);return}return}f=wa+fw,p=wa,m=!1;const I=l.shift();l.push(I),I==="x2"?d():I==="speed"&&u(),s.bus.onAdOffered.notifyObservers({}),Oe.addDesignEvent("UI:AdOffered:"+I,1)}}function Ew(s){const e=s.with("poiHomeService"),t=s.identifiableQuery.with("hairdresser","unlocked"),i=s.identifiableQuery.with("tailor","unlocked"),n=s.identifiableQuery.with("wall","unlocked"),r=s.with("keyboardInput","enabled"),a=s.with("mouseInput","enabled");s.bus.onInteractiveAreaLeft.add(()=>{o=!1});let o=!1;const l={};s.bus.onBuildingFinished.add(u=>{l[u.key]=!0}),s.bus.onPlayerMovementFinished.add(()=>{if(o)return;const u=e.entities[0],h=t.entities[0],d=i.entities[0],f=n.entities[0],m=(()=>u!=null&&u.playerInInteractiveArea?"home":h!=null&&h.playerInInteractiveArea&&l[h.id]?"hairdresser":d!=null&&d.playerInInteractiveArea&&l[d.id]?"tailor":f!=null&&f.playerInInteractiveArea&&l[f.id]?"wall":null)();m&&(o=!0,s.bus.onArrivedToService.notifyObservers({service:m}))});const c=g.Zero();return u=>{const h=s.playerEntity;if(h.playerInServiceBuilding==null)return;c.setAll(0);const d=r.entities[0],f=a.entities[0];if(d!=null){const{pressedKeys:m}=d.keyboardInput,_=m.has("KeyW")||m.has("ArrowUp"),E=m.has("KeyS")||m.has("ArrowDown"),v=m.has("KeyA")||m.has("ArrowLeft"),y=m.has("KeyD")||m.has("ArrowRight"),A=_&&!E,I=E&&!_,x=v&&!y?-1:y&&!v?1:0,F=A?1:I?-1:0;c.copyFromFloats(x,0,F)}if(f!=null){const{delta:m}=f.mouseInput;m&&c.copyFromFloats(m.x,0,-1*m.y)}const p=-c.x*u*Math.PI;h.transform.rotation.y+=p}}function vw(s){const e=s.with("model","appearance","enabled");let t=()=>{};const i=Ew(s);let n=0;return r=>{if(i(r),n++,n%2!==0)return;let a=!1;const o=e.entities;for(const l of o){a=!1;const c=l.model.visual;if(c==null)continue;const u=c.customizer;if(u==null)continue;const h=l.appearance;h.parts.forEach(d=>{const f=d[0],p=d[1],m=d[2],_=u.activatePart(f,p,m);a=a||_}),h.removed.length>0&&(h.removed.forEach(d=>{u.setPartVisible(d,0,!1),a=!0}),h.removed.length=0),t=u.commitData,a&&t()}}}function yw(s){const e=s.with("lifetime","enabled");return t=>{for(const i of e)i.lifetime+=t,s.bus.onLifetimeUpdated.notifyObservers({entity:i})}}function Aw(s){const e=s.identifiableQuery.with("moveableInArea","rect","enabled"),t=s.mapObjectsQuery.with("movement","enabled");return i=>{for(const n of e){const r=n.rect,a=n.moveableInArea;for(const o of t){const l=o.transform.position;FP(l,r)?a.entities.has(o)||(a.entities.add(o),s.bus.onMoveableAreaEntered.notifyObservers({entity:o}),a.onEnter&&a.onEnter.forEach(u=>u(s,o,n))):a.entities.has(o)&&(a.entities.delete(o),s.bus.onMoveableAreaLeft.notifyObservers({entity:o}),a.onLeft&&a.onLeft.forEach(u=>u(s,o,n)))}}}}const Tw=120,Sw=-.4,nd={type:"rain",duration:40},Cw="rainDirt";function Iw(s){const e=s.with("wheatGarden","enabled","unlocked"),t=s.gameEventsQuery;let i=$.nextInt(25,60);function*n(r){vt(s,ut.heaven),Te(1e3).then(()=>{vt(s,ut.rain)});const a=3,o=1,l=r-a-o,c={x:125,z:128,width:7,height:5},u=-.03,h=-.4,d=ur(s,"zVillage",$.id(),Cw,new g(c.x+c.width/2,h,c.z+c.height/2),{rotY:0,scaling:new g(c.width/12,.35,c.height/11)},{enabled:!0,moveableInArea:{entities:new Set,onEnter:[(f,p,m)=>{const _=m.id+"_effect_"+p.id;It(s,pa(s,p,{attr:"attMovementSpeed",op:"mul",value:Sw},_)),p.recalculateAttributes!=null&&(p.recalculateAttributes=!0)}],onLeft:[(f,p,m)=>{const _=m.id+"_effect_"+p.id,E=s.effectsQuery.entities.find(v=>v.ownedBy===p.id&&v.id===_);E!=null&&(s.remove(E),p.recalculateAttributes!=null&&(p.recalculateAttributes=!0))}]},onRemove:[()=>{const f=d.id+"_effect_";d.moveableInArea.entities.forEach(p=>{const m=f+p.id,_=s.effectsQuery.entities.find(E=>E.ownedBy===p.id&&E.id===m);_!=null&&(s.remove(_),p.recalculateAttributes!=null&&(p.recalculateAttributes=!0))})}]});Hr(s.sceneEntity.scene,d.transform.position,"y",u,a).onAnimationEndObservable.addOnce(()=>{s.addComponent(d,"rect",c)}),yield Te((l+a+o)*1e3),YP(s,ut.rain),s.removeComponent(d,"rect"),Hr(s.sceneEntity.scene,d.transform.position,"y",h,o).onAnimationEndObservable.addOnce(()=>{s.addComponent(d,"removing",!0)})}return r=>{if(e.entities[0]==null)return;const o=s.sceneEntity.scene;if(i-=r,i>0)return;if(t.entities[0]==null){const c=s.add({enabled:!0,gameEvent:nd,onRemove:[()=>{o.stopRainEffect(),i=Tw,s.bus.onGameEventFinished.notifyObservers({entity:c})}],willRemoveDelay:nd.duration});o.playRainEffect(),o.onBeforeRenderObservable.runCoroutineAsync(n(nd.duration)),s.bus.onGameEventStarted.notifyObservers({entity:c})}}}function Rw(s){const e=s.identifiableQuery.with("queuable"),t=g.Zero(),i=g.Zero();let n=0;return r=>{if(n-=r,!(n>0))for(const a of e){const o=a.queuable;for(let l=0;l<o.inQueue.length;l++){const c=o.inQueue[l];t.copyFrom(o.inQueuePositions[l]),i.copyFrom(c.transform.position),t.y=i.y=0,!(g.DistanceSquared(t,i)>.1)&&l===0&&o.exitCondition(s,a,c)&&(o.inQueue.shift(),o.gainingPositionMode==="inOrder"?o.inQueuePositions.pop():o.inQueuePositions.shift(),n=.5)}if(o.pending.length>0){if(o.inQueue.length>=o.spots.length)continue;[...o.pending].forEach((l,c)=>{if(!(o.inQueue.length>=o.spots.length)){if(o.inQueue.push(l),o.gainingPositionMode==="inOrder")o.inQueuePositions.push(o.spots[o.inQueuePositions.length]);else if(o.gainingPositionMode==="random"){const u=o.spots.filter(d=>!o.inQueuePositions.some(p=>g.DistanceSquared(p,d)<.1)),h=$.randomElement(u);o.inQueuePositions.push(h)}o.pending.splice(c,1)}})}}}}function bw(s){const e=s.npcsWithTasksQuery.with("npcQueueBehaviour"),t=g.Zero(),i=g.Zero();return n=>{for(const r of e){const a=r.npcTasksList[0];if(a.type!=="inQueue")continue;const o=a.at.queuable;if(o!=null)if(a.added){if(o.pending.indexOf(r)!==-1)continue;const l=o.inQueue.indexOf(r);if(l>=0){t.copyFrom(o.inQueuePositions[l]),i.copyFrom(r.transform.position),t.y=i.y=0,g.DistanceSquared(t,i)>.1&&(s.removeComponent(r,"npcQueueBehaviour"),s.addComponent(r,"npcEmptyBehaviour",!0),r.npcTasksList.unshift({type:"moveTo",pos:o.inQueuePositions[l].clone()}));continue}}else{o.pending.push(r),a.added=!0;continue}a.finished=!0,_s(s,r,"npcQueueBehaviour")}}}function xw(s){const e=s.npcsWithTasksQuery.with("npcGainUsageBehaviour");return t=>{for(const i of e){const n=i.npcTasksList[0];n.type==="gainUsage"&&(n.at.usable!=null&&!fh(s,n.at,i)||(n.finished=!0,s.removeComponent(i,"npcGainUsageBehaviour"),s.addComponent(i,"npcEmptyBehaviour",!0)))}}}const Mw=""+new URL("icon_money-bag_LP-a8f76bbe.png",import.meta.url).href,Pw=""+new URL("emoji_smile-fbaabe57.png",import.meta.url).href,Dw=""+new URL("emoji_sad-f2fb4a05.png",import.meta.url).href;function Ow(s){const e=s.npcsWithTasksQuery.with("npcWithEmoji"),t=s.emojisQuery,i={};return n=>{for(const r of e){const a=r.npcTasksList,o=a[0];if(o!=null){if(o.type==="inQueue"){if(r.stayingTime==null)continue;if(r.movingTime!=null&&r.movingTime>0){delete i[r.id];continue}if(i[r.id]==null){i[r.id]=$.nextInt(15,60);continue}i[r.id]-=n,i[r.id]<=0&&(Br(s,r,Dw,3),i[r.id]=$.nextInt(15,60))}else if(o.type==="checkout"){const l=t.entities.find(c=>c.ownedBy===r.id&&c.removing==null);l!=null&&s.addComponent(l,"removing",!0)}else if(!a.some(c=>c.type==="transferItem"&&!c.finished)){const c=a.find(h=>h.type==="checkout"&&!h.finished);if(t.entities.find(h=>h.ownedBy===r.id)!=null)continue;c!=null?Br(s,r,Mw,Number.MAX_SAFE_INTEGER):Br(s,r,Pw,Number.MAX_SAFE_INTEGER)}}}}}const ww=""+new URL("bell-6f5794dc.png",import.meta.url).href,Tg=1.1,Sg=Tg*Tg;function Fw(s){const e=s.npcsWithTasksQuery.with("durability","npcSleeping","enabled"),t=s.emojisQuery,i=s.npcsWithTasksQuery.with("manager","unlocked","enabled"),n=g.Zero(),r=g.Zero();return a=>{const o=s.playerEntity,l=i.entities[0];for(const c of e){if(c.npcGoals!=null){const d=c.npcGoals[0];if(d==null||d.type!=="sleeping")continue}const u=c.npcTasksList[0];if(u==null||u.type!=="waiting"||u.finished||u.delay<=.7)continue;if(n.copyFrom(c.transform.position),r.copyFrom(o.transform.position),n.y=r.y=0,g.DistanceSquared(r,n)>Sg)if(l!=null){if(r.copyFrom(l.transform.position),r.y=0,g.DistanceSquared(r,n)>Sg)continue}else continue;u.delay=.6,t.entities.forEach(d=>{d.ownedBy===c.id&&s.addComponent(d,"removing",!0)}),c.durability=c.attributes.attTotalMaxDurability||0,s.bus.onDurabilityChanged.notifyObservers({entity:c}),Br(s,c,ww,.8,"shaker"),vt(s,ut.wakeup),s.bus.onNpcWakeUp.notifyObservers(c)}}}function Lw(s){const e=s.with("soundTrack","soundVolume");let t=!1,i=!1;s.bus.onSettingsChanged.add(()=>n()),s.bus.onVisibilityChanged.add(a=>{i=!a.visible,n()}),s.bus.onRewardedVideoStarted.add(()=>{t=!0,n()}),s.bus.onRewardedVideoFinished.add(()=>{t=!1,n()}),s.bus.onRewardedVideoFailed.add(()=>{t=!1,n()}),s.bus.onInterstitialAdOpened.add(()=>{t=!0,n()}),s.bus.onInterstitialAdClosed.add(()=>{t=!1,n()}),s.bus.onInterstitialAdFailed.add(()=>{t=!1,n()});const n=()=>{const a=s.settingsEntity.settings,o=e.entities,l=o.find(h=>h.soundTrack.id===tv),c=o.find(h=>h.soundTrack.id===iv),u=t||i;a.music&&!u?l.soundTrack.setVolume(l.soundVolume):l.soundTrack.setVolume(0),a.sound&&!u?c.soundTrack.setVolume(c.soundVolume):c.soundTrack.setVolume(0)};let r=!1;return a=>{r||(r=!0,n())}}function Nw(s){const e=s.with("attributes");return t=>{e.entities.forEach(n=>{n.attributes.attTotalMaxDurability!==void 0&&n.durability===void 0&&s.addComponent(n,"durability",n.attributes.attTotalMaxDurability||0)})}}const Bw="crate",kw=[],Uw={iLog:Math.PI/2,iIron:Math.PI/2,iBread:Math.PI/2,iCorn:Math.PI/2},Vw=.2,Gw={iWater:.3,iAleBarrel:.4,iBread:.1,iApple:.3,iFlour:.35,iCrystal:.3},zw=.6,Hw={iBread:1.2,iApple:1,iAleBarrel:.4,iWater:.5,iPlank:.5,iBook:1},Ww="MAX",Xw=.35,Yw=.7,as=g.Zero(),Kw=["pWaterNpc","pLogNpc","pMinerNpc"],Cg=["iOre","iAleBarrel","iWater","iPlank","iIron","iLog","iFlour","iCorn","iBread","iApple","iWheat","iCrystal","iBook","iGem"];function Qw(s,e){const t=s.item.key,i=e.item.key,n=Cg.indexOf(t),r=Cg.indexOf(i);return n-r}function Zw(s){const e={},t=new Set,i=new Set,n=({zone:r,entityId:a,items:o,pPos:l,pY:c,poses:u,dist:h=0,yOffset:d=0,showMax:f=!1,crate:p=!1})=>{o.sort(Qw);const m=Math.cos(c),_=Math.sin(c),E=h*_,v=h*m;let y=d;if(p){const I=c+0,T=a+"crate";i.delete(T),e[T]===void 0?(e[T]={model:s.add({id:T,zone:r,transform:{position:l.clone().addInPlaceFromFloats(E,y,v),rotation:{y:I},scaling:new g(1,1,1)},model:{key:Bw},enabled:!0}),offset:y},t.add(T)):(e[T].model.transform.position.copyFromFloats(l.x+E,l.y+y,l.z+v),e[T].model.transform.rotation.y=I)}let A=0;if(o.forEach(I=>{const T=c+(Uw[I.item.key]||0),R=Gw[I.item.key]||Vw,x=Hw[I.item.key]||zw;let F=I.item.count;for(;F>0;){const L=u?u[A]:void 0,V=I.id+F;if(i.delete(V),e[V]===void 0){const Z=l.clone().addInPlaceFromFloats(E,y,v);e[V]={model:s.add({id:V,transform:{position:Z,rotation:{y:T},scaling:g.One().scaleInPlace(x)},model:{key:I.item.key},enabled:!0,zone:r}),offset:y},t.add(V),L!=null&&Z.addInPlace(L)}else e[V].model.transform.position.copyFromFloats(l.x+E,l.y+y,l.z+v),L!=null&&e[V].model.transform.position.addInPlace(L),e[V].model.transform.rotation.y=T,e[V].model.zone=r;F--,y+=R,A++}}),f){const I=a+"_max";i.delete(I),y+=Yw,e[I]===void 0?(e[I]={model:s.add({id:I,zone:r,transform:{position:l.clone().addInPlaceFromFloats(0,y,0),rotation:{y:0},scaling:g.One().scaleInPlace(Xw)},model:{key:Ww},enabled:!0}),offset:y},t.add(I)):(e[I].model.transform.position.copyFromFloats(l.x,l.y+y,l.z),e[I].model.transform.rotation.y=0,e[I].model.zone=r)}};return r=>{const a=s.lvlManager;if(!a)return;const o=a.currentZone;if(!o)return;const l=s.playerEntity,c=s.playerItems.filter(d=>d.item.key!=="iCoin"&&d.item.count>0),u=s.npcsWithTasksQuery.entities,h=s.producersQuery.entities;if(i.clear(),t.forEach(d=>{i.add(d)}),s.villageMode==="peacetime"){if(u.forEach(d=>{if(d.zone!==o)return;const f=d.id,p=s.itemsEntitiesByOwner.get(d.id);if(p!=null){const m=[];if(p.forEach(_=>{_.item.key!=="iCoin"&&_.item.count>0&&m.push(_)}),m.length>0){const _=!Kw.includes(f);n({zone:d.zone,entityId:d.id,items:m,pPos:d.transform.position,pY:d.transform.rotation.y,dist:.5,yOffset:.8,showMax:!1,crate:_})}}}),c.length>0&&l.playerInServiceBuilding==null){const d=l.transform.position,f=l.transform.rotation.y,p=l.attributes.attInventoryTotalCapacity||0,_=c.reduce((E,v)=>E+v.item.count,0)>=p&&l.showMaxDuration>0;n({zone:o,entityId:l.id,items:c,pPos:d,pY:f,dist:-.4,yOffset:.6,showMax:_,crate:!1})}h.forEach(d=>{if(d.enabled==null||d.unlocked==null||d.zone!==o)return;const f=d.itemProducer.outputItemType,p=s.itemsEntitiesByOwner.get(d.id);if(p!=null){const m=[];if(p.forEach(_=>{_.item.key===f&&_.item.count>0&&m.push(_)}),m.length>0&&d.attributes.attTotalOutputCapacity!=null){const _=d.attributes.attTotalOutputCapacity||0,E=m.reduce((y,A)=>y+A.item.count,0),v=d.well==null&&d.mine==null&&E>=_;as.copyFromFloats(0,0,0),m.forEach(y=>{y.transform!=null&&(as.x+=y.transform.position.x,as.z+=y.transform.position.z,y.transform.position.y>as.y&&(as.y=y.transform.position.y))}),as.x=as.x/m.length,as.z=as.z/m.length,as.y+=.5,n({zone:o,entityId:d.id,items:kw,pPos:as,pY:d.transform.rotation.y,showMax:v})}}})}i.forEach(d=>{const f=e[d];f!==void 0&&(s.addComponent(f.model,"removing",!0),delete e[d],t.delete(d))})}}const Ig=1.5,qw=35,jw=45,$w=3,Jw=new g(122,0,122),Rg=new g(122,0,121),eF=1.5,bg=4,tF=new Set(["iPlank","iWheat","iFlour","iApple","iAleBarrel","iBread","iBook","iCorn","iIron"]),iF=[Ae.skinColorDanger,G.FromHexString("#037224"),G.FromHexString("#72036f")];function nF(s){const e=s.npcsWithTasksQuery.with("thief","unlocked","enabled","appearance"),t=s.npcsWithTasksQuery.with("manager","unlocked","enabled"),i=s.identifiableQuery.with("mill","unlocked");let n=$.nextFloor(5,10);function r(o){switch(o){case"iPlank":return $.nextInt(3,7);case"iWheat":return $.nextInt(5,7);case"iFlour":return $.nextInt(4,8);case"iBread":return $.nextInt(3,9);case"iApple":return $.nextInt(5,10);case"iAleBarrel":return $.nextInt(4,9);default:return 10}}function a(){return $.nextFloor(qw,jw)}return o=>{const l=e.entities[0];if(l==null||i.entities[0]==null||(n-=o,n>0))return;const u=s.playerEntity,h=t.entities[0],d=l.npcTasksList[0];if(d==null){l.attributes.attBaseMovementSpeed=eF,l.recalculateAttributes=!0,l.transform.position.copyFrom(Jw);const m=s.producersQuery.entities.filter(E=>E.unlocked&&E.enabled&&tF.has(E.itemProducer.outputItemType)),_=$.randomElement(m);if(_!=null){l.appearance.parts[0][2]=$.randomElement(iF).clone();const E=r(_.itemProducer.outputItemType),v=_.transform.position.clone();_.itemProducer.outputGainingArea?v.copyFrom($.nextV3InRect(_.itemProducer.outputGainingArea)):_.itemProducer.outputArea&&v.copyFrom($.nextV3InRect(_.itemProducer.outputArea)),s.removeComponent(l,"thiefEmpty"),$h(s,l),Cn(s,l,v),Uf(s,l,_.id,l.id,_.itemProducer.outputItemType,!1,E),Cn(s,l,Rg),$h(s,l),Rs(s,l,1e4)}return}else if(d.type==="waiting"){d.delay=0,n=a(),l.transform.position.y=1e3;return}if(l.thiefEmpty)return;if(g.DistanceSquared(u.transform.position,l.transform.position)>Ig)if(h!=null){const m=s.entityByIdentifier.get(ws);if(!!m&&!!m.enabled){if(g.DistanceSquared(h.transform.position,l.transform.position)>Ig)return}else return}else return;if(l.attributes.attBaseMovementSpeed!==bg&&(l.attributes.attBaseMovementSpeed=bg,l.recalculateAttributes=!0,Br(s,l,dh,.8,"shaker"),vt(s,ut.wakeup)),d.type==="transferItem")d.transfered=d.count,l.npcTasksList=[d];else if(d.type==="moveTo")d.finished=!0,_s(s,l,"npcMoveToTargetBehaviour"),l.npcTasksList=[d];else if(d.type==="clearOwnedItems")return;const p=s.itemsEntitiesByOwner.get(l.id);p&&p.forEach(m=>{for(m.item.count>0&&vt(s,ut.dropItem);m.item.count>0;){m.item.count--;const _=l.transform.position,E=$.v3InCircle($.nextFloor(.3,.8));E.addInPlace(_);const v=E.x,y=E.z,A=ac(s,l.zone,m.item.key,1,v,y,!0,!0);s.addComponent(A,"willRemoveDelay",$w)}}),$h(s,l),s.addComponent(l,"thiefEmpty",!0),Cn(s,l,Rg),Rs(s,l,1e4)}}const sF=25,rF=15,aF=2;function oF(s){const e=s.visualMapObjectsQuery.with("canChop","enabled"),t=g.Zero(),i=ee.Identity();return s.bus.onZoneUnLoaded.add(()=>{[...e.entities].forEach(n=>{n.chopping!=null&&rg(s,n)})}),n=>{const r=s.treesQuery.entities,a=e.entities,o=s.playerEntity;a.forEach(l=>{const c=l.chopping;if(c==null){if(l.stayingTime==null||l.stayingTime>0){const u=l.transform.position,h=r.find(d=>l.zone===d.zone&&d.durability>0&&d.model.visual!=null&&g.DistanceSquared(u,d.model.visual.model.absolutePosition)<=1.3);if(h){const d=h.model.visual.model.absolutePosition;u.subtractToRef(d,t),t.y=0,ee.FromLookDirectionLHToRef(t,g.UpReadOnly,i),i.toEulerAnglesToRef(t);const f=t;l.transform.rotation.y=f.y+.3,QP(s,l,h),l===o&&vt(s,ut.cuttingWood)}}}else if(c.delay-=n,c.delay<0){const u=l.attributes;let h=2e3;u!=null&&u.attTotalChoppingSpeed!=null&&(h=u.attTotalChoppingSpeed),c.delay=1e3/h,c.target.durability!=null&&c.target.durability>0?(c.target.durability--,c.target.lastChopper=l,l===o&&vt(s,ut.cuttingWood)):rg(s,l)}}),r.forEach(l=>{if(l.durability>=1)return;s.removeComponent(l,"durability");const c=l.model.visual.model.absolutePosition,u=l.lastChopper,h=u?u.attributes:void 0,f=1e3/(h&&h.attTotalChoppingSpeed||2e3);Te(f*1e3).then(()=>{let p=3;if(u&&u.npc){const m=h&&h.attInventoryTotalCapacity||0,_=s.ownedItemsQuery.entities.filter(y=>y.ownedBy===u.id).reduce((y,A)=>A.item.count+y,0);let E=Math.max(0,m-_);const v=Math.min(p,E);Ra(s,u.id,"iLog",v),p-=v}for(let m=0;m<p;m++){const _=$.v3InCircle($.nextFloor(0,.3));_.addInPlace(c);const E=ac(s,l.zone,"iLog",1,_.x,_.z,!0,!0);s.addComponent(E,"willRemoveDelay",rF)}s.removeComponent(l,"enabled"),Te(sF*1e3).then(()=>{l.lastChopper=null,s.addComponent(l,"durability",aF),It(s,l),s.bus.onTreeRespawned.notifyObservers({treeEntity:l})}),u!=null&&(u.player&&s.statsEntity.gameStatistics.chopped++,s.bus.onTreeChopped.notifyObservers({who:u,treeEntity:l}))})})}}function lF(s){const e=s.with("gridMap","transform","zone"),t=s.with("gridMapPatch","enabled","zone"),i=new Map;s.bus.onPatchUpdated.add(r=>{i.delete(r)});const n=g.Zero();return r=>{const a=s.lvlManager;if(!a)return;const o=t.entities;let l=!1;e.entities.forEach(c=>{const u=c.gridMap;o.forEach(h=>{if(h.zone!==c.zone)return;i.has(h)||i.set(h,new Set);const d=i.get(h);if(d.has(u))return;d.add(u);const f=h.gridMapPatch;u.applyOpenedPatch(f.opened),u.applyClosedPatch(f.closed),l=!0})}),l&&e.entities.forEach(c=>{const u=c.gridMap,h=c.transform.position,d=u.findNode(h);if(d&&d.isWall()){const f=a.getZone(c.zone);if(!f)return;const p=f.gridMapInfo.resolvingPoint;n.set(p.x,p.y,p.z);const m=u.search(h,n);if(m.length>1)c.transform.position.copyFrom(m[1]);else{const _=[],E=new Set;E.add(u.indexToId(d.x,d.y));const v=A=>{let I=A.x,T=A.y;for(let R=-1;R<2;R++)for(let x=-1;x<2;x++){if(R===0&&x===0)continue;const F=I+R,L=T+x,V=u.getNode(F,L);if(V!=null){const Z=u.indexToId(F,L);if(E.has(Z))continue;_.push(V),E.add(Z)}}};let y=4;for(;y>0;){v(d);const A=[..._];_.length=0;for(let I=0;I<A.length;I++){const T=A[I],R=u.indexToV3([T.x,T.y]),x=u.search(R,n);x.length>1?(c.transform.position.copyFrom(x[1]),y=-1):v(T)}y--}}}})}}function cF(s){const e=s.npcsWithTasksQuery.with("attributes","npcChoppingBehaviour"),t=new Set;return s.bus.onZoneUnLoaded.add(()=>{[...e.entities].forEach(i=>{const n=i.npcTasksList[0];if(n.type!=="chop")return;const r=n.tree;r&&t.delete(r),n.finished=!0,_s(s,i,"npcChoppingBehaviour")})}),s.bus.onTreeChopped.add(i=>{t.add(i.treeEntity)}),s.bus.onTreeRespawned.add(i=>{t.delete(i.treeEntity)}),i=>{for(const n of e){const r=n.npcTasksList[0];if(r.type!=="chop")continue;const a=r.tree;if(a&&(!a.durability||a.durability<1)&&t.has(a)){r.finished=!0,_s(s,n,"npcChoppingBehaviour"),t.delete(a);continue}}}}const uF=6;function hF(s){const e=s.identifiableQuery.with("playerInInteractiveArea","zone"),t=s.mapObjectsQuery.with("bonusResourceSpawnPoint"),i=s.identifiableQuery.with("interactiveArea","itemHolder"),n=s.with("bonusResource"),r=s.producersQuery.with("mill","purchased"),a=s.producersQuery.with("pub","purchased"),o=s.with("ship","purchased"),l=s.with("baker","purchased"),c=s.with("market","unlocked"),u={};function h(){const p=c.entities[0],m=r.entities[0],_=a.entities[0],E=l.entities[0],v=o.entities[0];if(p==null)return 0;const A=i.entities.filter(Z=>!!Z.enabled&&!!Z.interactiveArea.target&&!Z.interactiveArea.target.purchased&&Z.itemHolder.type==="iCoin").map(Z=>Z.itemHolder.max-Z.itemHolder.val);A.sort((Z,ne)=>ne-Z);let I=A[0];if(!I||I<1)return 0;const T=m!=null,R=_!=null,x=E!=null,F=v!=null;I=Math.ceil(I*1.1);const L=F?200:R?150:x?90:T?70:25,V=R?15:x?10:T?7:5;return I>L?L:I<V?V:I}const d=new Set(["pTrainerStrengthNpc","pTrainerHpNpc"]),f=p=>Ie(this,null,function*(){if(!Vn.isRewardedVideoAvailable()||p==="iCoin"&&!fm())return;const m=e.entities;let _=m.find(I=>!I.purchased&&I.interactiveArea==null),E=!1;if(_==null){const I=m.find(T=>T.purchased&&d.has(T.id));if(!I)return;E=!0,_=I}const v=t.entities.find(I=>I.ownedBy===_.id);if(!v)return;let y=0;if(E){y=2,_.itemProducer&&(p=_.itemProducer.outputItemType);let I=0;p==="iHp"?I=s.playerEntity.attributesLevel.attVit||0:p==="iStrength"&&(I=s.playerEntity.attributesLevel.attStr||0),I>=100?y=6:I>=50?y=5:I>=30?y=4:I>=10&&(y=3)}else{const I=i.entities.find(x=>x.itemHolder.type===p&&x.interactiveArea.target===_);if(!I)return;const T=_.id;if(p==="iCoin")y=h();else{const x=I.itemHolder.max-I.itemHolder.val;if(x<1)return;let F=0;_.well!=null||_.dock!=null?F=I.itemHolder.max:_.wall!=null?F=18:_.hut1!=null||_.hut2!=null?F=Math.min(15,x):_.dock2!=null?F=Math.min(20,x):_.balloon!=null?F=Math.min(4,x):T==="pSnowFireplace"?F=18:T==="pClimb"?F=Math.min(18,x):T==="pCaveLight"||T==="pCaveBridge1"||T==="pCaveBridge2"?F=Math.min(12,x):(T==="homeBed"||T==="homeTable")&&(F=8),F<1&&(F=12),y=Math.min(Math.max(uF,x),F),x<=4&&y<=x&&(y=6)}}n.entities.find(I=>I.bonusResource.relatedToEntityId===_.id)==null&&(yield Te(500),ZP(s,_.zone,p,y,_.id,v.transform.position))});return s.playerItems.forEach(p=>{u[p.item.key]=p.item.count}),s.bus.onInventoryUpdated.add(()=>{const p=new Set(Object.keys(u));s.playerItems.forEach(m=>{const _=m.item.key,E=m.item.count,v=u[_];v&&E<1&&v>0&&f(_),u[_]=E,p.delete(_)});for(const m of p){const _=u[m];_&&_>0&&(f(m),u[m]=0)}}),p=>{}}function dF(s){hF(s);const e=s.visualMapObjectsQuery.with("bonusResource","screenPosition").without("removing"),t=(n,r)=>{const o=s.playerItems.find(u=>u.item.key===n),l=s.statsEntity.gameStatistics.picked,c=n;l[c]==null?l[c]=r:l[c]+=r,o?o.item.count+=r:Ra(s,s.playerEntity.id,n,r)},i=n=>Ie(this,null,function*(){const r=n.bonusResource,a=r.itemType,o=r.itemCount,l=s.bus.onRewardedVideoFinished.addOnce(c=>Ie(this,null,function*(){if(c.id==="adsResourceOffer"){if(a==="iHp")co(s,3),Gf(s,"attVit",o);else if(a==="iStrength")co(s,3),Gf(s,"attStr",o);else if(a==="iCoin"){co(s,o);for(let u=0;u<5;u++)yield Te(100),vt(s,ut.pickCoin),s.add({id:$.id(),item:{key:"iCoin",count:0},animatePickingInUI:!0,willRemoveDelay:1})}else for(let u=0;u<o;u++)yield Te(50),t(a,1),u%3===0&&vt(s,ut.pickItem);s.bus.onInventoryUpdated.notifyObservers()}}));try{yield Vn.playRewardedVideo("adsResourceOffer")}catch(c){console.error(c)}finally{s.bus.onRewardedVideoFinished.remove(l)}});return n=>{e.entities.forEach(r=>{const a=r.bonusResource;if(r.playerInInteractiveArea==null){if(a.activationDelay=a.activationDuration,a.removeDelay==null?a.removeDelay=a.lifetime:a.removeDelay-=n,a.removeDelay<=0){s.addComponent(r,"removing",!0),s.bus.onBonusResourceRemoved.notifyObservers({entity:r}),Oe.addDesignEvent("UI:BonusExpired:"+a.relatedToEntityId+a.itemType+a.itemCount,1);return}return}a.activationDelay==null?a.activationDelay=a.activationDuration:a.activationDelay-=n,a.activationDelay<=0&&(s.addComponent(r,"removing",!0),s.bus.onBonusResourceRemoved.notifyObservers({entity:r}),Oe.addDesignEvent("UI:BonusActivated:"+a.relatedToEntityId+a.itemType+a.itemCount,1),Oe.addDesignEvent("UI:BonusActivatedPerEntity:"+a.relatedToEntityId+a.itemType,1),i(r))})}}const fF=6*60;function pF(s){const e=s.with("managerActivation","enabled"),t=s.npcsWithTasksQuery.with("manager","enabled"),i=s.npcsWithTasksQuery.with("thief"),n=()=>Ie(this,null,function*(){const r=s.bus.onRewardedVideoFinished.addOnce(a=>{a.id==="adsManager"&&It(s,pa(s,s.globalEffector,{attr:"attChoppingSpeed",op:"add",value:0,duration:fF},ws))});try{yield Vn.playRewardedVideo("adsManager")}catch(a){console.error(a)}finally{s.bus.onRewardedVideoFinished.remove(r)}});return r=>{e.entities.forEach(c=>{const u=c.managerActivation;if(c.playerInInteractiveArea==null){u.activationDelay=u.activationDuration;return}u.activationDelay==null?u.activationDelay=u.activationDuration:u.activationDelay-=r,u.activationDelay<=0&&(s.removeComponent(c,"enabled"),Oe.addDesignEvent("UI:ManagerActivated"),n())});const a=t.entities[0];if(a==null)return;const o=s.entityByIdentifier.get(ws);if(!!o&&!!o.enabled){const c=i.entities[0];if(c==null)return;if(c.npcTasksList.length>0&&!c.thiefEmpty){const u=c.npcTasksList[0];u&&u.type!=="waiting"&&(a.npcTasksList.some(h=>h.type==="moveTo"&&h.follow)||(a.npcTasksList.forEach(h=>{switch(h.type){case"waiting":{_s(s,a,"npcWaitingBehaviour");break}case"moveTo":_s(s,a,"npcMoveToTargetBehaviour")}h.finished=!0}),Cn(s,a,c.transform.position,!0),a.npcTasksList[a.npcTasksList.length-1].pos=c.transform.position))}}}}class vv{constructor(){X(this,"prevState");X(this,"currentState");X(this,"elapsedTime",0)}changeState(e){this.currentState!=e&&(this.currentState&&this.currentState.onExit(this),this.prevState=this.currentState,this.currentState=e,this.elapsedTime=0,this.currentState.onEnter(this))}update(e){this.elapsedTime+=e,this.currentState!=null&&this.currentState.onUpdate(this,e)}}class Qs{constructor(){X(this,"actions",[]);X(this,"transitions",[]);X(this,"data",{})}onEnter(e){this.actions.forEach(t=>t.onEnter&&t.onEnter(e))}onUpdate(e,t){for(const i of this.transitions)if(i.decision.onUpdate!=null&&i.decision.onUpdate(e,t),i.decision.check(e)){e.changeState(i.nextState);return}this.actions.forEach(i=>i.onUpdate&&i.onUpdate(e,t))}onExit(e){this.actions.forEach(t=>t.onExit&&t.onExit(e))}}class Kf{constructor(e){this.delay=e}check(e){return e.elapsedTime>=this.delay}}class xg{constructor(e,t,i){X(this,"sqrRange");this.pos=e,this.target=t,this.range=i,this.sqrRange=i*i}check(e){return g.DistanceSquared(this.pos,this.target)<=this.sqrRange}}class Mg{constructor(e,t,i){X(this,"sqrRange");this.pos=e,this.target=t,this.range=i,this.sqrRange=i*i}check(e){return g.DistanceSquared(this.pos,this.target)>this.sqrRange}}class Pg{constructor(e){this.entity=e}check(e){return this.entity.currentHp<=0}}const Qf={check:()=>!0};class mF extends vv{constructor(e,t){super(),this.npcEntity=e,this.world=t;const i=12,n=e.attackDistance||.5,r=new Qs,a=new Qs,o=new Qs;o.data.delay=1;const l=new Qs,c=new Qs,u={decision:new Pg(e),nextState:c};r.transitions.push({decision:new Kf(1),nextState:a},u),a.transitions.push(u,{decision:new xg(e.transform.position,t.playerEntity.transform.position,i),nextState:o},{decision:Qf,nextState:r}),o.transitions.push(u,{decision:new xg(e.transform.position,t.playerEntity.transform.position,n),nextState:l},{decision:new Mg(e.transform.position,t.playerEntity.transform.position,i),nextState:r}),o.actions.push({onEnter:()=>{Cn(t,e,t.playerEntity.transform.position)},onUpdate:(h,d)=>{o.data.delay-=d,e.npcTasksList[0]?o.data.delay<=0&&(sg(e,e.transform.position),o.data.delay=.5):Cn(t,e,t.playerEntity.transform.position)},onExit:()=>{sg(e,e.transform.position)}}),l.transitions.push(u,{decision:new Mg(e.transform.position,t.playerEntity.transform.position,n),nextState:a},{decision:new Pg(t.playerEntity),nextState:r}),this.changeState(a)}get currentTask(){return this.npcEntity.npcTasksList[0]}}const _F=1,gF=[Ae.skinColorDanger,G.FromHexString("#037224"),G.FromHexString("#72036f")],EF=[new j(146,129),new j(146,129.5),new j(146,130),new j(146,130.5),new j(146,131),new j(146,131.5)];function vF(s){const e=s.identifiableQuery.with("visualDamage","ownedBy"),t=i=>{s.remove(i),s.bus.onVisualDamageDestroyed.notifyObservers(i)};return i=>{e.entities.forEach(n=>{n.visualDamage.lifetime==null&&(n.visualDamage.lifetime=_F),n.visualDamage.lifetime-=i,n.visualDamage.lifetime<=0&&t(n)})}}function yF(s){const e=vF(s),t=s.visualMapObjectsQuery.with("minAttackDmg","maxAttackDmg","attackSpeed","attackDelay","attackDistance","teamId","alive","attributes"),i=s.visualMapObjectsQuery.with("attackable","currentHp","maxHp","teamId","alive"),n=s.with("keyboardInput"),r=s.with("mouseInput"),a=(m,_,E,v,y,A)=>{const I=ed[E],T=s.add({id:"enemy"+$.id(),zone:_,npc:!0,enabled:!0,npcEmptyBehaviour:!0,npcTasksList:[],gridMap:s.npcGlobalGridMap,transform:{rotation:{y:0},position:new g(m.x,0,m.z),scaling:g.One().scaleInPlace(.6*(I.scaleFactor||1))},model:{key:"npc_worker"},attributes:{attBaseMovementSpeed:1.2+$.nextFloor(0,.8),attCritChance:.08,attExcellentChance:.03},recalculateAttributes:!0,movement:{speed:0,velocity:g.Zero()},stayingTime:0,movingTime:0,purchased:!0,appearance:{parts:[["Body",0,$.randomElement(gF).clone()],["Eyes",0,Ae.eyesColorDark],["Weapon",0,G.Red()]],removed:[]},screenPosition:j.Zero(),screenPositionOffset:new g(0,2.5,0),lifetime:0,attackable:!0,teamId:"pirates",maxHp:A,currentHp:A,alive:!0,attackDelay:0,attackDistance:1,attackSpeed:1*(I.dmgSpeedFactor||1),minAttackDmg:v,maxAttackDmg:y}),R=new mF(T,s);return s.addComponent(T,"npcFSM",R),T};s.bus.onEntityDestroyed.add(m=>{const _=m.entity;_.npc&&o.has(_)&&(o.delete(_),o.size===0&&u())});const o=new Set,l=()=>{s.playerEntity.appearance&&s.playerEntity.appearance.parts.push(["Weapon",0,Ae.bristleColorDark])},c=()=>{const m=s.playerEntity;m.appearance&&(m.appearance.parts=m.appearance.parts.filter(_=>_[0]!=="Weapon"),m.appearance.removed.push("Weapon"))},u=()=>{c();const m=Du[s.varsEntity.persistentVars.waves];if(!m)return;const _=ed[m];if(_){const E=_.award;co(s,E),vt(s,ut.success),hv(Math.min(E,7))}Oe.addDesignEvent(`UI:Waves:WaveWin${s.varsEntity.persistentVars.waves}`),s.varsEntity.persistentVars.waves++,s.bus.onWaveWin.notifyObservers(),ag(s)},h=()=>{c(),s.bus.onWaveLose.notifyObservers(),Oe.addDesignEvent(`UI:Waves:WaveLose${s.varsEntity.persistentVars.waves}`),ag(s)},d=m=>{const _=Du[m];if(!_)return;const E=ed[_];if(jP(s,s.playerEntity),s.playerEntity.attackSpeed=s.playerEntity.attributes.attAttackSpeed||.6,E.count==null)return;l();const v=E.count,y=NP([...EF]);E.hp,E.minDmg,E.maxDmg;const A=1/v;for(let I=0;I<v;I++){const T=E.hp*A,R=E.minDmg*A,x=E.maxDmg*A,F=y[I%y.length],L=new g(F.x,0,F.y),V=a(L,"zVillage",_,R,x,T);o.add(V)}Oe.addDesignEvent(`UI:Waves:WaveStart${m}`)};s.bus.onVillageModeChanged.add(m=>{m==="war"?d(s.varsEntity.persistentVars.waves):(o.forEach(_=>{s.addComponent(_,"removing",!0)}),o.clear())});const f=ee.Identity(),p=g.Zero();return m=>{e(m),t.entities.forEach(_=>{if(_.attackDelay-=m,_.attackDelay>0)return;const E=_.teamId,v=_.attackDistance*_.attackDistance,y=i.entities.filter(ne=>ne.teamId!==E);if(y.length===0)return;const A=y.map(ne=>{const ae=g.DistanceSquared(ne.transform.position,_.transform.position);return ae<=v?{entity:ne,distSqr:ae}:!1}).filter(Boolean);A.sort((ne,ae)=>ne.distSqr-ae.distSqr);const I=A[0];if(!I)return;s.addComponent(_,"playAttackAnimation",!0),_.attackDelay=_.attackSpeed,Te(500).then(()=>{s.removeComponent(_,"playAttackAnimation")});let T=$s.Normal,R=Math.max(1,$.nextFloor(_.minAttackDmg,_.maxAttackDmg));const x=_.attributes;let F=x.attExcellentChance||0,L=x.attCritChance||0;F>.001&&$.nextRandomBool(F)?(R=_.maxAttackDmg*1.1,T=$s.Excellent):L>.001&&$.nextRandomBool(L)&&(R=_.maxAttackDmg,T=$s.Critical),R=Math.floor(R);const V=I.entity;V.currentHp-=R,V.player?og(s,V.id,R,$s.Enemy):og(s,V.id,R,T),p.copyFrom(_.transform.position),p.subtractInPlace(V.transform.position),p.y=0,p.normalize(),ee.FromLookDirectionLHToRef(p,g.UpReadOnly,f),f.toEulerAnglesToRef(p);const Z=p;_.transform.rotation.y=Z.y,s.bus.onHpUpdated.notifyObservers(V),V.currentHp<=0?(V.currentHp=0,s.removeComponent(V,"alive"),V.npcTasksList&&(V.npcTasksList.length=0),V.movement&&V.movement.velocity.setAll(0),V.model.visual&&(V.model.visual.model.rotation.x=Math.PI*.5,V.transform.position.y+=.1),V.player?(n.entities.forEach(ne=>s.removeComponent(ne,"enabled")),r.entities.forEach(ne=>s.removeComponent(ne,"enabled")),Te(1500).then(()=>{V.model.visual&&(V.model.visual.model.rotation.x=0),V.transform.position.copyFromFloats(144,0,130),s.addComponent(V,"alive",!0),V.currentHp=V.maxHp,n.entities.forEach(ne=>s.addComponent(ne,"enabled",!0)),r.entities.forEach(ne=>s.addComponent(ne,"enabled",!0)),h()})):s.addComponent(V,"willRemoveDelay",1),vt(s,$.randomElement([ut.die1,ut.die2,ut.die3]))):_.player&&vt(s,$.randomElement([ut.attack1,ut.attack2]))})}}function AF(s){let e=null;return t=>{const i=s.playerEntity,n=s.sceneEntity;if(i==null||n==null)return;const r=s.lvlManager;if(r==null)return;const a=r.currentZone;if(a==null)return;const o=r.getZone(a);if(!o||i.model.visual==null)return;const c=n.scene,u=c.hemiLight;if(u==null||e===a)return;e=a;const h=o.light,d=o.parsedLight;u.intensity=h.hemiIntensity,u.diffuse.copyFrom(d.hemiColor),u.groundColor.copyFrom(d.hemiGroundColor),c.clearColor.copyFromFloats(d.clearColor.r,d.clearColor.g,d.clearColor.b,1)}}function TF(s,e){xP(e,s);const t=Lw(e),i=OO(e),n=S2(e),r=wO(e),a=uw(e),o=cw(e),l=L2(e),c=d2(e),u=LO(e),h=PO(e),d=BO(e),f=DO(e),p=x2(e),m=GO(e),_=UO(e),E=R2(e),v=w2(e),y=I2(e),A=F2(e),I=zO(e),T=VO(e),R=YO(e),x=v2(e),F=r2(e),L=g2(e),V=iw(e),Z=nw(e),ne=hw(e),ae=gw(e),Ue=vw(e),Ve=Zw(e),$e=yw(e),re=Aw(e),ge=Iw(e),be=Rw(e),ze=dw(e),Ke=Ow(e),Ut=Nw(e),st=dF(e),Jt=pF(e),Wt=Fw(e),ii=nF(e),$i=oF(e),Ji=lF(e),en=yF(e),vn=AF(e),Ne=P2(e),Xe=Z2(e),_i=j2(e),yt=tw(e),Ge=sw(e),yn=aw(e),Vt=rw(e),P=ow(e),ie=bw(e),et=xw(e),zi=cF(e),Hi=M2(e),Bs=me=>{const Mt=e.sceneEntity;Hi(me),!Mt.paused&&(Mt.wasPaused||(t(me),i(),n(),r(),a(me),o(me),c(),u(me),h(),d(),p(me),m(),v(me),y(me),A(),I(me),Z(me),_(me),E(me),V(me),ne(me),ae(me),Ue(me),Ve(me),$e(me),re(me),ge(me),be(me),Ke(me),Ut(me),st(me),Jt(me),Wt(me),ii(me),$i(me),Ji(me),en(me),Xe(me),Ne(me),_i(me),yt(me),Ge(me),P(me),yn(me),Vt(me),ie(me),et(me),zi(me),T(me),R(),x(me),F(me),ze(me),l(me),vn(me),f(),L()))};return s.onReadyObservable.addOnce(()=>Ie(this,null,function*(){Bs(0),e.bus.onSceneReady.notifyObservers({})})),Bs}const SF=M.memo(()=>{const s=bt(),e=ve.useRef(null),t=ve.useRef(null);return ve.useEffect(()=>{const i=s.with("scene"),n=s.with("mouseInput"),r=a=>{let o=Date.now();const l=30;a.onAfterRenderObservable.add(()=>{const c=Date.now();if(o>c)return;o=c+l;const u=e.current,h=t.current;if(u==null||h==null)return;const d=n.entities[0];if(d===void 0)return;const{mouseInput:{startedAt:f,delta:p}}=d;if(f==null){u.style.display="none";return}u.style.display="block",u.style.top=f.y+"px",u.style.left=f.x+"px",p!=null&&(h.style.cssText=`top:${+p.y*50+50}%; left:${+p.x*50+50}%;`)})};if(i.entities.length>0){const{scene:a}=i.entities[0];r(a)}else i.onEntityAdded.add(a=>{const o=a.scene;r(o)})},[s]),M.createElement("div",{className:"joystick",ref:e},M.createElement("div",{className:"stick",ref:t}))}),CF=M.memo(()=>{const s=bt(),e=ve.useRef(null),t=ve.useRef(null),{refresh:i}=Yt(),[n,r]=ve.useState(!1);return te("onPauseChanged",({paused:a})=>{const o=s.with("canvas").entities[0];if(o==null)return;const l=o.canvas;l.classList&&(a?l.classList.add("paused"):l.classList.remove("paused"))}),ve.useEffect(()=>{const a=s.with("canvas").entities[0];if(!a)throw new Error("no canvas!");if(!e.current)return;e.current.prepend(a.canvas);const o=s.sceneEntity;if(!o)throw new Error("no scene!");const l=o.scene,c=l.getEngine();console.log("scene created");const u=TF(l,s),h=document.getElementById("fps");let d=Date.now();const f=300,p=s.playerEntity;let m=Date.now()+1e4,_=null,E=0,v=null;const y=29,A=3e4,I=s.debug;let T;const R=.3;s.bus.onSceneReady.addOnce(()=>{Oe.addDesignEvent("UI:Loading:onSceneReady",1),s.lvlManager&&s.lvlManager.downloadAllMeshesInSequence();const F=Date.now();s.bus.onPlayerMovementStarted.addOnce(()=>{Ei.gameplayStart(),Oe.addDesignEvent("UI:Loading:onGameplayStarted",Date.now()-F);const V=Date.now(),Z=s.statsEntity.gameStatistics;if(!Z.chopped){Te(3e3).then(()=>{Oe.addDesignEvent("UI:Events:dist3s",Z.movementDistance)}),Te(1e4).then(()=>{Oe.addDesignEvent("UI:Events:dist10s",Z.movementDistance)});const ne=s.bus.onStartChopping.add(Ue=>{Ue.entity.player&&(ne.remove(),Oe.addDesignEvent("UI:Events:onPlayerStartChopping",Date.now()-V))}),ae=s.bus.onTreeChopped.add(Ue=>{Ue.who.player&&(ae.remove(),Oe.addDesignEvent("UI:Events:onPlayerFinishChopping",Date.now()-V))})}try{fm()?Oe.addDesignEvent("UI:Configs:bonusCoinsAvailable"):Oe.addDesignEvent("UI:Configs:bonusCoinsNotAvailable")}catch(ne){}});const L=Date.now();T=()=>{if(l.deltaTime==null)return;const V=l.deltaTime/1e3,Z=Date.now()-L;V<R&&u(V),s.statsEntity.gameStatistics.gameTime=Z},l.executeWhenReady(()=>{Te(1e3).then(()=>{l.unfreezeActiveMeshes()})})}),c.runRenderLoop(()=>{if(T!==void 0&&T(),o.paused){s.addComponent(o,"wasPaused",!0);return}try{l.render()}catch(Ue){const Ve=Ue;throw Oe.addErrorEvent(Ii.EGAErrorSeverity.Critical,Ve.toString()),Ue}o.wasPaused&&s.removeComponent(o,"wasPaused");const F=l.deltaTime,L=F===0?120:Math.floor(1e3/F),V=Date.now();if(_==null?_=L:_=Math.floor((_+L)/2),(v==null||v>L)&&(v=L),L<y&&E++,V>m&&(Oe.addDesignEvent("GA:AverageFPS",_||0),Oe.addDesignEvent("GA:MinFPS",v||0),Oe.addDesignEvent("GA:CriticalFPS",E),_=v=L,E=0,m=V+A),d>V)return;const Z=p.transform.position,ne=Math.trunc(Z.x),ae=Math.trunc(Z.z);if(d=V+f,h!=null){if(!I||!I.showFPS){h.firstChild.nodeValue.length!==0&&(h.firstChild.nodeValue="");return}h.firstChild.nodeValue="FPS:"+L+`/${_} ECS:`+s.entities.length+`,${ne} ${ae},t:`+Math.floor(s.statsEntity.gameStatistics.gameTime/1e3)}}),t.current=()=>l.debugLayer.show({overlay:!0});const x=()=>{c.resize();const F=window.innerHeight>window.innerWidth;s.settingsEntity.settings.portraitOrientation=F,s.bus.onSettingsChanged.notifyObservers(s.settingsEntity)};return window.addEventListener("resize",x),x(),Dn.onGameLoaded.notifyObservers(s),s.bus.onPauseChanged.add(F=>{F.reason!=="interstitial"&&(F.paused?Ei.gameplayStop():Ei.gameplayStart())}),document.querySelector(".preloader").style.display="none",()=>{window.removeEventListener("resize",x)}},[s]),te("onRewardedVideoStarted",()=>i()),te("onRewardedVideoFinished",()=>i()),te("onRewardedVideoFailed",()=>i()),te("onPrestigeActivated",()=>Ie(void 0,null,function*(){r(!0),yield Te(2e3),r(!1)})),M.createElement("div",{className:"in-game-page",ref:e},M.createElement(MO,null),M.createElement(SF,null),M.createElement(oO,null),s.debug.showFPS===!0&&M.createElement("span",{id:"fps",onClick:()=>t.current&&t.current()},"FPS:~"),n&&M.createElement("div",{className:"prestige-loader"},M.createElement("span",{style:{fontSize:"3em"}},"...")))}),IF=""+new URL("whiteRect-c5f57e8e.png",import.meta.url).href,RF=""+new URL("flare-54450e62.png",import.meta.url).href,Lu=class Lu extends Le{constructor(t){super(t);X(this,"defaultCamera");this.clearColor=Lu.DEFAULT_COLOR}createArcCamera({dist:t=3,minZ:i=.01,maxZ:n=1e3}={}){const r=new Lt("Camera",Math.PI*.5,Math.PI/2.5,t,g.Zero(),this);return r.maxZ=n,r.minZ=i,this.defaultCamera=r,this}enableFog(){const t=this;return t.fogEnabled=!0,t.fogDensity=.1,t.fogStart=10,t.fogEnd=20,t.fogMode=Le.FOGMODE_EXP2,t.fogColor=new G(.9,.9,.85),this}disableFog(){return this.fogEnabled=!1,this}};X(Lu,"DEFAULT_COLOR",new pe(.8,.8,.8,1));let Zf=Lu;class bF extends Zf{constructor(t){super(t);X(this,"_inProgressInstantiations",{});X(this,"_lights",[]);X(this,"_instantiatedModels",{});X(this,"_allModels",{});X(this,"_modelsPromises",{});X(this,"_allAnimations",{});X(this,"_ground");X(this,"_whiteTexture");X(this,"_flareTexture");X(this,"_instancesPool",{});X(this,"hemiLight");X(this,"flag");X(this,"_rainParticleSystem");X(this,"_buyParticleSystem");X(this,"bakerSmokePS");X(this,"fireplaceSmokePS");X(this,"bathSmokePS");X(this,"snowFireplaceSmokePS");X(this,"_npcPool",{});X(this,"_grounds",new Set);X(this,"_loadingModel",{});X(this,"_unfreezeOnAnimation",[]);this.performancePriority=hs.Aggressive,this.skipFrustumClipping=!0,this.autoClearDepthAndStencil=!0,this.autoClear=!0,this.clearColor.copyFrom(pe.FromHexString("#171717FF")),this._activeMeshesFrozen=!0,this._skipEvaluateActiveMeshesCompletely=!0,this._activeMeshesFrozenButKeepClipping=!1,this.actionManager=new at(this);const i=new rh("HemiLight",new g(.8,1,1),this);i.intensity=3,i.diffuse=G.FromHexString("#FFEACB"),i.groundColor=G.FromHexString("#3C3C3C"),this.hemiLight=i,this.disableFog(),this._lights=this.lights,this._lights.forEach(n=>{n.startIntensity=n.intensity}),lP(this),window.__gameScene=this,this.onBeforeCameraRenderObservable.add(()=>{this._unfreezeOnAnimation.forEach(n=>{this.forceModelToUpdate(n)})})}createFlag(t,i){const n=Math.round(i.length/t),r=new Uint8Array(i.length*3);let a=0;for(let c=0;c<r.length;c+=3){const u=G.FromHexString(i[a]);r[c]=Math.round(u.r*255),r[c+1]=Math.round(u.g*255),r[c+2]=Math.round(u.b*255),a++}this.flag=an.CreateRGBTexture(r,t,n,this,!1,!0,H.NEAREST_SAMPLINGMODE);const o=lm("flagPlane",{width:t,height:n},this),l=new J("flagMaterial",this);l.diffuseTexture=this.flag,o.material=l,o.position.copyFromFloats(120,2.7,122),o.rotationQuaternion=null,o.rotation.y=-Math.PI*.4,o.rotation.x=-.1,o.scaling.setAll(.2),this.forceModelToUpdate(o)}updateFlag(t){if(!this.flag)return;const i=new Uint8Array(t.length*3);let n=0;for(let r=0;r<i.length;r+=3){const a=G.FromHexString(t[n]);i[r]=Math.round(a.r*255),i[r+1]=Math.round(a.g*255),i[r+2]=Math.round(a.b*255),n++}this.flag.update(i)}prepareItems(t){const i=t.reduce((r,a)=>{const o=a;return r[a.name]=o,o.setParent(null),o.scaling.setAll(1),o.rotation.setAll(0),r},{}),n=Qt({},i);Object.entries(n).forEach(([r,a])=>{if(this.assignModelForKey(r,a),r==="MAX"){const o=new J("MAX_mat");o.disableLighting=!0,o.emissiveColor=G.FromHexString("#FF4141"),a.billboardMode=he.BILLBOARDMODE_ALL,a.material=o,a.rotationQuaternion=null,a.rotation.setAll(0),a.renderingGroupId=1}})}assignModelForKey(t,i){if(this._modelsPromises[t]=Promise.resolve(),!this._allModels[t]){this._allModels[t]=[i];return}this._allModels[t].push(i)}registerNPCPool(t,i){this._npcPool[t]=i}getVariantsCount(t){return this._allModels[t]==null?1:this._allModels[t].length}createBakerSmokeParticleSystem(){if(!this._whiteTexture){console.warn("no white texture for smoke!");return}const t=new He("bakerSmokeParticles",15,this);t.preventAutoStart=!0,t.startDelay=0,t.preWarmCycles=5,t.particleTexture=this._whiteTexture,t.minLifeTime=2.5,t.maxLifeTime=3,t.emitRate=2,t.gravity=new g(0,1.5,0),t.addSizeGradient(0,.1),t.addSizeGradient(.2,.7),t.addSizeGradient(.5,1),t.addSizeGradient(.8,.7),t.addColorGradient(0,new pe(.5,.5,.5,.1)),t.addColorGradient(.4,new pe(.1,.1,.1,.1)),t.addColorGradient(.7,new pe(.03,.03,.03,.15)),t.addColorGradient(1,new pe(0,0,0,0)),t.addVelocityGradient(0,1),t.addVelocityGradient(.1,.8),t.addVelocityGradient(.7,.4),t.addVelocityGradient(1,.1),t.minInitialRotation=0,t.maxInitialRotation=Math.PI,t.minAngularSpeed=-1,t.maxAngularSpeed=1,t.blendMode=He.BLENDMODE_STANDARD,t.emitter=new g(137.6,3.5,144.5),t.minEmitBox=new g(-1,-1,-1).scaleInPlace(.1),t.maxEmitBox=new g(1,1,1).scaleInPlace(.1),this.bakerSmokePS=t,this.fireplaceSmokePS=new He("fireplaceSmokePS",10,this),this.fireplaceSmokePS.preventAutoStart=!0,this.fireplaceSmokePS.startDelay=0,this.fireplaceSmokePS.preWarmCycles=5,this.fireplaceSmokePS.particleTexture=this._whiteTexture,this.fireplaceSmokePS.blendMode=He.BLENDMODE_STANDARD,this.fireplaceSmokePS.gravity=new g(0,1.5,0),this.fireplaceSmokePS.minInitialRotation=0,this.fireplaceSmokePS.maxInitialRotation=Math.PI,this.fireplaceSmokePS.minAngularSpeed=-1,this.fireplaceSmokePS.maxAngularSpeed=1,this.fireplaceSmokePS.minEmitBox=new g(-.2,0,-.1),this.fireplaceSmokePS.maxEmitBox=new g(.2,.1,.1),this.fireplaceSmokePS.emitRate=4,this.fireplaceSmokePS.emitter=new g(23.8,.4,140.7),this.fireplaceSmokePS.minEmitPower=this.fireplaceSmokePS.maxEmitPower=1,this.fireplaceSmokePS.addVelocityGradient(0,2),this.fireplaceSmokePS.addVelocityGradient(.15,1),this.fireplaceSmokePS.addVelocityGradient(1,.1),this.fireplaceSmokePS.minLifeTime=this.fireplaceSmokePS.maxLifeTime=1,this.fireplaceSmokePS.addColorGradient(0,pe.FromHexString("#EA0D0DC8")),this.fireplaceSmokePS.addColorGradient(.3,pe.FromHexString("#F57607C8")),this.fireplaceSmokePS.addColorGradient(1,new pe(0,0,0,0)),this.fireplaceSmokePS.addSizeGradient(0,.1),this.fireplaceSmokePS.addSizeGradient(.2,.4),this.fireplaceSmokePS.addSizeGradient(.8,.1),this.bathSmokePS=new He("bathSmokePS",10,this),this.bathSmokePS.preventAutoStart=!0,this.bathSmokePS.startDelay=0,this.bathSmokePS.preWarmCycles=5,this.bathSmokePS.particleTexture=this._whiteTexture,this.bathSmokePS.blendMode=He.BLENDMODE_STANDARD,this.bathSmokePS.gravity=new g(0,1.5,0),this.bathSmokePS.minInitialRotation=0,this.bathSmokePS.maxInitialRotation=Math.PI,this.bathSmokePS.minAngularSpeed=-1,this.bathSmokePS.maxAngularSpeed=1,this.bathSmokePS.minEmitBox=new g(-.3,0,-.2),this.bathSmokePS.maxEmitBox=new g(.3,.01,.2),this.bathSmokePS.emitRate=6,this.bathSmokePS.emitter=new g(23.69,.5,139.1),this.bathSmokePS.minEmitPower=this.bathSmokePS.maxEmitPower=1,this.bathSmokePS.addVelocityGradient(0,.8),this.bathSmokePS.addVelocityGradient(1,.1),this.bathSmokePS.minLifeTime=this.bathSmokePS.maxLifeTime=.8,this.bathSmokePS.addColorGradient(0,pe.FromHexString("#FFFFFFFF")),this.bathSmokePS.addColorGradient(1,pe.FromHexString("#FFFFFF00")),this.bathSmokePS.addSizeGradient(0,.5),this.bathSmokePS.addSizeGradient(1,.1),this.snowFireplaceSmokePS=new He("snowFireplaceSmokePS",10,this),this.snowFireplaceSmokePS.preventAutoStart=!0,this.snowFireplaceSmokePS.startDelay=0,this.snowFireplaceSmokePS.preWarmCycles=5,this.snowFireplaceSmokePS.particleTexture=this._whiteTexture,this.snowFireplaceSmokePS.blendMode=He.BLENDMODE_STANDARD,this.snowFireplaceSmokePS.gravity=new g(0,1.5,0),this.snowFireplaceSmokePS.minInitialRotation=0,this.snowFireplaceSmokePS.maxInitialRotation=Math.PI,this.snowFireplaceSmokePS.minAngularSpeed=-1,this.snowFireplaceSmokePS.maxAngularSpeed=1,this.snowFireplaceSmokePS.minEmitBox=new g(-.3,0,-.3),this.snowFireplaceSmokePS.maxEmitBox=new g(.3,.01,.3),this.snowFireplaceSmokePS.emitRate=6,this.snowFireplaceSmokePS.emitter=g.Zero(),this.snowFireplaceSmokePS.minEmitPower=this.snowFireplaceSmokePS.maxEmitPower=1,this.snowFireplaceSmokePS.addVelocityGradient(0,.8),this.snowFireplaceSmokePS.addVelocityGradient(1,.5),this.snowFireplaceSmokePS.minLifeTime=1,this.snowFireplaceSmokePS.maxLifeTime=1.5,this.snowFireplaceSmokePS.addColorGradient(0,pe.FromHexString("#0e0e0eFF")),this.snowFireplaceSmokePS.addColorGradient(1,pe.FromHexString("#3e3e3e00")),this.snowFireplaceSmokePS.addSizeGradient(0,1),this.snowFireplaceSmokePS.addSizeGradient(1,.1)}createBuyEffectParticleSystem(){if(!this._flareTexture){console.warn("no flare texture!");return}const t=new He("buyEffectParticles",15,this);t.preventAutoStart=!0,t.startDelay=0,t.particleTexture=this._flareTexture,t.minLifeTime=.1,t.maxLifeTime=.4,t.emitRate=20,t.minEmitPower=5,t.maxEmitPower=6,t.minSize=.1,t.maxSize=.3,t.color1=pe.FromHexString("#FF9200FF"),t.color2=pe.FromHexString("#9406FFFF"),t.colorDead=pe.FromHexString("#000000FF"),t.minInitialRotation=0,t.maxInitialRotation=Math.PI,t.blendMode=He.BLENDMODE_ADD,t.emitter=new g(124,.3,130);const i=t.createConeEmitter(1,Math.PI);i.radiusRange=0,i.heightRange=0,this._buyParticleSystem=t}createRainEffectParticleSystem(){if(!this._flareTexture){console.warn("no flare texture!");return}const t=new He("rainEffectParticles",50,this);t.updateSpeed=.025,t.preventAutoStart=!0,t.startDelay=0,t.preWarmCycles=0,t.preWarmStepOffset=1,t.gravity=g.Zero(),t.particleTexture=this._flareTexture,t.minLifeTime=1,t.maxLifeTime=1,t.emitRate=30,t.minEmitPower=20,t.maxEmitPower=40,t.minSize=.1,t.maxSize=.1,t.minScaleX=.1,t.maxScaleX=.1,t.minScaleY=16,t.maxScaleY=24,t.color1=pe.FromHexString("#FFFFFFFF"),t.color2=pe.FromHexString("#FFFFFFFF"),t.colorDead=pe.FromHexString("#FFFFFF00"),t.minInitialRotation=0,t.maxInitialRotation=0,t.blendMode=He.BLENDMODE_ADD,t.emitter=new g(140,10,140),t.createBoxEmitter(new g(0,-1,0),new g(0,-1,0),new g(-30,0,-30),new g(30,0,30)),this._rainParticleSystem=t}initializeGameScene(){this.createArcCamera();const t=this.defaultCamera;t&&(t.minZ=.05,t.checkCollisions=!1,t.fov=.7),this._whiteTexture=new H(IF,this),this._flareTexture=new H(RF,this),this.createBakerSmokeParticleSystem(),this.createBuyEffectParticleSystem(),this.createRainEffectParticleSystem()}playBuyEffect(t,i){return Ie(this,null,function*(){if(this._buyParticleSystem==null)return;const n=t.clone();n.y=.5,this.activateNewInstance(this._buyParticleSystem),this._buyParticleSystem.reset(),this._buyParticleSystem.emitter=n,this._buyParticleSystem.start(0),yield Te(i),this._buyParticleSystem.stop()})}playRainEffect(){return Ie(this,null,function*(){this._rainParticleSystem!=null&&(this._rainParticleSystem.reset(),this._rainParticleSystem.start())})}stopRainEffect(){return Ie(this,null,function*(){this._rainParticleSystem!=null&&this._rainParticleSystem.stop()})}getGroundHeightAtPosition(t){return 0}getInstanceByKey(t){return this._instantiatedModels[t]}_createTempModel(t){return Ie(this,null,function*(){let i=1,n=1,r=1,a=null;switch(t){case"interactiveArea":case"playerPointer":case"tpArea":case"trashArea":{a=ZE("model_"+t,{thickness:.14,diameter:2,tessellation:9});break}default:return new Promise((o,l)=>{const c=()=>Ie(this,null,function*(){const u=this._modelsPromises[t];if(!u)return setTimeout(()=>c(),500);try{yield u;const h=this._allModels[t];h.length<1?l(new Error("no model")):o(h[0])}catch(h){l(h)}});setTimeout(()=>c(),500)})}switch(a==null&&(a=ha("model"+t,{width:i,height:n,depth:r},this)),a.setEnabled(!1),a.checkCollisions=!1,t){case"interactiveArea":{const o=new J("interactiveAreaMaterial",this);o.diffuseColor=G.Black(),o.specularColor=G.Black(),o.emissiveColor=G.FromHexString("#8b5cf6"),a.material=o;break}case"trashArea":{const o=new J("trashAreaMaterial",this);o.diffuseColor=G.Black(),o.specularColor=G.Black(),o.emissiveColor=G.FromHexString("#e03c17"),a.material=o;break}case"tpArea":{const o=new J("tpAreaMaterial",this);o.diffuseColor=G.Black(),o.specularColor=G.Black(),o.emissiveColor=G.FromHexString("#3ce017"),a.material=o;break}case"playerPointer":{const o=new J("playerPointerMaterial",this);o.diffuseColor=G.Black(),o.specularColor=G.Black(),o.emissiveColor=G.FromHexString("#30a6f0"),a.material=o;break}}return a})}loadModel(t,i=0){return Ie(this,null,function*(){let n=this._allModels[t]||[];if(i<0)throw new Error("variant:"+i);if(n[i]==null){const r=this._loadingModel[t];if(r!=null)return r;const a=this._createTempModel(t);this._loadingModel[t]=a;const o=yield a;return this._allModels[t]==null&&(this._allModels[t]=[]),this._allModels[t][i]=o,o}return n[i]})}getInstanceById(t){return this._instantiatedModels[t]}removeInstanceById(t){delete this._inProgressInstantiations[t];const i=this.getInstanceById(t);if(i==null)return;delete this._instantiatedModels[t];const n=i.model;if(i.key.startsWith("npc")){const a=this._npcPool[i.key];if(!a)return;n.rotation.setAll(0),n.scaling.setAll(.6),a.freeItem({mesh:n,anims:i.animations,customizer:i.customizer});return}const r=this._instancesPool[i.key+i.variant];r!=null?(r.push(n),n.unfreezeWorldMatrix(),n.position.y=1e4,n.scaling.setAll(1),n.freezeWorldMatrix(),this.forceModelToUpdate(n)):(n._unFreeze(),n.dispose())}awaitPool(t){return Ie(this,null,function*(){let i=this._npcPool[t];for(;!(i=this._npcPool[t]);)yield Te(50);return i})}instantiateModel(r){return Ie(this,arguments,function*({id:t,modelKey:i,variant:n=0}){let a=this._instantiatedModels[t];if(!a){const o=this._inProgressInstantiations[t];if(o)return o;const l=new Promise(u=>Ie(this,null,function*(){const h=i.startsWith("npc")?null:yield this.loadModel(i,n);this.onBeforeRenderObservable.addOnce(()=>Ie(this,null,function*(){let d,f,p;if(i.startsWith("npc")){const _=(yield this.awaitPool(i)).getItem();d=_.mesh,f=_.anims,p=_.customizer}else{if(h==null)throw new Error(`can't loaded ${i}!`);const m=i+n;let _=this._instancesPool[m];_==null&&(this._instancesPool[m]=_=[]),_.length>0?d=_.pop():(d=h.createInstance(i+t),d.setParent(h.parent),this.activateNewInstance(d)),this.forceModelToUpdate(d),f=this._allAnimations[i]}d.checkCollisions=!1,d.unfreezeWorldMatrix(),d.position.setAll(0),d.rotate(g.Up(),0),d.rotation=d.rotationQuaternion.toEulerAngles(),d.rotation.x=0,d.rotation.z=0,d.rotationQuaternion=null,d.freezeWorldMatrix(),this.renderingManager.maintainStateBetweenFrames=!1,u({key:i,model:d,animations:f,variant:n,customizer:p})}))}));this._inProgressInstantiations[t]=l;const c=yield l;if(!this._inProgressInstantiations[t])return this.removeInstanceById(t),c;a=this._instantiatedModels[t]=c,delete this._inProgressInstantiations[t]}return a})}playClearingBuildingAnim(t,i){t.bus.onBuildingAnimationClear.notifyObservers(i)}playAllBuildingAnim(t,i,n){n>.999?t.bus.onBuildingFinished.notifyObservers({key:i}):t.bus.onBuildingAnimationProgress.notifyObservers({producer:i,progress:n})}activateNewInstance(t){this._activeMeshesFrozen=!1,this.forceModelToUpdate(t),this.onAfterRenderObservable.addOnce(()=>{this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!0})}forceModelToUpdate(t){if(this.renderingManager.maintainStateBetweenFrames=!1,t._unFreeze!=null&&t._unFreeze(),t._internalAbstractMeshDataInfo!=null&&(t._internalAbstractMeshDataInfo._isActive=!1),t.isAnInstance){const i=t.sourceMesh;i._unFreeze(),i._internalAbstractMeshDataInfo!=null&&(i._internalAbstractMeshDataInfo._isActive=!1)}}}const xF=new URL("assets/Worker_Male.e0e0c3ae.glb",location.href).href,MF=""+new URL("anims-41406b6a.json",import.meta.url).href;class PF{constructor(e,t,i,n,r){X(this,"ranges",[]);X(this,"animsForRanges");X(this,"_instances",[]);this.scene=e,this.mesh=t,this.ags=i,this.partsMap=n,this.commitTexture=r,i.reduce((a,o,l)=>{if(l===0)a.push({from:Math.floor(o.from),to:Math.floor(o.to)});else{const c=a[l-1];a.push({from:c.to+1,to:c.to+1+Math.floor(o.to)})}return a},this.ranges),this.animsForRanges=this.ranges.map(a=>{const o=new B("anim.x","x",60,B.ANIMATIONTYPE_FLOAT,B.ANIMATIONLOOPMODE_CONSTANT,!1),l=new B("anim.y","y",60,B.ANIMATIONTYPE_FLOAT,B.ANIMATIONLOOPMODE_CONSTANT,!1);return o.setKeys([{frame:0,value:a.from}]),l.setKeys([{frame:0,value:a.to}]),[o,l]}),this.setAnimationParameters(t),this.freeItem({mesh:t,anims:this.createAnimationGroupsForInstance(t),customizer:new Ae(n,t,0,r)})}getItem(){if(this._instances.length>0){const n=this._instances[this._instances.length-1];return this._instances.length--,n}const e=this.createMeshInstance($.id()),t=this.createAnimationGroupsForInstance(e),i=new Ae(this.partsMap,e,this.mesh.instances.length,this.commitTexture);return{mesh:e,anims:t,customizer:i}}freeItem(e){e.mesh.unfreezeWorldMatrix(),e.mesh.position.y=1e3,e.mesh.freezeWorldMatrix(),this.scene.forceModelToUpdate(e.mesh),this._instances.push(e)}setAnimationParameters(e,t=0){const i=this.ranges[t],n=Math.floor(i.from),r=Math.floor(i.to),a=Math.floor(Math.random()*(r-n-1));e.instancedBuffers.bakedVertexAnimationSettingsInstanced=new dt(n,r-1,a,60)}createMeshInstance(e,t){const i=this.mesh.createInstance("npc_inst"+e);return i.instancedBuffers.color=new pe(this.mesh.instances.length,0,0,1),this.setAnimationParameters(i,t),i.unfreezeWorldMatrix(),i.position.y=1e3,i.freezeWorldMatrix(),this.scene.activateNewInstance(i),i}createGroupForRange(e,t,i){const n=new ao(t,this.scene);return i.forEach(r=>n.addTargetedAnimation(r,e.instancedBuffers.bakedVertexAnimationSettingsInstanced)),n.onAnimationGroupPlayObservable.add(r=>{e.instancedBuffers.bakedVertexAnimationSettingsInstanced.w=60*r.speedRatio}),n}createAnimationGroupsForInstance(e){return this.ags.reduce((t,i,n)=>(t.push(this.createGroupForRange(e,i.name,this.animsForRanges[n])),t),[])}}function DF(s,e,t){return Ie(this,null,function*(){const i=new RM(s,e),n=new Ia(s);e.bakedVertexAnimationManager=n;let r;return typeof t=="string"?r=i.loadBakedVertexDataFromJSON(t):Array.isArray(t)?r=yield OF(e,t):n.texture=t,e.registerInstancedBuffer("bakedVertexAnimationSettingsInstanced",4),r!=null&&(n.texture=i.textureFromBakedVertexData(r)),s.registerBeforeRender(()=>{s.deltaTime!=null&&(n.time+=s.deltaTime/1e3)}),n})}function OF(s,e){return Ie(this,null,function*(){const t=s.skeleton,i=t.bones.length,n=e.reduce((c,u)=>c+(Math.floor(u.to)-Math.floor(u.from))+1,0);let r=0;const a=(i+1)*4*4*n,o=new Float32Array(a);function*l(){const c=t.getTransformMatrices(s);o.set(c,r*c.length)}for(const c of e){c.reset();const u=Math.floor(c.from),h=Math.floor(c.to);for(let d=u;d<=h;d++)c.start(!1,1,d,d,!1),yield c.onAnimationEndObservable.runCoroutineAsync(l()),r++,c.stop()}return o})}const wF={zVillage:{name:"zVillage",env:{PlaneMounts:[0,0,0,100,100,100,4.712,0,0],SM_Env_Tree_03:[-129.48,-.15,116.17,1.095,1.095,1.095,0,-.9,0,-145.49,-.15,115.87,1.095,1.095,1.095,0,-2.066,0,-138.85,.2,115.05,1.008,1.008,1.008,0,-.9,0,-132.69,-.15,110.48,1.095,1.095,1.095,0,-2.609,0,-139.39,-.15,110.51,1.095,1.095,1.095,0,-.304,0,-125.57,-.15,110.53,1.095,1.095,1.095,0,-.9,0,-117.27,-.15,109.63,1.095,1.095,1.095,0,-5.859,0],SM_Env_Path_Wood_Side_01:[-158.13,-1.57,137.33,1.574,1.574,1.574,0,-1.519,0,-157.93,-1.19,144.79,1,1.149,1,0,-1.559,0,-158.13,-1.799,131.14,1.671,1.671,1.671,0,-1.501,0],SM_Env_Bushes_03:[-155.4,-.114,132.67,.562,.562,.562,.077,-5.498,-6.207,-151.27,-.34,138.8,.682,.682,.682,.013,-2.931,-.06,-130.64,-.29,121.74,.998,.998,.998,6.233,-.59,-.05,-143.71,-.08,144.7,.563,.563,.563,.043,-.715,-.009,-151.54,-.31,144.17,.409,.409,.514,.077,-5.498,-6.207,-115.04,-.46,145.12,.621,.621,.621,0,-3.45,0,-143.39,-.11,128.04,.476,.476,.476,.077,-3.729,-6.207,-127.34,-.708,125.42,.822,.822,.822,0,-3.142,0,-118.73,.056,130.11,.682,.682,.682,0,0,0,-117.35,-.36,115.09,1.479,1.479,1.479,0,-2.338,0,-124.89,-.36,115.51,1.045,1.045,1.045,0,-3.443,0,-133.41,-.36,115.21,1.331,1.331,1.331,0,-3.443,0,-117.78,-.15,121.87,.574,.574,.574,0,-6.072,0,-137.82,-.61,147.52,.794,.794,.794,.077,-2.357,-6.207,-130.65,-.09,127.65,.509,.509,.509,0,-4.158,0,-122.65,-.118,148.64,.516,.516,.516,0,-5.042,0],SM_Env_Rock_02:[-117.35,-1.58,138.76,.682,1.182,.549,0,0,0,-117.246,-1.58,138.602,.64,1.109,.515,0,-4.429,0,-158.87,-.64,139.64,.275,.12,.231,0,0,-6.031],SM_Prop_Log_Big_02:[-139.07,.1,126.53,.512,.512,.051,1.529,-3.142,-2.206,-148.61,.107,133.495,.524,.524,.052,1.529,-3.142,-3.142,-147.51,.002,133.831,.399,.399,.04,1.529,-3.142,-2.206,-149.51,-.02,133.96,.445,.445,.045,1.529,-3.142,-4.114,-147.56,.02,127.11,.524,.524,.052,1.529,-3.142,-3.142,-151.1,.03,130.35,.524,.524,.052,1.529,-3.142,-3.142],SM_Env_Flax_03:[-131.34,.106,135.04,1,1,1,0,0,0,-137.891,.106,142.714,1.063,1.063,1.063,0,-.268,0,-154.14,-.058,140.88,1.413,1.413,1.413,0,-.268,0,-149.67,.147,145.54,1.251,1.251,1.251,0,-.268,0,-151.314,.147,149.026,.988,.988,.988,0,-.268,0,-147.08,.147,142.38,1.382,1.382,1.382,0,-.268,0,-133.53,.096,144.56,1.063,1.063,1.063,0,-.268,0,-130.258,.145,142.882,1.063,1.063,1.063,0,-.268,0,-127.26,.096,145.46,1.063,1.063,1.063,0,-.268,0,-126.8,.096,133.32,1.063,1.063,1.063,0,-.268,0,-119.96,.096,129.96,1.063,1.063,1.063,0,-.268,0,-125.52,.096,125.71,1.063,1.063,1.063,0,-.268,0,-114.61,.096,134.56,1.063,1.063,1.063,0,-.268,0,-114.49,.083,131.52,1.096,1.096,1.096,0,-6.119,0,-122.484,.096,134.383,.7,.7,.7,0,-1.539,0,-118.58,.096,137.38,1.266,1.266,1.266,0,-.268,0,-117.55,.132,142.12,.908,.908,.908,0,-.268,0,-145.23,-.1,133.87,1.246,1.246,1.246,0,-1.249,0,-151.54,-.093,135.073,1.821,1.821,1.821,.092,-2.294,-6.18],SM_Env_Flowers_01:[-129.1,-.148,135.09,1,1,1,0,0,0,-142.082,.005,144.182,1,1,1,0,-.095,0,-118.2,-.13,128.09,1,1,1,0,-4.661,0,-121.637,.017,136.086,1.096,.885,1.096,0,-.537,0,-151.23,-.05,142.26,1,1,1,0,-5.187,0,-152.21,-.19,129.43,.908,.908,.652,0,-5.187,0,-123.02,-.13,151.52,.704,.704,.506,0,-5.187,0,-114.19,-.156,145.01,.766,.766,.55,0,-5.187,0,-127.779,.23,147.616,.635,.514,.558,0,-5.187,0,-145.14,-.09,124.78,.9,.9,.9,0,-3.368,0],PlaneGround:[-138,0,125,100,100,100,4.712,0,0],trashBin:[-127,-.078,135.8,1.691,1.691,1.691,0,0,0]},buildings:{pHome:{statics:{},finish:{SM_Prop_Log_Big_02:[-116.282,.223,125.046,.173,.191,.073,5.657,-1.795,-6.15,-116.282,.204,125.046,.181,.2,.065,5.645,-5.305,0,-116.282,.109,125.046,.155,.172,.057,0,-3.677,-.486],SM_Env_DirtRoad_Straight_01:[-115.89,-.084,125.05,.171,.4,.075,0,-1.571,0],SM_Env_Rock_02:[-116.296,.03,124.686,.104,.061,.059,0,0,0,-116.548,.002,125.281,.1,.059,.057,0,-.933,0,-115.883,.03,125.178,.102,.059,.055,0,-2.229,0,-115.955,.03,124.851,.103,.061,.055,0,-.991,0,-116.161,.049,125.372,.118,.065,.063,0,-3.002,0,-116.598,-.004,124.935,.105,.061,.06,5.806,-5.425,-6.138],SM_Bld_House_Roof_Thatch_Peak_Cap_Half_01:[-112.98,2.243,122.64,5.25,2,3.236,0,-3.142,0]},parts:{SM_Prop_Log_Big_02:[-111.98,.224,124.714,.39,.39,.405,0,-3.142,0,-111.98,.574,124.709,.411,.411,.402,0,-3.142,-4.812,-111.98,.914,124.714,.404,.404,.395,0,-3.142,0,-111.98,1.254,124.689,.404,.404,.388,0,-3.142,-.442,-111.98,1.588,124.689,.404,.404,.403,0,-3.142,-5.308,-111.98,1.913,124.689,.404,.404,.403,0,-3.142,-.4,-113.98,.079,125.899,.39,.39,.114,0,-3.142,-5.969,-113.98,.429,125.918,.411,.411,.12,0,-3.142,-.449,-113.98,.769,125.913,.404,.404,.118,0,-3.142,0,-113.98,1.089,125.926,.404,.404,.118,0,-3.142,-1.607,-113.98,1.409,125.922,.393,.393,.115,0,-3.142,-5.32,-113.98,1.723,125.922,.393,.393,.115,0,-3.142,-4.101,-113.98,2.03,124.66,.393,.393,.402,0,-3.142,-4.101,-113.96,.094,123.579,.39,.39,.13,0,-3.142,-5.969,-113.96,.444,123.579,.411,.411,.136,0,-3.142,-.449,-113.96,.784,123.552,.404,.404,.134,0,-3.142,0,-113.96,1.104,123.581,.404,.404,.134,0,-3.142,-1.607,-113.96,1.424,123.579,.39,.39,.13,0,-3.142,-6.178,-113.96,1.753,123.579,.39,.39,.13,0,-3.142,-5.105,-112.912,.074,123.26,.39,.39,.277,0,-1.571,0,-112.912,.424,123.26,.411,.411,.291,0,-1.571,-5.539,-112.908,.764,123.26,.404,.404,.286,0,-1.571,-.781,-112.926,1.104,123.26,.404,.404,.281,0,-1.571,0,-112.926,1.438,123.26,.404,.404,.292,0,-1.571,-6.023,-112.926,1.748,123.26,.404,.404,.292,0,-1.571,-.369,-112.926,2.074,123.26,.404,.404,.292,0,-1.571,-6.028,-112.938,.074,126.16,.39,.39,.277,0,-4.712,0,-112.938,.424,126.16,.411,.411,.291,0,-4.712,-5.539,-112.942,.764,126.16,.404,.404,.286,0,-4.712,-.781,-112.924,1.104,126.16,.404,.404,.281,0,-4.712,0,-112.924,1.438,126.16,.404,.404,.292,0,-4.712,-6.023,-112.924,1.748,126.16,.404,.404,.292,0,-4.712,-.369,-112.924,2.074,126.16,.404,.404,.292,0,-4.712,-6.028]},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[],animateMesh:"",purchases:{}},pPub:{statics:{},finish:{SM_Prop_Plank_02_orig:[-112.176,.779,134.54,.863,1,1.04,0,0,0,-112.26,.676,133.74,.812,2.618,1.655,0,0,0,-112.184,1.403,134.54,.894,1,1.04,0,0,0],SM_Env_DirtRoad_Straight_01:[-112.37,-.06,135.09,.914,.3,.431,0,-3.142,0],SM_Bld_House_Roof_Thatch_Peak_Cap_Half_01:[-112.02,2.31,135.57,8.8,2.75,4.43,0,0,0]},parts:{SM_Prop_Log_Big_02:[-112.116,.19,134.83,.39,.39,.564,0,-1.571,0,-112.067,.54,134.83,.411,.411,.56,0,-1.571,-4.812,-112.06,.88,134.83,.404,.404,.55,0,-1.571,0,-112.095,1.22,134.83,.404,.404,.541,0,-1.571,-.442,-112.095,1.554,134.83,.404,.404,.561,0,-1.571,-5.308,-112.06,1.878,134.83,.404,.404,.55,0,-1.571,0,-114.04,.05,131.095,.39,.39,.139,0,0,-5.969,-114.04,.4,131.051,.411,.411,.146,0,0,-.449,-114.04,.74,131.071,.404,.404,.144,0,0,0,-114.04,1.06,131.049,.404,.404,.144,0,0,-1.607,-114.04,1.38,131.024,.393,.393,.14,0,0,-5.32,-114.04,1.722,131.051,.411,.411,.146,0,0,-.449,-112.16,.19,130.77,.397,.397,.543,0,-1.571,-5.705,-112.16,.54,130.77,.411,.411,.562,0,-1.571,-.409,-112.153,.88,130.77,.404,.404,.552,0,-1.571,-1.517,-110.361,1.23,130.77,.404,.404,.178,0,-1.571,0,-113.777,1.23,130.77,.404,.404,.178,0,-1.571,-5.168,-113.777,1.564,130.77,.418,.418,.184,0,-1.571,-3.458,-110.394,1.552,130.77,.389,.389,.171,0,-1.571,-1.65,-112.16,1.903,130.77,.411,.411,.562,0,-1.571,-.409,-110.01,.04,132.819,.39,.39,.515,0,0,0,-110.01,.39,132.819,.411,.411,.543,0,0,-5.539,-110.01,.73,132.812,.404,.404,.533,0,0,-.781,-110.01,1.07,132.845,.404,.404,.524,0,0,0,-110.01,1.404,132.845,.404,.404,.543,0,0,0,-110.01,1.741,132.845,.404,.404,.543,0,0,0,-110.01,2.105,132.812,.404,.404,.533,0,0,-.781,-114.04,.042,134.259,.39,.39,.234,0,0,-5.969,-114.04,.392,134.302,.411,.411,.246,0,0,-.449,-114.04,.732,134.308,.404,.404,.242,0,0,0,-114.04,1.052,134.295,.404,.404,.242,0,0,-1.607,-114.04,1.379,134.259,.39,.39,.234,0,0,-5.969,-114.04,1.7,134.302,.411,.411,.246,0,0,-.449,-114.04,2.049,132.876,.411,.411,.553,0,0,-5.484]},disabledOnFinish:{SM_Prop_Plank_02_orig:[-114.07,.189,134.82,.1,.5,.2,0,0,-1.571,-110.07,.189,134.82,.1,.5,.2,0,0,-1.571,-114.07,.189,130.82,.1,.5,.2,0,0,-1.571,-110.07,.189,130.82,.1,.5,.2,0,0,-1.571]},staticsDisabledOnFinish:{},clearing:{SM_Env_Bushes_03:[-112.82,.09,133.45,.926,.926,.926,0,-2.931,0]},animate:[-110.01,.04,132.819,.39,.39,.515,0,0,0,-112.16,.19,130.77,.397,.397,.543,0,-1.571,-5.705,-112.116,.19,134.83,.39,.39,.564,0,-1.571,0,-114.04,.05,131.095,.39,.39,.139,0,0,-5.969,-114.04,.042,134.259,.39,.39,.234,0,0,-5.969,-113.823,.042,134.578,.39,.39,.234,1.571,-.314,0,-113.718,.042,131.056,.39,.39,.234,1.571,-.314,0,-110.348,.042,134.566,.39,.39,.234,1.571,-.314,0,-110.304,.042,131.078,.39,.39,.234,1.571,-.314,0],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pBaker:{statics:{},finish:{SM_Prop_Plank_02_orig:[-138.012,.673,142.816,.237,1,1.58,.016,0,0],SM_Prop_Brick_02:[-137.139,.54,144.575,1,1,1,0,-3.16,0,-137.69,.54,144.561,1,1,1,0,-3.16,0,-137.139,.54,143.749,1,1,1,0,-3.142,0,-137.69,.54,143.738,1,1,1,0,-3.16,0,-137.409,.54,144.016,1,1,1,0,-1.571,0,-137.145,.157,144.563,2,1,1,0,-3.142,0,-137.145,.157,143.741,2,1,1,0,-3.142,0,-137.394,.347,143.741,2,1,1,0,-1.571,0,-137.407,.346,143.742,1,1,1,0,-3.142,0,-138.237,.346,143.728,1,1,1,0,-1.571,0,-138.227,.532,144.835,1,1,1,0,-1.571,-3.142,-138.233,.54,143.995,1,1,1,0,-1.571,0,-137.394,.731,143.741,2,1,1,0,-1.571,0,-137.407,.725,143.742,1,1,1,0,-3.142,0,-137.407,.346,144.583,1,1,1,0,-3.142,0,-137.407,.725,143.975,1,1,2.691,0,-3.142,0,-138.237,.745,143.728,1,1,1,0,-1.571,0,-137.979,.745,144.821,1,1,1,0,-4.712,0,-137.139,.933,144.575,1,1,1,0,-3.16,0,-137.69,.933,144.561,1,1,1,0,-3.16,0,-137.139,.933,143.749,1,1,1,0,-3.142,0,-137.69,.933,143.738,1,1,1,0,-3.16,0,-137.409,.946,144.016,1,1,1,0,-1.571,0,-137.404,1.131,143.741,2,1,1,0,-1.571,0,-137.407,1.122,143.742,1,1,1,0,-3.142,0,-137.407,1.122,144.583,1,1,1,0,-3.142,0,-137.959,1.127,143.729,.5,1,1,0,-3.142,0,-137.968,1.127,144.832,.5,1,1,0,-4.712,0,-137.139,1.322,144.575,1,1,1,0,-3.16,0,-137.69,1.322,144.561,1,1,1,0,-3.16,0,-137.139,1.322,143.749,1,1,1,0,-3.142,0,-137.69,1.322,143.738,1,1,1,0,-3.16,0,-137.409,1.335,144.016,1,1,1,0,-1.571,0,-137.394,1.493,143.741,2,1,1,0,-1.571,0,-137.407,1.487,143.742,1,1,1,0,-3.142,0,-138.237,1.507,143.728,1,1,1,0,-1.571,0,-137.979,1.507,144.821,1,1,1,0,-4.712,0,-137.407,1.487,144.583,1,1,1,0,-3.142,0,-137.139,1.706,144.575,1,1,1,0,-3.16,0,-137.69,1.706,144.561,1,1,1,0,-3.16,0,-137.139,1.706,143.749,1,1,1,0,-3.142,0,-137.69,1.706,143.738,1,1,1,0,-3.16,0,-137.409,1.719,144.016,1,1,1,0,-1.571,0,-138.234,1.896,144.543,1,1,1,0,-1.571,-3.142,-137.407,1.894,143.742,1,1,1,0,-3.142,0,-137.407,1.894,144.583,1,1,1,0,-3.142,0,-138.237,1.909,143.728,1,1,1,0,-1.571,0,-137.979,1.902,144.821,1,1,1,0,-4.712,0,-137.411,1.905,143.728,1,1,1,0,-1.571,0,-137.153,1.903,144.821,1,1,1,0,-4.712,0,-137.139,2.111,143.905,1,1,1,0,-3.142,0,-137.69,2.111,143.894,1,1,1,0,-3.16,0,-137.139,2.088,144.443,1,1,1,0,-3.16,0,-137.69,2.088,144.429,1,1,1,0,-3.16,0,-137.149,2.091,144.165,.5,1,1,0,-3.142,0,-137.69,2.088,144.165,1,1,1,0,-3.16,0,-137.402,3.03,144.73,1,1,1,0,-3.16,0,-137.402,3.03,144.455,1,1,1,0,-1.571,0,-137.138,3.03,144.203,1,1,1,0,-3.16,0,-137.945,3.03,144.18,1,1,1,0,-1.571,0,-137.402,3.237,144.182,1,1,1,0,-1.571,0,-137.152,3.233,144.73,1,1,1,0,-3.16,0,-137.395,3.236,144.203,1,1,1,0,-3.16,0,-137.945,3.24,144.455,1,1,1,0,-1.571,0],SM_Bld_House_Roof_Thatch_Peak_Cap_Half_01:[-136.38,2.289,144.108,5.25,2.201,4.109,0,-4.712,0],SM_Env_Fence_Woof_03:[-135.97,-.079,145.34,1.142,1,1,0,-4.677,0,-142.2,-.079,142.95,1.285,1,1,0,-1.553,0,-142.08,-.079,146.12,1.605,1,1,0,-.017,0]},parts:{SM_Prop_Plank_02_orig:[-138.886,.31,144.01,.41,.4,1,0,-1.58,0,-138.489,.31,144.01,.41,.4,1,0,-1.571,0,-139.282,.31,144.01,.41,.4,1,0,-1.571,0,-139.675,.31,144.01,.41,.4,1,0,-1.562,0,-140.09,.31,144.01,.41,.4,1,0,-1.571,0,-140.449,.31,144.01,.41,.4,1,0,-1.571,0,-140.793,.31,144.01,.41,.4,1,0,-1.571,0],SM_Prop_Log_Big_02:[-140.972,.12,144.088,.39,.39,.265,0,0,0,-140.972,.47,144.088,.411,.411,.279,0,0,0,-140.972,.81,144.085,.404,.404,.274,0,0,0,-140.972,1.15,144.102,.404,.404,.269,0,0,0,-140.972,1.484,144.102,.418,.418,.289,0,0,0,-140.972,1.827,144.102,.418,.418,.278,0,0,-.998,-140.972,2.138,144.102,.418,.418,.278,0,0,-6.234,-139.035,.45,143.252,.39,.39,.085,0,0,-6.043,-139.035,.777,143.252,.39,.39,.085,0,0,-5.383,-139.035,1.114,143.252,.39,.39,.085,0,0,-4.777,-139.035,1.444,143.252,.39,.39,.085,0,0,-5.388,-139.035,1.775,143.252,.39,.39,.085,0,0,-5.388,-139.035,.1,143.252,.39,.39,.085,0,0,-6.043,-138.05,.27,143.074,.397,.397,.316,0,-1.571,-5.705,-138.05,.62,143.074,.411,.411,.327,0,-1.571,-.409,-138.046,.96,143.074,.404,.404,.321,0,-1.571,-1.517,-137.004,1.31,143.074,.404,.404,.103,0,-1.571,0,-138.991,1.3,143.074,.404,.404,.103,0,-1.571,-5.168,-138.991,1.644,143.074,.418,.418,.107,0,-1.571,-5.168,-137.023,1.632,143.074,.389,.389,.1,0,-1.571,-1.65,-138.964,.27,144.983,.39,.39,.518,0,-1.571,0,-138.964,.62,144.983,.411,.411,.525,0,-1.571,-4.812,-138.957,.96,144.983,.404,.404,.523,0,-1.571,0,-138.991,1.3,144.983,.404,.404,.527,0,-1.571,-.442,-138.984,1.634,144.983,.404,.404,.526,0,-1.571,-5.308,-138.957,1.96,144.983,.404,.404,.536,0,-1.571,0,-137,.12,144.012,.39,.39,.277,0,0,0,-137,.47,144.012,.411,.411,.291,0,0,-5.539,-137,.81,144.008,.404,.404,.286,0,0,-.781,-137,1.15,144.026,.404,.404,.281,0,0,0,-137,1.484,144.026,.404,.404,.292,0,0,0,-137,1.825,144.026,.404,.404,.281,0,0,0,-137,2.16,144.026,.404,.404,.281,0,0,0,-140.968,.27,143.18,.39,.39,.081,0,-1.571,-5.969,-140.968,.62,143.18,.411,.411,.085,0,-1.571,-.449,-140.984,.96,143.18,.404,.404,.083,0,-1.571,0,-140.967,1.28,143.18,.404,.404,.083,0,-1.571,-1.607,-140.967,1.605,143.18,.404,.404,.083,0,-1.571,-4.712,-138.965,1.954,143.18,.404,.404,.537,0,-1.571,-4.712]},disabledOnFinish:{SM_Prop_Plank_02_orig:[-141,.18,145.08,.1,.5,.2,0,0,-1.571,-137,.18,145.08,.1,.5,.2,0,0,-1.571,-141,.18,143.08,.1,.5,.2,0,0,-1.571,-137,.18,143.08,.1,.5,.2,0,0,-1.571]},staticsDisabledOnFinish:{},clearing:{SM_Env_Bushes_03:[-137.43,.59,145.77,1.133,1.133,1.133,0,-2.931,0]},animate:[-139,.04,144.69,.39,.39,.54,0,-1.571,0,-136.95,.19,143.85,.397,.397,.249,0,-3.142,-5.705,-141.01,.19,144.034,.39,.39,.273,0,-3.142,0,-138.02,.05,143.1,.39,.39,.304,0,-1.571,-5.969,-140.96,.042,143.13,.39,.39,.095,0,-1.571,-5.969,-140.74,.042,143.4,.39,.39,.234,1.571,-1.885,0,-137.235,.042,143.402,.39,.39,.234,1.571,-1.885,0,-140.685,.042,144.38,.39,.39,.234,1.571,-1.885,0,-137.245,.042,144.419,.39,.39,.234,1.571,-1.885,0],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pMarket:{statics:{},finish:{SM_Prop_Plank_02_orig:[-123.762,1.169,133.746,.031,3.189,1.108,0,-1.571,0,-123.762,1.141,133.977,.023,1.192,1.108,0,-1.571,0,-123.762,1.179,133.832,.054,1.734,1.108,0,-1.571,-.591,-121.81,1.03,133.94,.255,12.891,.142,0,-3.142,0],SM_Env_Path_Wood_02:[-124.9,-.09,131.48,1,1,1,0,-3.142,0],SM_Bld_House_Roof_Thatch_Peak_Cap_Half_01:[-127.05,2.32,135.08,5.71,2.541,3.48,0,-1.571,0],SM_Env_Fence_Woof_03:[-120.81,-.149,136.38,1.142,1,1,0,-4.677,0,-123.28,-.149,137.01,1,1,1,0,0,0],SM_Prop_Barrel_01_copy:[-125.93,.24,136.76,.93,.93,.93,0,0,0],pb_Mesh104748:[-121.662,1.281,133.841,2.212,2.212,1.664,0,-3.142,0]},parts:{SM_Prop_Log_Big_02:[-126.16,.05,134.909,.39,.39,.328,0,0,-3.789,-126.16,.4,134.909,.411,.411,.345,0,0,-.441,-126.16,.74,134.905,.404,.404,.339,0,0,0,-126.16,1.08,134.926,.404,.404,.333,0,0,-5.493,-126.16,1.414,134.926,.404,.404,.346,0,0,0,-126.16,1.738,134.909,.411,.411,.345,0,0,-.441,-126.16,2.055,134.905,.404,.404,.339,0,0,0,-124.596,.2,136.02,.39,.39,.414,0,-1.571,-1.517,-124.596,.55,136.02,.411,.411,.436,0,-1.571,-4.751,-124.591,.89,136.02,.404,.404,.428,0,-1.571,-5.728,-124.617,1.23,136.02,.404,.404,.421,0,-1.571,0,-124.617,1.564,136.02,.404,.404,.437,0,-1.571,-.717,-124.596,1.906,136.02,.411,.411,.436,0,-1.571,-4.751,-123.12,.05,134.899,.39,.39,.328,0,0,0,-123.12,.4,134.899,.411,.411,.345,0,0,-1.498,-123.12,.74,134.895,.404,.404,.339,0,0,-5.277,-123.12,1.08,134.916,.404,.404,.333,0,0,-5.854,-123.12,1.414,134.916,.404,.404,.346,0,0,0,-123.12,1.758,134.899,.411,.411,.345,0,0,-1.498,-123.12,2.05,134.899,.411,.411,.345,0,0,-1.498,-123.469,.214,133.82,.39,.39,.169,0,-1.571,-5.532,-123.469,.55,133.82,.411,.411,.178,0,-1.571,-.65,-123.466,.89,133.82,.404,.404,.175,0,-1.571,-1.731,-123.453,-.086,133.82,.39,.39,.169,0,-1.571,-5.316,-123.069,1.233,133.82,.39,.39,.065,0,-1.571,-5.532,-123.069,1.555,133.82,.39,.39,.065,0,-1.571,-4.347,-125.846,.213,133.82,.39,.39,.138,0,-1.571,-5.142,-125.846,.55,133.82,.411,.411,.146,0,-1.571,0,-125.844,.89,133.82,.404,.404,.143,0,-1.571,-1.108,-125.844,1.21,133.82,.404,.404,.143,0,-1.571,-2.187,-125.833,-.061,133.82,.366,.366,.13,0,-1.571,-3.886,-125.844,1.551,133.82,.404,.404,.143,0,-1.571,-2.187,-124.585,1.896,133.82,.411,.411,.426,0,-1.571,0]},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[],animateMesh:"",purchases:{}},pWinery:{statics:{},finish:{SM_Env_Path_Wood_02:[-134.89,-.099,139.39,1,1,1,0,-3.142,0],SM_Prop_Plank_02_orig:[-131.405,.146,143.696,.41,.4,1,0,-1.571,0,-131.786,.146,143.696,.41,.4,1,0,-1.571,0,-132.215,.146,143.696,.41,.4,1,0,-1.571,0,-132.665,.109,143.696,.41,.4,1,0,-1.571,0],SM_Bld_House_Roof_Thatch_Peak_Cap_Half_01:[-132.05,2.39,145.48,5.25,2.77,2.6,0,0,0]},parts:{SM_Prop_Log_Big_02:[-132.069,.27,144.81,.39,.39,.293,0,-1.571,0,-132,.62,144.81,.411,.411,.291,0,-1.571,-4.812,-131.997,.96,144.81,.404,.404,.285,0,-1.571,0,-132.015,1.3,144.81,.404,.404,.281,0,-1.571,-.442,-132.015,1.634,144.81,.404,.404,.291,0,-1.571,-5.308,-132.015,1.959,144.81,.404,.404,.291,0,-1.571,-.4,-133.06,.125,143.028,.39,.39,.081,0,0,-5.969,-133.06,.475,143.028,.411,.411,.085,0,0,-.449,-133.06,.815,143.014,.404,.404,.083,0,0,0,-133.06,1.135,143.001,.404,.404,.083,0,0,-1.607,-133.06,1.455,142.986,.393,.393,.081,0,0,-5.32,-133.06,1.769,142.986,.393,.393,.081,0,0,-4.101,-133.06,2.076,143.886,.393,.393,.29,0,0,-4.101,-132.038,.27,142.901,.397,.397,.285,0,-1.571,-5.705,-132.038,.585,142.901,.411,.411,.295,0,-1.571,-.409,-132.034,.924,142.901,.404,.404,.29,0,-1.571,-1.517,-131.093,1.255,142.901,.404,.404,.093,0,-1.571,0,-132.887,1.279,142.901,.404,.404,.093,0,-1.571,-5.168,-132.887,1.605,142.901,.418,.418,.096,0,-1.571,-3.458,-131.111,1.561,142.901,.389,.389,.09,0,-1.571,-1.65,-131.111,1.89,142.901,.389,.389,.09,0,-1.571,-2.67,-132.887,1.955,142.901,.418,.418,.096,0,-1.571,-2.241,-132.034,2.249,142.901,.404,.404,.29,0,-1.571,-1.517,-131.03,.12,143.892,.39,.39,.277,0,0,0,-131.03,.47,143.892,.411,.411,.291,0,0,-5.539,-131.03,.81,143.888,.404,.404,.286,0,0,-.781,-131.03,1.15,143.906,.404,.404,.281,0,0,0,-131.03,1.484,143.906,.404,.404,.292,0,0,-6.023,-131.03,1.794,143.906,.404,.404,.292,0,0,-.369,-131.03,2.12,143.906,.404,.404,.292,0,0,-6.028,-133.03,.14,144.808,.39,.39,.081,0,0,-5.969,-133.03,.49,144.808,.411,.411,.085,0,0,-.449,-133.03,.83,144.824,.404,.404,.083,0,0,0,-133.03,1.15,144.807,.404,.404,.083,0,0,-1.607,-133.03,1.47,144.808,.39,.39,.081,0,0,-6.178,-133.03,1.799,144.808,.39,.39,.081,0,0,-5.105]},disabledOnFinish:{SM_Prop_Plank_02_orig:[-133,.25,144.86,.1,.5,.2,0,0,-1.571,-131,.25,144.86,.1,.5,.2,0,0,-1.571,-133,.25,142.86,.1,.5,.2,0,0,-1.571,-131,.25,142.86,.1,.5,.2,0,0,-1.571]},staticsDisabledOnFinish:{},clearing:{SM_Env_Bushes_03:[-132.14,.09,145.504,.686,.686,.686,0,-2.931,0,-133.27,-.04,143.58,.822,.822,.822,0,-4.369,0]},animate:[-130.998,.04,143.86,.39,.39,.288,0,0,0,-132.072,.19,142.917,.397,.397,.287,0,-1.571,-5.705,-132.046,.19,144.82,.39,.39,.273,0,-1.571,0,-132.98,.05,143.058,.39,.39,.107,0,0,-5.969,-132.95,.042,144.724,.39,.39,.095,0,0,-5.969,-132.665,.042,144.584,.39,.39,.234,1.571,-.314,0,-132.686,.042,143.221,.39,.39,.234,1.571,-.314,0,-131.277,.042,144.58,.39,.39,.234,1.571,-.314,0,-131.251,.042,143.216,.39,.39,.234,1.571,-.314,0],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pSawmill:{statics:{},finish:{SM_Env_DirtRoad_Straight_01:[-129.92,-.06,128.138,.829,.3,.541,0,-3.142,0],SM_Prop_Log_Big_02:[-129.607,.847,125.208,.879,.754,.47,0,-3.142,0,-131.23,.25,120.738,.628,.628,.613,0,-4.706,0],SM_Item_Saw_01:[-129.574,.3,125.158,3.774,2.374,3.774,0,0,0],thinRoof:[-128.57,2.69,122.268,2.08,1.51,2.34,0,-3.142,-5.923],SM_Env_Fence_Woof_03:[-131.22,0,128.148,1,1,1,0,-.087,0,-128.14,0,128.208,1,1,1,0,-4.712,0,-128.054,0,125.722,1,1,1,0,-4.712,0,-128.13,0,122.768,1,1,1,0,-4.712,0,-132.472,0,122.218,.738,1,1,0,-.089,0,-134.17,0,120.266,.87,1,1,0,-1.606,0]},parts:{SM_Prop_Log_Big_02:[-130.9,1.16,123.168,.503,.503,.491,1.571,-6.164,0,-130.9,1.16,127.148,.503,.503,.491,1.571,-4.712,0,-128.89,.372,127.148,.503,.503,.491,1.571,-4.712,0,-128.89,.372,123.178,.503,.503,.491,1.571,-4.712,0,-128.884,2.399,125.158,.647,.647,.565,0,0,0]},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[],animateMesh:"",purchases:{}},pWell:{statics:{},finish:{pb_Mesh95050:[-131.363,.172,136.073,.337,.4,.31,0,-1.571,0],SM_Env_Path_Wood_02:[-134.7,-.088,134.49,1,1,1,0,-3.142,0]},parts:{SM_Prop_Log_Big_02:[-132.825,.207,136.95,.39,.39,.258,0,0,0,-131.264,.226,136.948,.39,.39,.258,0,0,0,-131.26,.542,136.89,.39,.39,.258,0,0,0,-132.805,.51,136.914,.39,.39,.274,0,0,-4.9,-132.02,.099,136.046,.39,.39,.227,0,-1.571,0,-132.02,.371,136.046,.39,.39,.239,0,-1.571,0,-132.009,.099,137.863,.39,.39,.239,0,-1.571,0,-132.009,.371,137.863,.39,.39,.251,0,-1.564,-.94,-130.957,.155,136.982,.39,.39,.254,.024,-3.17,-5.575,-131.959,.099,138.156,.39,.39,.239,0,-1.506,-1.083]},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{SM_Env_Bushes_03:[-132.35,.072,136.94,.76,.76,.76,6.273,-6.209,-6.142]},animate:[],animateMesh:"",purchases:{}},pMill:{statics:{},finish:{},parts:{SM_Prop_Plank_02_orig:[-146.086,.175,137.166,.6,1,1.8,0,0,0,-146.086,.175,137.836,.6,1,1.8,0,0,0,-146.086,.175,138.495,.6,1,1.8,0,0,0],pMillBlades:[-147.35,2.646,137.84,.275,.275,.275,0,-1.571,0],SM_Prop_Log_Big_02:[-147.331,.145,137.761,.411,.411,.276,0,0,-5.484,-144.629,.088,137.786,.411,.411,.255,0,0,-4.204,-145.744,.145,137.761,.411,.411,.276,0,0,-4.868,-147.331,.473,137.799,.411,.411,.248,0,0,-4.559,-147.331,.811,137.812,.411,.411,.229,0,0,-2.662,-147.331,1.145,137.761,.411,.411,.215,0,0,-2.662,-147.331,1.472,137.761,.411,.411,.193,0,0,-2.662,-147.331,1.81,137.761,.411,.411,.175,0,0,-2.662,-147.26,2.168,137.84,.411,.411,.16,0,0,-1.252,-147.331,2.479,137.761,.411,.411,.138,0,0,-1.252,-147.331,2.817,137.72,.411,.411,.136,0,0,-1.252,-145.994,.302,138.719,.411,.411,.35,0,-1.571,-5.484,-145.79,.475,137.83,.411,.411,.254,0,0,-3.33,-146.55,.623,138.645,.411,.411,.218,0,-1.571,-5.484,-146.55,.944,138.532,.411,.411,.218,0,-1.571,-5.484,-146.55,1.269,138.42,.411,.411,.218,0,-1.571,-5.484,-146.55,1.617,138.344,.411,.411,.218,0,-1.571,-5.484,-146.55,1.955,138.289,.411,.411,.218,0,-1.571,-5.484,-146.55,2.294,138.198,.411,.411,.218,0,-1.571,-5.484,-146.55,2.607,138.052,.411,.411,.218,0,-1.571,-5.484,-145.761,.807,138.523,.411,.411,.095,0,0,-3.062,-145.767,1.138,138.529,.411,.411,.091,0,0,-4.619,-145.786,1.46,138.52,.411,.411,.093,0,0,-2.446,-145.776,1.813,138.462,.411,.411,.106,0,0,-4.49,-145.773,2.159,138.43,.411,.411,.106,0,0,-.679,-145.773,2.496,137.95,.411,.411,.174,0,0,-.679,-146.55,2.607,137.729,.411,.411,.218,0,-1.571,-5.484,-146.55,2.607,137.39,.411,.411,.218,0,-1.571,-4.576]},disabledOnFinish:{SM_Prop_Plank_02_orig:[-147.35,.068,138.84,.1,.5,.2,0,0,-1.571,-144.49,.068,138.84,.1,.5,.2,0,0,-1.571,-147.35,.068,136.84,.1,.5,.2,0,0,-1.571,-144.49,.068,136.84,.1,.5,.2,0,0,-1.571]},staticsDisabledOnFinish:{},clearing:{SM_Env_Bushes_03:[-146.12,.003,137.6,.742,.742,.742,0,-5.501,0]},animate:[-144.58,.04,137.84,.39,.39,.288,0,0,0,-145.99,.19,138.8,.39,.39,.356,0,-1.571,0,-147.33,.05,137.813,.39,.39,.29,0,0,-5.969,-145.755,.133,137.617,.39,.39,.241,0,0,-5.969,-147.015,.042,138.564,.39,.39,.234,1.571,-.314,0,-147.036,.042,137.201,.39,.39,.234,1.571,-.314,0,-146.04,.042,138.54,.39,.39,.234,1.571,-.314,0,-144.96,.042,138.52,.39,.39,.234,1.571,-.314,0],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pWall:{statics:{},finish:{SM_Prop_Log_Big_02:[-124.862,2.138,119.047,.664,.664,.457,1.571,-4.262,0,-125.186,2.085,118.537,.664,.664,.457,1.571,-4.262,0,-125.336,2.179,117.943,.664,.664,.457,1.571,-4.262,0,-125.645,2.085,117.426,.664,.664,.457,1.571,-4.262,0,-124.962,3.09,118.296,.447,.447,.301,0,-5.833,-1.571,-124.977,1.06,118.303,.447,.447,.301,0,-5.833,-1.571,-117.922,2.081,117.933,.664,.664,.454,1.571,-1.201,0,-118.229,2.116,118.449,.664,.664,.454,1.571,-2.402,0,-118.525,2.086,118.947,.664,.664,.454,1.571,-2.107,0,-118.806,2.116,119.42,.664,.664,.454,1.571,-2.107,0,-118.696,2.93,118.773,.447,.447,.301,0,-3.678,-1.571,-118.696,1.033,118.773,.447,.447,.301,0,-3.678,-1.571,-119.69,1.57,121.41,.113,.113,.408,1.571,0,0]},parts:{SM_Prop_Log_Big_02:[-111.87,-.95,119.74,1,1,1,1.565,-3.142,-3.142,-113.77,-.95,119.81,1,1,1,1.571,0,0,-112.84,-.95,119.8,1,1,1,1.571,-3.117,0,-114.68,-.95,119.78,1,1,1,1.571,-5.913,0,-115.45,-.95,119.93,1,1,1,1.571,0,0,-116.32,-.95,119.96,1,1,1,1.571,-.722,0,-117.18,-.95,119.93,1,1,1,1.571,0,0,-118.09,-.95,119.93,1,1,1,1.571,0,0,-118.929,-.95,119.945,1,1,1,1.571,0,0,-124.56,-.95,119.71,1,1,1,1.571,0,0,-125.41,-.95,119.74,1,1,1,1.571,0,0,-126.27,-.95,119.83,1,1,1,1.571,0,0,-127.1,-.95,119.91,1,1,1,1.571,-.992,0,-128,-.95,119.88,1,1,1,1.571,0,0,-128.83,-.95,119.86,1,1,1,1.571,-5.511,0,-129.65,-.95,119.77,1,1,1,1.571,0,0,-130.55,-.95,119.75,1,1,1,1.571,0,0,-131.38,-.95,119.63,1,1,1,1.571,-5.307,0,-132.24,-.95,119.75,1,1,1,1.555,0,0,-133.07,-.95,119.75,1,1,1,1.571,0,0,-133.97,-.95,119.75,1,1,1,1.571,0,0,-134.88,-.95,119.75,1,1,1,1.549,-3.142,-3.142,-135.74,-1.26,119.75,1.071,1.071,1.071,1.571,0,0,-136.57,-.95,119.75,1,1,1,1.565,-4.712,-4.712,-137.47,-.95,119.75,1,1,1,1.536,0,0,-138.3,-.95,119.56,1,1,1,1.571,0,0,-139.12,-.95,119.46,1,1,1,1.571,0,0,-140.02,-.95,119.61,1,1,1,1.571,0,0,-140.85,-.95,119.75,1,1,1,1.571,0,0,-141.71,-.95,119.64,1,1,1,1.56,-3.142,-3.142,-142.61,-.95,119.75,1,1,1,1.571,0,0,-143.44,-.95,119.86,1,1,1,1.551,0,0,-144.26,-.95,119.75,1,1,1,1.571,0,0,-145.16,-.95,119.75,1,1,1,1.571,0,0,-145.99,-.95,119.75,1,1,1,1.571,0,0,-147.01,-.95,119.87,1,1,1,1.571,0,0,-148.08,-.88,119.83,1,1,1,1.571,0,0,-149.09,-.7,119.8,1,1,1,1.571,0,0,-150.2,-.51,119.9,1,1,1,1.501,-2.003,-2.004,-151.21,-.81,120,1,1,1,1.529,-2.332,-2.334]},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[-111.87,-.95,119.74,1,1,1,1.565,-3.142,-3.142,-118.929,-.95,119.945,1,1,1,1.571,0,0,-124.56,-.95,119.71,1,1,1,1.571,0,0,-131.38,-.95,119.63,1,1,1,1.571,-5.307,0,-137.47,-.95,119.75,1,1,1,1.536,0,0,-142.61,-.95,119.75,1,1,1,1.571,0,0,-151.21,-.81,120,1,1,1,1.529,-2.332,-2.334],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pAppleGarden:{statics:{},finish:{SM_Env_Tree_03:[-141.32,-.57,139.02,.525,.525,.525,6.243,-.268,-6.196,-138.76,-.57,136.02,.525,.525,.525,6.243,-1.114,-6.196,-138.35,-.57,139.33,.525,.525,.525,6.243,-1.8,-6.196,-141.44,-.57,135.97,.525,.525,.525,6.243,-3.513,-6.196],SM_Prop_Apple_01_on_tree:[-141.322,2.417,139.021,.525,.525,.525,6.243,-.268,-6.196,-141.953,2.203,137.857,.525,.525,.525,.648,-2.804,-2.857,-142.634,1.777,138.959,.525,.525,.525,1.089,-5.651,-.905,-138.762,2.417,136.019,.525,.525,.525,6.243,-1.114,-6.196,-138.309,2.203,134.775,.525,.525,.525,.648,-3.65,-2.857,-139.585,1.777,134.996,.525,.525,.525,1.089,-.215,-.905,-141.438,2.417,135.969,.525,.525,.525,6.243,-3.513,-6.196,-140.931,2.203,137.192,.525,.525,.525,.648,-6.049,-2.857,-140.14,1.777,136.167,.525,.525,.525,1.089,-2.613,-.905,-138.351,2.417,139.328,.525,.525,.525,6.243,-1.8,-6.196,-137.213,2.203,138.652,.525,.525,.525,.648,-4.336,-2.857,-138.34,1.777,138.015,.525,.525,.525,1.089,-.9,-.905]},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{SM_Env_Bushes_03:[-141.12,-.11,138.74,1.133,1.133,1.133,0,-2.931,0,-139.67,-.17,136.47,1.133,1.133,1.133,0,-5.501,0]},animate:[],animateMesh:"",purchases:{}},pWheatGarden:{statics:{},finish:{SM_Env_Straw_Field_01:[-139.89,-.28,131.755,.595,.595,.595,0,0,0]},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{SM_Env_Bushes_03:[-139.06,-.17,131.26,.739,.739,.739,0,0,0,-140.77,.1,132.49,.672,.672,.672,6.253,-3.508,-.078]},animate:[],animateMesh:"",purchases:{}},pDock:{statics:{SM_Prop_Log_Big_02:[-164.51,-.58,141.19,.5,.5,.2,1.571,0,0,-164.64,-1.39,142.47,.5,.5,.2,1.571,0,0,-161.067,-1.39,141.189,.5,.5,.2,1.571,0,0,-161.067,-1.39,142.47,.5,.5,.2,1.571,0,0,-161.13,-.414,141.17,.6,.6,.9,0,-1.571,0,-161.21,-.414,142.45,.6,.6,.9,0,-1.571,0]},finish:{},parts:{SM_Prop_Plank_02_orig:[-157.465,-.18,141.63,.521,1,1.5,0,-1.571,0,-157.988,-.18,141.67,.521,1,1.5,0,-1.571,0,-158.517,-.18,141.7,.521,1,1.5,0,-1.571,0,-159.037,-.18,141.67,.521,1,1.5,0,-1.571,0,-159.574,-.18,141.63,.521,1,1.5,0,-1.571,0,-160.097,-.18,141.67,.51,1,1.5,0,-1.58,0,-160.626,-.18,141.65,.521,1,1.5,0,-1.571,0,-161.146,-.18,141.67,.521,1,1.5,0,-1.571,0,-161.688,-.17,141.67,.542,1,1.5,0,-1.571,0,-162.211,-.18,141.67,.521,1,1.5,0,-1.571,0,-162.74,-.18,141.69,.521,1,1.5,0,-1.571,0,-163.26,-.18,141.67,.521,1,1.5,0,-1.58,0,-163.797,-.18,141.63,.521,1,1.5,0,-1.571,0,-164.32,-.18,141.67,.521,1,1.5,0,-1.571,0,-164.894,-.18,141.67,.521,1,1.5,0,-1.571,0]},disabledOnFinish:{},staticsDisabledOnFinish:{SM_Prop_Log_Big_02:[-157.938,.419,141.292,.415,.413,.435,.326,0,0]},clearing:{},animate:[],animateMesh:"",purchases:{}},pShip:{statics:{},finish:{ship:[-167.7,-3.39,141.96,1.969,2.119,1.969,0,0,0]},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[-167.7,-1.07,140.81,1,1,1,0,0,-4.493,-168.6,-1.07,141,1,1,1,0,0,-4.798,-166.74,-1.07,141,1,1,1,0,0,-.935,-165.81,-1.07,141.2,1,1,1,0,0,0,-169.53,-1.07,141.2,1,1,1,0,0,0,-164.77,-.23,144.64,1,1,1,1.571,0,0,-165.28,4.19,144.22,.452,.452,.792,6.243,-5.512,-4.712,-162.13,-.23,144.68,1,1,1,.912,-4.712,-4.712,-167.28,-.56,140.77,3.363,.309,1,0,0,0],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pFisherman:{statics:{},finish:{SM_Env_DirtRoad_Straight_01:[-152.42,-.104,145.32,.906,.45,.423,0,0,0],thinRoof:[-150.58,2.196,148.04,2.087,1.518,1.64,0,-4.712,-6.109],SM_Env_Fence_Woof_03:[-154.35,-.079,147.72,.696,.903,.903,0,-1.553,0,-149.91,-.079,150.23,.938,.903,.903,0,-4.73,0,-149.91,-.079,147.72,.781,.903,.903,0,-4.73,0]},parts:{SM_Prop_Log_Big_02:[-152.629,.27,147.5,.39,.39,.405,0,-4.712,0,-152.629,.62,147.5,.411,.411,.402,0,-4.712,-4.812,-152.634,.96,147.5,.404,.404,.395,0,-4.712,0,-152.609,1.3,147.5,.404,.404,.388,0,-4.712,-.442,-152.609,1.634,147.5,.404,.404,.403,0,-4.712,-5.308,-152.609,1.959,147.5,.404,.404,.403,0,-4.712,-.4,-153.819,.125,146.14,.39,.39,.114,0,-4.712,-5.969,-153.819,.475,146.14,.411,.411,.12,0,-4.712,-.449,-153.833,.815,146.14,.404,.404,.118,0,-4.712,0,-153.846,1.135,146.14,.404,.404,.118,0,-4.712,-1.607,-153.861,1.455,146.14,.393,.393,.115,0,-4.712,-5.32,-153.861,1.769,146.14,.393,.393,.115,0,-4.712,-4.101,-152.58,2.076,146.14,.393,.393,.402,0,-4.712,-4.101,-151.499,.14,146.16,.39,.39,.13,0,-4.712,-5.969,-151.499,.49,146.16,.411,.411,.136,0,-4.712,-.449,-151.472,.83,146.16,.404,.404,.134,0,-4.712,0,-151.501,1.15,146.16,.404,.404,.134,0,-4.712,-1.607,-151.499,1.47,146.16,.39,.39,.13,0,-4.712,-6.178,-151.499,1.799,146.16,.39,.39,.13,0,-4.712,-5.105,-151.18,.12,146.851,.39,.39,.212,0,-3.142,0,-151.18,.47,146.851,.411,.411,.224,0,-3.142,-5.539,-151.18,.81,146.855,.404,.404,.22,0,-3.142,-.781,-151.18,1.15,146.837,.404,.404,.216,0,-3.142,0,-151.18,1.484,146.837,.404,.404,.224,0,-3.142,-6.023,-151.18,1.794,146.837,.404,.404,.224,0,-3.142,-.369,-151.18,2.12,146.554,.404,.404,.292,0,-3.142,-6.028,-154.08,.12,146.858,.39,.39,.208,0,0,0,-154.08,.47,146.858,.411,.411,.219,0,0,-5.539,-154.08,.81,146.854,.404,.404,.215,0,0,-.781,-154.08,1.15,146.872,.404,.404,.212,0,0,0,-154.08,1.484,146.872,.404,.404,.22,0,0,-6.023,-154.08,1.794,146.872,.404,.404,.22,0,0,-.369,-154.08,2.12,146.556,.404,.404,.292,0,0,-6.028]},disabledOnFinish:{SM_Prop_Plank_02_orig:[-154.07,.396,147.43,.1,.5,.2,0,0,-1.571,-151.07,.396,147.43,.1,.5,.2,0,0,-1.571,-154.07,.396,146.01,.1,.5,.2,0,0,-1.571,-151.07,.396,146.06,.1,.5,.2,0,0,-1.571]},staticsDisabledOnFinish:{},clearing:{},animate:[-151.15,.04,146.798,.39,.39,.221,0,0,0,-154.022,.04,146.798,.39,.39,.221,0,0,0,-152.576,.243,147.481,.397,.397,.398,0,-1.571,-5.705,-153.784,.19,146.112,.39,.39,.119,0,-1.571,0,-151.539,.19,146.112,.39,.39,.119,0,-1.571,0,-153.727,.042,147.31,.39,.39,.234,1.571,-.314,0,-151.497,.042,147.248,.39,.39,.234,1.571,-.314,0,-151.187,.042,146.468,.39,.39,.234,1.571,-.314,0,-153.756,.042,146.42,.39,.39,.234,1.571,-.314,0],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pHut1:{statics:{},finish:{SM_Bld_House_Roof_Thatch_Peak_Cap_Half_01:[-114.71,2.289,146.87,5.25,2,3.236,0,-4.712,0],SM_Env_DirtRoad_Straight_01:[-116.75,.025,145.65,.778,.4,.226,0,0,0],SM_Prop_Plank_02_orig:[-116.843,1.088,147.84,.002,16.23,9.316,0,-1.571,0,-118.234,1.088,146.955,.002,18.815,6.172,0,0,0,-115.392,1.088,146.955,.002,18.815,6.172,0,0,0,-117.879,1.088,145.862,.002,16.23,1.985,0,-1.571,0,-115.763,1.088,145.862,.002,16.23,2.85,0,-1.571,0],pb_Mesh108348:[-116.93,3.05,145.23,3.493,3.493,3.493,0,0,0]},parts:{SM_Prop_Log_Big_02:[-116.784,.27,147.87,.39,.39,.405,0,-4.712,0,-116.779,.62,147.87,.411,.411,.402,0,-4.712,-4.812,-116.784,.96,147.87,.404,.404,.395,0,-4.712,0,-116.759,1.3,147.87,.404,.404,.388,0,-4.712,-.442,-116.759,1.634,147.87,.404,.404,.403,0,-4.712,-5.308,-116.759,1.959,147.87,.404,.404,.403,0,-4.712,-.4,-117.969,.125,145.87,.39,.39,.114,0,-4.712,-5.969,-117.988,.475,145.87,.411,.411,.12,0,-4.712,-.449,-117.983,.815,145.87,.404,.404,.118,0,-4.712,0,-117.996,1.135,145.87,.404,.404,.118,0,-4.712,-1.607,-117.992,1.455,145.87,.393,.393,.115,0,-4.712,-5.32,-117.992,1.769,145.87,.393,.393,.115,0,-4.712,-4.101,-116.73,2.076,145.87,.393,.393,.402,0,-4.712,-4.101,-115.649,.14,145.89,.39,.39,.13,0,-4.712,-5.969,-115.649,.49,145.89,.411,.411,.136,0,-4.712,-.449,-115.622,.83,145.89,.404,.404,.134,0,-4.712,0,-115.651,1.15,145.89,.404,.404,.134,0,-4.712,-1.607,-115.649,1.47,145.89,.39,.39,.13,0,-4.712,-6.178,-115.649,1.799,145.89,.39,.39,.13,0,-4.712,-5.105,-115.33,.12,146.938,.39,.39,.277,0,-3.142,0,-115.33,.47,146.938,.411,.411,.291,0,-3.142,-5.539,-115.33,.81,146.942,.404,.404,.286,0,-3.142,-.781,-115.33,1.15,146.924,.404,.404,.281,0,-3.142,0,-115.33,1.484,146.924,.404,.404,.292,0,-3.142,-6.023,-115.33,1.794,146.924,.404,.404,.292,0,-3.142,-.369,-115.33,2.12,146.924,.404,.404,.292,0,-3.142,-6.028,-118.23,.12,146.912,.39,.39,.277,0,0,0,-118.23,.47,146.912,.411,.411,.291,0,0,-5.539,-118.23,.81,146.908,.404,.404,.286,0,0,-.781,-118.23,1.15,146.926,.404,.404,.281,0,0,0,-118.23,1.484,146.926,.404,.404,.292,0,0,-6.023,-118.23,1.794,146.926,.404,.404,.292,0,0,-.369,-118.23,2.12,146.926,.404,.404,.292,0,0,-6.028]},disabledOnFinish:{SM_Prop_Plank_02_orig:[-118.22,.396,147.8,.1,.5,.2,0,0,-1.571,-115.22,.396,147.8,.1,.5,.2,0,0,-1.571,-118.22,.396,145.8,.1,.5,.2,0,0,-1.571,-115.22,.396,145.8,.1,.5,.2,0,0,-1.571]},staticsDisabledOnFinish:{},clearing:{},animate:[-115.3,.04,146.889,.39,.39,.286,0,0,0,-118.219,.04,146.889,.39,.39,.277,0,0,0,-116.726,.251,147.851,.397,.397,.398,0,-1.571,-5.705,-117.957,.148,145.85,.39,.39,.119,0,-1.571,0,-115.689,.162,145.866,.39,.39,.119,0,-1.571,0,-117.955,.042,147.625,.39,.39,.234,1.571,-.314,0,-115.647,.042,147.618,.39,.39,.234,1.571,-.314,0,-115.51,.042,146.08,.39,.39,.234,1.571,-.314,0,-117.965,.042,146.098,.39,.39,.234,1.571,-.314,0],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pHut2:{statics:{},finish:{SM_Bld_House_Roof_Thatch_Peak_Cap_Half_01:[-120.66,2.289,146.87,5.25,2,3.236,0,-4.712,0],SM_Env_DirtRoad_Straight_01:[-122.7,-.039,145.65,.778,.4,.226,0,0,0],SM_Prop_Plank_02_orig:[-122.793,1.088,147.84,.002,16.23,9.316,0,-1.571,0,-124.184,1.088,146.955,.002,18.815,6.172,0,0,0,-121.342,1.088,146.955,.002,18.815,6.172,0,0,0,-123.829,1.088,145.862,.002,16.23,1.985,0,-1.571,0,-121.713,1.088,145.862,.002,16.23,2.85,0,-1.571,0],pb_Mesh109906:[-122.95,3.05,145.23,3.493,3.493,3.493,0,0,0]},parts:{SM_Prop_Log_Big_02:[-122.734,.27,147.87,.39,.39,.405,0,-4.712,0,-122.729,.62,147.87,.411,.411,.402,0,-4.712,-4.812,-122.734,.96,147.87,.404,.404,.395,0,-4.712,0,-122.709,1.3,147.87,.404,.404,.388,0,-4.712,-.442,-122.709,1.634,147.87,.404,.404,.403,0,-4.712,-5.308,-122.709,1.959,147.87,.404,.404,.403,0,-4.712,-.4,-123.919,.125,145.87,.39,.39,.114,0,-4.712,-5.969,-123.938,.475,145.87,.411,.411,.12,0,-4.712,-.449,-123.933,.815,145.87,.404,.404,.118,0,-4.712,0,-123.946,1.135,145.87,.404,.404,.118,0,-4.712,-1.607,-123.942,1.455,145.87,.393,.393,.115,0,-4.712,-5.32,-123.942,1.769,145.87,.393,.393,.115,0,-4.712,-4.101,-122.68,2.076,145.87,.393,.393,.402,0,-4.712,-4.101,-121.599,.14,145.89,.39,.39,.13,0,-4.712,-5.969,-121.599,.49,145.89,.411,.411,.136,0,-4.712,-.449,-121.572,.83,145.89,.404,.404,.134,0,-4.712,0,-121.601,1.15,145.89,.404,.404,.134,0,-4.712,-1.607,-121.599,1.47,145.89,.39,.39,.13,0,-4.712,-6.178,-121.599,1.799,145.89,.39,.39,.13,0,-4.712,-5.105,-121.28,.12,146.938,.39,.39,.277,0,-3.142,0,-121.28,.47,146.938,.411,.411,.291,0,-3.142,-5.539,-121.28,.81,146.942,.404,.404,.286,0,-3.142,-.781,-121.28,1.15,146.924,.404,.404,.281,0,-3.142,0,-121.28,1.484,146.924,.404,.404,.292,0,-3.142,-6.023,-121.28,1.794,146.924,.404,.404,.292,0,-3.142,-.369,-121.28,2.12,146.924,.404,.404,.292,0,-3.142,-6.028,-124.18,.12,146.912,.39,.39,.277,0,0,0,-124.18,.47,146.912,.411,.411,.291,0,0,-5.539,-124.18,.81,146.908,.404,.404,.286,0,0,-.781,-124.18,1.15,146.926,.404,.404,.281,0,0,0,-124.18,1.484,146.926,.404,.404,.292,0,0,-6.023,-124.18,1.794,146.926,.404,.404,.292,0,0,-.369,-124.18,2.12,146.926,.404,.404,.292,0,0,-6.028]},disabledOnFinish:{SM_Prop_Plank_02_orig:[-124.17,.396,147.8,.1,.5,.2,0,0,-1.571,-121.17,.396,147.8,.1,.5,.2,0,0,-1.571,-124.17,.396,145.8,.1,.5,.2,0,0,-1.571,-121.17,.396,145.8,.1,.5,.2,0,0,-1.571]},staticsDisabledOnFinish:{},clearing:{},animate:[-121.25,.04,146.889,.39,.39,.286,0,0,0,-124.169,.04,146.889,.39,.39,.277,0,0,0,-122.676,.251,147.851,.397,.397,.398,0,-1.571,-5.705,-123.907,.148,145.85,.39,.39,.119,0,-1.571,0,-121.639,.162,145.866,.39,.39,.119,0,-1.571,0,-123.905,.042,147.625,.39,.39,.234,1.571,-.314,0,-121.597,.042,147.618,.39,.39,.234,1.571,-.314,0,-121.46,.042,146.08,.39,.39,.234,1.571,-.314,0,-123.915,.042,146.098,.39,.39,.234,1.571,-.314,0],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pTailor:{statics:{},finish:{SM_Bld_House_Roof_Thatch_Peak_Cap_Half_01:[-113.06,2.33,135.97,5.25,2.77,2.6,0,-3.142,0],SM_Env_Fence_Woof_03:[-114.259,-.082,135.374,.456,.783,.783,0,-1.571,0],SM_Env_DirtRoad_Straight_01:[-114.366,-.13,137.74,.542,.4,.272,0,-4.712,0],SM_Prop_Plank_02_orig:[-112.01,1.048,137.813,.002,17.859,7.335,0,0,0,-113.077,1.048,138.657,.002,17.859,6.417,0,-1.571,0,-113.115,1.048,136.715,.002,17.859,6.417,0,-1.571,0,-114.001,1.048,138.51,.002,17.859,1.184,0,0,0,-114.001,1.048,136.966,.002,17.859,1.26,0,0,0],pb_Mesh108106:[-114.86,2.74,137.76,3.355,3.355,3.355,0,-1.489,0]},parts:{SM_Prop_Log_Big_02:[-113.079,.21,138.65,.39,.39,.293,0,-1.571,0,-113.01,.56,138.65,.411,.411,.291,0,-1.571,-4.812,-113.007,.9,138.65,.404,.404,.285,0,-1.571,0,-113.025,1.24,138.65,.404,.404,.281,0,-1.571,-.442,-113.025,1.574,138.65,.404,.404,.291,0,-1.571,-5.308,-113.025,1.899,138.65,.404,.404,.291,0,-1.571,-.4,-114.07,.065,136.868,.39,.39,.081,0,0,-5.969,-114.07,.415,136.838,.411,.411,.085,0,0,-.449,-114.07,.755,136.828,.404,.404,.083,0,0,0,-114.07,1.075,136.828,.404,.404,.083,0,0,-1.607,-114.07,1.395,136.826,.393,.393,.081,0,0,-5.32,-114.07,1.709,136.826,.393,.393,.081,0,0,-4.101,-114.07,2.016,137.726,.393,.393,.29,0,0,-4.101,-113.048,.21,136.741,.397,.397,.285,0,-1.571,-5.705,-113.048,.525,136.741,.411,.411,.295,0,-1.571,-.409,-113.044,.864,136.741,.404,.404,.29,0,-1.571,-1.517,-113.044,2.189,136.741,.404,.404,.29,0,-1.571,-1.517,-113.048,1.186,136.741,.397,.397,.285,0,-1.571,-5.705,-113.048,1.511,136.741,.411,.411,.295,0,-1.571,-.409,-113.044,1.842,136.741,.404,.404,.29,0,-1.571,-1.517,-112.04,.06,137.732,.39,.39,.277,0,0,0,-112.04,.41,137.732,.411,.411,.291,0,0,-5.539,-112.04,.75,137.728,.404,.404,.286,0,0,-.781,-112.04,1.09,137.746,.404,.404,.281,0,0,0,-112.04,1.424,137.746,.404,.404,.292,0,0,-6.023,-112.04,1.734,137.746,.404,.404,.292,0,0,-.369,-112.04,2.06,137.746,.404,.404,.292,0,0,-6.028,-114.04,.08,138.648,.39,.39,.081,0,0,-5.969,-114.04,.43,138.662,.411,.411,.085,0,0,-.449,-114.04,.77,138.665,.404,.404,.083,0,0,0,-114.04,1.09,138.656,.404,.404,.083,0,0,-1.607,-114.04,1.41,138.648,.39,.39,.081,0,0,-6.178,-114.04,1.739,138.648,.39,.39,.081,0,0,-5.105]},disabledOnFinish:{SM_Prop_Plank_02_orig:[-114.01,.19,138.7,.1,.5,.2,0,0,-1.571,-112.01,.19,138.7,.1,.5,.2,0,0,-1.571,-114.01,.19,136.7,.1,.5,.2,0,0,-1.571,-112.01,.19,136.7,.1,.5,.2,0,0,-1.571]},staticsDisabledOnFinish:{},clearing:{SM_Env_Bushes_03:[-113.07,-.071,137.46,.792,.792,.792,0,-2.36,0]},animate:[-112.008,.04,137.7,.39,.39,.288,0,0,0,-113.082,.19,136.757,.397,.397,.287,0,-1.571,-5.705,-113.056,.19,138.66,.39,.39,.273,0,-1.571,0,-113.99,.05,136.898,.39,.39,.107,0,0,-5.969,-113.96,.042,138.564,.39,.39,.095,0,0,-5.969,-113.675,.042,138.424,.39,.39,.234,1.571,-.314,0,-113.696,.042,137.061,.39,.39,.234,1.571,-.314,0,-112.287,.042,138.42,.39,.39,.234,1.571,-.314,0,-112.261,.042,137.056,.39,.39,.234,1.571,-.314,0],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pHairdresser:{statics:{},finish:{SM_Bld_House_Roof_Thatch_Peak_Cap_Half_01:[-113.04,2.3,144.12,5.25,2.77,2.6,0,0,0],SM_Env_Fence_Woof_03:[-114.244,-.086,143.825,.618,.812,.812,0,-1.571,0],SM_Prop_Barrel_01_copy:[-113.471,-.07,144.914,1.226,1.226,1.226,0,-3.229,0],SM_Env_DirtRoad_Straight_01:[-114.244,-.116,142.552,.542,.4,.272,0,-4.712,0],SM_Prop_Plank_02_orig:[-112.01,.998,142.548,.002,17.859,6.088,0,0,0,-113.068,.998,143.453,.002,17.859,6.241,0,-1.571,0,-113.068,.457,141.527,.002,8.228,6.241,0,-1.571,0,-113.792,1.567,141.527,.002,13.075,1.717,0,-1.571,0,-112.239,1.587,141.556,.002,13.075,1.631,0,-1.571,0,-114.01,1.079,143.286,.002,19.631,1.022,0,0,0,-114.037,1.079,141.812,.002,19.631,1.022,0,0,0],pb_Mesh114426:[-114.79,3,142.2,2.83,2.83,2.83,0,-4.779,0]},parts:{SM_Prop_Log_Big_02:[-113.059,.18,143.45,.39,.39,.293,0,-1.571,0,-112.99,.53,143.45,.411,.411,.291,0,-1.571,-4.812,-112.987,.87,143.45,.404,.404,.285,0,-1.571,0,-113.005,1.21,143.45,.404,.404,.281,0,-1.571,-.442,-113.005,1.544,143.45,.404,.404,.291,0,-1.571,-5.308,-113.005,1.869,143.45,.404,.404,.291,0,-1.571,-.4,-114.05,.035,141.668,.39,.39,.081,0,0,-5.969,-114.05,.385,141.625,.411,.411,.085,0,0,-.449,-114.05,.725,141.633,.404,.404,.083,0,0,0,-114.05,1.045,141.62,.404,.404,.083,0,0,-1.607,-114.05,1.365,141.626,.393,.393,.081,0,0,-5.32,-114.05,1.679,141.626,.393,.393,.081,0,0,-4.101,-114.05,1.986,142.526,.393,.393,.29,0,0,-4.101,-113.028,.18,141.541,.397,.397,.285,0,-1.571,-5.705,-113.028,.495,141.541,.411,.411,.295,0,-1.571,-.409,-113.024,.834,141.541,.404,.404,.29,0,-1.571,-1.517,-112.083,1.146,141.541,.404,.404,.093,0,-1.571,0,-113.877,1.161,141.541,.404,.404,.093,0,-1.571,-5.168,-113.877,1.492,141.541,.418,.418,.096,0,-1.571,-3.458,-112.101,1.471,141.541,.389,.389,.09,0,-1.571,-1.65,-112.101,1.8,141.541,.389,.389,.09,0,-1.571,-2.67,-113.877,1.842,141.541,.418,.418,.096,0,-1.571,-2.241,-113.024,2.15,141.541,.404,.404,.29,6.275,-1.571,-1.517,-112.02,.03,142.532,.39,.39,.277,0,0,0,-112.02,.38,142.532,.411,.411,.291,0,0,-5.539,-112.02,.72,142.528,.404,.404,.286,0,0,-.781,-112.02,1.06,142.546,.404,.404,.281,0,0,0,-112.02,1.394,142.546,.404,.404,.292,0,0,-6.023,-112.02,1.704,142.546,.404,.404,.292,0,0,-.369,-112.02,2.03,142.546,.404,.404,.292,0,0,-6.028,-114.02,.05,143.448,.39,.39,.081,0,0,-5.969,-114.02,.4,143.448,.411,.411,.085,0,0,-.449,-114.02,.74,143.464,.404,.404,.083,0,0,0,-114.02,1.06,143.447,.404,.404,.083,0,0,-1.607,-114.02,1.38,143.448,.39,.39,.081,0,0,-6.178,-114.02,1.709,143.448,.39,.39,.081,0,0,-5.105]},disabledOnFinish:{SM_Prop_Plank_02_orig:[-113.99,.16,143.5,.1,.5,.2,0,0,-1.571,-111.99,.16,143.5,.1,.5,.2,0,0,-1.571,-113.99,.16,141.5,.1,.5,.2,0,0,-1.571,-111.99,.16,141.5,.1,.5,.2,0,0,-1.571]},staticsDisabledOnFinish:{},clearing:{},animate:[-111.988,.04,142.51,.39,.39,.288,0,0,0,-113.062,.19,141.567,.397,.397,.287,0,-1.571,-5.705,-113.036,.19,143.47,.39,.39,.273,0,-1.571,0,-114.059,.05,141.643,.39,.39,.107,0,0,-5.969,-114.016,.042,143.466,.39,.39,.095,0,0,-5.969,-113.655,.042,143.234,.39,.39,.234,1.571,-.314,0,-113.676,.042,141.871,.39,.39,.234,1.571,-.314,0,-112.267,.042,143.23,.39,.39,.234,1.571,-.314,0,-112.241,.042,141.866,.39,.39,.234,1.571,-.314,0],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pLaboratory:{statics:{},finish:{SM_Prop_Log_Big_02:[-148.361,3.908,150.482,.213,.155,.163,.585,-5.193,-4.712,-148.157,3.348,150.589,.139,.102,.107,1.562,-3.622,-3.142,-148.82,4.25,150.243,.277,.202,.038,.585,-5.193,-4.712],cauldron:[-148.92,-.042,150.473,1.31,1,1.31,0,-.534,0]},parts:{SM_Prop_Plank_02_orig:[-147.713,.417,149.751,.336,.333,.504,1.571,0,0,-147.713,.931,149.751,.336,.333,.504,1.571,0,0,-147.713,1.451,149.751,.336,.333,.504,1.571,0,0,-147.713,1.928,149.751,.336,.333,.504,1.571,0,0,-147.713,2.335,149.751,.336,.333,.504,1.571,0,0,-146.991,3.58,150.442,.336,.333,.504,1.389,-.055,-4.712,-147.744,3.488,151.258,.27,.333,.504,1.571,-6.156,0,-148.408,3.58,150.565,.302,.333,.504,1.571,-4.712,0,-147.691,2.865,150.514,.348,1,4.69,0,0,0],thinRoof:[-149.11,5.226,151.58,1.585,1,1,0,0,0],SM_Prop_Log_Big_02:[-147.18,2.528,150.99,.411,.411,.598,1.571,0,0,-147.13,2.528,149.91,.411,.411,.598,1.571,-5.597,0,-148.24,2.528,151.14,.411,.411,.598,1.571,0,0,-148.24,2.528,149.93,.411,.411,.598,1.571,0,0,-147.12,2.738,150.42,.353,.353,.176,0,0,0,-148.21,2.738,150.49,.353,.353,.176,0,0,-5.406]},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[-147.18,2.528,150.99,.411,.411,.598,1.571,0,0,-147.13,2.528,149.91,.411,.411,.598,1.571,-5.597,0,-148.24,2.528,151.14,.411,.411,.598,1.571,0,0,-148.24,2.528,149.93,.411,.411,.598,1.571,0,0,-147.12,2.738,150.42,.353,.353,.176,0,0,0,-148.21,2.738,150.49,.353,.353,.176,0,0,-5.406],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pDock2:{statics:{SM_Prop_Log_Big_02:[-164.51,-.58,147.12,.5,.5,.2,1.571,0,0,-164.64,-1.39,148.4,.5,.5,.2,1.571,0,0,-162.82,-1.39,147.119,.5,.5,.2,1.571,0,0,-162.82,-1.39,148.4,.5,.5,.2,1.571,0,0,-161.13,-.414,147.1,.6,.6,.9,0,-1.571,0,-161.21,-.414,148.38,.6,.6,.9,0,-1.571,0,-164.19,-1.39,150.59,.5,.5,.2,1.571,0,0,-162.37,-1.39,150.59,.5,.5,.2,1.571,0,0,-162.43,-.414,149.86,.6,.6,.367,0,0,0,-164.21,-.414,149.86,.6,.6,.367,0,0,0]},finish:{},parts:{SM_Prop_Plank_02_orig:[-157.465,-.18,147.56,.521,1,1.5,0,-1.571,0,-157.988,-.18,147.6,.521,1,1.5,0,-1.571,0,-158.517,-.18,147.63,.521,1,1.5,0,-1.571,0,-159.037,-.18,147.6,.521,1,1.5,0,-1.571,0,-159.574,-.18,147.56,.521,1,1.5,0,-1.571,0,-160.097,-.18,147.6,.51,1,1.5,0,-1.58,0,-160.626,-.18,147.58,.521,1,1.5,0,-1.571,0,-161.146,-.18,147.6,.521,1,1.5,0,-1.571,0,-161.688,-.17,147.6,.542,1,1.5,0,-1.571,0,-162.211,-.18,147.6,.521,1,1.5,0,-1.571,0,-162.74,-.18,147.62,.521,1,1.5,0,-1.571,0,-163.26,-.18,147.6,.521,1,1.5,0,-1.58,0,-163.797,-.18,147.56,.521,1,1.5,0,-1.571,0,-164.32,-.18,147.6,.521,1,1.5,0,-1.571,0,-164.894,-.18,147.6,.521,1,1.5,0,-1.571,0,-163.507,-.18,149.21,.521,1,1.5,0,0,0,-163.587,-.18,149.77,.521,1,1.5,0,0,0,-163.517,-.18,150.31,.521,1,1.5,0,0,0,-163.597,-.18,150.84,.521,1,1.5,0,0,0,-163.507,-.18,151.37,.521,1,1.5,0,0,0]},disabledOnFinish:{},staticsDisabledOnFinish:{SM_Prop_Log_Big_02:[-157.938,.419,147.222,.415,.413,.435,.326,0,0]},clearing:{},animate:[],animateMesh:"",purchases:{}},pBalloon:{statics:{SM_Prop_Plank_02_orig:[-163.397,-.61,152.499,.19,16.71,9.16,0,-4.712,-4.712]},finish:{pb_Mesh104600:[-163.68,-1.284,152.3,.723,.723,.723,0,0,0]},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[-162.7,.59,153.39,.495,.495,.495,1.571,0,0,-162.03,.59,151.72,.495,.495,.495,1.571,0,0,-165,.59,153.54,.495,.495,.495,1.571,0,0,-165.06,.59,151.53,.495,.495,.495,1.571,0,0,-163.82,2.87,153.56,.495,.495,.495,0,-1.521,0,-163.73,2.87,151.56,.495,.495,.495,0,-1.613,0,-162.01,3.14,152.46,.495,.495,.328,0,0,0,-165.31,3.14,152.46,.495,.495,.328,0,0,0,-162.55,3.14,152.46,.495,.495,.328,0,0,-4.49,-164.86,3.14,152.46,.495,.495,.328,0,0,-2.386],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pArena:{statics:{SM_Prop_Log_Big_02:[-153.03,.913,133.34,.2,.2,.167,1.571,0,0,-153.03,1.135,133.311,.1,.1,.08,0,-1.571,0,-152.726,1.323,133.205,.05,.05,.05,1.032,0,0,-153.03,1.588,133.34,.301,.301,.016,1.571,0,0],SM_Env_Straw_Field_01:[-153.03,.1,133.36,.075,.56,.08,0,-1.23,0]},finish:{},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[],animateMesh:"",purchases:{}},pMine:{statics:{SM_Prop_Log_Big_02:[-112.94,0,150.59,.454,.467,.5,1.449,-4.712,-4.712,-114.39,0,152.19,.454,.467,.5,1.52,0,0,-114,2.18,151.183,.513,.467,.307,0,-.648,0,-113.684,2.18,151.49,.614,.467,.28,0,-.648,0,-112.86,.01,151.01,.454,.572,.5,1.449,-4.712,-4.712,-113.91,0,152.25,.666,.593,.5,1.52,0,0,-112.62,.04,151.36,.616,.467,.5,1.449,-4.712,-4.712,-113.33,.02,152.58,.454,.467,.5,1.52,0,0,-112.78,.04,152.88,.693,.467,.5,1.52,0,0,-112,.12,151.58,1.011,.676,.5,1.449,-4.712,-4.712,-113.298,2.18,151.781,.614,.467,.28,0,-3.803,0,-113.46,2.18,152.79,.891,.467,.6,0,-3.803,0]},finish:{},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[],animateMesh:"",purchases:{}},pForge:{statics:{},finish:{SM_Prop_Anvil_01:[-126.798,0,150.13,1.387,1.387,1.387,0,-5.172,0],SM_Prop_Brick_02:[-127.145,.27,151.901,1,1,1,0,-4.731,0,-127.131,.27,151.35,1,1,1,0,-4.731,0,-126.319,.27,151.901,1,1,1,0,-4.712,0,-126.308,.27,151.35,1,1,1,0,-4.731,0,-127.133,-.113,151.895,2,1,1,0,-4.712,0,-126.311,-.113,151.895,2,1,1,0,-4.712,0,-126.312,.076,151.633,1,1,1,0,-4.712,0,-126.298,.076,150.803,1,1,1,0,-3.142,0,-127.405,.262,150.813,1,1,1,0,-3.142,-3.142,-126.565,.27,150.807,1,1,1,0,-3.142,0,-126.312,.455,151.633,1,1,1,0,-4.712,0,-127.153,.076,151.633,1,1,1,0,-4.712,0,-126.545,.455,151.633,1,1,2.691,0,-4.712,0,-126.298,.475,150.803,1,1,1,0,-3.142,0,-127.391,.475,151.061,1,1,1,0,0,0,-127.145,.663,151.901,1,1,1,0,-4.731,0,-127.131,.663,151.35,1,1,1,0,-4.731,0,-126.319,.663,151.901,1,1,1,0,-4.712,0,-126.308,.663,151.35,1,1,1,0,-4.731,0,-126.312,.852,151.633,1,1,1,0,-4.712,0,-127.153,.852,151.633,1,1,1,0,-4.712,0,-126.299,.857,151.081,.5,1,1,0,-4.712,0,-127.402,.857,151.072,.5,1,1,0,0,0,-127.145,1.052,151.901,1,1,1,0,-4.731,0,-127.131,1.052,151.35,1,1,1,0,-4.731,0,-126.319,1.052,151.901,1,1,1,0,-4.712,0,-126.308,1.052,151.35,1,1,1,0,-4.731,0,-126.28,-.319,151.65,2,11.263,1,0,-3.142,0,-126.312,1.217,151.633,1,1,1,0,-4.712,0,-126.298,1.237,150.803,1,1,1,0,-3.142,0,-127.391,1.237,151.061,1,1,1,0,0,0,-127.153,1.217,151.633,1,1,1,0,-4.712,0,-127.145,1.436,151.901,1,1,1,0,-4.731,0,-127.131,1.436,151.35,1,1,1,0,-4.731,0,-126.319,1.436,151.901,1,1,1,0,-4.712,0,-126.308,1.436,151.35,1,1,1,0,-4.731,0,-127.113,1.626,150.806,1,1,1,0,-3.142,-3.142,-126.312,1.624,151.633,1,1,1,0,-4.712,0,-127.081,1.624,151.633,1,1,1,0,-4.712,0,-126.298,1.639,150.803,1,1,1,0,-3.142,0,-127.391,1.632,151.061,1,1,1,0,0,0,-126.328,1.841,151.901,1,1,1,0,-4.712,0,-126.317,1.841,151.35,1,1,1,0,-4.731,0,-126.866,1.818,151.901,1,1,1,0,-4.731,0,-126.852,1.818,151.35,1,1,1,0,-4.731,0,-126.588,1.821,151.891,.5,1,1,0,-4.712,0,-126.588,1.818,151.35,1,1,1,0,-4.731,0]},parts:{SM_Prop_Log_Big_02:[-127.648,.61,149.97,.503,.503,.491,1.571,-1.452,0,-130.208,.61,149.98,.503,.503,.491,1.571,0,0,-130.188,-.178,151.88,.503,.503,.491,1.571,0,0,-127.948,-.178,151.88,.503,.503,.491,1.571,0,0],thinRoof:[-126.938,2.21,152.67,2.08,1.51,1.66,0,-4.712,-6.056]},disabledOnFinish:{SM_Prop_Plank_02_orig:[-130.598,.3,151.9,.1,.5,.3,0,0,-1.571,-126.598,.3,151.9,.1,.5,.3,0,0,-1.571,-130.598,.3,149.9,.1,.5,.3,0,0,-1.571]},staticsDisabledOnFinish:{},clearing:{},animate:[-127.648,.61,149.97,.503,.503,.491,1.571,-1.452,0,-130.208,.61,149.98,.503,.503,.491,1.571,0,0,-130.188,-.178,151.88,.503,.503,.491,1.571,0,0,-127.948,-.178,151.88,.503,.503,.491,1.571,0,0,-128.898,1.89,151.87,.516,.515,.354,0,-1.571,0,-128.898,2.75,149.95,.516,.515,.354,0,-1.571,0,-127.472,.21,151.753,.121,.121,.118,1.571,-1.452,0,-127.443,.21,150.836,.121,.121,.118,1.571,-1.452,0,-126.231,.21,151.609,.121,.121,.118,1.571,-1.452,0,-126.257,.21,150.817,.121,.121,.118,1.571,-1.452,0],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pCornField:{statics:{},finish:{corn_plant:[-124.82,-.033,139.33,.77,.77,.77,0,0,0,-124.744,-.033,141.183,.77,.77,.77,0,0,0,-127.23,-.033,139.46,.77,.77,.77,0,0,0,-127.06,-.033,141.39,.77,.77,.77,0,0,0,-126.08,-.033,139.48,.77,.77,.77,0,0,0,-125.96,-.033,141.34,.77,.77,.77,0,0,0],SM_Prop_Plank_02_orig:[-125.99,-.07,142.54,.284,2,1.876,0,0,0]},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[],animateMesh:"",purchases:{}},pClimb:{statics:{},finish:{SM_Prop_Plank_02_orig:[-140.97,.82,152.37,.284,1,1,1.53,-4.712,-4.712,-141,1.63,152.63,.284,1,1,1.518,-1.571,-1.571,-140.95,2.49,152.777,.284,1,1,1.518,-4.712,-4.712,-140.95,3.11,153.15,.284,1,1,1.518,-4.712,-4.712]},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[],animateMesh:"",purchases:{}}},foliage:{},chopping:{SM_Env_Tree_03:[-129.9,-.19,136.96,.559,.703,.556,0,-.268,-.064,-127.52,-.24,144.8,.91,.91,.91,6.231,-3.142,0,-147.99,-.21,123.49,.779,.779,.779,6.279,-.269,-.072,-119.8,-.02,146.51,.496,.782,.55,6.249,-2.331,-.028,-137.52,-.09,121.52,.599,.684,.612,6.23,-.901,-6.252,-114,-.15,129.2,.91,.95,.88,6.271,-.803,-6.234,-119.16,-.03,136.42,.466,.669,.519,6.274,-1.571,0,-112.52,-.12,121.38,.876,.876,.876,0,-3.036,0,-145.92,-.08,145.5,.964,.964,.964,6.275,-.433,-.081,-150.07,-.09,140.51,.783,.783,.783,6.275,-2.3,-.081,-135.74,-.03,125.76,.576,.658,.588,.189,0,0,-138.68,-.02,124.28,.605,.691,.618,.011,-2.902,-.01,-141.86,-.03,126.43,.561,.639,.493,.03,-4.203,-.07,-113.56,-.06,140.15,.665,.696,.536,.002,-3.301,-6.272,-135.7,-.25,146.85,.831,.792,.831,6.219,-2.703,0]},gridMapInfo:{x:108,z:120,width:58,height:32,data:"00000000000000000000000000000000000000011111111100000000000000000000000111111111100000000000000000000001111111111100000000000000011111111111111111111111000000000111111111111111111111111100000001111111111111111111111111111111011111111111111111111111111111110111111111111111111111111111111101111111111111111100111111111111011111111111111111001111111111110111111111111111111111111111111101111111111111111111111111111111011111111111111111111111111111110111111111111111111111111111111101111111111111111111111111111111011111111111111111111111111111110111111111111111111111111111111101111111111111111111111111111111011111111111111111111111111111110111111111111111111111111111111101111111111111111111111111111111011111111111111111111111111111110111111111111111111111111111111101111111111111111111111111111111011111111111111111111111111111110111111111111111111111111111111101111111111111111111111111111111011111111111111111111111111111110111111111111111111111111111111101111111111111111111111111111111011111111111111111111111111111110111111111111111111111111111111101111111111111111111111111111111011111111111111111111111111111110111111111111111111111111111111101111111111111111111111111111111011111111111111111111111111111110111111111111111111111111111111101111111111111111111111111111111011111111111111111111111111111110111111111111111111111111111111101111111111111111111111111111111011111111111111111111111111111000000000011111111111111111111110000000000111111111111111111111100000000001111111111111111111111000000000011111111111111111111110000000000111111111111111111111100000000001111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000011000000000000000000000000000000",resolvingPoint:{x:124,z:130,y:0}},waypoints:{ship:[{x:167.7,z:141.959991,y:-3.39},{x:169.66861,z:132.116959,y:-3.39},{x:175.574432,z:124.242531,y:-3.39},{x:195.2605,z:116.3681,y:-3.39}]},pois:{poiClimb:{point:{x:142.44,z:151.38},radius:.1},poiClimbOffer:{point:{x:140.58,z:150.74},radius:.1}},light:{clear:"#F9CE83",hemi:"#FFEACB",hemiGround:"#3C3C3C",hemiIntensity:3,point:"#000000",pointIntensity:0,pointRadius:0}},zHome:{name:"zHome",env:{floor:[-21.83,-.2,138.16,1.412,1.83,24.044,0,0,0],SM_Prop_Log_Big_02:[-21.5,-.086,141.374,.5,.5,.871,0,-4.712,0,-21.489,.363,141.374,.527,.527,.865,0,-4.712,-4.812,-21.5,.799,141.374,.517,.517,.85,0,-4.712,0,-21.447,1.235,141.374,.517,.517,.835,0,-4.712,-.442,-18.417,-.039,137.916,.476,.476,.905,0,-3.142,0,-18.417,.388,137.999,.502,.502,.953,0,-3.142,-5.539,-18.417,.804,137.988,.493,.493,.937,0,-3.142,-.781,-18.417,1.219,137.845,.493,.493,.92,0,-3.142,0],pHomeMapChest:[-19.58,0,137.5,1.647,1.647,1.647,0,-1.571,0],SM_Prop_Mirror_03:[-19.04,.66,137.48,1,1,1,0,-1.571,0],rug:[-22.03,0,137.56,1.677,1,.752,0,0,0],SM_Bld_Castle_Door_Single_01:[-25.01,0,138.25,1,1,2,0,-3.651,0],SM_Env_Planter_Pot_07:[-18.987,-.12,135.943,1,1,1,0,0,0],flowers1:[-18.982,.179,135.927,.611,.611,.611,0,0,0]},buildings:{pHomeMap:{statics:{},finish:{},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[],animateMesh:"",purchases:{homeBed:{meshes:{bed:[-20.59,0,140.4,1.248,1.247,1.248,0,-1.571,0]},open:[],close:[{id:5,width:3,height:1}],point:{x:21.44,z:140.13,y:0},offerPoint:{x:19.94,z:139.23,y:0}},homeTable:{meshes:{SM_Prop_Table_Wood_01:[-23.36,0,134.778,.629,.629,.629,0,-1.571,0],SM_Prop_Mortar_And_Pestle_01:[-22.82,.56,134.584,1,1,1,0,0,0],SM_Item_Mug_Tankard_01:[-22.976,.592,134.961,1,1,1,0,-2.312,0],chair:[-21.89,0,134.618,1,1,1,0,-.744,0]},open:[],close:[{id:12,width:3,height:1}],point:{x:22.792,z:135.229,y:0},offerPoint:{x:21.092,z:135.329,y:0}},homeBath:{meshes:{bath:[-23.69,0,139.13,1.362,1.239,1.239,0,-.103,0]},open:[],close:[{id:22,width:2,height:1}],point:{x:23.88,z:139.07,y:0},offerPoint:{x:21.98,z:139.07,y:0}},homeFireplace:{meshes:{fireplace:[-23.83,0,140.95,1.026,1.026,1.139,0,-3.142,0]},open:[],close:[{id:23,width:2,height:1}],point:{x:23.46,z:140.04,y:0},offerPoint:{x:22.04,z:139.03,y:0}},homeWorkbench:{meshes:{SM_Prop_Workbench_01_Preset:[-20.24,0,134.59,.841,.841,.841,0,0,0]},open:[],close:[{id:0,width:2,height:1}],point:{x:20.03,z:135.03,y:0},offerPoint:{x:21.03,z:136.03,y:0}}}}},foliage:{},chopping:{},gridMapInfo:{x:20,z:135,width:5,height:6,data:"110011111111111111111111111111",resolvingPoint:{x:21.5,z:137.5,y:0}},waypoints:{},pois:{poiHomeService:{point:{x:20.19,z:137.52},radius:.687}},light:{clear:"#171717",hemi:"#FFEACB",hemiGround:"#3C3C3C",hemiIntensity:3,point:"#FCC50F",pointIntensity:1.8,pointRadius:8}},zSnow:{name:"zSnow",env:{pSnowEnv:[-127.18,-7.09,226.6,.587,.587,.587,0,-1.555,0],pSnowCave:[-133.4,1.11,232.87,.203,.203,.203,0,-2.239,-.81],snowLog:[-133.54,0,216.65,.203,.225,.086,4.712,0,0,-133.6,0,217.34,.203,.225,.086,4.712,0,0,-134.33,0,217.41,.203,.225,.086,4.712,0,0,-134.52,0,218.43,.203,.225,.086,4.712,0,0,-135.59,0,218.53,.203,.225,.086,4.712,0,0,-135.65,0,219.43,.203,.225,.086,4.712,0,0,-135.67,0,220.42,.203,.225,.086,4.712,0,0,-135.66,0,221.36,.203,.225,.086,4.712,0,0,-135.67,0,222.25,.203,.225,.086,4.712,0,0,-135.63,0,223.16,.203,.225,.086,4.712,0,0,-135.59,0,224.21,.203,.225,.086,4.712,0,0,-135.55,0,225.12,.203,.225,.086,4.712,0,0,-132.39,0,216.68,.203,.225,.086,4.712,0,0,-132.25,0,217.46,.203,.225,.086,4.712,0,0,-131.31,0,217.43,.203,.225,.086,4.712,0,0,-135.4,0,226.81,.203,.225,.086,4.712,0,0,-135.45,0,228.49,.203,.225,.086,4.712,0,0,-135.52,0,230.75,.203,.225,.086,4.712,0,0,-134.73,0,230.7,.203,.225,.086,4.712,0,0,-133.68,0,230.68,.203,.225,.086,4.712,0,0,-132.71,0,232.91,.203,.225,.086,4.712,0,0,-132.67,0,234.53,.203,.225,.086,4.712,0,0,-131.528,0,234.581,.203,.225,.086,4.712,0,0,-129.83,0,234.54,.203,.225,.086,4.712,0,0,-128.49,0,234.57,.203,.225,.086,4.712,0,0,-127.1,0,234.643,.203,.225,.086,4.712,0,0,-126.037,0,234.714,.203,.225,.086,4.712,0,0,-123.56,0,234.66,.203,.225,.086,4.712,0,0,-122.14,0,234.68,.203,.225,.086,4.712,0,0,-120.65,0,234.65,.203,.225,.086,4.712,0,0,-119.687,0,234.56,.203,.225,.086,4.712,0,0,-119.331,0,233.564,.203,.225,.086,4.712,0,0,-119.36,0,231.66,.203,.225,.086,4.712,0,0,-119.27,0,230.21,.203,.225,.086,4.712,0,0,-119.27,0,228.95,.203,.225,.086,4.712,0,0,-119.32,0,225.06,.203,.225,.086,4.712,0,0,-119.33,0,223.44,.203,.225,.086,4.712,0,0,-119.319,0,221.654,.203,.225,.086,4.712,0,0,-119.39,0,219.6,.203,.225,.086,4.712,0,0,-121.43,0,219.49,.203,.225,.086,4.712,0,0,-123.17,0,219.58,.203,.225,.086,4.712,0,0,-125.5,0,219.39,.203,.225,.086,4.712,0,0,-127.39,0,219.54,.203,.225,.086,4.712,0,0,-128.74,0,219.42,.203,.225,.086,4.712,0,0,-129.69,0,219.3,.203,.225,.086,4.712,0,0,-130.4,0,219.4,.203,.225,.086,4.712,0,0,-131.2,0,219.4,.203,.225,.086,4.712,0,0,-131.14,0,218.58,.203,.225,.086,4.712,0,0,-133.038,-.511,216.469,.203,.225,.13,0,-1.571,-4.712,-132.903,-1.032,216.375,.203,.225,.13,0,-4.569,-4.712,-133.11,-1.859,216.25,.203,.225,.13,0,-4.428,-4.712,-133.23,-2.75,216.12,.203,.225,.13,0,-1.304,-4.712,-133.08,-3.76,215.88,.203,.225,.13,0,-4.747,-4.712],snowTree:[-135.27,-.31,233.56,.849,.849,.849,.09,-.641,-.067,-130.22,-.84,218.53,.798,.798,.798,0,-.638,0,-118.81,-.5,220.73,.727,.727,.727,6.268,-3.025,-6.154]},buildings:{pSnowFireplace:{statics:{},finish:{SM_Prop_Log_Big_02:[-132.53,.078,223.891,.427,.472,.18,0,-1.571,-5.594,-132.639,.078,223.41,.427,.472,.18,0,-1.465,-5.594,-132.53,.078,222.878,.427,.472,.18,0,-4.712,0,-132.53,.401,223.326,.427,.472,.18,0,0,0,-133.045,.401,223.362,.427,.573,.18,0,-6.211,-2.704,-132.076,.401,223.362,.427,.472,.2,0,-.058,-4.145,-132.53,.666,223.891,.427,.472,.18,0,-1.571,-5.594,-132.423,.666,223.41,.424,.468,.204,0,-1.571,-5.594,-132.53,.666,222.878,.427,.472,.18,0,-4.712,0]},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[-132.53,.078,223.891,.427,.472,.18,0,-1.571,-5.594,-132.639,.078,223.41,.427,.472,.18,0,-1.465,-5.594,-132.53,.078,222.878,.427,.472,.18,0,-4.712,0,-132.53,.401,223.326,.427,.472,.18,0,0,0,-133.045,.401,223.362,.427,.573,.18,0,-6.211,-2.704,-132.076,.401,223.362,.427,.472,.2,0,-.058,-4.145,-132.53,.666,223.891,.427,.472,.18,0,-1.571,-5.594,-132.423,.666,223.41,.424,.468,.204,0,-1.571,-5.594,-132.53,.666,222.878,.427,.472,.18,0,-4.712,0],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pSnowHut:{statics:{},finish:{snowRoof:[-122,2.143,221.3,5.25,2,3.236,0,-3.142,0],SM_Prop_Plank_02_orig:[-121.03,.942,223.433,.002,16.23,9.316,0,0,0,-121.915,.942,224.824,.002,18.815,6.172,0,-4.712,0,-121.915,.942,221.982,.002,18.815,6.172,0,-4.712,0]},parts:{SM_Prop_Log_Big_02:[-121,.124,223.374,.39,.39,.405,0,-3.142,0,-121,.474,223.369,.411,.411,.402,0,-3.142,-4.812,-121,.814,223.374,.404,.404,.395,0,-3.142,0,-121,1.154,223.349,.404,.404,.388,0,-3.142,-.442,-121,1.488,223.349,.404,.404,.403,0,-3.142,-5.308,-121,1.813,223.349,.404,.404,.403,0,-3.142,-.4,-121.932,-.026,221.92,.39,.39,.277,0,-1.571,0,-121.932,.324,221.92,.411,.411,.291,0,-1.571,-5.539,-121.928,.664,221.92,.404,.404,.286,0,-1.571,-.781,-121.946,1.004,221.92,.404,.404,.281,0,-1.571,0,-121.946,1.338,221.92,.404,.404,.292,0,-1.571,-6.023,-121.946,1.648,221.92,.404,.404,.292,0,-1.571,-.369,-121.946,1.974,221.92,.404,.404,.292,0,-1.571,-6.028,-123,.079,223.374,.39,.39,.405,0,-3.142,0,-123,.429,223.369,.411,.411,.402,0,-3.142,-4.812,-123,.769,223.374,.404,.404,.395,0,-3.142,0,-123,1.109,223.349,.404,.404,.388,0,-3.142,-.442,-123,1.443,223.349,.404,.404,.403,0,-3.142,-5.308,-123,1.768,223.349,.404,.404,.403,0,-3.142,-.4,-123.16,.64,222.842,.279,.111,.201,4.712,-4.712,0,-123.16,.64,223.063,.279,.111,.201,4.712,-4.712,0,-123.16,.64,223.258,.279,.111,.201,4.712,-4.712,0,-123.16,.64,223.429,.279,.111,.201,4.712,-4.712,0,-121.958,-.026,224.82,.39,.39,.277,0,-4.712,0,-121.958,.324,224.82,.411,.411,.291,0,-4.712,-5.539,-121.962,.664,224.82,.404,.404,.286,0,-4.712,-.781,-121.944,1.004,224.82,.404,.404,.281,0,-4.712,0,-121.944,1.338,224.82,.404,.404,.292,0,-4.712,-6.023,-121.944,1.648,224.82,.404,.404,.292,0,-4.712,-.369,-121.944,1.974,224.82,.404,.404,.292,0,-4.712,-6.028]},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[-121.21,-.026,222.11,.39,.39,.277,1.571,-4.712,0,-121.23,-.026,224.59,.39,.39,.277,1.571,-4.712,0,-121.11,-.026,223.25,.39,.39,.277,1.571,-4.712,0,-122.81,-.026,224.64,.39,.39,.277,1.571,-4.712,0,-122.87,-.026,223.91,.39,.39,.277,1.571,-4.712,0,-122.87,-.026,222.509,.39,.39,.277,1.571,-4.712,0,-122.85,-.026,222.156,.39,.39,.277,1.571,-4.712,0,-122.02,-.026,224.71,.39,.39,.277,1.571,-4.712,0,-122.108,-.026,222.127,.39,.39,.277,1.571,-4.712,0],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pSnowCave:{statics:{},finish:{SM_Prop_TorchStick_01:[-132.948,0,231.62,1,1,1,0,0,0]},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[],animateMesh:"",purchases:{}},pJewelerNpc:{statics:{},finish:{SM_Prop_Tech_Crystal_01:[-123.015,0,226.981,1.161,1.161,1.161,0,-5.912,0]},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[],animateMesh:"",purchases:{}}},foliage:{},chopping:{snowTree:[-121.65,-.54,232.82,.567,.567,.567,0,0,0,-120.18,-.2,229.94,.567,.567,.567,0,-.638,0,-127.67,-.51,232.46,.567,.567,.567,0,-1.367,0,-125.03,-.63,230.41,.567,.567,.567,0,-.638,0,-125.31,-.5,219.84,.727,.727,.727,0,-.638,0,-130.94,-.41,233.5,.515,.515,.515,.047,-3.072,-.035,-130.25,-.38,227.21,.727,.727,.727,0,-.638,0]},gridMapInfo:{x:120,z:217,width:16,height:18,data:"000111111111111111000111111111111111000111111111111111000111111111111111000111111111111111000111111111111111000111111111111111000111111111111111000111111111111111000111111111111111000111111111111111000111111111111111011111111111111111111111111111111000011111111111110000001111111111110000",resolvingPoint:{x:127.97,z:221.03,y:0}},waypoints:{},pois:{poiSnowFireplace:{point:{x:132.668,z:223.298},radius:.1},poiSnowFireplaceOffer:{point:{x:130.668,z:223.798},radius:.1},poiSnowHut:{point:{x:123.22,z:223.49},radius:.1},poiSnowHutOffer:{point:{x:124.22,z:224.99},radius:.1},poiSnowCave:{point:{x:132.954,z:231.039},radius:.1},poiSnowCaveOffer:{point:{x:130.954,z:231.539},radius:.1},poiJewelerNpc:{point:{x:123.25,z:226.31},radius:.1},poiJewelerNpcOffer:{point:{x:125.27,z:227.75},radius:.1}},light:{clear:"#71BED5",hemi:"#B5B5B5",hemiGround:"#003845",hemiIntensity:3,point:"#000000",pointIntensity:0,pointRadius:0}},zCave:{name:"zCave",env:{caveTile1:[-121,-.01,249,1.548,1,1.741,0,-1.571,0,-121,-.01,260.32,.675,1,1.741,0,-1.571,0,-121,-.01,266.34,.973,1,1.741,0,-1.571,0],brickWall1:[-120.99,-1.99,249.05,.805,1.2,.7,0,-1.571,0,-120.99,-1.99,253,.943,1.2,.7,0,-3.142,0,-120.99,-1.99,252.96,.805,1.2,.7,0,-1.571,0,-120.99,-1.99,256.81,1.048,1.2,.7,0,-1.571,0,-120.99,-1.99,261.74,1.056,1.2,.7,0,-1.571,0,-120.89,-2.13,266.33,1.092,1.2,.7,0,-1.571,0,-120.9,-7.43,249.18,1.74,1.446,.7,0,-3.142,0,-129.43,-6.2,249.28,1.472,1.2,.7,0,-1.571,0,-129.45,-6.2,260.52,.614,1.2,.7,0,-1.571,0,-121.09,-6.2,260.52,1.642,1.2,.7,0,-3.142,0,-121.09,-12.04,249.27,4.896,2,.7,0,-1.571,0,-121.09,-6.2,266.46,1.642,1.2,.7,0,-3.142,0,-129.45,-6.2,266.48,.614,1.2,.7,0,-1.571,0],brickDoor1:[-129.52,-2.07,253.04,.828,1.2,.7,0,0,0],brickStairs1:[-125,-.14,249.17,1,1,1,0,-4.712,0],caveWall1:[-122.35,-.71,270.36,.231,.231,.231,6.271,-1.659,-.138],SM_Prop_Gravestone_01:[-121.474,0,252.505,1,1,1,0,-2.519,0],pCaveSnakeHead:[-125.37,1.31,269.21,6.94,6.94,8.671,0,-3.142,0],SM_Env_StoneWall_Pillar_01:[-122.08,0,263.31,2.335,1.672,1.274,0,0,0,-127.62,0,269.3,1.516,1,1,0,0,0,-122.59,0,269.34,1,1,1.916,0,-1.567,0]},buildings:{pCaveLight:{statics:{},finish:{SM_Prop_TorchStick_01:[-126.08,0,252.67,1,1,1,0,0,0,-128.65,0,252.75,1,1,1,0,0,0]},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{SM_Prop_Plank_02_orig:[-127.5,.62,252.86,.553,3.194,.229,0,0,-.004,-127.5,1.34,252.86,.606,3.181,.229,0,0,-.155,-127.5,2.17,252.86,.606,2.732,.229,0,0,-6.189]},clearing:{},animate:[],animateMesh:"",purchases:{}},pCaveBridge1:{statics:{},finish:{SM_Prop_TorchStick_01:[-122.16,0,256.64,1,1,1,0,0,0,-123.927,0,256.72,1,1,1,0,0,0],SM_Prop_Log_Big_02:[-122.81,-.162,256.99,.427,.472,.18,0,-1.571,-.057,-122.81,-.162,257.44,.405,.447,.168,0,-1.571,-5.594,-122.87,-.162,257.957,.427,.472,.18,0,-1.571,-5.594,-122.84,-.162,258.45,.427,.472,.18,0,-1.571,-5.594,-122.87,-.162,260.02,.427,.472,.158,0,-1.571,-4.47,-122.84,-.162,258.98,.427,.472,.18,0,-1.571,-5.594,-122.85,-.162,259.55,.427,.472,.18,0,-1.571,-5.594,-122.304,-.192,258.396,.04,.044,.495,0,-.044,0,-123.349,-.192,258.396,.04,.044,.495,0,-6.262,0]},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[-122.304,-.192,258.396,.04,.044,.495,0,-.044,0,-123.349,-.192,258.396,.04,.044,.495,0,-6.262,0,-122.87,-.162,257.957,.427,.472,.18,0,-1.571,-5.594,-122.84,-.162,258.45,.427,.472,.18,0,-1.571,-5.594,-122.87,-.162,260.02,.427,.472,.158,0,-1.571,-4.47,-122.84,-.162,258.98,.427,.472,.18,0,-1.571,-5.594,-122.85,-.162,259.55,.427,.472,.18,0,-1.571,-5.594,-122.81,-.162,257.44,.405,.447,.168,0,-1.571,-5.594,-122.81,-.162,256.99,.427,.472,.18,0,-1.571,-.057],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pCaveBridge2:{statics:{},finish:{SM_Prop_TorchStick_01:[-127.26,0,263.587,1,1,1,0,0,0,-128.754,0,263.611,1,1,1,0,0,0],SM_Prop_Log_Big_02:[-127.867,-.162,264,.405,.447,.17,0,-1.571,-3.546,-127.898,-.162,264.519,.382,.422,.161,0,-1.571,-4.487,-127.953,-.162,265.071,.367,.405,.154,0,-1.571,-3.61,-127.89,-.162,265.601,.427,.472,.18,0,-1.571,-.542,-127.93,-.162,266.113,.427,.472,.18,0,-1.571,-3.75,-128.514,-.192,264.962,.04,.044,.398,0,-6.262,0,-127.373,-.192,264.964,.04,.044,.398,0,-.047,0]},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[-128.514,-.192,264.962,.04,.044,.398,0,-6.262,0,-127.373,-.192,264.964,.04,.044,.398,0,-.047,0,-127.898,-.162,264.519,.382,.422,.161,0,-1.571,-4.487,-127.953,-.162,265.071,.367,.405,.154,0,-1.571,-3.61,-127.89,-.162,265.601,.427,.472,.18,0,-1.571,-.542,-127.93,-.162,266.113,.427,.472,.18,0,-1.571,-3.75,-127.867,-.162,264,.405,.447,.17,0,-1.571,-3.546],animateMesh:"SM_Prop_Log_Big_02",purchases:{}},pCaveCrystal:{statics:{},finish:{SM_Prop_Crystal_01:[-125.318,.706,268.977,1.141,1.141,1.141,0,-5.751,0]},parts:{},disabledOnFinish:{},staticsDisabledOnFinish:{},clearing:{},animate:[],animateMesh:"",purchases:{}}},foliage:{},chopping:{},gridMapInfo:{x:122,z:250,width:8,height:19,data:"11101110000110000111110111000011000011111011100001110001111101110000111000111110111000011100011111011100001110001111101110000111000111110111000011100011",resolvingPoint:{x:125.94,z:251.02,y:0}},waypoints:{},pois:{poiCaveLight:{point:{x:127.5,z:252.53},radius:.1},poiCaveLightOffer:{point:{x:124.76,z:251.69},radius:.1},poiCaveBridge1:{point:{x:122.92,z:255.89},radius:.1},poiCaveBridge1Offer:{point:{x:125.52,z:255.89},radius:.1},poiCaveBridge2:{point:{x:128.073,z:263.09},radius:.1},poiCaveBridge2Offer:{point:{x:125.963,z:262.524},radius:.1},poiCaveCrystal:{point:{x:125,z:268.05},radius:.1},poiCaveCrystalOffer:{point:{x:123,z:267.55},radius:.1}},light:{clear:"#171717",hemi:"#825858",hemiGround:"#1F1F1F",hemiIntensity:3,point:"#FFA95E",pointIntensity:3,pointRadius:8}}},FF=["treasureChest","iWater","iCoin","iLog","iPlank","iWheat","iApple","iAleBarrel","iFlour","arrow","rainDirt","MAX","crate","iBread","swords","Boots","iBook","iOre","iIron","iWool","iCorn","iCrystal","iGem","exclamation"],LF=["pb_Mesh104748","SM_Item_Saw_01","pb_Mesh95050","pMillBlades","ship","pb_Mesh108348","pb_Mesh109906","pb_Mesh108106","pb_Mesh114426","cauldron","pb_Mesh104600","SM_Prop_Anvil_01","PlaneMounts","PlaneGround","trashBin","SM_Prop_Mortar_And_Pestle_01","SM_Item_Mug_Tankard_01","bath","fireplace","SM_Prop_Workbench_01_Preset","pHomeMapChest","SM_Prop_Mirror_03","rug","SM_Prop_Tech_Crystal_01"],NF=[{fromPoint:{x:114.537,z:124.704},toPoint:{x:23.3,z:137.5},fromZone:"zVillage",toZone:"zHome"},{fromPoint:{x:24.44,z:137.6},toPoint:{x:115.425,z:123.635},fromZone:"zHome",toZone:"zVillage"},{fromPoint:{x:140.8,z:151.5},toPoint:{x:132.96,z:218.37},fromZone:"zVillage",toZone:"zSnow"},{fromPoint:{x:132.97,z:216.88},toPoint:{x:139,z:151},fromZone:"zSnow",toZone:"zVillage"},{fromPoint:{x:133.394,z:231.535},toPoint:{x:126.33,z:250.15},fromZone:"zSnow",toZone:"zCave"},{fromPoint:{x:123.43,z:249.43},toPoint:{x:132.23,z:230.12},fromZone:"zCave",toZone:"zSnow"}],BF=["SM_Prop_Log_Big_02","SM_Env_DirtRoad_Straight_01","SM_Env_Rock_02","SM_Bld_House_Roof_Thatch_Peak_Cap_Half_01","SM_Prop_Plank_02_orig","SM_Env_Bushes_03","SM_Prop_Brick_02","SM_Env_Fence_Woof_03","SM_Env_Path_Wood_02","SM_Prop_Barrel_01_copy","pb_Mesh104748","SM_Item_Saw_01","thinRoof","pb_Mesh95050","pMillBlades","SM_Env_Tree_03","SM_Prop_Apple_01_on_tree","SM_Env_Straw_Field_01","ship","pb_Mesh108348","pb_Mesh109906","pb_Mesh108106","pb_Mesh114426","cauldron","pb_Mesh104600","SM_Prop_Anvil_01","corn_plant","PlaneMounts","SM_Env_Path_Wood_Side_01","SM_Env_Flax_03","SM_Env_Flowers_01","PlaneGround","trashBin","bed","SM_Prop_Table_Wood_01","SM_Prop_Mortar_And_Pestle_01","SM_Item_Mug_Tankard_01","chair","bath","fireplace","SM_Prop_Workbench_01_Preset","floor","pHomeMapChest","SM_Prop_Mirror_03","rug","SM_Bld_Castle_Door_Single_01","SM_Env_Planter_Pot_07","flowers1","snowRoof","SM_Prop_TorchStick_01","SM_Prop_Tech_Crystal_01","pSnowEnv","pSnowCave","snowLog","snowTree","SM_Prop_Crystal_01","caveTile1","brickWall1","brickDoor1","brickStairs1","caveWall1","SM_Prop_Gravestone_01","pCaveSnakeHead","SM_Env_StoneWall_Pillar_01","treasureChest","iWater","iCoin","iLog","iPlank","iWheat","iApple","iAleBarrel","iFlour","arrow","rainDirt","MAX","crate","iBread","swords","Boots","iBook","iOre","iIron","iWool","iCorn","iCrystal","iGem","exclamation"],qi={zones:wF,items:FF,singletonMeshes:LF,teleports:NF,meshes:BF},kF=""+new URL("texture0_compressed-d7c577c1.jpg",import.meta.url).href,UF=new URL("assets/SM_Prop_Log_Big_02.0927ce48.glb",location.href).href,VF=new URL("assets/SM_Env_DirtRoad_Straight_01.26e962ce.glb",location.href).href,GF=new URL("assets/SM_Env_Rock_02.7bcb9dfb.glb",location.href).href,zF=new URL("assets/SM_Bld_House_Roof_Thatch_Peak_Cap_Half_01.aa4069f3.glb",location.href).href,HF=new URL("assets/SM_Prop_Plank_02_orig.d14f0c81.glb",location.href).href,WF=new URL("assets/SM_Env_Bushes_03.80c2af62.glb",location.href).href,XF=new URL("assets/SM_Prop_Brick_02.398207f4.glb",location.href).href,YF=new URL("assets/SM_Env_Fence_Woof_03.e79bb738.glb",location.href).href,KF=new URL("assets/SM_Env_Path_Wood_02.c89b1e4c.glb",location.href).href,QF=new URL("assets/SM_Prop_Barrel_01_copy.de097a06.glb",location.href).href,ZF=new URL("assets/pb_Mesh104748.78f600ce.glb",location.href).href,qF=new URL("assets/SM_Item_Saw_01.13a78435.glb",location.href).href,jF=new URL("assets/thinRoof.be8e7977.glb",location.href).href,$F=new URL("assets/pb_Mesh95050.022f62e4.glb",location.href).href,JF=new URL("assets/pMillBlades.ae44fbf7.glb",location.href).href,eL=new URL("assets/SM_Env_Tree_03.f0113f64.glb",location.href).href,tL=new URL("assets/SM_Prop_Apple_01_on_tree.e98a05cc.glb",location.href).href,iL=new URL("assets/SM_Env_Straw_Field_01.de15ba4e.glb",location.href).href,nL=new URL("assets/ship.740ec4ea.glb",location.href).href,sL=new URL("assets/pb_Mesh108348.b67d4111.glb",location.href).href,rL=new URL("assets/pb_Mesh109906.c603f8d1.glb",location.href).href,aL=new URL("assets/pb_Mesh108106.c5cc412b.glb",location.href).href,oL=new URL("assets/pb_Mesh114426.ff977f3b.glb",location.href).href,lL=new URL("assets/cauldron.996751a5.glb",location.href).href,cL=new URL("assets/pb_Mesh104600.908cd0d1.glb",location.href).href,uL=new URL("assets/SM_Prop_Anvil_01.60b123f4.glb",location.href).href,hL=new URL("assets/corn_plant.919e5dc4.glb",location.href).href,dL=new URL("assets/PlaneMounts.1c34b194.glb",location.href).href,fL=new URL("assets/SM_Env_Path_Wood_Side_01.46196529.glb",location.href).href,pL=new URL("assets/SM_Env_Flax_03.3f695601.glb",location.href).href,mL=new URL("assets/SM_Env_Flowers_01.86d614df.glb",location.href).href,_L=new URL("assets/PlaneGround.1c11df18.glb",location.href).href,gL=new URL("assets/trashBin.4e59543e.glb",location.href).href,EL=new URL("assets/bed.36cf329b.glb",location.href).href,vL=new URL("assets/SM_Prop_Table_Wood_01.5f3b3276.glb",location.href).href,yL=new URL("assets/SM_Prop_Mortar_And_Pestle_01.988760ee.glb",location.href).href,AL=new URL("assets/SM_Item_Mug_Tankard_01.e7581666.glb",location.href).href,TL=new URL("assets/chair.3c34bd6d.glb",location.href).href,SL=new URL("assets/bath.7b20d3df.glb",location.href).href,CL=new URL("assets/fireplace.f5b1bbce.glb",location.href).href,IL=new URL("assets/SM_Prop_Workbench_01_Preset.aac1214e.glb",location.href).href,RL=new URL("assets/floor.a4fa4fd9.glb",location.href).href,bL=new URL("assets/pHomeMapChest.1ee7cb6b.glb",location.href).href,xL=new URL("assets/SM_Prop_Mirror_03.f95272a9.glb",location.href).href,ML=new URL("assets/rug.3527d8d1.glb",location.href).href,PL=new URL("assets/SM_Bld_Castle_Door_Single_01.eeff323d.glb",location.href).href,DL=new URL("assets/SM_Env_Planter_Pot_07.c4fd4893.glb",location.href).href,OL=new URL("assets/flowers1.82e06796.glb",location.href).href,wL=new URL("assets/snowRoof.3ec735d3.glb",location.href).href,FL=new URL("assets/SM_Prop_TorchStick_01.9e51b69d.glb",location.href).href,LL=new URL("assets/SM_Prop_Tech_Crystal_01.c7d89d25.glb",location.href).href,NL=new URL("assets/pSnowEnv.c2f115aa.glb",location.href).href,BL=new URL("assets/pSnowCave.1d67735e.glb",location.href).href,kL=new URL("assets/snowLog.fceeb1e2.glb",location.href).href,UL=new URL("assets/snowTree.59e81d30.glb",location.href).href,VL=new URL("assets/SM_Prop_Crystal_01.03690f29.glb",location.href).href,GL=new URL("assets/caveTile1.5f276f08.glb",location.href).href,zL=new URL("assets/brickWall1.81a00b9f.glb",location.href).href,HL=new URL("assets/brickDoor1.d7f0e690.glb",location.href).href,WL=new URL("assets/brickStairs1.537c2184.glb",location.href).href,XL=new URL("assets/caveWall1.df372f2e.glb",location.href).href,YL=new URL("assets/SM_Prop_Gravestone_01.100110ec.glb",location.href).href,KL=new URL("assets/pCaveSnakeHead.10678eed.glb",location.href).href,QL=new URL("assets/SM_Env_StoneWall_Pillar_01.0d96e414.glb",location.href).href,ZL=new URL("assets/treasureChest.28294d35.glb",location.href).href,qL=new URL("assets/iWater.05ae422a.glb",location.href).href,jL=new URL("assets/iCoin.bb782531.glb",location.href).href,$L=new URL("assets/iLog.351138fe.glb",location.href).href,JL=new URL("assets/iPlank.d3e91b19.glb",location.href).href,eN=new URL("assets/iWheat.edfd2421.glb",location.href).href,tN=new URL("assets/iApple.8cea81ff.glb",location.href).href,iN=new URL("assets/iAleBarrel.e2755866.glb",location.href).href,nN=new URL("assets/iFlour.71c42609.glb",location.href).href,sN=new URL("assets/arrow.9b197585.glb",location.href).href,rN=new URL("assets/rainDirt.c733a486.glb",location.href).href,aN=new URL("assets/MAX.0f9d98fc.glb",location.href).href,oN=new URL("assets/crate.5a38b23e.glb",location.href).href,lN=new URL("assets/iBread.9bb46135.glb",location.href).href,cN=new URL("assets/swords.2b78f747.glb",location.href).href,uN=new URL("assets/Boots.f57f67ab.glb",location.href).href,hN=new URL("assets/iBook.e7e80f1d.glb",location.href).href,dN=new URL("assets/iOre.fed1645e.glb",location.href).href,fN=new URL("assets/iIron.0d4b9e94.glb",location.href).href,pN=new URL("assets/iWool.b573e135.glb",location.href).href,mN=new URL("assets/iCorn.2dcee103.glb",location.href).href,_N=new URL("assets/iCrystal.19e09ac8.glb",location.href).href,gN=new URL("assets/iGem.1dda5cd6.glb",location.href).href,EN=new URL("assets/exclamation.761d2566.glb",location.href).href,vN=""+new URL("lvl1-f837e4c0.json",import.meta.url).href,yN=Object.freeze(Object.defineProperty({__proto__:null,Boots:uN,MAX:aN,PlaneGround:_L,PlaneMounts:dL,SM_Bld_Castle_Door_Single_01:PL,SM_Bld_House_Roof_Thatch_Peak_Cap_Half_01:zF,SM_Env_Bushes_03:WF,SM_Env_DirtRoad_Straight_01:VF,SM_Env_Fence_Woof_03:YF,SM_Env_Flax_03:pL,SM_Env_Flowers_01:mL,SM_Env_Path_Wood_02:KF,SM_Env_Path_Wood_Side_01:fL,SM_Env_Planter_Pot_07:DL,SM_Env_Rock_02:GF,SM_Env_StoneWall_Pillar_01:QL,SM_Env_Straw_Field_01:iL,SM_Env_Tree_03:eL,SM_Item_Mug_Tankard_01:AL,SM_Item_Saw_01:qF,SM_Prop_Anvil_01:uL,SM_Prop_Apple_01_on_tree:tL,SM_Prop_Barrel_01_copy:QF,SM_Prop_Brick_02:XF,SM_Prop_Crystal_01:VL,SM_Prop_Gravestone_01:YL,SM_Prop_Log_Big_02:UF,SM_Prop_Mirror_03:xL,SM_Prop_Mortar_And_Pestle_01:yL,SM_Prop_Plank_02_orig:HF,SM_Prop_Table_Wood_01:vL,SM_Prop_Tech_Crystal_01:LL,SM_Prop_TorchStick_01:FL,SM_Prop_Workbench_01_Preset:IL,arrow:sN,bath:SL,bed:EL,brickDoor1:HL,brickStairs1:WL,brickWall1:zL,cauldron:lL,caveTile1:GL,caveWall1:XL,chair:TL,corn_plant:hL,crate:oN,exclamation:EN,fireplace:CL,floor:RL,flowers1:OL,iAleBarrel:iN,iApple:tN,iBook:hN,iBread:lN,iCoin:jL,iCorn:mN,iCrystal:_N,iFlour:nN,iGem:gN,iIron:fN,iLog:$L,iOre:dN,iPlank:JL,iWater:qL,iWheat:eN,iWool:pN,lvl1:vN,pCaveSnakeHead:KL,pHomeMapChest:bL,pMillBlades:JF,pSnowCave:BL,pSnowEnv:NL,pb_Mesh104600:cL,pb_Mesh104748:ZF,pb_Mesh108106:aL,pb_Mesh108348:sL,pb_Mesh109906:rL,pb_Mesh114426:oL,pb_Mesh95050:$F,rainDirt:rN,rug:ML,ship:nL,snowLog:kL,snowRoof:wL,snowTree:UL,swords:cN,thinRoof:jF,trashBin:gL,treasureChest:ZL},Symbol.toStringTag,{value:"Module"}));function sd(...s){const e=new Set;return s.forEach(t=>{Object.keys(t).forEach(i=>{e.add(i)})}),[...e]}const yv=g.Zero(),Av=g.Zero(),Tv=g.Zero(),AN=[yv,Av,Tv];function TN(s){const e=[];for(let t=0;t<s.length;t+=9){for(let i=0;i<3;i++){const n=t+i*3;AN[i].set(s[n+0],s[n+1],s[n+2])}e.push({pos:yv.clone(),rot:Tv.clone(),scale:Av.clone()})}return e}class SN{constructor(e,t,i){X(this,"dirty",!0);X(this,"state","hidden");X(this,"willAdd",[]);X(this,"all",new Set);X(this,"unused",new Set);X(this,"used",new Set);X(this,"purchased",new Set);X(this,"activeTransforms",{});X(this,"_buildStages",[]);X(this,"_buildStage",-1);X(this,"purchases");this.buildingName=e,this.zone=t,this.categories=i;const n=this.categories,r=n.animate;n.animateMesh&&r.length>0&&this.all.add(n.animateMesh);const a=[];for(let o=0;o<r.length;o+=9){let l=0;for(;l<9;)a.push(r[o+l]),l++;this._buildStages.push({[n.animateMesh]:[...a]})}sd(n.statics,n.staticsDisabledOnFinish,n.clearing,n.disabledOnFinish,n.finish,n.parts).forEach(o=>{this.all.add(o)}),this.purchases=i.purchases,Object.values(this.purchases).forEach(o=>{sd(o.meshes).forEach(l=>this.all.add(l))})}hide(){this.state!=="hidden"&&(this.dirty=!0,this.state="hidden")}init(){this.state!=="init"&&(this.dirty=!0,this.state="init")}clear(){this.state==="inProgress"&&this._buildStage<0||(this._buildStage=-1,this.state="inProgress",this.dirty=!0)}inProgress(e){let t=Math.round((this._buildStages.length-1)*e);e<.001&&(t=-1),!(this.state==="inProgress"&&t===this._buildStage)&&(this._buildStage=t,this.state="inProgress",this.dirty=!0)}build(){this.state!=="finished"&&(this.state="finished",this.dirty=!0)}purchase(e){this.purchased.has(e)||(this.purchased.add(e),this.dirty=!0)}update(){if(!this.dirty)return;this.dirty=!1;const e=this.categories;switch(this.willAdd.length=0,this.willAdd.push(e.statics),this.state){case"hidden":this.willAdd.length=0;break;case"init":this.willAdd.push(e.clearing,e.staticsDisabledOnFinish);break;case"inProgress":if(this.willAdd.push(e.disabledOnFinish,e.staticsDisabledOnFinish),this._buildStage>=0){const t=this._buildStages[this._buildStage];t&&this.willAdd.push(t)}break;case"finished":this.willAdd.push(e.parts,e.finish),this.purchased.forEach(t=>{this.willAdd.push(this.purchases[t].meshes)});break}this.willAdd=this.willAdd.filter(t=>Object.keys(t).length>0),this.unused=new Set(this.all),this.used=new Set,this.activeTransforms={},this.willAdd.forEach(t=>{sd(t).forEach(i=>{const n=i,r=t[i];this.unused.delete(n),this.used.add(n),this.activeTransforms[n]||(this.activeTransforms[n]=[]),this.activeTransforms[n].push(...r)})})}}class CN{constructor(e,t,i){X(this,"lvlData");X(this,"currentZone",null);X(this,"meshes",{});X(this,"transformedRoot");X(this,"loadingMeshes",new Set);X(this,"buildings",{});X(this,"layeredMeshTransforms",{});X(this,"material");X(this,"singletonMeshesNames",new Set);X(this,"buffersPerZone",{});X(this,"clearedBuildings",new Set);X(this,"inProgressBuildings",{});X(this,"finishedBuildings",new Set);X(this,"tmpMatrix",D.Identity());this.scene=e,this.world=t,this.assetManager=i,this.lvlData=qi,this.transformedRoot=new Me("_gltf_root",e),this.transformedRoot.scaling.z=-1,this.transformedRoot.rotation.y=Math.PI,this.material=new J("LvlMaterial",e),this.material.transparencyMode=0,this.material.diffuseColor=G.FromHexString("#646464"),this.material.emissiveColor=G.FromHexString("#000000"),this.material.specularColor.set(0,0,0);const n=new H(kF,e,!0,!1);n.level=1.5,n.name="LvlTexture",this.material.diffuseTexture=n,this.init(),this.initLvl()}init(){const e=this.world;e.bus.onBuildingAnimationClear.add(t=>{const i=t;this.finishedBuildings.has(i)||this.inProgressBuildings[i]||(this.clearedBuildings.add(i),this.currentZone&&this.clearBuilding(i))}),e.bus.onBuildingAnimationProgress.add(({producer:t,progress:i})=>{const n=t;this.finishedBuildings.has(n)||(this.inProgressBuildings[n]=i,this.clearedBuildings.delete(n),this.currentZone&&this.inProgressBuilding(n,i))}),e.bus.onBuildingFinished.add(({key:t})=>{const i=t;this.finishedBuildings.has(i)||(this.finishedBuildings.add(i),this.clearedBuildings.delete(i),delete this.inProgressBuildings[i],this.currentZone&&this.buildBuilding(i))}),this.world.bus.onInteractiveAreaEntered.add(t=>{if(!t.area||!t.area.enabled)return;const i=t.area.teleport;if(!i)return;const n=i.targetZone;if(t.entity.playerInInteractiveArea)return;const r=this.getZone(n);this.loadZone(n).finally(()=>{e.playerEntity.transform.position.copyFrom(i.to),this.finishedBuildings.forEach(o=>r.buildings[o]&&this.buildBuilding(o)),Object.entries(this.inProgressBuildings).forEach(([o,l])=>r.buildings[o]&&this.inProgressBuilding(o,l)),this.clearedBuildings.forEach(o=>r.buildings[o]&&this.clearBuilding(o))})})}initLvl(){let e=()=>{};const t=new Promise(i=>{e=i});return this.lvlData.singletonMeshes.forEach(i=>this.singletonMeshesNames.add(i)),Promise.allSettled(this.lvlData.items.map(i=>this.loadModel(i))).then(()=>{const i=this.lvlData.items.map(n=>this.meshes[n]).filter(Boolean);this.scene.prepareItems(i)}).finally(()=>{console.log("lvl loaded"),e()}),Object.keys(this.lvlData.zones).forEach(i=>{const n=i;this.buffersPerZone[n]={};const r=this.getZone(n);Object.entries(r.buildings).forEach(a=>{const o=a[0],l=a[1],c=new SN(o,n,l);this.buildings[o]=c,o==="pHomeMap"&&this.finishedBuildings.add("pHomeMap")})}),t}getZone(e){return this.lvlData.zones[e]}updateBuffer(e,t,i){const n=Math.ceil(i.length/9);let r,a=0;const o=16*n;r=new Float32Array(o),this.buffersPerZone[t][e]=r;const l=g.Zero(),c=g.Zero(),u=g.Zero(),h=[l,c,u];for(let d=0;d<i.length;d+=9){for(let m=0;m<3;m++){const _=d+m*3;h[m].set(i[_+0],i[_+1],i[_+2])}const f=ee.FromEulerVector(u);D.Compose(c,f,l).copyToArray(r,a),a+=16}}loadZone(e){return Ie(this,null,function*(){const t=this.getZone(e),i=new Set;this.currentZone!=null&&([...this.world.treesQuery.entities].forEach(l=>{if(l.model&&l.model.visual){const c=l.model.visual.model;c.isAnInstance||c.dispose()}this.world.remove(l)}),this.world.bus.onZoneUnLoaded.notifyObservers(this.currentZone)),this.layeredMeshTransforms={},Object.entries(t.env).forEach(([o,l])=>{const c=o;i.add(c),this.layeredMeshTransforms[c]?this.layeredMeshTransforms[c].env.push(...l):this.layeredMeshTransforms[c]={env:[...l],buildings:[]}}),Object.entries(t.buildings).forEach(o=>{const l=o[0],c=this.buildings[l];c&&(this.finishedBuildings.has(l)?c.build():this.clearedBuildings.has(l)?c.inProgress(.01):c.init(),c.update(),c.used.forEach(u=>{this.layeredMeshTransforms[u]||(this.layeredMeshTransforms[u]={buildings:[],env:[]});const h=c.activeTransforms[u];h&&this.layeredMeshTransforms[u].buildings.push(...h),i.add(u)}))});const n=new Set(this.lvlData.items),r=this.lvlData.meshes.filter(o=>!n.has(o));r.forEach(o=>{const l=this.layeredMeshTransforms[o];if(!l){this.updateBuffer(o,e,[]);return}this.updateBuffer(o,e,[...l.env,...l.buildings])}),yield Promise.allSettled([...i].map(o=>this.loadModel(o))),this.currentZone=e,r.forEach(o=>{this.updateModel(o,this.buffersPerZone[e][o]);const l=t.chopping[o];l&&this.initChopping(e,o,l)}),i.clear();const a=this.world.playerEntity;this.world.removeComponent(a,"zone"),this.world.addComponent(a,"zone",e),this.world.removeComponent(a,"gridMap"),t.gridMap&&this.world.addComponent(a,"gridMap",t.gridMap),this.scene.unfreezeActiveMeshes(),this.world.bus.onZoneLoaded.notifyObservers(e),Oe.addDesignEvent(`UI:Zones:Loaded_${e}`)})}initChopping(e,t,i){if(!i||i.length<1)return;const n=this.meshes[t],r=n.clone(n.name+"Choppable",n.parent);r.makeGeometryUnique();let a=r;TN(i).forEach((o,l)=>{l>0&&(a=r.createInstance(r.name+l),a.setParent(n.parent)),a.position.copyFrom(o.pos),a.rotation.copyFrom(o.rot),a.rotationQuaternion=null,a.scaling.copyFrom(o.scale),a.freezeWorldMatrix(),this.world.add({dontSaveEnabled:!0,enabled:!0,tree:!0,zone:e,transform:{position:o.pos,rotation:{y:o.rot.y},scaling:o.scale},attributes:{attBaseMaxDurability:3},durability:2,model:{key:t,visual:{variant:0,key:t,model:a}},lastChopper:null})})}loadModel(e){return Ie(this,null,function*(){const t=yN[e];if(!t)return console.error("no url for mesh:",e),Promise.resolve();let i=()=>{};const n=new Promise(o=>{i=o});for(;this.loadingMeshes.has(e);)yield Te(100);if(this.meshes[e])return i(),n;this.loadingMeshes.add(e);const r=this.assetManager.addMeshTask(e,void 0,t,""),a=()=>r.run(this.scene,()=>{r.loadedMeshes.forEach(l=>{l.material&&l.material.dispose(!0),l.material=this.material});const o=r.loadedMeshes[1];o.name=e,this.meshes[e]=o,o.setParent(this.transformedRoot),r.loadedMeshes[0].dispose(),this.loadingMeshes.delete(e),i()},(o,l)=>{(o||l)&&console.error(o||l),Te(2e3).then(()=>a())});return a(),n})}hideBuilding(e){const t=this.buildings[e];t&&(t.hide(),this.updateBuildings(e))}initBuilding(e){const t=this.buildings[e];t&&(t.init(),this.updateBuildings(e))}clearBuilding(e){const t=this.buildings[e];t&&(t.clear(),this.updateBuildings(e))}inProgressBuilding(e,t){const i=this.buildings[e];i&&(i.inProgress(t),this.updateBuildings(e))}buildBuilding(e){const t=this.buildings[e];t&&(t.build(),this.updateBuildings(e))}purchase(e,t){const i=this.buildings[e];i&&(i.purchase(t),this.updateBuildings(e))}updateBuildings(e){const t=this.buildings[e];if(!t)return;t.update();const i=this.layeredMeshTransforms,n=Object.values(this.buildings);t.all.forEach(r=>{let a=i[r];a?a.buildings.length=0:a=i[r]={env:[],buildings:[]},n.forEach(o=>{o.activeTransforms[r]&&a.buildings.push(...o.activeTransforms[r])}),this.updateBuffer(r,t.zone,[...a.env,...a.buildings]),this.updateModel(r,this.buffersPerZone[t.zone][r])}),this.scene.unfreezeActiveMeshes()}updateModel(e,t){const i=this.meshes[e];i&&(t.length<1?i.setEnabled(!1):(this.singletonMeshesNames.has(e)?(i.unfreezeWorldMatrix(),D.FromArrayToRef(t,0,this.tmpMatrix).decompose(i.scaling,i.rotationQuaternion,i.position),i.freezeWorldMatrix()):(i.thinInstanceSetBuffer("matrix",t,16,!1),i.thinInstanceBufferUpdated("matrix")),i.setEnabled(!0)),this.scene.forceModelToUpdate(i))}waitForMeshes(e){return Ie(this,null,function*(){yield Promise.allSettled(e.map(t=>this.loadModel(t)))})}downloadAllMeshesInSequence(){return Ie(this,null,function*(){const e=new Set;Object.values(this.lvlData.zones).forEach(t=>{Object.keys(t.env||{}).forEach(i=>{e.add(i)}),Object.values(this.buildings).forEach(i=>{i.all.forEach(n=>e.add(n))})});for(const t of e)yield this.loadModel(t),this.currentZone&&this.updateModel(t,this.buffersPerZone[this.currentZone][t]);this.scene.unfreezeActiveMeshes()})}}const IN=[{from:0,to:249.99999046325684,name:"Idle"},{from:0,to:52.5,name:"Run"},{from:0,to:52.5,name:"Run_Carry"},{from:0,to:62.49999761581421,name:"SwordSlash"},{from:0,to:75,name:"Walk"},{from:0,to:75,name:"Walk_Carry"}];function RN(s,e,t){return Ie(this,null,function*(){let i;const n=new Promise(A=>{i=A}),r=Date.now(),a=new HM(s);let o=.8;const l=()=>{const A=Math.floor(100*o);e.style.width=A+"%"};l(),a.useDefaultLoadingScreen=!1;let c=()=>{};const u=new Promise(A=>{c=A}),h=2;let d=0;const f=()=>{o+=.1,l(),d++,d>=h&&i()},p=a.addTextFileTask("anims",MF),m=a.addMeshTask("baseCharacter",void 0,xF,""),_=()=>{m.run(s,()=>Ie(this,null,function*(){m.loadedAnimationGroups.forEach(st=>{st.stop()});const A=m.loadedMeshes[0];(()=>{A.scaling.setAll(1),A.rotationQuaternion&&A.rotationQuaternion.set(0,0,0,0),A.rotationQuaternion=null,A.rotation.setAll(0),A.position.setAll(0)})();const T=Date.now(),R=A.getChildTransformNodes(!0)[0].getChildMeshes(!1);R.forEach(st=>{st.material&&st.material.dispose()});const x=he.MergeMeshes(R,!1,!0,void 0,!1,!1);x.name="_MergedModel1",x.skeleton=R[0].skeleton,x.doNotSyncBoundingInfo=!0,s.onBeforeRenderObservable.add(()=>{x.skeleton.prepare()}),x.scaling.setAll(.6),x.position.setAll(0);const F=yield u;yield DF(s,x,F);const L=new Ro("CharacterMaterial",s);x.material=L,L.specularColor=G.White().scaleInPlace(2/255),L.diffuseColor=G.White().scaleInPlace(149/255),L.emissiveColor=G.FromHexString("#1E1E1E"),L.specularPower=10;const V=128,Z=OP(R,V),ne=x.getTotalVertices(),ae=R.length,Ue=32,Ve=V,$e=[],re=[];for(let st=0;st<ne;st++)$e.push(0,0,0,0),re.push(st,0);x.registerInstancedBuffer(C.ColorKind,4),x.instancedBuffers.color=new pe(0,0,0,0),x.setVerticesData(C.ColorKind,$e),x.setVerticesData(C.UVKind,re);const ge=an.CreateRGBATexture(Z.pixelsData,Ue,Ve,s,!1,!1,N.TEXTURE_NEAREST_SAMPLINGMODE,N.TEXTURETYPE_UNSIGNED_BYTE);ge.name="CharactersPaintingTexture",L.AddUniform("texVertColors","sampler2D",ge),L.AddAttribute(C.UVKind),L.Vertex_Definitions("attribute vec2 uv;");let be=0;const ze=`${R.reduce((st,Jt,Wt)=>{if(Wt===0)return be+=Jt.getTotalVertices(),st;let ii=`(step(${be}.0,vId)-step(${be+Jt.getTotalVertices()}.0,vId))*${Wt}.0`;return Wt<ae-1&&(ii+="+"),be+=Jt.getTotalVertices(),st+ii},"")}`;L.Vertex_MainEnd(`
        float vId = uv.x;
        float partIdInt = ${ze};
        float partId = (partIdInt + 0.5) / ${Ue}.0;
        float instanceId = (color.r + 0.5) / ${Ve}.0;
        vColor = texture2D(texVertColors, vec2(partId, instanceId));
        gl_Position.y = vColor.w * gl_Position.y;
        `);const Ke=()=>{ge.update(Z.pixelsData)};R.forEach(st=>st.dispose());const Ut=new PF(s,x,IN,Z,Ke);L.forceCompilation(x,()=>{Oe.addDesignEvent("UI:Loading:RChar",Date.now()-r),Oe.addDesignEvent("UI:Loading:RCharDur",Date.now()-T),console.log("compilation finished"),s.registerNPCPool("npc_worker",Ut),f()},{},st=>{throw Oe.addDesignEvent("UI:Loading:RCharDurError",Date.now()-T),Oe.addErrorEvent(Ii.EGAErrorSeverity.Critical,st||"compilation error"),new Error("compilation error:"+st)})}),(A,I)=>{(A||I)&&console.error(A||I),Te(2e3).then(()=>_())})},E=()=>{p.run(s,()=>{Oe.addDesignEvent("UI:Loading:RAnims",Date.now()-r),c(p.text)},(A,I)=>{(A||I)&&console.error(A||I),Te(2e3).then(()=>E())})};E(),_();const v=new CN(s,t,a);window.lvlManager=v,t.add({lvlManager:v});const y=Date.now();return v.loadZone("zVillage").finally(()=>{Oe.addDesignEvent("UI:Loading:RStatic",Date.now()-y),f()}),n})}const bN=()=>Dn.onPreloadingFinished.notifyObservers(),xN=M.memo(()=>{const s=bt(),[e,t]=ve.useState(!1);return ve.useEffect(()=>{const i=document.querySelector(".progress-bar__progress"),n=document.createElement("canvas");n.className="game-canvas",n.width=400,n.height=300;let r;try{r=uP(n).engine}catch(u){console.error(u),u instanceof Error&&Oe.addErrorEvent(Ii.EGAErrorSeverity.Critical,u.toString()),document.querySelector(".preloader").style.display="none",t(!0);return}r.hideLoadingUI();const a=new bF(r);a.initializeGameScene();try{Oe.addDesignEvent("UI:Tech:WebGL_"+r.version)}catch(u){}const o=a.defaultCamera;if(o==null)throw new Error("no camera?");RN(a,i,s).finally(()=>{bN()}),s.add({engine:r}),s.add({canvas:n}),s.add({scene:a}),o.setTarget(s.playersQuery.entities[0].transform.position.clone()),o.radius=14,o.alpha=-Math.PI/4,o.beta=Math.PI/4;const l=s.add({enabled:!0,camera:o,cameraSettings:{radius:o.radius,alpha:o.alpha,beta:o.beta,target:o.target.clone(),targetSpeed:20},cameraFollowPlayer:!0}),c=s.add({camera:o,cameraSettings:{radius:o.radius,alpha:o.alpha,beta:o.beta,target:o.target.clone(),targetSpeed:20},cameraCinematic:{posPath:new So([new g(122,2,122),new g(180,20,160),o.target.clone()]),rotPath:new So([new g(Math.PI,Math.PI/3,0),new g(0,Math.PI/3,10)]),durations:[10,10],onStart:[()=>{s.removeComponent(l,"enabled")}],onFinish:[()=>{It(s,l),s.removeComponent(c,"enabled")}]}})},[s]),e?M.createElement("h1",{style:{padding:"1rem"}},"Sorry, we can't launch the game in your browser. Try to update it."):null});function Dg(s,e){(e==null||e>s.length)&&(e=s.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=s[t];return i}function MN(s,e){if(s){if(typeof s=="string")return Dg(s,e);var t=Object.prototype.toString.call(s).slice(8,-1);if(t==="Object"&&s.constructor&&(t=s.constructor.name),t==="Map"||t==="Set")return Array.from(s);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return Dg(s,e)}}function PN(s,e){var t=typeof Symbol!="undefined"&&s[Symbol.iterator]||s["@@iterator"];if(!t){if(Array.isArray(s)||(t=MN(s))||e&&s&&typeof s.length=="number"){t&&(s=t);var i=0,n=function(){};return{s:n,n:function(){return i>=s.length?{done:!0}:{done:!1,value:s[i++]}},e:function(l){throw l},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var r=!0,a=!1,o;return{s:function(){t=t.call(s)},n:function(){var l=t.next();return r=l.done,l},e:function(l){a=!0,o=l},f:function(){try{!r&&t.return!=null&&t.return()}finally{if(a)throw o}}}}function DN(s,e){if(!(s instanceof e))throw new TypeError("Cannot call a class as a function")}function Og(s,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(s,i.key,i)}}function ON(s,e,t){return e&&Og(s.prototype,e),t&&Og(s,t),Object.defineProperty(s,"prototype",{writable:!1}),s}function wN(s,e,t){return e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}var wg=function(){function s(){DN(this,s),wN(this,"listeners",new Set),this.emit=this.emit.bind(this)}return ON(s,[{key:"clear",value:function(){this.listeners.clear()}},{key:"add",value:function(t){var i=this;return this.listeners.add(t),function(){return i.remove(t)}}},{key:"remove",value:function(t){this.listeners.delete(t)}},{key:"emit",value:function(t){var i=PN(this.listeners),n;try{for(i.s();!(n=i.n()).done;){var r=n.value;r(t)}}catch(a){i.e(a)}finally{i.f()}}}]),s}();function Fg(s,e){(e==null||e>s.length)&&(e=s.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=s[t];return i}function FN(s,e){if(s){if(typeof s=="string")return Fg(s,e);var t=Object.prototype.toString.call(s).slice(8,-1);if(t==="Object"&&s.constructor&&(t=s.constructor.name),t==="Map"||t==="Set")return Array.from(s);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return Fg(s,e)}}function LN(s,e){var t=typeof Symbol!="undefined"&&s[Symbol.iterator]||s["@@iterator"];if(!t){if(Array.isArray(s)||(t=FN(s))||e&&s&&typeof s.length=="number"){t&&(s=t);var i=0,n=function(){};return{s:n,n:function(){return i>=s.length?{done:!0}:{done:!1,value:s[i++]}},e:function(l){throw l},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var r=!0,a=!1,o;return{s:function(){t=t.call(s)},n:function(){var l=t.next();return r=l.done,l},e:function(l){a=!0,o=l},f:function(){try{!r&&t.return!=null&&t.return()}finally{if(a)throw o}}}}function NN(s,e){if(!(s instanceof e))throw new TypeError("Cannot call a class as a function")}function Lg(s,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(s,i.key,i)}}function BN(s,e,t){return e&&Lg(s.prototype,e),t&&Lg(s,t),Object.defineProperty(s,"prototype",{writable:!1}),s}function rd(s,e,t){return e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}var Sv;Sv=Symbol.iterator;var kN=function(){function s(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];NN(this,s),rd(this,"onEntityAdded",new wg),rd(this,"onEntityRemoved",new wg),rd(this,"entityPositions",new Map),this.entities=e,this.add=this.add.bind(this),this.remove=this.remove.bind(this);for(var t=0;t<e.length;t++)this.entityPositions.set(e[t],t)}return BN(s,[{key:Sv,value:function(){var t=this,i=this.entities.length;return{next:function(){var r=t.entities[--i];return{value:r,done:i<0}}}}},{key:"size",get:function(){return this.entities.length}},{key:"has",value:function(t){return this.entityPositions.has(t)}},{key:"add",value:function(t){return t&&!this.has(t)&&(this.entities.push(t),this.entityPositions.set(t,this.entities.length-1),this.onEntityAdded.emit(t)),t}},{key:"remove",value:function(t){if(this.has(t)){this.onEntityRemoved.emit(t);var i=this.entityPositions.get(t);this.entityPositions.delete(t);var n=this.entities[this.entities.length-1];n!==t&&(this.entities[i]=n,this.entityPositions.set(n,i)),this.entities.pop()}return t}},{key:"clear",value:function(){var t=LN(this),i;try{for(t.s();!(i=t.n()).done;){var n=i.value;this.remove(n)}}catch(r){t.e(r)}finally{t.f()}}}]),s}();function qf(s,e){(e==null||e>s.length)&&(e=s.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=s[t];return i}function UN(s){if(Array.isArray(s))return qf(s)}function VN(s){if(typeof Symbol!="undefined"&&s[Symbol.iterator]!=null||s["@@iterator"]!=null)return Array.from(s)}function Cv(s,e){if(s){if(typeof s=="string")return qf(s,e);var t=Object.prototype.toString.call(s).slice(8,-1);if(t==="Object"&&s.constructor&&(t=s.constructor.name),t==="Map"||t==="Set")return Array.from(s);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return qf(s,e)}}function GN(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function jf(s){return UN(s)||VN(s)||Cv(s)||GN()}function $f(s){"@babel/helpers - typeof";return $f=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},$f(s)}function Zc(s,e){var t=typeof Symbol!="undefined"&&s[Symbol.iterator]||s["@@iterator"];if(!t){if(Array.isArray(s)||(t=Cv(s))||e&&s&&typeof s.length=="number"){t&&(s=t);var i=0,n=function(){};return{s:n,n:function(){return i>=s.length?{done:!0}:{done:!1,value:s[i++]}},e:function(l){throw l},f:n}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var r=!0,a=!1,o;return{s:function(){t=t.call(s)},n:function(){var l=t.next();return r=l.done,l},e:function(l){a=!0,o=l},f:function(){try{!r&&t.return!=null&&t.return()}finally{if(a)throw o}}}}function Fo(s,e){if(!(s instanceof e))throw new TypeError("Cannot call a class as a function")}function Ng(s,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(s,i.key,i)}}function Lo(s,e,t){return e&&Ng(s.prototype,e),t&&Ng(s,t),Object.defineProperty(s,"prototype",{writable:!1}),s}function pl(s){if(s===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return s}function Jf(s,e){return Jf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(i,n){return i.__proto__=n,i},Jf(s,e)}function oc(s,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");s.prototype=Object.create(e&&e.prototype,{constructor:{value:s,writable:!0,configurable:!0}}),Object.defineProperty(s,"prototype",{writable:!1}),e&&Jf(s,e)}function Ou(s){return Ou=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},Ou(s)}function zN(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(s){return!1}}function HN(s,e){if(e&&(typeof e=="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return pl(s)}function lc(s){var e=zN();return function(){var i=Ou(s),n;if(e){var r=Ou(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return HN(this,n)}}function ma(s,e,t){return e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}var Iv=function(){function s(){Fo(this,s),ma(this,"cache",new Map)}return Lo(s,[{key:"get",value:function(t,i){var n=this.cache.get(t);return n===void 0&&(this.cache.set(t,i),n=i),n}}]),s}();function WN(s){for(var e=arguments.length,t=new Array(e>1?e-1:0),i=1;i<e;i++)t[i-1]=arguments[i];return t.every(function(n){return s[n]!==void 0})}function XN(s){for(var e=arguments.length,t=new Array(e>1?e-1:0),i=1;i<e;i++)t[i-1]=arguments[i];return t.every(function(n){return s[n]===void 0})}new Iv;var Bg=function(e){return jf(new Set(e.sort().filter(function(t){return!!t&&t!==""})))},YN=function(e){return{with:e.with!==void 0?Bg(e.with):[],without:e.without!==void 0?Bg(e.without):[]}},KN=new Iv,QN=function(e){var t=YN(e),i=JSON.stringify(t);return KN.get(i,t)},Rv=function(s){oc(t,s);var e=lc(t);function t(){var i;Fo(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return i=e.call.apply(e,[this].concat(r)),ma(pl(i),"buckets",new Set),i}return Lo(t,[{key:"wants",value:function(n){return!0}},{key:"evaluate",value:function(n){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:n;if(this.wants(r)?this.add(n):this.remove(n),this.has(n)){var a=Zc(this.buckets),o;try{for(a.s();!(o=a.n()).done;){var l=o.value;l.evaluate(n,r)}}catch(c){a.e(c)}finally{a.f()}}}},{key:"where",value:function(n){var r=this,a=this.entities.length,o=function(){var c;do c=r.entities[--a];while(c&&!n(c));return{value:c,done:a<0}};return ma({},Symbol.iterator,function(){return{next:o}})}},{key:"with",value:function(){return this.archetype.apply(this,arguments)}},{key:"without",value:function(){for(var n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return this.archetype({without:r})}},{key:"archetype",value:function(n){if(typeof n=="function"){var r=Zc(this.buckets),a;try{for(r.s();!(a=r.n()).done;){var o=a.value;if(o instanceof kg&&o.predicate===n)return o}}catch(E){r.e(E)}finally{r.f()}var l=new kg(this,n);return this.buckets.add(l),l}if($f(n)!=="object"){for(var c=arguments.length,u=new Array(c>1?c-1:0),h=1;h<c;h++)u[h-1]=arguments[h];return this.archetype({with:[n].concat(u)})}var d=QN(n),f=Zc(this.buckets),p;try{for(f.s();!(p=f.n()).done;){var m=p.value;if(m instanceof Ug&&m.query===d)return m}}catch(E){f.e(E)}finally{f.f()}var _=new Ug(this,d);return this.buckets.add(_),_}}]),t}(kN),bv=function(s){oc(t,s);var e=lc(t);function t(i){var n;return Fo(this,t),n=e.call(this),n.source=i,n}return Lo(t,[{key:"startUpdating",value:function(){var n=this;this.source.onEntityAdded.add(function(r){n.wants(r)&&n.add(r)}),this.source.onEntityRemoved.add(function(r){n.remove(r)}),this.update()}},{key:"update",value:function(){var n=Zc(this.source),r;try{for(n.s();!(r=n.n()).done;){var a=r.value;this.evaluate(a)}}catch(o){n.e(o)}finally{n.f()}}}]),t}(Rv),kg=function(s){oc(t,s);var e=lc(t);function t(i,n){var r;return Fo(this,t),r=e.call(this,i),r.source=i,r.predicate=n,r.startUpdating(),r}return Lo(t,[{key:"wants",value:function(n){return this.predicate(n)}}]),t}(bv),Ug=function(s){oc(t,s);var e=lc(t);function t(i,n){var r;return Fo(this,t),r=e.call(this,i),r.source=i,r.query=n,r.startUpdating(),r}return Lo(t,[{key:"wants",value:function(n){return WN.apply(void 0,[n].concat(jf(this.query.with||[])))&&XN.apply(void 0,[n].concat(jf(this.query.without||[])))}}]),t}(bv);function Vg(s,e){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(s);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(s,n).enumerable})),t.push.apply(t,i)}return t}function ZN(s){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Vg(Object(t),!0).forEach(function(i){ma(s,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):Vg(Object(t)).forEach(function(i){Object.defineProperty(s,i,Object.getOwnPropertyDescriptor(t,i))})}return s}var qN=function(s){oc(t,s);var e=lc(t);function t(){var i,n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return Fo(this,t),i=e.call(this,n),ma(pl(i),"entityToId",new Map),ma(pl(i),"idToEntity",new Map),ma(pl(i),"nextId",0),i.onEntityRemoved.add(function(r){if(i.entityToId.has(r)){var a=i.entityToId.get(r);i.idToEntity.delete(a),i.entityToId.delete(r)}}),i}return Lo(t,[{key:"update",value:function(i){function n(r,a,o){return i.apply(this,arguments)}return n.toString=function(){return i.toString()},n}(function(i,n,r){if(typeof n=="function"){var a=n(i);a&&Object.assign(i,a)}else typeof n=="string"?i[n]=r:n&&Object.assign(i,n);return this.has(i)&&this.evaluate(i),i})},{key:"addComponent",value:function(n,r,a){n[r]===void 0&&(n[r]=a,this.has(n)&&this.evaluate(n))}},{key:"removeComponent",value:function(n,r){if(n[r]!==void 0){if(this.has(n)){var a=ZN({},n);delete a[r],this.evaluate(n,a)}delete n[r]}}},{key:"id",value:function(n){if(this.has(n)){if(!this.entityToId.has(n)){var r=this.nextId++;this.entityToId.set(n,r),this.idToEntity.set(r,n)}return this.entityToId.get(n)}}},{key:"entity",value:function(n){return this.idToEntity.get(n)}}]),t}(Rv);class jN extends qN{constructor(t=[]){super(t);X(this,"bus",eD());X(this,"upgradableProducers",["pPlayer","pSawmill","pWheatGarden","pWell","pLogNpc","pMill","pWaterNpc","pBaker","pMillerNpc","pAppleGarden","pWinery","pAppleNpc"]);X(this,"entityByIdentifier",new Map);X(this,"globalEffector",this.add({id:"pGlobalEffector",attributes:{attBaseMovementSpeed:0,attBaseProducingSpeed:0,attBasePickCoinsMultiplier:0},enabled:!0}));X(this,"villageEntity",this.add({villageMode:"peacetime"}));X(this,"identifiableQuery",this.with("id"));X(this,"mapObjectsQuery",this.identifiableQuery.with("transform"));X(this,"visualMapObjectsQuery",this.mapObjectsQuery.with("model","zone"));X(this,"itemsOnMapQuery",this.mapObjectsQuery.with("item"));X(this,"playersQuery",this.visualMapObjectsQuery.with("player","movement","attributes","recalculateAttributes","attributesLevel","movingTime","stayingTime","showMaxDuration","currentHp","maxHp","attackSpeed"));X(this,"ownedQuery",this.identifiableQuery.with("ownedBy"));X(this,"ownedItemsQuery",this.ownedQuery.with("item"));X(this,"effectsQuery",this.ownedQuery.with("effect"));X(this,"sceneQuery",this.with("scene"));X(this,"statsQuery",this.with("gameStatistics"));X(this,"npcsWithTasksQuery",this.mapObjectsQuery.with("npc","npcTasksList","attributes","zone"));X(this,"producersQuery",this.mapObjectsQuery.with("itemProducer","attributes","zone"));X(this,"queuableProducersQuery",this.producersQuery.with("queuable","usable"));X(this,"settingsQuery",this.with("settings"));X(this,"gameEventsQuery",this.with("gameEvent","enabled"));X(this,"debugQuery",this.with("debug"));X(this,"lvlManagerQuery",this.with("lvlManager"));X(this,"camerasQuery",this.with("camera","cameraSettings"));X(this,"activeCamerasQuery",this.camerasQuery.with("enabled"));X(this,"emojisQuery",this.with("npcEmoji","ownedBy"));X(this,"storageQuery",this.with("persistentStorage"));X(this,"soundsQuery",this.with("sound","soundKey"));X(this,"tasksQuery",this.with("task"));X(this,"varsQuery",this.with("persistentVars"));X(this,"mapInfoQuery",this.with("mapInfo"));X(this,"treesQuery",this.with("transform","tree","durability","model","zone"));X(this,"flagQuery",this.with("flag"));X(this,"npcGridMapQuery",this.with("npcGlobalGridMap"));X(this,"entitiesByOwner",new Map);X(this,"itemsEntitiesByOwner",new Map);this.onEntityAdded.add(i=>{i.id!=null&&this.entityByIdentifier.set(i.id,i)}),this.onEntityRemoved.add(i=>{i.id!=null&&this.entityByIdentifier.delete(i.id)}),this.ownedQuery.onEntityAdded.add(i=>{const n=i.ownedBy,r=this.entitiesByOwner,a=r.get(n);if(a?a.add(i):r.set(n,new Set([i])),i.item!=null){const o=this.itemsEntitiesByOwner,l=o.get(n);l?l.add(i):o.set(n,new Set([i]))}}),this.ownedQuery.onEntityRemoved.add(i=>{const n=i.ownedBy,a=this.entitiesByOwner.get(n);if(a!=null&&a.delete(i),i.item!=null){const l=this.itemsEntitiesByOwner.get(n);l!=null&&l.delete(i)}})}get villageMode(){return this.villageEntity.villageMode}get npcGlobalGridMap(){return this.npcGridMapQuery.entities[0].npcGlobalGridMap}get flag(){return this.flagQuery.entities[0].flag}get debug(){return this.debugQuery.entities[0].debug}get sceneEntity(){return this.sceneQuery.entities[0]}get playerEntity(){return this.playersQuery.entities[0]}get settingsEntity(){return this.settingsQuery.entities[0]}get playerItems(){const t=this.playerEntity;return[...this.itemsEntitiesByOwner.get(t.id)||[]]}get playerEffects(){const t=this.playerEntity;return this.effectsQuery.entities.filter(i=>i.ownedBy===t.id)}get statsEntity(){return this.statsQuery.entities[0]}get coinsCount(){const t=this.playerEntity;return this.ownedItemsQuery.entities.filter(i=>i.ownedBy===t.id&&i.item.key==="iCoin").reduce((i,n)=>i+n.item.count,0)}get playerItemsCount(){return this.playerItems.reduce((t,i)=>(i.item.key!=="iCoin"&&(t+=i.item.count),t),0)}get storage(){return this.storageQuery.entities[0]}get sounds(){return this.soundsQuery.entities}get tasks(){return this.tasksQuery.entities}get varsEntity(){return this.varsQuery.entities[0]}get mapInfo(){return this.mapInfoQuery.entities[0].mapInfo}get lvlManager(){const t=this.lvlManagerQuery.entities[0];return t==null?null:t.lvlManager}}class Za{static load(e){return Ie(this,null,function*(){try{return localStorage.getItem(e)}catch(t){return null}})}static save(e,t){return Ie(this,null,function*(){try{localStorage.setItem(e,t)}catch(i){}})}}const ad="__lll__",pm="__vcBIG__";function $N(s){return Ie(this,null,function*(){const e=yield Za.load(pm);if(e==null)return;JSON.parse(e).forEach(i=>{switch(i.type){case"achive":{const n=s.entityByIdentifier.get(i.id);n&&n.achievement&&(n.achievement.val=i.val,i.p&&s.addComponent(n,"purchased",!0));return}}})})}function JN(s){return Ie(this,null,function*(){const e=[];s.identifiableQuery.with("achievement").entities.forEach(i=>{e.push({type:"achive",id:i.id,val:i.achievement.val,p:!!i.purchased})});const t=JSON.stringify(e);yield Za.save(pm,t)})}class e3{constructor(){X(this,"_lastSaved","")}load(e){return Ie(this,null,function*(){const t=yield Za.load(ad);if(t==null)return;JSON.parse(t).forEach(n=>{switch(n.type){case"stats":{e.add({gameStatistics:{gameTime:0,servedClients:n.stats.servedClients||0,movementDistance:n.stats.movementDistance||0,picked:n.stats.picked||{},supplied:n.stats.supplied||{},produced:n.stats.produced||{},chopped:n.stats.chopped||0}});break}case"settings":{e.add({settings:{music:n.settings.music!=null?n.settings.music:!0,sound:n.settings.sound!=null?n.settings.sound:!0,locale:n.settings.locale||void 0}});break}case"vars":{e.add({persistentVars:{unlockedUpgrades:n.vars.unlockedUpgrades||0,viewedUpgrades:n.vars.viewedUpgrades||0,prestige:n.vars.prestige||0,dropTip:!!n.vars.dropTip,waves:n.vars.waves||0}});break}case"item":{const r={id:n.id,item:{key:n.itemKey,count:n.itemCount},ownedBy:n.ownedBy},a=n.transform;if(a!=null){const o=a.pos;r.zone=a.z||"zVillage",r.model={key:n.itemKey},r.transform={position:new g(o[0],o[1],o[2]),rotation:{y:a.rot.y}},r.pickable=!0,n.itemKey==="iCoin"&&(r.animateRotation={duration:Math.PI})}e.add(r);break}case"purchased":case"purchasedProducer":{const r=e.entityByIdentifier.get(n.id);r&&r.purchased==null&&e.addComponent(r,"purchased",!0);break}case"itemHolder":{const r=e.entityByIdentifier.get(n.id);r&&r.itemHolder&&(r.itemHolder.val=n.val,Dn.onGameLoaded.addOnce(a=>{if(!r.itemHolder)return;r.interactiveArea&&r.interactiveArea.target&&r.interactiveArea.target.purchased&&Math.abs(r.itemHolder.max-r.itemHolder.val)>.001&&(r.itemHolder.val=r.itemHolder.max),r.itemHolder.onValueChanged&&r.itemHolder.onValueChanged.forEach(l=>{l(a,r)}),r.itemHolder.max-r.itemHolder.val<.001&&r.itemHolder.onMaxed&&r.itemHolder.onMaxed.forEach(l=>l(a,r))}));break}case"enable":{const r=e.entityByIdentifier.get(n.id);r&&It(e,r);break}case"willRemoveDelay":{const r=e.entityByIdentifier.get(n.id);r&&e.addComponent(r,"willRemoveDelay",n.delay);break}case"ordersProgress":{const r=e.entityByIdentifier.get(n.id);r&&KP(e,r,n.progress);break}case"task":{if(n.finished){const r=e.tasks.find(a=>a.task.op===n.op);r&&(e.removeComponent(r,"taskActive"),e.addComponent(r,"taskDone",!0))}break}case"appearance":{const r=e.playerEntity.appearance;r&&(r.parts=n.parts.map(a=>[a[0],a[1],G.FromHexString(a[2])]));break}case"flag":{e.flag.forEach((r,a)=>{e.flag[a]=n.flag[a]||e.flag[a]});break}case"playerStats":{e.playerEntity.attributesLevel.attStr=n.str,e.playerEntity.attributesLevel.attVit=n.vit;break}}})})}save(e){return Ie(this,null,function*(){const t=[];if(e.identifiableQuery.with("ordersProgress").entities.forEach(a=>{t.push({type:"ordersProgress",id:a.id,progress:a.ordersProgress})}),e.ownedItemsQuery.entities.filter(a=>a.removing==null&&a.willRemoveDelay==null&&a.item.count>0).forEach(a=>{const o=e.entityByIdentifier.get(a.ownedBy);if(o==null||o.npc!=null)return;const l=a.transform;t.push({type:"item",id:a.id,itemCount:a.item.count,itemKey:a.item.key,ownedBy:a.ownedBy,transform:l!=null?{pos:[l.position.x,l.position.y,l.position.z],rot:{y:l.rotation.y},z:a.zone}:void 0})}),e.statsEntity&&t.push({type:"stats",stats:e.statsEntity.gameStatistics}),e.settingsEntity&&t.push({type:"settings",settings:e.settingsEntity.settings}),e.varsEntity&&t.push({type:"vars",vars:e.varsEntity.persistentVars}),e.tasks.forEach(a=>{t.push({type:"task",op:a.task.op,finished:!!a.taskDone})}),e.identifiableQuery.with("purchased").entities.forEach(a=>{a.achievement||t.push({type:"purchased",id:a.id})}),e.identifiableQuery.with("itemHolder").entities.forEach(a=>{t.push({type:"itemHolder",id:a.id,val:a.itemHolder.val})}),e.identifiableQuery.with("enabled").entities.forEach(a=>{a.dontSaveEnabled==null&&t.push({type:"enable",id:a.id})}),e.identifiableQuery.with("willRemoveDelay").entities.forEach(a=>{t.push({type:"willRemoveDelay",id:a.id,delay:a.willRemoveDelay})}),e.playerEntity.appearance){const a=e.playerEntity.appearance.parts.map(o=>[o[0],o[1],o[2].toHexString()]);t.push({type:"appearance",parts:a})}e.playerEntity.attributesLevel&&t.push({type:"playerStats",vit:e.playerEntity.attributesLevel.attVit||0,str:e.playerEntity.attributesLevel.attStr||0}),e.flag&&t.push({type:"flag",flag:e.flag});const r=JSON.stringify(t);this._lastSaved!==r&&(this._lastSaved=r,yield Za.save(ad,r))})}loadBig(e){return Ie(this,null,function*(){yield $N(e)})}saveBig(e){return Ie(this,null,function*(){yield JN(e)})}clear(){return Ie(this,null,function*(){yield Za.save(ad,JSON.stringify([])),yield Za.save(pm,JSON.stringify([]))})}}function Gg(s){let e=s;const t=[];for(;e.parent;)t.unshift(e),e=e.parent;return t}function t3(){return new s3(s=>s.f)}const wu={search(s,e,t,i={}){s.cleanDirty();const n=i.heuristic||wu.heuristics.manhattan,r=i.closest||!1,a=t3();let o=e;for(e.h=n(e,t),s.markDirty(e),a.push(e);a.size()>0;){const u=a.pop();if(u===t)return Gg(u);u.closed=!0;const h=s.neighbors(u);for(let d=0,f=h.length;d<f;++d){const p=h[d];if(!(p.closed||p.isWall())){var l=u.g+p.getCost(u),c=p.visited;(!c||l<p.g)&&(p.visited=!0,p.parent=u,p.h=p.h||n(p,t),p.g=l,p.f=p.g+p.h,s.markDirty(p),r&&(p.h<o.h||p.h===o.h&&p.g<o.g)&&(o=p),c?a.rescoreElement(p):a.push(p))}}}return r?Gg(o):[]},heuristics:{manhattan(s,e){var t=Math.abs(e.x-s.x),i=Math.abs(e.y-s.y);return t+i},diagonal(s,e){var t=1,i=Math.sqrt(2),n=Math.abs(e.x-s.x),r=Math.abs(e.y-s.y);return t*(n+r)+(i-2*t)*Math.min(n,r)}},cleanNode(s){s.f=0,s.g=0,s.h=0,s.visited=!1,s.closed=!1,s.parent=null}};class i3{constructor(e,t={}){X(this,"diagonal");X(this,"nodes",[]);X(this,"grid",[]);X(this,"dirtyNodes",[]);this.diagonal=!!t.diagonal;for(let i=0;i<e.length;i++){this.grid[i]=[];for(let n=0,r=e[i];n<r.length;n++){const a=new n3(i,n,r[n]);this.grid[i][n]=a,this.nodes.push(a)}}this.init()}init(){this.dirtyNodes=[];for(var e=0;e<this.nodes.length;e++)wu.cleanNode(this.nodes[e])}cleanDirty(){for(var e=0;e<this.dirtyNodes.length;e++)wu.cleanNode(this.dirtyNodes[e]);this.dirtyNodes=[]}markDirty(e){this.dirtyNodes.push(e)}neighbors(e){const t=[],i=e.x,n=e.y,r=this.grid;return r[i-1]&&r[i-1][n]&&t.push(r[i-1][n]),r[i+1]&&r[i+1][n]&&t.push(r[i+1][n]),r[i]&&r[i][n-1]&&t.push(r[i][n-1]),r[i]&&r[i][n+1]&&t.push(r[i][n+1]),this.diagonal&&(r[i-1]&&r[i-1][n-1]&&t.push(r[i-1][n-1]),r[i+1]&&r[i+1][n-1]&&t.push(r[i+1][n-1]),r[i-1]&&r[i-1][n+1]&&t.push(r[i-1][n+1]),r[i+1]&&r[i+1][n+1]&&t.push(r[i+1][n+1])),t}toString(){for(var e=[],t=this.grid,i=0;i<t.length;i++){for(var n=[],r=t[i],a=0;a<r.length;a++)n.push(r[a].weight);e.push(n.join(" "))}return e.join(`
`)}}class n3{constructor(e,t,i){X(this,"f",0);X(this,"g",0);X(this,"h",0);X(this,"visited",!1);X(this,"closed",!1);X(this,"parent",null);this.x=e,this.y=t,this.weight=i}toString(){return"["+this.x+" "+this.y+"]"}getCost(e){return e&&e.x!=this.x&&e.y!=this.y?this.weight*1.41421:this.weight}isWall(){return this.weight===0}}class s3{constructor(e){X(this,"content",[]);this.scoreFunction=e}push(e){this.content.push(e),this.sinkDown(this.content.length-1)}pop(){const e=this.content[0],t=this.content.pop();if(t==null)throw new Error;return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e}remove(e){const t=this.content.indexOf(e),i=this.content.pop();if(i==null)throw new Error;t!==this.content.length-1&&(this.content[t]=i,this.scoreFunction(i)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))}size(){return this.content.length}rescoreElement(e){this.sinkDown(this.content.indexOf(e))}sinkDown(e){const t=this.content[e];for(;e>0;){const i=(e+1>>1)-1,n=this.content[i];if(this.scoreFunction(t)<this.scoreFunction(n))this.content[i]=t,this.content[e]=n,e=i;else break}}bubbleUp(e){const t=this.content.length,i=this.content[e],n=this.scoreFunction(i);for(;;){const r=e+1<<1,a=r-1;let o=null,l;if(a<t){const c=this.content[a];l=this.scoreFunction(c),l<n&&(o=a)}if(r<t){const c=this.content[r];this.scoreFunction(c)<(o===null?n:l)&&(o=r)}if(o!==null)this.content[e]=this.content[o],this.content[o]=i,e=o;else break}}}function r3({xOffset:s=0,zOffset:e=0,width:t,height:i}){return{width:t,height:i,xOffset:s,zOffset:e}}function xv(s){const e=[];for(let o=0;o<s.width;o++){e[o]=[];for(let l=0;l<s.height;l++)e[o][l]=1}const t=new i3(e,{diagonal:!0});function i(o){let{x:l,z:c}=o;l-=s.xOffset,c-=s.zOffset,l+=.5,c+=.5;const u=Math.floor(l),h=Math.floor(c);return[u,h]}function n(o){return new g(s.xOffset+o[0],0,s.zOffset+o[1])}const r=(o,l)=>{const c=t.grid[o];if(c!=null)return c[l]};function a(o,l){return o*s.height+l}return{mapInfo:s,graph:t,v3ToIndex:i,indexToV3:n,search:(o,l,c)=>{const u=i(o),h=i(l),d=t.grid[u[0]][u[1]],f=t.grid[h[0]][h[1]],p=wu.search(t,d,f,c);return[n(u),...p.map(m=>n([m.x,m.y]))]},getNode:r,findNode:o=>{const l=i(o);return r(l[0],l[1])},generateString:()=>{const o=new Array(s.height*s.width);return t.grid.forEach(l=>{o.push(...l.map(c=>c.weight))}),o.join("")},parseString:o=>{t.grid.forEach((l,c)=>{l.forEach((u,h)=>{t.grid[c][h].weight=o[a(c,h)]==="0"?0:1})})},idToIndex:o=>{const l=Math.floor(o/s.height),c=o%s.height;return[l,c]},indexToId:a,applyOpenedPatch:o=>{o.forEach(l=>{const c=Math.floor(l/s.height),u=l%s.height,h=t.grid[c];if(h==null)return;const d=h[u];d!=null&&(d.weight=1)})},applyClosedPatch:o=>{o.forEach(l=>{const c=Math.floor(l/s.height),u=l%s.height,h=t.grid[c];if(h==null)return;const d=h[u];d!=null&&(d.weight=0)})}}}const Mv=""+new URL("emoji_sleep-a5a59b4e.png",import.meta.url).href,zg=120;class No extends vv{constructor(e,t){super(),this.npcEntity=e,this.world=t;const i=new Qs,n=new Qs,r=new Qs,a=new Qs;i.transitions.push({decision:new Kf(.1),nextState:n}),i.actions.push({onEnter:()=>{const o=this.currentGoal;switch(o.type){case"returnToInitial":{this.npcEntity.npcInitialPosition!=null&&(Cn(t,this.npcEntity,this.npcEntity.npcInitialPosition),Rs(t,this.npcEntity,1));break}case"consumeDurability":{this.npcEntity.durability!=null&&this.npcEntity.attributes!=null&&(dm(t)||cv(t,this.npcEntity,o.amount));break}case"sleeping":{$2(this.world,this.npcEntity)&&this.npcEntity.npcSleepPosition&&(Cn(t,this.npcEntity,this.npcEntity.npcSleepPosition),ov(t,this.npcEntity),Rs(t,this.npcEntity,zg),lv(t,this.npcEntity),Br(t,this.npcEntity,Mv,zg));break}case"supplying":{if(!this.isProducerReady(o.target))break;const l=o.source;if(l&&l.unlocked==null)break;const c=o.target.itemProducer.inputItemType;if(c!=null){if(this.calculateFreeSpaceInProducer(o.target)<1)break;const h=this.maxNpcCapacity;if(l){const d=l.itemProducer!=null?$.nextV3InRect(l.itemProducer.outputArea):l.transform.position;Cn(t,this.npcEntity,d),Uf(t,this.npcEntity,l.id,this.npcEntity.id,c,!0,h),Rs(t,this.npcEntity,.5)}else if(this.getNpcItemCount(c)<1)break;Cn(t,this.npcEntity,o.target.transform.position),Uf(t,this.npcEntity,this.npcEntity.id,o.target.id,c,!0,h),Rs(t,this.npcEntity,.5)}break}case"checkForWakeUp":{const l=t.npcsWithTasksQuery.with("npcSleeping").entities[0];if(l!=null){let c=!0;if(o.checkEffectId!=null){const u=t.entityByIdentifier.get(o.checkEffectId);c=!!u&&!!u.enabled}c&&Cn(t,this.npcEntity,l.transform.position)}Rs(t,this.npcEntity,.5);break}case"chopping":{const l=this.getNpcItemCount("iLog"),c=this.maxNpcCapacity;if(l>=c)break;const u=o.radius,h=this.npcEntity.transform.position,d=t.treesQuery.entities.filter(p=>p.zone===e.zone&&p.durability>0&&p.model.visual!=null).map(p=>({dist:g.Distance(h,p.model.visual.model.absolutePosition),treeEntity:p}));d.sort((p,m)=>p.dist-m.dist);const f=d[0];if(f&&f.dist<=u){const p=f.treeEntity,m=p.model.visual.model.absolutePosition.clone(),_=m.subtract(h).normalize();m.subtractInPlace(_.scaleInPlace(.4)),Cn(t,this.npcEntity,m),XP(t,this.npcEntity,p),Rs(t,this.npcEntity,.3)}else Rs(t,this.npcEntity,.5);break}}}}),n.transitions.push({decision:{check:()=>e.npcTasksList.length===0},nextState:r},{decision:new Kf(1),nextState:a}),r.transitions.push({decision:Qf,nextState:i}),r.actions.push({onEnter:()=>{const o=this.currentGoal;let l=0;for(;l<this.goals.length-1;l++)this.goals[l]=this.goals[l+1];this.goals[l]=o,t.bus.onNpcGoalChanged.notifyObservers({npcEntity:this.npcEntity})}}),a.transitions.push({decision:Qf,nextState:n}),a.actions.push({onEnter:()=>{const o=this.currentTask;if(o!=null)switch(o.type){case"transferItem":{const c=o.fromOwnerId===this.npcEntity.id;if((o.timeFromLastTransferedItem!=null?o.timeFromLastTransferedItem:o.activeDuration!=null?o.activeDuration:0)>3){const h=o.count-(o.transfered||0);o.transfered=o.count,c&&h>0&&GP(t,o.fromOwnerId,o.item,h)}break}}}}),this.changeState(i)}get maxNpcCapacity(){return this.npcEntity.attributes.attInventoryTotalCapacity||0}get currentTask(){return this.npcEntity.npcTasksList[0]}get currentGoal(){return this.goals[0]}get goals(){return this.npcEntity.npcGoals}get npcItems(){return this.getOwnedItems(this.npcEntity)}getOwnedItems(e){return this.world.ownedItemsQuery.entities.filter(t=>t.ownedBy===e.id)}getItemCount(e,t){return this.getOwnedItems(e).filter(i=>i.item.key===t).reduce((i,n)=>i+n.item.count,0)}getNpcItemCount(e){return this.getItemCount(this.npcEntity,e)}isProducerReady(e){return e.purchased!=null&&e.unlocked!=null}calculateFreeSpaceInProducer(e){const t=e.attributes.attInventoryTotalCapacity;if(t==null)return 0;const i=e.itemProducer.inputItemType;if(i==null)return 0;const n=this.getItemCount(e,i);return t-n}}const a3={achiCoin1:{key:"achiCoin1",icon:"iCoin",max:50,lvl:1,award:2},achiCoin2:{key:"achiCoin2",icon:"iCoin",max:100,lvl:2,award:5},achiCoin3:{key:"achiCoin3",icon:"iCoin",max:250,lvl:3,award:7},achiCoin4:{key:"achiCoin4",icon:"iCoin",max:500,lvl:4,award:10},achiCoin5:{key:"achiCoin5",icon:"iCoin",max:1e3,lvl:5,award:25},achiCoin6:{key:"achiCoin6",icon:"iCoin",max:3e3,lvl:6,award:50},achiCoin7:{key:"achiCoin7",icon:"iCoin",max:1e4,lvl:7,award:100},achiCoin8:{key:"achiCoin8",icon:"iCoin",max:5e4,lvl:8,award:200},achiCoin9:{key:"achiCoin9",icon:"iCoin",max:1e5,lvl:9,award:500},achiLog1:{key:"achiLog1",icon:"iLog",max:10,lvl:1,award:2},achiLog2:{key:"achiLog2",icon:"iLog",max:25,lvl:2,award:5},achiLog3:{key:"achiLog3",icon:"iLog",max:50,lvl:3,award:7},achiLog4:{key:"achiLog4",icon:"iLog",max:100,lvl:4,award:10},achiLog5:{key:"achiLog5",icon:"iLog",max:250,lvl:5,award:25},achiLog6:{key:"achiLog6",icon:"iLog",max:500,lvl:6,award:50},achiLog7:{key:"achiLog7",icon:"iLog",max:1e3,lvl:7,award:100},achiLog8:{key:"achiLog8",icon:"iLog",max:5e3,lvl:8,award:200},achiLog9:{key:"achiLog9",icon:"iLog",max:1e4,lvl:9,award:500},achiPlank1:{key:"achiPlank1",icon:"iPlank",max:20,lvl:1,award:2},achiPlank2:{key:"achiPlank2",icon:"iPlank",max:40,lvl:2,award:5},achiPlank3:{key:"achiPlank3",icon:"iPlank",max:75,lvl:3,award:7},achiPlank4:{key:"achiPlank4",icon:"iPlank",max:150,lvl:4,award:10},achiPlank5:{key:"achiPlank5",icon:"iPlank",max:250,lvl:5,award:25},achiPlank6:{key:"achiPlank6",icon:"iPlank",max:500,lvl:6,award:50},achiPlank7:{key:"achiPlank7",icon:"iPlank",max:1e3,lvl:7,award:100},achiPlank8:{key:"achiPlank8",icon:"iPlank",max:5e3,lvl:8,award:200},achiPlank9:{key:"achiPlank9",icon:"iPlank",max:1e4,lvl:9,award:500},achiWheat1:{key:"achiWheat1",icon:"iWheat",max:20,lvl:1,award:2},achiWheat2:{key:"achiWheat2",icon:"iWheat",max:40,lvl:2,award:5},achiWheat3:{key:"achiWheat3",icon:"iWheat",max:75,lvl:3,award:7},achiWheat4:{key:"achiWheat4",icon:"iWheat",max:150,lvl:4,award:10},achiWheat5:{key:"achiWheat5",icon:"iWheat",max:250,lvl:5,award:25},achiWheat6:{key:"achiWheat6",icon:"iWheat",max:500,lvl:6,award:50},achiWheat7:{key:"achiWheat7",icon:"iWheat",max:1e3,lvl:7,award:100},achiWheat8:{key:"achiWheat8",icon:"iWheat",max:5e3,lvl:8,award:200},achiWheat9:{key:"achiWheat9",icon:"iWheat",max:1e4,lvl:9,award:500},achiFlour1:{key:"achiFlour1",icon:"iFlour",max:20,lvl:1,award:2},achiFlour2:{key:"achiFlour2",icon:"iFlour",max:40,lvl:2,award:5},achiFlour3:{key:"achiFlour3",icon:"iFlour",max:75,lvl:3,award:7},achiFlour4:{key:"achiFlour4",icon:"iFlour",max:150,lvl:4,award:10},achiFlour5:{key:"achiFlour5",icon:"iFlour",max:250,lvl:5,award:25},achiFlour6:{key:"achiFlour6",icon:"iFlour",max:500,lvl:6,award:50},achiFlour7:{key:"achiFlour7",icon:"iFlour",max:1e3,lvl:7,award:100},achiFlour8:{key:"achiFlour8",icon:"iFlour",max:5e3,lvl:8,award:200},achiFlour9:{key:"achiFlour9",icon:"iFlour",max:1e4,lvl:9,award:500},achiBread1:{key:"achiBread1",icon:"iBread",max:20,lvl:1,award:2},achiBread2:{key:"achiBread2",icon:"iBread",max:40,lvl:2,award:5},achiBread3:{key:"achiBread3",icon:"iBread",max:75,lvl:3,award:7},achiBread4:{key:"achiBread4",icon:"iBread",max:150,lvl:4,award:10},achiBread5:{key:"achiBread5",icon:"iBread",max:250,lvl:5,award:25},achiBread6:{key:"achiBread6",icon:"iBread",max:500,lvl:6,award:50},achiBread7:{key:"achiBread7",icon:"iBread",max:1e3,lvl:7,award:100},achiBread8:{key:"achiBread8",icon:"iBread",max:5e3,lvl:8,award:200},achiBread9:{key:"achiBread9",icon:"iBread",max:1e4,lvl:9,award:500},achiApple1:{key:"achiApple1",icon:"iApple",max:20,lvl:1,award:2},achiApple2:{key:"achiApple2",icon:"iApple",max:40,lvl:2,award:5},achiApple3:{key:"achiApple3",icon:"iApple",max:75,lvl:3,award:7},achiApple4:{key:"achiApple4",icon:"iApple",max:150,lvl:4,award:10},achiApple5:{key:"achiApple5",icon:"iApple",max:250,lvl:5,award:25},achiApple6:{key:"achiApple6",icon:"iApple",max:500,lvl:6,award:50},achiApple7:{key:"achiApple7",icon:"iApple",max:1e3,lvl:7,award:100},achiApple8:{key:"achiApple8",icon:"iApple",max:5e3,lvl:8,award:200},achiApple9:{key:"achiApple9",icon:"iApple",max:1e4,lvl:9,award:500},achiAleBarrel1:{key:"achiAleBarrel1",icon:"iAleBarrel",max:20,lvl:1,award:2},achiAleBarrel2:{key:"achiAleBarrel2",icon:"iAleBarrel",max:40,lvl:2,award:5},achiAleBarrel3:{key:"achiAleBarrel3",icon:"iAleBarrel",max:75,lvl:3,award:7},achiAleBarrel4:{key:"achiAleBarrel4",icon:"iAleBarrel",max:150,lvl:4,award:10},achiAleBarrel5:{key:"achiAleBarrel5",icon:"iAleBarrel",max:250,lvl:5,award:25},achiAleBarrel6:{key:"achiAleBarrel6",icon:"iAleBarrel",max:500,lvl:6,award:50},achiAleBarrel7:{key:"achiAleBarrel7",icon:"iAleBarrel",max:1e3,lvl:7,award:100},achiAleBarrel8:{key:"achiAleBarrel8",icon:"iAleBarrel",max:5e3,lvl:8,award:200},achiAleBarrel9:{key:"achiAleBarrel9",icon:"iAleBarrel",max:1e4,lvl:9,award:500},achiIron1:{key:"achiIron1",icon:"iIron",max:20,lvl:1,award:2},achiIron2:{key:"achiIron2",icon:"iIron",max:40,lvl:2,award:5},achiIron3:{key:"achiIron3",icon:"iIron",max:75,lvl:3,award:7},achiIron4:{key:"achiIron4",icon:"iIron",max:150,lvl:4,award:10},achiIron5:{key:"achiIron5",icon:"iIron",max:250,lvl:5,award:25},achiIron6:{key:"achiIron6",icon:"iIron",max:500,lvl:6,award:50},achiIron7:{key:"achiIron7",icon:"iIron",max:1e3,lvl:7,award:100},achiIron8:{key:"achiIron8",icon:"iIron",max:5e3,lvl:8,award:200},achiIron9:{key:"achiIron9",icon:"iIron",max:1e4,lvl:9,award:500},achiBook1:{key:"achiBook1",icon:"iBook",max:20,lvl:1,award:2},achiBook2:{key:"achiBook2",icon:"iBook",max:40,lvl:2,award:5},achiBook3:{key:"achiBook3",icon:"iBook",max:75,lvl:3,award:7},achiBook4:{key:"achiBook4",icon:"iBook",max:150,lvl:4,award:10},achiBook5:{key:"achiBook5",icon:"iBook",max:250,lvl:5,award:25},achiBook6:{key:"achiBook6",icon:"iBook",max:500,lvl:6,award:50},achiBook7:{key:"achiBook7",icon:"iBook",max:1e3,lvl:7,award:100},achiBook8:{key:"achiBook8",icon:"iBook",max:5e3,lvl:8,award:200},achiBook9:{key:"achiBook9",icon:"iBook",max:1e4,lvl:9,award:500},achiCorn1:{key:"achiCorn1",icon:"iCorn",max:20,lvl:1,award:2},achiCorn2:{key:"achiCorn2",icon:"iCorn",max:40,lvl:2,award:5},achiCorn3:{key:"achiCorn3",icon:"iCorn",max:75,lvl:3,award:7},achiCorn4:{key:"achiCorn4",icon:"iCorn",max:150,lvl:4,award:10},achiCorn5:{key:"achiCorn5",icon:"iCorn",max:250,lvl:5,award:25},achiCorn6:{key:"achiCorn6",icon:"iCorn",max:500,lvl:6,award:50},achiCorn7:{key:"achiCorn7",icon:"iCorn",max:1e3,lvl:7,award:100},achiCorn8:{key:"achiCorn8",icon:"iCorn",max:5e3,lvl:8,award:200},achiCorn9:{key:"achiCorn9",icon:"iCorn",max:1e4,lvl:9,award:500},achiStrength1:{key:"achiStrength1",icon:"iStrength",max:5,lvl:1,award:2},achiStrength2:{key:"achiStrength2",icon:"iStrength",max:15,lvl:2,award:5},achiStrength3:{key:"achiStrength3",icon:"iStrength",max:30,lvl:3,award:7},achiStrength4:{key:"achiStrength4",icon:"iStrength",max:50,lvl:4,award:10},achiStrength5:{key:"achiStrength5",icon:"iStrength",max:75,lvl:5,award:25},achiStrength6:{key:"achiStrength6",icon:"iStrength",max:100,lvl:6,award:50},achiStrength7:{key:"achiStrength7",icon:"iStrength",max:130,lvl:7,award:100},achiStrength8:{key:"achiStrength8",icon:"iStrength",max:150,lvl:8,award:200},achiStrength9:{key:"achiStrength9",icon:"iStrength",max:200,lvl:9,award:500},achiCrystal1:{key:"achiCrystal1",icon:"iCrystal",max:1,lvl:1,award:2},achiCrystal2:{key:"achiCrystal2",icon:"iCrystal",max:5,lvl:2,award:5},achiCrystal3:{key:"achiCrystal3",icon:"iCrystal",max:10,lvl:3,award:7},achiCrystal4:{key:"achiCrystal4",icon:"iCrystal",max:25,lvl:4,award:10},achiCrystal5:{key:"achiCrystal5",icon:"iCrystal",max:50,lvl:5,award:25},achiCrystal6:{key:"achiCrystal6",icon:"iCrystal",max:75,lvl:6,award:50},achiCrystal7:{key:"achiCrystal7",icon:"iCrystal",max:100,lvl:7,award:100},achiCrystal8:{key:"achiCrystal8",icon:"iCrystal",max:150,lvl:8,award:200},achiCrystal9:{key:"achiCrystal9",icon:"iCrystal",max:200,lvl:9,award:500},achiGem1:{key:"achiGem1",icon:"iGem",max:1,lvl:1,award:2},achiGem2:{key:"achiGem2",icon:"iGem",max:5,lvl:2,award:5},achiGem3:{key:"achiGem3",icon:"iGem",max:10,lvl:3,award:7},achiGem4:{key:"achiGem4",icon:"iGem",max:25,lvl:4,award:10},achiGem5:{key:"achiGem5",icon:"iGem",max:50,lvl:5,award:25},achiGem6:{key:"achiGem6",icon:"iGem",max:75,lvl:6,award:50},achiGem7:{key:"achiGem7",icon:"iGem",max:100,lvl:7,award:100},achiGem8:{key:"achiGem8",icon:"iGem",max:150,lvl:8,award:200},achiGem9:{key:"achiGem9",icon:"iGem",max:200,lvl:9,award:500}},o3=["achiCoin1","achiCoin2","achiCoin3","achiCoin4","achiCoin5","achiCoin6","achiCoin7","achiCoin8","achiCoin9","achiLog1","achiLog2","achiLog3","achiLog4","achiLog5","achiLog6","achiLog7","achiLog8","achiLog9","achiPlank1","achiPlank2","achiPlank3","achiPlank4","achiPlank5","achiPlank6","achiPlank7","achiPlank8","achiPlank9","achiWheat1","achiWheat2","achiWheat3","achiWheat4","achiWheat5","achiWheat6","achiWheat7","achiWheat8","achiWheat9","achiFlour1","achiFlour2","achiFlour3","achiFlour4","achiFlour5","achiFlour6","achiFlour7","achiFlour8","achiFlour9","achiBread1","achiBread2","achiBread3","achiBread4","achiBread5","achiBread6","achiBread7","achiBread8","achiBread9","achiApple1","achiApple2","achiApple3","achiApple4","achiApple5","achiApple6","achiApple7","achiApple8","achiApple9","achiAleBarrel1","achiAleBarrel2","achiAleBarrel3","achiAleBarrel4","achiAleBarrel5","achiAleBarrel6","achiAleBarrel7","achiAleBarrel8","achiAleBarrel9","achiIron1","achiIron2","achiIron3","achiIron4","achiIron5","achiIron6","achiIron7","achiIron8","achiIron9","achiBook1","achiBook2","achiBook3","achiBook4","achiBook5","achiBook6","achiBook7","achiBook8","achiBook9","achiCorn1","achiCorn2","achiCorn3","achiCorn4","achiCorn5","achiCorn6","achiCorn7","achiCorn8","achiCorn9","achiStrength1","achiStrength2","achiStrength3","achiStrength4","achiStrength5","achiStrength6","achiStrength7","achiStrength8","achiStrength9","achiCrystal1","achiCrystal2","achiCrystal3","achiCrystal4","achiCrystal5","achiCrystal6","achiCrystal7","achiCrystal8","achiCrystal9","achiGem1","achiGem2","achiGem3","achiGem4","achiGem5","achiGem6","achiGem7","achiGem8","achiGem9"],Hg=120;function ji(s,e){return{x:s,z:e,width:.001,height:.001}}const Ot=1.3;function Pv(s,...e){e.forEach(t=>{It(s,t)})}const dr=(s,e,t,i=0,n=!0,r={})=>s.add(Qt({id:$.id(),transform:{rotation:{y:i},position:t},zone:e,model:{key:"npc_worker"},appearance:{parts:[["Body",0,Ae.colorBrown600],["Eyes",0,Ae.eyesColorDark],["Mouth",0,Ae.eyesColorDark]],removed:[]},enabled:n?!0:void 0},r)),Wn=(s,e,t,i=0,n=!0,r={})=>dr(s,e,t,i,n,Qt({npc:!0,npcTasksList:[],npcEmptyBehaviour:!0,attributes:{},recalculateAttributes:!0,screenPosition:j.Zero(),screenPositionOffset:new g(0,2.5,0)},r)),Ht=s=>{let e=0;return(t,i)=>{const n=t.sceneEntity.scene;if(i.itemHolder==null){n.playAllBuildingAnim(t,s,1);return}e++;const r=e,a=i.itemHolder.val/i.itemHolder.max;Te(200).then(()=>{r===e&&i.enabled&&n.playAllBuildingAnim(t,s,a)})}};function l3(s){switch(s){case"pShip":case"pMarket":case"pBaker":case"pWinery":case"pWall":case"pPub":return!0}return!1}const nt=s=>e=>{if(s.purchased!=null)return;const i=e.playerEntity.transform.position;It(e,s),um(e,s,i),s.id&&l3(s.id)&&Ei.happytime(),Te(300).then(()=>vt(e,ut.success))},xt=s=>e=>{e.sceneEntity.scene.playAllBuildingAnim(e,s,1)};function gt(s){return e=>e.addComponent(s,"removing",!0)}function pt(s){return e=>It(e,s)}function c3(s){const e=tc.Producers[s],t={};if(e==null)throw new Error("no config");return e.inputCapacity!=null&&(t.attInventoryBaseCapacity=e.inputCapacity),e.outputCapacity!=null&&(t.attBaseOutputCapacity=e.outputCapacity),e.speed!=null&&(t.attBaseProducingSpeed=e.speed),e.durability!=null&&(t.attBaseMaxDurability=e.durability),t}function u3(s){const e=tc.Producers[s];if(e==null)throw new Error("no producer data!");return{item:e.unlockItem,count:e.unlockAmount}}function We(s){return{baseAttributes:c3(s),unlock:u3(s)}}function qr(s){return{spots:s,pending:[],inQueue:[],inQueuePositions:[],gainingPositionMode:"inOrder",exitCondition:(e,t)=>t.usable!=null&&t.usedBy==null}}function ke(s,e=0,t=0,i=0){return s.transform.position.clone().addInPlaceFromFloats(e,t,i)}function ct(s,e,t){return t.y=.1,s.add({id:$.id(),transform:{rotation:{y:0},position:t},bonusResourceSpawnPoint:!0,ownedBy:e})}function Je(s,e){return{conditions:[s],onEnter:[e]}}function Bt({world:s,zone:e,mapInfo:t,id:i,width:n,height:r,open:a=!1}){const o=[],l=[],c=a?o:l;for(let u=0;u<n;u++)for(let h=0;h<r;h++)c.push(i+u*t.height+h);return s.add({zone:e,gridMapPatch:{opened:o,closed:l}})}function cc(s,e,t){s.bus.onProducerOutputProduced.add(r=>{if(r.id!==e.id||t.durability==null||dm(s))return;const a=e.attributes.attInventoryTotalCapacity||0,o=a*3,l=a*4,c=t.attributes.attTotalMaxDurability||0;if(!c)return;let u=c/$.nextInt(o,l+1);cv(s,t,u),!(t.durability>0)&&(ov(s,t),Rs(s,t,Hg),lv(s,t),Br(s,t,Mv,Hg))})}const h3=s=>{const e="zVillage",t="pHome",i=We(t),n=s.add({id:t,home:!0,zone:e,attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:new g(113.5,0,124.7),rotation:{y:0}},screenPosition:j.Zero(),screenPositionOffset:new g(0,2,0),onUnlock:[xt(t)]}),r=s.add({id:n.id+"Area",zone:e,transform:{position:ke(n,1,0,0),rotation:{y:0},scaling:g.One()},interactiveArea:{radius:Ot,target:n},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(n)],onValueChanged:[]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});return n.onUnlock.push(gt(r)),n.onUnlock.push(pt(Bt({world:s,zone:e,mapInfo:s.mapInfo,id:131,width:3,height:4}))),mm(s,"pSawmill","zHome"),{entity:n,area:r}},d3=s=>{const e="zVillage",t="pLaboratory",i=We(t),n=new g(147,0,149.3),r=s.add({id:t,zone:e,laboratory:!0,attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},itemProducer:{inputItemType:"iCoin",outputItemType:"iBook",outputItemAmountRate:.01,minInputItemsPerStep:i.baseAttributes.attInventoryBaseCapacity,stackableInput:!0,fullPerStep:!0,nextStepAt:0,outputArea:ji(n.x-1,n.z+1)},screenPosition:j.Zero(),screenPositionOffset:new g(0,1.5,0),onUnlock:[xt(t)]}),a=s.add({id:r.id+"Area",zone:e,transform:{position:ke(r,0,0,-.5),rotation:{y:0}},interactiveArea:{radius:Ot,target:r},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(r)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)}),o=Bi(s,a,e);ct(s,r.id,ke(a,2,0,-.5)),r.onUnlock.push(pt(Bt({world:s,zone:e,mapInfo:s.mapInfo,id:1278,width:4,height:2})));const l=n.clone().addInPlaceFromFloats(-1,.05,1),c=()=>({y:$.nextFloor(-.2,.2)});s.add({id:r.id+"_output_shelf",zone:e,transform:{rotation:{y:0},position:l},outputShelf:{slots:[{rot:c(),pos:l.clone().addInPlaceFromFloats(0,.1,0)},{rot:c(),pos:l.clone().addInPlaceFromFloats(0,.3,0)},{rot:c(),pos:l.clone().addInPlaceFromFloats(0,.5,0)},{rot:c(),pos:l.clone().addInPlaceFromFloats(0,.7,0)},{rot:c(),pos:l.clone().addInPlaceFromFloats(0,.9,0)},{rot:c(),pos:l.clone().addInPlaceFromFloats(0,.11,0)},{rot:c(),pos:l.clone().addInPlaceFromFloats(0,.13,0)},{rot:c(),pos:l.clone().addInPlaceFromFloats(0,.15,0)},{rot:c(),pos:l.clone().addInPlaceFromFloats(0,.17,0)},{rot:c(),pos:l.clone().addInPlaceFromFloats(0,.19,0)}]},ownedBy:r.id});const u=()=>{!!r.itemProducer.willProduceAmount?s.removeComponent(o,"enabled"):It(s,o)};return s.bus.onProducerOutputProduced.add(h=>{h.id===r.id&&u()}),s.bus.onProducerItemsUpdated.add(h=>{h.id===r.id&&u()}),r.onUnlock.push(()=>u()),{entity:r,area:a,areaVisualEntity:o}},f3=s=>{const e="zVillage",t="pScientistNpc",i=We(t),n=new g(146.5,0,149),r=dr(s,e,n.clone(),Math.PI*.9,!1,{id:t,scientist:!0,attributes:Qt({},i.baseAttributes),movement:{speed:0,velocity:g.Zero()}});return r.appearance.parts.push(["Mustache",3,Ae.eyesColor]),r.appearance.parts.push(["Pant",1,Ae.colorLeather700]),r.appearance.parts.push(["Hair",3,Ae.eyesColor]),s.bus.onEntityUnlocked.add(a=>{a.id==="pLaboratory"&&It(s,r)}),s.bus.onPurchased.add(a=>{a.entity.laboratory&&um(s,r)}),{npc:r}},p3=s=>{const e="zVillage",t="pSawmill",i=We(t),n=new g(131,0,126),r=new g(133.3,0,122),a="pSawmillWorkerNpc",o=Wn(s,e,new g(n.x,.05,n.z),Math.PI*.5,!1,{id:a,sawmillWorker:!0,purchased:!0,unlocked:!0,attributes:Qt({},We(a).baseAttributes)});o.appearance.parts.push(["Mustache",3,Ae.eyesColorDark]),o.appearance.parts.push(["Pant",1,Ae.colorLeather700]),o.appearance.parts.push(["Hair",3,Ae.eyesColorDark]);const l=[],c=new g(131.8,0,123.4),u=ji(132.5,122.4),h=.6;for(let _=0;_<7;_++)l.push(c.clone()),c.addInPlaceFromFloats(0,0,h);const d=s.add({id:t,zone:e,sawmill:!0,usable:!0,queuable:qr(l),attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},itemProducer:{inputItemType:"iLog",outputItemType:"iPlank",outputItemAmountRate:1,nextStepAt:0,outputArea:ji(r.x,r.z),outputGainingArea:u,animated:!0},screenPosition:j.Zero(),screenPositionOffset:new g(0,1.5,0),onUnlock:[xt(t)],connectedWorker:o}),f=s.add({id:d.id+"Area",zone:e,transform:{position:ke(d,1,0,0),rotation:{y:0}},interactiveArea:{radius:Ot,target:d},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(d)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)}),p=()=>({y:$.nextFloor(-.2,.2)});s.add({id:d.id+"_output_shelf",zone:e,transform:{rotation:{y:0},position:r},outputShelf:{slots:[{rot:p(),pos:r.clone().addInPlaceFromFloats(0,.1,0)},{rot:p(),pos:r.clone().addInPlaceFromFloats(0,.3,0)},{rot:p(),pos:r.clone().addInPlaceFromFloats(0,.5,0)},{rot:p(),pos:r.clone().addInPlaceFromFloats(0,.7,0)},{rot:p(),pos:r.clone().addInPlaceFromFloats(0,.9,0)},{rot:p(),pos:r.clone().addInPlaceFromFloats(0,.11,0)},{rot:p(),pos:r.clone().addInPlaceFromFloats(0,.13,0)},{rot:p(),pos:r.clone().addInPlaceFromFloats(0,.15,0)}]},ownedBy:d.id});const m=Bi(s,f,e);return d.onUnlock.push(gt(m)),d.onUnlock.push(pt(o)),d.onUnlock.push(pt(Bt({world:s,zone:e,mapInfo:s.mapInfo,id:641,width:4,height:8})),pt(Bt({world:s,zone:e,mapInfo:s.mapInfo,id:769,width:3,height:2}))),cc(s,d,o),{entity:d,area:f,areaVisualEntity:m}},m3=(s,e,t)=>{const i="zVillage",n="pMarket",r=We(n),a=s.add({id:n,zone:i,market:!0,usable:!0,transform:{position:new g(e+3,0,t+11),rotation:{y:0}},attributes:r.baseAttributes,recalculateAttributes:!0,rect:{x:e+1.5,z:t+10.5,width:3,height:.5},onUnlock:[xt(n)]}),o=s.add({id:a.id+"Area",zone:i,transform:{position:ke(a,0,0,0),rotation:{y:0},scaling:g.One()},interactiveArea:{radius:Ot,target:a},itemHolder:{type:r.unlock.item,max:r.unlock.count,val:0,onMaxed:[nt(a)],onValueChanged:[]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});return a.onUnlock.push(gt(o)),a.onUnlock.push(pt(Bt({world:s,zone:i,mapInfo:s.mapInfo,id:430,width:6,height:4}))),{entity:a,area:o}},_3=s=>{const e="zVillage",t="pWell",i=We(t),n=new g(133.2,0,136.9),r=s.add({id:t,zone:e,well:!0,attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},itemProducer:{outputItemType:"iWater",outputItemAmountRate:1,nextStepAt:0,outputArea:ji(n.x+.2,n.z)},onUnlock:[xt(t)]}),a=s.add({id:r.id+"Area",zone:e,transform:{position:ke(r,.3,0,0),rotation:{y:0}},interactiveArea:{radius:Ot,target:r},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(r)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)});ct(s,r.id,ke(a,2,0,2));const o=Bi(s,a,e);r.onUnlock.push(gt(o));const l=Bt({world:s,zone:e,mapInfo:s.mapInfo,id:752,width:3,height:3});return r.onUnlock.push(pt(l)),{entity:r,area:a,areaVisualEntity:o}},g3=(s,e)=>{const t="zVillage",i="pLogNpc",n=We(i),r=Wn(s,t,new g(138,0,129),-Math.PI,!1,{id:i,canChop:!0,npcInitialPosition:new g(138,0,129),npcSleepPosition:new g(139,0,129),npcGoals:[{type:"returnToInitial"},{type:"chopping",radius:10},{type:"supplying",target:e},{type:"returnToInitial"},{type:"consumeDurability",amount:1},{type:"sleeping"}],hireableNpc:!0,attributes:Qt({attBaseMovementSpeed:1.5,attBasePickingDistance:.6,attBasePickingSpeed:600,attBaseChoppingSpeed:2e3},n.baseAttributes),movement:{speed:0,velocity:g.Zero()},stayingTime:0});r.appearance.parts.push(["Pant",0,Ae.colorLeather700]);const a=new No(r,s);s.addComponent(r,"npcFSM",a);const o=s.add({id:r.id+"Area",zone:t,transform:{position:r.transform.position.clone().addInPlaceFromFloats(0,0,-.5),rotation:{y:0},scaling:g.One()},interactiveArea:{radius:Ot,target:r},itemHolder:{type:n.unlock.item,max:n.unlock.count,val:0,onMaxed:[nt(r)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});return ct(s,r.id,ke(o,-2.5,0,1)),s.addComponent(r,"onUnlock",[gt(o)]),{npc:r,area:o}},E3=(s,e,t,i,n)=>{const r="zVillage",a="pWaterNpc",o=We(a),l=Wn(s,r,new g(131,0,134),Math.PI*.7,!1,{id:a,npcInitialPosition:new g(133,0,135),npcSleepPosition:new g(132,0,135),npcGoals:[{type:"returnToInitial"},{type:"supplying",source:e,target:t},{type:"supplying",source:e,target:i},{type:"supplying",source:e,target:n},{type:"returnToInitial"},{type:"consumeDurability",amount:1},{type:"sleeping"}],hireableNpc:!0,attributes:Qt({attBaseMovementSpeed:1.5,attBasePickingDistance:.6,attBasePickingSpeed:600},o.baseAttributes),movement:{speed:0,velocity:g.Zero()}});l.appearance.parts.push(["Pant",0,Ae.colorLeather700]);const c=new No(l,s);s.addComponent(l,"npcFSM",c);const u=s.add({id:l.id+"Area",zone:r,transform:{position:l.transform.position.clone().addInPlaceFromFloats(.4,0,0),rotation:{y:0},scaling:g.One()},interactiveArea:{radius:Ot,target:l},itemHolder:{type:o.unlock.item,max:o.unlock.count,val:0,onMaxed:[nt(l)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});return ct(s,l.id,ke(u,-2,0,-1.5)),s.addComponent(l,"onUnlock",[gt(u)]),{npc:l,area:u}},v3=s=>{const e="zVillage",t="pWheatGarden",i=We(t),n=new g(139,.1,132),r=[],a=new g(141.5,0,130),o=.6;for(let h=0;h<7;h++)r.push(a.clone()),a.addInPlaceFromFloats(-o,0,0);const l=s.add({id:t,zone:e,wheatGarden:!0,usable:!0,queuable:qr(r),attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},itemProducer:{inputItemType:"iWater",outputItemType:"iWheat",outputItemAmountRate:1,nextStepAt:0,outputArea:{x:n.x+3,z:n.z-2,width:.1,height:2},animated:!0},screenPosition:j.Zero(),screenPositionOffset:new g(0,1,0),onUnlock:[xt(t)]}),c=s.add({id:l.id+"Area",zone:e,transform:{position:l.transform.position.clone().addInPlaceFromFloats(0,0,0),rotation:{y:0}},interactiveArea:{radius:Ot+.5,target:l},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(l)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)});ct(s,l.id,ke(c,-2,0,-2));const u=Bi(s,c,e);return l.onUnlock.push(gt(u)),{entity:l,area:c,areaVisualEntity:u}},y3=s=>{const e="zVillage",t="pMill",i=We(t),n=new g(146.7,0,137),r="pMillWorkerNpc",a=Wn(s,e,new g(n.x,0,n.z),Math.PI,!1,{id:r,purchased:!0,unlocked:!0,attributes:Qt({},We(r).baseAttributes)});a.appearance.parts[0][2]=Ae.colorBrown800,a.appearance.parts.push(["Pant",1,Ae.colorLeather700]);const o=[],l=new g(144.1,0,136.4),c=ji(144,137.5),u=.6;for(let _=0;_<5;_++)o.push(l.clone()),l.addInPlaceFromFloats(_*.2,0,-u);const h=s.add({id:t,zone:e,mill:!0,usable:!0,queuable:qr(o),attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},itemProducer:{inputItemType:"iWheat",outputItemType:"iFlour",outputItemAmountRate:1,nextStepAt:0,outputArea:{x:n.x-1.8,z:n.z+1.1,width:.1,height:.1},outputGainingArea:c},screenPosition:j.Zero(),screenPositionOffset:new g(0,1,0),onUnlock:[xt(t)],connectedWorker:a}),d=s.add({id:h.id+"Area",zone:e,transform:{position:h.transform.position.clone().addInPlaceFromFloats(.3,0,-.7),rotation:{y:0}},interactiveArea:{radius:Ot,target:h},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(h)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)}),f=new g(n.x-1.8,.3,n.z+1.1);s.add({id:h.id+"_output_shelf",zone:e,transform:{rotation:{y:0},position:f},outputShelf:{slots:[{rot:{y:$.nextFloor(0,Math.PI)},pos:f.clone().addInPlaceFromFloats(0,0,0)},{rot:{y:$.nextFloor(0,Math.PI)},pos:f.clone().addInPlaceFromFloats(0,0,-.7)},{rot:{y:$.nextFloor(0,Math.PI)},pos:f.clone().addInPlaceFromFloats(.7,0,0)},{rot:{y:$.nextFloor(0,Math.PI)},pos:f.clone().addInPlaceFromFloats(.7,0,-.7)},{rot:{y:$.nextFloor(0,Math.PI)},pos:f.clone().addInPlaceFromFloats(.35,0,-.35)}]},ownedBy:h.id}),ct(s,h.id,ke(d,-2,0,-2));const p=Bi(s,d,e);h.onUnlock.push(gt(p)),h.onUnlock.push(pt(a));const m=Bt({world:s,zone:e,mapInfo:s.mapInfo,id:1233,width:2,height:3});return h.onUnlock.push(pt(m)),cc(s,h,a),{entity:h,area:d,areaVisualEntity:p}},A3=s=>{const e="zVillage",t="pBaker",i=We(t),n=new g(140,.15,143.4),r="pBakerWorkerNpc",a=Wn(s,e,new g(n.x,.3,n.z),Math.PI/2,!1,{id:r,purchased:!0,unlocked:!0,attributes:Qt({},We(r).baseAttributes)});s.removeComponent(a,"appearance"),s.removeComponent(a,"model");const o=ji(137.7,142),l=[],c=new g(136.5,0,142),u=.6;for(let v=0;v<7;v++)l.push(c.clone()),c.addInPlaceFromFloats(-u/Math.max(1,v/.9),0,v*.2);const h=s.add({id:t,zone:e,baker:!0,usable:!0,queuable:qr(l),attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},itemProducer:{inputItemType:"iFlour",outputItemType:"iBread",outputItemAmountRate:1,nextStepAt:0,outputArea:{x:n.x,z:n.z,width:.4,height:1},outputGainingArea:o},screenPosition:j.Zero(),screenPositionOffset:new g(0,1,0),onUnlock:[xt(t)],connectedWorker:a}),d=s.add({id:h.id+"Area",zone:e,transform:{position:h.transform.position.clone().addInPlaceFromFloats(.2,0,-.9),rotation:{y:0}},interactiveArea:{radius:Ot,target:h},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(h)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)}),f=.15,p=new g(n.x-2.5,.7,n.z-.7),m=()=>({y:Math.PI*.1});s.add({id:h.id+"_output_shelf",zone:e,transform:{rotation:{y:0},position:p},outputShelf:{slots:[{rot:m(),pos:p.clone().addInPlaceFromFloats(0,0,0)},{rot:m(),pos:p.clone().addInPlaceFromFloats(f,.01,0)},{rot:m(),pos:p.clone().addInPlaceFromFloats(f*2,.02,0)},{rot:m(),pos:p.clone().addInPlaceFromFloats(f*3,.03,0)},{rot:m(),pos:p.clone().addInPlaceFromFloats(f*4,.04,0)},{rot:m(),pos:p.clone().addInPlaceFromFloats(f*5,.05,0)},{rot:m(),pos:p.clone().addInPlaceFromFloats(f*6,.06,0)}]},ownedBy:h.id}),ct(s,h.id,ke(d,-2,0,-1.5));const _=Bi(s,d,e);h.onUnlock.push(gt(_)),h.onUnlock.push(pt(a));const E=Bt({world:s,zone:e,mapInfo:s.mapInfo,id:919,width:7,height:4});return h.onUnlock.push(pt(E)),cc(s,h,a),{entity:h,area:d,areaVisualEntity:_}},T3=s=>{const e="zVillage",t="pAppleGarden",i=We(t),n=new g(139,0,138),r=[],a=new g(n.x+1.3,0,n.z-1.6),o=ji(142,135.6),l=.6;for(let d=0;d<5;d++)r.push(a.clone()),a.addInPlaceFromFloats(-l,0,0);const c=s.add({id:t,zone:e,appleGarden:!0,usable:!0,queuable:qr(r),attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},itemProducer:{inputItemType:"iWater",outputItemType:"iApple",outputItemAmountRate:1,nextStepAt:0,outputArea:{x:n.x+3.3,z:n.z-1.5,width:.2,height:1.5},outputGainingArea:o},screenPosition:j.Zero(),screenPositionOffset:new g(0,1,0),onUnlock:[xt(t)]}),u=s.add({id:c.id+"Area",zone:e,transform:{position:c.transform.position.clone().addInPlaceFromFloats(0,.1,0),rotation:{y:0}},interactiveArea:{radius:Ot,target:c},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(c)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)});ct(s,c.id,ke(u,-2,0,-1.5));const h=Bi(s,u,e);return c.onUnlock.push(gt(h)),{entity:c,area:u,areaVisualEntity:h}},S3=s=>{const e="zVillage",t="pWinery",i=We(t),n=new g(133,.15,144),r="pWineryWorkerNpc",a=Wn(s,e,new g(n.x,.3,n.z),Math.PI/2,!1,{id:r,purchased:!0,unlocked:!0,attributes:Qt({},We(r).baseAttributes)});s.removeComponent(a,"appearance"),s.removeComponent(a,"model");const o=[],l=new g(n.x,.3,n.z-2.7),c=.7;for(let m=0;m<5;m++)o.push(l.clone()),l.addInPlaceFromFloats(-c,0,0);const u=s.add({id:t,zone:e,winery:!0,usable:!0,queuable:qr(o),attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},itemProducer:{inputItemType:"iApple",outputItemType:"iAleBarrel",outputItemAmountRate:1,nextStepAt:0,outputArea:{x:n.x-2,z:n.z-2,width:2,height:.1}},screenPosition:j.Zero(),screenPositionOffset:new g(0,1,0),onUnlock:[xt(t)],connectedWorker:a}),h=s.add({id:u.id+"Area",zone:e,transform:{position:u.transform.position.clone().addInPlaceFromFloats(.5,0,0),rotation:{y:0}},interactiveArea:{radius:Ot,target:u},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(u)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)}),d=new g(n.x-2,.1,n.z-2);s.add({id:u.id+"_output_shelf",zone:e,transform:{rotation:{y:0},position:d},outputShelf:{slots:[{rot:{y:$.nextFloor(0,Math.PI)},pos:d.clone().addInPlaceFromFloats(0,0,0)},{rot:{y:$.nextFloor(0,Math.PI)},pos:d.clone().addInPlaceFromFloats(.9,.1,.1)},{rot:{y:$.nextFloor(0,Math.PI)},pos:d.clone().addInPlaceFromFloats(.5,1,0)},{rot:{y:$.nextFloor(0,Math.PI)},pos:d.clone().addInPlaceFromFloats(1.8,0,.05)},{rot:{y:$.nextFloor(0,Math.PI)},pos:d.clone().addInPlaceFromFloats(1.5,1,0)},{rot:{y:$.nextFloor(0,Math.PI)},pos:d.clone().addInPlaceFromFloats(-.8,0,0)},{rot:{y:$.nextFloor(0,Math.PI)},pos:d.clone().addInPlaceFromFloats(-.4,1,-.1)},{rot:{y:$.nextFloor(0,Math.PI)},pos:d.clone().addInPlaceFromFloats(.1,0,-.9)}]},ownedBy:u.id}),ct(s,u.id,ke(h,-1.5,0,-2));const f=Bi(s,h,e);u.onUnlock.push(gt(f)),u.onUnlock.push(pt(a));const p=Bt({world:s,zone:e,mapInfo:s.mapInfo,id:759,width:3,height:3});return u.onUnlock.push(pt(p)),cc(s,u,a),{entity:u,area:h,areaVisualEntity:f}},C3=s=>{const e="zVillage",t="pPub",i=We(t),n=s.add({id:t,zone:e,pub:!0,attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:new g(114,0,133),rotation:{y:0}},itemProducer:{inputItemType:"iAleBarrel",outputItemType:"iCoin",outputItemAmountRate:8,nextStepAt:0,outputArea:{x:115,z:130,width:.1,height:1}},screenPosition:j.Zero(),screenPositionOffset:new g(0,2,0),onUnlock:[xt(t)]}),r=s.add({id:n.id+"Area",zone:e,transform:{position:n.transform.position.clone().addInPlaceFromFloats(1,0,0),rotation:{y:0}},interactiveArea:{radius:Ot,target:n},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(n)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)});ct(s,n.id,ke(r,1.5,0,2));const a=Bi(s,r,e);n.onUnlock.push(gt(a));const o=Bt({world:s,zone:e,mapInfo:s.mapInfo,id:75,width:5,height:5});return n.onUnlock.push(pt(o)),{entity:n,area:r,areaVisualEntity:a}},I3=s=>{const e="zVillage",t="pWall",i=We(t),n=new g(122,0,121),r=s.add({id:t,zone:e,wall:!0,attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},screenPosition:j.Zero(),screenPositionOffset:new g(0,2,0),onUnlock:[xt(t)]}),a=s.add({id:r.id+"Area",zone:e,transform:{position:ke(r,0,0,0),rotation:{y:0}},interactiveArea:{radius:Ot,target:r},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(r)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)});ct(s,r.id,ke(a,-.5,0,2.5));const o=Bi(s,a,e);return{entity:r,area:a,areaVisualEntity:o}},R3=s=>{const e="zVillage",t="pHunter",i=We(t),n=new g(121,0,124),r=dr(s,e,new g(n.x-1,0,n.z),Math.PI/2,!1);r.appearance.parts[0][2]=Ae.colorBrown300,r.appearance.parts.push(["Coat",1,Ae.colorLeather700],["Hair",5,Ae.colorLeather700]);const a=s.add({id:t,zone:e,hunter:!0,attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},itemProducer:{inputItemType:"iBread",outputItemType:"iCoin",outputItemAmountRate:5,nextStepAt:0,outputArea:ji(n.x,n.z+1)},screenPosition:j.Zero(),screenPositionOffset:new g(0,2,0),onUnlock:[()=>{}]}),o=s.add({id:a.id+"Area",zone:e,transform:{position:a.transform.position.clone().addInPlaceFromFloats(0,0,0),rotation:{y:0}},interactiveArea:{radius:Ot,target:a},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(a)],onValueChanged:[]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)});ct(s,a.id,ke(o,1.5,0,2));const l=Bi(s,o,e);return a.onUnlock.push(gt(l)),a.onUnlock.push(pt(r)),{entity:a,area:o,areaVisualEntity:l,npc:r}},b3=(s,e,t,i)=>{const n="zVillage",r="pMillerNpc",a=We(r),o=new g(148,0,134),l=Wn(s,n,o,Math.PI*1.5,!1,{id:r,npcInitialPosition:o.clone().addInPlaceFromFloats(-2,0,0),npcSleepPosition:o.clone().addInPlaceFromFloats(1,0,0),npcGoals:[{type:"returnToInitial"},{type:"supplying",source:t,target:e},{type:"supplying",source:e,target:i},{type:"returnToInitial"},{type:"consumeDurability",amount:1},{type:"sleeping"}],hireableNpc:!0,attributes:Qt({attBaseMovementSpeed:1.5,attBasePickingDistance:.6,attBasePickingSpeed:600},a.baseAttributes),movement:{speed:0,velocity:g.Zero()}});l.appearance.parts[0][2]=Ae.colorBrown800,l.appearance.parts.push(["Pant",0,Ae.colorBrown300]);const c=new No(l,s);s.addComponent(l,"npcFSM",c);const u=s.add({id:l.id+"Area",zone:n,transform:{position:l.transform.position.clone().addInPlaceFromFloats(-.5,0,0),rotation:{y:0},scaling:g.One()},interactiveArea:{radius:Ot,target:l},itemHolder:{type:a.unlock.item,max:a.unlock.count,val:0,onMaxed:[nt(l)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});return ct(s,l.id,ke(u,-2,0,-1.5)),s.addComponent(l,"onUnlock",[gt(u)]),{npc:l,area:u}},x3=(s,e,t)=>{const i="zVillage",n="pAppleNpc",r=We(n),a=new g(129,0,142),o=Wn(s,i,a,Math.PI*.5,!1,{id:n,npcInitialPosition:a.clone().addInPlaceFromFloats(1,0,-1),npcSleepPosition:a.clone().addInPlaceFromFloats(0,0,0),npcGoals:[{type:"returnToInitial"},{type:"supplying",source:e,target:t},{type:"returnToInitial"},{type:"consumeDurability",amount:1},{type:"sleeping"}],hireableNpc:!0,attributes:Qt({attBaseMovementSpeed:1.5,attBasePickingDistance:.6,attBasePickingSpeed:600},r.baseAttributes),movement:{speed:0,velocity:g.Zero()}});o.appearance.parts[0][2]=Ae.colorBrown300,o.appearance.parts.push(["Pant",0,Ae.colorLeather700]);const l=new No(o,s);s.addComponent(o,"npcFSM",l);const c=s.add({id:o.id+"Area",zone:i,transform:{position:o.transform.position.clone().addInPlaceFromFloats(.5,0,0),rotation:{y:0},scaling:g.One()},interactiveArea:{radius:Ot,target:o},itemHolder:{type:r.unlock.item,max:r.unlock.count,val:0,onMaxed:[nt(o)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});return ct(s,o.id,ke(c,.5,0,-2.5)),s.addComponent(o,"onUnlock",[gt(c)]),{npc:o,area:c}},M3=s=>{const e="zVillage",t="pDock",i=We(t),n=new g(156,0,142),r=s.add({id:t,zone:e,dock:!0,attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},screenPosition:j.Zero(),screenPositionOffset:new g(0,2,0),onUnlock:[xt(t)]}),a=s.add({id:r.id+"Area",zone:e,transform:{position:r.transform.position.clone().addInPlaceFromFloats(0,0,0),rotation:{y:0},scaling:g.One()},interactiveArea:{radius:Ot,target:r},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(r)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});ct(s,r.id,ke(a,-2.5,0,-1.5)),r.onUnlock.push(gt(a));const o=Bt({world:s,zone:e,mapInfo:s.mapInfo,id:1621,width:7,height:2,open:!0});return r.onUnlock.push(pt(o)),{entity:r,area:a}},P3=s=>{const e="zVillage",t="pFisherman",i=We(t),n=new g(152.5,0,145.5),r=Wn(s,e,new g(n.x,.1,n.z),Math.PI*.97,!1,{id:t+"Npc",attributes:{attBaseMovementSpeed:4.5},movement:{speed:0,velocity:g.Zero()},stayingTime:0,movingTime:0,purchased:!0,gridMap:s.npcGlobalGridMap});r.appearance.parts.push(["Mustache",2,Ae.eyesColorDark]),r.appearance.parts.push(["Pant",0,Ae.colorLeather700]),r.appearance.parts.push(["Weapon",1,Ae.colorLeather700]);const a=s.add({id:t,zone:e,fisherman:!0,attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},itemProducer:{inputItemType:"iFlour",outputItemType:"iCoin",outputItemAmountRate:4,nextStepAt:0,outputArea:{x:n.x-.25,z:n.z-1,width:1.5,height:.5}},screenPosition:j.Zero(),screenPositionOffset:new g(0,1.5,0),onUnlock:[xt(t)]}),o=s.add({id:a.id+"Area",zone:e,transform:{position:a.transform.position.clone().addInPlaceFromFloats(0,0,-1),rotation:{y:0}},interactiveArea:{radius:Ot,target:a},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(a)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)});ct(s,a.id,ke(o,-2,0,-1.5));const l=Bi(s,o,e);return a.onUnlock.push(gt(l)),a.onUnlock.push(pt(r)),a.onUnlock.push(pt(Bt({world:s,zone:e,mapInfo:s.mapInfo,id:1370,width:5,height:6}))),{entity:a,area:o,areaVisualEntity:l}},D3=s=>{const e="zVillage",t="pShip",i=We(t),n=new g(164,0,141.9),r=new g(164,0,141.9),a=dr(s,e,n.clone().addInPlaceFromFloats(0,0,0),Math.PI*1.5,!1,{id:t+"Npc"});a.appearance.parts.push(["Pant",1,Ae.colorLeather700]),a.appearance.parts.push(["Hair",3,Ae.colorBrown800]);const o=s.add({id:t,zone:e,ship:!0,attributes:i.baseAttributes,recalculateAttributes:!0,itemProducer:{inputItemType:"iAleBarrel",outputItemType:"iCoin",outputItemAmountRate:20,fullPerStep:!0,nextStepAt:0,outputArea:{x:r.x-4,z:r.z-.5,width:2,height:1}},transform:{position:r,rotation:{y:0}},screenPosition:j.Zero(),screenPositionOffset:new g(0,2,0),onUnlock:[(u,h)=>{xt(t)(u),Pv(u,a),o.transform.position.copyFrom(n),l.transform.position.copyFrom(o.transform.position.clone().addInPlaceFromFloats(-1,0,0)),c.transform.position.copyFrom(l.transform.position)}]}),l=s.add({id:o.id+"Area",zone:e,transform:{position:o.transform.position.clone().addInPlaceFromFloats(0,0,0),rotation:{y:0}},interactiveArea:{radius:Ot,target:o},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(o)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)});ct(s,o.id,ke(l,-3,0,0));const c=Bi(s,l,e);return o.onUnlock.push(gt(c)),{entity:o,area:l,areaVisualEntity:c,npcMerchant:a}},O3=s=>{const e="zVillage",t="pManagerNpc",i=We(t),n=new g(134,0,133),r=Wn(s,e,n,Math.PI*1,!1,{id:t,manager:!0,npcInitialPosition:n.clone(),npcGoals:[{type:"returnToInitial"},{type:"checkForWakeUp",checkEffectId:ws}],attributes:Qt({attBaseMovementSpeed:3},i.baseAttributes),gridMap:s.npcGlobalGridMap,movement:{speed:0,velocity:g.Zero()},purchased:!0});r.appearance.parts[0][2]=Ae.colorBrown700,r.appearance.parts.push(["Belt",0,Ae.bristleColorDark]),r.appearance.parts.push(["Hair",0,Ae.bristleColorDark]);const a=new No(r,s);s.addComponent(r,"npcFSM",a);const o=s.add({id:r.id+"Area",zone:e,dontSaveEnabled:!0,transform:{position:r.transform.position.clone().addInPlaceFromFloats(0,0,-.5),rotation:{y:0},scaling:g.One().scaleInPlace(.6)},interactiveArea:{radius:.6,target:r},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),managerActivation:{activationDuration:1.8},model:{key:"interactiveArea"}});s.bus.onInitBeforeSave.add(()=>{s.removeComponent(r,"enabled"),s.removeComponent(o,"enabled")}),s.bus.onEnabled.add(c=>{c.entity.id===ws&&s.removeComponent(o,"enabled")}),s.bus.onEntityDestroyed.add(c=>{c.entity.id===ws&&It(s,o)});const l=s.with("mill","purchased","unlocked");s.add({adviser:{suggestions:[Je(()=>l.entities.length>0,()=>{It(s,r),It(s,o)})]}})},w3=s=>{const e="zVillage",t="pThiefNpc",i=We(t),n=new g(130,100,132),r=Wn(s,e,n,Math.PI*1,!1,{id:t,thief:!0,attributes:Qt({},i.baseAttributes),movement:{speed:0,velocity:g.Zero()},gridMap:s.npcGlobalGridMap,unlocked:!0});return r.appearance.parts[0][2]=Ae.skinColorDanger,r.appearance.parts[1][2]=Ae.eyesColorDark,r.appearance.parts.push(["Jacket",0,Ae.eyesColorDark]),r.appearance.parts.push(["Belt",0,Ae.eyesColorDark]),{npc:r}},F3=(s,e,t)=>{const i="zVillage",n="pHut1",r=We(n),a=new g(117,0,145.5),o=a.clone().addInPlaceFromFloats(0,0,-.5),l=dr(s,i,o.clone(),Math.PI*1,!1,{id:n+"Npc",npc:!0,npcEmptyBehaviour:!0,npcTasksList:[],attributes:{attBaseMovementSpeed:1.5},recalculateAttributes:!0,movement:{speed:0,velocity:g.Zero()},gridMap:s.npcGlobalGridMap,purchased:!0});l.appearance.parts.push(["Pant",1,Ae.colorLeather700]),l.appearance.parts.push(["Hair",3,Ae.colorBrown800]);const c=new g(123,0,122),u=new g(125,0,127),h=new g(135,0,137),d=new g(116,0,126),f=new g(115,0,132.5),p=new g(162,0,142),m=()=>{const y=[c,u,h,d];return e.unlocked&&y.push(f),t.unlocked&&y.push(p),[{type:"waiting",delay:$.nextInt(5,10)},{type:"moveTo",pos:$.randomElement(y).clone()},{type:"waiting",delay:$.nextInt(2,5)},{type:"moveTo",pos:o.clone()}]};s.bus.onEnabled.add(y=>{y.entity===l&&(s.bus.onNpcTasksUpdated.add(A=>{A.npcEntity===l&&l.npcTasksList.length===0&&(l.npcTasksList.push(...m()),s.bus.onNpcTasksUpdated.notifyObservers({npcEntity:l}))}),l.npcTasksList.push(...m()),s.bus.onNpcTasksUpdated.notifyObservers({npcEntity:l}))});const _=s.add({id:n,zone:i,hut1:!0,attributes:r.baseAttributes,recalculateAttributes:!0,transform:{position:a,rotation:{y:0}},itemProducer:{outputItemType:"iCoin",outputItemAmountRate:1,nextStepAt:0,outputArea:{x:a.x-.5,z:a.z-1,width:1,height:.1}},onUnlock:[xt(n)]}),E=s.add({id:_.id+"Area",zone:i,transform:{position:_.transform.position.clone().addInPlaceFromFloats(0,0,0),rotation:{y:0},scaling:g.One()},interactiveArea:{radius:Ot,target:_},itemHolder:{type:r.unlock.item,max:r.unlock.count,val:0,onMaxed:[nt(_)],onValueChanged:[Ht(n)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});ct(s,_.id,ke(E,-2,0,-2)),_.onUnlock.push(gt(E));const v=Bt({world:s,zone:i,mapInfo:s.mapInfo,id:218,width:5,height:3});return _.onUnlock.push(pt(v)),_.onUnlock.push(pt(l)),{entity:_,area:E}},L3=(s,e,t)=>{const i="zVillage",n="pHut2",r=We(n),a=new g(123,0,145.5),o=a.clone().addInPlaceFromFloats(0,0,-.5),l=dr(s,i,o.clone(),Math.PI*1,!1,{id:n+"Npc",npc:!0,npcEmptyBehaviour:!0,npcTasksList:[],attributes:{attBaseMovementSpeed:1.5},recalculateAttributes:!0,movement:{speed:0,velocity:g.Zero()},gridMap:s.npcGlobalGridMap,purchased:!0});l.appearance.parts.push(["Pant",1,Ae.colorLeather700]),l.appearance.parts.push(["Hair",3,Ae.colorBrown800]);const c=new g(123,0,122),u=new g(125,0,127),h=new g(135,0,137),d=new g(116,0,126),f=new g(115,0,132.5),p=new g(162,0,142),m=()=>{const y=[c,u,h,d];return e.unlocked&&y.push(f),t.unlocked&&y.push(p),[{type:"waiting",delay:$.nextInt(5,10)},{type:"moveTo",pos:$.randomElement(y).clone()},{type:"waiting",delay:$.nextInt(2,5)},{type:"moveTo",pos:o.clone()}]};s.bus.onEnabled.add(y=>{y.entity===l&&(s.bus.onNpcTasksUpdated.add(A=>{A.npcEntity===l&&l.npcTasksList.length===0&&(l.npcTasksList.push(...m()),s.bus.onNpcTasksUpdated.notifyObservers({npcEntity:l}))}),l.npcTasksList.push(...m()),s.bus.onNpcTasksUpdated.notifyObservers({npcEntity:l}))});const _=s.add({id:n,zone:i,hut2:!0,attributes:r.baseAttributes,recalculateAttributes:!0,transform:{position:a,rotation:{y:0}},itemProducer:{outputItemType:"iCoin",outputItemAmountRate:1,nextStepAt:0,outputArea:{x:a.x-.5,z:a.z-1,width:1,height:.1}},onUnlock:[xt(n)]}),E=s.add({id:_.id+"Area",zone:i,transform:{position:_.transform.position.clone().addInPlaceFromFloats(0,0,0),rotation:{y:0},scaling:g.One()},interactiveArea:{radius:Ot,target:_},itemHolder:{type:r.unlock.item,max:r.unlock.count,val:0,onMaxed:[nt(_)],onValueChanged:[Ht(n)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});ct(s,_.id,ke(E,-2,0,-2)),_.onUnlock.push(gt(E));const v=Bt({world:s,zone:i,mapInfo:s.mapInfo,id:442,width:4,height:3});return _.onUnlock.push(pt(v)),_.onUnlock.push(pt(l)),{entity:_,area:E}},N3=s=>{const e="zVillage",t="pHairdresser",i=We(t),n=new g(114.5,0,142.7),r=s.add({id:t,zone:e,hairdresser:!0,attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},onUnlock:[xt(t)]}),a=s.add({id:r.id+"Area",zone:e,transform:{position:ke(r,0,0,0),rotation:{y:0}},interactiveArea:{radius:Ot,target:r},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(r)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)});ct(s,r.id,ke(a,1.5,0,-2));const o=Bi(s,a,e),l=Bt({world:s,zone:e,mapInfo:s.mapInfo,id:149,width:3,height:5});return r.onUnlock.push(pt(l)),{entity:r,area:a,areaVisualEntity:o}},B3=s=>{const e="zVillage",t="pTailor",i=We(t),n=new g(114.5,0,137.8),r=s.add({id:t,zone:e,tailor:!0,attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},onUnlock:[xt(t)]}),a=s.add({id:r.id+"Area",zone:e,transform:{position:ke(r,0,0,0),rotation:{y:0}},interactiveArea:{radius:Ot,target:r},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(r)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)});ct(s,r.id,ke(a,1.5,0,-2));const o=Bi(s,a,e),l=Bt({world:s,zone:e,mapInfo:s.mapInfo,id:112,width:4,height:4});return r.onUnlock.push(pt(l)),{entity:r,area:a,areaVisualEntity:o}},k3=s=>{const e="zVillage",t="trashBin",i="pTrash",n=s.add({id:i,zone:e,trashBin:!0,transform:{position:new g(127.5,0,135.3),rotation:{y:0}},enabled:!0,dontSaveEnabled:!0}),r=s.add({id:n.id+"Area",zone:e,transform:{position:n.transform.position.clone(),rotation:{y:0},scaling:g.One().scaleInPlace(.5)},interactiveArea:{radius:.5,target:n},dontSaveEnabled:!0,model:{key:"trashArea"}}),a=s.with("sawmill","purchased"),o=()=>a.entities.length>0;let l=null;const c=()=>Ie(void 0,null,function*(){const h=s.sceneEntity;if(!h)return;const d=h.scene;if(!s.lvlManager||(yield s.lvlManager.waitForMeshes([t]),l==null&&(l=d.getMeshByName(t),!l)))return;const f=o();l.isVisible=f}),u=()=>{const h=o();s.playerItems.filter(p=>p.item.key!=="iCoin").some(p=>p.item.count>0)&&h?r.enabled||It(s,r):r.enabled&&s.removeComponent(r,"enabled")};s.bus.onShowMaxAppeared.add(h=>Ie(void 0,null,function*(){if(!o()||h.player==null||s.varsEntity.persistentVars.dropTip||h.playerInServiceBuilding!=null)return;for(s.varsEntity.persistentVars.dropTip=!0,yield Te(1e3);s.playerEntity.zone!==e;)yield Te(100);const f=uo(s,n.zone,r.transform.position.clone());At(s,r.transform.position.clone()),yield Te(600),s.bus.onDropTutorialRequested.notifyObservers(),Te(2e3).then(()=>{s.bus.onDropTutorialFinished.notifyObservers(),gt(f)(s)})})),s.bus.onInitBeforeSave.add(()=>{s.removeComponent(r,"enabled")}),s.bus.onInventoryUpdated.add(()=>{u(),c()}),s.bus.onSceneReady.addOnce(()=>{u(),c()}),s.bus.onPlayerMovementFinished.add(()=>{if(!n.playerInInteractiveArea)return;const h=s.playerItems.filter(m=>m.item.key!=="iCoin");if(!h.some(m=>m.item.count>0)||!l)return;const f=l.absolutePosition,p=()=>{const m=h.find(A=>A.item.count>0);if(m==null)return;const _=m.item.key;m.item.count--,s.bus.onItemDropped.notifyObservers({itemKey:_}),s.bus.onInventoryUpdated.notifyObservers(),vt(s,ut.dropItem),Oe.addDesignEvent(`UI:Inventory:Trash_${_}`,1);const E=s.playerEntity.transform.position.clone(),v=ur(s,n.zone,"dropAnim"+$.id(),_,E.clone().addInPlaceFromFloats(0,.5,0),{rotY:$.nextFloor(0,2*Math.PI),scaling:g.One().setAll(.6)},{enabled:!0,dontSaveEnabled:!0}),y=g.Lerp(E,f.clone(),.5);rv(s.sceneEntity.scene,v.transform,"position",y.addInPlaceFromFloats(0,2,0),f.clone().addInPlaceFromFloats(0,.5,0),.3).onAnimationEndObservable.addOnce(()=>{s.addComponent(v,"removing",!0)})};s.sceneEntity.scene.onBeforeRenderObservable.runCoroutineAsync(function*(){for(;n.playerInInteractiveArea;)p(),yield Te(300)}())})},U3=s=>{const e="zVillage",t="pDock2",i=We(t),n=new g(157,0,147),r=s.add({id:t,zone:e,dock2:!0,attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},screenPosition:j.Zero(),screenPositionOffset:new g(0,2,0),onUnlock:[xt(t)]}),a=s.add({id:r.id+"Area",zone:e,transform:{position:r.transform.position.clone().addInPlaceFromFloats(0,0,0),rotation:{y:0},scaling:g.One()},interactiveArea:{radius:Ot,target:r},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(r)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});ct(s,r.id,ke(a,-1.5,0,-2)),r.onUnlock.push(gt(a));const o=Bt({world:s,zone:e,mapInfo:s.mapInfo,id:1627,width:7,height:2,open:!0}),l=Bt({world:s,zone:e,mapInfo:s.mapInfo,id:1789,width:2,height:3,open:!0});return r.onUnlock.push(pt(o),pt(l)),{entity:r,area:a}},V3=s=>{const e="zVillage",t="pBalloon",i=We(t),n=new g(163.5,0,151),r=s.add({id:t,zone:e,balloon:!0,attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},screenPosition:j.Zero(),screenPositionOffset:new g(0,2,0),onUnlock:[xt(t)]}),a=s.add({id:r.id+"Area",zone:e,transform:{position:r.transform.position.clone().addInPlaceFromFloats(0,.1,0),rotation:{y:0}},interactiveArea:{radius:Ot,target:r},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(r)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)});ct(s,r.id,ke(a,0,0,-2));const o=Bi(s,a,e);return s.bus.onPlayerMovementFinished.add(()=>{!r.playerInInteractiveArea||!r.unlocked||s.bus.onButtonClicked.notifyObservers({btn:"prestige"})}),{entity:r,area:a,areaVisualEntity:o}},G3=s=>{const e="zVillage",t="pMine",i=We(t),n=new g(114,0,151),r=s.add({id:t,zone:e,mine:!0,attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},itemProducer:{outputItemType:"iOre",outputItemAmountRate:1,nextStepAt:0,outputArea:{x:n.x-.25,z:n.z-.25,width:.5,height:.5},animated:!0},onUnlock:[xt(t)]}),a=s.add({id:r.id+"Area",zone:e,transform:{position:ke(r,0,0,0),rotation:{y:0},scaling:g.One()},interactiveArea:{radius:Ot,target:r},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(r)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});return ct(s,r.id,ke(a,2.5,0,-.5)),r.onUnlock.push(gt(a)),{entity:r,area:a}},z3=s=>{const e="zVillage",t="pForge",i=We(t),n=new g(129,0,149.3),r=Wn(s,e,new g(n.x,0,n.z+.1),Math.PI*.97,!1,{id:t+"Npc",purchased:!0,unlocked:!0});r.appearance.parts.push(["Mustache",2,Ae.eyesColorDark]),r.appearance.parts.push(["Pant",0,Ae.colorLeather700]);const a=ji(131,149.7),o=[],l=new g(131,0,148.5),c=.65;for(let _=0;_<7;_++)o.push(l.clone()),l.addInPlaceFromFloats(-c/Math.max(1,_/.9),0,-_*.15);const u=s.add({id:t,zone:e,forge:!0,usable:!0,queuable:qr(o),attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},itemProducer:{inputItemType:"iOre",outputItemType:"iIron",outputItemAmountRate:1,nextStepAt:0,outputArea:ji(n.x+2,n.z+1),outputGainingArea:a,animated:!0},screenPosition:j.Zero(),screenPositionOffset:new g(0,2,0),onUnlock:[xt(t)],connectedWorker:r}),h=s.add({id:u.id+"Area",zone:e,transform:{position:ke(u,0,0,0),rotation:{y:0}},interactiveArea:{radius:Ot,target:u},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(u)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)}),d=new g(n.x+2,0,n.z+1),f=()=>({y:$.nextFloor(-.2,.2)});s.add({id:u.id+"_output_shelf",zone:e,transform:{rotation:{y:0},position:d},outputShelf:{slots:[{rot:f(),pos:d.clone().addInPlaceFromFloats(0,.1,0)},{rot:f(),pos:d.clone().addInPlaceFromFloats(0,.3,0)},{rot:f(),pos:d.clone().addInPlaceFromFloats(0,.5,0)},{rot:f(),pos:d.clone().addInPlaceFromFloats(0,.7,0)},{rot:f(),pos:d.clone().addInPlaceFromFloats(0,.9,0)},{rot:f(),pos:d.clone().addInPlaceFromFloats(0,.11,0)},{rot:f(),pos:d.clone().addInPlaceFromFloats(0,.13,0)},{rot:f(),pos:d.clone().addInPlaceFromFloats(0,.15,0)}]},ownedBy:u.id}),ct(s,u.id,ke(h,-2,0,-.5)),cc(s,u,r);const p=Bi(s,h,e);u.onUnlock.push(gt(p)),u.onUnlock.push(pt(r));const m=Bt({world:s,zone:e,mapInfo:s.mapInfo,id:638,width:4,height:2,open:!1});return u.onUnlock.push(pt(m)),{entity:u,area:h,areaVisualEntity:p}},H3=(s,e,t)=>{const i="zVillage",n="pMinerNpc",r=We(n),a=Wn(s,i,new g(118,0,151.4),Math.PI*.8,!1,{id:n,npcInitialPosition:new g(118,0,151.4),npcSleepPosition:new g(119.5,0,151),npcGoals:[{type:"returnToInitial"},{type:"supplying",source:e,target:t},{type:"returnToInitial"},{type:"consumeDurability",amount:1},{type:"sleeping"}],hireableNpc:!0,attributes:Qt({attBaseMovementSpeed:1.5,attBasePickingDistance:.6,attBasePickingSpeed:600},r.baseAttributes),movement:{speed:0,velocity:g.Zero()},stayingTime:0});a.appearance.parts.push(["Pant",0,Ae.colorLeather700]);const o=new No(a,s);s.addComponent(a,"npcFSM",o);const l=s.add({id:a.id+"Area",zone:i,transform:{position:a.transform.position.clone().addInPlaceFromFloats(0,.05,-.5),rotation:{y:0},scaling:g.One()},interactiveArea:{radius:Ot,target:a},itemHolder:{type:r.unlock.item,max:r.unlock.count,val:0,onMaxed:[nt(a)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});return ct(s,a.id,ke(l,2.3,0,-.5)),s.addComponent(a,"onUnlock",[gt(l)]),{npc:a,area:l}},W3=s=>{const e="zVillage",t="pCornField",i=We(t),n=new g(126,.1,140.7),r=ji(n.x,n.z+2.3),a=[],o=new g(127,0,143),l=.6;for(let m=0;m<7;m++)a.push(o.clone()),o.addInPlaceFromFloats(l/Math.max(1,m/.9),0,-m*.2);const c=s.add({id:t,zone:e,cornField:!0,usable:!0,queuable:qr(a),attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},itemProducer:{inputItemType:"iWater",outputItemType:"iCorn",outputItemAmountRate:1,nextStepAt:0,outputArea:ji(n.x,n.z+1.8),animated:!0,outputGainingArea:r},screenPosition:j.Zero(),screenPositionOffset:new g(0,1,0),onUnlock:[xt(t)]}),u=s.add({id:c.id+"Area",zone:e,transform:{position:ke(c,0,0,0),rotation:{y:0}},interactiveArea:{radius:Ot+.5,target:c},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(c)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0)}),h=.2,d=new g(n.x-.5,.2,n.z+1.8),f=()=>({y:0});s.add({id:c.id+"_output_shelf",zone:e,transform:{rotation:{y:0},position:d},outputShelf:{slots:[{rot:f(),pos:d.clone().addInPlaceFromFloats(0,0,0)},{rot:f(),pos:d.clone().addInPlaceFromFloats(h,0,0)},{rot:f(),pos:d.clone().addInPlaceFromFloats(h*2,0,0)},{rot:f(),pos:d.clone().addInPlaceFromFloats(h*3,0,0)},{rot:f(),pos:d.clone().addInPlaceFromFloats(h*4,0,0)},{rot:f(),pos:d.clone().addInPlaceFromFloats(h*5,0,0)},{rot:f(),pos:d.clone().addInPlaceFromFloats(h*6,0,0)}]},ownedBy:c.id}),ct(s,c.id,ke(u,.5,0,2.3));const p=Bi(s,u,e);return c.onUnlock.push(gt(p)),{entity:c,area:u,areaVisualEntity:p}},X3=s=>{const e="zVillage",t="pArena",i=We(t),n=new g(148,.3,130),r=s.add({id:t,zone:e,arena:!0,attributes:i.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0},scaling:g.One().scaleInPlace(2.5)},animateRotation:{duration:1},onUnlock:[()=>{s.addComponent(r,"model",{key:"swords"})}],screenPosition:j.Zero(),screenPositionOffset:new g(0,1.5,0)}),a=s.add({id:r.id+"Area",dontSaveEnabled:!0,zone:e,transform:{position:ke(r,0,0,0),rotation:{y:0},scaling:g.One()},interactiveArea:{radius:Ot,target:r},itemHolder:{type:i.unlock.item,max:i.unlock.count,val:0,onMaxed:[nt(r)],onValueChanged:[Ht(t)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});ct(s,r.id,ke(a,-1.5,0,-1));const o=[Bt({world:s,zone:e,mapInfo:s.mapInfo,id:1191,width:1,height:7,open:!0}),Bt({world:s,zone:e,mapInfo:s.mapInfo,id:1191,width:7,height:1,open:!0}),Bt({world:s,zone:e,mapInfo:s.mapInfo,id:1191+6,width:7,height:1,open:!0}),Bt({world:s,zone:e,mapInfo:s.mapInfo,id:1383,width:1,height:7,open:!0})],l=[...o.map(f=>[...f.gridMapPatch.opened])],c=()=>{o.forEach((f,p)=>{f.gridMapPatch.opened.length=0,f.gridMapPatch.closed=[...l[p]],s.bus.onPatchUpdated.notifyObservers(f)})},u=()=>{o.forEach((f,p)=>{f.gridMapPatch.closed.length=0,f.gridMapPatch.opened=[...l[p]],s.bus.onPatchUpdated.notifyObservers(f)})};r.onUnlock.push(...o.map(pt)),r.onUnlock.push(pt(a)),s.bus.onVillageModeChanged.add(f=>{f==="war"?(s.removeComponent(a,"enabled"),s.removeComponent(r,"enabled"),c()):f==="peacetime"&&(It(s,a),It(s,r),u())});let h=null;s.bus.onTimerFired.add(f=>{f===h&&r.playerInInteractiveArea&&s.villageMode==="peacetime"&&qP(s)}),s.bus.onPlayerMovementStarted.add(()=>{h&&(s.addComponent(h,"removing",!0),h=null)});const d=1;return s.bus.onPlayerMovementFinished.add(()=>{!r.unlocked||!r.playerInInteractiveArea||!Du[s.varsEntity.persistentVars.waves]||(h=$P(s,d),s.addComponent(h,"activationTimer",!0))}),{entity:r,area:a}},Wg=(s,e,t)=>{const i=s.playerEntity.attributesLevel[e];if(i==null)return;const n=10,r=.05;let a=n+Math.ceil((Math.ceil(Math.exp(Math.max(0,i-1)*r))-1)*1);a=Math.min(a,50),t.itemProducer.minInputItemsPerStep=a,t.itemProducer.outputItemAmountRate=1/a,t.attributes.attInventoryBaseCapacity=a,t.recalculateAttributes=!0},Dv=(s,e,t)=>{s.bus.onInitBeforeSave.add(i=>Wg(i,e,t)),s.bus.onProducerOutputProduced.add(i=>{if(i.id!==t.id)return;const n=s.entitiesByOwner.get(i.id);n&&n.forEach(r=>{if(r.item&&r.item.key===t.itemProducer.outputItemType){for(;r.item.count;)r.item.count--,Gf(s,e,1);s.addComponent(r,"removing",!0)}})}),s.bus.onPlayerAttrLevelUpgraded.add(i=>{i===e&&Wg(s,i,t)})},Y3=s=>{const e="zVillage",t="pTrainerStrengthNpc",i=We(t),n=dr(s,e,new g(152,0,133),Math.PI,!1,{id:t,attributes:i.baseAttributes,recalculateAttributes:!0,screenPosition:j.Zero(),screenPositionOffset:new g(0,1.5,0),screenPositionDistSqrt:ks(8,2),itemProducer:{inputItemType:"iCoin",outputItemType:"iStrength",outputItemAmountRate:.1,minInputItemsPerStep:i.baseAttributes.attInventoryBaseCapacity,stackableInput:!0,fullPerStep:!0,nextStepAt:0,outputArea:ji(0,0)},purchased:!0});n.appearance.parts.push(["Pant",0,Ae.colorBrown700]),n.appearance.parts.push(["Weapon",0,Ae.colorLeather700]);const r=s.add({id:n.id+"Area",zone:e,transform:{position:ke(n,0,0,-.5),rotation:{y:0},scaling:g.One().setAll(.7)},interactiveArea:{radius:.7,target:n},model:{key:"interactiveArea"}});return ct(s,n.id,ke(r,-1.5,0,-.5)),Dv(s,"attStr",n),{area:r,npc:n}},K3=s=>{const e="zVillage",t="pTrainerHpNpc",i=We(t),n=dr(s,e,new g(154,0,132),Math.PI*1.2,!1,{id:t,attributes:i.baseAttributes,recalculateAttributes:!0,screenPosition:j.Zero(),screenPositionOffset:new g(0,1.5,0),screenPositionDistSqrt:ks(8,2),itemProducer:{inputItemType:"iCoin",outputItemType:"iHp",outputItemAmountRate:.1,minInputItemsPerStep:i.baseAttributes.attInventoryBaseCapacity,stackableInput:!0,fullPerStep:!0,nextStepAt:0,outputArea:ji(0,0)},purchased:!0});n.appearance.parts.push(["Pant",0,Ae.colorBrown700]),n.appearance.parts.push(["Weapon",0,Ae.colorLeather700]);const r=s.add({id:n.id+"Area",zone:e,transform:{position:ke(n,-.5,0,-.5),rotation:{y:0},scaling:g.One().setAll(.7)},interactiveArea:{radius:.7,target:n},model:{key:"interactiveArea"}});return ct(s,n.id,ke(r,-.5,0,-2)),Dv(s,"attVit",n),{area:r,npc:n}};function Ci(s){return new g(s.x,0,s.z)}function Q3(s,e,t){function r(a,o,l,c,u){const h=kP(s,a,o,t,c,.55);s.addComponent(h,"dontSaveEnabled",!0),s.addComponent(h,"enabled",!0),s.addComponent(h,"teleport",{to:l,targetZone:u}),s.addComponent(h,"model",{key:"tpArea"}),h.transform.scaling=g.One().setAll(.6)}e.forEach((a,o)=>{r("tp"+o,Ci(a.fromPoint),Ci(a.toPoint),a.fromZone,a.toZone)})}function mm(s,e,t){const i=s.with("teleport","interactiveArea"),n=()=>{i.entities.filter(o=>o.teleport.targetZone===t).forEach(o=>s.removeComponent(o,"enabled"))},r=()=>{i.entities.filter(o=>o.teleport.targetZone===t).forEach(o=>It(s,o))};Dn.onGameLoaded.addOnce(n);const a=s.bus.onEntityUnlocked.add(o=>{o.id===e&&(r(),a.remove())})}const Z3=s=>{const t="zVillage",i="pClimb",n=Ci(qi.zones[t].pois.poiClimb.point),r=Ci(qi.zones[t].pois.poiClimbOffer.point),a=We(i),o=s.add({id:i,zone:t,attributes:a.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},onUnlock:[xt(i)]}),l=s.add({id:o.id+"Area",zone:t,transform:{position:ke(o,0,0,0),rotation:{y:0},scaling:g.One().scaleInPlace(.8)},interactiveArea:{radius:.8,target:o},itemHolder:{type:a.unlock.item,max:a.unlock.count,val:0,onMaxed:[nt(o)],onValueChanged:[]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});return o.onUnlock.push(gt(l)),ct(s,o.id,r),mm(s,o.id,"zSnow"),{entity:o,area:l}},q3=s=>{const t="zSnow",i="pSnowFireplace",n=qi.zones[t],r=Ci(n.pois.poiSnowFireplace.point),a=Ci(n.pois.poiSnowFireplaceOffer.point),o=We(i),l=s.add({id:i,zone:t,attributes:o.baseAttributes,recalculateAttributes:!0,transform:{position:r,rotation:{y:0}},onUnlock:[xt(i)]}),c=s.add({id:l.id+"Area",zone:t,transform:{position:ke(l,0,0,0),rotation:{y:0},scaling:g.One().scaleInPlace(.8)},interactiveArea:{radius:.8,target:l},itemHolder:{type:o.unlock.item,max:o.unlock.count,val:0,onMaxed:[nt(l)],onValueChanged:[Ht(i)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});l.onUnlock.push(gt(c)),ct(s,l.id,a);const u=Bt({world:s,zone:t,mapInfo:n.gridMap.mapInfo,id:222,width:2,height:2,open:!1});return l.onUnlock.push(pt(u)),{entity:l,area:c}},j3=s=>{const t="zSnow",i="pSnowHut",n=qi.zones[t],r=Ci(n.pois.poiSnowHut.point),a=Ci(n.pois.poiSnowHutOffer.point),o=We(i),l=s.add({id:i,zone:t,attributes:o.baseAttributes,recalculateAttributes:!0,transform:{position:r,rotation:{y:0}},onUnlock:[xt(i)]}),c=s.add({id:l.id+"Area",zone:t,transform:{position:ke(l,0,0,0),rotation:{y:0},scaling:g.One().scaleInPlace(.8)},interactiveArea:{radius:.8,target:l},itemHolder:{type:o.unlock.item,max:o.unlock.count,val:0,onMaxed:[nt(l)],onValueChanged:[Ht(i)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});l.onUnlock.push(gt(c)),ct(s,l.id,a);const u=Bt({world:s,zone:t,mapInfo:n.gridMap.mapInfo,id:5,width:4,height:4,open:!1});return l.onUnlock.push(pt(u)),{entity:l,area:c}},$3=s=>{const t="zSnow",i="pSnowCave",n=Ci(qi.zones[t].pois.poiSnowCave.point),r=Ci(qi.zones[t].pois.poiSnowCaveOffer.point),a=We(i),o=s.add({id:i,zone:t,attributes:a.baseAttributes,recalculateAttributes:!0,transform:{position:n,rotation:{y:0}},onUnlock:[xt(i)]}),l=s.add({id:o.id+"Area",zone:t,transform:{position:ke(o,0,0,0),rotation:{y:0},scaling:g.One().scaleInPlace(.8)},interactiveArea:{radius:.8,target:o},itemHolder:{type:a.unlock.item,max:a.unlock.count,val:0,onMaxed:[nt(o)],onValueChanged:[Ht(i)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});return o.onUnlock.push(gt(l)),ct(s,o.id,r),mm(s,o.id,"zCave"),{entity:o,area:l}},J3=s=>{const t="zCave",i="pCaveLight",n=qi.zones[t],r=Ci(n.pois.poiCaveLight.point),a=Ci(n.pois.poiCaveLightOffer.point),o=We(i),l=s.add({id:i,zone:t,attributes:o.baseAttributes,recalculateAttributes:!0,transform:{position:r,rotation:{y:0}},onUnlock:[xt(i)]}),c=s.add({id:l.id+"Area",zone:t,transform:{position:ke(l,0,0,0),rotation:{y:0},scaling:g.One().scaleInPlace(.8)},interactiveArea:{radius:.8,target:l},itemHolder:{type:o.unlock.item,max:o.unlock.count,val:0,onMaxed:[nt(l)],onValueChanged:[Ht(i)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});l.onUnlock.push(gt(c)),ct(s,l.id,a);const u=Bt({world:s,zone:t,mapInfo:n.gridMap.mapInfo,id:98,width:2,height:1,open:!0});return l.onUnlock.push(pt(u)),{entity:l,area:c}},e4=s=>{const t="zCave",i="pCaveBridge1",n=qi.zones[t],r=Ci(n.pois.poiCaveBridge1.point),a=Ci(n.pois.poiCaveBridge1Offer.point),o=We(i),l=s.add({id:i,zone:t,attributes:o.baseAttributes,recalculateAttributes:!0,transform:{position:r,rotation:{y:0}},onUnlock:[xt(i)]}),c=s.add({id:l.id+"Area",zone:t,transform:{position:ke(l,0,0,0),rotation:{y:0},scaling:g.One().scaleInPlace(.8)},interactiveArea:{radius:.8,target:l},itemHolder:{type:o.unlock.item,max:o.unlock.count,val:0,onMaxed:[nt(l)],onValueChanged:[Ht(i)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});l.onUnlock.push(gt(c)),ct(s,l.id,a);const u=Bt({world:s,zone:t,mapInfo:n.gridMap.mapInfo,id:26,width:1,height:4,open:!0});return l.onUnlock.push(pt(u)),{entity:l,area:c}},t4=s=>{const t="zCave",i="pCaveBridge2",n=qi.zones[t],r=Ci(n.pois.poiCaveBridge2.point),a=Ci(n.pois.poiCaveBridge2Offer.point),o=We(i),l=s.add({id:i,zone:t,attributes:o.baseAttributes,recalculateAttributes:!0,transform:{position:r,rotation:{y:0}},onUnlock:[xt(i)]}),c=s.add({id:l.id+"Area",zone:t,transform:{position:ke(l,0,0,0),rotation:{y:0},scaling:g.One().scaleInPlace(.8)},interactiveArea:{radius:.8,target:l},itemHolder:{type:o.unlock.item,max:o.unlock.count,val:0,onMaxed:[nt(l)],onValueChanged:[Ht(i)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});l.onUnlock.push(gt(c)),ct(s,l.id,a);const u=Bt({world:s,zone:t,mapInfo:n.gridMap.mapInfo,id:128,width:1,height:3,open:!0});return l.onUnlock.push(pt(u)),{entity:l,area:c}},i4=s=>{const t="zCave",i="pCaveCrystal",n=qi.zones[t],r=Ci(n.pois.poiCaveCrystal.point),a=Ci(n.pois.poiCaveCrystalOffer.point),o=We(i),l=s.add({id:i,zone:t,attributes:o.baseAttributes,recalculateAttributes:!0,transform:{position:r,rotation:{y:0}},itemProducer:{inputItemType:"iCoin",outputItemType:"iCrystal",outputArea:ji(r.x+2,r.z-.5),animated:!0,outputItemAmountRate:.02,minInputItemsPerStep:o.baseAttributes.attInventoryBaseCapacity,stackableInput:!0,fullPerStep:!0,nextStepAt:0},screenPosition:j.Zero(),screenPositionOffset:new g(0,2,0),onUnlock:[xt(i)]}),c=s.add({id:l.id+"Area",zone:t,transform:{position:ke(l,0,0,0),rotation:{y:0},scaling:g.One().scaleInPlace(.8)},interactiveArea:{radius:.8,target:l},itemHolder:{type:o.unlock.item,max:o.unlock.count,val:0,onMaxed:[nt(l)],onValueChanged:[Ht(i)]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});return ct(s,l.id,a),{entity:l,area:c}},n4=s=>{const t="zSnow",i="pJewelerNpc",n=qi.zones[t],r=Ci(n.pois.poiJewelerNpc.point),a=Ci(n.pois.poiJewelerNpcOffer.point),o=We(i),l=dr(s,t,r,Math.PI*.5,!1,{id:i,attributes:o.baseAttributes,recalculateAttributes:!0,screenPosition:j.Zero(),screenPositionOffset:new g(0,1.5,0),screenPositionDistSqrt:ks(8,2),itemProducer:{inputItemType:"iCrystal",outputItemType:"iGem",outputArea:ji(r.x+.2,r.z+1),animated:!0,outputItemAmountRate:.2,minInputItemsPerStep:o.baseAttributes.attInventoryBaseCapacity,stackableInput:!0,fullPerStep:!0,nextStepAt:0},onUnlock:[xt(i)]}),c=G.FromHexString("#fafafa");l.appearance.parts.push(["Pant",1,c]),l.appearance.parts.push(["Coat",0,c]),l.appearance.parts.push(["Hair",5,c]);const u=s.add({id:l.id+"Area",zone:t,transform:{position:ke(l,.4,0,0),rotation:{y:0},scaling:g.One().scaleInPlace(.8)},interactiveArea:{radius:.8,target:l},itemHolder:{type:o.unlock.item,max:o.unlock.count,val:0,onMaxed:[nt(l)],onValueChanged:[]},screenPosition:j.Zero(),screenPositionOffset:new g(0,3,0),model:{key:"interactiveArea"}});return ct(s,l.id,a),l.onUnlock.push(pt(Bt({world:s,zone:t,mapInfo:n.gridMap.mapInfo,id:64,width:1,height:1,open:!1}))),{npc:l,area:u}};function s4(s,e){const{x:t,z:i}=e;GE.forEach(P=>{const ie=tc.Effects[P];if(ie==null)return;const et=s.add({id:P,effect:{attr:ie.attr,op:ie.op,value:ie.val},ownedBy:ie.target});ie.duration!=null&&s.addComponent(et,"willRemoveDelay",ie.duration)}),O3(s);const n=w3(s),r=h3(s),a=p3(s),o=m3(s,t,i),l=_3(s),c=v3(s),u=y3(s),h=A3(s),d=T3(s),f=S3(s),p=C3(s),m=I3(s),_=R3(s),E=M3(s),v=P3(s),y=D3(s),A=F3(s,p.entity,E.entity),I=L3(s,p.entity,E.entity),T=N3(s),R=B3(s),x=d3(s),F=U3(s),L=V3(s);f3(s),k3(s);const V=X3(s),Z=G3(s),ne=z3(s),ae=H3(s,Z.entity,ne.entity),Ue=W3(s),Ve=Y3(s),$e=K3(s),re=Z3(s),ge=q3(s),be=j3(s),ze=$3(s),Ke=n4(s),Ut=J3(s),st=e4(s),Jt=t4(s),Wt=i4(s),ii=b3(s,u.entity,c.entity,h.entity),$i=g3(s,a.entity),Ji=E3(s,l.entity,c.entity,d.entity,Ue.entity),en=x3(s,d.entity,f.entity),vn={pHome:[r.area],pSawmill:[a.area,a.areaVisualEntity],pMarket:[o.area],pWell:[l.area,l.areaVisualEntity],pHut1:[A.area],pHut2:[I.area],pWheatGarden:[c.area,c.areaVisualEntity],pMill:[u.area,u.areaVisualEntity],pAppleGarden:[d.area,d.areaVisualEntity],pBaker:[h.area,h.areaVisualEntity],pWinery:[f.area,f.areaVisualEntity],pPub:[p.area,p.areaVisualEntity],pWall:[m.area,m.areaVisualEntity],pHunter:[_.area,_.areaVisualEntity,_.npc],pDock:[E.area],pFisherman:[v.area,v.areaVisualEntity],pShip:[y.area,y.areaVisualEntity],pLogNpc:[$i.area,$i.npc],pWaterNpc:[Ji.area,Ji.npc],pMillerNpc:[ii.area,ii.npc],pAppleNpc:[en.area,en.npc],pThiefNpc:[n.npc],pHairdresser:[T.area,T.areaVisualEntity],pTailor:[R.area,R.areaVisualEntity],pLaboratory:[x.area,x.areaVisualEntity],pDock2:[F.area],pBalloon:[L.area,L.areaVisualEntity],pMine:[Z.area],pForge:[ne.area,ne.areaVisualEntity],pMinerNpc:[ae.area,ae.npc],pCornField:[Ue.area,Ue.areaVisualEntity],pArena:[V.area],pTrainerStrengthNpc:[Ve.npc,Ve.area],pTrainerHpNpc:[$e.npc,$e.area],pClimb:[re.area],pSnowFireplace:[ge.area],pSnowHut:[be.area],pSnowCave:[ze.area],pJewelerNpc:[Ke.area],pCaveLight:[Ut.area],pCaveBridge1:[st.area],pCaveBridge2:[Jt.area],pCaveCrystal:[Wt.area]},Ne=P=>{P!=="pHome"&&P!=="pSawmill"&&P!=="pMarket"&&P!=="pTrainerHpNpc"&&P!=="pTrainerStrengthNpc"&&P!=="pThiefNpc"&&Oe.addDesignEvent(`UI:EnableProducer:${P}`),Pv(s,...vn[P])};Ne("pThiefNpc"),Dn.onGameLoaded.addOnce(()=>{});const Xe=(P,ie)=>uo(s,ie,P.transform.position.clone().addInPlaceFromFloats(0,.5,0)),_i=(P,ie)=>{P.removeOnUnlock!=null?P.removeOnUnlock.push(ie):s.addComponent(P,"removeOnUnlock",[ie])},yt=P=>()=>s.addComponent(P,"removing",!0),Ge=(P,ie)=>{P.itemHolder.onMaxed!=null?P.itemHolder.onMaxed.push(yt(ie)):P.itemHolder.onMaxed=[yt(ie)]},yn=(P,ie=1)=>(s.statsEntity.gameStatistics.picked[P]||0)>=ie,Vt=P=>{s.sceneEntity.scene.onBeforeRenderObservable.runCoroutineAsync(P())};s.add({adviser:{suggestions:[Je(()=>!0,()=>{if(s.statsEntity.gameStatistics.chopped>=1)return;const ie=uo(s,"zVillage",new g(119.2,.2,136));s.bus.onStartChopping.addOnce(yt(ie)),s.bus.onPlayerMovementStarted.addOnce(()=>Ie(this,null,function*(){const et=s.tasksQuery.with("taskActive").without("taskDone").entities[0];et&&et.task.op==="dragToMove"&&(yield Te(500),At(s,ie.attentionPoint.clone()))}))}),Je(()=>r.entity.enabled||s.statsEntity.gameStatistics.chopped>0&&yn("iLog",3),()=>{const P=r,ie=P.entity.zone;P.entity.purchased||(Ne(P.entity.id),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id)),!P.entity.enabled&&(Ge(P.area,Xe(P.area,ie)),Vt(function*(){yield Te(1e3),At(s,P.area.transform.position.clone())}))}),Je(()=>r.entity.buildingFinished===!0,()=>{const P=o,ie=P.entity.zone;if(P.entity.enabled)return;Ne(P.entity.id);const et=s.sceneEntity.scene;Vt(function*(){for(yield Te(1e3);s.playerEntity.zone!==ie;)yield Te(500);et.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.area,ie)),At(s,P.area.transform.position.clone())})}),Je(()=>o.entity.buildingFinished===!0,()=>Ie(this,null,function*(){const P=a;Ne(P.entity.id);const ie=P.entity.zone;P.entity.purchased||s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),!P.entity.enabled&&(Ge(P.area,Xe(P.areaVisualEntity,ie)),Vt(function*(){yield Te(1e3),At(s,P.areaVisualEntity.transform.position.clone())}))})),Je(()=>a.entity.purchased===!0,()=>{if(s.statsEntity.gameStatistics.gameTime<15e3)return;const P=uo(s,a.entity.zone,new g(135,.2,125.5));s.bus.onStartChopping.addOnce(yt(P))}),Je(()=>a.entity.buildingFinished===!0&&yn("iCoin",1),()=>{const P=c;if(P.entity.enabled)return;const ie=P.entity.zone;Ne(P.entity.id),Vt(function*(){yield Te(500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie)),At(s,P.areaVisualEntity.transform.position.clone())})}),Je(()=>!!c.entity.unlocked,()=>{const P=l;if(P.entity.enabled)return;const ie=P.entity.zone;Ne(P.entity.id),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie))}),Je(()=>!!l.entity.unlocked,()=>{const P=$i;if(P.npc.enabled)return;const ie=P.npc.zone;Ne(P.npc.id),Ge(P.area,Xe(P.area,ie)),Vt(function*(){yield Te(1500),At(s,P.area.transform.position.clone())})}),Je(()=>!!$i.npc.unlocked,()=>{const P=A;if(P.entity.enabled)return;const ie=P.entity.zone;Ne(P.entity.id),Vt(function*(){yield Te(500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.area,ie)),At(s,P.area.transform.position.clone())})}),Je(()=>!!A.entity.unlocked,()=>{const P=u;if(P.entity.enabled)return;const ie=P.entity.zone;Ne(P.entity.id),Vt(function*(){yield Te(1500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie)),At(s,P.areaVisualEntity.transform.position.clone())})}),Je(()=>!!u.entity.unlocked,()=>{const P=E;if(P.entity.enabled)return;const ie=P.entity.zone;Ne(P.entity.id),Vt(function*(){yield Te(1500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.area,ie)),At(s,P.area.transform.position.clone())})}),Je(()=>!!E.entity.unlocked,()=>{const P=v;if(P.entity.enabled)return;const ie=P.entity.zone;Ne(P.entity.id),Vt(function*(){yield Te(1500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie)),At(s,P.areaVisualEntity.transform.position.clone())})}),Je(()=>!!v.entity.unlocked,()=>{const P=Ji;if(P.npc.enabled)return;const ie=P.npc.zone;Ne(P.npc.id),_i(P.npc,Xe(P.area,ie)),Vt(function*(){yield Te(1500),At(s,P.area.transform.position.clone())})}),Je(()=>!!Ji.npc.unlocked,()=>Ie(this,null,function*(){const P=h;if(P.entity.enabled)return;const ie=P.entity.zone;Ne(P.entity.id),yield Te(500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie)),At(s,P.areaVisualEntity.transform.position.clone())})),Je(()=>!!h.entity.unlocked,()=>Ie(this,null,function*(){const P=T;if(P.entity.enabled)return;const ie=P.entity.zone;Ne(P.entity.id),yield Te(1500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie)),At(s,P.areaVisualEntity.transform.position.clone())})),Je(()=>!!T.entity.unlocked,()=>Ie(this,null,function*(){const P=m;if(P.entity.enabled)return;const ie=P.entity.zone;Ne(P.entity.id),yield Te(1500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie)),At(s,P.areaVisualEntity.transform.position.clone())})),Je(()=>!!m.entity.unlocked,()=>Ie(this,null,function*(){const P=_;if(P.entity.enabled)return;const ie=P.entity.zone;Ne(P.entity.id),yield Te(500),Ge(P.area,Xe(P.areaVisualEntity,ie))})),Je(()=>!!_.entity.unlocked,()=>Ie(this,null,function*(){const P=ii;if(P.npc.enabled)return;const ie=P.npc.zone;Ne(P.npc.id),Ge(P.area,Xe(P.area,ie)),yield Te(1500),At(s,P.area.transform.position.clone())})),Je(()=>!!ii.npc.unlocked,()=>Ie(this,null,function*(){const P=d;if(P.entity.enabled)return;Ne(P.entity.id);const ie=P.entity.zone;yield Te(500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie)),At(s,P.areaVisualEntity.transform.position.clone())})),Je(()=>!!d.entity.unlocked,()=>Ie(this,null,function*(){const P=f;if(P.entity.enabled)return;Ne(P.entity.id),yield Te(1500);const ie=P.entity.zone;s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie)),At(s,P.areaVisualEntity.transform.position.clone())})),Je(()=>!!f.entity.unlocked,()=>Ie(this,null,function*(){const P=I;if(P.entity.enabled)return;Ne(P.entity.id),yield Te(1500);const ie=P.entity.zone;s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.area,ie)),At(s,P.area.transform.position.clone())})),Je(()=>!!I.entity.unlocked,()=>Ie(this,null,function*(){const P=p;if(P.entity.enabled)return;Ne(P.entity.id),yield Te(1500);const ie=P.entity.zone;s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie)),At(s,P.areaVisualEntity.transform.position.clone())})),Je(()=>!!p.entity.unlocked,()=>Ie(this,null,function*(){const P=en;if(P.npc.enabled)return;yield Te(1500);const ie=P.npc.zone;Ne(P.npc.id),Ge(P.area,Xe(P.area,ie)),At(s,P.area.transform.position.clone())})),Je(()=>!!en.npc.unlocked,()=>Ie(this,null,function*(){const P=R;if(P.entity.enabled)return;Ne(P.entity.id),yield Te(1500);const ie=P.entity.zone;s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie)),At(s,P.areaVisualEntity.transform.position.clone())})),Je(()=>!!R.entity.unlocked,()=>Ie(this,null,function*(){const P=y;if(P.entity.enabled)return;Ne(P.entity.id),yield Te(1500);const ie=P.entity.zone;s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie)),At(s,P.areaVisualEntity.transform.position.clone())})),Je(()=>!!y.entity.unlocked,()=>{const P=ne;if(P.entity.enabled)return;Ne(P.entity.id);const ie=P.entity.zone;Vt(function*(){yield Te(1500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie)),At(s,P.areaVisualEntity.transform.position.clone())})}),Je(()=>!!ne.entity.unlocked,()=>{const P=Z;if(P.entity.enabled)return;Ne(P.entity.id);const ie=P.entity.zone;Vt(function*(){yield Te(1500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.area,ie)),At(s,P.area.transform.position.clone())})}),Je(()=>!!Z.entity.unlocked,()=>{const P=ae;if(P.npc.enabled)return;Ne(P.npc.id);const ie=P.npc.zone;Vt(function*(){yield Te(1e3),Ge(P.area,Xe(P.area,ie)),At(s,P.area.transform.position.clone())})}),Je(()=>!!ae.npc.unlocked,()=>{const P=Ue;if(P.entity.enabled)return;Ne(P.entity.id);const ie=P.entity.zone;Vt(function*(){yield Te(1500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie)),At(s,P.areaVisualEntity.transform.position.clone())})}),Je(()=>!!Ue.entity.unlocked,()=>{const P=F;if(P.entity.enabled)return;Ne(P.entity.id);const ie=P.entity.zone;Vt(function*(){yield Te(1500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.area,ie)),At(s,P.area.transform.position.clone())})}),Je(()=>!!F.entity.unlocked,()=>Ie(this,null,function*(){const P=x;if(P.entity.enabled)return;Ne(P.entity.id);const ie=P.entity.zone;Vt(function*(){yield Te(1500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie)),At(s,P.areaVisualEntity.transform.position.clone())})})),Je(()=>!!x.entity.unlocked,()=>{const P=L;if(P.entity.enabled)return;Ne(P.entity.id);const ie=P.entity.zone;Vt(function*(){yield Te(1500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.areaVisualEntity,ie)),At(s,P.areaVisualEntity.transform.position.clone())})}),Je(()=>!!u.entity.unlocked,()=>{const P=V;P.entity.enabled||Ne(P.entity.id)}),Je(()=>!!V.entity.unlocked,()=>{Ne(Ve.npc.id),Ne($e.npc.id)}),Je(()=>!!L.entity.unlocked,()=>{const P=re;if(P.entity.enabled)return;Ne(P.entity.id);const ie=P.entity.zone;Vt(function*(){yield Te(1500),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id),Ge(P.area,Xe(P.area,ie)),At(s,P.area.transform.position.clone())})}),Je(()=>!!re.entity.unlocked,()=>{const P=ge;if(P.entity.enabled)return;Ne(P.entity.id),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id)}),Je(()=>!!ge.entity.unlocked,()=>{const P=be;if(P.entity.enabled)return;Ne(P.entity.id),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id)}),Je(()=>!!be.entity.unlocked,()=>{const P=Ke;P.npc.enabled||Ne(P.npc.id)}),Je(()=>!!Ke.npc.unlocked,()=>{const P=ze;if(P.entity.enabled)return;Ne(P.entity.id),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id)}),Je(()=>!!ze.entity.unlocked,()=>{const P=Ut;if(P.entity.enabled)return;Ne(P.entity.id),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id)}),Je(()=>!!Ut.entity.unlocked,()=>{const P=st;if(P.entity.enabled)return;Ne(P.entity.id),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id)}),Je(()=>!!st.entity.unlocked,()=>{const P=Jt;if(P.entity.enabled)return;Ne(P.entity.id),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id)}),Je(()=>!!Jt.entity.unlocked,()=>{const P=Wt;if(P.entity.enabled)return;Ne(P.entity.id),s.sceneEntity.scene.playClearingBuildingAnim(s,P.entity.id)})]}}),r4(s,o.entity,a.entity)}function r4(s,e,t){const i=(r,a,o=1)=>s.ownedItemsQuery.entities.find(l=>l.ownedBy===r.id&&l.item.key===a&&l.item.count>=o);(r=>{let a=0;const o=p=>r.add({task:Em(Qt({},p),{order:a++})});let l=!1;r.bus.onStartChopping.add(({entity:p})=>{p===r.playerEntity&&(l=!0)}),o({op:"dragToMove",startConditions:[()=>!0],finishConditions:[()=>!!l]}),o({op:"takeLogs",startConditions:[()=>r.statsEntity.gameStatistics.chopped>0],finishConditions:[()=>!!i(r.playerEntity,"iLog",3)]}),o({op:"goToSawmill",startConditions:[()=>!!t.unlocked],finishConditions:[()=>!!i(t,"iPlank",1)]});let c=!1,u=!1,h=!1;r.bus.onButtonClicked.add(({btn:p})=>{p==="upgrades"?c=!0:p==="buyUpgrade"?u=!0:p==="closeUpgrades"&&(h=!0)}),o({op:"openUpgrades",startConditions:[()=>!!r.statsEntity.gameStatistics.produced.pSawmill],finishConditions:[()=>!!c],onStart:[()=>{c=!1}]}),o({op:"buyUpgrade",startConditions:[()=>c],finishConditions:[()=>!!u],onStart:[()=>{u=!1}]}),o({op:"closeUpgrades",startConditions:[()=>u],finishConditions:[()=>!!h],onStart:[()=>{h=!1}]}),o({op:"collectCoins",startConditions:[()=>!!i(e,"iCoin",1)&&r.playerEntity.zone==="zVillage"],finishConditions:[()=>!!r.statsEntity.gameStatistics.picked.iCoin],onStart:[()=>{const p=e.transform.position.clone(),m=uo(r,"zVillage",p),_=r.bus.onItemPicked.add(()=>{r.statsEntity.gameStatistics.picked.iCoin&&(gt(m)(r),_.remove())});Te(500).then(()=>Ie(this,null,function*(){for(;r.playerEntity.zone!=="zVillage";)yield Te(200);yield Te(500),!r.statsEntity.gameStatistics.picked.iCoin&&At(r,p.clone())}))}]});let d=!1;r.bus.onNpcStartSleep.addOnce(()=>{d=!0});let f=!1;r.bus.onNpcStopSleep.addOnce(()=>{f=!0}),o({op:"wakeUp",startConditions:[()=>d&&r.playerEntity.zone==="zVillage"],finishConditions:[()=>f],onStart:[()=>{const p=r.mapObjectsQuery.with("npcSleeping").entities[0];if(!p)return;const m=p.id,_=p.transform.position.clone();m==="pSawmillWorkerNpc"?_.addInPlaceFromFloats(.6,.4,0):m==="pLogNpc"&&_.addInPlaceFromFloats(-.3,.4,-.3);const E=uo(r,"zVillage",_);r.bus.onNpcStopSleep.addOnce(()=>{gt(E)(r)})}]})})(s)}function a4(s){o3.forEach(l=>{const c=a3[l];s.add({id:l,achievement:{type:c.icon,val:0,max:c.max,award:c.award,lvl:c.lvl}})});const e={};s.bus.onSceneReady.addOnce(()=>{s.playerItems.forEach(d=>{e[d.item.key]=d.item.count});const l=s.identifiableQuery.with("achievement").entities.reduce((d,f)=>{const p=f.achievement.type;return d[p]?d[p].push(f):d[p]=[f],d},{});Object.values(l).forEach(d=>{d.sort((f,p)=>f.achievement.lvl-p.achievement.lvl)});const c=s.statsEntity.gameStatistics;let u=c.picked.iCoin||0;const h=(d,f)=>{if(f<1)return;const p=l[d];p&&p.find(m=>{if(!m.purchased)return m.achievement.val>=m.achievement.max||(m.achievement.val+=f,m.achievement.val>=m.achievement.max&&(m.achievement.val=m.achievement.max),s.bus.onAchievementsUpdated.notifyObservers(),s.bus.onBigSaveRequested.notifyObservers()),m})};s.bus.onTreeChopped.add(d=>{d.who.player&&h("iLog",1)}),s.bus.onWaveWin.add(()=>{h("iStrength",1)}),s.bus.onProducerOutputProduced.add(d=>{const f=d.amount;if(!(f<1))switch(d.id){case"pSawmill":{h("iPlank",f);return}case"pWheatGarden":{h("iWheat",f);return}case"pMill":{h("iFlour",f);return}case"pBaker":{h("iBread",f);return}case"pAppleGarden":{h("iApple",f);return}case"pWinery":{h("iAleBarrel",f);return}case"pForge":{h("iIron",f);return}case"pLaboratory":{h("iBook",f);return}case"pCornField":{h("iCorn",f);return}case"pJewelerNpc":{h("iGem",f);return}case"pCaveCrystal":{h("iCrystal",f);return}}}),s.bus.onInventoryUpdated.add(()=>{const d=c.picked.iCoin||0;if(d>u){const f=d-u;u=d,f>0&&h("iCoin",f)}})});const t="pAchives",i=s.add({id:t,zone:"zVillage",dontSaveEnabled:!0,transform:{position:new g(121.9,.15,133.4),rotation:{y:0}},enabled:!0,screenPosition:j.Zero(),screenPositionOffset:new g(0,2.5,0)}),n=s.add({id:i.id+"Area",zone:"zVillage",dontSaveEnabled:!0,transform:{position:i.transform.position.clone(),rotation:{y:0},scaling:g.One().setAll(.5)},interactiveArea:{radius:.6,target:i},model:{key:"interactiveArea"}}),r=ur(s,n.zone,i.id+"Sign","exclamation",n.transform.position.clone(),{scaling:g.One().setAll(3)},{dontSaveEnabled:!0,exclamationSign:!0});r.transform.position.y=1;const a=s.identifiableQuery.with("achievement").without("purchased");Dn.onGameLoaded.addOnce(()=>{s.removeComponent(n,"enabled"),s.removeComponent(r,"enabled");const l="pSawmill",c=s.entityByIdentifier.get(l);c&&c.purchased&&(It(s,n),o())});const o=()=>{a.entities.some(c=>c.achievement.max<=c.achievement.val)?n.animateRotation==null&&(s.addComponent(n,"animateRotation",{duration:1}),n.enabled&&s.addComponent(r,"enabled",!0)):n.animateRotation!=null&&(s.removeComponent(n,"animateRotation"),s.removeComponent(r,"enabled"))};s.bus.onAchievementsUpdated.add(()=>{o()}),s.bus.onPurchased.add(l=>{l.entity.sawmill&&It(s,n),o()}),s.bus.onPlayerMovementFinished.add(()=>{i.playerInInteractiveArea&&s.bus.onButtonClicked.notifyObservers({btn:"achievements"})})}function o4(s){return Ie(this,null,function*(){yield Te(1e3);const e=s.varsEntity.persistentVars.prestige+1,t=s.identifiableQuery.with("achievement").entities.map(a=>Qt({},a)),i=Qt({},s.settingsEntity.settings);Oe.addDesignEvent("UI:Prestige:Finished"+e),s.with("sound").entities.forEach(a=>{a.sound.pause(),a.sound.autoplay=!1}),s.with("soundTrack").entities.forEach(a=>{a.soundTrack.setVolume(0)});const n=s.with("engine").entities[0].engine;s.sceneEntity.scene.dispose(),n.dispose(),s.with("canvas").entities[0].canvas.remove(),yield s.with("persistentStorage").entities[0].persistentStorage.clear(),s.entities.forEach(a=>{s.remove(a)}),Dn.onAfterPrestige.notifyObservers(),Dn.onWorldCreated.addOnce(a=>{a.varsEntity.persistentVars.prestige=e,t.forEach(o=>{const l=a.entityByIdentifier.get(o.id);l&&l.achievement&&(l.achievement.val=o.achievement.val,o.purchased&&a.addComponent(l,"purchased",!0))}),a.settingsEntity.settings.music=i.music,a.settingsEntity.settings.sound=i.sound,a.settingsEntity.settings.locale=i.locale})})}function l4(s){function i({zone:u,gridMap:h,id:d,width:f,height:p,open:m=!1}){const _=[],E=[],v=m?_:E;for(let y=0;y<f;y++)for(let A=0;A<p;A++)v.push(d+y*h.mapInfo.height+A);return s.add({zone:u,gridMapPatch:{opened:_,closed:E}})}const n=new Set(td),r={},a=Object.keys(qi.zones);td.forEach(u=>{const h=na[u];if(!h)return;const d=a.find(p=>qi.zones[p].buildings[h.producer]!=null);if(!d)return;const f=s.add({id:u,zone:d,dontSaveEnabled:!0});s.add({id:f.id+"Area",dontSaveEnabled:!0,zone:d,interactiveArea:{radius:.5,target:f},itemHolder:{type:h.item,max:h.price,val:0,onMaxed:[nt(f)],onValueChanged:[]},screenPosition:j.Zero(),screenPositionOffset:new g(0,2.5,0)}),r[h.producer]||(r[h.producer]=[]),r[h.producer].push(u)});const o={};function l(u){const h=s.lvlManager;if(!h)return;const d=na[u];if(!d)return;const f=h.buildings[d.producer];if(!f)return;const p=f.purchases[u];if(!p)return;n.delete(u);const m=r[d.producer]||[];r[d.producer]=m.filter(y=>y!==u),h.purchase(d.producer,u);const _=s.entityByIdentifier.get(u+"Area");_&&!_.removing&&(s.removeComponent(_,"enabled"),s.addComponent(_,"removing",!0));const E=h.getZone(f.zone);if(!E)return;const v=E.gridMap;v&&(o[u]||(o[u]=[],p.open&&p.open.forEach(y=>{o[u].push(i({zone:f.zone,gridMap:v,id:y.id,width:y.width,height:y.height,open:!0}))}),p.close&&p.close.forEach(y=>{o[u].push(i({zone:f.zone,gridMap:v,id:y.id,width:y.width,height:y.height,open:!1}))}),o[u].forEach(y=>It(s,y))))}s.bus.onPurchased.add(u=>{const h=u.entity;if(!n.has(h.id))return;const d=h.id;if(!s.lvlManager)return;const p=na[d];p&&(l(h.id),c([p.producer]))});function c(u){const h=s.lvlManager;h&&u.forEach(d=>{const f=r[d];if(!f||f.length<1)return;const p=f[0];if(!p)return;const m=na[p];if(!m)return;const _=h.buildings[m.producer];if(!_)return;const E=_.purchases[p];if(!E)return;const v=s.entityByIdentifier.get(p);if(!v)return;if(v.purchased){const A=r[m.producer]||[];r[m.producer]=A.filter(I=>I!==p),console.warn(`Already purchased! ${p}`),c([d]);return}const y=s.entityByIdentifier.get(p+"Area");if(y&&E.point&&!y.transform){s.addComponent(y,"transform",{position:new g(E.point.x,E.point.y,E.point.z),rotation:{y:0},scaling:g.One().setAll(.55)}),s.addComponent(y,"model",{key:"interactiveArea"}),It(s,y);const A=E.offerPoint;A&&ct(s,v.id,new g(A.x,A.y,A.z))}})}s.bus.onZoneLoaded.add(()=>{const u=s.lvlManager;u&&(td.forEach(h=>{const d=na[h];if(!d)return;const f=u.buildings[d.producer];if(!f||!f.purchases[h])return;const m=s.entityByIdentifier.get(h);m&&m.purchased&&l(h)}),c(Object.keys(r)))})}function c4(s,e){Object.keys(e.zones).forEach(t=>{const i=t,n=e.zones[i];n.entity=s.add({id:i,zone:i}),n.parsedLight={clearColor:G.FromHexString(n.light.clear),hemiColor:G.FromHexString(n.light.hemi),hemiGroundColor:G.FromHexString(n.light.hemiGround),pointColor:G.FromHexString(n.light.point)};const r=n.gridMapInfo;if(r){const{x:a,z:o,width:l,height:c,data:u}=r,h=xv({xOffset:a,zOffset:o,width:l,height:c});h.parseString(u),n.gridMap=h}Object.keys(n.pois).forEach(a=>{const o=a,l=n.pois[o];if(l&&l.radius>.2){const c=s.add({id:o,zone:i,poi:o,[o]:!0}),u=s.add({id:o+"Area",zone:i,dontSaveEnabled:!0,transform:{position:new g(l.point.x,0,l.point.z),rotation:{y:0},scaling:g.One().setAll(l.radius)}});s.addComponent(u,"interactiveArea",{radius:l.radius,target:c}),s.addComponent(u,"model",{key:"interactiveArea"}),It(s,u)}})})}function u4(s){console.log("initWorldObjects"),c4(s,qi);const e=s.add({id:"teleportTarget"});Q3(s,qi.teleports,e),l4(s),s.add({id:"npc_spawner_1",zone:"zVillage",npcSpawn:!0,rect:{x:121,z:126.5,width:3,height:.5}}),a4(s),s4(s,{x:122,z:122,width:20,height:20}),s.bus.onBuildingFinished.add(t=>{const i=s.entityByIdentifier.get(t.key);i!=null&&s.addComponent(i,"buildingFinished",!0)}),s.bus.onPurchased.add(({entity:t})=>{if(!s.varsEntity)return;const i=s.varsEntity.persistentVars;i&&s.upgradableProducers.includes(t.id)&&(i.unlockedUpgrades++,s.bus.onVarChanged.notifyObservers({key:"unlockedUpgrades"}))}),s.bus.onArrivedToService.add(({service:t})=>{const i=s.playerEntity,n=s.camerasQuery.with("cameraFollowPlayer").entities[0];s.addComponent(i,"paused",!0),s.addComponent(i,"playerInServiceBuilding",t),s.add({enabled:!0,camera:n.camera,cameraSettings:{radius:t==="wall"?10:t==="tailor"?4:t==="hairdresser"?3:5,alpha:t==="wall"?-.11:-Math.PI*.1,beta:t==="wall"?.8:1.1,target:n.camera.target.clone().addInPlaceFromFloats(0,-.5,0),targetSpeed:20}}),s.removeComponent(n,"enabled"),i.transform.rotation.y=Math.PI*.5,s.bus.onPlayerAtService.notifyObservers({service:t})}),s.bus.onPrestigeActivated.add(()=>{o4(s)}),s.bus.onSceneReady.addOnce(()=>{const t=s.varsEntity.persistentVars.prestige;ho.forEach((i,n)=>{n>=t||i.effects.forEach((r,a)=>{const o=r.ownedBy,l=o?s.entityByIdentifier.get(o):s.globalEffector;if(!l){console.warn("no owner with id "+o);return}const c=pa(s,l,{attr:r.attr,op:r.op,value:r.value},i.id+"Effect"+a);s.addComponent(c,"prestigeEffect",!0),It(s,c)})})}),s.bus.onPlayerAttrLevelUpgraded.add(t=>{Oe.addDesignEvent("UI:UpgradeAttrs:"+t),Oe.addDesignEvent("UI:UpgradeAttrsLvl:"+t+s.playerEntity.attributesLevel[t]);const i=s.sceneEntity;i!=null&&(i.scene.playBuyEffect(s.playerEntity.transform.position.clone(),1e3),vt(s,ut.success),JP(t))})}const Xg="pPlayer",h4=108,d4=120,f4=58,p4=32,m4="01111111111111111111111111111111011111111111111111111111111111110111111111100000111111111111111101111111111000000000111111111111011000011110000000001000001111110110000111100000000010000011111101100001111000000000100000000111011111111111111111101010000001110111111111111111111111111000011101111111111111100000000011000111011111111111110000000000100001110111111111111100000000001111111100011111111111111100000010011111011111111111110000100000100001110111111111111000000100001100011101111111111111000001111111000111011111111111110000000001110001110000001111111100000000011111111100000000111111000000000111001111000000101111100000000001100011000000000001111000000000011011110000000000011111000000111111111100000000000111110000001111111111000000000001111100000011100011111100011111111111000000111000111111100111111111111000011110001111111001111111111111111111111111111111101111111111111111111111111111111011111111111111111110000111111110111111111111111111100001111111101111111111111000111000011111111011111110001100001110000111111110111111100011000011100001111111111111111000110000111000011111111111011111111111111110000111111111111111111111111111111111111111111111111111111111100000111111111111111111111110110000000111111111111111111111100000000000111111111111111111111000000000001100111111111111111110000000000011001111111111111111100000000000000011111111111111111000000000000000111111111111111110000000000000001111111111111111110000001100000011111111111111111111111110000000111111111111111111100000100000001111111111111111011000010000000111111111111111111001111111100001111111111111111110001111111110111111111110000000000001100001101111111110000000000000011000011001111111001000000000000110000110011111110000000000000001100001100011111110000000000000011000011000111111100000000000000110000111111111111000000000000001100001111111111110000000000000011000000000",_4=["#000000","#B1FBF2","#B1FBF2","#000000","#B1FBF2","#000000","#000000","#B1FBF2","#000000","#B1FBF2","#000000","#B1FBF2","#000000","#B1FBF2","#B1FBF2","#000000","#000000","#B1FBF2","#000000","#B1FBF2","#000000","#B1FBF2","#B1FBF2","#B1FBF2","#000000","#67C85B","#000000","#67C85B","#000000","#67C85B","#67C85B","#67C85B","#000000","#000000","#000000","#67C85B","#000000","#67C85B","#67C85B","#000000","#000000","#000000","#67C85B","#67C85B","#67C85B","#000000","#000000","#67C85B"];function Yg(){return Ie(this,null,function*(){const s=new jN,e=new e3;s.add({persistentStorage:e}),s.add({debug:{showAstar:!1,showFPS:!1}}),s.add({keyboardInput:{pressedKeys:new Set},mouseInput:{},enabled:!0});const t=r3({width:f4,height:p4,xOffset:h4,zOffset:d4});s.add({mapInfo:t}),s.add({flag:_4});const i=xv(t);i.parseString(m4),s.add({npcGlobalGridMap:i,zone:"zVillage"});const n=s.add(BP({id:Xg,currentHp:0,zone:"zVillage",maxHp:0,attackDelay:0,attackDistance:1,attackSpeed:0,minAttackDmg:0,maxAttackDmg:0,teamId:"villager",attackable:!0,alive:!0,screenPosition:j.Zero(),screenPositionOffset:new g(0,2.5,0),transform:{position:new g(124.3,.1,130.3),rotation:{y:Math.PI*.8}},player:!0,canPickIntoInventory:!0,canChop:!0,model:{key:"npc_worker",shadow:!0},appearance:{parts:[["Body",0,Ae.colorBrown500.clone()],["Eyes",0,Ae.eyesColorDark.clone()],["Mouth",0,Ae.eyesColorDark.clone()],["Hair",3,Ae.hairColor.clone()],["Pant",1,Ae.colorLeather700.clone()],["Jacket",0,Ae.colorLeather700.clone()]],removed:[]},movement:{speed:0,velocity:g.Zero()},movingTime:0,stayingTime:0,attributes:{attInventoryBaseCapacity:3,attBaseMovementSpeed:4.5,attBasePickingSpeed:4e3,attBasePickingDistance:.7,attBaseSupplySpeed:4e3,attBaseChoppingSpeed:2e3,attBasePickCoinsMultiplier:1,attBaseStr:0,attBaseVit:0,attAttackSpeed:.6,attCritChance:.15,attExcellentChance:.1},recalculateAttributes:!0,attributesLevel:{attStr:1,attVit:1},enabled:!0,showMaxDuration:0}));return s.add({id:n.id+"Stats",playerStats:!0,transform:{position:n.transform.position,rotation:{y:0}},zone:"zVillage",enabled:!0,screenPosition:j.Zero(),screenPositionOffset:new g(0,-.25,0)}),u4(s),yield e.load(s),yield e.loadBig(s),s.statsEntity==null&&(s.add({gameStatistics:{gameTime:0,servedClients:0,movementDistance:0,picked:{},supplied:{},produced:{},chopped:0}}),s.add({persistentVars:{unlockedUpgrades:0,viewedUpgrades:0,prestige:0,dropTip:!1,waves:0}}),s.add({id:"iCoins",item:{key:"iCoin",count:20},ownedBy:Xg})),s.settingsEntity||s.add({settings:{sound:!0,music:!0}}),s.bus.onInitBeforeSave.notifyObservers(s),Dn.onWorldCreated.notifyObservers(s),e.save(s),s.settingsEntity.settings.locale&&(gv(s.settingsEntity.settings.locale),s.bus.onSettingsChanged.notifyObservers(s.settingsEntity)),s})}const Ov=M.memo(()=>{const[s,e]=ve.useState(0);ve.useEffect(()=>{let r=!0;Dn.onPreloadingFinished.add(()=>{r&&Ei.sdkGameLoadingStop(),e(1),r=!1}),Dn.onAfterPrestige.add(()=>{Yg().then(a=>{e(0),i(a)})})},[]);const[t,i]=ve.useState(null);if(ve.useEffect(()=>{Ei.sdkGameLoadingStart(),Yg().then(r=>{i(r)})},[]),t==null)return null;window.__world=t;const n=()=>{switch(s){case 0:return M.createElement(xN,null);case 1:return M.createElement(CF,null);default:return M.createElement("div",null,"Not implemented page!")}};return M.createElement("div",{className:"app"},M.createElement(Xx,{world:t},n()))}),g4=""+new URL("draco_wasm_wrapper_gltf_v0-ca5fcd48.js",import.meta.url).href,E4=""+new URL("draco_decoder_gltf_v0-1517e637.wasm",import.meta.url).href,v4=""+new URL("draco_decoder_gltf_v0-488a3eb5.js",import.meta.url).href;Oe.setEnabledInfoLog(!1);Oe.configureBuild("prod 0.18.2");Oe.configureAvailableResourceCurrencies(["coins"]);Oe.configureAvailableResourceItemTypes(["adsOffer"]);Oe.initialize("bbe92810095e07b816f631efc1acd8c4","8dc5d3e8597763d5a7d2cde31695f08fc2daa266");const y4=document.getElementById("react-target"),wv=rE(y4);on.Configuration={decoder:{wasmUrl:g4,wasmBinaryUrl:E4,fallbackUrl:v4}};window.addEventListener("keydown",s=>{["ArrowDown","ArrowUp"," "].includes(s.key)&&s.preventDefault()});const A4=["scene-explorer-host","inspector-host"];window.addEventListener("wheel",s=>{let e=s.target;for(;e;){if(e.classList&&(e.classList.contains("scrollable")||A4.includes(e.id)))return;e=e.parentElement}s.preventDefault()},{passive:!1});if(typeof document!="undefined"){let s="",e=null;Dn.onGameLoaded.add(i=>{e=i});const t=()=>{const i=!!document[s];e&&e.bus.onVisibilityChanged.notifyObservers({visible:!i})};document.hidden!==void 0?(s="hidden",document.addEventListener("visibilitychange",t,!1)):document.mozHidden!==void 0?(s="mozHidden",document.addEventListener("mozvisibilitychange",t,!1)):document.msHidden!==void 0?(s="msHidden",document.addEventListener("msvisibilitychange",t,!1)):document.webkitHidden!==void 0&&(s="webkitHidden",document.addEventListener("webkitvisibilitychange",t,!1))}const Fv=Date.now(),T4=__vcStopwatches[1]-__vcStopwatches[0],S4=__vcStopwatches[2]-__vcStopwatches[1],C4=Fv-__vcStopwatches[1];Oe.addDesignEvent("UI:Loading:SDK",T4);Oe.addDesignEvent("UI:Loading:Altcs",S4);Oe.addDesignEvent("UI:Loading:Startup",C4);const I4=5e3;let Lv=!1;const R4=setTimeout(()=>{Oe.addDesignEvent("UI:Loading:BridgeInitFailed",1),Lv=!0,wv.render(M.createElement(Ov,null))},I4);Ei.init().finally(()=>{clearTimeout(R4),Oe.addDesignEvent("UI:Loading:SDKInit",Date.now()-Fv),!Lv&&wv.render(M.createElement(Ov,null))});
